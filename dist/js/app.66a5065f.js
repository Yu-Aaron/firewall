/**
 * southwest_app
 * @version v0.0.1
 * Copyright 2013-2019 Istuary Innovation Lab Inc.
 */
window.env = "production";!function(){"use strict";angular.module("southWest.directives",[])}(),function(){"use strict";angular.module("southWest.filters",[]).filter("translateSeverity",[function(){return function(e){var t={1:"LOW",2:"MEDIUM",3:"HIGH"};return t[e]||e}}]).filter("translateCategory",[function(){return function(e){var t={0:"BRUTE_FORCE",1:"INFO_LEAK",2:"CODE_EXECUTION",3:"DOS",4:"OVERFLOW"};return t[e]||e}}]).filter("translateAction",[function(){return function(e){var t={1:"ALLOW",2:"ALERT",3:"DROP",4:"REJECTBOTH"};return t[e]||e}}]).filter("translateUserpril",[function(){return function(e){var t={ADMIN:"管理员",NORMAL_USER:"普通用户"};return t[e]||e}}]).filter("translateTopoStatus",[function(){return function(e){var t={on:"使用中",off:"未使用"};return t[e]||e}}]).filter("tableUnit",[function(){return function(e){var t={device:"台设备",incident:"个事件",event:"个事件",user:"个用户",rules:"条规则",log:"条日志",audit:"条记录",devicedata:"台设备",nodeZone:"个逻辑分区",file:"个文件",reduction:"条记录",item:"条"};return t[e]||e}}]).filter("trustAsResourceUrl",["$sce",function(e){return function(t){return e.trustAsResourceUrl(t)}}]).filter("convertOptions",[function(){return function(e,t,n,o){var a=[];return angular.forEach(e,function(e){e[t]=e[t]===n?o:e[t],a.push(e)}),a.sort(function(e,n){return e[t]>n[t]?1:-1}),a}}]).filter("convertText",[function(){return function(e,t,n){return e===t?n:e}}]).filter("ellipsis",[function(){return function(e,t){var n=String(e);return n.length>t&&(e=n.slice(0,t-1).concat("...")),e}}]).filter("convertBackType",[function(){return function(e){return"mwbus"===e?"业务备份":"mwsys"===e?"系统备份":void 0}}]).filter("convertNullBlank",[function(){return function(e,t){return e?e:t}}]).filter("convertTrueFalse",[function(){return function(e,t,n){return e?t:n}}]).filter("spliceContentFromArray",[function(){return function(e,t,n){return angular.isArray(t)&&t.forEach(function(t){e.some(function(o,a){if(n){if(t===o[n])return e.splice(a,1),!0}else if(t===o)return e.splice(a,1),!0})}),e}}]).filter("outerInterface",[function(){return function(e){var t={any:"任意"};return t[e]||e}}]).filter("spaceFormat",function(){return function(e){for(var t=0,n={0:"B",1:"K",2:"M",3:"G",4:"T",5:"P"};e>=100;)e/=1024,t++;return e.toFixed(1)+n[t]}}).filter("byte",function(){return function(e){for(var t=0,n={0:"B",1:"K",2:"M",3:"G",4:"T",5:"P"};e>=1024;)e/=1024,t++;return e.toFixed(2)+n[t]}}).filter("utc",function(){return function(e,t){return moment(e).format(t||"YYYY-MM-DD HH:mm:ss")}})}(),function(){"use strict";angular.module("southWest.models",[])}(),function(){"use strict";function e(e){var t=e.state;e.state=function(e,n){return n.resolve||(n.resolve={}),t.apply(this,arguments)}}e.$inject=["$stateProvider"],angular.module("southWest.services",[]).config(e)}(),function(){"use strict";function e(e){function t(t){e(function(){document.getElementById(t).focus()},1e3)}var n={focusById:t};return n}function t(e){return{restrict:"A",link:function(t,n){e(function(){n[0].focus()})}}}t.$inject=["$timeout"],e.$inject=["$timeout"],angular.module("southWest.directives").directive("autofocus",t).factory("autofocusCtrl",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s){function c(e,t,n,o,a,r,i,l,s,c){var d=0,u=0,p=o.defer();e.isDPIUpgrading=s.isDPIUpgrading(),l.$on("dpiUpgradeState",function(){e.isDPIUpgrading=s.isDPIUpgrading()});var f=this;f.EditMode=!1,f.hovered=100,f.linkPromise=p.promise,f.gridPattern={stroke:"#333333",strokeWidth:.8},f.nodeBGBrush="#000",f.nodeSelectionBrush="#76B900",f.nodeTopFillBrush="#1C418F",f.nodeTextBrush="#E4E4E4",f.nodeTopFont="10pt SourceHanSansCN-Regular",f.ipFont="9px sans-serif",f.iconFont="8pt FontAwesome",f.statusOffBrush="#FE540F",f.centerConnectorStroke="#76B900",f.centerConnectorFill="black",f.connectorBrush="#E4E4E4",f.linkBrush="#CCCCCC",f.linkOpacity=.5,f.linkHighlightBrush="#76B900",f.linkHighlightOpacity=.5,f.tooltipBGBrush="#E6E6E6",f.deviceColor="",f.invalid=!1,f.nodeKeyMaping={},f.getDeviceColor=function(e){var t="#193984";switch(e){case"SECURITY_DEVICE":t="#AA3D11";break;case"FACTORY_DEVICE":t="#1D3D87";break;case"NETWORK_DEVICE":t="#107F6D"}return t},f.setConfig=function(e){f.config=e},e.currentNode={orderID:null},e.showOptions=!1,e.optionsStyle={position:"absolute",left:d+"px",top:u+"px"},e.detailStyle={position:"absolute",left:"0px",top:"0px"},e.showDetailPanel=!1,e.calculatePosition=function(){e.detailStyle.left=d+30+"px",e.detailStyle.top=u+"px"},f.setPosition=function(t,n){e.optionsStyle.left=t+65+"px",e.optionsStyle.top=n-10+"px"},e.topo||(e.topo=""),e.downloadTopo=function(){n.downloadLink(e.currentTopo.topologyId).then(function(e){window.open("./"+e,"_self")})},e.discoverTopo=function(){c.transitionTo("topology.discovery")},e.pv=t.get("privilege").filter(function(e){return e.name===l.currentState})[0].actionValue,e.render=function(t){i.id===void[0]?a.getDomain().then(function(n){n&&n[0].domainInfo.currentTopologyId?(e.topo||(e.topo=n[0].domainInfo.currentTopologyId),e.noTopo=!1):e.noTopo=!e.topo,f.getTopologyInfo(t)}):(e.topo=i.id,f.getTopologyInfo(t))},f.getTopologyInfo=function(t){e.topo&&(p.resolve(e.topo),n.getTopo(e.topo).then(function(a){var l=a,s=[];s.push(n.getNodes(e.topo)),s.push(n.getLinks(e.topo)),s.push(n.getDevices(e.topo)),s.push(r.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$limit:1e6,$orderby:"model_name"})),s.push(r.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq FACTORY_DEVICE",$limit:1e6,$orderby:"model_name"})),s.push(r.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq NETWORK_DEVICE",$limit:1e6,$orderby:"model_name"})),s.push(r.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq SECURITY_DEVICE",$limit:1e6,$orderby:"model_name"})),o.all(s).then(function(n){if(l.nodes=n[0].data,l.links=n[1].data,l.devices=n[2].data,n[3][0].model_name||n[3][0].make||n[3][0].model?"":l.blankModel=n[3][0].modelId,f.factory_models=n[4],f.network_models=n[5],f.security_models=n[6],e.topologyHasNode=i.hasNode,e.currentTopo=l,t?e.putDiagramData(l):e.drawTopo(l),f.config.isInfsafety){for(var o=0;o<l.nodes.length;o++)for(var a=0;a<l.devices.length;a++)if(l.nodes[o].deviceId===l.devices[a].deviceId){l.nodes[o]._make=l.devices[a].make,l.nodes[o]._serialNumber=l.devices[a].serialNumber,l.nodes[o]._modelIdentifier=l.devices[a]._model_name,l.nodes[o]._zoneNames=l.devices[a]._zoneNames[0],l.nodes[o]._knownVulnerabilitiesNumber=l.devices[a].knownVulnerabilitiesNumber,l.devices[a].devicePorts&&l.devices[a].devicePorts.length>0&&(l.nodes[o]._ip=l.devices[a].devicePorts[0].portIp);break}e.nodeMap=_.indexBy(l.nodes,"id"),e.forms.modes=[{mode:"ENDPOINT",modename:"HMI",icontype:"hmi"},{mode:"ENDPOINT",modename:"OPC 客户端",icontype:"opc_client"},{mode:"ENDPOINT",modename:"OPC 服务器",icontype:"opc_server"},{mode:"ENDPOINT",modename:"PLC",icontype:"plc"},{mode:"ENDPOINT",modename:"工作站",icontype:"workstation"},{mode:"ENDPOINT",modename:"子网",icontype:"subnet"},{mode:"ENDPOINT",modename:"其它",icontype:"unknown-device"}];for(var r in e.nodeMap)_.findLastIndex(e.forms.modes,{icontype:e.nodeMap[r]._iconType})===-1&&(e.nodeMap[r]._iconType="unknown-device")}})}))},f.updateDiagram=function(e,t,n,a){var r=o.defer();o.all(e).then(function(){r.resolve("success"),l.addAlert({type:"success",content:a})},function(){r.resolve("修改设备失败"),l.addAlert({type:"danger",content:a})})},e.render()}function d(n,o,c,d){var u=d;u.linkPromise.then(function(o){function c(){C.startTransaction("removePortFinal");var e=[];C.selection.each(function(t){(t instanceof go.Node||t instanceof go.Link)&&e.push(t)});for(var t=0;t<e.length;t++)C.remove(e[t]);C.commitTransaction("removePortFinal")}function p(e){if((4&n.pv)>0&&u.config.setPosition){var t=C.findPartAt(e.diagram.lastInput.documentPoint,!1);null!==t&&(t.selectionAdorned=!1);for(var o=e.diagram.selection.iterator;o.next();)if(o.value instanceof go.Node&&o.value.data.deviceId){var r={id:o.value.data.nodeId,x:o.value.location.x,y:o.value.location.y};a.updatePosition(r)}else if(o.value.data.isGroup)for(var i=o.value.memberParts.iterator;i.next();)if(i.value instanceof go.Node&&i.value.data.nodeId){var l={id:i.value.data.nodeId,x:i.value.location.x,y:i.value.location.y};a.updatePosition(l)}}}function f(t){g(t.data),t.data.deviceId&&e.getACLInfo(t.data.deviceId).then(function(e){n.hasacltable=!1,e.length>0&&(n.hasacltable=!0),n.acltable=e},function(){n.hasacltable=!1}),n.validateDevice(n.selectedDeviceInTable),n.populateModelOptions(n.selectedDeviceInTable.category),C.select(t)}function m(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,o){var a=n[e]<o[e]?-1:n[e]>o[e]?1:0;return a*t}}function g(e){if(n.selectedDeviceInTable=e,n.selectedDeviceInTable.ports){for(var t=0;t<n.selectedDeviceInTable.ports.length;t++)"mgmt"!==n.selectedDeviceInTable.ports[t].portName.toLowerCase()&&(n.selectedDeviceInTable.ports[t].index=+n.selectedDeviceInTable.ports[t].portName.substr(1));n.selectedDeviceInTable.ports.sort(m("index"));for(var o=0;o<n.selectedDeviceInTable.ports.length;o++)"mgmt"!==n.selectedDeviceInTable.ports[o].portName.toLowerCase()&&delete n.selectedDeviceInTable.ports[o].index;n.selectedDeviceInTable.ports.sort(m("index"))}}function h(t){t.subject.part.data.key&&(t.subject.part.data.deviceId&&e.getACLInfo(t.subject.part.data.deviceId).then(function(e){n.hasacltable=!1,e.length>0&&(n.hasacltable=!0),n.acltable=e},function(){n.hasacltable=!1}),n.populateModelOptions(n.selectedDeviceInTable.category)),n.validateDevice(n.selectedDeviceInTable),n.$digest()}function v(e,t,n){if(!t)return!1;for(var o=0,a=0;a<n.length;a++)if(t===n[a].serialNumber){if(e!==n[a].deviceId)return!0;if(!e&&!n[a].deviceId){if(0!==o)return!0;o++}}return!1}function y(e,t,n){if(!t)return!1;for(var o=0,a=0;a<n.length;a++)if(t===n[a].ip){if(e!==n[a].deviceId)return!0;if(!e&&!n[a].deviceId){if(0!==o)return!0;o++}}return!1}function I(e,t,n){if(!t)return!1;for(var o=0;o<n.length;o++)if(t===n[o].mac&&e!==n[o].deviceId)return!0;return!1}function D(e){var t={};return t.nameInDetail=e.deviceType,t.topology=C.topologyId,t.currentTopology=C.currentTopology,t.img=e.img,t.category=e.category,t.updateTime=(new Date).toJSON(),t.statusIconShow="SECURITY_DEVICE"===e.category,t.portIdRef=!0,t.loc="",t.nodeType="Cloud"===e.deviceType?"CLOUD":"网络交换机"===e.deviceType?"SWITCH":"路由器"===e.deviceType?"ROUTER":"安全设备"===e.deviceType?"IPS":"ENDPOINT",t.isEdited=!1,t.iconType=e.img.substring(7,e.img.length-9),t.modelId="Cloud"!==e.deviceType?"":"cloud",t.deviceId="","Cloud"!==e.deviceType&&(t.ports=[{_subnets:Array[0],deployedRulesNumber:0,deviceId:"Device Id",isMgmtPort:!0,linkState:0,mac:"",portId:"",portIp:"",portName:"p0",protectedDevicesNumber:0,status:0}],t.deviceOnline=0,t.numPorts=0,t.ip="",t.manufacturerInDetail="",t.modelInDetail="",t.versionInDetail="",t.routingMode="Routind Mode",t.mmgtPort=0,t.mac="",t.rightArray=[],t.leftArray=[],t.bottomArray="FACTORY_DEVICE"===e.category&&"子网"!==e.deviceType?[{portName:"p0",portIp:""}]:[],t.subcategory="NORMAL",t.statusColor="red","安全设备"===e.deviceType&&(t.modeDescription="",t.showMode=t.modeDescription.length,t.statusText="未激活",t.serialNumber="")),n.topologyHasNode||(n.topologyHasNode=!0),t}function T(e){C.doMouseWheel=function(){this.lastInput.control=!0,C.toolManager.doMouseWheel(),localStorage.setItem("monitor:topology.scale."+e.topologyId,C.scale)},S(e),t.$on("updateDashboardHeader",function(){n.render("update");for(var e=0;e<C.model.nodeDataArray.length;e++)C.model.nodeDataArray[e].currentTopology=!C.model.nodeDataArray[e].currentTopology})}function b(e,t,n,o,a){this.from=t,this.to=n,this.fromPort=o,this.toPort=a,this.color="gray",this.toArrow="",this.strokeWidth="1",this.linkId=e,this.link=go.Link.AvoidsNodes}function S(o){function a(e,t,n){var o=["",""];if(e)for(var a=0;a<e.length;a++)if(e[a]!==n){var r=!1;if(t)for(var i=0;i<t.length;i++)2===t[i].length&&(t[i][0]===e[a]&&t[i][1]===n||t[i][0]===n&&t[i][1]===e[a])&&(r=!0,o[1].length>0&&(o[1]+=","),o[1]+=e[a]);r||(o[0].length>0&&(o[0]+=","),o[0]+=e[a])}return o}function l(e){if(e.mostImprLink&&e.mostImprLink.length>0)for(var t=-s(e.mostImprLink[0]),n=-s(e.mostImprLink[1]),o=0;o<le.length;o++)(le[o].from===t&&le[o].to===n||le[o].from===n&&le[o].to===t)&&(le[o].suggestionPosition=!le[o].suggestionPosition,C.model=new go.GraphLinksModel(c,le))}function s(e){return e=e.toString(),u.nodeKeyMaping[e.toString()]||e}n.drawing=!0,C.topologyId=o.topologyId,n.routingIPS=!1;for(var c=[],p=[],m={},g={},h={},v={},y={},I=0;I<o.devices.length;I++){m[o.devices[I].deviceId]=[],g[o.devices[I].deviceId]=[];for(var T=0;T<o.devices[I].devicePorts.length;T++)m[o.devices[I].deviceId].push(-1),g[o.devices[I].deviceId].push(-1)}for(var S=0;S<o.nodes.length;S++)if("CLOUD"===o.nodes[S].type){var P={key:o.nodes[S].id,nodeId:o.nodes[S].id,iconType:"cloud",topologyId:o.nodes[S].topologyId,currentTopology:o.currentTopology,modelId:"cloud",img:"images/cloud-icon.727f8e55.png",loc:o.nodes[S].x+" "+o.nodes[S].y,nameInDetail:o.nodes[S].name,category:"NETWORK_DEVICE",updateTime:o.updatedAt,statusIconShow:!1,portIdRef:!0,nodeType:"CLOUD",deviceId:"cloud"};p.push(P)}else{v[o.nodes[S].id]=o.nodes[S].deviceId,h[o.nodes[S].deviceId]={positionNodeId:o.nodes[S].id,loc:o.nodes[S].x+" "+o.nodes[S].y,x:o.nodes[S].x,y:o.nodes[S].y,iconType:e.getIconName(o.nodes[S]._iconType),nodeType:o.nodes[S].type,subcategory:o.nodes[S]._subcategory},n.routingIPS||"ROUTING_IPS"!==o.nodes[S].type||(n.routingIPS=!0);for(var A=0;A<o.devices.length;A++)if(o.devices[A].deviceId===o.nodes[S].deviceId){if(o.nodes[S].ports){for(var k=0;k<o.nodes[S].ports.length;k++)for(var w=0;w<o.devices[A].devicePorts.length;w++)if(o.devices[A].devicePorts[w].portName===o.nodes[S].ports[k]){m[o.devices[A].deviceId][w]=o.nodes[S].id,"ips"===o.nodes[S].type.toLowerCase()?g[o.devices[A].deviceId][w]=o.nodes[S].id:g[o.devices[A].deviceId]=o.nodes[S].id;break}}else g[o.devices[A].deviceId]=o.nodes[S].id;break}}for(var E=1,N={},$={},M=!1,R=[],U=0;U<o.devices.length;U++){var _=o.devices[U];if(h[_.deviceId]){for(var x=o.updatedAt,O="",L="",B="",V=0;V<_.devicePorts.length;V++)_.devicePorts[V].isMgmtPort&&(O=_.devicePorts[V].linkState||"",L=_.devicePorts[V].portIp||"",B=_.devicePorts[V].mac||"");N[_.deviceId]=E;var j,W="ROUTING_IPS"===h[_.deviceId].nodeType;if(W){var F;for(S=0;S<o.nodes.length;S++)if(o.nodes[S].deviceId===_.deviceId){if(_&&_.notConnectedPortMap)for(j=_.notConnectedPortMap.split(/\[(.*?)\]/g),F=j.length-1;F>=0;F--)j[F].length<2?j.splice(F,1):j[F]=j[F].split(",");if(_.devicePorts)for(F=0;F<_.devicePorts.length;F++)for(var H=0;H<_.devicePorts.length;H++)_.devicePorts.index=H,_.devicePorts[F].portName==="p"+H&&(_.devicePorts[F].index=+_.devicePorts[F].portName.substr(1),_.devicePorts[F].connection=a(o.nodes[S].ports,j,"p"+H))}}var G=h[_.deviceId].nodeType&&"ROUTING_IPS"===h[_.deviceId].nodeType?"路由保护":h[_.deviceId].nodeType&&("IDS"===h[_.deviceId].nodeType?"监测审计":h[_.deviceId].nodeType&&("IPS"===h[_.deviceId].nodeType?"DATA_COLLECTION_DEVICE"===_._subCategory?"数采隔离":"智能保护":""));u.nodeKeyMaping[h[_.deviceId].positionNodeId.toString()]=E.toString();var z={key:-E,nodeId:h[_.deviceId].positionNodeId,topologyId:o.topologyId,currentTopology:o.currentTopology,deviceId:_.deviceId,img:"SECURITY_DEVICE"===_.category?["kea-c200","kea-c400","ked-c400","kev-c200","kev-c400"].indexOf(i("deviceModel")(_._model_name).toLowerCase())>=0?"images/devices/security/"+i("deviceModel")(_._model_name).toLowerCase()+"-icon.png":"images/devices/security/"+e.getIconName(_.iconType)+"-icon.png":"images/"+h[_.deviceId].iconType.toLowerCase()+"-icon.png",iconType:h[_.deviceId].iconType,loc:h[_.deviceId].loc,nameInDetail:_.name,manufacturerInDetail:_&&_.make?_.make:"",modelId:_&&_.modelId?_.modelId:"",modelInDetail:_&&_._model_name?_._model_name:"",versionInDetail:_&&_.version?_.version:"",serialNumber:_.serialNumber?_.serialNumber:"",modeDescription:G,ruleOnNode:"",countOfIncident:"",unreadCountOfIncident:"",showMode:G.length>0,routingMode:W,mmgtPort:O,deviceOnline:"DISCOVERY"===_.deviceSource?_.deviceOnline:0,deviceSource:_.deviceSource,updateTime:x,mac:B,ip:L,ports:"switch"!==h[_.deviceId].iconType.toLowerCase()?_.devicePorts:"",numPorts:_.devicePorts.length,rightArray:[],leftArray:[],nearArray:[],farArray:[],bottomArray:[],category:_.category,subcategory:_._subCategory,nodeType:h[_.deviceId].nodeType,isEdited:!1,invalid:!1,startDatetime:_.startDatetime};if(h[_.deviceId].devicePorts=z.ports,["ips","ids"].indexOf(h[_.deviceId].nodeType.toLowerCase())===-1)if("FACTORY_DEVICE"===z.category&&"subnet"!==z.iconType.toLowerCase()){z.portIdRef=!1;for(var q=0;q<z.ports.length;q++)z.ports[q].isMgmtPort&&z.bottomArray.push({portName:z.ports[q].portName,portIp:z.ports[q].portIp})}else z.portIdRef=!0;else{z.portIdRef=!1;for(var Y=0;Y<z.ports.length;Y++)z.ports[Y].isMgmtPort||(Number(z.ports[Y].portName.substr(1))%2===0?("ips"===h[_.deviceId].nodeType.toLowerCase()?z.nearArray.push({portName:z.ports[Y].portName+"near"}):"",z.leftArray.push({portName:z.ports[Y].portName})):("ips"===h[_.deviceId].nodeType.toLowerCase()?z.farArray.push({portName:z.ports[Y].portName+"far"}):"",z.rightArray.push({portName:z.ports[Y].portName})));for(Y=0;Y<z.nearArray.length;Y++)R.push(new b((-1),(-E),(-E),z.nearArray[Y].portName,z.farArray[Y].portName))}z&&"SECURITY_DEVICE"===z.category?"DISCOVERY"===z.deviceSource?1===z.deviceOnline?(z.statusText="连线",z.statusIconShow=!1,z.statusColor="green"):z.deviceOnline===-1?(z.statusText="掉线",z.statusIconShow=!0,z.statusColor="red"):(z.statusText="未激活",z.statusIconShow=!0,z.statusColor="red"):(z.statusText="未激活",z.statusIconShow=!0,z.statusColor="red"):(z.statusText="",z.statusIconShow=!1,z.statusColor="white"),M||"SECURITY_DEVICE"!==z.category||(M=E-1);var K={};for(var J in z)z.hasOwnProperty(J)&&(K[J]=z[J]);c.push(z),$[E]=z,y[K.deviceId]=K,E++}}for(var Z=0;Z<p.length;Z++)N[E]=E,$[E]=p[Z].key,v[p[Z].key]=E,g[E]=p[Z].key,p[Z].key=-E,c.push(p[Z]),E++;for(var Q=[],X={},ee=0;ee<o.links.length;ee++){var te=-N[v[o.links[ee].nodeID]],ne=-N[v[o.links[ee].destinationNodeID]],oe="unspecified",ae="unspecified";if(h[v[o.links[ee].nodeID]])for(var re=0;re<m[v[o.links[ee].nodeID]].length;re++)if(m[v[o.links[ee].nodeID]][re]===o.links[ee].nodeID){m[v[o.links[ee].nodeID]][re]=-1,oe=o.links[ee].sourcePortName?o.links[ee].sourcePortName:h[v[o.links[ee].nodeID]].devicePorts[re].portName.toLowerCase();break}if(h[v[o.links[ee].destinationNodeID]])for(var ie=0;ie<m[v[o.links[ee].destinationNodeID]].length;ie++)if(m[v[o.links[ee].destinationNodeID]][ie]===o.links[ee].destinationNodeID){m[v[o.links[ee].destinationNodeID]][ie]=-1,ae=o.links[ee].destinationPortName?o.links[ee].destinationPortName:h[v[o.links[ee].destinationNodeID]].devicePorts[ie].portName.toLowerCase();break}Q.push(new b(o.links[ee].id,te,ne,oe,ae)),X[o.links[ee].id]=new b(o.links[ee].id,te,ne,oe,ae)}Q=Q.concat(R),C.linkCopy=X,y.length=c.length,C.nodeCopy=y,C.devicesNodeMapCopy=g,$.length=c.length,C.keyToDevice=$,C.allData=o,C.currentTopology=o.currentTopology,C.topologyId=o.topologyId,C.blankModelId=o.blankModel,C.model=new go.GraphLinksModel(c,Q),C.model.linkFromPortIdProperty="fromPort",C.model.linkToPortIdProperty="toPort",C.model.isReadOnly=!0,C.model.copyNodeDataFunction=D,n.drawing=!1;var le=[];for(u.config.isInfsafety?t.$on("infsafetyResult",function(e,t){t===-1?(le=[],C.model=new go.GraphLinksModel(c,Q)):(angular.copy(Q,le),Object.keys(t.pathSafty).forEach(function(e){var n;n=t.pathSafty[e]<=60?"#ff6d28":t.pathSafty[e]>=80?"#92d219":"#fff319",e=e.substring(1,e.length-1).split(/,\s+/);var o=s(e[0]),a=s(e[e.length-1]),r={from:-o,to:-a,color:n,toArrow:"Standard",strokeWidth:"3",suggestionPosition:!1,curve:go.Link.Bezier,curviness:50};le.push(r)}),l(t),C.model=new go.GraphLinksModel(c,le)),C.model.linkFromPortIdProperty="fromPort",C.model.linkToPortIdProperty="toPort",C.toolManager.dragSelectingTool.isEnabled=!1,C.toolManager.contextMenuTool.isEnabled=!1,C.model.isReadOnly=!0}):u.config.isAttackPath&&(le=angular.copy(Q,le),r.getAttackTarget(n.currentPath.pathId).then(function(e){if(e.data.length>1){for(var t=1;t<e.data.length;t++){var n=s(e.data[t-1].selectedTarget),o=s(e.data[t].selectedTarget),a={from:-n,to:-o,color:"red",toArrow:"Standard",strokeWidth:"3",suggestionPosition:!1,curve:go.Link.Bezier,curviness:50,targetOrder:e.data[t].targetOrder};le.push(a)}for(var r=0;r<e.data.length;r++)for(var i=0;i<c.length;i++)-s(e.data[r].selectedTarget)===c[i].key&&(c[i].targetOrder=e.data[r].targetOrder)}C.model=new go.GraphLinksModel(c,le),C.model.linkFromPortIdProperty="fromPort",C.model.linkToPortIdProperty="toPort",C.toolManager.dragSelectingTool.isEnabled=!1,C.toolManager.contextMenuTool.isEnabled=!1,C.model.isReadOnly=!0})),n.topologyHasNode&&(M=M===!1?0:M,f(d.lastSelection!==!1&&C.findNodeForKey(-N[d.lastSelection])?C.findNodeForKey(-N[d.lastSelection]):C.findNodeForData(C.model.nodeDataArray[M]))),n.oldData=[],ee=0;ee<C.model.nodeDataArray.length;ee++){n.validateDevice(C.model.nodeDataArray[ee]);var se={deviceId:C.model.nodeDataArray[ee].deviceId,serialNumber:C.model.nodeDataArray[ee].serialNumber,ip:C.model.nodeDataArray[ee].ip};n.oldData.push(se)}}d.config.isEdited&&d.config.EditTopo("edit topo"),d.config.isInfsafety&&d.config.drawInfsafety("infsafy"),d.config.isAttackPath&&d.config.drawAttackPath("infsafy");var P=go.GraphObject.make,A=P(go.Adornment,"Vertical",P("ContextMenuButton",P(go.TextBlock,"删除设备"),{click:function(){c()}})),C=P(go.Diagram,"topologySingle",{initialContentAlignment:go.Spot.TopCenter,scale:null===localStorage.getItem("monitor:topology.scale."+o)?1:parseFloat(localStorage.getItem("monitor:topology.scale."+o)),"toolManager.mouseWheelBehavior":go.ToolManager.WheelZoom,"undoManager.isEnabled":!0,allowDrop:!0,minScale:.1,maxScale:2,maxSelectionCount:1,grid:P(go.Panel,"Grid",{gridCellSize:new go.Size(50,50)},P(go.Shape,"LineH",d.gridPattern),P(go.Shape,"LineV",d.gridPattern))});C.scrollMode=go.Diagram.InfiniteScroll,C.nodeTemplate=P(go.Node,"Spot",{margin:50,name:"NODE",selectionAdorned:!1,deletable:!1},new go.Binding("location","loc",go.Point.parse),new go.Binding("deletable","deviceId",function(e){return"Device Id"===e}),new go.Binding("contextMenu","deviceId",function(e){return"Device Id"===e?A:""}),P(go.Panel,"Table",{toolTip:P(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},P(go.Shape,"Rectangle",{isPanelMain:!0,fill:d.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),P(go.Panel,"Vertical",{margin:10},P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("text","nameInDetail",function(e){return"设备名称: "+e})),P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("visible","category",function(e){return"SECURITY_DEVICE"===e}),new go.Binding("text","statusText",function(e){return"设备状态: "+e})),P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("visible","iconType",function(e){return!(["cloud"].indexOf(e)>=0)}),new go.Binding("text","modelInDetail",function(e){return"型号: "+e})),P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("visible","iconType",function(e){return!(["cloud","subnet","switch"].indexOf(e)>=0)}),new go.Binding("text","ports",function(e){var t=[];for(var n in e)n&&e[n]&&e[n].isMgmtPort&&t.push("[ "+(e[n].portIp?e[n].portIp:"未知")+" / "+(e[n].mac?e[n].mac:"未知")+" ]");return 1===t.length?"IP / MAC: "+t[0]:"IP / MAC: \n"+t.join("\n")}))))},P(go.Panel,"Auto",{row:0,column:1,name:"ORDER"},P(go.Shape,"Ellipse",{fill:"red",width:25,height:25,stroke:"red",visible:!1},new go.Binding("visible","targetOrder",function(e){return!!e})),P(go.TextBlock,{textAlign:"center",stroke:"white",width:25,font:d.nodeTopFont,visible:!0},new go.Binding("text","targetOrder"))),P(go.Panel,"Auto",{row:1,column:1,name:"BODY"},P(go.Shape,"RoundedRectangle",{stroke:"red",strokeWidth:2,opacity:1,width:100,height:122,visible:!1},new go.Binding("visible","targetOrder",function(e){return!!e})),P(go.Shape,"RoundedRectangle",{fill:null,strokeWidth:2,stroke:null,portId:"unspecified"},new go.Binding("fill","isSelected",function(e){return e?d.nodeSelectionBrush:null}).ofObject("")),P(go.Panel,"Auto",{alignment:go.Spot.Top},P(go.Shape,"RoundedRectangle",{width:100,fill:d.nodeTopFillBrush,stroke:null,name:"TextBox"},new go.Binding("fill","category",function(e){return d.getDeviceColor(e)})),P(go.TextBlock,{margin:new go.Margin(2,0,6,0),stroke:d.nodeTextBrush,isMultiline:!1,width:90,font:d.nodeTopFont,textAlign:"center",overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,name:"TEXT"},new go.Binding("text","nameInDetail"))),P(go.Shape,"Rectangle",{alignment:go.Spot.Top,width:100,fill:d.nodeBGBrush,stroke:null,height:10,margin:new go.Margin(20,0,0,0)}),P(go.Panel,"Auto",{margin:new go.Margin(20,0,0,0)},P(go.Shape,"RoundedRectangle",{width:100,fill:d.nodeBGBrush,strokeWidth:3,stroke:null}),P(go.Panel,"Vertical",{margin:new go.Margin(0,5,0,5)},P(go.Panel,"Auto",P(go.Picture,{margin:new go.Margin(5),width:80,height:65,imageStretch:go.GraphObject.Uniform},new go.Binding("source","img")),P(go.Picture,{margin:new go.Margin(38,40,0,0),width:30,imageStretch:go.GraphObject.Uniform},new go.Binding("visible","category",function(e){return"SECURITY_DEVICE"===e}),new go.Binding("source","serialNumber",function(e){var t=null;if(e&&e.length>=2){var n=e.substr(0,2).toLowerCase();["js","jc","sc","zb"].indexOf(n)>=0&&(t="/images/devices/security/badge-"+("jc"===n?"js":n)+".png")}return t})),P(go.Picture,{name:"OfflineIcon",margin:new go.Margin(0,0,0,0),width:60,height:55,source:"/images/Warning.f7811348.png"},new go.Binding("visible","statusIconShow"))),P(go.TextBlock,{stroke:d.nodeTextBrush,textAlign:"center",margin:new go.Margin(0,0,0,0),wrap:go.TextBlock.None,font:d.ipFont,height:9},new go.Binding("visible","iconType",function(e){return!(["cloud","subnet","switch"].indexOf(e)>=0)}),new go.Binding("text","key",function(e){var t=C.findNodeForKey(e).data;return"FACTORY_DEVICE"===t.category&&t.ports&&t.ports.length>0?t.ports[0].portIp?t.ports[0].portIp+(t.ports.length>1?" ...":""):"未知":t.ip&&0!==t.ip.length?t.ip:"未知"}),new go.Binding("stroke","statusIconShow",function(e){return e?d.statusOffBrush:d.nodeTextBrush})),P(go.TextBlock,{stroke:d.nodeTextBrush,textAlign:"center",margin:new go.Margin(0,0,0,0),wrap:go.TextBlock.None,font:d.ipFont,height:9},new go.Binding("visible","iconType",function(e){return["cloud","subnet","switch"].indexOf(e)>=0}))),P(go.Shape,"Circle",{fill:d.centerConnectorFill,desiredSize:new go.Size(16,16),strokeWidth:4,stroke:d.centerConnectorStroke,margin:new go.Margin(0,0,20,0),fromLinkable:!0,toLinkable:!0,name:"middlePort"},new go.Binding("opacity","",function(){return d.EditMode?1:0}),new go.Binding("portId","portIdRef",function(e){return e?"foreGround":"security"}),new go.Binding("cursor","",function(){return d.EditMode?"pointer":"default"}),new go.Binding("visible","portIdRef")))),P(go.Panel,"Vertical",new go.Binding("itemArray","nearArray"),{row:1,column:0,itemTemplate:P(go.Panel,{fromSpot:go.Spot.Right,toSpot:go.Spot.Left},new go.Binding("portId","portName"),P(go.Shape,"Rectangle",{stroke:null,fill:null,desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)}))}),P(go.Panel,"Vertical",new go.Binding("itemArray","farArray"),{row:1,column:2,itemTemplate:P(go.Panel,{fromSpot:go.Spot.Right,toSpot:go.Spot.Left},new go.Binding("portId","portName"),P(go.Shape,"Rectangle",{stroke:null,fill:null,desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)}))}),P(go.Panel,"Vertical",new go.Binding("itemArray","rightArray"),{row:1,column:2,itemTemplate:P(go.Panel,{mouseEnter:function(e,t){d.hovered=Math.floor(Number(t.data.portName[1])/2),C.updateAllTargetBindings("portName")},mouseLeave:function(){d.hovered=100,C.updateAllTargetBindings("portName")},fromSpot:go.Spot.Right,toSpot:go.Spot.Right,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),P(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)},new go.Binding("fill","portName",function(e){return d.EditMode?d.centerConnectorStroke:Math.floor(Number(e[1])/2)===d.hovered?d.centerConnectorStroke:d.connectorBrush}),new go.Binding("stroke","portName",function(e){return d.EditMode&&Math.floor(Number(e[1])/2)===d.hovered?"red":null}),new go.Binding("cursor","",function(){return d.EditMode?"pointer":"default"})),{toolTip:P(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},P(go.Shape,"Rectangle",{isPanelMain:!0,fill:d.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),P(go.Panel,"Vertical",{margin:10},P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("text","portName",function(e){return"端口: "+e}))))})}),P(go.Panel,"Vertical",new go.Binding("itemArray","leftArray"),{row:1,column:0,itemTemplate:P(go.Panel,{mouseEnter:function(e,t){d.hovered=Math.floor(Number(t.data.portName[1])/2),C.updateAllTargetBindings("portName")},mouseLeave:function(){d.hovered=100,C.updateAllTargetBindings("portName")},fromSpot:go.Spot.Left,toSpot:go.Spot.Left,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),P(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)},new go.Binding("fill","portName",function(e){return Math.floor(Number(e[1])/2)===d.hovered?d.centerConnectorStroke:d.connectorBrush}),new go.Binding("cursor","",function(){return d.EditMode?"pointer":"default"})),{toolTip:P(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},P(go.Shape,"Rectangle",{isPanelMain:!0,fill:d.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),P(go.Panel,"Vertical",{margin:10},P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("text","portName",function(e){return"端口: "+e}))))})}),P(go.Panel,"Horizontal",new go.Binding("itemArray","bottomArray"),{row:2,column:1,itemTemplate:P(go.Panel,{mouseEnter:function(e,t){for(var n="bottomArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=d.centerConnectorStroke;break}C.updateAllTargetBindings("portColor")},mouseLeave:function(e,t){for(var n="bottomArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=d.connectorBrush;break}C.updateAllTargetBindings("portColor")},fromSpot:go.Spot.Bottom,toSpot:go.Spot.Bottom,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),P(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(0,1)},new go.Binding("fill","",function(e){return e.portColor?e.portColor:d.connectorBrush}),new go.Binding("cursor","",function(){return d.EditMode?"pointer":"default"})),{toolTip:P(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},P(go.Shape,"Rectangle",{isPanelMain:!0,fill:d.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),P(go.Panel,"Vertical",{margin:10},P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("text","portName",function(e){return"端口: "+e})),P(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:d.nodeTopFont},new go.Binding("text","portIp",function(e){return"IP: "+e}))))})})));var k=P(go.Adornment,"Vertical",P("ContextMenuButton",P(go.TextBlock,"删除连线"),{
click:function(){c()}}));C.linkTemplate=P(go.Link,{curve:go.Link.JumpOver,routing:go.Link.Normal,corner:5,contextMenu:k,relinkableFrom:!0,relinkableTo:!0},new go.Binding("contextMenu","",function(){return d.EditMode?k:null}),new go.Binding("selectable","linkId",function(e){return e!==-1}),new go.Binding("routing","link"),new go.Binding("curve","curve"),new go.Binding("curviness","curviness"),P(go.Shape,{strokeWidth:15,stroke:"transparent",isPanelMain:!0},new go.Binding("strokeWidth","strokeWidth"),new go.Binding("stroke","color"),new go.Binding("visible","linkId",function(e){return!(e===-1&&!d.EditMode)})),P(go.Shape,{strokeWidth:5,visible:!0},new go.Binding("stroke","color"),new go.Binding("toArrow","toArrow"),new go.Binding("visible","linkId",function(e){return!(e===-1&&!d.EditMode)})),P(go.Panel,"Auto",{},P(go.Shape,"Ellipse",{fill:null,stroke:"#74b600",width:29,height:29,strokeWidth:2,opacity:.5,visible:!1},new go.Binding("visible","suggestionPosition")),P(go.Shape,"Ellipse",{fill:null,stroke:"#74b600",width:20,height:20,strokeWidth:2,opacity:.5,visible:!1},new go.Binding("visible","suggestionPosition")),P(go.Shape,"Ellipse",{fill:"#74b600",stroke:"#74b600",width:13,height:13,strokeWidth:1,opacity:.5,visible:!1},new go.Binding("visible","suggestionPosition"))),P(go.TextBlock,{text:"请在此处增加匡恩工控保护设备",font:d.nodeTopFont,stroke:"#74b600",visible:!1,alignmentFocus:new go.Spot((-.1),.5,(-3),0)},new go.Binding("visible","suggestionPosition"))),C.click=function(){C.startTransaction("no highlighteds"),C.clearHighlighteds(),C.commitTransaction("no highlighteds"),n.$digest()},C.mouseDrop=function(){C.startTransaction("getNode"),C.selection.each(function(e){e instanceof go.Node&&!(C.selection.dd>1)&&(f(e),n.$digest())}),C.commitTransaction("getNode")},document.getElementById("topologySingle").onmousedown=function(e){e.which&&3===e.which&&C.toolManager.panningTool.doActivate()},document.getElementById("topologySingle").onmousemove=function(e){(3===e.which||navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&2===e.buttons)&&(C.toolManager.panningTool.doMouseMove(),C.currentCursor="all-scroll",C.toolManager.draggingTool.doCancel())},document.getElementById("topologySingle").onmouseup=function(e){if(e.which&&3===e.which){C.toolManager.panningTool.doDeactivate();for(var t=C.nodes.iterator;t.next();)if(t.value instanceof go.Node){t.value.location.x=t.value.location.x+(C.toolManager.panningTool.originalPosition.x-C.position.x),t.value.location.y=t.value.location.y+(C.toolManager.panningTool.originalPosition.y-C.position.y);var n={id:t.value.data.nodeId,x:t.value.location.x,y:t.value.location.y};a.updatePosition(n)}}},d.saveData=function(e){C.updateAllTargetBindings("nameInDetail"),C.updateAllTargetBindings("ip"),d.EditMode&&(n.selectedDeviceInTable.isEdited?n.selectedDeviceInTable.isEdited.indexOf(e)===-1?C.model.insertArrayItem(n.selectedDeviceInTable.isEdited,-1,e):"":C.model.setDataProperty(n.selectedDeviceInTable,"isEdited",[e]))},n.forms={},n.validateIp=angular.copy(s.getIPReg()),n.validateMac=angular.copy(s.getMACReg()),n.validateDevice=function(e){e.nameError=!e.nameInDetail||0===e.nameInDetail.length,e.modelError=(!e.modelId||0===e.modelId.length)&&"subnet"!==e.iconType.toLowerCase(),e.invalidIp=!(e.ip&&e.ip.match(n.validateIp)||["router","cloud","switch"].indexOf(e.iconType.toLowerCase())!==-1),"SECURITY_DEVICE"===e.category?(e.serialError=!e.serialNumber||0===e.serialNumber.length,e.serialFormatError=!l.validSNFormat(e.serialNumber),e.invalidMac=e.mac&&!e.mac.match(n.validateMac)):e.invalidMac=e.mac&&!e.mac.match(n.validateMac),"subnet"===e.iconType.toLowerCase()?e.invalidNetMask=!e.ports[0].netMask||!e.ports[0].netMask.match(n.validateIp):"",e.hasDuplicateSN=v(e.deviceId,e.serialNumber,C.model.nodeDataArray),e.hasDuplicateIP=y(e.deviceId,e.ip,C.model.nodeDataArray),e.hasDuplicateMAC=I(e.deviceId,e.mac,C.model.nodeDataArray),e.invalid=e.nameError||e.modelError||e.invalidIp||e.serialError||e.invalidMac||e.invalidNetMask||e.hasDuplicateSN||e.hasDuplicateIP||"SECURITY_DEVICE"===e.category&&e.serialFormatError;for(var t,o=0;o<C.model.nodeDataArray.length;o++)t=t||C.model.nodeDataArray[o].invalid;d.invalid=t},n.populateModelOptions=function(e){"cloud"!==n.selectedDeviceInTable.nodeType.toLowerCase()&&(n.forms.models=[],"FACTORY_DEVICE"===e?n.forms.models=d.factory_models:"NETWORK_DEVICE"===e?n.forms.models=d.network_models:"SECURITY_DEVICE"===e&&(n.forms.models=d.security_models,n.selectedDeviceInTable.modelId||(n.selectedDeviceInTable.modelId=n.forms.models[0].modelId,n.modelChange(n.selectedDeviceInTable))))},n.populateModeOptions=function(e,t){n.forms.modes=[];var o=t;t&&t.indexOf(" / ")>0&&(o=t.split(" / ")[1]),"DATA_COLLECTION_DEVICE"===e||0===o.indexOf("KED")?(n.forms.modes[0]={},n.forms.modes[0].mode="IPS",n.forms.modes[0].modename="数采隔离"):0===o.indexOf("KEA")?(n.forms.modes[0]={},n.forms.modes[0].mode="IDS",n.forms.modes[0].modename="监测审计"):0===o.indexOf("KEV")?"KEV-U800"===o?(n.forms.modes[0]={},n.forms.modes[0].mode="IPS",n.forms.modes[0].modename="智能保护"):(n.forms.modes[0]={},n.forms.modes[1]={},n.forms.modes[0].mode="IPS",n.forms.modes[1].mode="ROUTING_IPS",n.forms.modes[0].modename="智能保护",n.forms.modes[1].modename="路由保护"):0===o.indexOf("KEC")&&(n.forms.modes[0]={},n.forms.modes[1]={},n.forms.modes[0].mode="IPS",n.forms.modes[1].mode="IDS",n.forms.modes[0].modename="智能保护",n.forms.modes[1].modename="监测审计")},n.modelChange=function(e){for(var t in n.forms.models)if(t&&n.forms.models[t].modelId===e.modelId){if(e.manufacturerInDetail=n.forms.models[t].make,e.numPorts=n.forms.models[t].numOfPorts,e.modelInDetail=n.forms.models[t].model_name+" / "+n.forms.models[t].model,"SECURITY_DEVICE"===e.category){["kea-c200","kea-c400","ked-c400","kev-c200","kev-c400"].indexOf(n.forms.models[t].model.toLowerCase())>=0?C.model.setDataProperty(e,"img","images/devices/security/"+n.forms.models[t].model.toLowerCase()+"-icon.png"):C.model.setDataProperty(e,"img","images/devices/security/"+n.forms.models[t].iconType+"-icon.png"),e.iconType=n.forms.models[t].iconType;var o=n.forms.models[t].model_name+" / "+n.forms.models[t].model;d.newModel(n.forms.models[t].model),n.populateModeOptions(e.subcategory,o)}e.subcategory=n.forms.models[t].subCategory;break}d.saveData("basic"),n.validateDevice(e)},n.modeChange=function(e){for(var t in n.forms.modes)if(t&&n.forms.modes[t].modename===e.modeDescription){e.nodeType=n.forms.modes[t].mode,"数采隔离"===e.modeDescription&&(e.subCategory=1),0===e.modelInDetail.indexOf("KEV")&&d.newModel(e.modelInDetail);break}n.validateDevice(e)},C.animationManager.isEnabled=!1,C.toolManager.draggingTool.isGridSnapEnabled=!0,C.toolManager.draggingTool.gridSnapCellSize=new go.Size(1,1),C.toolManager.panningTool.isEnabled=!1,C.toolManager.dragSelectingTool.isEnabled=!1,C.toolManager.hoverDelay=1200,C.toolManager.dragSelectingTool.box=P(go.Part,{layerName:"Tool"},P(go.Shape,{name:"SHAPE",fill:"gray",opacity:.3,strokeWidth:1})),C.toolManager.linkingTool.temporaryLink=P(go.Link,{layerName:"Tool"},P(go.Shape,{strokeWidth:2,stroke:d.centerConnectorStroke}),P(go.Shape,{toArrow:"Standard",fill:d.centerConnectorStroke,stroke:null})),C.toolManager.linkingTool.temporaryFromPort.strokeWidth=2,C.toolManager.linkingTool.temporaryFromPort.stroke=d.centerConnectorStroke,C.toolManager.linkingTool.temporaryFromPort.figure="Circle",C.toolManager.linkingTool.temporaryFromPort.fill=d.centerConnectorStroke,C.toolManager.linkingTool.temporaryToPort.strokeWidth=2,C.toolManager.linkingTool.temporaryToPort.stroke=d.centerConnectorStroke,C.toolManager.linkingTool.temporaryToPort.figure="Circle",C.toolManager.linkingTool.temporaryToPort.fill=d.centerConnectorStroke,C.addDiagramListener("SelectionMoved",p),C.addDiagramListener("ObjectSingleClicked",h),n.drawTopo=function(e){T(e)},n.putDiagramData=function(e){S(e)},d.EnterEdit=function(e){if(e)return d.EditMode=!d.EditMode,d.lastSelection=!1,void n.render("update");if(C.startTransaction("Edit"),d.EditMode){for(var t=0;t<C.model.linkDataArray.length;t++)"foreGround"===C.model.linkDataArray[t].fromPort&&C.model.setDataProperty(C.model.linkDataArray[t],"fromPort","unspecified"),"foreGround"===C.model.linkDataArray[t].toPort&&C.model.setDataProperty(C.model.linkDataArray[t],"toPort","unspecified");C.toolManager.dragSelectingTool.isEnabled=!1,C.toolManager.contextMenuTool.isEnabled=!1,C.model.isReadOnly=!0}else{for(var o=0;o<C.model.linkDataArray.length;o++)"unspecified"===C.model.linkDataArray[o].fromPort&&C.model.setDataProperty(C.model.linkDataArray[o],"fromPort","foreGround"),"unspecified"===C.model.linkDataArray[o].toPort&&C.model.setDataProperty(C.model.linkDataArray[o],"toPort","foreGround");C.toolManager.dragSelectingTool.isEnabled=!0,C.model.isReadOnly=!1,d.EditMode=!0,C.updateAllTargetBindings("nameInDetail"),C.updateAllTargetBindings("linkId")}C.commitTransaction("Edit")}})}var u={scope:!1,restrict:"E",replace:!0,transclude:!0,templateUrl:"/templates/common/cdiagram.9139d467.html",controllerAs:"cdiagram",controller:c,link:d};return u}e.$inject=["Device","$rootScope","sse","$q","Topology","Attack","$filter","snVal","formatVal"],angular.module("southWest.directives").directive("cdiagram",e)}(),function(){"use strict";angular.module("southWest.directives").directive("clock",function(){return{restrict:"E",scope:{time:"=?"},templateUrl:"/templates/common/clock.bf624ce3.html",link:function(e,t){function n(e){r=e?new Date(e).getTime()-(new Date).getTime():0,clearInterval(i),o(),i=setInterval(o,100)}function o(){var e=new Date((new Date).getTime()+r),n=e.getSeconds(),o=e.getMinutes(),a=e.getHours(),i=e.getDate(),l=e.getMonth()+1,s=e.getFullYear(),c=6*n,d=6*o+.1*n,u=30*a+.5*o;t.find(".sec-hand").css("transform","rotate("+c+"deg)"),t.find(".min-hand").css("transform","rotate("+d+"deg)"),t.find(".hour-hand").css("transform","rotate("+u+"deg)"),t.find(".date").text(i),t.find(".month").text(l),t.find(".year").text(s)}var a=t.find(".diallines");a.each(function(e,t){$(t).css("transform","rotate("+6*e+"deg)")});var r,i;e.$watch("time",function(e){n(e)}),e.$on("$destroy",function(){clearInterval(i)})}}})}(),function(){"use strict";function e(){return{restrict:"A",link:function(e,t,n){function o(e,n){jQuery({Counter:e}).animate({Counter:n},{duration:1e3,easing:"swing",step:function(){t.text(Math.round(this.Counter))}})}e.$watch(n.ngBind,function(e,n){return e?(n===e&&(n=0),void o(n,e)):t.text(0)})}}}angular.module("southWest.directives").directive("countAnimation",e)}(),function(){"use strict";angular.module("southWest.directives").directive("customCheckbox",function(){return{restrict:"A",compile:function(e,t){return e.after('<label class="'+(t.class||"custom-checkbox")+'"'+(t.ngHide?" ng-hide="+t.ngHide:"")+"></label>").parent().addClass("custom-checkbox-wrap"),{post:function(e,t,n){var o;n.id?t.next("label").attr("for",n.id):(o="custom-checkbox-"+e.$id+"-"+Math.ceil(1e4*Math.random()),t.attr("id",o),t.next("label").attr("for",o)),n.ngDisabled&&e.$watch(n.ngDisabled,function(e){e?t.parent().addClass("disabled"):t.parent().removeClass("disabled")})}}}}})}(),function(){"use strict";function e(){var e={scope:!1,restrict:"E",replace:!0,transclude:!0,templateUrl:"/templates/common/customNetworkRule.71243efc.html",controllerAs:"networkRule",controller:t};return e}function t(e){e.optionSelected=function(e,t){t.option?t.placeHolder="":t.placeHolder="任意"}}angular.module("southWest.directives").directive("customNetworkRule",e)}(),function(){"use strict";angular.module("southWest.directives").directive("customRadio",function(){return{restrict:"A",compile:function(e,t){return e.after('<label class="'+(t.class||"custom-radio")+'"'+(t.ngHide?" ng-hide="+t.ngHide:"")+"></label>").parent().addClass("custom-radio-wrap"),{post:function(e,t,n){var o;n.id?t.next("label").attr("for",n.id):(o="custom-radio-"+e.$id+"-"+Math.ceil(1e4*Math.random()),t.attr("id",o),t.next("label").attr("for",o)),n.ngDisabled&&e.$watch(n.ngDisabled,function(e){e?t.parent().addClass("disabled"):t.parent().removeClass("disabled")})}}}}})}(),function(){"use strict";function e(){return{require:"?ngModel",scope:{customVal:"@",validator:"&",valArgs:"=?"},link:function(e,t,n,o){o&&o.$validators&&(o.$validators[e.customVal]=function(t){return e.validator()(t,e.valArgs)})}}}angular.module("southWest.directives").directive("customVal",e)}(),function(){"use strict";function e(e){return{restrict:"A",link:function(t,n){e(function(){n.dotdotdot({wrap:"letter",watch:!0})})}}}e.$inject=["$timeout"],angular.module("southWest.directives").directive("dotdotdot",e)}(),function(){"use strict";function e(e,t){function n(e,t,n,o,a,r,l,s,c){"ngInject";function d(e){var t,n;return e&&e.startDate&&e.startTime&&(t=moment(e.startDate).format("YYYY-MM-DD")+"T"+moment(e.startTime).format("HH:mm:ss"),t=moment(t).utc().format()),e&&e.endDate&&e.endTime&&(n=moment(e.endDate).format("YYYY-MM-DD")+"T"+moment(e.endTime).format("HH:mm:ss"),n=moment(n).utc().format()),{start:t,end:n}}function u(){var e={$limit:k.totalNum};if(E.predicate&&(e.$orderby=E.predicate+(E.reverse?" desc":"")),(k.query&&k.query.length||k.dateTimeRange&&k.dateTimeRange.enable)&&(k.query&&(e.$filter=i(k.query,S)),k.dateTimeRange&&k.dateTimeRange.enable)){var t=d(k.dateTimeRange);e.$filter=(e.$filter?e.$filter+" and ":"")+"("+P+" ge '"+t.start+"'"+(t.end?" and "+P+" le '"+t.end+"')":")")}C(e).then(function(e){window.open("./"+e,"_self")})}function p(){var e;if(e=k.pagination?{$skip:(k.currentPage-1)*k.numPerPage,$limit:k.numPerPage}:{$limit:void 0},E.predicate&&(e.$orderby=E.predicate+(E.reverse?" desc":"")),k.searchDefer&&k.searchDefer.resolve&&k.searchDefer.resolve("success"),k.searchDefer=t.defer(),k.advancedSearchQuery&&g(e),k.query&&k.query.length||k.dateTimeRange&&k.dateTimeRange.enable)k.searchPromise=k.searchDefer.promise,m(e);else{"normal"!==k.filter&&(e.$filter?e.$filter+=" and (contains(protocolSourceName,'"+k.filter+"'))":e.$filter="(contains(protocolSourceName,'"+k.filter+"'))");var o=angular.copy(e);k.searchPromise=k.searchDefer.promise,I(e).then(function(e){if("signature"===k.name||"custom"===k.name||"template"===k.name){var t=l.policyId;delete o.$skip,o.$limit=k.totalNum,I(o).then(function(e){r(k,t,k.name,e,function(e){var t=(k.currentPage-1)*k.numPerPage;k.table=e.slice(t,t+k.numPerPage),k.searchDefer.resolve("success")})})}else k.table=e,k.searchDefer.resolve("success");n(function(){angular.element(window).trigger("resize")},50)},function(){k.searchDefer.resolve("fail")}),f(e)}}function f(e){var t;e&&e.$filter&&(t={$filter:e.$filter}),D(t).then(function(e){k.totalNum=e||0})}function m(e){if(k.query&&(e.$filter?e.$filter=e.$filter+" and "+i(k.query,S):e.$filter=i(k.query,S)),k.dateTimeRange&&k.dateTimeRange.enable){var t=d(k.dateTimeRange);e.$filter=(e.$filter?e.$filter+" and ":"")+"("+P+" ge '"+t.start+(t.end?"' and "+P+" le '"+t.end+"')":"')")}f(e),T(e).then(function(e){k.table=e,k.searchDefer.resolve("success")},function(){k.searchDefer.resolve("fail")})}function g(e){k.advancedSearchQuery&&(e.$filter=k.advancedSearchQuery)}function h(){if(k.dateTimeRange.enable=!k.dateTimeRange.enable,!k.dateTimeRange.enable){var e={$skip:(k.currentPage-1)*k.numPerPage,$limit:k.numPerPage};m(e)}}function v(){k.advancedSearchOptions.map(function(e){e.value="checkbox"===e.input?e.options[0].value:"",e.error=!1,e.invalidMsg=""}),k.advancedSearchQuery=k.isSearching=k.query=k.q="",k.advancedSearch.enable=!k.advancedSearch.enable}function y(){if(b){var t=e.$on(k.name,function(e,t){p()});e.$on("$destroy",function(){t()})}}var I,D,T,b,S,P,A,C,k=this,w=/^([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$/,E={},N=t.defer();k.linkPromise=N.promise,k.pagination=!0,k.totalCount=!0,k.scrollable=!0,k.currentPage=1,k.numPerPage=10,k.table={},k.query="",k.filter="normal",k.validIp=w,k.advancedSearchQuery="",k.disabledTimeOptions=!1,k.setConfig=function(e){var t=!!k.advancedSearch&&k.advancedSearch.enable;k.query="",k.advancedSearchQuery="",I=e.getAll,D=e.getCount,T=e.search,C=e.getAllExport,b=e.name,S=e.fields,P=e.dateTimeRange,A=e.advancedSearch,E.predicate=e.predicate,E.reverse=e.reverse,e.numPerPage&&(k.numPerPage=e.numPerPage),k.dateTimeRange=e.dateTimeRange&&{enable:!1},k.advancedSearch=e.advancedSearch&&{enable:!1},k.advancedSearchOptions=e.advancedSearch&&e.advancedSearchOptions,k.advancedSearchTimeRange={},k.advancedSearchOptions&&k.advancedSearchOptions.map(function(e){"timerange"===e.input&&(k.advancedSearchTimeRange=e)}),k.name=e.name,k.pagination=e.pagination,k.totalCount=e.totalCount,k.scrollable=e.scrollable,k.disabledTimeOptions=e.disabledTimeOptions,N.resolve(k.scrollable),p(),y(),k.advancedSearch&&(k.advancedSearch.enable=t)},k.getTableData=p,k.getTableDataCount=f,k.rangeSearch=h,k.highAdvancedSearch=v,k.getTableExport=u,k.advancedSearchApply=function(){var e="";k.advancedSearchOptions.forEach(function(t){if(("string"===t.input||["ipAdress","macAdress","portNum"].indexOf(t.input)>=0)&&t.value){e+=e?" and (":"(";var n=t.value.split(" ");if("sourcePort"!==t.name&&"destinationPort"!==t.name||1!==n.length)for(var o=0;o<n.length;o++)e+="contains("+t.name+",'"+n[o]+"')",e+=o<n.length-1?" and ":")";else e+=t.name+" eq '"+n[0]+"')"}if("checkbox"===t.input&&parseInt(t.value)!==-1&&(e?(e+=" and "+t.name,e+=" eq "+("string"===t.parser?"'"+t.value+"'":t.value)):(e+=t.name,e+=" eq "+("string"===t.parser?"'"+t.value+"'":t.value))),"list_checkbox"===t.input&&t.value!==[]){for(var a=0,r=0;r<t.options.length;r++)if(t.options[r].value===!0){var i="profinetio"===k.filter&&"dataType"===t.name;0===a?i?e?(e+=" and (contains("+t.name,e+=",'"+t.options[r].name+"')"):(e+="(contains("+t.name,e+=",'"+t.options[r].name+"')"):e?(e+=" and ("+t.name,e+=" eq '"+t.options[r].name+"'"):(e+="("+t.name,e+=" eq '"+t.options[r].name+"'"):i?e?(e+=" or contains("+t.name,e+=",'"+t.options[r].name+"')"):(e+="contains("+t.name,e+=",'"+t.options[r].name+"')"):e?(e+=" or "+t.name,e+=" eq '"+t.options[r].name+"'"):(e+=t.name,e+=" eq '"+t.options[r].name+"'"),a++}a&&(e+=")")}if("timerange"===t.input&&k.advancedSearchTimeRange.startDate){var l=d(k.advancedSearchTimeRange);e+="("+t.name+" ge '"+l.start+(l.end?"' and "+t.name+" le '"+l.end+"')":"')")}}),k.advancedSearchQuery=k.isSearching=e,k.currentPage=1,p()},k.doAdvancedSearch=function(e){c.getTime().then(function(t){s.currentTime=new Date(t),"r"!==e&&k.setAdvancedSearchTimeRange(e),k.query="",k.advancedSearchApply(),k.isSearching=k.advancedSearchQuery})},k.getOrderConfig=function(){return E},k.getAdvancedSearchDateTimeRange=function(){return k.advancedSearchTimeRange&&angular.extend(k.advancedSearchTimeRange,{startDate:moment(s.currentTime).subtract(3,"days").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(3,"days").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}),k.advancedSearchTimeRange},k.setAdvancedSearchTimeRange=function(e){return delete k.advancedSearchTimeRange.endDate,delete k.advancedSearchTimeRange.endTime,"n"===e?(delete k.advancedSearchTimeRange.startDate,delete k.advancedSearchTimeRange.startTime):"m"===e?angular.extend(k.advancedSearchTimeRange,{startDate:moment(s.currentTime).subtract(30,"days").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(30,"days").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}):"h"===e?angular.extend(k.advancedSearchTimeRange,{startDate:moment(s.currentTime).subtract(1,"hours").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(1,"hours").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}):"d"===e?angular.extend(k.advancedSearchTimeRange,{startDate:moment(s.currentTime).subtract(1,"days").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(1,"days").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}):"w"===e?angular.extend(k.advancedSearchTimeRange,{startDate:moment(s.currentTime).subtract(7,"days").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(7,"days").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}):"y"===e?angular.extend(k.advancedSearchTimeRange,{startDate:moment(s.currentTime).subtract(1,"years").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(1,"years").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}):angular.extend(k.advancedSearchTimeRange,{startDate:moment(s.currentTime).subtract(1,"days").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(1,"days").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}),k.advancedSearchTimeRange},k.getDateTimeRange=function(){return k.dateTimeRange&&angular.extend(k.dateTimeRange,{startDate:moment(s.currentTime).subtract(3,"days").milliseconds(0).toDate(),startTime:moment(s.currentTime).subtract(3,"days").milliseconds(0).toDate(),endDate:moment(s.currentTime).milliseconds(0).toDate(),endTime:moment(s.currentTime).milliseconds(0).toDate()}),k.dateTimeRange},k.updateNumPerPage=k.pageChanged=p,k.sort=function(e){E.predicate=e,E.reverse=!E.reverse,p()},k.searchBar=function(e){k.query=e,k.currentPage=1,p()},k.refresh=function(){k.advancedSearch&&k.advancedSearch.enable?k.doAdvancedSearch(k.s):(k.isSearching=k.q,k.advancedSearchQuery="",k.searchBar(k.q))},k.getDataByCustomParameter=function(e){k.advancedSearchQuery=e,p()}}function o(n,o,a,r){r.linkPromise.then(function(a){function r(){var t=c.height(),o='<div class="fixed-table-header">';o+='<table class="table table-striped table-bordered"><thead>'+c.html()+"</thead>",o+="</table>",o+="</div>";var a=e(o)(n);s.prepend(a).find(".fixed-table-body").css("height","calc(100% - "+t+"px)").find("table").css("margin-top",-t),l=s.find(".fixed-table-header th")}function i(){c.find("th").each(function(e,t){angular.element(l[e]).width(angular.element(t).width())})}if(a){var l=null,s=o.find(".fixed-table-container"),c=s.find(".fixed-table-body thead"),d=angular.element(t);r(),i(),d.on("resize",i),n.$on("$destroy",function(){d.off("resize",i)})}})}n.$inject=["$scope","$q","$timeout","URI","sse","initializeData","$stateParams","$rootScope","serverTime"];var a={scope:!1,restrict:"E",replace:!0,transclude:!0,templateUrl:"/templates/common/dtable.51fc51d8.html",controllerAs:"dtable",controller:n,link:o};return a}function t(){function e(e,t,n,o){e.order=o.getOrderConfig(),e.sort=function(){o.sort(e.orderBy)}}var t={scope:{orderBy:"@"},require:"^dtable",restrict:"A",transclude:!0,templateUrl:"/templates/common/orderBy.c9ad254e.html",link:e};return t}function n(e){function t(t,n,o,a){angular.extend(t,{range:a.getDateTimeRange()}),t.validateTimePeriod=function(n,o){var a=moment(n.startDate).format("YYYY-MM-DD")+"T"+moment(n.startTime).format("HH:mm:ss");a=moment(a).utc().format();var r=moment(n.endDate).format("YYYY-MM-DD")+"T"+moment(n.endTime).format("HH:mm:ss");r=moment(r).utc().format();var i=moment(e.currentTime).utc().format();t.invalidStartTime="",t.invalidEndTime="","Invalid date"===a&&(t.invalidStartTime="开始日期/时间不合法"),"Invalid date"===r&&(t.invalidEndTime="结束日期/时间不合法"),0===t.invalidStartTime.length&&0===t.invalidEndTime.length&&("startdate"===o||"starttime"===o?a>i?t.invalidStartTime="开始时间不可在当前时间之后":a>=r&&(t.invalidStartTime="开始时间要在结束时间之前"):r>i?t.invalidEndTime="结束时间不可在当前时间之后":a>=r&&(t.invalidEndTime="结束时间要在开始时间之后"))}}var n={scope:!1,require:"^dtable",restrict:"E",replace:!0,templateUrl:"/templates/common/dtable.rangeSelector.2511f20b.html",link:t};return n}function o(e,t,n){function o(o,a,r,i){angular.extend(o,{range:i.getAdvancedSearchDateTimeRange()}),e.on("click",function(e){if(!$(e.target).is("div.multiselect-parent")&&!$(e.target).closest("div.multiselect-parent").is("div.multiselect-parent")){for(var t=0;t<i.advancedSearchOptions.length;t++){var n=i.advancedSearchOptions[t];"list_checkbox"===n.input&&(n.open=!1)}o.$digest()}}),o.validateTimePeriod=function(e,n){var a,r;a="string"==typeof e.startTime?e.startTime:moment(e.startTime).format("HH:mm:ss"),r="string"==typeof e.endTime?e.endTime:moment(e.endTime).format("HH:mm:ss");var i=moment(e.startDate).format("YYYY-MM-DD")+"T"+moment(e.startTime).format("HH:mm:ss");i=moment(i).utc().format();var l=moment(e.endDate).format("YYYY-MM-DD")+"T"+moment(e.endTime).format("HH:mm:ss");l=moment(l).utc().format();var s=moment(t.currentTime).utc().format();o.invalidStartTime="",o.invalidEndTime="","Invalid date"===i&&(o.invalidStartTime="开始日期/时间不合法"),"Invalid date"===l&&(o.invalidEndTime="结束日期/时间不合法"),0===o.invalidStartTime.length&&0===o.invalidEndTime.length&&("startdate"===n||"starttime"===n?i>s?o.invalidStartTime="开始时间不可在当前时间之后":i>=l&&(o.invalidStartTime="开始时间要在结束时间之前"):l>s?o.invalidEndTime="结束时间不可在当前时间之后":i>=l&&(o.invalidEndTime="结束时间要在开始时间之后"))},o.validate=function(e){if(""===e.value)e.error=!1,e.invalidMsg="";else switch(e.input){case"ipAdress":e.error=n.validateIp(e.value),e.invalidMsg=e.error?"请输入合法IP地址":"";break;case"macAdress":e.error=n.validateMac(e.value),e.invalidMsg=e.error?"请输入合法MAC地址":"";break;case"portNum":e.error=!n.checkPortInput(e.value),e.invalidMsg=e.error?"请输入合法端口列表":""}},o.getMultiselectItems=function(e){for(var t="",n=0;n<e.length;n++)e[n].value===!0&&(0!==t.length&&(t+=", "),t+="NONSTANDARD"===e[n].name?"其他":e[n].name);return t||"请选择"}}var a={scope:!1,require:"^dtable",restrict:"E",replace:!0,templateUrl:"/templates/common/dtable.advanced-search.94feda6e.html",link:o};return a}function a(e){var t={restrict:"E",require:"ngModel",replace:!0,templateUrl:"/templates/common/timePicker.62a11688.html",scope:{value:"=ngModel",name:"@name",id:"@id",placeholder:"=placeholder",ngdisabled:"=ngDisabled",click:"&",control:"=",hide:"&",pickSeconds:"=?"},link:function(t,n,o,a){t.showWidget=function(){t.picker&&t.picker.show&&t.picker.show()},t.setTime=function(){t.picker&&t.value?(t.picker.setLocalDate(t.value),t.picker.notifyChange()):t.picker&&t.placeholder&&(t.picker.setLocalDate(t.placeholder),t.picker.notifyChange())},t.internalControl=t.control||{},t.internalControl.clearDate=function(){t.picker&&(t.picker.setLocalDate(t.placeholder),n.find("input").val(""))},$.fn.datetimepicker.Constructor.prototype.actions.showHours=function(){},$.fn.datetimepicker.Constructor.prototype.actions.showMinutes=function(){},$.fn.datetimepicker.Constructor.prototype.actions.showSeconds=function(){},n.datetimepicker({pickDate:!1,pickSeconds:t.pickSeconds!==!1}).on("hide",function(){_.isFunction(t.hide)&&t.hide({time:a.$modelValue})}),t.picker=n.data("datetimepicker"),n.on("changeDate",function(e){var t=new Date(e.date.getTime()+6e4*e.date.getTimezoneOffset());a.$setViewValue(t),n.find("input").blur()}),a.$render=function(){var n=a.$modelValue;t.time=e("date")(n,"HH:mm:ss")},t.$watch("value",function(){a.$render()},!0),a.$viewChangeListeners.push(function(){t.$eval(o.ngChange)})}};return t}function r(e){var t={restrict:"E",require:"ngModel",replace:!0,templateUrl:"/templates/common/datePicker.81165242.html",scope:{value:"=ngModel",name:"@name",id:"@id",placeholder:"=placeholder",ngdisabled:"=ngDisabled",click:"&",control:"=",startDate:"@",endDate:"@"},link:function(t,n,o,a){t.showWidget=function(){t.picker&&t.picker.show&&t.picker.show()},t.hideWidget=function(){t.picker&&t.picker.hide&&t.picker.hide()},t.setTime=function(){t.picker&&t.value?(t.picker.setLocalDate(t.value),t.picker.notifyChange()):t.picker&&t.placeholder&&(t.picker.setLocalDate(t.placeholder),t.picker.notifyChange())},t.internalControl=t.control||{},t.internalControl.clearDate=function(){t.picker&&(t.picker.setDate(t.placeholder),n.find("input").val(""))},n.datetimepicker({pickTime:!1,startDate:new Date(t.startDate),endDate:new Date(t.endDate)}),t.picker=n.data("datetimepicker"),n.on("changeDate",function(e){var o=new Date,r=new Date(e.date.getTime()+6e4*o.getTimezoneOffset());a.$setViewValue(r),n.find("input").blur(),t.hideWidget()}),a.$render=function(){var n=a.$modelValue;t.time=e("date")(n,"yyyy-MM-dd")},t.$watch("value",function(e,t){e!==t&&a.$render()},!0),a.$viewChangeListeners.push(function(){t.$eval(o.ngChange)})}};return t}function i(e,t){return"(("+e.split(" ").map(function(e){return t.map(function(t){return"contains("+t+",'"+e+"')"}).join(" or ")}).join(") and (")+"))"}e.$inject=["$compile","$window"],n.$inject=["$rootScope"],o.$inject=["$document","$rootScope","formatVal"],a.$inject=["$filter"],r.$inject=["$filter"],angular.module("southWest.directives").directive("dtable",e).directive("orderBy",t).directive("rangeSelector",n).directive("advancedSearch",o).directive("timePicker",a).directive("datePicker",r)}(),function(){"use strict";function e(){var e={scope:{validator:"=",obj:"=",type:"="},restrict:"E",templateUrl:"/templates/common/errorMessages.a02513a7.html"};return e}angular.module("southWest.directives").directive("errorMsg",e)}(),function(){"use strict";function e(e){return{restrict:"A",compile:function(t){return t.addClass("fadeListItem"),function(t,n){e(function(){n.addClass("in")},40*t.$index)}}}}e.$inject=["$timeout"],angular.module("southWest.directives").directive("fadeInList",e)}(),function(){"use strict";function e(e,t,n,o){function a(t,a){var r=!1;a.bind("click",function(){!r&&o.getUserName().length>0&&(e.userToken(),r=!0,n(function(){r=!1},5e3))})}var r={restrict:"A",link:a};return r}e.$inject=["SystemUser","debounce","$timeout","auth"],angular.module("southWest.directives").directive("globalEvents",e)}(),function(){"use strict";function e(e,t){return{restrict:"AE",scope:{selectedModel:"=",options:"=",extraSettings:"=",events:"=",searchFilter:"=?",translationTexts:"=",groupBy:"@"},template:function(e,t){var n=!!t.checkboxes,o=!!t.groupBy,a=!!t.readonly,r='<div class="multiselect-parent btn-group dropdown-multiselect">';r+=a?'<button type="button" class="dropdown-toggle" ng-class="settings.buttonClasses" ng-disabled="true" ng-click="toggleDropdown()">{{getButtonText()}}&nbsp;<span class="caret"></span></button>':'<button type="button" class="dropdown-toggle" ng-class="settings.buttonClasses" ng-click="toggleDropdown()">{{getButtonText()}}&nbsp;<span class="caret"></span></button>',r+="<ul class=\"dropdown-menu dropdown-menu-form\" ng-style=\"{display: open ? 'block' : 'none', height : settings.scrollable ? settings.scrollableHeight : 'auto' }\" style=\"overflow-x: hidden; overflow-y: scroll;\" >",r+='<li ng-hide="!settings.showCheckAll || settings.selectionLimit > 0"><a data-ng-click="selectAll()"><span class="glyphicon glyphicon-ok"></span>  {{texts.checkAll}}</a>',r+='<li ng-show="settings.showUncheckAll"><a data-ng-click="deselectAll();"><span class="glyphicon glyphicon-remove"></span>   {{texts.uncheckAll}}</a></li>',r+='<li ng-hide="(!settings.showCheckAll || settings.selectionLimit > 0) && !settings.showUncheckAll" class="divider"></li>',r+='<li ng-show="settings.enableSearch"><div class="dropdown-header"><input type="text" class="form-control" style="width: 100%;" ng-model="searchFilter" placeholder="{{texts.searchPlaceholder}}" /></li>',r+='<li ng-show="settings.enableSearch" class="divider"></li>',o?(r+='<li ng-repeat-start="option in orderedItems | filter: searchFilter" ng-show="getPropertyForObject(option, settings.groupBy) !== getPropertyForObject(orderedItems[$index - 1], settings.groupBy)" role="presentation" class="dropdown-header">{{ getGroupTitle(getPropertyForObject(option, settings.groupBy)) }}</li>',r+='<li ng-repeat-end role="presentation">'):r+='<li role="presentation" ng-repeat="option in options | filter: searchFilter">',r+='<a role="menuitem" tabindex="-1" ng-click="setSelectedItem(getPropertyForObject(option,settings.idProp))">',r+=n?'<div class="dropdown-list"><label><input class="checkboxInput" type="checkbox" ng-click="checkboxClick($event, getPropertyForObject(option,settings.idProp))" ng-checked="isChecked(getPropertyForObject(option,settings.idProp))" /> {{getPropertyForObject(option, settings.displayProp)}}</label></div></a>':"<span data-ng-class=\"{'glyphicon glyphicon-ok': isChecked(getPropertyForObject(option,settings.idProp))}\"></span> {{getPropertyForObject(option, settings.displayProp)}}</a>",
r+="</li>",r+='<li class="divider" ng-show="settings.selectionLimit > 1"></li>',r+='<li role="presentation" ng-show="settings.selectionLimit > 1"><a role="menuitem">{{selectedModel.length}} {{texts.selectionOf}} {{settings.selectionLimit}} {{texts.selectionCount}}</a></li>',r+="</ul>",r+="</div>",e.html(r)},link:function(n,o,a){function r(e){var t={};return""===n.settings.externalIdProp?t[n.settings.idProp]=e:t[n.settings.externalIdProp]=e,t}function i(e){for(var t in e)t&&delete e[t]}var l=o.children()[0];n.toggleDropdown=function(){n.open=!n.open},n.checkboxClick=function(e,t){n.setSelectedItem(t),e.stopImmediatePropagation()},n.externalEvents={onItemSelect:angular.noop,onItemDeselect:angular.noop,onSelectAll:angular.noop,onDeselectAll:angular.noop,onInitDone:angular.noop,onMaxSelectionReached:angular.noop},n.settings={dynamicTitle:!0,scrollable:!0,scrollableHeight:"180px",closeOnBlur:!0,displayProp:"label",idProp:"id",externalIdProp:"id",enableSearch:!1,selectionLimit:0,showCheckAll:!0,showUncheckAll:!0,closeOnSelect:!1,buttonClasses:"btn btn-default",closeOnDeselect:!1,groupBy:a.groupBy||void 0,groupByTextProvider:null,smartButtonMaxItems:10,smartButtonTextConverter:angular.noop},n.texts={checkAll:"全选",uncheckAll:"清空",selectionCount:"选中",selectionOf:"/",searchPlaceholder:"查找...",buttonDefaultText:"请选择",dynamicButtonTextSuffix:"选中"},n.searchFilter=n.searchFilter||"",angular.isDefined(n.settings.groupBy)&&n.$watch("options",function(t){angular.isDefined(t)&&(n.orderedItems=e("orderBy")(t,n.settings.groupBy))}),angular.extend(n.settings,n.extraSettings||[]),angular.extend(n.externalEvents,n.events||[]),angular.extend(n.texts,n.translationTexts),n.singleSelection=1===n.settings.selectionLimit,n.singleSelection&&angular.isArray(n.selectedModel)&&0===n.selectedModel.length&&i(n.selectedModel),n.settings.closeOnBlur&&t.on("click",function(e){for(var t=e.target.parentElement,o=!1;angular.isDefined(t)&&null!==t&&!o;)_.contains(t.className.split(" "),"multiselect-parent")&&!o&&t===l&&(o=!0),t=t.parentElement;o||n.$apply(function(){n.open=!1})}),n.getGroupTitle=function(e){return null!==n.settings.groupByTextProvider?n.settings.groupByTextProvider(e):e},n.getButtonText=function(){if(n.settings.dynamicTitle&&(n.selectedModel.length>0||angular.isObject(n.selectedModel)&&_.keys(n.selectedModel).length>0)){if(n.settings.smartButtonMaxItems>0){var e=[];return angular.forEach(n.options,function(t){if(n.isChecked(n.getPropertyForObject(t,n.settings.idProp))){var o=n.getPropertyForObject(t,n.settings.displayProp),a=n.settings.smartButtonTextConverter(o,t);e.push(a?a:o)}}),n.selectedModel.length>n.settings.smartButtonMaxItems&&(e=e.slice(0,n.settings.smartButtonMaxItems),e.push("...")),e.join(", ")}var t;return t=n.singleSelection?null!==n.selectedModel&&angular.isDefined(n.selectedModel[n.settings.idProp])?1:0:angular.isDefined(n.selectedModel)?n.selectedModel.length:0,0===t?n.texts.buttonDefaultText:t+" "+n.texts.dynamicButtonTextSuffix}return n.texts.buttonDefaultText},n.getPropertyForObject=function(e,t){return angular.isDefined(e)&&e.hasOwnProperty(t)?e[t]:""},n.selectAll=function(){n.deselectAll(!1),n.externalEvents.onSelectAll(),angular.forEach(n.options,function(e){n.setSelectedItem(e[n.settings.idProp],!0)})},n.deselectAll=function(e){e=e||!0,e&&n.externalEvents.onDeselectAll(),n.singleSelection?i(n.selectedModel):n.selectedModel.splice(0,n.selectedModel.length)},n.setSelectedItem=function(e,t){var o=r(e),a=null;if(a=""===n.settings.externalIdProp?_.find(n.options,o):o,n.singleSelection)return i(n.selectedModel),angular.extend(n.selectedModel,a),n.externalEvents.onItemSelect(a),void(n.settings.closeOnSelect&&(n.open=!1));t=t||!1;var l=_.findIndex(n.selectedModel,o)!==-1;!t&&l?(n.selectedModel.splice(_.findIndex(n.selectedModel,o),1),n.externalEvents.onItemDeselect(o)):!l&&(0===n.settings.selectionLimit||n.selectedModel.length<n.settings.selectionLimit)&&(n.selectedModel.push(a),n.externalEvents.onItemSelect(a)),n.settings.closeOnSelect&&(n.open=!1)},n.isChecked=function(e){return n.singleSelection?null!==n.selectedModel&&angular.isDefined(n.selectedModel[n.settings.idProp])&&n.selectedModel[n.settings.idProp]===r(e)[n.settings.idProp]:_.findIndex(n.selectedModel,r(e))!==-1},n.externalEvents.onInitDone()}}}e.$inject=["$filter","$document"],angular.module("southWest.directives").directive("ngDropdownMultiselect",e)}(),function(){"use strict";function e(e){return{restrict:"A",link:function(t,n){n.bind("contextmenu",function(t){t.preventDefault(),e.addAlert({type:"danger",content:"右键功能被禁用"})})}}}e.$inject=["$rootScope"],angular.module("southWest.directives").directive("rightClickPrevent",e)}(),function(){"use strict";function e(e,t){function n(e,n){var a=e.privilegeName,r=e.privilegeRequire,i=e.privilegeHandle,l=t.get("privilege").filter(function(e){return e.name===a});try{if(void 0!==l&&null!==l&&l.length>0){var s=l[0].actionValue;switch(s){case 1:o(i,n);break;case 2:switch(r){case"BAN":case"VIEW":if(void 0!==i&&null!==i&&"disabled"===i){n.prop("disabled",!0);var c;(c=n.find("input, button")).length&&c.prop("disabled",!0);break}break;case"MIXED":o(i,n);break;default:n.css("visibility","hidden"),n.hide()}break;case 30:break;default:n.css("visibility","hidden"),n.hide()}}else n.css("visibility","hidden"),n.hide()}catch(e){n.css("visibility","hidden"),n.hide()}}function o(e,t){switch(e){case"disabled":t.prop("disabled",!0);var n;(n=t.find("input, button")).length&&n.prop("disabled",!0);break;case"hidden":t.css("visibility","hidden"),t.hide();break;default:t.css("visibility","hidden"),t.hide()}}var a={scope:{privilegeName:"@",privilegeRequire:"@",privilegeHandle:"@"},restrict:"A",link:n};return a}e.$inject=["$rootScope","Enum"],angular.module("southWest.directives").directive("settingPrivilege",e)}(),function(){"use strict";function e(){return{restrict:"E",replace:!0,scope:{status:"="},template:'<div class="status-lamp"><ul><li></li><li></li><li></li></ul></div>',link:function(e,t){e.$watch("status",function(e){e=e||"down",t.find("li").attr("class",e)})}}}angular.module("southWest.directives").directive("statusLamp",e)}(),function(){"use strict";angular.module("southWest.directives").directive("switchToggle",["$timeout",function(e){return{restrict:"E",scope:{status:"=",onLabel:"@",offLabel:"@",change:"&",disabled:"=?",invert:"=?"},templateUrl:"/templates/common/switch.be17e265.html",link:function(t){t.innerStatus=t.invert?!t.status:!!t.status,t.$watch("status",function(e){t.innerStatus=t.invert?!e:!!e}),t.$watch("innerStatus",function(e){t.status=t.invert?!e:e}),t.onLabel=t.onLabel||"启动",t.offLabel=t.offLabel||"关闭",t.changeAction=function(){t.change&&e(t.change)}}}}])}(),function(){"use strict";function e(e,t){return{restrict:"A",scope:{touchDown:"=ngModel",ngChange:"&"},link:function(n,o,a){if(void 0===a.id)throw"the element with touchDown attribute musts have an id to enable storing user's local config";t(function(){if(!o.attr("disabled")&&!o[0].disabled){var r=e.get(a.id);void 0!==r&&null!==r&&(n.touchDown=r,n.ngChange&&t(function(){n.ngChange()})),n.$watch("touchDown",function(t,n){t!==n&&e.set(a.id,t)})}})}}}e.$inject=["lclStorage","$timeout"],angular.module("southWest.directives").directive("touchDown",e)}(),function(){"use strict";angular.module("southWest.directives").directive("triStateCheckbox",function(){return{restrict:"A",replace:!0,require:"?ngModel",link:function(e,t,n,o){if(o){var a=!0,r=!1,i=null;o.$formatters=[],o.$parsers=[],o.$render=function(){var e=o.$viewValue;switch(t.data("checked",e),t.removeClass("tri-state-indeterminate"),e){case a:t.prop("indeterminate",!1),t.prop("checked",!0);break;case r:t.prop("indeterminate",!1),t.prop("checked",!1);break;case i:t.prop("indeterminate",!0),t.addClass("tri-state-indeterminate")}},t.bind("click",function(){var n;switch(t.data("checked")){case r:n=a;break;case a:n=r;break;case i:n=a;break;default:n=a}o.$setViewValue(n),e.$apply(o.$render)})}}}})}(),function(){"use strict";function e(){var e=["asDays","asHours","asMinutes","asSeconds"],t=["天前","小时前","分钟前","秒前"];return function(n,o){for(var a,r="刚刚",i=new Date(o)-new Date(n),l=moment.duration(i),s=0,c=e.length;s<c;s++)if(a=Math.floor(l[e[s]]())){r=t[s];break}return(a||"")+r}}angular.module("southWest.filters").filter("alarmTimeDiff",e)}(),function(){"use strict";function e(){return function(e){var t={eq:"=",gt:">",lt:"<",co:"包含"},n=[e].map(function(e){return t[e]});return n||e}}function t(){return function(e){var t={eq:"=",gt:">",lt:"<",co:"包含"},n=e.map(function(e){return t[e]});return n||e}}function n(){return function(e){var t={"=":"eq",">":"gt","<":"lt","包含":"co"};return t[e]||e}}angular.module("southWest.filters").filter("selectConvert",e).filter("selectConvertHTML",t).filter("selectConvertBack",n)}(),function(){"use strict";function e(){return function(e){var t={SECURITY_DEVICE:"安全设备",FACTORY_DEVICE:"工控设备",NETWORK_DEVICE:"网络设备"};return t[e]||e}}function t(){return function(e){var t={INSTALLED:"已安装",NOT_INSTALLED:"未安装",SUGGESTED:"建议安装"};return t[e]||e}}function n(){return function(e){if(Array.isArray(e)){var t=[];return e.forEach(function(e){e&&t.push(e.zoneName)}),t.join(", ")}return e}}function o(){return function(e){var t={IPS:"智能保护模式",IDS:"监测审计模式",ROUTING_IPS:"路由保护模式"};return t[e]||e}}function a(){return function(e){if(e&&e.indexOf(" / ",e.length-3)!==-1)return e.substring(0,e.length-3);if(e&&e.indexOf(" / ")>0){var t=e.split(" / ");if(t[0]===t[1])return t[0]}return e}}function r(){return function(e){var t={1:"连线",0:"未激活","-1":"掉线"};return t[e]||e}}function i(){return function(e){var t={1:"端口连接正常",0:"未知","-1":"端口未连接"};return t[e]||e}}function l(){return function(e){var t={DOING:"",SUCCESS:"成功",FAILURE:"失败"};return t[e]||e}}angular.module("southWest.filters").filter("deviceCategoryFilter",e).filter("deviceInstallationState",t).filter("deviceZoneFilter",n).filter("deviceMode",o).filter("deviceModel",a).filter("deviceConnection",r).filter("devicePortConnection",i).filter("deviceDebugInfoResult",l)}(),function(){"use strict";function e(){return function(e){var t=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];return e.map(function(e){return t[e>>4&15]+t[15&e]}).join(" ")}}function t(){return function(e){var t={0:"起源",1:"防火墙",2:"目标"};return t[e]||e}}function n(){return function(e){return e?e.replace(/,/g,", "):""}}function o(){return function(e){var t={"1source":"laptop","2dpi":"placeholders/u857","3destination":"laptop"};return t[e]||e}}function a(){return function(e){var t={Connected:"连接",Disconnected:"未连接"};return t[e]||e}}function r(){return function(e){var t={REJECTBOTH:"阻断",DROP:"丢弃",WARN:"警告",INFO:"信息"};return t[e]||e}}function i(){return function(e){var t={DROP:"丢弃",REJECTBOTH:"阻断",ALERT:"警告",ALLOW:"允许"};return t[e.toUpperCase()]||e}}function l(){return function(e){var t={DPI_ON_OFF:"设备状态",IF_UP_DOWN:"接口状态",MEM_WARNING:"内存警告",DISK_WARNING:"磁盘警告",TEMPERATURE_WARNING:"温度警告",NTP_SYNC:"NTP同步",DPI_BYPASS:"BYPASS",TRAFFIC_UP_DOWN:"流量警告",SYSTEM_CHECK:"系统自检测",SELFTEST_RESULT:"开机自检",MW_EVENT:"平台系统事件",SYS_EVENT:"关键进程"};return t[e]||e}}function s(){return function(e){var t={LOW:"低",MEDIUM:"中",HIGH:"高",NONE:""};return t[e]||e}}angular.module("southWest.filters").filter("toHex",e).filter("nodeName",t).filter("protocolDetail",n).filter("nodeIcon",o).filter("eventContent",a).filter("eventLevel",r).filter("eventAction",i).filter("eventType",l).filter("eventRiskLevel",s)}(),function(){"use strict";angular.module("southWest.filters").filter("ipPoolTypes",[function(){return function(e){var t={IPADDRESS:"单个地址",SUBNET:"子网",IPRANGE:"范围"};return t[e]||e}}]).filter("ipPoolInterfaces",[function(){return function(e){var t={};return t[e]||e}}]).filter("objScheduleTypes",[function(){return function(e){var t={LOOP:"是",ONCE:"否"};return t[e]||e}}]).filter("dvcAssetInputMode",[function(){return function(e){var t={1:"自动",0:"手动"};return t[e]||e}}])}(),function(){"use strict";function e(e){return function(t,n){var o=e.resource||{};return o[n]||t}}e.$inject=["$rootScope"],angular.module("southWest.filters").filter("resFilter",e)}(),function(){"use strict";function e(){return function(e){var t={ALLOW:"允许",ALERT:"警告",DROP:"丢弃",REJECTBOTH:"阻断"};return t[e]||e}}function t(){return function(e){var t={LOW:"低",MEDIUM:"中",HIGH:"高",NONE:""};return t[e]||e}}function n(){return function(e){var t={DEFAULT:"上传",SYNCHRONIZATION:"同步"};return t[e]||e}}angular.module("southWest.filters").filter("actionName",e).filter("riskLevel",t).filter("templateSourceName",n)}(),function(){"use strict";angular.module("southWest.filters").filter("strategyAction",[function(){return function(e){var t={ALLOW:"放行",REJECT:"阻断",pass:"放行",drop:"阻断"};return t[e]||e}}]).filter("strategyExpression",[function(){return function(e){var t={eq:"等于",ne:"不等于",gt:"大于",ge:"大于等于",lt:"小于",le:"小于等于",rg:"范围"};return t[e]||e}}]).filter("appIdToProtocol",[function(){return function(e){var t={616:"DNP3",737:"Modbus-TCP",4200:"Modbus-UDP"};return e?t[e]:null}}]).filter("protocolValueTemplate",[function(){return function(e){var t="templates/strategy/security/protocoltemplates/funcCodeStaticValueTpl.18c5b71d.html";switch(e){case"DNP3":t="templates/strategy/security/protocoltemplates/funcCodeRefOptionValueTpl.cdce8d66.html"}return t}}]).filter("protocolTranslation",[function(){return function(e,t){var n=null;switch(t){case"Modbus-TCP":case"Modbus-UDP":n={Read_Coils:"读线圈",Read_Discrete_Inputs:"读输入离散量",Read_Holding_Registers:"读保持寄存器",Read_Input_Register:"读输入寄存器",Write_Single_Coil:"写单个线圈",Write_Single_Register:"写单个寄存器",Read_Exception_Status:"读异常状态",Diagnostic:"诊断",Program_484:"Program_484",Poll_484:"Poll_484",Get_Com_Event_Counter:"Get_Com_Event_Counter",Get_Com_Event_Log:"Get_Com_Event_Log",Program_Controller:"Program_Controller",Poll_Controller:"Poll_Controller",Write_Multiple_Coils:"写多个线圈",Write_Multiple_Registers:"写多个寄存器",Report_Slave_ID:"报告从设备ID","Program_884/M84":"Program_884/M84","Reset_Comm._Link":"Reset_Comm._Link",Read_File_Record:"读文件记录",Write_File_Record:"写文件记录",Mask_Write_Register:"屏蔽写寄存器",Read_Write_Multiple_Registers:"读写多个寄存器",Read_FIFO_Queue:"读队列",Read_Device_Identification:"读设备识别码",startaddr:"起始地址",endaddr:"数量",data:"数值",subfunc:"异常码",refaddr:"参考地址",rdstartaddr:"读起始地址",rdendaddr:"读数量",wtstartaddr:"写起始地址",wtendaddr:"写数量",fifoaddr:"队列地址",meitype:"MEI类型"};break;case"DNP3":n={object:"对象",value:"数值",obj0101:"单位二进制输入",obj0102:"带status的二进制输入",obj0201:"不带时间的二进制变位输入",obj0202:"带变位时间的二进制输入",obj0203:"带相对时间的二进制变位输入",obj1001:"二进制输出",obj1002:"带status的二进制输出",obj1201:"控制继电器的输出块",obj1202:"模式控制块（PCB）",obj2001:"32位二进制计数器",obj2002:"16位二进制计数器 ",obj2003:"32位增值计数器（Dalta count）",obj2004:"16位增值计数器",obj2005:"32位不带标志的二进制计数器 ",obj2006:"16位不带标志的二进制计数器 ",obj2007:"32位不带标志的增值计数器",obj2008:"16位不带标志的增值计数器",obj2101:"32位冻结计数器",obj2102:"16位冻结计数器",obj2103:"32位冻结的增值计数器",obj2104:"16位冻结的增值计数器",obj2105:"带冻结时间的32位冻结的计数器",obj2106:"带冻结时间的16位冻结的计数器",obj2107:"带冻结时间的32位冻结的增值计数器",obj2108:"带冻结时间的16位冻结的增值计数器",obj2109:"无标志的32位冻结计数器",obj2110:"无标志的16位冻结计数器",obj2111:"无标志的32位冻结增值计数器",obj2112:"无标志的16位冻结增值计数器",obj2201:"无时间的32位事件变化计数器 ",obj2202:"无时间的16位事件变化计数器 ",obj2203:"无时间的32位事件变化增值计数器",obj2204:"无时间的16位事件变化增值计数器",obj2205:"带时间的32位事件变化计数器",obj2206:"带时间的16位事件变化计数器",obj2207:"带时间的32位事件变化增值计数器",obj2208:"带时间的16位事件变化增值计数器",obj2301:"不带时间的32位冻结计数器事件",obj2302:"不带时间的16位冻结计数器事件",obj2303:"不带时间的32位冻结的delta计数器事件",obj2304:"不带时间的16位冻结的delta计数器事件",obj2305:"带时间的32位冻结计数器事件",obj2306:"带时间的16位冻结计数器事件",obj2307:"带时间的32位冻结的delta计数器事件",obj2308:"带时间的16位冻结的delta计数器事件",obj3001:"32位模拟量输入",obj3002:"16位模拟量输入 ",obj3003:"不带标志的32位模拟量输入",obj3004:"不带标志的16位模拟量输入",obj3101:"冻结的32位模拟输入",obj3102:"冻结的16位模拟输入",obj3103:"带冻结时间的32位冻结的模拟输入",obj3104:"带冻结时间的16位冻结的模拟输入",obj3105:"无标志的32位冻结了的模拟输入",obj3106:"无标志的16位冻结了的模拟输入",obj3201:"不带时间的32位模拟量变化事件",obj3202:"不带时间的16位模拟量变化事件",obj3203:"带时间的32位模拟量变化事件",obj3204:"带时间的16位模拟量变化事件",obj3301:"不带时间的32位冻结模拟量事件",obj3302:"不带时间的16位冻结模拟量事件",obj3303:"带时间的32位冻结模拟量事件",obj3304:"带时间的16位冻结模拟量事件",obj4001:"32位模拟量输出之状态",obj4002:"16位模拟量输出之状态",obj4101:"32位模拟量输出块",obj4102:"16位模拟量输出块",obj5001:"时间与日期",obj5002:"带有时间间隔的时间与日期",obj5101:"CTO的时间与日期（Comman Time of Occurrence）",obj5102:"非同步的CTO时间与日期",obj5201:"粗延时",obj5202:"精延时",obj6001:"0类数据",obj6002:"1类数据",obj6003:"2类数据",obj6004:"3类数据",obj7001:"文件识别码",obj8001:"内部信号",obj8101:"存储对象 ",obj8201:"设备简表（profile）",obj8301:"保密登记对象（PRO）",obj8302:"保密登记对象的说明项（PROD）",obj9001:"应用程序之识别等",obj10001:"短浮点",obj10002:"长浮点",obj10003:"扩充的浮点",obj10101:"小包装的二进制编码十进制",obj10102:"中包装的二进制编码十进制",obj10103:"大包装的二进制编码十进制"};break;default:n={}}return n[e]||e}}])}(),function(){"use strict";function e(){return function(e){var t={USER_MANAGEMENT:"User Management",POLICY:"Policy",REAL_TIME_PROTECTION:"Real Time Protection",DOMAIN_SUBNET:"Doman Subnet",DEVICE_MANAGEMENT:"Device Management",AUDIT_MANAGEMENT:"Audit Management",TOPOLOGY:"Topology",STRATEGY_MANAGEMENT:"Strategy Management",STRUCTURE_SAFETY:"Structure Safety",PRIVATE_PROTOCOL:"Private Protocol",ATTACKPATH:"AttackPath",SETTINGS_POLICY:"System Management",INTRUSION_DETECTION:"Intrusion Detection"};return t[e]||e}}angular.module("southWest.filters").filter("targetValueReformat",e)}(),function(){"use strict";function e(e,t,n){function o(t){return e.get(i+"/getAlarms",{params:n(t)}).then(function(e){return e.data})}function a(){return e.get(i+"/new/count").then(function(e){return e.data})}function r(){return e.put(i+"/read").then(function(e){return e.data})}var i=t+"/alarms",l={get:o,getCount:a,update:r};return l}e.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("Alarm",e)}(),function(){"use strict";function e(e,t,n,o){function a(){return e.get(o.getUrl(n.currentIp)+i+"/getAntiPenetrationSetting").then(function(e){return e.data})}function r(t){return e.post(o.getUrl(n.currentIp)+i+"/antiattackInfosSetting",t).then(function(e){return e.data})}var i=t+"/antipenetration",l={getAntiPenetrationSetting:a,setAntiPenetrationSetting:r};return l}e.$inject=["$http","URI","$rootScope","UCD"],angular.module("southWest.models").factory("antiPenetration",e)}(),function(){"use strict";function e(e,t){function n(){return e.get("/api")}function o(){return e.get("/api/v2.0/sysbaseinfo/curtime",{ignoreLoadingBar:!0}).then(function(e){return t.currentTime=new Date(e.data||""),e})}function a(){return e.get("/api/v2.0/sysbaseinfo/curtimesimple")}var r={getFullApi:n,sysbaseinfo:o,getCurDate:a};return r}e.$inject=["$http","$rootScope"],angular.module("southWest.models").factory("apiInfo",e)}(),function(){"use strict";function e(e,t,n){function o(){return h.query().$promise}function a(e,n){return t.post(v+"topology/"+e,n)}function r(e){return t({url:n+"/files/type/attacktarget/fileid/"+e+"/download",method:"GET"})}function i(e){return t({url:n+"/files/fileid/"+e+"/filedelete",method:"DELETE"})}function l(e){return t.get(v+"topology/"+e)}function s(){return t.get(v+"searchcriteria/")}function c(e,n){return t.get(v+"searchcriteria/topology/"+e+"/"+n)}function d(e,n,o){return t.get(v+"topology/"+e+"/attackpath/"+n+"/"+o)}function u(e,n){return t({url:v+"attackpath/"+e+"/attacktarget",method:"POST",data:n,headers:{"Content-Type":"application/json"}})}function p(e,n,o){return t({url:v+"attackpath/"+e+"/attacktarget/"+n,method:"PUT",data:o,headers:{"Content-Type":"application/json"}})}function f(e){return t.get(v+"attackpath/"+e+"/targets")}function m(e,n,o){return t({url:v+"attackpath/"+e+"/attacktarget/"+n,method:"PUT",data:o,headers:{"Content-Type":"application/json"}})}function g(e,o){var a=new FormData;return a.append("file",o),t({url:n+"/files/type/attackpath/sourceid/"+e+"/multipleupload",method:"POST",data:a,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}var h=e(n+"/attack"),v=n+"/attackpaths/",y={get:o,createAttackPath:a,downloadTargetFile:r,deleteTargetFile:i,getAttackTargetFilter:d,getPath:l,getQuery:s,getQueryDetail:c,createAttackTarget:u,editAttackTarget:p,getAttackTarget:f,updateAttackTarget:m,uploadMultipleFiles:g};return y}e.$inject=["$resource","$http","URI"],angular.module("southWest.models").factory("Attack",e)}(),function(){"use strict";function e(e,t,n,o,a){function r(e,n){return t.get(_+"/head/"+e+"/type/"+n).then(function(e){return e.data})}function i(e,n,a){return t.get(_+"/head/"+n+"/type/"+a,{params:o(e)}).then(function(e){return e.data})}function l(e,n){return t.get(_+"/head/"+e+"/type/"+n+"/count").then(function(e){return e.data})}function s(e,n,a){var r="normal"!==n&&"http"!==n&&"ftp"!==n&&"pop3"!==n&&"smtp"!==n&&"telnet"!==n;return n&&r&&a?t.get(_+"/detailinfo/type/"+n,{params:o(e)}).then(function(e){return e.data}):t.get(_+"/heads",{params:o(e)}).then(function(e){return e.data})}function c(e){return t.get(_+"/content/forumpost/",{params:o(e)}).then(function(e){return e.data},function(){var e='[{"id": 1,"usrIp": "192.168.11.12","usrMac": "00:0c:29:e7:6e:4d","forumName": "天涯论坛","titile": "懒惰是社会发展的源动力","postContent": "人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最终傲立食物链之巅。经过了数千年的发展社会制度越来越完善，人们也通过摸索学会了制造与使用更多的工具。　　有的人认为是因为人学会了分工和使用武器。是智慧使得人们更加强大。　　这些说法都有道理，但是我觉得，人之所以会使用工具，会分工合作全是因为人类的学习能力和懒惰的本性。　　懒惰是深深地潜藏在人骨子里的一种属性，也许有的人表现得很勤快，但是他仍然是有惰性的。不劳而获永远是最最吸引我们的一种诱惑。所以我们拼命地学习可以减少我们劳动力的方法，制造机器，分工合作也只是其中的一小部分罢了。　　在原始社会中，有的人个体比较强大，就会胁迫比较弱小的个体成为自己的下属，最终形成部落，部落相互吞并形成大部落，最后是国家。这时候阶级就表现出他独特的优势来了。因为上位者可以不用干活，而享受到最好的物品。这个时候维持这个社会的也是武力，只有强大的武力可以威慑民众不敢反抗。而后过了几代几十代形成了一种惯性，民众们习惯了上面有统治者的管理，才让国家这个形式流传到现在。而惯性的形成也是因为懒，只有懒得去改变才会形成习惯。　　到了现代社会，人们变得越发的懒惰，所以开始发明各种解放我们的双手的机械。　　归结到底，人们有需要，但是又不想劳动，才会去想着发明各种东西来代替自己工作。这样也带动了社会的发展。人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最终傲立食物链之巅。经过了数千年的发展社会制度越来越完善，人们也通过摸索学会了制造与使用更多的工具。　　有的人认为是因为人学会了分工和使用武器。是智慧使得人们更加强大。　　这些说法都有道理，但是我觉得，人之所以会使用工具，会分工合作全是因为人类的学习能力和懒惰的本性。　　懒惰是深深地潜藏在人骨子里的一种属性，也许有的人表现得很勤快，但是他仍然是有惰性的。不劳而获永远是最最吸引我们的一种诱惑。所以我们拼命地学习可以减少我们劳动力的方法，制造机器，分工合作也只是其中的一小部分罢了。　　在原始社会中，有的人个体比较强大，就会胁迫比较弱小的个体成为自己的下属，最终形成部落，部落相互吞并形成大部落，最后是国家。这时候阶级就表现出他独特的优势来了。因为上位者可以不用干活，而享受到最好的物品。这个时候维持这个社会的也是武力，只有强大的武力可以威慑民众不敢反抗。而后过了几代几十代形成了一种惯性，民众们习惯了上面有统治者的管理，才让国家这个形式流传到现在。而惯性的形成也是因为懒，只有懒得去改变才会形成习惯。　　到了现代社会，人们变得越发的懒惰，所以开始发明各种解放我们的双手的机械。　　归结到底，人们有需要，但是又不想劳动，才会去想着发明各种东西来代替自己工作。这样也带动了社会的发展。人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最终傲立食物链之巅。经过了数千年的发展社会制度越来越完善，人们也通过摸索学会了制造与使用更多的工具。　　有的人认为是因为人学会了分工和使用武器。是智慧使得人们更加强大。　　这些说法都有道理，但是我觉得，人之所以会使用工具，会分工合作全是因为人类的学习能力和懒惰的本性。　　懒惰是深深地潜藏在人骨子里的一种属性，也许有的人表现得很勤快，但是他仍然是有惰性的。不劳而获永远是最最吸引我们的一种诱惑。所以我们拼命地学习可以减少我们劳动力的方法，制造机器，分工合作也只是其中的一小部分罢了。　　在原始社会中，有的人个体比较强大，就会胁迫比较弱小的个体成为自己的下属，最终形成部落，部落相互吞并形成大部落，最后是国家。这时候阶级就表现出他独特的优势来了。因为上位者可以不用干活，而享受到最好的物品。这个时候维持这个社会的也是武力，只有强大的武力可以威慑民众不敢反抗。而后过了几代几十代形成了一种惯性，民众们习惯了上面有统治者的管理，才让国家这个形式流传到现在。而惯性的形成也是因为懒，只有懒得去改变才会形成习惯。　　到了现代社会，人们变得越发的懒惰，所以开始发明各种解放我们的双手的机械。　　归结到底，人们有需要，但是又不想劳动，才会去想着发明各种东西来代替自己工作。这样也带动了社会的发展。人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最终傲立食物链之巅。经过了数千年的发展社会制度越来越完善，人们也通过摸索学会了制造与使用更多的工具。　　有的人认为是因为人学会了分工和使用武器。是智慧使得人们更加强大。　　这些说法都有道理，但是我觉得，人之所以会使用工具，会分工合作全是因为人类的学习能力和懒惰的本性。　　懒惰是深深地潜藏在人骨子里的一种属性，也许有的人表现得很勤快，但是他仍然是有惰性的。不劳而获永远是最最吸引我们的一种诱惑。所以我们拼命地学习可以减少我们劳动力的方法，制造机器，分工合作也只是其中的一小部分罢了。　　在原始社会中，有的人个体比较强大，就会胁迫比较弱小的个体成为自己的下属，最终形成部落，部落相互吞并形成大部落，最后是国家。这时候阶级就表现出他独特的优势来了。因为上位者可以不用干活，而享受到最好的物品。这个时候维持这个社会的也是武力，只有强大的武力可以威慑民众不敢反抗。而后过了几代几十代形成了一种惯性，民众们习惯了上面有统治者的管理，才让国家这个形式流传到现在。而惯性的形成也是因为懒，只有懒得去改变才会形成习惯。　　到了现代社会，人们变得越发的懒惰，所以开始发明各种解放我们的双手的机械。　　归结到底，人们有需要，但是又不想劳动，才会去想着发明各种东西来代替自己工作。这样也带动了社会的发展。人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最终傲立食物链之巅。经过了数千年的发展社会制度越来越完善，人们也通过摸索学会了制造与使用更多的工具。　　有的人认为是因为人学会了分工和使用武器。是智慧使得人们更加强大。　　这些说法都有道理，但是我觉得，人之所以会使用工具，会分工合作全是因为人类的学习能力和懒惰的本性。　　懒惰是深深地潜藏在人骨子里的一种属性，也许有的人表现得很勤快，但是他仍然是有惰性的。不劳而获永远是最最吸引我们的一种诱惑。所以我们拼命地学习可以减少我们劳动力的方法，制造机器，分工合作也只是其中的一小部分罢了。　　在原始社会中，有的人个体比较强大，就会胁迫比较弱小的个体成为自己的下属，最终形成部落，部落相互吞并形成大部落，最后是国家。这时候阶级就表现出他独特的优势来了。因为上位者可以不用干活，而享受到最好的物品。这个时候维持这个社会的也是武力，只有强大的武力可以威慑民众不敢反抗。而后过了几代几十代形成了一种惯性，民众们习惯了上面有统治者的管理，才让国家这个形式流传到现在。而惯性的形成也是因为懒，只有懒得去改变才会形成习惯。　　到了现代社会，人们变得越发的懒惰，所以开始发明各种解放我们的双手的机械。　　归结到底，人们有需要，但是又不想劳动，才会去想着发明各种东西来代替自己工作。这样也带动了社会的发展。人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最终傲立食物链之巅。经过了数千年的发展社会制度越来越完善，人们也通过摸索学会了制造与使用更多的工具。　　有的人认为是因为人学会了分工和使用武器。是智慧使得人们更加强大。　　这些说法都有道理，但是我觉得，人之所以会使用工具，会分工合作全是因为人类的学习能力和懒惰的本性。　　懒惰是深深地潜藏在人骨子里的一种属性，也许有的人表现得很勤快，但是他仍然是有惰性的。不劳而获永远是最最吸引我们的一种诱惑。所以我们拼命地学习可以减少我们劳动力的方法，制造机器，分工合作也只是其中的一小部分罢了。　　在原始社会中，有的人个体比较强大，就会胁迫比较弱小的个体成为自己的下属，最终形成部落，部落相互吞并形成大部落，最后是国家。这时候阶级就表现出他独特的优势来了。因为上位者可以不用干活，而享受到最好的物品。这个时候维持这个社会的也是武力，只有强大的武力可以威慑民众不敢反抗。而后过了几代几十代形成了一种惯性，民众们习惯了上面有统治者的管理，才让国家这个形式流传到现在。而惯性的形成也是因为懒，只有懒得去改变才会形成习惯。　　到了现代社会，人们变得越发的懒惰，所以开始发明各种解放我们的双手的机械。　　归结到底，人们有需要，但是又不想劳动，才会去想着发明各种东西来代替自己工作。这样也带动了社会的发展。人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最终傲立食物链之巅。经过了数千年的发展社会制度越来越完善，人们也通过摸索学会了制造与使用更多的工具。　　有的人认为是因为人学会了分工和使用武器。是智慧使得人们更加强大。　　这些说法都有道理，但是我觉得，人之所以会使用工具，会分工合作全是因为人类的学习能力和懒惰的本性。　　懒惰是深深地潜藏在人骨子里的一种属性，也许有的人表现得很勤快，但是他仍然是有惰性的。不劳而获永远是最最吸引我们的一种诱惑。所以我们拼命地学习可以减少我们劳动力的方法，制造机器，分工合作也只是其中的一小部分罢了。　　在原始社会中，有的人个体比较强大，就会胁迫比较弱小的个体成为自己的下属，最终形成部落，部落相互吞并形成大部落，最后是国家。这时候阶级就表现出他独特的优势来了。因为上位者可以不用干活，而享受到最好的物品。这个时候维持这个社会的也是武力，只有强大的武力可以威慑民众不敢反抗。而后过了几代几十代形成了一种惯性，民众们习惯了上面有统治者的管理，才让国家这个形式流传到现在。而惯性的形成也是因为懒，只有懒得去改变才会形成习惯。　　到了现代社会，人们变得越发的懒惰，所以开始发明各种解放我们的双手的机械。　　归结到底，人们有需要，但是又不想劳动，才会去想着发明各种东西来代替自己工作。这样也带动了社会的发展。人为什么会从无数的物种中脱颖而出成为站在食物链顶端的生物呢？有人认为是因为人学会了使用火等工具使得人类可以战胜其他物种最　到己工作。这样也带动了社会的发展。", "postTimestamp": "2016-10-20T07:55:22Z"}]';return angular.fromJson(e)})}function d(e){return t.get(_+"/content/search/",{params:o(e)}).then(function(e){return e.data},function(){var e='[{"usrIp": "192.168.11.12", "usrMac": "00:0c:29:e7:6e:4d", "searchName": "百度", "searchContent": "AngularJS 2.0", "searchTimestamp": "2016-10-20T07:55:22Z"}]';return angular.fromJson(e)})}function u(e,n,r){return t.get(_+"/topology/"+a.id+"/startTime/"+n+"/endTime/"+r+"/heads",{params:o(e)}).then(function(e){return e.data})}function p(e){return t.get(_+"/topology/"+a.id+"/stream/heads",{params:o(e)}).then(function(e){return e.data})}function f(e,n){return t.get(_+"/detailinfo/type/"+e,{params:o(n)}).then(function(e){return e.data})}function m(e,n,a){var r="normal"!==n&&"http"!==n&&"ftp"!==n&&"pop3"!==n&&"smtp"!==n&&"telnet"!==n;return n&&r&&a?t.get(_+"/detailinfo/type/"+n+"/count",{params:o(e)}).then(function(e){return e.data}):t.get(_+"/heads/count",{params:o(e)}).then(function(e){return void 0===n?0:e.data})}function g(e){return t.get(_+"/content/forumpost/count/",{params:o(e)}).then(function(e){return e.data},function(){return 10001})}function h(e){return t.get(_+"/content/search/count/",{params:o(e)}).then(function(e){return e.data},function(){return 999})}function v(e){return t.get(_+"/topology/"+a.id+"/stream/heads/count",{params:o(e)}).then(function(e){return e.data})}function y(e,n,r){return t.get(_+"/topology/"+a.id+"/startTime/"+n+"/endTime/"+r+"/heads/count",{params:o(e)}).then(function(e){return e.data})}function I(e){return t.get(_+"/topology/"+a.id+"/iptraffic/devices",e).then(function(e){return e.data})}function D(e){return t.get(_+"/ftpcontrolflowdata/"+e).then(function(e){return e.data})}function T(e){return t.post(_+"/flowdataheadid/"+e.flowdataHead.flowdataHeadId+"/"+e.flowdataHead.protocolSourceName+"flowdata/view").then(function(e){return e.data})}function b(e){var n=_+"/flowdataheadid/"+e.flowdataHead.flowdataHeadId+"/"+e.flowdataHead.protocolSourceName+"flowdata/download";return t({method:"POST",url:n,data:{password:e.cmdZipPsw},transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){return e.data})}function S(e){var n=_+"/"+e.flowdataHead.protocolSourceName+"flowdata/";return n+="ftpcontrol"===e.flowdataHead.protocolSourceName?e.flowdataHead.flowdataHeadId+"/ftpflowdata":e.flowdataHead.flowdataHeadId+"/",t({method:"POST",url:n,data:{password:e.zipPsw},transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){return e.data})}function P(e,n){var o=_+"/"+e.flowdataHead.protocolSourceName+"flowdata/";return o+="ftpcontrol"===e.flowdataHead.protocolSourceName?e.flowdataHead.flowdataHeadId+"/ftpflowdata/"+n:e.flowdataHead.flowdataHeadId+"/"+n,t({method:"POST",url:o,data:{password:e.fileZipPsw},responseType:"arraybuffer",transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){return e.data})}function A(e,n,a){var r=n?{password:n,clienttime:(new Date).getTimezoneOffset()/60}:null;return t({method:"POST",url:_+"/"+a.toLowerCase()+"/export",data:r,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:o(e)}).then(function(e){return e.data})}function C(e,n,a,r,i){return t.get(_+"/flowdata/type/"+e+"/frequency/"+n+"/starttime/"+a.toISOString()+"/endtime/"+r.toISOString(),{params:o(i)}).then(function(e){return e.data})}function k(e){return t.get(n+"/jobscheduler/jobbuilder/category/"+e).then(function(e){return e.data})}function w(e){return t.put(n+"/jobscheduler/jobbuilder",e).then(function(e){return e.data})}function E(e,n,a,r){var i=n?{password:n,clienttime:(new Date).getTimezoneOffset()/60}:null;return t({method:"POST",url:_+"/"+a.toLowerCase()+"/"+r+"/export",data:i,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:o(e)}).then(function(e){return e.data})}function N(e,n){var a=n?{password:n}:null;return t({method:"POST",url:_+"/content/forumpost/export",data:a,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:o(e)}).then(function(e){return e.data})}function $(e,n){var a=n?{password:n}:null;return t({method:"POST",url:_+"/content/search/export",data:a,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:o(e)}).then(function(e){return e.data})}function M(e,n,a){var r="(visitTimestamp ge '"+e+"' and visitTimestamp le '"+n+"')",i=[];return i.$filter=r,i.$usrIp=a,t.get(_+"/action/webvisit",{params:o(i)}).then(function(e){return e.data},function(){var e='[{"id":1, "usrIp": "192.168.11.12", "usrMac": "00:0c:29:e7:6e:4d", "webTitle": "CSDN", "webUrl": "http://www.csdn.com", "visitTimestamp": "2016-08-10 08:55:22"}]';return angular.fromJson(e)})}function R(e,n,a){var r="(searchTimestamp ge '"+e+"' and searchTimestamp le '"+n+"')",i=[];return i.$filter=r,i.$usrIp=a,t.get(_+"/content/search",{params:o(i)}).then(function(e){return e.data},function(){var e='[{"id":2, "usrIp": "192.168.11.12", "usrMac": "00:0c:29:e7:6e:4d", "searchName": "百度", "searchContent": "AngularJS 2.0", "searchTimestamp": "2016-08-10 07:55:22"}]';return angular.fromJson(e)})}function U(e,n,a){var r="(postTimestamp ge '"+e+"' and postTimestamp le '"+n+"')",i=[];return i.$filter=r,i.$usrIp=a,t.get(_+"/content/forumpost",{params:o(i)}).then(function(e){return e.data},function(){var e='[{"id":3, "usrIp": "192.168.11.12", "usrMac": "00:0c:29:e7:6e:4d", "forumName": "天涯", "title":"Hello World", "postContent": "AngularJS 2.0", "postTimestamp": "2016-08-10 06:55:22"}]';return angular.fromJson(e)})}var _=n+"/auditlogs",x={get:r,getDetails:i,getDetailsCount:l,getAllByTime:u,getAll:s,getAllReduction:p,getSep:f,getReductionCount:v,getCount:m,getCountByTime:y,getDeviceData:I,getFtpControlFlowData:D,getViewCommand:T,getDownloadCommand:b,getDownloadZipPath:S,getDownloadFileZipPath:P,getAllExport:A,getGrouped:C,getScheduleSetting:k,setScheduleSetting:w,getAuditProtocolExport:E,getForumpostAll:c,getForumpostCount:g,
getForumpostExport:N,getSearchengineAll:d,getSearchengineCount:h,getSearchengineExport:$,getHttpActionByIp:M,getSearchContentByIp:R,getForumpostByIp:U};return x}function t(e,t,n,o,a,r,i,l){function s(t){return r.sysbaseinfo().then(function(n){var a=new Date(n.data||""),r=a-24e3,i=new Date(r),l=i-t;l-=l%2e4;var s=new Date(l),c=y(i),d=y(s);return e.get(o+"/auditlogs/traffic/totalstats/starttime/"+d+"/endtime/"+c).then(function(e){return r%2e4!==0&&e.data.length>1&&e.data.splice(e.data.length-1,1),e.endTime=i,e})})}function c(t){return r.sysbaseinfo().then(function(n){var a=new Date(n.data||""),r=a-24e3,i=new Date(r),l=i-t,s=new Date(l),c=y(i),d=y(s);return e.get(o+"/auditlogs/traffic/protocolstats/starttime/"+d+"/endtime/"+c).then(function(e){return e.data.forEach(function(e){"TRADITION"===e.trafficName&&(e.trafficName="网络通用协议"),"OTHER"===e.trafficName&&(e.trafficName="其他")}),e.data})})}function d(t,n){return r.sysbaseinfo().then(function(a){var r=new Date(a.data||""),i=r-24e3,l=new Date(i),s=l-n,c=new Date(s),d=y(l),u=y(c);return e.get(o+"/auditlogs/iptraffic/devices/total/"+t+"/"+u+"/"+d).then(function(e){return e.endTime=l,e})})}function u(t){return e.get(o+"/devices/topology/"+t+"?$filter=category%20eq%20FACTORY_DEVICE&$orderby=name").then(function(e){return e.data})}function p(t){return e.get(o+"/devices/topology/"+t+"?$filter=category%20eq%20FACTORY_DEVICE and selected eq 1&$orderby=name").then(function(e){return e.data})}function f(t,n){var a=n?1:0;return e.put(o+"/devices/iptraffic/"+t+"/"+a).then(function(e){return e.data})}function m(e,t,o){e.noPoint=t.length<1;var a={lang:{noData:"当前时间段内没有实时流量数据"},chart:{type:"line",backgroundColor:"#212121",color:"white",animation:Highcharts.svg,marginRight:10,events:{load:function(){var t=this.series[0],a=this.series[1],r=n(function(){I(o,24e3).then(function(n){e.noPoint=!1;var o=n.endTime.getTime();if(n=n.data,0===n.length)t.addPoint([o,0],!0,!1),a.addPoint([o,0],!0,!1);else{var r=0-n.length;for(r;r<0;r+=1){var i=new Date(n[r+n.length].startTime).getTime(),l=Math.floor(n[r+n.length].recvBytes/10.24)/100,s=Math.floor(n[r+n.length].sendBytes/10.24)/100;t.addPoint([i,l],!0,!1),a.addPoint([i,s],!0,!1)}}for(var c=0;c<t.data.length;c+=1)t.data[c].x<o-36e5&&t.removePoint(c,!0);for(var d=0;d<a.data.length;d+=1)a.data[d].x<o-36e5&&a.removePoint(d,!0)})},24e3);e.$on("$destroy",function(){n.cancel(r)})}}},colors:["#EEEEEE","#999999"],title:{text:"",style:{color:"#eeeeee"}},xAxis:{title:{text:"时间",style:{color:"#CCCCCC"}},type:"datetime",tickPixelInterval:150,gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}}},yAxis:{title:{text:"速率 (KB/s)",style:{color:"#CCCCCC"}},plotLines:[{value:0,width:1e5}],gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}},min:0,offset:0},legend:{enabled:!0,itemStyle:{color:"#EEEEEE",fontWeight:"bold"},itemHiddenStyle:{color:"#555555"},itemHoverStyle:{color:"#45EE45"}},exporting:{enabled:!1},plotOptions:{line:{lineWidth:2,turboThreshold:1e4},series:{marker:{symbol:"circle",enabled:!1}}},rangeSelector:{buttons:[{count:1,type:"minute",text:"1分"},{count:5,type:"minute",text:"5分"},{count:30,type:"minute",text:"30分"},{type:"all",text:"全部"}],inputEnabled:!1,selected:0},tooltip:{formatter:function(){return"<b>数据流量</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)+" KB/s"}},series:[{name:"设备输入流量",color:"#76B900",data:function(){var e=[],n=0-t.length;for(n;n<0;n+=1)e.push({x:new Date(t[n+t.length].startTime).getTime(),y:Math.floor(t[n+t.length].recvBytes/10.24)/100});return e}()},{name:"设备输出流量",color:"#ffc52d",data:function(){var e=[],n=0-t.length;for(n;n<0;n+=1)e.push({x:new Date(t[n+t.length].startTime).getTime(),y:Math.floor(t[n+t.length].sendBytes/10.24)/100});return e}()}]};return a}function g(e,t,o){var a={lang:{noData:"当前时间段内没有实时流量数据"},chart:{type:"line",backgroundColor:"#212121",color:"white",animation:Highcharts.svg,marginRight:10,events:{load:function(){var e=this.series[0],t=n(function(){s(24e3).then(function(t){var n=t.endTime.getTime();if(t=t.data,0===t.length)e.addPoint([n,0],!0,!1);else{var o=0-t.length;for(o;o<0;o+=1){var a=new Date(t[o+t.length].timestamp).getTime(),r=Math.floor(t[o+t.length].totalBytes/10.24)/100;e.addPoint([a,r],!0,!1)}}})},24e3);o.$on("$destroy",function(){n.cancel(t)})}}},colors:["#EEEEEE"],title:{text:t.title,style:{color:"#eeeeee"}},xAxis:{title:{text:"时间",style:{color:"#CCCCCC"}},type:"datetime",gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}}},yAxis:{title:{text:"速率 (KB/s)",style:{color:"#CCCCCC"}},plotLines:[{value:0,width:1e5}],gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}},min:0,offset:0},legend:{enabled:t.legendEnable,itemStyle:{color:"#EEEEEE",fontWeight:"bold"},itemHiddenStyle:{color:"#555555"},itemHoverStyle:{color:"#45EE45"}},exporting:{enabled:!1},plotOptions:{line:{lineWidth:2,turboThreshold:1e4},series:{animation:{duration:1e3},marker:{symbol:"circle"}}},rangeSelector:{buttons:[{count:1,type:"minute",text:"1分"},{count:5,type:"minute",text:"5分"},{count:30,type:"minute",text:"30分"},{count:60,type:"minute",text:"60分"},{type:"all",text:"全部"}],inputEnabled:!1,selected:3},tooltip:{formatter:function(){return"<b>"+this.series.name+":</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)+" KB/s"}},series:e};return a}function h(e,o,a){var r,i={lang:{noData:"当前时间段内没有实时流量数据"},chart:{type:"line",backgroundColor:"#212121",color:"white",animation:Highcharts.svg,marginRight:10,events:{load:function(){var e=this.series;r=n(function(){if(void 0!==e&&e.length>0&&o.deviceIds.length){for(var a=[],i=0;i<o.deviceIds.length;i++)a.push(d(o.deviceIds[i],24e3));t.all(a).then(function(t){for(var a=0;a<o.deviceIds.length;a++){for(var i=t[a].endTime.getTime(),l=0;l<t[a].data.length;l++){var s=new Date(t[a].data[l].startTime).getTime(),c=Math.floor(t[a].data[l].totalBytes/10.24)/100;void 0!==e[a]?e[a].addPoint([s,c],!0,!1):n.cancel(r)}0===t[a].data.length&&(e[a]?e[a].addPoint([i,0],!0,!1):n.cancel(r))}})}},24e3),a.$on("$destroy",function(){n.cancel(r)})}}},colors:["#EEEEEE"],title:{text:o.title,style:{color:"#eeeeee"}},xAxis:{title:{text:"时间",style:{color:"#CCCCCC"}},type:"datetime",tickPixelInterval:150,gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}}},yAxis:{title:{text:"速率 (KB/s)",style:{color:"#CCCCCC"}},plotLines:[{value:0,width:1e5}],gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}},min:0,offset:0},legend:{enabled:o.legendEnable,itemStyle:{color:"#EEEEEE",fontWeight:"bold"},itemHiddenStyle:{color:"#555555"},itemHoverStyle:{color:"#45EE45"}},exporting:{enabled:!1},plotOptions:{line:{lineWidth:2,turboThreshold:1e4},series:{marker:{symbol:"circle",enabled:!1}}},rangeSelector:{buttons:[{count:1,type:"minute",text:"1分"},{count:5,type:"minute",text:"5分"},{count:30,type:"minute",text:"30分"},{type:"all",text:"全部"}],inputEnabled:!1,selected:0},tooltip:{formatter:function(){return"<b>"+this.series.name+":</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)+" KB/s"}},series:e};return i}function v(e,t,n){e.map(function(e){"MODBUS_TCP"===e.trafficName&&(e.trafficName="MODBUS-TCP"),"MODBUS_UDP"===e.trafficName&&(e.trafficName="MODBUS-UDP")});for(var o=[],a=0;a<e.length;a++){var r=[];r.push(e[a].trafficName),r.push(l.formatTrafficDataWithoutUnit(e[a].totalBytes,n)),o.push(r)}var i={lang:{noData:"当前时间段没有汇总流量数据"},chart:{backgroundColor:null,plotBackgroundColor:null,plotBorderWidth:null,color:"white",plotShadow:!1},title:{text:t.title,style:{color:"#eeeeee"}},style:{color:"#EEEEEE"},tooltip:{pointFormat:"<b>{series.data.trafficName}</b>:{point.percentage:.1f}% <b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.y}"+n+" <b>",shadow:!1,style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"white",textShadow:!1}}}},series:[{type:"pie",name:"协议流量",data:o}]};return i}function y(e){return e.getUTCFullYear()+"-"+(e.getUTCMonth()+1>9?e.getUTCMonth()+1:"0"+(e.getUTCMonth()+1))+"-"+(e.getUTCDate()>9?e.getUTCDate():"0"+e.getUTCDate())+"T"+(e.getUTCHours()>9?e.getUTCHours():"0"+e.getUTCHours())+":"+(e.getUTCMinutes()>9?e.getUTCMinutes():"0"+e.getUTCMinutes())+":"+(e.getUTCSeconds()>9?e.getUTCSeconds():"0"+e.getUTCSeconds())+"Z"}function I(n,a){return r.sysbaseinfo().then(function(r){var i=new Date(r.data||""),l=i-24e3,s=new Date(l),c=s-a,d=new Date(c),u=y(s),p=y(d);return e.get(o+"/auditlogs/iptraffic/devices/"+n+"/"+p+"/"+u).then(function(e){return e.endTime=s,t.when(e)})})}function D(t){return e.get(o+"/auditlogs/topology/"+i.id+"/iptraffic/devices",{params:a(t)}).then(function(e){return e.data})}function T(t){return e.get(o+"/auditlogs/topology/"+i.id+"/iptraffic/devices/count",{params:a(t)}).then(function(e){return e.data})}var b={getOverView:s,getProtocolView:c,getDeviceView:d,getDevice:u,getSelectedDevice:p,updateSelectedDevice:f,lineChart:m,totalLineChart:g,pieChart:v,deviceLineChart:h,formatDate:y,getDevicedataStats:I,getDevicedataList:D,getDevicedataCount:T};return b}function n(e,t,n,o,a,r,i){function l(t,n,a){var r=D(a),i=D(n);return e.get(o+"/auditlogs/traffic/devicetype/dpi/boxes/"+t+"/starttime/"+i+"/endtime/"+r).then(function(e){return e.endTime=a,e})}function s(e,o,a,i){var s,c={lang:{noData:"当前时间段内没有实时流量数据"},chart:{type:"line",backgroundColor:"#212121",color:"white",animation:Highcharts.svg,marginRight:10,events:{addSeries:function(){var e=this.renderer.label("A new device was added",100,120).attr({fill:Highcharts.getOptions().colors[0],padding:10,r:5,zIndex:8}).css({color:"#FFFFFF"}).add();setTimeout(function(){e.fadeOut()},2e3)},load:function(){var e=this.series,o=this;s=n(function(){i.reloadDevices=!0,void 0!==e&&r.sysbaseinfo().then(function(r){var c=new Date(r.data||""),d=c-24e3,p=new Date(d),f=p-36e5,m=new Date(f);i.reloadDevices=!1,u(m,p).then(function(r){for(var i=r,c=[],d=[],u=0;u<i.length;u++){for(var g=!0,h=i[u].boxId,v=0;v<e.length;v++){var y=e[v].options.boxId;if(h===y){c.push(i[u]),g=!1;break}}if(g&&d.push(i[u]),c.length+d.length===5)break}for(var D=0;D<e.length;D++){for(var T=!0,b=0;b<c.length;b++)if(e[D].options.boxId===c[b].boxId){T=!1;break}T&&(a.push(o.series[D].color),o.series[D].remove(!0))}if(I(o),d.length>0){f=p-36e5,m=new Date(f);for(var S=[],P=0;P<d.length;P++)S.push(l(d[P].boxId,m,p));t.all(S).then(function(e){for(var t=0;t<d.length;t++){for(var n=e[t].endTime.getTime(),r=[],i=0;i<e[t].data.length;i++){var l=new Date(e[t].data[i].timestamp).getTime(),s=Math.floor(e[t].data[i].totalBytes/10.24)/100;r.push({x:l,y:s})}0===e[t].data.length&&r.push({x:n,y:0});var c={boxId:d[t].boxId,name:d[t].deviceName,color:a.pop(),data:r};o.addSeries(c)}I(o)})}if(c.length>0){f=p-24e3,m=new Date(f);for(var A=[],C=0;C<c.length;C++)A.push(l(c[C].boxId,m,p));t.all(A).then(function(t){for(var a=0;a<c.length;a++){for(var r,i=t[a].endTime.getTime(),l=0;l<e.length;l++)if(void 0!==e[l]&&e[l].options.boxId===c[a].boxId){r=l;break}if(void 0!==r){e[r].update({name:c[a].deviceName});for(var d=0;d<t[a].data.length;d++){var u=new Date(t[a].data[d].timestamp).getTime(),p=Math.floor(t[a].data[d].totalBytes/10.24)/100;e[r].addPoint([u,p],!1,!1)}0===t[a].data.length&&e[r].addPoint([i,0],!1,!1)}else n.cancel(s)}I(o)})}})})},24e3),i.$on("$destroy",function(){n.cancel(s)})}}},colors:["#EEEEEE"],title:{text:o.title,style:{color:"#eeeeee"}},xAxis:{title:{text:"时间",style:{color:"#CCCCCC"}},type:"datetime",tickPixelInterval:150,gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}}},yAxis:{title:{text:"速率 (KB/s)",style:{color:"#CCCCCC"}},plotLines:[{value:0,width:1e5}],gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}},min:0,offset:0},legend:{enabled:o.legendEnable,itemStyle:{color:"#EEEEEE",fontWeight:"bold"},itemHiddenStyle:{color:"#555555"},itemHoverStyle:{color:"#45EE45"}},exporting:{enabled:!1},plotOptions:{line:{lineWidth:2,turboThreshold:1e4},series:{marker:{symbol:"circle",enabled:!1}}},rangeSelector:{buttons:[{count:1,type:"minute",text:"1分"},{count:5,type:"minute",text:"5分"},{count:30,type:"minute",text:"30分"},{type:"all",text:"全部"}],inputEnabled:!1,selected:0},tooltip:{formatter:function(){return"<b>"+this.series.name+"</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)+" KB/s"}},series:e};return c}function c(t){return r.sysbaseinfo().then(function(n){var a=new Date(n.data||""),r=a-24e3,i=new Date(r),l=i-t,s=new Date(l),c=D(i),d=D(s);return e.get(o+"/auditlogs/traffic/devicetype/dpi/starttime/"+d+"/endtime/"+c).then(function(e){return e.data})})}function d(e,t,n){for(var o=[],a=0;a<e.length;a++){var r=[];r.push(e[a].deviceName),r.push(i.formatTrafficDataWithoutUnit(e[a].totalBytes,n)),o.push(r)}var l={lang:{noData:"当前时间段没有汇总流量数据"},chart:{backgroundColor:null,plotBackgroundColor:null,plotBorderWidth:null,color:"white",plotShadow:!1},title:{text:t.title,style:{color:"#eeeeee"}},style:{color:"#EEEEEE"},tooltip:{useHTML:!0,pointFormat:"{series.data.deviceName}: <b>{point.percentage:.1f}%</b>",formatter:function(){$("div.highcharts-tooltip span").css("white-space","inherit");var e=this.point.percentage?this.point.percentage.toFixed(1):this.point.percentage,t='<div style="font-size: 10px;width: 200px;display:block;word-break: break-all;word-wrap: break-word;">'+this.key+'<br/><span style="font-size:10px">: <b>'+e+"%</b></span></div>";return t}},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{useHTML:!0,enabled:!0,formatter:function(){return'<div style="white-space:pre"><p style="width: 200px; display:inline-block; white-space:pre-wrap;"><b>'+this.point.name+"</b>:"+this.point.y+n+"</p></div>"}}}},series:[{type:"pie",name:"安全设备汇总流量",data:o}]};return l}function u(t,n){var r=D(n),i=D(t);return e.get(o+"/auditlogs/traffic/devicetype/dpi/devices/starttime/"+i+"/endtime/"+r,{params:a({$limit:5})}).then(function(e){return e.data})}function p(t){return r.sysbaseinfo().then(function(n){var r=new Date(n.data||""),i=r-24e3,l=new Date(i),s=l-36e5,c=new Date(s),d=D(l),u=D(c);return t=t||{},t.$limit=t.$limit||5,e.get(o+"/auditlogs/traffic/devicetype/dpi/devices/starttime/"+u+"/endtime/"+d,{params:a(t)}).then(function(e){return e.data})})}function f(t){return r.sysbaseinfo().then(function(n){var r=new Date(n.data||""),i=r-24e3,l=new Date(i),s=l-36e5,c=new Date(s),d=D(l),u=D(c);return e.get(o+"/auditlogs/traffic/devicetype/dpi/devices/count/starttime/"+u+"/endtime/"+d,{params:a(t)}).then(function(e){return e.data})})}function m(t,n){D(n),D(t);return e.get(o+"/auditlogs/traffic/devicetype/dpi/protocoltypes").then(function(e){var t=[];return e.data.forEach(function(e){"TRADITION"===e.trafficName&&(e.trafficName="网络通用协议"),"OTHER"===e.trafficName&&(e.trafficName="其他"),t.push({protocolName:e.trafficName,trafficId:"TRAFFIC_"+e.trafficName.toUpperCase()})}),t})}function g(t,n,a){"TRAFFIC_网络通用协议"===t&&(t="TRAFFIC_TRADITION"),"TRAFFIC_其他"===t&&(t="TRAFFIC_OTHER");var r=D(a),i=D(n);return e.get(o+"/auditlogs/traffic/devicetype/dpi/protocoltype/"+t+"/starttime/"+i+"/endtime/"+r).then(function(e){return e.endTime=a,e})}function h(e,o,a,i){e.map(function(e){"MODBUS_TCP"===e.name&&(e.name="MODBUS-TCP"),"MODBUS_UDP"===e.name&&(e.name="MODBUS-UDP")});var l,s={lang:{noData:"当前时间段内没有实时流量数据"},chart:{type:"line",backgroundColor:"#212121",color:"white",animation:Highcharts.svg,marginRight:10,events:{addSeries:function(){var e=this.renderer.label("A new protocol was added",100,120).attr({fill:Highcharts.getOptions().colors[0],padding:10,r:5,zIndex:8}).css({color:"#FFFFFF"}).add();setTimeout(function(){e.fadeOut()},2e3)},load:function(){var e=this.series,o=this;l=n(function(){void 0!==e&&r.sysbaseinfo().then(function(r){var i=new Date(r.data||""),s=i-24e3,c=new Date(s),d=c-36e5,u=new Date(d);m(u,c).then(function(r){for(var i=r,s=[],p=[],f=0;f<i.length;f++){for(var m=!0,h="MODBUS_TCP"===i[f].protocolName?"MODBUS-TCP":"MODBUS_UDP"===i[f].protocolName?"MODBUS-UDP":i[f].protocolName,v=0;v<e.length;v++){var y=e[v].name;if(h===y){s.push(i[f]),m=!1;break}}m&&p.push(i[f])}for(var D=0;D<e.length;D++){for(var T=!0,b=0;b<s.length;b++)if(e[D].name===("MODBUS_TCP"===s[b].protocolName?"MODBUS-TCP":"MODBUS_UDP"===s[b].protocolName?"MODBUS-UDP":s[b].protocolName)){T=!1;break}T&&(a.push(o.series[D].color),o.series[D].remove(!0))}if(I(o),p.length>0){d=c-36e5,u=new Date(d);for(var S=[],P=0;P<p.length;P++)S.push(g(p[P].trafficId,u,c));t.all(S).then(function(e){for(var t=0;t<p.length;t++){for(var n=e[t].endTime.getTime(),r=[],i=0;i<e[t].data.length;i++){var l=new Date(e[t].data[i].timestamp).getTime(),s=Math.floor(e[t].data[i].totalBytes/10.24)/100;r.push({x:l,y:s})}0===e[t].data.length&&r.push({x:n,y:0});var c={name:"MODBUS_TCP"===p[t].protocolName?"MODBUS-TCP":"MODBUS_UDP"===p[t].protocolName?"MODBUS-UDP":p[t].protocolName,color:a.pop(),data:r};o.addSeries(c)}I(o)})}if(s.length>0){d=c-24e3,u=new Date(d);for(var A=[],C=0;C<s.length;C++)A.push(g(s[C].trafficId,u,c));t.all(A).then(function(t){for(var a=0;a<s.length;a++){for(var r,i=t[a].endTime.getTime(),c=0;c<e.length;c++)if(void 0!==e[c]&&e[c].name===s[a].protocolName){r=c;break}if(void 0!==r){for(var d=0;d<t[a].data.length;d++){var u=new Date(t[a].data[d].timestamp).getTime(),p=Math.floor(t[a].data[d].totalBytes/10.24)/100;e[r].addPoint([u,p],!0,!1)}0===t[a].data.length&&e[r].addPoint([i,0],!0,!1)}else n.cancel(l)}I(o)})}})}),I(o)},24e3),i.$on("$destroy",function(){n.cancel(l)})}}},colors:["#EEEEEE"],title:{text:o.title,style:{color:"#eeeeee"}},xAxis:{title:{text:"时间",style:{color:"#CCCCCC"}},type:"datetime",gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}}},yAxis:{title:{text:"速率 (KB/s)",style:{color:"#CCCCCC"}},plotLines:[{value:0,width:1e5}],gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}},min:0,offset:0},legend:{enabled:o.legendEnable,itemStyle:{color:"#EEEEEE",fontWeight:"bold"},itemHiddenStyle:{color:"#555555"},itemHoverStyle:{color:"#45EE45"}},exporting:{enabled:!1},plotOptions:{line:{lineWidth:2,turboThreshold:1e4},series:{marker:{symbol:"circle",enabled:!1}}},rangeSelector:{buttons:[{count:1,type:"minute",text:"1分"},{count:5,type:"minute",text:"5分"},{count:30,type:"minute",text:"30分"},{type:"all",text:"全部"}],inputEnabled:!1,selected:0},tooltip:{formatter:function(){return"<b>"+this.series.name+":</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)+" KB/s"}},series:e};return s}function v(t,n){return r.sysbaseinfo().then(function(a){var r=new Date(a.data||""),i=r-24e3,l=new Date(i),s=l-n,c=new Date(s),d=D(l),u=D(c);return e.get(o+"/auditlogs/traffic/devicetype/dpi/protocolstats/boxes/"+t+"/starttime/"+u+"/endtime/"+d).then(function(e){return e.data.forEach(function(e){"TRADITION"===e.trafficName&&(e.trafficName="网络通用协议"),"OTHER"===e.trafficName&&(e.trafficName="其他")}),e.data})})}function y(e,t,n){for(var o=[],a=0;a<e.length;a++){var r=[];r.push(e[a].trafficName),r.push(i.formatTrafficDataWithoutUnit(e[a].totalBytes,n)),o.push(r)}var l={lang:{noData:"当前时间段没有汇总流量数据"},chart:{backgroundColor:null,plotBackgroundColor:null,plotBorderWidth:null,color:"white",plotShadow:!1},title:{text:t.title,style:{color:"#eeeeee"}},style:{color:"#EEEEEE"},tooltip:{pointFormat:"{series.data.trafficName}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.y}"+n+" <b>",shadow:!1,style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"white",textShadow:!1}}}},series:[{type:"pie",name:"工控协议汇总流量",data:o}]};return l}function I(e){var t=400;if(e){var n=e.hasData()?t:t/2;n!==e.chartHeight&&e.setSize(e.chartWidth,n,!1)}}function D(e){return e.getUTCFullYear()+"-"+(e.getUTCMonth()+1>9?e.getUTCMonth()+1:"0"+(e.getUTCMonth()+1))+"-"+(e.getUTCDate()>9?e.getUTCDate():"0"+e.getUTCDate())+"T"+(e.getUTCHours()>9?e.getUTCHours():"0"+e.getUTCHours())+":"+(e.getUTCMinutes()>9?e.getUTCMinutes():"0"+e.getUTCMinutes())+":"+(e.getUTCSeconds()>9?e.getUTCSeconds():"0"+e.getUTCSeconds())+"Z"}var T={getDpiTrafficRealTime:l,deviceLineChart:s,getDpiTrafficTotal:c,devicePieChart:d,getDpiDevices:u,getDpiTrafficList:p,getDpiTrafficCount:f,getSelectedProtocols:m,getProtocolRealTime:g,protocolLineChart:h,getProtocolTotal:v,protocolPieChar:y};return T}function o(e,t,n,o,a){function r(o,a,r,i){var l=v(r),s=v(a),c=o.ipAddr;return e.get(t+"/auditlogs/traffic/devicetype/ic/devices/"+c+"/starttime/"+s+"/endtime/"+l,{params:n(i)}).then(function(e){return e.data.map(function(e){e.sendSpeed=e.sendBytes,e.recvSpeed=e.recvBytes,e.totalBytes=e.sendBytes+e.recvBytes}),e.device=o,e.endTime=r,e})}function i(o,a,r,i,l){"TRAFFIC_网络通用协议"===a&&(a="TRAFFIC_TRADITION"),"TRAFFIC_其他"===a&&(a="TRAFFIC_OTHER"),"TRAFFIC_MODBUS-TCP"===a&&(a="TRAFFIC_MODBUS_TCP"),"TRAFFIC_MODBUS-UDP"===a&&(a="TRAFFIC_MODBUS_UDP");var s=v(i),c=v(r);return e.get(t+"/auditlogs/traffic/devicetype/ic/devices/"+o+"/protocoltype/"+a+"/starttime/"+c+"/endtime/"+s,{params:n(l)}).then(function(e){return e.data.map(function(e){e.sendSpeed=e.sendBytes,e.recvSpeed=e.recvBytes,e.totalBytes=e.sendBytes+e.recvBytes}),e.endTime=i,e})}function l(n){return a.sysbaseinfo().then(function(o){var a=new Date(o.data||""),r=a-24e3,i=new Date(r),l=i-n;l-=l%2e4;var s=new Date(l),c=v(i),d=v(s);return e.get(t+"/auditlogs/traffic/devicetype/ic/starttime/"+d+"/endtime/"+c).then(function(e){return e.data.map(function(e){e.deviceId=e.iCDeviceMac||e.iCDeviceIp}),e.data})})}function s(n,o){return a.sysbaseinfo().then(function(a){var r=new Date(a.data||""),i=r-24e3,l=new Date(i),s=l-o,c=new Date(s),d=v(l),u=v(c);return e.get(t+"/auditlogs/traffic/devicetype/ic/protocolstats/devices/"+n+"/starttime/"+u+"/endtime/"+d).then(function(e){return e.data.forEach(function(e){"TRADITION"===e.trafficName&&(e.trafficName="网络通用协议"),"OTHER"===e.trafficName&&(e.trafficName="其他")}),e.data})})}function c(o,a,r){var i=v(a),l=v(o);return r=r||{},r.$limit=r.$limit,e.get(t+"/auditlogs/traffic/devicetype/ic/devices/starttime/"+l+"/endtime/"+i,{params:n(r)}).then(function(e){return e.data.map(function(e){e.Id=e.deviceId,e.deviceAddr=e.iCDeviceIp||e.iCDeviceMac,e.deviceId=e.deviceAddr,e.macAddr=e.iCDeviceMac,e.ipAddr=e.iCDeviceIp,e.totalBytes=e.sendBytes+e.recvBytes,e.deviceInfo=encodeURI((e.iCDeviceMac||" ")+"|"+(e.iCDeviceIp||" ")+"|"+(e.deviceName||" "))}),e.data})}function d(o,a,r){var i=v(a),l=v(o);return e.get(t+"/auditlogs/traffic/devicetype/ic/devices/count/starttime/"+l+"/endtime/"+i,{params:n(r)}).then(function(e){return e.data})}function u(e,t,n){return c(e,t,{$limit:n||5})}function p(o){return e.get(t+"/auditlogs/traffic/devicetype/ic/protocoltypes",{params:n({$filter:"(iCDeviceIp eq '"+o+"')"})}).then(function(e){var t=[];return e.data.forEach(function(e){"TRADITION"===e.trafficName&&(e.trafficName="网络通用协议"),"OTHER"===e.trafficName&&(e.trafficName="其他"),"MODBUS_TCP"===e.trafficName&&(e.trafficName="MODBUS-TCP"),"MODBUS_UDP"===e.trafficName&&(e.trafficName="MODBUS-UDP"),t.push({protocolName:e.trafficName,trafficId:"TRAFFIC_"+e.trafficName.toUpperCase()})}),t})}function f(e,t){var n={lang:{noData:"当前时间段内没有实时流量数据"},chart:{type:"line",backgroundColor:"#212121",color:"white",animation:Highcharts.svg,marginRight:10},colors:["#EEEEEE"],title:{text:t.title,style:{color:"#eeeeee"}},xAxis:{title:{text:"时间",style:{color:"#CCCCCC"}},type:"datetime",gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}}},yAxis:{title:{text:"速率 (KB/s)",style:{color:"#CCCCCC"}},plotLines:[{value:0,width:1e5}],gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}},min:0,offset:0},legend:{enabled:t.legendEnable,itemStyle:{color:"#EEEEEE",fontWeight:"bold"},itemHiddenStyle:{color:"#555555"},itemHoverStyle:{color:"#45EE45"}},exporting:{enabled:!1},plotOptions:{line:{lineWidth:2,turboThreshold:1e4},series:{marker:{symbol:"circle",enabled:!1}}},rangeSelector:{buttons:[{count:1,type:"minute",text:"1分"},{count:5,type:"minute",text:"5分"},{count:30,type:"minute",text:"30分"},{type:"all",text:"全部"}],inputEnabled:!1,selected:0},tooltip:{formatter:function(){return"<b>"+this.series.name+":</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)+" KB/s"}},series:e};return n}function m(e,t){var n={lang:{noData:"当前时间段内没有实时流量数据"},chart:{type:"line",backgroundColor:"#212121",color:"white",animation:Highcharts.svg,marginRight:10},colors:["#EEEEEE"],title:{text:t.title,style:{color:"#eeeeee"}},xAxis:{title:{text:"时间",style:{color:"#CCCCCC"}},type:"datetime",gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}}},yAxis:{title:{text:"速率 (KB/s)",style:{color:"#CCCCCC"}},plotLines:[{value:0,width:1e5}],gridLineColor:"#535353",labels:{style:{color:"#CCCCCC"}},min:0,offset:0},legend:{enabled:t.legendEnable,itemStyle:{color:"#EEEEEE",fontWeight:"bold"},itemHiddenStyle:{color:"#555555"},itemHoverStyle:{color:"#45EE45"}},exporting:{enabled:!1},plotOptions:{line:{lineWidth:2,turboThreshold:1e4},series:{marker:{symbol:"circle",enabled:!1}}},rangeSelector:{buttons:[{count:1,type:"minute",text:"1分"},{count:5,type:"minute",text:"5分"},{count:30,type:"minute",text:"30分"},{type:"all",text:"全部"}],inputEnabled:!1,selected:0},tooltip:{formatter:function(){return"<b>"+this.series.name+":</b><br/>"+Highcharts.dateFormat("%Y-%m-%d %H:%M:%S",this.x)+"<br/>"+Highcharts.numberFormat(this.y,2)+" KB/s"}},series:e};return n}function g(e,t,n){for(var a=[],r=0;r<e.length;r++){var i=[];i.push(e[r].deviceName+" ("+e[r].iCDeviceIp+")"),i.push(o.formatTrafficDataWithoutUnit(e[r].totalBytes,n)),a.push(i)}var l={lang:{noData:"当前时间段没有汇总流量数据"},chart:{backgroundColor:null,plotBackgroundColor:null,plotBorderWidth:null,color:"white",plotShadow:!1},title:{text:t.title,style:{color:"#eeeeee"}},style:{color:"#EEEEEE"},tooltip:{pointFormat:"{series.data.trafficName}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.y}"+n+" <b>",shadow:!1,style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"white",textShadow:!1}}}},series:[{type:"pie",name:"设备流量",data:a}]};return l}function h(e,t,n){e.map(function(e){"MODBUS_TCP"===e.trafficName&&(e.trafficName="MODBUS-TCP"),"MODBUS_UDP"===e.trafficName&&(e.trafficName="MODBUS-UDP")});for(var a=[],r=0;r<e.length;r++){var i=[];i.push(e[r].trafficName),i.push(o.formatTrafficDataWithoutUnit(e[r].totalBytes,n)),a.push(i)}var l={chart:{lang:{noData:"当前时间段没有汇总流量数据"},backgroundColor:null,plotBackgroundColor:null,plotBorderWidth:null,color:"white",plotShadow:!1},title:{text:t.title,style:{color:"#eeeeee"}},style:{color:"#EEEEEE"},tooltip:{pointFormat:"{series.data.trafficName}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.y}"+n+" <b>",shadow:!1,style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"white",textShadow:!1}}}},series:[{type:"pie",name:"协议流量",data:a}]};return l}function v(e){return e.getUTCFullYear()+"-"+(e.getUTCMonth()+1>9?e.getUTCMonth()+1:"0"+(e.getUTCMonth()+1))+"-"+(e.getUTCDate()>9?e.getUTCDate():"0"+e.getUTCDate())+"T"+(e.getUTCHours()>9?e.getUTCHours():"0"+e.getUTCHours())+":"+(e.getUTCMinutes()>9?e.getUTCMinutes():"0"+e.getUTCMinutes())+":"+(e.getUTCSeconds()>9?e.getUTCSeconds():"0"+e.getUTCSeconds())+"Z"}function y(o){return e.get(t+"/auditlogs/traffics",{params:n(o)}).then(function(e){return e.data})}function I(o){return e.get(t+"/auditlogs/traffics/count",{params:n(o)}).then(function(e){return e.data})}var D={getDeviceTrafficList:c,getDeviceTrafficCount:d,getTopTrafficDevice:u,getDeviceTraffic:r,getDeviceTrafficStatistics:l,getSelectedProtocols:p,getProtocolTraffic:i,getProtocolTrafficStatistics:s,deviceLineChart:f,devicePieChart:g,protocolLineChart:m,protocolPieChart:h,formatDate:v,getDeviceTrafficStats:y,getDeviceTrafficStatsCount:I};return D}function a(e,t,n){function o(o,a){return e.get(t+"/auditlogs/action/web/starttime/"+o+"/endtime/"+a,{params:n({$limit:10})}).then(function(e){return e.data})}function a(e){for(var t=["#c14746","#ed8956","#fafd6d","#5deb41","#62fece","#55bcfc","#4970fe","#5e43bf","#9333ae","#d65897"],n=[],o=[],a=0;a<e.length&&a<10;a++)n.push(e[a].usrIp||"未知"),o.push({name:e[a].usrIp,color:t[a],y:e[a].totalNum});var r={lang:{noData:"当前时间段没有用户网站访问统计数据"},chart:{type:"column",backgroundColor:"#212121",plotBackgroundColor:null,plotBorderWidth:null,color:"white",plotShadow:!1},title:{text:""},legend:{enabled:!1},xAxis:{categories:n,labels:{style:{color:"#CCCCCC"}}},yAxis:{min:0,allowDecimals:!1,gridLineWidth:.5,gridLineColor:"rgb(238, 197, 102)",title:{text:"总数 (个)"}},tooltip:{headerFormat:'<span font-size:10px">{point.key} : <b>{point.y}</b>个</span>',pointFormat:"",footerFormat:"",shared:!0,useHTML:!0},plotOptions:{column:{pointWidth:25,pointPadding:.3,borderWidth:0}},style:{color:"#EEEEEE"},series:[{data:o}]};return r}function r(e){var t=[e.shoppingNum,e.newsNum,e.videoNum,e.sportNum,e.entertainmentNum,e.financeNum,e.gamesNum,e.novelNum],n=6*Math.max(e.shoppingNum,e.newsNum,e.videoNum,e.sportNum,e.entertainmentNum,e.financeNum,e.gamesNum,e.novelNum)/5,o=[{name:"购物",max:n},{name:"新闻",max:n},{name:"视频",max:n},{name:"体育",max:n},{name:"娱乐",max:n},{name:"财经",max:n},{name:"游戏",max:n},{name:"小说",max:n}],a={normal:{width:1,color:"#30c919"}},r={tooltip:{},radar:{shape:"polygon",indicator:o,splitNumber:4,name:{textStyle:{color:"#E8E8E8"}},splitLine:{lineStyle:{color:["rgba(238, 197, 102, 0.1)","rgba(238, 197, 102, 0.2)","rgba(238, 197, 102, 0.4)","rgba(238, 197, 102, 0.8)","rgba(238, 197, 102, 1)"].reverse()}},splitArea:{show:!1},axisLine:{lineStyle:{color:"rgba(238, 197, 102, 0.5)"}}},series:[{name:e.usrIp,type:"radar",lineStyle:a,symbol:"circle",itemStyle:{normal:{color:"#e8e8e8"}},areaStyle:{normal:{opacity:.05}},data:[{value:t,name:e.usrIp,areaStyle:{normal:{opacity:.9,color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:"#3F9371"},{offset:1,color:"#97BB37"}],(!1))}}}]}]};return r}function i(n,o,a){var r=a?{password:a}:null;return e({method:"POST",url:t+"/auditlogs/action/web/starttime/"+n+"/endtime/"+o+"/export",data:r,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.data})}var l={getBehaviorDatas:o,behaviorBarChart:a,behaviorRadarChart:r,getAllExport:i};return l}e.$inject=["$q","$http","URI","encodeURL","topologyId"],t.$inject=["$http","$q","$interval","URI","encodeURL","apiInfo","topologyId","trafficDataService"],n.$inject=["$http","$q","$interval","URI","encodeURL","apiInfo","trafficDataService"],o.$inject=["$http","URI","encodeURL","trafficDataService","apiInfo"],a.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("Audit",e).factory("mwdata",t).factory("dpidevicedata",n).factory("icdevicedata",o).factory("behaviordata",a)}(),function(){"use strict";function e(e,t,n){function o(e){return t.get(i+"/auditlog/"+e).then(function(e){return e.data})}function a(e){return t.post(i+"/auditlog/action",e).then(function(e){return e})}function r(e){return t.post(i+"/auditlog/content",e).then(function(e){return e})}var i=n+"/servicesetting",l={getAuditSetting:o,setAuditSetting:a,setContentAuditSetting:r};return l}e.$inject=["$q","$http","URI"],angular.module("southWest.models").factory("AuditSetting",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m){function g(t){return e.all([n({method:"POST",url:i+"/login",data:t,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}})]).then(function(e){var t=e[0].data,n={msg:"",done:!1};return t.success?(a.removeItem("customizedMenus"),R.whoAmI().then(function(){return a.setItem("loginSuccess","1"),n.done=!0,n})):(n.msg=t.message,n)})}function h(e,o){if(e&&!t.domainLogin[e]&&"allInOne"!==t.MW_SETTING){
var r;return t.isProduction?(r="https://",o=""):(r="http://",o=o?o:":3000"),n({method:"POST",url:r+e+(o?o:"")+i+"/autologin",data:{username:"admin",securitykey:a.getItem("securityKey")},transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(){t.domainLogin[e]=e,sessionStorage.setItem("domainLogin",JSON.stringify(t.domainLogin))})}}function v(){if(!t.autoLoginAll){var n="category eq SECURITY_DEVICE";!function(){var o={$filter:n};return u.getAll(o,a.getItem("topologyId")).then(function(n){var o=n.map(function(e){for(var t=0;t<e.devicePorts.length;t++)e.devicePorts[t].isMgmtPort&&(e.mgmtIp=e.devicePorts[t].portIp);return h(e.mgmtIp)});return o.length?e.all(o).then(function(){t.autoLoginAll=!0}):[]})}()}}function y(e){return n({method:"POST",url:i+"/users/unlock",data:e,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}})}function I(){return n.post(i+"/logout").then(function(e){e.data&&R.clear()})}function D(o){return o&&t.secretKey?e(function(e){e(t.secretKey)}):U?e(function(e){c(function(){e(D(!0))},200)}):(U=!0,n.get(i+"/users/getSecretKey").then(function(e){return U=!1,a.setItem("secretKey",e.data),t.secretKey=e.data,e}))}function T(){return n.get(i+"/users/getImage").then(function(e){return e})}function b(){return e.all([n.get(i+"/users/whoami"),n.get("js/conf.json"),n.get("js/logo.json")]).then(function(n){return t.isRootUser=!1,"root"===n[0].data.user.name&&"0"===n[0].data.user._roles[0].roleId&&(t.isRootUser=!0),P(),p.getUI().then(function(){M=n[0].data.user,l.set("privilege",n[0].data.targetAndActionValueFormList),l.set("Role",n[0].data.user._roles),l.set("userType",n[0].data.user._type),t.config=n[1].data,t.logo=n[2].data,t.menuslist=S(t.config.dashboard),f.init(M._type);var o=[];return e.all(o).then(function(){return t.$broadcast("username",M),d.userToken(),!0}),e.all([o]).then(function(){return t.$broadcast("username",M),d.userToken(),!0})})},function(e){401===e.status&&P(),400===e.status&&I()})}function S(e){for(var t=[],n=0;n<e.length;n++){var o=e[n],a={target:o.target,icon:o.icon};if(t.push(a),void 0!==o.children&&null!==o.children)for(var r=0;r<o.children.length;r++){var i=o.children[r],l={target:i.target,icon:i.icon};if(t.push(l),void 0!==i.children&&null!==i.children)for(var s=0;s<i.children.length;s++){var c=i.children[s],d={target:c.target,icon:c.icon};t.push(d)}}}return t}function P(){t.MW_SETTING="normal";var e,n="工业防火墙",o="工业防火墙",a="/images/product-logo.1f73c5be.png",r="/images/logo/logo2.5092196e.png",i="/images/logo/logo-capstone.b662af23.png";e="工业防火墙",t.LOGIN_LOGO=a,t.HEADER_LOGO=r,t.VERSION_LOGO=i,t.PLATFORM_NAME=e,t.PLATFORM_SHORT_NAME=o,t.certification={name:"匡恩网络工业防火墙系统",version:"V3.0",type:"KEV-U1008E"},t.VERSION_NUMBER="",$.getJSON("/api/v2.0/systemsetting/configuration/item/buildVersion").then(function(e){t.VERSION_NUMBER=e}),m.getSerialNumber().then(function(e){e&&e.data&&e.data.serialNumber&&(t.serialNumber=e.data.serialNumber)});var l=document.getElementById("tabTitle");l&&(l.innerHTML=n)}function A(e){return l.get("privilege").filter(function(t){return t.name===e})[0].actionValue}function C(){return M.name}function k(){return M._type}function w(){return M._roles}function E(n){function o(n){return void 0!==n&&0===n?e.reject():e(function(e){t.rootMenu?e(t.rootMenu):c(function(){e(o(--n))},20)})}function a(t){return t&&""!==t&&"auth"!==t?o(200).then(function(e){return r(e,t)}):e.resolve(!0)}function r(e,t){if(e){if(e.state===t)return!0;if(e.child&&e.child.length>0&&0===t.indexOf(e.state))return e.child.some(function(e){return r(e,t)})}return!1}return a(n)}function N(){M={name:""},t.autoLoginAll=!1,t.domainLogin={},r.dismissAll(),o.is("auth")||o.transitionTo("auth"),a.removeItem("loginSuccess"),a.removeItem("secretKey")}t.domainLogin=sessionStorage.getItem("domainLogin")?JSON.parse(sessionStorage.getItem("domainLogin")):{};var M={name:""},R={login:g,autoLogin:h,autoLoginAll:v,unlockUser:y,logout:I,whoAmI:b,getLevel:A,getUserName:C,getUserType:k,getUserRole:w,getVerifyCodeImage:T,getSecretKey:D,validateState:E,clear:N};return R;var U}e.$inject=["$q","$rootScope","$http","$state","localStorage","$modalStack","URI","Enum","topologyId","$timeout","SystemUser","Device","uiCtrl","uiTree","System"],angular.module("southWest.services").factory("auth",e)}(),function(){"use strict";function e(e,t,n,o){function a(){return n.get(o+"/systemsetting/basic")}function r(e,t){var a={ntpIp:e,activateNtp:t};return n.post(o+"/systemsetting/ntp",a).then(function(e){return e.data})}function i(e){var t={systemTime:e,activateNtp:!1};return n.post(o+"/systemsetting/systemtime",t).then(function(e){return e.data})}function l(e){return n.post(o+"/systemsetting/workingmodesetting",e).then(function(e){return e.data})}function s(e){return n.post(o+"/systemsetting/syslog",e)}function c(){return n.get(o+"/systemsetting/mwnetwork")}function d(e,t,a,r,i,l){var s={mwIp:t,netMask:a,gateWay:r,mwHostname:e,preferDns:i,spareDns:l};return n.post(o+"/systemsetting/mwip",s).then(function(e){return e.data})}function u(e){return n.post(o+"/systemsetting/security/remoteprotocol",e)}function p(e){return n.get(o+"/systemsetting/security/portstate/"+e)}function f(){return n.get(o+"/systemsetting/originalgateway")}function m(){return n.post(o+"/systemsetting/nginx")}var g={getBasicSetting:a,updateNtpSync:r,setSystemTime:i,setWorkingModeSetting:l,updateSyslog:s,getMWNetwork:c,updateIPAddress:d,updateRemoteProtocol:u,protocolPortOccupied:p,getFactoryGateway:f,restartNginx:m};return g}e.$inject=["$resource","$rootScope","$http","URI"],angular.module("southWest.models").factory("Basic",e)}(),function(){"use strict";function e(e,t,n,o,a,r){function i(e){return t.get(r.getUrl(a.currentIp)+f+"prompt",{params:e})}function l(e,n,a,r,i){var l=f+"policy/"+e+"/policytype/"+i+"/blocks";return n&&(l=l+"?lockstatus="+n),a&&(l=l+"&type="+a),t.get(l,{params:o(r)}).then(function(e){return e.data})}function s(e,n,a,r,i){var l=f+"policy/"+e+"/policytype/"+i+"/blocks/count";return n&&(l=l+"?lockstatus="+n),a&&(l=l+"&type="+a),t.get(l,{params:o(r)}).then(function(e){return e.data})}function c(e,n,o){return t.post(f+"policy/"+e+"/policytype/"+o+"/block",n)}function d(e,n){return t.post(r.getUrl(a.currentIp)+f+"block/"+e+"/rule",n)}function u(e){return t.put(r.getUrl(a.currentIp)+f+"rules/delete",e)}function p(e,n){return t.put(r.getUrl(a.currentIp)+f+"block/"+e+"/rules/priority",n)}var f=n+"/policies/",m={getData:i,getAll:l,getCount:s,createPolicyBlock:c,createRule:d,deleteRule:u,changePriority:p};return m}e.$inject=["$q","$http","URI","encodeURL","$rootScope","UCD"],angular.module("southWest.models").factory("Custom",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i){function l(){return e.get(a.getUrl(t.currentIp)+T+"policy/type/POLICY_DEPLOYED_RULE_COUNT")}function s(){return e.get(a.getUrl(t.currentIp)+T+"policy/type/POLICY_DEPLOYED_SIGNATURE_COUNT")}function c(){return i.resolve(22)}function d(e){var t=new Date(e+" UTC").getTime();return isNaN(t)?"N/A":t}function u(){return e.get(T+"policy/type/POLICY_WHITELIST_UPDATED").then(function(e){return d(e.data.statsString)})}function p(){return e.get(T+"policy/type/POLICY_SIGNATURE_UPDATED").then(function(e){return d(e.data.statsString)})}function f(){return e.get(a.getUrl(t.currentIp)+T+"incident/topology/"+a.getDomain(t.currentIp,o.id).topoId+"/peakhour").then(function(e){return e.data})}function m(){return e.get(T).then(function(){},function(e){return e})}function g(t){return e.put(T+"topology/"+o.id+"/dashboard",t)}function h(t){return e.get(n+"/todolists/topology/"+o.id,{params:r(t)}).then(function(e){return e.data})}function v(t,a){return e.put(n+"/todolists/topology/"+o.id+"/todolist/"+t+"/status",a).then(function(e){return e.data})}function y(t){return e({method:t.operationMethod,url:n+t.operationApi,data:t.operationContent,headers:{"Content-Type":"application/json"}}).then(function(e){return e.data},function(e){return e.data})}function I(){return e.get(T+"policy/type/POLICY_DEPLOYED_IP_RULE_COUNT")}function D(){return e.get(T+"policy/type/POLICY_IP_RULE_UPDATED").then(function(e){return d(e.data.statsString)})}var T=n+"/dashboards/",b={getRuleDeployedCount:l,getSignatureDeployedCount:s,getStrategyDeployCount:c,getWhiteListPolicyUpdateTime:u,getBlackListPolicyUpdateTime:p,getPeakHour:f,getHeartBeat:m,updateDashboard:g,getTodoList:h,updateTodoList:v,doTodoItem:y,getIPRuleDeployedCount:I,getIPRulePolicyUpdateTime:D};return b}e.$inject=["$http","$rootScope","URI","topologyId","UCD","encodeURL","$q"],angular.module("southWest.models").service("Dashboard",e)}(),function(){"use strict";function e(e,t,n,o,a){function r(t){return e.get(n+"/intrusiondetection/topology/"+t).then(function(e){return e.data})}function i(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/"+o).then(function(e){return e.data})}function l(t,o,a){return e.get(n+"/intrusiondetection/topology/"+t+"/"+o+"/"+a+"/patternmatching").then(function(e){return e.data})}function s(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/intrusionincidents",{params:a(o)}).then(function(e){return e.data})}function c(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/intrusionincidents/count",{params:a(o)}).then(function(e){return e.data})}function d(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/"+o+"/flowdatastats").then(function(e){return e.data})}function u(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/"+o+"/incidentstats").then(function(e){return e.data})}function p(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/intrusionincidents/"+o).then(function(e){return e.data})}function f(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/"+o+"/patterns").then(function(e){return e.data})}function m(e,t,n){n||(n="");var a={options:{plotOptions:{area:{lineColor:"#76B900",fillOpacity:.7}},chart:{borderColor:"#000000",borderWidth:1,backgroundColor:"#323232",events:{load:function(){t.chart=this}}},yAxis:{opposite:!1,gridLineColor:"#000000",gridLineWidth:1,alternateGridColor:"transparent"},xAxis:{ordinal:!1,gridLineColor:"#000000",gridLineWidth:1,alternateGridColor:"transparent"},tooltip:{formatter:function(){return!(!this.series||"Series 2"!==this.series.name)&&"事件发生时间："+o("date")(this.x,"yyyy-MM-dd HH:mm:ss")}},rangeSelector:{enabled:!0,selected:3,inputEnabled:!1,buttonTheme:{fill:"none",stroke:"none","stroke-width":0,r:8,style:{color:"white",fontWeight:"bold"},states:{hover:{},select:{fill:"gray",style:{color:"white"}}}},buttons:[{type:"second",count:30,text:"30秒"},{type:"minute",count:1,text:"1分"},{type:"minute",count:5,text:"5分"},{type:"all",text:"全部"}]},navigator:{enabled:!0}},series:[{name:"事件数量",id:"dataseries",type:"area",color:"#4D681E"},{type:"flags",id:"incidentseries",name:"Incidents",onSeries:"dataseries",title:" ",shape:"circlepin",y:-5,stackDistance:15,enableMouseTracking:!0,width:5,height:5,useHTML:!0}],title:{align:"left",text:"online"===e?"当前数据检测":"离线数据检测",useHTML:!0,style:{color:"#888888"}},subtitle:{align:"right",text:"online"===e?"实时检测开始时间："+n:"",useHTML:!0,style:{color:"#cccccc"}},useHighStocks:!0,loading:!1};return a}function g(t,o){var a=new FormData;return a.append("file",o),e({url:n+"/files/topology/"+t+"/pcapupload",method:"POST",data:a,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}function h(e){var t={options:{rangeSelector:{enabled:!0,selected:1},navigator:{enabled:!0}},series:[{name:"AAPL Stock Price",data:e,turboThreshold:1,type:"area",threshold:null,tooltip:{valueDecimals:2},fillColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,Highcharts.getOptions().colors[0]],[1,Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get("rgba")]]}}],title:{text:"AAPL Stock Price"},useHighStocks:!0,loading:!1};return t}function v(t,o){return e.post(n+"/intrusiondetection/topology/"+t,o).then(function(e){return e.data})}function y(t,o){return e.put(n+"/intrusiondetection/topology/"+t,o).then(function(e){return e.data})}function I(){return e.get(n+"/vulnerabilities/count").then(function(e){return e.data})}function D(t,o){return e.delete(n+"/files/topology/"+t+"/"+o+"/pcapdeletion").then(function(e){return e.data})}function T(t,o){return e.get(n+"/intrusiondetection/topology/"+t+"/"+o+"/initialstate").then(function(e){return e.data})}function b(t,o,a){return e.post(n+"/intrusiondetection/topology/"+t+"/"+o+"/lowlevelactor",a).then(function(e){return e.data})}var S={getId:r,getStartTime:i,graph:h,graph2:m,getPatternDetail:l,getPatternTable:s,upload:g,getFlowdata:d,getIncidentdata:u,getPatternTableCount:c,getIncidentDetail:p,getPattern:f,startAnalyze:v,stopAnalyze:y,getVulnerabilityCount:I,deletePcap:D,initialstate:T,lowlevelactor:b};return S}e.$inject=["$http","$q","URI","$filter","encodeURL"],angular.module("southWest.models").factory("Detect",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l){function s(){return t.get($e+o.id+"/devicegroup")}function c(e){return t.post($e+o.id+"/devicegroup",e)}function d(e,n){return t.put($e+o.id+"/devicegroup/"+e,n)}function u(e){return t.post($e+o.id,e).then(function(e){return e.data})}function p(e){return t.post($e+o.id+"/models",e).then(function(e){return e.data})}function f(e){return t.post(n+"/topologies/"+o.id+"/nodes",e).then(function(e){return e.data})}function m(e){return t.put(n+"/topologies/node/"+e.id,e)}function g(e,n,a){return t.get(r.getUrl(a)+$e+(n||o.id)+"/"+e).then(function(e){return e.data})}function h(e,n,l){return n||o.id?t.get(r.getUrl(l)+$e+(n||o.id),{params:a(e)}).then(function(e){return e.data}):i.getDomain().then(function(n){return o.id=n[0].domainInfo.currentTopologyId,t.get($e+o.id,{params:a(e)}).then(function(e){return e.data})})}function v(e,n,o){var i=r.getUrl(o)+$e+r.getDomain(o,n).topoId+"/count";return t.get(i,{params:a(e)}).then(function(e){return e.data})}function y(e){return t.get($e+(o.id?o.id:"0")+"/models",{params:a(e)}).then(function(e){return e.data})}function I(e){return t.get(n+"/devices/newdiscovered",{params:a(e)}).then(function(e){return e.data})}function D(e,n){return t.get($e+o.id+"/deviceip/"+n).then(function(e){return e.data},function(){return{name:"未知",iconType:"unknown-device"}})}function T(e,n){return t.get($e+o.id+"/devicemac/"+n).then(function(e){return e.data},function(){return{name:"未知",iconType:"unknown-device"}})}function b(e,o,i){return t.get(r.getUrl(i)+n+e,{params:a(o)}).then(function(e){return e.data})}function S(e,o,i){return t.get(r.getUrl(i)+n+e+"/count",{params:a(o)}).then(function(e){return e.data})}function P(){return t.get(n+"/topologies/"+o.id+"/ipsidscount").then(function(e){return e.data})}function A(o,a){var i=o.map(function(e,i){return t.get(r.getUrl(a)+n+"/policies/topology/"+e.topologyId+"/nodes/"+e.id+"/rulesignaturecount").then(function(e){o[i].rules=e.data})});return e.all(i).then(function(){return o})}function C(){return t.get(n+"/devices/newdiscovered")}function k(e,a){return t.put(n+"/devices/topology/"+o.id+"/device/"+e+"/defaultgateway",{defaultGateway:a}).then(function(e){return e.data})}function w(e,a){return t.post(n+"/devices/topology/"+o.id+"/device/"+e+"/remoteroutings",a).then(function(e){return e.data})}function E(e,a){return t.put(n+"/devices/topology/"+o.id+"/device/"+e+"/remoteroutings/delete",a).then(function(e){return e.data})}function N(e,a){return t.put(n+"/devices/topology/"+o.id+"/device/"+e+"/remoteroutings",a).then(function(e){return e.data})}function M(e,a){return t.put(n+"/devices/topology/"+o.id+"/device/"+e+"/coverremoteroutings",a).then(function(e){return e.data})}function R(e,o,a){return t.get(r.getUrl(a)+n+"/devices/topology/"+e+"/"+o+"/systemstat")}function U(e){return t.get(n+"/devices/device/"+e+"/acls?$orderby=_aclNumber").then(function(e){return e.data})}function _(){return t.get(n+"/devices/model/protocolCategory").then(function(e){return e.data})}function x(e,o){return t({url:n+"/devices/device/"+e+"/acl/delete",data:o,method:"PUT",headers:{"Content-Type":"application/json"}})}function O(e,o){return t({url:n+"/devices/device/"+e+"/acl",data:o,method:"POST",headers:{"Content-Type":"application/json"}})}function L(e){return t({url:n+"/devices/topology/"+o.id+"/device/"+e.deviceId+"/acl",data:e,method:"PUT",headers:{"Content-Type":"application/json"}})}function B(e,t){var n={options:{credits:{enabled:!1},plotOptions:{area:{lineColor:"#76B900",allowPointSelect:!1,fillOpacity:.7},line:{animation:!1,allowPointSelect:!1,lineColor:"#009bd0",lineWidth:2},series:{marker:{enabled:!1}}},chart:{borderColor:"#000000",borderWidth:0,plotBorderWidth:1,plotBackgroundColor:"#363636",backgroundColor:"#1f1f1f",plotBorderColor:"#000000",plotShadow:!0,events:{load:function(){t(this)}}},tooltip:{enabled:!1},legend:{enabled:!1},xAxis:{labels:{enabled:!1},showEmpty:!0,units:null,lineWidth:0,tickWidth:0},yAxis:{title:null,gridLineWidth:0,min:0,max:1,plotLines:[{value:0,width:1,color:"black"},{value:.25,width:.5,color:"black"},{value:.5,width:.5,color:"black"},{value:.75,width:.5,color:"black"},{value:1,width:1,color:"black"}],labels:{formatter:function(){return 100*this.value+"%"}}}},title:{text:""},size:{width:269,height:200},series:e.data,chart:{type:"scatter"},useHighStocks:!1,loading:!1};return n}function V(e,t,n){var o={chart:{type:"area",spacingBottom:30},options:{chart:{plotBackgroundColor:"#1f1f1f",plotBorderWidth:null,plotShadow:!1,margin:[0,0,0,0],events:{load:function(){n(this)}}},credits:{enabled:!1},tooltip:{enabled:!1},plotOptions:{pie:{shadow:!1,center:["50%","50%"]},series:{animation:!1}},legend:{enabled:!0,itemDistance:40,symbolWidth:9,symbolHeight:9,symbolPadding:5,itemStyle:{color:"#CCCCCC",fontSize:"13px"},itemHoverStyle:{color:"#CCCCCC"}}},series:[{ignoreHiddenPoint:!0,type:"pie",name:"Browser share",data:e,allowPointSelect:!1,cursor:"pointer",innerSize:170,minSize:150,showInLegend:!1,size:130,borderWidth:0,dataLabels:{enabled:!0,distance:30,useHTML:!0,format:'<b style="color: {point.color}; font-size: 12px;">{point.y}%</b>',style:{color:"#CCCCCC"}},states:{hover:{enabled:!1}}},{ignoreHiddenPoint:!0,type:"pie",name:"Browser share",data:[{y:100,color:"#9e9e9e"}],allowPointSelect:!1,cursor:"pointer",innerSize:105,minSize:100,showInLegend:!1,size:118,borderWidth:0,dataLabels:{enabled:!1},states:{hover:{enabled:!1}}},{name:"score",allowOverlap:!0,allowPointSelect:!1,type:"pie",data:[{color:"#1f1f1f",y:t}],size:80,borderWidth:0,states:{hover:{enabled:!1}},dataLabels:{softConnector:!1,useHTML:!0,format:'<br><b style="font-size: 35px; line-height: 25px;">{point.y}</b><br style="line-height: 13px;"><b style="margin-left:30px;">GB</b>',color:"#CCCCCC",distance:-60}}],title:{text:null},loading:!1,size:{width:269,height:200}};return o}function j(e){return t.put(n+"/devices/topology/"+o.id+"/device/"+e.deviceId+"/routing",e).then(function(e){return e.data})}function W(e){return t.get($e+o.id+"/device/"+e+"/notconnectedport").then(function(e){return e.data})}function F(e,n,a){return t.put($e+o.id+"/device/"+e+"/portroutingconfig",{notConnectedPortMap:n,devicePorts:a}).then(function(e){return e.data})}function H(e,o){return t.put(n+"/devices/"+e+"/deviceports",o).then(function(e){return e.data})}function G(e,n,o){return t({method:"PUT",url:$e+e+"/device/"+n+"/ipsubnet",data:$.param(o),headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.data},function(e){return e.data})}function z(e,n,o,a,r){return r=r?r:"ipandmac",t.put($e+e+"/device/"+n+"/ipmac/"+r,o).then(function(e){return e.data})}function q(e,n){return t.put($e+o.id+"/"+e,n).then(function(e){return e.data})}function Y(e,o){return t.put(n+"/topologies/node/"+e+"/nodeProtocols",o).then(function(e){return e.data})}function K(e,n){return t.put($e+o.id+"/assigndevice/"+e,n).then(function(e){return e.data})}function J(e,a){return t.put(n+"/topologies/"+o.id+"/device/"+e+"/configdevice",a).then(function(e){return e.data})}function Z(e,n,a){return t.get(r.getUrl(a)+$e+r.getDomain(a,o.id).topoId+"/"+e+"/search/"+n).then(function(e){return e.data})}function Q(e,o,a){return t.get(r.getUrl(a)+n+"/policies/topology/"+e+"/device/"+o+"/items/count?type=RULE").then(function(e){return e.data})}function X(e,o){return t.get(n+"/policies/topology/"+e+"/device/"+o+"/domains/count").then(function(e){return e.data})}function ee(e,o,a){return t.get(r.getUrl(a)+n+"/policies/topology/"+e+"/device/"+o+"/items/count?type=SIGNATURE").then(function(e){return e.data})}function te(e,t){var n=e?e.toLowerCase():"unknown-device";return"cnc"!==n&&"cloud"!==n&&"unknown-device"!==n&&"deltav"!==n&&"hmi"!==n&&"opc_client"!==n&&"opc_server"!==n&&"plc"!==n&&"router"!==n&&"switch"!==n&&"workstation"!==n&&"subnet"!==n&&"kea-u1000"!==n&&"kea-u1142"!==n&&"kea-u1000e"!==n&&"kea-u2000"!==n&&"kea-c200"!==n&&"kea-c400"!==n&&"ked-c400"!==n&&"kev-c200"!==n&&"kev-c400"!==n&&"kec-u1000"!==n&&(n="unknown-device"),"unknown-device"===n&&t&&(t=t.substring(t.lastIndexOf(" ")+1),n=t.toLowerCase(),["kea-c200","kea-c400","ked-c400","kev-c200","kev-c400","kea-u1000","kea-u1142","kea-u1000e","kea-u2000","kec-u1000"].indexOf(n)===-1&&(n="unknown-device")),n}function ne(e){var t="images/devices/security/",n="kea-c200",o=e?l("deviceModel")(e).toLowerCase():"";return o=o.indexOf(" / ")>0?o.split(" / ")[1].toLowerCase():o,["kea-c200","kea-c400","ked-c400","kev-c200","kev-c400","kea-u1000","kea-u1142","kea-u1000e","kea-u2000","kec-u1000","kev-u800"].indexOf(o)>-1&&(n=o),t+n+"-icon.png"}function oe(e,t){if(!t)return!1;var n={};return n.$filter="serialNumber eq '"+t+(e?"' and deviceId ne '"+e+"'":"'"),v(n).then(function(e){return 1===e},function(){return!0})}function ae(e,t,n){return!!t&&D(o.id,t).then(function(t){return t&&t.deviceId&&t.deviceId!==e&&(!!n||"subnet"!==t.iconType)},function(){return!0})}function re(e,o){return t.post(r.getUrl(o)+n+"/devices/ipmac/set",e)}function ie(e){return t.put(r.getUrl(e)+n+"/devices/ipmac/delete")}function le(e,n,i){return t.get(r.getUrl(i)+$e+r.getDomain(i,n||o.id).topoId,{params:a(e)}).then(function(e){if(e.data)for(var t=0;t<e.data.length;t++)e.data[t]._ipmacBoolean=1===e.data[t]._ipmac;return e.data})}function se(e,o){return t.put(n+"/topologies/node/"+e+"/nodeProperty",o).then(function(e){return e.data})}function ce(e){return t.get(n+"/topologies/subTopology/device/"+e).then(function(e){return e.data})}function de(e){return t.delete(n+"/devices/topology/"+o.id+"/"+e)}function ue(e){return t.get(n+"/topologies/"+o.id+"/allzones",{params:a(e)}).then(function(e){return e.data})}function pe(e){return t.post(n+"/topologies/"+o.id+"/nodeZone",e)}function fe(e){return t.put(n+"/topologies/"+o.id+"/nodeZone/"+e.nodeZoneId+"/zoneName",e)}function me(e,a){t({url:n+"/topologies/"+o.id+"/nodeZones",method:"DELETE",data:e,headers:{"Content-Type":"application/json"}}).success(function(){a()}).error(function(e){a(e.error)})}function ge(e){return t.get(n+"/topologies/"+o.id+"/nodeZone/count",{params:a(e)}).then(function(e){return e.data})}function he(e,o){return t.put(n+"/topologies/Device/"+e+"/NodeZone/"+o).then(function(e){return e.data})}function ve(e){return t.delete($e+"-1/securitydevice/"+e).then(function(e){return e.data})}function ye(e,n,o){return t({url:$e+e+"/device/"+n+"/deviceports",method:"PUT",data:o,headers:{"Content-Type":"application/json"}}).then(function(e){return e.data})}function Ie(e){return t.delete(n+"/topologies/node/"+e)}function De(e){return t.get(n+"/devices/debuginfos",{params:a(e)}).then(function(e){return e.data})}function Te(e,o){t({url:n+"/devices/dodebug",method:"POST",data:e,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e)})}function be(e){return t.get(n+"/devices/backupinfos",{params:a(e)}).then(function(e){return e.data})}function Se(e){return t.get(n+"/devices/backupinfos/count",{params:a(e)}).then(function(e){return e.data})}function Pe(e,o){t({url:n+"/devices/backup",method:"POST",data:e,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e)})}function Ae(e,o){t({url:n+"/devices/backup",method:"DELETE",data:e,headers:{"Content-Type":"application/json"}}).success(function(){o()}).error(function(e){o(e.error)})}function Ce(e){return t.get(n+"/devices/confbackupinfos",{params:a(e)}).then(function(e){return e.data})}function ke(e){return t.get(n+"/devices/confbackupinfos/count",{params:a(e)}).then(function(e){return e.data})}function we(e,o){t({url:n+"/devices/confbackup",method:"DELETE",data:e,headers:{"Content-Type":"application/json"}}).success(function(){o()}).error(function(e){o(e.error)})}function Ee(e){return t.put(n+"/devices/confrestoration",e)}function Ne(){return t.get(n+"/devices/secretkey")}var $e=n+"/devices/topology/",Me={getGroups:s,createGroups:c,updateGroups:d,createDevice:u,createModel:p,createNodes:f,updateNode:m,createIPMACBinding:re,deleteIPMACBinding:ie,get:g,getAll:h,getCount:v,getModels:y,getNewDevices:I,getDevice:D,getDeviceByMac:T,getBlocksRef:b,getBlocksRefCount:S,getIpsidsCount:P,getNodeRules:A,getNotConnectedPort:W,getDPIInfo:R,getACLInfo:U,getDeviceDiscoverred:C,getAllProtocols:_,deleteACL:x,addACL:O,deployACL:L,hasDuplicateSN:oe,hasDuplicateIP:ae,updateNotConnectedPort:F,updateDevicePort:H,updateSingleIpSubnet:G,update:q,updateMgmIpMac:z,updateNodeProtocols:Y,addToCurrentTopology:K,configDevice:J,search:Z,routing:j,pieChart:V,lineChart:B,getDeviceRuleCount:Q,getDeviceDomainRuleCount:X,getDeviceSignatureCount:ee,getIconName:te,getSecurityDeviceIconPath:ne,setDefaultGateway:k,deleteRemoteRoutings:E,addRemoteRoutings:w,updateRemoteRoutings:N,coverRemoteRoutings:M,getAllForIpMacBinding:le,updateNodeProperty:se,getSubTopo:ce,deleteOneDevice:de,getAllNodeZone:ue,addNodeZone:pe,updateZoneName:fe,deleteNodeZones:me,getNodeZoneCount:ge,updateNodeAssociation:he,removeNewDevice:ve,updateAllDevicePorts:ye,removeNodeByID:Ie,getDebuginfoCollection:De,collectDebuginfo:Te,getConfBackUpInfos:be,getConfBackUpInfoCount:Se,doConfBackUp:Pe,deleteBackUpFiles:Ae,getConfBackUpFileInfos:Ce,getConfBackUpFileInfoCount:ke,deleteConfBackUpFiles:we,restoreConfBackUpFiles:Ee,getSecretKey:Ne};return Me}e.$inject=["$q","$http","URI","topologyId","encodeURL","UCD","domain","$filter"],angular.module("southWest.models").factory("Device",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i){function l(){var n=[],o=i.getItem("domain_getDomain");return!o&&n.push(t.get(m)),e.all(n).then(function(e){return o?JSON.parse(o):(e[0].data.length>0?a.id!==e[0].data[0].domainInfo.currentTopologyId&&(a.id=e[0].data[0].domainInfo.currentTopologyId||0,r.topologyId=e[0].data[0].domainInfo.currentTopologyId||0):a.id=0,i.setItem("domain_getDomain",JSON.stringify(e[0].data)),e[0].data)})}function s(e){return t.get(m+"?$filter=(contains(domainName, '"+e+"') or contains(domainCode, '"+e+"'))").then(function(e){return e.data})}function c(e){return t.put(m,e).then(function(e){return e.data})}function d(e){return t.put(n+"/users/user/info",e).then(function(e){return e.data})}function u(e,o){return t.put(n+"/users/user/"+e+"/"+o,{}).then(function(e){return e.data})}function p(){}function f(e){var n={method:"POST",url:m+"initdomain/",headers:{"Content-Type":"application/json"},data:e};return t(n).then(function(e){return e.data})}var m=n+"/domains/",g={getDomain:l,getDomainByKeyword:s,updateDomain:c,updateUser:d,lockUser:u,deleteDomain:p,addDomain:f};return g}e.$inject=["$q","$http","URI","encodeURL","topologyId","$rootScope","localStorage"],angular.module("southWest.models").factory("domain",e)}(),function(){"use strict";function e(e,t,n,o){function a(t){return e.get(d,{params:n(t)}).then(function(e){return e.data})}function r(t){return e.get(d+"/count",{params:n(t)}).then(function(e){return e.data})}function i(){return e.put(d+"/markallread").then(function(e){return e.data})}function l(){return e.put(d+"/markalldeleted").then(function(e){return e.data})}function s(t,o){var a=o?{password:o}:null;return e({method:"POST",url:d+"/export",data:a,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:n(t)}).then(function(e){return e.data})}function c(n){if(n)return e.get(t+"/datadictionaries/source/"+n).then(function(e){return e.data});var a=o.defer();return a.resolve([]),a.promise}var d=t+"/events",u={getAll:a,getCount:r,markAllRead:i,markAllDeleted:l,getAllExport:s,search:c};return u}e.$inject=["$http","URI","encodeURL","$q"],angular.module("southWest.models").factory("Event",e)}(),function(){"use strict";function e(e,t,n){function o(){return e.get(A+"/unreadCount/incident").then(function(e){return e.data})}function a(){return e.get(A+"/unreadCount/strategy").then(function(e){return e.data})}function r(){var t=(new Date).getTimezoneOffset()/60*-1;return e.get(A+"/todayIncidentCount/"+t).then(function(e){return e.data})}function i(){var t=(new Date).getTimezoneOffset()/60*-1;return e.get(A+"/historyIncidentCount/"+t).then(function(e){return e.data})}function l(){var t=(new Date).getTimezoneOffset()/60*-1;return e.get(A+"/peakHour/"+t).then(function(e){return e.data})}function s(){return e.get(A+"/errorIncidentCount").then(function(e){return e.data})}function c(t){return e.get(A+"/incidents",{params:n(t)}).then(function(e){return e.data})}function d(t){return e.get(A+"/count/incident",{params:n(t)}).then(function(e){return e.data})}function u(t){return e.get(A+"/updateIncidentStatus/"+t).then(function(e){return e.data})}function p(t){return e.put(A+"/markallread/"+t).then(function(e){return e.data})}function f(t){return e.put(A+"/deleteAll/"+t).then(function(e){return e.data})}function m(t){return e.get(A+"/"+t).then(function(e){return e.data})}function g(){return e.get(A+"/starttime").then(function(e){return e.data})}function h(t,n,o,a,r,i){return e.get(A+"/report/type/"+t+"/srcIp/"+n+"/dstIp/"+o+"/start/"+a+"/end/"+r+"/schedule/"+i,{timeout:3e5}).then(function(e){return e.data})}function v(t,n){return e.get(A+"/ipdevices/start/"+t+"/end/"+n).then(function(e){return e.data})}function y(n){return e.get(t+"/jobscheduler/jobbuilder/category/"+n).then(function(e){return e.data})}function I(n){return e.put(t+"/jobscheduler/jobbuilder",n).then(function(e){return e.data})}function D(t,o){var a=o?{password:o,clienttime:(new Date).getTimezoneOffset()/60}:{clienttime:(new Date).getTimezoneOffset()/60};return e({method:"POST",url:A+"/export",data:a,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:n(t)}).then(function(e){return e.data})}function T(t,n,o,a){return e.get(A+"/report/type/"+t+"/ip/"+n+"/start/"+o+"/end/"+a+"/",{timeout:3e5}).then(function(e){return e.data})}function b(o){var a="";o&&(a=a+"ipAddress eq '"+o+"'");var r={$filter:a};return e.get(t+"/objects/asset/ipmac/set",{params:n(r)}).then(function(e){return e.data})}function S(t,n,o,a,r,i,l){var s={image:t,image2:n};return e({method:"POST",url:A+"/export/Image/srcIp/"+o+"/dstIp/"+a+"/start/"+r+"/end/"+i+"/type/"+l,data:s,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.data})}function P(n){return e.get(t+"/incidents/timeLine/startTime/"+n.start+"/endTime/"+n.end).then(function(e){return e.data})}var A=t+"/incidents",C={getUnreadIncidentCount:o,getUnreadStrategyCount:a,getTodayIncidentCount:r,getHistoryIncidentCount:i,getPeakHour:l,getErrorCount:s,getIncidents:c,getIncidentCount:d,updateIncidentStatus:u,markAllRead:p,deletedAll:f,getAllExport:D,getIncidentById:m,getStartTime:g,
getReport:h,getIpDevices:v,getScheduleSetting:y,setScheduleSetting:I,getReportIp:T,getAsset:b,getOutPutReport:S,getTimelineIncidents:P};return C}e.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("Incident",e)}(),function(){"use strict";function e(e,t,n,o,a,r){return function(i){function l(t){return e.get(D+t).then(function(e){return e.data})}function s(t){return e.get(D,{params:n(t)}).then(function(e){return e.data})}function c(t,r){return r&&"incidents"===i?e.get(o.getUrl(a.currentIp)+D+"/incidentcount",{params:n(t)}).then(function(e){return e.data}):e.get(o.getUrl(a.currentIp)+D+"/count",{params:n(t)}).then(function(e){return e.data})}function d(t,n){return e.get(D+"/devices/"+t+"/"+n).then(function(e){return e.data})}function u(t){return e.put(D+"/"+t).then(function(e){return e.data})}function p(){return e.put(D+"/markallread").then(function(e){return e.data})}function f(){return e.put(D+"/markalldeleted").then(function(e){return e.data})}function m(t,o){var a=o?{password:o}:null;return e({method:"POST",url:D+"/export",data:a,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:n(t)}).then(function(e){return e.data})}function g(n){return e.get(t+"/jobscheduler/jobbuilder/category/"+n).then(function(e){return e.data})}function h(n){return e.put(t+"/jobscheduler/jobbuilder",n).then(function(e){return e.data})}function v(t,o,a,r,l,s){return e.get(D+"/points/level/"+t+("incidents"===i?"/risklevel/"+o:"")+"/frequency/"+a+"/starttime/"+r.toISOString()+"/endtime/"+l.toISOString(),{params:n(s)}).then(function(e){return e.data})}function y(n){if(n)return e.get(t+"/datadictionaries/source/"+n).then(function(e){return e.data});var o=r.defer();return o.resolve([]),o.promise}function I(o,a,r,i,l){return e.get(t+"/policies/devicesignaturecounts/"+o+"/starttime/"+a.toISOString()+"/endtime/"+r.toISOString()+"/level/"+i,{params:n(l)}).then(function(e){return e.data},function(){return[{signatureName:"test1",signatureCount:2},{signatureName:"test2",signatureCount:12},{signatureName:"test3",signatureCount:12},{signatureName:"test4",signatureCount:12},{signatureName:"test5",signatureCount:12},{signatureName:"test6",signatureCount:12},{signatureName:"test7",signatureCount:12},{signatureName:"test8",signatureCount:12},{signatureName:"CONTROL_MICROSYSTEMS_(Event_40)_TCP_UDP_Port_Change_Attempt",signatureCount:15},{signatureName:"TROJAN_Win32/Wecorl.gen!A_Download",signatureCount:26},{signatureName:"NETBIOS_SMB_llsrconnect_overflow_attempt",signatureCount:19},{signatureName:"test1",signatureCount:12}]})}var D=t+"/"+i,T={get:l,getAll:s,getCount:c,getIncidentsByDevice:d,update:u,markAllRead:p,markAllDeleted:f,getAllExport:m,getScheduleSetting:g,setScheduleSetting:h,getGrouped:v,getRuleCountOnDevice:I,search:y};return T}}e.$inject=["$http","URI","encodeURL","UCD","$rootScope","$q"],angular.module("southWest.models").service("_IncidentEventAPI",e)}(),function(){"use strict";function e(e,t,n){function o(){return e.get(n+"/structuresafeties/newid/").then(function(e){return e.data})}function a(t,o){return e.get(n+"/structuresafeties/topology/"+t.id+"/structuresafety/"+o+"/nodes").then(function(e){return e.data})}function r(t,o){return e.get(n+"/structuresafeties/topology/"+t.id+"/structuresafety/"+o+"/nodes").then(function(e){return e.data})}function i(){return t.when(c)}function l(t,o,a){return e.post(n+"/structuresafeties/topology/"+t.id+"/structuresafety/"+o+"/calculatesafety",a).then(function(e){return e.data})}function s(e,t,n){var o={options:{chart:{plotBackgroundColor:"#212121",plotBorderWidth:null,plotShadow:!1,margin:[0,0,0,0]},tooltip:{enabled:!1},plotOptions:{pie:{shadow:!1,center:["50%","50%"]}},legend:{enabled:!0,itemDistance:40,symbolWidth:9,symbolHeight:9,symbolPadding:5,itemStyle:{color:"#CCCCCC",fontSize:"13px"},itemHoverStyle:{color:"#CCCCCC"}}},series:[{ignoreHiddenPoint:!0,type:"pie",name:"Browser share",data:e,allowPointSelect:!1,cursor:"pointer",innerSize:80,minSize:100,showInLegend:!0,size:130,borderWidth:0,point:{events:{legendItemClick:function(){return!1},click:function(){}}},dataLabels:{enabled:!0,distance:10,useHTML:!0,format:'<b style="color : {point.color}; font-size: 12px;">{point.y}</b><b style="font-size: 12px;"> 条路径</b>',style:{color:"#CCCCCC"}}},{name:"score",allowOverlap:!0,allowPointSelect:!1,type:"pie",data:[{color:"#4C4D4C",y:n}],size:80,borderWidth:0,states:{hover:{enabled:!1}},dataLabels:{softConnector:!1,useHTML:!0,format:'<br><b style="font-size: 35px; line-height: 25px;">{point.y}</b><br style="line-height: 13px;"><b style="margin-left:30px;">总分</b>',color:"#CCCCCC",distance:-60}}],title:{text:null},loading:!1,size:{width:269,height:270}};return o}var c=[{id:"vimp",method:"显示最短攻击路径",memo:"计算结果只针对最短路径"}],d={getId:o,source:a,target:r,analyze:i,calculate:l,pieChart:s};return d}e.$inject=["$http","$q","URI"],angular.module("southWest.models").factory("infSafety",e)}(),function(){"use strict";function e(e,t,n,o,a){function r(t){return e.get(a.getUrl(o.currentIp)+y+"/learning/"+t)}function i(t){return e.get(y+"/policies/task/"+t+"/learnedipmac")}function l(t){return e.put(y+"/policies/learnedipmac",t)}function s(t,n){return e.post(a.getUrl(n||o.currentIp)+y+"/learning/createLearningTask/",t)}function c(t){return e.post(y+"/learning/all",t)}function d(t){return e.get(a.getUrl(t||o.currentIp)+y+"/learning/getLearningTasksByfilter?$filter=state ne REJECTED&$orderby=startDatetime desc")}function u(t,n){return e.put(a.getUrl(o.currentIp)+y+"/learning/"+t,n)}function p(t){return e.delete(a.getUrl(o.currentIp)+y+"/learning/"+t)}function f(t){return e.put(a.getUrl(o.currentIp)+y+"/learning/"+t+"/pause")}function m(t){return e.put(a.getUrl(o.currentIp)+y+"/learning/"+t+"/resume")}function g(t){return e.put(a.getUrl(o.currentIp)+y+"/learning/"+t+"/stop")}function h(t){return e.get(a.getUrl(o.currentIp)+y+"/policies/"+t+"/blocks?type=LEARN&&lockstatus=NODEPLOY")}function v(t){return e.get(a.getUrl(o.currentIp)+y+t)}var y=t,I={getTask:r,getTaskMac:i,setTaskMac:l,createLearningTask:s,createLearningTaskAll:c,getLearningTasks:d,updateLearningTask:u,removeLearningTask:p,pause:f,resume:m,stop:g,getLearningBlocksByPolicyId:h,getLearningBlocksByRef:v};return I}e.$inject=["$http","URI","topologyId","$rootScope","UCD"],angular.module("southWest.models").factory("Learning",e)}(),function(){"use strict";function e(e,t,n){function o(t,n){return e.get(E+"/operationlog/"+t+"/type/"+n).then(function(e){return e.data})}function a(t){return e.get(E+"/all",{params:n(t)}).then(function(e){return e.data})}function r(t,o,a){var r=o?{password:o}:null;return void 0!==a&&null!==a&&(r=angular.extend(r?r:{},{type:a})),e({method:"POST",url:E+"/all/export",data:r,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:n(t)}).then(function(e){return e.data})}function i(t){return e.get(E+"/all/count",{params:n(t)}).then(function(e){return e.data})}function l(t,o){return e.get(E+"/type/"+o,{params:n(t)}).then(function(e){return e.data})}function s(t,o,a){var r=a?{password:a}:null;return e({method:"POST",url:E+"/type/"+o+"/export",data:r,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"},params:n(t)}).then(function(e){return e.data})}function c(t,o){return e.get(E+"/type/"+o+"/count",{params:n(t)}).then(function(e){return e.data})}function d(t){return e.post("/api/v2.0/logger/createlog",{data:t})}function u(){return e.get("/api/v2.0/logger/mocklogs")}function p(n){return e.get(t+"/jobscheduler/jobbuilder/category/"+n).then(function(e){return e.data})}function f(n){return e.put(t+"/jobscheduler/jobbuilder",n).then(function(e){return e.data})}function m(){return e.get(E+"/starttime").then(function(e){return e.data})}function g(t,n,o){return e.get(E+"/report/start/"+t+"/end/"+n+"/schedule/"+o,{timeout:3e5}).then(function(e){return e.data})}function h(t,n,o,a,r){var i={image:t,image2:n};return e({method:"POST",url:E+"/export/Image/start/"+o+"/end/"+a+"/type/"+r,data:i,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.data})}function v(t){return e.post(E+"/deleteDpiUserCmdLog",t)}function y(t){return e.post(E+"/deleteFwFlowdata",t)}function I(t){return e.post(E+"/deleteDpiUserLogin",t)}function D(t){return e.post(E+"/deleteOperationLog",t)}function T(t){return e.post(E+"/deleteMWLoginLog",t)}function b(){return e.post(E+"/clearDpiUserCmdLogs")}function S(){return e.post(E+"/clearFwFlowdatas")}function P(){return e.post(E+"/clearDpiUserLogins")}function A(){return e.post(E+"/clearOperationLogs")}function C(){return e.post(E+"/clearMWLoginLogs")}function k(t){return e.post(E+"/deleteEvent",t)}function w(){return e.post(E+"/clearEvents")}var E=t+"/operationlogs",N={get:o,getAll:a,getAllExport:r,getCount:i,getDPILogs:l,getDPILogsExport:s,getDPILogCount:c,createlog:d,mocklogs:u,getScheduleSetting:p,setScheduleSetting:f,getStartTime:m,getReport:g,getOutPutReport:h,deleteLogDc:v,deleteLogDf:y,deleteLogDl:I,deleteLogPf:D,deleteLogPl:T,deleteEvent:k,clearLogDc:b,clearLogDf:S,clearLogDl:P,clearLogPf:A,clearLogPl:C,clearEvents:w};return N}e.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("Logger",e)}(),function(){"use strict";function e(e,t,n,o){function a(){return e.get(f+"/getInterfaces").then(function(e){return e.data})}function r(){return o.resolve(0)}function i(t){return e.get(f+"/queryInterfacesByConditions",{params:n(t)}).then(function(e){var t=[];return e.data&&angular.forEach(e.data,function(e){"agl0"!==e&&"ha"!==e&&t.push(e)}),t})}function l(t){return e.post(f+"/addinterface",t)}function s(t){return e.post(f+"/updateinterface",t)}function c(t){return e.post(f+"/checkBeforeDelete",t)}function d(t){return e.post(f+"/deleteinterface",t)}function u(t){return e.post(f+"/isIpRangeDuplicate/",t)}function p(t){var n=f+"/getInterfacesByBri";return t&&(n=n+"/"+t),e.get(n).then(function(e){var t=[];if(e.data){var n=[];angular.forEach(e.data,function(e,o){"agl0"!==o&&"ha"!==o&&(n.length<4?n.push({name:o,used:e}):(t.push(n),n=[],n.push({name:o,used:e})))}),t.push(n)}return t})}var f=t+"/netinterfaces",m={getNetInterfaceDatas:a,getNetInterfaceDataCounts:r,getInterfaceNames:i,addNetInterfaceData:l,editNetInterfaceData:s,checkBeforeDelete:c,deleteNetInterfaceData:d,getInterfaceListByBri:p,isIpRangeDuplicate:u};return m}function t(e,t,n){function o(t){return e.get(d+"/getIPRoutes",{params:n(t)}).then(function(e){return e.data})}function a(t){return e.get(d+"/getIPRouteCount",{params:n(t)}).then(function(e){return e.data})}function r(t){return e.get(d+"/queryInterfacesByConditions",{params:n(t)}).then(function(e){var t=[];e.data&&angular.forEach(e.data,function(e){"agl0"!==e&&"ha"!==e&&t.push(e)});var n=t.reverse();return n.push("any"),n.reverse(),n})}function i(t){return e.post(d+"/addIPRoute",t)}function l(t){return e.post(d+"/updateIPRoute",t)}function s(t){return e.post(d+"/deleteIPRoute",t)}function c(t){return e.post(d+"/isIpRangeDuplicateByRoute/",t)}var d=t+"/netinterfaces",u={getStaticRouterDatas:o,getStaticRouterDatasCount:a,getOutInterfaceNames:r,addStaticRouterData:i,editStaticRouterData:l,deleteStaticRouterData:s,isIpRangeDuplicate:c};return u}e.$inject=["$http","URI","encodeURL","$q"],t.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("interfaceModel",e).factory("staticRouterModel",t)}(),function(){"use strict";function e(e,t,n){function o(t){var o=u+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function a(t){var o=u+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function r(){return e.get(u+"types").then(function(e){return e.data})}function i(){var o=t+"/netinterfaces",a={};return a.$filter="interfaceType eq 'ETH'",a.$filter+=" or interfaceType eq 'BRI'",e.get(o+"/queryInterfacesByConditions",{params:n(a)}).then(function(e){return e.data})}function l(t,n){return e({url:u+"ippool",method:"POST",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n(e)}).error(function(e){n(null,e.error)})}function s(t,n){return e({url:u+"ippool",method:"PUT",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n(e)}).error(function(e){n(null,e.error)})}function c(t,n){return e({url:u+"ippools",method:"DELETE",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n(e)}).error(function(e){n(null,e.error)})}function d(t,n,o){return n=n?"1":"0",e({url:u+""+t+"/enable/"+n,method:"PUT",headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}var u=t+"/objects/addresspool/",p={getAll:o,getCount:a,getTypes:r,getInterfaces:i,addNewIpPool:l,updateIpPool:s,deleteIpPool:c,switchIpPool:d};return p}function t(e,t,n,o){function a(t){var o=p+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function r(t){var o=p+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function i(){return o.getNetInterfaceDatas()}function l(n,o){return e({url:t+"/objects/securityarea",method:"POST",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function s(t,n){return e({url:p,method:"PUT",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n(e)}).error(function(e){n(null,e.error)})}function c(n,o){e({url:t+"/objects/securityarea/",method:"DELETE",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function d(t,n,o,a){return o=o?"1":"0",e({url:p+""+t+"/"+n+"/enable/"+o,method:"PUT",headers:{"Content-Type":"application/json"}}).success(function(e){a(e)}).error(function(e){a(null,e.error)})}function u(t){var o=p+"asset/all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}var p=t+"/objects/securityarea/",f={getAll:a,getCount:r,getInterfaces:i,addNewSecurityArea:l,updateSecurityArea:s,deleteSecurityArea:c,switchSecurityArea:d,getAllSecurityAreaAndAssets:u};return f}function n(e,t,n){function o(t){var o=y+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function a(t){var o=y+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function r(){return e.get(t+"/objects/model/type").then(function(e){return e.data})}function i(o){var a={modelname:o};return e.get(t+"/objects/model/make",{params:n(a)}).then(function(e){return e.data})}function l(o,a){var r={modelname:o,makename:a};return e.get(t+"/objects/model/name",{params:n(r)}).then(function(e){return e.data})}function s(){return e.get(t+"/objects/securityarea/all/names").then(function(e){return e.data})}function c(n,o){return e({url:t+"/objects/asset",method:"POST",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function d(n,o){return e({url:t+"/objects/asset",method:"PUT",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function u(n,o){e({url:t+"/objects/asset",method:"DELETE",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function p(t,n,o,a){return o=o?"1":"0",e({url:y+""+t+"/"+n+"/enable/"+o,method:"PUT",headers:{"Content-Type":"application/json"}}).success(function(e){a(e)}).error(function(e){a(null,e.error)})}function f(t){var o={assetNames:t.assetNames,secNames:t.secNames,assetIds:t.assetIds,securityAreaName:t.securityarea};return e.put(y+"quickTransfer",null,{params:n(o)}).then(function(e){return e.data})}function m(t){var o=y+"ipmac/set";return e.get(o,{params:n(t)}).then(function(e){if(e.data)for(var t=0;t<e.data.length;t++)e.data[t]._ipmacBoolean=1===e.data[t]._ipmac;return e.data})}function g(t){return e.post(y+"ipmac/set",t)}function h(){return e.post(y+"ipmac/delete")}function v(t){return e.get(y+"referenced/assetId/"+t).then(function(e){return e.data})}var y=t+"/objects/asset/",I={getAll:o,getCount:a,getTypes:r,getFactories:i,getModels:l,getSecurityAreaNames:s,quickTransferTo:f,addNewDeviceAsset:c,updateDeviceAsset:d,deleteDeviceAsset:u,switchDeviceAsset:p,getAllIpmacInfo:m,createIPMACBinding:g,deleteIPMACBinding:h,checkReferencedByIpMac:v};return I}function o(e,t,n){function o(t){var o=r+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function a(t){var o=r+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}var r=t+"/objects/predefineserver/",i={getAll:o,getCount:a};return i}function a(e,t,n){function o(t){var o=s+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function a(t){var o=s+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function r(n,o){return e({url:t+"/objects/server",method:"POST",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function i(n,o){return e({url:t+"/objects/server",method:"PUT",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function l(n,o){e({url:t+"/objects/server",method:"DELETE",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}var s=t+"/objects/server/",c={getAll:o,getCount:a,addNewService:r,updateService:i,deleteService:l};return c}function r(e,t,n){function o(t){var o=r+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function a(t){var o=r+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}var r=t+"/objects/predefineapp/",i={getAll:o,getCount:a};return i}function i(e,t,n){function o(t){var o=d+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function a(t){var o=d+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function r(){return e.get(d+"types").then(function(e){return e.data})}function i(){return e.get(t+"/objects/predefineapp/names").then(function(e){return e.data})}function l(n,o){return e({url:t+"/objects/app",method:"POST",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function s(n,o){return e({url:t+"/objects/app",method:"PUT",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function c(n,o){e({url:t+"/objects/app",method:"DELETE",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}var d=t+"/objects/app/",u={getAll:o,getCount:a,getProtocols:r,getPredefineApps:i,addNewApply:l,updateApply:s,deleteApply:c};return u}function l(e,t,n){function o(t){var o=c+"all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function a(t){var o=c+"all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function r(n,o){return angular.isArray(n)?n.forEach(function(e){e.type="ONCE"}):n.type="ONCE",e({url:t+"/objects/time",method:"POST",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function i(n,o){return angular.isArray(n)?n.forEach(function(e){e.type="LOOP"}):n.type="LOOP",e({url:t+"/objects/time",method:"POST",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function l(n,o){return e({url:t+"/objects/time",method:"PUT",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}function s(n,o){e({url:t+"/objects/time",method:"DELETE",data:n,headers:{"Content-Type":"application/json"}}).success(function(e){o(e)}).error(function(e){o(null,e.error)})}var c=t+"/objects/time/",d={getAll:o,getCount:a,addSingleSchedule:r,addLoopSchedule:i,updateSchedule:l,deleteSchedule:s};return d}e.$inject=["$http","URI","encodeURL"],t.$inject=["$http","URI","encodeURL","interfaceModel"],n.$inject=["$http","URI","encodeURL"],o.$inject=["$http","URI","encodeURL"],a.$inject=["$http","URI","encodeURL"],r.$inject=["$http","URI","encodeURL"],i.$inject=["$http","URI","encodeURL"],l.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("IpPool",e).factory("SecurityArea",t).factory("DeviceAsset",n).factory("ServicePredefine",o).factory("ServiceCustomize",a).factory("ApplyPredefine",r).factory("ApplyCustomize",i).factory("ObjectSchedule",l)}(),function(){"use strict";function e(e,t,n,o){function a(){return e.get(t+"/dashboarduserprofile")}function r(n){return e({url:t+"/dashboarduserprofile",method:"POST",data:JSON.stringify(n),transformRequest:angular.identity,headers:{"Content-Type":"application/json"}})}function i(n){return e.put(t+"/users/userWidgetOptionSettings",n)}function l(){return e.get(t+"/devices/mw/systemstat").then(function(e){return _.extend(e.data||{},{cpu:e.data.cpuUsage||0,memory:e.data.memoryUsage||0,storage:e.data.partitionUsage||0,memoryFree:e.data.memoryFree||0,partitionFree:e.data.partitionFree||0})})}function s(){return e.get(t+"/sysbaseinfo/curtime").then(function(e){return e.data})}function c(){var o={$filter:"interfaceType eq 'ETH'"};return e.get(t+"/netinterfaces/queryInterfacesByConditions",{params:n(o)}).then(function(e){return e.data})}function d(n,a,r){return v&&v.resolve(),v=o.defer(),e.get(t+"/devices/realTimeTraffics/"+r.value+"/"+a,{timeout:v.promise}).then(function(e){return e.data}).then(function(e){if(_.isEmpty(e)&&a>1){var t={};return _.each(n,function(e){t[e.name]=_.range(a).map(function(e,t){return{flowIn:0,flowOut:0,x:moment((new Date).getTime()-t*r.time)}}).reverse()}),t}return e}).then(function(e){if(_.isEmpty(e))return{};var t,o=_.mapValues(e,function(e){return t||(t=_.map(e,function(e){return{x:moment.utc(e.x).local().format(r.format),flowIn:0,flowOut:0,originTime:e.x}})),_.map(e,function(e){return{x:moment.utc(e.x).local().format(r.format),flowIn:parseFloat(e.flowIn),flowOut:parseFloat(e.flowOut),originTime:e.x}})});return _.each(n,function(e){o[e.name]||(o[e.name]=t)}),o})}function u(e){return o.resolve(new Array(e+1).join("0").split("").map(function(t,n){return{time:(new Date).getTime()-1e3*(e-n),msg:"NTP时间从2016-11-30 16:32:03到:2016-11-30 16:32:03同步成功 偏移量:0.00秒"}}))}function p(){return e.get(t+"/dashboards/policycount").then(function(e){return e.data}).then(function(e){return _(e).map(function(e){return e.num=parseInt(e.num),e}).reject(function(e){return 0===e.num}).value()})}function f(){return e.get(t+"/natSetting/allStrategy").then(function(e){return e.data}).then(function(e){return _(e).map(function(e){return e.num=parseInt(e.num),e}).reject(function(e){return 0===e.num}).value()})}function m(n){return e.get(t+"/incidents/incidentTopFive/startTime/"+n).then(function(e){return e.data}).then(function(e){return e.length?e.concat(_(_.range(5)).map(function(){return{name:"",num:0}}).value()).slice(0,5):[]}).then(function(e){return _(e).map(function(e){return e.num=parseInt(e.num),e}).sortBy("num").value()})}function g(o){var a={$filter:"(level eq DROP) or (level eq REJECTBOTH)"};return a.$limit=o,a.$orderby="incidentId desc",e.get(t+"/incidents/incidents",{params:n(a)}).then(function(e){return _.sortBy(e.data,"timestamp")})}var h={getDashboardUserProfile:a,setDashboardUserProfile:r,setUserWidgetOption:i,getSystemUsage:l,getCurtime:s,getETHList:c,getETHData:d,getErrorIncidentList:u,getRuleData:p,getStrategyData:f,getIncidentData:m,getErrorIncidents:g};return h;var v}e.$inject=["$http","URI","encodeURL","$q"],angular.module("southWest.models").factory("mOverview",e)}(),function(){"use strict";function e(e,t,n,o){function a(e){var n={};return e&&(n={params:o({$filter:"dataType eq "+e})}),t.get(f,n).then(function(e){return e.data})}function r(){return t.get(f+"/defaultports").then(function(e){return e.data})}function i(e){var n=[];for(var o in e)if(e[o]&&!e[o].disabled){var a={};a.privateProtocolId=e[o].privateProtocolId,a.protocolPort=e[o].protocolPort,a.protocolName=e[o].protocolName,a.disabled=e[o].disabled,n.push(a)}return t.put(f,n)}function l(){return t.get(n+"/strategymanagement/strategybuilder/strategycode/FTP_PROTOCOL_TOGGLE").then(function(e){return e.data})}function s(e){return t.put(n+"/strategymanagement/strategyrule/ruledata",e).then(function(e){return e.data})}function c(){return t.get(n+"/servicesetting/protocolswitch").then(function(e){return e.data})}function d(e){return t.post(n+"/servicesetting/protocolswitch",e).then(function(e){return e.data})}function u(e){return t.get(f+"?$filter=dataType eq "+e).then(function(e){return e.data},function(){return[]})}function p(e){return t.post(n+"/servicesetting/protocolportsconfig",e).then(function(e){return e})}var f=n+"/privateprotocols",m={getProtocols:a,getHiddenPorts:r,updateAll:i,getFTPProtocols:l,updateAllDP:s,getProtocolSwitch:c,setProtocolSwitch:d,getPrivateProtocols:u,updatePrivateProtocols:p};return m}e.$inject=["$q","$http","URI","encodeURL"],angular.module("southWest.models").factory("PrivateProtocol",e)}(),function(){"use strict";function e(e,t){function n(n){return e.get(t+"/jobscheduler/jobbuilder/category/"+n).then(function(e){return e.data})}function o(n){return e.put(t+"/jobscheduler/jobbuilder",n).then(function(e){return e.data})}function a(){return e.get(l+"/starttime").then(function(e){return e.data})}function r(t,n,o){return e.get(l+"/report/start/"+t+"/end/"+n+"/schedule/"+o,{timeout:3e5}).then(function(e){return e.data})}function i(t,n,o,a,r){var i={image:t,image2:n};return e({method:"POST",url:l+"/export/Image/start/"+o+"/end/"+a+"/type/"+r,data:i,transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(function(e){return e.data})}var l=t+"/auditlogs",s={getScheduleSetting:n,setScheduleSetting:o,getStartTime:a,getReport:r,getOutPutReport:i};return s}e.$inject=["$http","URI"],angular.module("southWest.models").factory("ProtocolReport",e)}(),function(){"use strict";function e(e,t,n){function o(t){return e.put(s+"/backuplogs/delete",t)}function a(t){return e.get(s+"/backuplogs",{params:n(t)}).then(function(e){return e.data})}function r(t){return e.get(s+"/backuplogs/count",{params:n(t)}).then(function(e){return e.data})}function i(){return e.post(s+"/backuplog")}function l(){return e.get(s+"/backuplogs").then(function(e){return e.data})}var s=t+"/operationlogs",c={deleteRecord:o,getBackupLogs:a,getBackupLogsCount:r,generateRecord:i,search:l};return c}e.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("Record",e)}(),function(){"use strict";function e(e,t){function n(){return e.get(t+"/systemsetting/hotstandby").then(function(e){return e.data})}function o(){return e.get(t+"/systemsetting/hotstandbystate").then(function(e){return e.data})}function a(n){return e.post(t+"/systemsetting/hotstandby",n).then(function(e){return e.data})}function r(){return e.get(t+"/systemsetting/bypass").then(function(e){return e.data})}function i(n){return e.post(t+"/systemsetting/bypass",n).then(function(e){return e.data})}var l={getHotStandby:n,getHotStandbyState:o,getBypass:r,updateHotStandby:a,updateBypass:i};return l}e.$inject=["$http","URI"],angular.module("southWest.models").factory("Reliable",e)}(),function(){"use strict";function e(e,t,n){function o(e,n,o,r,i){return t.get(l+"/sessionprotocol/?starttime="+r+"&endtime="+i+"&protocol="+e+"&srcIp="+n+"&dstIp="+o,{timeout:3e5}).then(function(e){var t=[],n=[],o=[],r=[],i=0;return e.data.map(function(e){"none"!==e.srcPoolName&&"none"!==e.dstPoolName||0!==o.length||o.push({poolName:"防火墙外地址池",poolId:"",ipRange:"",SecAreaName:""}),"none"===e.srcPoolName||a(n,e.srcPoolName)||n.push({poolName:e.srcPoolName,poolId:e.srcPoolId,ipRange:"none"===e.srcPoolAddress?"":e.srcPoolAddress,SecAreaName:"none"===e.srcSecAreaName?"":e.srcSecAreaName}),"none"===e.dstPoolName||a(n,e.dstPoolName)||n.push({poolName:e.dstPoolName,poolId:e.dstPoolId,ipRange:"none"===e.dstPoolAddress?"":e.dstPoolAddress,SecAreaName:"none"===e.dstSecAreaName?"":e.dstSecAreaName});var t=_.find(r,function(t){return t.protocolName===e.protocolName});void 0!==t&&void 0!==t.protocolName&&null!==t.protocolName?(t.data.push({srcPool:"none"===e.srcPoolName?"防火墙外地址池":e.srcPoolName,dstPoolName:"none"===e.dstPoolName?"防火墙外地址池":e.dstPoolName,srcPoolId:e.srcPoolId,dstPoolId:e.dstPoolId,value:e.count}),i+=e.count):(r.push({protocolName:e.protocolName,data:[{srcPool:"none"===e.srcPoolName?"防火墙外地址池":e.srcPoolName,dstPoolName:"none"===e.dstPoolName?"防火墙外地址池":e.dstPoolName,srcPoolId:e.srcPoolId,dstPoolId:e.dstPoolId,value:e.count}]}),i+=e.count)}),t.push(_.sortBy(n,"SecAreaName")),t.push(o),t.push(r),t.push({average:0===r.length?i:i/r.length}),t})}function a(e,t){var n=_.find(e,function(e){return e.poolName===t});return void 0!==n&&void 0!==n.poolName&&null!==n.poolName}function r(e,n,o){return t.get(l+"/sessionprotocol/poolId/"+e+"/?starttime="+n+"&endtime="+o,{timeout:3e5}).then(function(t){var n=[],o=[],a=[],r=[],i=[],l=[];return t.data.map(function(t){t.srcPoolId===e?_.contains(n,t.srcIp)||(n.push(t.srcIp),o.push(t.srcName)):_.contains(a,t.srcIp)||(a.push(t.srcIp),r.push(t.srcName)),t.dstPoolId===e?_.contains(n,t.dstIp)||(n.push(t.dstIp),o.push(t.dstName)):_.contains(a,t.dstIp)||(a.push(t.dstIp),r.push(t.dstName));var l=_.find(i,function(e){return e.protocolName===t.protocolName});void 0!==l&&void 0!==l.protocolName&&null!==l.protocolName?l.data.push({srcIp:t.srcIp,dstIp:t.dstIp}):i.push({protocolName:t.protocolName,data:[{srcIp:t.srcIp,dstIp:t.dstIp}]})}),l.push(n),l.push(a),l.push(i),l.push(o),l.push(r),l})}function i(e,n,o,a,r){return t.get(l+"/sessionprotocol/protocol/"+e+"/srcPoolId/"+n+"/dstPoolId/"+o+"/?starttime="+a+"&endtime="+r,{timeout:3e5}).then(function(e){var t=[],a=[],r=[],i=[],l=[],s=[];return e.data.map(function(e){e.srcPoolId!==n||_.contains(t,e.srcIp)||_.contains(a,e.srcIp)?e.srcPoolId!==o||_.contains(t,e.srcIp)||_.contains(a,e.srcIp)||(a.push(e.srcIp),s.push(e.srcName)):(t.push(e.srcIp),l.push(e.srcName)),e.dstPoolId!==o||_.contains(a,e.dstIp)||_.contains(t,e.dstIp)?e.dstPoolId!==n||_.contains(a,e.dstIp)||_.contains(t,e.dstIp)||(t.push(e.dstIp),l.push(e.dstName)):(a.push(e.dstIp),s.push(e.dstName));var i=_.find(r,function(t){return t.protocolName===e.protocolName});void 0!==i&&void 0!==i.protocolName&&null!==i.protocolName?i.data.push({srcIp:e.srcIp,dstIp:e.dstIp}):r.push({protocolName:e.protocolName,data:[{srcIp:e.srcIp,dstIp:e.dstIp}]})}),i.push(t),i.push(a),i.push(r),i.push(l),i.push(s),i})}var l=n+"/auditlogs",s={get:o,getPoolDetails:r,getLineDetails:i};return s}e.$inject=["$q","$http","URI"],angular.module("southWest.models").factory("ProtocolModel",e)}(),function(){"use strict";function e(e,t,n,o,a,r){function i(){var t=a.getUrl(r.currentIp)+"/api/v2.0/signatures";return e.get(t)}function l(t,n,a,r,i,l,s,c){var d=se+"policy/"+t+"/policytype/BLACKLIST/blocks";return n&&(d=d+"?lockstatus="+n),a&&(d=d+"&type="+a),r&&(d=d+"&category="+r),i&&(d=d+"&desc="+i),l&&(d=d+"&sid="+l),s&&(d=d+"&signame="+s),e.get(d,{params:o(c)}).then(function(e){return e.data})}function s(t,n,a,r,i,l,s,c){var d=se+"policy/"+t+"/policytype/BLACKLIST/blocks/count";return n&&(d=d+"?lockstatus="+n),a&&(d=d+"&type="+a),r&&(d=d+"&category="+r),i&&(d=d+"&desc="+i),l&&(d=d+"&sid="+l),s&&(d=d+"&signame="+s),e.get(d,{params:o(c)}).then(function(e){return e.data})}function c(t){
return e.get(a.getUrl(r.currentIp)+se+"block/"+t+"/rules")}function d(t){return e.post(a.getUrl(r.currentIp)+"/api/v2.0/signatures/insertRule",{data:t})}function u(t){return e.post(a.getUrl(r.currentIp)+"/api/v2.0/signatures/updateSchedule",{data:t})}function p(t){return e.post(a.getUrl(r.currentIp)+"/api/v2.0/signatures/updateStatus",{data:t})}function f(t){return e.post(a.getUrl(r.currentIp)+"/api/v2.0/signatures/removeSchedule",{data:t})}function m(t){return e.post(a.getUrl(r.currentIp)+"/api/v2.0/signatures/saveSignature",{data:t})}function g(t,n,a,r,i){i||(i="BLACKLIST");var l=se+"policy/"+t+"/policytype/"+i+"/blocks";return n&&(l=l+"?lockstatus="+n),a&&(l=l+"&type="+a),e.get(l,{params:o(r)})}function h(t,n,a,r,i){i||(i="BLACKLIST");var l=se+"policy/"+t+"/policytype/"+i+"/blocks/count";return n&&(l=l+"?lockstatus="+n),a&&(l=l+"&type="+a),e.get(l,{params:o(r)})}function v(t){var n=new FormData;return n.append("file",t),e({url:a.getUrl(r.currentIp)+se+"vulnerabilities/fileupload/isValid",method:"POST",data:n,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}function y(t){var n=new FormData;return n.append("file",t),e({url:a.getUrl(r.currentIp)+se+"vulnerabilities/fileupload",method:"POST",data:n,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}function I(){return e.get(a.getUrl(r.currentIp)+se+"newid")}function D(t){return e.get(a.getUrl(r.currentIp)+se+"getPolicies?$filter=lockedType eq READYDEPLOY and policyType eq "+t+"&$orderby=inUse desc, updatedAt desc")}function T(t){return t?e.get(a.getUrl(r.currentIp)+se+"getPolicies?$filter=inUse eq true and policyType eq "+t):e.get(a.getUrl(r.currentIp)+se+"getPolicies?$filter=inUse eq true")}function b(t){return e.get(a.getUrl(r.currentIp)+se+"policy/"+t)}function S(){return e.get(a.getUrl(r.currentIp)+se+"getPolicies?$filter=lockedType eq READYDEPLOY&_signaturesCount gt 0&$orderby=inUse desc")}function P(t,n){return e.post(a.getUrl(n||r.currentIp)+se+t+"/deploy")}function A(t,n){return e.post(se+"policytype/"+n+"/all/deploy",t)}function C(t,n){return e.put(a.getUrl(r.currentIp)+se+"policy/"+t,{name:n})}function k(t,n,o,a){return e.post(se+"policy/"+t+"/policytype/"+a+"/blocktype/signature/unlock?policyname="+n,o)}function w(t,n,o){return e.post(se+"policy/"+t+"/policytype/"+o+"/unlockall?policyname="+n)}function E(t,n,o){return e.put(se+"topology/"+t+"/policy/"+n+"/risklevel/"+o)}function N(t,n){return e.put(se+"policyblock/"+t+"/risklevel/"+n)}function $(t,n){return e.put(se+"signature/"+t+"/risklevel/"+n)}function M(t,n){return e.put(se+"rule/"+t+"/risklevel/"+n)}function R(t){return e.get(a.getUrl(r.currentIp)+se+"block/"+t+"/signatures")}function U(t){return e.get(a.getUrl(r.currentIp)+se+"policy/"+t)}function _(t,n,o){return e.put(a.getUrl(r.currentIp)+se+"policy/"+t+"/blocks/priority",{policyBlockId:n.policyBlockId,currentOrder:n.priority,targetOrder:o})}function x(e){return n.when({policyId:e,action1:"阻断",action2:"警告"})}function O(t,n,o){return e.put(a.getUrl(r.currentIp)+se+"block/"+t+"/rule/"+n,{action:o})}function L(t,n,o){return e.put(a.getUrl(r.currentIp)+se+"block/"+t+"/rule/"+n,{fields:o})}function B(t,n){return e.put(a.getUrl(r.currentIp)+se+"policy/"+t+"/signatures",n)}function V(t,n){return e.put(a.getUrl(r.currentIp)+se+"block/"+t+"/signatures",n)}function j(t,n,o){return e.put(a.getUrl(r.currentIp)+se+"policy/"+t+"/defaultrules",{supportRuleAction:n,unknownRuleAction:o})}function W(t){return e.delete(a.getUrl(r.currentIp)+se+"policytype/"+t)}function F(t,n,o){return e.put(a.getUrl(r.currentIp)+se+"policy/"+t+"/blocktype/"+n+"/availableblocks",o)}function H(t){return e.get(a.getUrl(r.currentIp)+se+"policy/"+t+"/sigrules/count")}function G(t,n){return e.put(a.getUrl(r.currentIp)+se+"policyid/"+t+"/blocks/deleteall/type/"+n)}function z(t){return e.put(a.getUrl(r.currentIp)+se+"blocks/delete",t)}function q(t){return e.put(a.getUrl(r.currentIp)+se+"policy/"+t+"/policyset")}function Y(t,n){return e.get(a.getUrl(r.currentIp)+se+"policy/"+t+"/rule/"+n+"/template/export").then(function(e){return e.data})}function K(t){return e.get(a.getUrl(t||r.currentIp)+se+"ipmac")}function J(){return e.get(t+"/servicesetting/ipmacswitch")}function Z(){return J().then(function(e){var t=!1;return e.data.map(function(e){"IP_MAC"===e.subscriptionType&&0===e.operationStatus&&(t="OFF"!==e.subscriptionStatus)}),t},function(){return!1})}function Q(t,n){return e.put(a.getUrl(n||r.currentIp)+se+"ipmacaction",t)}function X(n){return e.post(t+"/servicesetting/ipmacswitch",n)}function ee(t){return e.get(se+"topology/"+t+"?$filter=policyType eq MALICIOUS_DOMAIN")}function te(t){return e.get(se+"maliciousdomain",{params:o(t)}).then(function(e){return e.data})}function ne(t){return e.get(se+"maliciousdomain/count",{params:o(t)}).then(function(e){return e.data})}function oe(t){return e.put(se+"maliciousdomain",t)}function ae(t){return e.post(se+"maliciousdomain",t)}function re(t){return e.delete(se+"maliciousdomain/"+t)}function ie(t,n,o){return e.post(se+"maliciousdomain/method/"+t+"/deploy/"+n,o)}function le(t,n,o,a){return e.put(se+"policy/"+t+"/blocks/prioritys/direction/"+o+"/size/"+a,n)}var se=t+"/policies/",ce={get:i,getAll:l,getCount:s,uploadSignature:y,signatureIsValid:v,saveSignature:m,deploy:P,deployAll:A,removeSchedule:f,updateSchedule:u,updateStatus:p,getRulesbyBlockId:c,getSignaturesbyBlockId:R,getIPMACPolicy:K,getIPMACSwitch:J,isMacNeeded:Z,insertRule:d,getPolicies:D,getBlacklist:S,createPolicy:I,getDeployedPolicy:T,getPolicy:b,getPolicyBlockbyPolicyId:g,getPolicyBlockCountbyPolicyId:h,getPolicyByPolicyId:U,unlock:k,unlockAll:w,changePolicyRiskLevel:E,changePolicyBlockRiskLevel:N,changeSignatureRiskLevel:$,changeRuleRiskLevel:M,changePriority:_,getDefaultRulesByPolicyId:x,changePolicyName:C,changeAction:O,changeFields:L,changeActionToAllInOnePolicy:B,changeActionToAllinOnePolicyBlock:V,cleanDeploy:W,changeDefaultRuleAction:j,changeIPMACAction:Q,changeIPMACSwitch:X,availableBlocks:F,getPolicySignatureRulesCount:H,deleteAllBlocksByPolicyIdandType:G,deleteBlocksByBlockIds:z,deletePolicySetByPolicyId:q,exportWhitelistTemplate:Y,getMaliciousDomainPolicy:ee,getMaliciousDomains:te,getMaliciousDomainCount:ne,changeActionToMaliciousDomain:oe,addMaliciousDomain:ae,deleteMaliciousDomain:re,deployMaliciousDomains:ie,changePriorityByDirection:le};return ce}e.$inject=["$http","URI","$q","encodeURL","UCD","$rootScope"],angular.module("southWest.models").factory("Signature",e)}(),function(){"use strict";function e(){this.listen=function(e,t,n,o){var a={contentType:"application/json",logLevel:"warn",transport:"sse",enableXDR:!0,reconnectInterval:1e3};a.url="/sse/"+e,a.onOpen=function(e){o&&o("SSE is on open")},a.onMessage=function(e){var t=atmosphere.util.parseJSON(e.responseBody);n&&n(t)},atmosphere.subscribe(a),t.$on("$destroy",function(){atmosphere.unsubscribeUrl(a.url)})},this.unsubscribe=function(e){var t={contentType:"application/json",logLevel:"debug",transport:"sse",enableXDR:!0};t.url="/sse/"+e,atmosphere.unsubscribeUrl(t.url)}}angular.module("southWest.services").service("sse",e)}(),function(){"use strict";function e(e,t,n,o){function a(t){var o=v+"/all";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function r(t){var o=v+"/all/count";return e.get(o,{params:n(t)}).then(function(e){return e.data})}function i(o){var a=t+"/cpolicy/object/names";return e.get(a,{params:n(o)}).then(function(e){var t=e.data;return angular.isArray(t)&&(t=t.map(function(e){return angular.isString(e)?{name:e}:e})),t})}function l(o){var a=t+"/cpolicy/service/names";return e.get(a,{params:n(o)}).then(function(e){var t=e.data;return angular.isArray(t)&&(t=t.map(function(e){return angular.isString(e)?{name:e}:e})),t})}function s(o){var a=t+"/cpolicy/apps/names";return e.get(a,{params:n(o)}).then(function(e){var t=e.data;return angular.isArray(t)&&(t=t.map(function(e){return angular.isString(e)?{name:e}:e})),t})}function c(){var n=t+"/cpolicy/time/names";return e.get(n).then(function(e){return e.data})}function d(t){function n(e,t){var n=this;n.name=t,n.tree=e,n.detail=t?e[t]?e[t]:{}:null,n.isHavingSubFunc=!1,n.isHavingValue=!1,n.getAllFuncCode=function(){var e=[],t=["value","ref-options"];for(var o in n.detail)t.indexOf(o)<0&&e.push(o);return e},angular.isObject(n.detail)&&(n.isHavingValue=angular.isArray(n.detail.value)&&n.detail.value.length>0,n.isHavingSubFunc=n.getAllFuncCode().length>0),n.getValueDetail=function(e){var t=e?e:angular.copy(n.detail.value);return n.isHavingValue&&t.map(function(e){if(angular.isString(e.value)){var t=e.value.split(",");t.forEach(function(t){var n=t.split("-");2===n.length?(e.type=e.type?e.type+"-RANGE":"RANGE",e.min=Number(n[0]),e.max=Number(n[1])):e.type=e.type?e.type+"-"+t:t})}else angular.isArray(e.value)?(e.type="OPTION",e.option=[],e.value.forEach(function(t){var n=angular.isString(t)?t.split(","):[];if(2===n.length){for(var o=Number(n[0]),a=Number(n[1]),r=[],i=o;i<=a;i++)r.push(i);Array.prototype.push.apply(e.option,r)}else e.option.push(t)})):e.ref&&angular.isArray(n.tree[e.ref])&&(e.type="REF-OPTION",e.option=angular.copy(n.tree[e.ref]),e.option.forEach(function(e){e.option&&n.getValueDetail(e.option)}));return e}),t}}return e.get("js/protocolTree.json").then(function(e){var o=e.data,a="Modbus-TCP";return t&&angular.isObject(t)&&(t.tree?o=t.tree:null,t.funcCode?a=t.funcCode:null),new n(o,a)})}function u(e,t){function n(e){var t=[{name:"data",expressionKey:"expression"}];angular.isArray(e)&&e.length>0&&e.forEach(function(e){delete e.funcCodes,delete e.nodeIndex,delete e.tree,delete e.value,delete e.isHavingSubFunc,t.forEach(function(t){var n=e[t.name];angular.isObject(n)&&(e[t.expressionKey]=n.expression,e[t.name]=n.value)}),angular.isArray(e.objs)&&e.objs.length>0&&e.objs.map(function(e){var n=e.refvalue.length;if(e.Object=e.refvalue?e.refvalue.slice(0,n-2):"",e.Variation=e.refvalue?e.refvalue.slice(-2,n):"",delete e.name,delete e.refvalue,delete e.option,t.forEach(function(t){var n=e[t.name];angular.isObject(n)&&(e[t.expressionKey]=n.expression,e[t.name]=n.value)}),e.value)if(e.value.indexOf("-")>-1){var o=e.value.split("-");e.value="["+o[0]+","+o[1]+"]"}else e.value="{"+e.value+"}";return e}),angular.isArray(e.nodes)&&e.nodes.length>0?n(e.nodes):delete e.nodes})}var o=angular.copy(e),a=angular.copy(t);return n(a),o.uiRules=JSON.stringify(a),o}function p(e,t,n,o){function a(e){if(angular.isArray(e.objs)&&e.objs.length>0){var t=angular.isArray(e.value)?e.value.length:0;e.objs=e.objs.map(function(n,o){var a=String.prototype.concat.call(n.Object,n.Variation);if(delete n.Object,delete n.Variation,i.forEach(function(e){var t=n[e.expressionKey],o=n[e.name];angular.isDefined(t)&&angular.isDefined(o)&&(n[e.name]={expression:t,value:o},delete n[e.expressionKey])}),o<t&&e.value[o].option.some(function(e){if(e.refvalue===a)return n=angular.extend(e,n),!0}),n.value)if(0===n.value.indexOf("[")){var r=JSON.parse(n.value);n.value=r[0]+"-"+r[1]}else n.value=n.value.slice(1,n.value.length-1);return n})}}function r(e,l,s){angular.isArray(e)&&e.length>0&&e.forEach(function(e){if(i.forEach(function(t){var n=e[t.expressionKey],o=e[t.name];angular.isDefined(n)&&angular.isDefined(o)&&(e[t.name]={expression:n,value:o},delete e[t.expressionKey])}),l)e.tree=t,e.funcCodes=n,o(e,a),angular.isArray(e.nodes)&&e.nodes.length>0?r(e.nodes,!1,e):e.nodes=[];else{var c={tree:s.tree,funcCode:s.funcCode};d(c).then(function(t){var n=t.getAllFuncCode();e.tree=t.detail,e.funcCodes=n,e.nodeIndex=s.nodeIndex,o(e,a),angular.isArray(e.nodes)&&e.nodes.length>0?r(e.nodes,!1,e):e.nodes=[]})}})}var i=[{name:"data",expressionKey:"expression"}],l=e.uiRules?JSON.parse(e.uiRules):"";return r(l,!0),l}function f(e){e.isTypeOption=function(e){return"OPTION"===e},e.isTypeRefOption=function(e){return"REF-OPTION"===e},e.isTypeInputSingle=function(e){return"RANGE"===e||"SINGLE"===e},e.isTypeInputMulti=function(e){return e.indexOf("DISCRETE")>-1||e.indexOf("LIMIT")>-1},e.isTypeExpression=function(e){return e.indexOf("EXPRESSION")>-1},e.actions=["pass","drop"],e.addNewFuncCode=function(){e.treeNodes.push({tree:e.rootTree,funcCodes:e.funcCodes,funcCode:e.funcCodes.length>0?e.funcCodes[0]:"",action:"pass",nodes:[]}),e.selectFuncCode(e.treeNodes[e.treeNodes.length-1])},e.toggle=function(e){e.toggle()},e.selectFuncCode=function(e,t){var n={tree:e.tree,funcCode:e.funcCode};angular.isArray(e.value)&&e.value.forEach(function(t){e[t.name]&&delete e[t.name]}),d(n).then(function(o){e.value=angular.copy(o.getValueDetail()),e.value&&e.value.map(function(e,t){if(n.tree["ref-options"])return e.refValueIndex=t,e}),e.isHavingSubFunc=o.isHavingSubFunc,t?t(e):null})},e.remove=function(e){e.remove()},e.newSubNode=function(t){t.expand();var n=t.$modelValue,o={tree:n.tree,funcCode:n.funcCode};d(o).then(function(t){var o=t.getAllFuncCode();n.nodes.push({tree:t.detail,funcCodes:o,funcCode:o.length>0?o[0]:"",action:"pass",nodeIndex:n.nodeIndex,nodes:[]}),e.selectFuncCode(n.nodes[n.nodes.length-1])})},e.checkRangeVal=function(e,t){if(e&&t){if(t.type){var n=o.validateValueInput(e,t.type);if(n){var a=[e];if(e.indexOf("-")>=0&&(a=e.split("-"),Number(a[0])>Number(a[1])))return!1;if(angular.isDefined(t.min)&&angular.isDefined(t.max)){var r=Number(t.min),i=Number(t.max);e.indexOf(",")>=0&&(a=e.split(",")),a.some(function(e){return e=Number(e),n=e>=r&&e<=i,!n})}}return n}if(angular.isDefined(t.min)&&angular.isDefined(t.max))return e=Number(e),e>=Number(t.min)&&e<=Number(t.max)}return!0}}function m(t,n){return e({url:v,method:"POST",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n(e)}).error(function(e){n(null,e.error)})}function g(t,n){return e({url:v,method:"PUT",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n(e)}).error(function(e){n(null,e.error)})}function h(t,n){return e({url:v,method:"DELETE",data:t,headers:{"Content-Type":"application/json"}}).success(function(e){n(e)}).error(function(e){n(null,e.error)})}var v=t+"/cpolicy/policy",y={getAll:a,getCount:r,searchObjects:i,searchServices:l,searchApps:s,getTimes:c,getTreeNode:d,formatStrategy:u,parseStrategy:p,initTreeNodeAction:f,addNewSecurityStrategy:m,updateSecurityStrategy:g,deleteSecurityStrategy:h};return y}function t(e,t,n,o){function a(o,a){return e.get(t+"/sessionmanage/sessionstate/all",{params:n(o)}).then(function(e){return a.totalNum=e.data.totalCount,e.data.pageData})}function r(e){return o.resolve(e.totalNum||0)}function i(n,o){var a=l(o),r=l(n);return e.get(t+"/sessionmanage/session/count/startTime/"+r+"/endTime/"+a).then(function(e){var t=[];return e.data.forEach(function(e){t.push([new Date(e.sessionTimestamp),e.sessionCount])}),t})}function l(e){return e.getUTCFullYear()+"-"+(e.getUTCMonth()+1>9?e.getUTCMonth()+1:"0"+(e.getUTCMonth()+1))+"-"+(e.getUTCDate()>9?e.getUTCDate():"0"+e.getUTCDate())+"T"+(e.getUTCHours()>9?e.getUTCHours():"0"+e.getUTCHours())+":"+(e.getUTCMinutes()>9?e.getUTCMinutes():"0"+e.getUTCMinutes())+":"+(e.getUTCSeconds()>9?e.getUTCSeconds():"0"+e.getUTCSeconds())+"Z"}function s(){return e.get(t+"/sessionmanage/strategylist").then(function(e){return e.data})}var c={getAll:a,getCount:r,getSessionCount:i,getStrategyList:s};return c}function n(e,t,n){function o(o){return e.get(t+"/sessionmanage/sessioncontrol/all",{params:n(o)}).then(function(e){return e.data})}function a(o){return e.get(t+"/sessionmanage/sessioncontrol/all/count",{params:n(o)}).then(function(e){return e.data})}function r(n){return e.post(t+"/sessionmanage/sessioncontrol/add",n).then(function(e){return e.data})}function i(n){return e.post(t+"/sessionmanage/sessioncontrol/edit",n).then(function(e){return e.data})}function l(n){return e.post(t+"/sessionmanage/sessioncontrol/del",n).then(function(e){return e.data})}function s(n){return e.get(t+"/objects/server/like/"+n).then(function(e){return e.data})}function c(n){return e.get(t+"/objects/app/like/"+n).then(function(e){return e.data})}function d(n){return e.post(t+"/sessionmanage/sessioncontrol/switch",n).then(function(e){return e.data})}function u(n){return e.post(t+"/sessionmanage/sessioncontrol/validate",n).then(function(e){return e.data})}var p={getAll:o,getCount:a,addSessionControl:r,editSessionControl:i,delSessionControl:l,searchService:s,searchApp:c,changeSwitch:d,validateSessionControl:u};return p}function o(e,t,n){function o(t){return e.get(f+"/getDNATSettings",{params:n(t)}).then(function(e){return e.data})}function a(t){return e.get(f+"/getDNATSettingsCount",{params:n(t)}).then(function(e){return e.data})}function r(){return e.get(f+"/addressPools").then(function(e){return e.data})}function i(t){return e.post(f+"/addDNATSetting",t)}function l(t){return e.post(f+"/updateDNATSetting",t)}function s(t){return e.post(f+"/deleteDNATSetting",t)}function c(t){return e.post(f+"/switchDNATSettingStatus",t)}function d(t){return e.post(f+"/switchDNATSettingLogs",t)}function u(n){return e.get(t+"/objects/app/like/"+n).then(function(e){return e.data})}function p(n){return e.get(t+"/objects/server/like/"+n).then(function(e){return e.data})}var f=t+"/natSetting",m={getDNATAll:o,getDNATCount:a,addDNATData:i,editDNATData:l,deleteDNATData:s,switchDNATStatus:c,switchDNATLogs:d,getAddressPools:r,searchApps:u,searchServices:p};return m}function a(e,t,n){function o(t){return e.get(u+"/getSNATSettings",{params:n(t)}).then(function(e){return e.data})}function a(t){return e.get(u+"/getSNATSettingsCount",{params:n(t)}).then(function(e){return e.data})}function r(t){return e.get(u+"/addressPools",{params:n(t)}).then(function(e){return e.data})}function i(t){return e.post(u+"/addSNATSetting",t)}function l(t){return e.post(u+"/updateSNATSetting",t)}function s(t){return e.post(u+"/deleteSNATSetting",t)}function c(t){return e.post(u+"/switchSNATSettingStatus",t)}function d(t){return e.post(u+"/switchSNATSettingLogs",t)}var u=t+"/natSetting",p={getSNATAll:o,getSNATCount:a,addSNATData:i,editSNATData:l,deleteSNATData:s,switchSNATStatus:c,switchSNATLogs:d,getAddressPools:r};return p}e.$inject=["$http","URI","encodeURL","formatVal"],t.$inject=["$http","URI","encodeURL","$q"],n.$inject=["$http","URI","encodeURL"],o.$inject=["$http","URI","encodeURL"],a.$inject=["$http","URI","encodeURL"],angular.module("southWest.models").factory("SecurityStrategyModel",e).factory("SessionStateModel",t).factory("SessionControlModel",n).factory("dnatModel",o).factory("snatModel",a)}(),function(){"use strict";function e(e,t){function n(){return e.get(t+"/servicesetting/trafficswitch").then(function(e){return e.data})}function o(n){return e.post(t+"/servicesetting/trafficswitch",n).then(function(e){return e.data})}function a(){return e.get(t+"/servicesetting/protocolswitch").then(function(e){return e.data})}function r(n){return e.post(t+"/servicesetting/protocolswitch",n).then(function(e){return e.data})}var i={getTrafficSwitch:n,setTrafficSwitch:o,getProtocolSwitch:a,setProtocolSwitch:r};return i}e.$inject=["$http","URI"],angular.module("southWest.models").factory("SwitchModel",e)}(),function(){"use strict";function e(e,t,n,o){function a(t){return e.get(c+"policytype/"+t+"/synchronization/tasks?$orderby=startDatetime desc&$limit=1")}function r(t,n){return e.post(c+"topology/"+t+"/policytype/"+n+"/synchronization")}function i(t,n){return e.get(c+"topology/"+t+"/temprules/",{params:o(n)}).then(function(e){return e.data})}function l(t,n){return e.get(c+"topology/"+t+"/temprules/count",{params:o(n)}).then(function(e){return e.data})}function s(t,n,o){return e.post(c+"topology/"+t+"/policytype/"+n+"/temprules/addition",o)}var c=t+"/policies/",d={getLatestSyncTask:a,checkSyncRules:r,getSyncResult:i,getSyncResultCount:l,addSyncResultToLib:s};return d}e.$inject=["$http","URI","$q","encodeURL"],angular.module("southWest.models").factory("SyncRules",e)}(),function(){"use strict";function e(e,t,n,o,a){function r(){return n.get(o+"/systemsetting")}function i(){return q.get().$promise}function l(){return n.get("/api/v2.0/strategymanagement/strategybuilders")}function s(e){return n.get(o+"/jobscheduler/jobbuilder/category/"+e)}function c(e){return n.put(o+"/jobscheduler/jobbuilder",e)}function d(e){return n.post(o+"/systemsetting/syslog",e).then(function(e){return e.data})}function u(e){return n.post(o+"/systemsetting/mode",e).then(function(e){return e.data})}function p(e,t,a,r,i,l,s){var c={mwIp:t,netMask:a,gateWay:r,hostName:e,preferDns:i,spareDns:l,bonding:s};return n.post(o+"/systemsetting/mwip",c).then(function(e){return e.data})}function f(e,t){var r={ntpIp:e,activateNtp:t};return n.post(o+"/systemsetting/topology/"+a.id+"/ntp",r).then(function(e){return e.data})}function m(e){return n({url:o+"/strategymanagement/strategyrule/ruledata",data:e,method:"PUT",headers:{"Content-Type":"application/json"}})}function g(e){return n({url:o+"/strategymanagement/strategyrule/ruledata",data:e,method:"PUT",headers:{"Content-Type":"application/json"}})}function h(e){return n({url:o+"/strategymanagement/strategyrule/ruledata",data:e,method:"PUT",headers:{"Content-Type":"application/json"}})}function v(e){var t={runningMode:e.runningMode,autoDiscovery:e.autoDiscovery,remoteMwIp:e.remoteMwIp};return n.post(o+"/systemsetting/runningmode",t).then(function(){})}function y(){return n.get(o+"/systemsetting/runningmode").then(function(e){var n={runningMode:null===e.data?null:e.data.runningMode,autoDiscovery:null===e.data?null:e.data.autoDiscovery,remoteMwIp:null===e.data?null:e.data.remoteMwIp,runningModes:[{mode:1,description:"集中管理"},{mode:2,description:"自管理"}]};return t.centraliztion=1===n.runningMode,n},function(){})}function I(){return q.update({status:"init"}).$promise}function D(){return Y.update().$promise}function T(){return n.post(o+"/systemsetting/factoryreset/mw",{flag:!0})}function b(){return n.post(o+"/systemsetting/restart/mw",{flag:!0})}function S(e){return n.post(o+"/systemsetting/topology/"+e+"/shutdown/mw",{flag:!0})}function P(e,t){return n.post(o+"/systemsetting/topology/"+t+"/factoryreset/dpi",e)}function A(e,t){return n.post(o+"/systemsetting/topology/"+t+"/restart/dpi",e)}function C(e,t){return n.post(o+"/systemsetting/topology/"+t+"/shutdown/dpi",e)}function k(e){return n.post(o+"/systemsetting/ipmac",e).then(function(e){return e.data})}function w(){return n.get(o+"/strategymanagement/strategybuilder/strategycode/IP_LOGIN_MANAGEMENT")}function E(e){return n({url:o+"/strategymanagement/strategyrule/",data:e,method:"POST",headers:{"Content-Type":"application/json"}})}function N(e){return n.delete(o+"/strategymanagement/strategyrule/"+e)}function $(e){return n({url:o+"/strategymanagement/strategyrule/ruledata",data:e,method:"PUT",headers:{"Content-Type":"application/json"}})}function M(e){return n.get(o+"/devices/upgrade?"+e).then(function(e){return e})}function R(e){n.get(o+"/devices/upgrade").then(function(t){for(var n=0;n<t.length;n++)if(e){if(e===t[n].deviceId)return("NONE"!==t[n].state||"NONE"===t[n].state&&0!==t[n].percentage&&100!==t[n].percentage)&&!t[n].error}else if("NONE"!==t[n].state||"NONE"===t[n].state&&0!==t[n].percentage&&100!==t[n].percentage&&!t[n].error)return!0;return!1})}function U(e){return n.post(o+"/devices/upgrade",e)}function _(){return n.get(o+"/files/device/image")}function x(){return n.post(o+"/datasync/synctoallinone")}function O(e){return n({url:o+"/strategymanagement/strategyrule/ruledata",data:e,method:"PUT",headers:{"Content-Type":"application/json"}})}function L(e){return n({url:o+"/strategymanagement/strategyaction/actiondata",data:e,method:"PUT",headers:{"Content-Type":"application/json"}})}function B(){return n.get(o+"/files/console/lastsuccessfulupgrade")}function V(){return n.post(o+"/files/console/upgrade")}function j(e){return n({url:o+"/files/allinone/upgrade",headers:{"Content-Type":"application/json"},data:e,method:"POST"})}function W(){return n.get(o+"/sysbaseinfo/serialnumber")}function F(e){var t={systemTime:e};return n({url:o+"/systemsetting/topology/"+a.id+"/systemtime",headers:{"Content-Type":"application/json"},data:t,method:"POST"})}function H(){return n.get(o+"/systemsetting/getAllUpgradeInfo").then(function(e){return e.data})}function G(e){return n.put(o+"/strategymanagement/strategyrule/"+e.strategyRuleId+"/"+e.disabled)}var z=function(t){return e(o+"/:name",{name:t},{update:{method:"PUT"}})},q=new z("maintenance"),Y=new z("system"),K={getSystemStatus:r,getMaintenance:i,updateMaintenance:u,updateSyslog:d,updateStorageInfo:g,updateIPTrafficInfo:h,initConfig:I,initSystem:D,resetSystem:T,restartSystem:b,shutdownSystem:S,resetDevice:P,restartDevice:A,shutdownDevice:C,getStrategyInfo:l,getJobStrategyInfo:s,ipMac:k,getRemoteIp:w,createRemoteIp:E,deleteRemoteIp:N,updateStradegyJobBuilder:c,updateRemoteIp:$,updateIPAddress:p,updateNtpSync:f,updateStrategyInfo:m,getDPIUpgradeInfo:M,isDPIUpgrading:R,syncDataToAllInOne:x,upgradeDPI:U,getUpgradeImageInfo:_,updateSystemConsoleInfo:O,updateSystemConsoleAction:L,getLastUpgrade:B,startUpgrade:V,startUpgradeAllinOne:j,getSerialNumber:W,setSystemTime:F,saveRunningMode:v,loadRunningMode:y,disableStrategyRule:G,getAllUpgradeInfo:H};return K}e.$inject=["$resource","$rootScope","$http","URI","topologyId"],angular.module("southWest.models").factory("System",e)}(),function(){"use strict";function e(e,t){function n(){return e.get(P+"/").then(function(e){return e.data})}function o(t){return e.get(P+"/role/"+t).then(function(e){return e.data})}function a(){return e.get(t+"/roles/").then(function(e){return e.data})}function r(n){return e.get(t+"/roles/role/"+n).then(function(e){return e.data})}function i(t){return e.put("/api/v2.0/users/user/"+t+"/markasdeleted")}function l(t,n){return e.post("/api/v2.0/systemusers/changeStatus",{data:{index:t,status:n}})}function s(t){return e.post(P,t).then(function(e){return e.data})}function c(t){return e.put("/api/v2.0/user/info",{userId:t.userId,name:t.name,passwordHash:t.password})}function d(t){return e.put("/api/v2.0/users/user/info",t)}function u(){return e.put(P+"/usertoken")}function p(){return e.put("/api/v2.0/users/usertoken")}function f(t,n){return e.put(P+"/user/"+t+"/"+n)}function m(t,n){return e.put(P+"/password",{oldPasswordHash:t,passwordHash:n},{transformRequest:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},headers:{"Content-Type":"application/x-www-form-urlencoded"}})}function g(){return e.get(P).then(function(e){return e.data.length})}function h(t){return e.get("/api/v2.0/roles/role/"+t).then(function(e){return e.data})}function v(t){return e.put("/api/v2.0/roles",{role:{name:t.role.name,comment:t.role.comment,roleId:t.role.roleId,roleLevel:t.role.roleLevel},targetAndActionValueFormList:t.targetAndActionValueFormList,deviceIds:t.deviceIds,customizedMenus:t.customizedMenus})}function y(){return e.get("/api/v2.0/users/whoami").then(function(e){return e.data})}function I(t){return e.post("/api/v2.0/roles",{role:{name:t.role.name,comment:t.role.comment,roleLevel:t.role.roleLevel,parentRoleId:t.parentRoleId},targetAndActionValueFormList:t.targetAndActionValueFormList,customizedMenus:t.customizedMenus})}function D(n){return e.delete(t+"/roles/role/"+n)}function T(){return e.get(P+"/defaultusers").then(function(e){return e.data})}function b(){return e.get(P+"/subtractionSessionNum").then(function(e){return e.data})}function S(){return e.post(P+"/addSessionNum")}var P=t+"/users",A={getUsers:n,getUsersByRoleId:o,getRoles:a,getRolesById:r,deleteUser:i,changeStatus:l,createUser:s,editUserPassword:c,editUser:d,lockUser:f,getUsersCount:g,updateMyPassword:m,userToken:u,keepAlive:p,getUserGroup:h,updateUserGroup:v,getCurrentUser:y,createGroup:I,deleteGroup:D,getDefaultUser:T,subtractionSessionNum:b,addSessionNum:S};return A}e.$inject=["$http","URI"],angular.module("southWest.models").factory("SystemUser",e)}(),function(){"use strict";function e(e,t,n){function o(t,o){return e.get(n.getUrl(o)+a+"/tasks/"+t)}var a=t,r={getTask:o};return r}e.$inject=["$http","URI","UCD"],angular.module("southWest.models").factory("Task",e)}(),function(){"use strict";function e(e,t,n,o){function a(t){return e.get(n.getUrl(o.currentIp)+u+t+"/blocks?lockstatus=NoDeploy")}function r(t,n){var o=new FormData;return o.append("file",t),e({url:u+"rule/policytype/"+n+"/blocktype/template/fileupload",method:"POST",data:o,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}function i(t,n,o,a){return e.post(u+"policy/"+t+"/policytype/"+a+"/blocktype/template/unlock?policyname="+n,o)}function l(t){return e.post(n.getUrl(o.currentIp)+"/api/v2.0/templates/deploy",{data:t})}function s(t,a,r){return e.put(n.getUrl(o.currentIp)+u+"block/"+t+"/signature/"+a,{action:r})}function c(t,a){return e.get(n.getUrl(o.currentIp)+u+"topology/"+n.getDomain(o.currentIp,t.id).topoId+"/incident/"+a+"/action").then(function(e){return e.data})}function d(t,a,r){return e.post(n.getUrl(o.currentIp)+u+"topology/"+n.getDomain(o.currentIp,t.id).topoId+"/incident/"+a+"/action",r).then(function(e){return e.data})}var u=t+"/policies/",p={get:a,uploadTemplate:r,deploy:l,unlock:i,changeAction:s,getSimilarEvent:c,updateSimilarEvent:d};return p}e.$inject=["$http","URI","UCD","$rootScope"],angular.module("southWest.models").factory("Template",e)}(),function(){"use strict";function e(e,t,n,o,a,r){function i(){return n.get(V+"/getAllSecurityZones").then(function(e){return e.data},function(){var e='[{"hidden":false, "nodeZoneId":"05322031-eb2a-4fca-86d2-2918567d71fb", "zoneName":"工作站111"}]';return angular.fromJson(e)})}function l(e){return j.query(e).$promise}function s(e){return n.post(V+a.id+"/validation",{nodes:e.nodes,links:e.links,devices:e.devices,models:e.models})}function c(){return n.get("/api/v2.0/topologies/getFakeTopo")}function d(e,t){return n.get(r.getUrl(e)+V+t+"/allzones")}function u(e){return n.post(V+"node/"+e.id+"/nodeview",{x:e.x,y:e.y})}function p(e,t){return n.put(V+t+"/links",e)}function f(e){return n.put(V+e+"/cleanup")}function m(e,t){return n.post(V+t+"/links",e)}function g(e,t){return n({url:V+t+"/links",method:"DELETE",data:e,headers:{"Content-Type":"application/json"}})}function h(){return n.get(o+"/topologydiscover/currentdiscover")}function v(){return n.get(V).then(function(e){for(var t=e.data,n={},o=0;o<t.length;o++)if(t[o].currentTopology){n=t[o];break}return n})}function y(e){return n.put(V+e.topologyId+"/current")}function I(){return n.get(V)}function D(e,t){return n.get(r.getUrl(t)+V+r.getDomain(t,e).topoId).then(function(e){return e.data})}function T(e,t){return n.get(r.getUrl(t)+V+r.getDomain(t,e).topoId+"/links")}function b(e,t){return n.get(r.getUrl(t)+V+r.getDomain(t,e).topoId+"/devices").then(function(e){return a.hasNode=!1,e.data.length&&(a.hasNode=!0),e})}function S(e,t){return n.get(r.getUrl(t)+V+r.getDomain(t,e).topoId+"/nodes").then(function(e){return e})}function P(e,t){return n.get(r.getUrl(t)+V+"device/"+e+"/nodes").then(function(e){return e.data})}function A(e){return n.get(o+"/topologydiscover/skeleton/"+e)}function C(e){return j.get({fields:"count",status:e}).$promise}function k(e){return j.update(e).$promise}function w(e,t){return n.put(V+e+"/memo",{memo:t})}function E(){return n.put(o+"/topologydiscover/stop")}function N(e){return n({url:"/api/v2.0/search",params:{q:e}})}function $(e){return n.put(V+e+"/configdevices")}function M(e,t){var a=new FormData;return a.append("file",e),n({url:o+"/files/topology/"+t+"/fileupload",method:"POST",data:a,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}function R(e){var t=new FormData;return t.append("file",e),n({url:o+"/files/topologydiscover/topologyskeletonupload",method:"POST",data:t,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}function U(e,t){var a=new FormData;return a.append("topologyImage",e),n({url:o+"/files/topology/"+t+"/imageupload",method:"POST",data:a,transformRequest:angular.identity,headers:{"Content-Type":void 0}})}function _(e){return n.get(o+"/files/topology/"+e+"/filedownload").then(function(e){return e.data})}function x(){return"/images/test/test-topology-image.05771520.jpg"}function O(e){
return n.put(o+"/topologydiscover/"+e+"/startwithoutskeleton")}function L(e){return e?this.getDevices(e).then(function(e){return e.data}):[]}function B(e,t){var a={name:t};return n({url:o+"/topologies/topologyid/"+e,method:"PUT",data:a,headers:{"Content-Type":"application/json"}})}var V=o+"/topologies/",j=t(o+"/topologies/:id",{id:"@id"},{update:{method:"PUT"}}),W={get:l,getCurrentTopo:v,setCurrentTopo:y,getTopo:D,getCount:C,getZones:d,getFakeTopo:c,getTopologies:I,getCurrentDiscover:h,getDiscoverSkeleton:A,cleanup:f,update:k,search:N,deployAllEndpoint:$,upload:M,uploadBackbone:R,uploadImage:U,downloadLink:_,downloadImage:x,updatePosition:u,getNodes:S,getDeviceNodes:P,getLinks:T,getDevices:b,stopTopologyDiscover:E,setMemo:w,updateTopologyDiscoverWithoutSkeleton:O,updateLink:p,addLink:m,deleteLink:g,validateTopo:s,getAllDeviceFull:L,changeTopoName:B,getAllSecurityZones:i};return W}e.$inject=["$rootScope","$resource","$http","URI","topologyId","UCD"],angular.module("southWest.models").factory("Topology",e)}(),function(){"use strict";function e(e,t,n,o,a){function r(){var o=[],r=JSON.parse(localStorage.getItem("customizedMenus"));return!r&&o.push(n.get(e+"/users/customizedMenus")),t.all(o).then(function(e){e.length>0&&e[0].data&&e[0].data.length>0&&!r&&localStorage.setItem("customizedMenus",JSON.stringify(e[0].data)),a.customizedMenus=r?r:e[0].data.filter(function(e){return e.active})},function(){return $.getJSON("js/customizedmenu.json").then(function(e){return a.customizedMenus=e,e})})}function i(){return a.VERSION_NUMBER.slice(-4)}function l(e){var n=e&&e.state?e.state:"myaccount",a=[];t.all(a).then(function(){a.push(o.transitionTo(n)),t.all(a).then(function(){})})}var s={getUI:r,UIversion:i,teleport:l};return s}e.$inject=["URI","$q","$http","$state","$rootScope"],angular.module("southWest.services").factory("uiCtrl",e)}(),function(){"use strict"}(),function(){"use strict";function e(){return{generateAnimatedLogo:function(){var e,t,n;for(e=document.createElement("div"),e.className="animated-logo",t=1;5>t;t++)n=document.createElement("div"),n.className="white-block block-"+t,e.appendChild(n);return e},initializeEngine:function(){var e,t,n=document.getElementById("jumbotron"),o=document.getElementById("jumbotron-content"),a=document.getElementById("typewriter"),r=document.getElementById("login-info");if(n)return t=document.createElement("div"),t.id="galaxy-bg",t.className="galaxy-bg",n.appendChild(t),o.appendChild(this.generateAnimatedLogo()),e=document.createElement("canvas"),e.className="terraform-canvas",n.appendChild(e),new window.Engine(e,t,a,r)}}}angular.module("southWest.services").factory("canvasBg",e)}(),function(){"use strict";function e(){function e(e,t){return _.find(e,function(e){return e.deviceId===t}).name}var t={mapDeviceAndNode:e};return t}angular.module("southWest.services").factory("CommonService",e)}(),function(){"use strict";function e(){return{passwordComplexity:[{name:"低",message:"任意字母、数字或字符，8位或以上，25位以下"},{name:"中",message:"必须是字母加数字和符号，8位或以上，25位以下"},{name:"高",message:"必须是字母加数字和符号，12位或以上，25位以下"}]}}angular.module("southWest.services").factory("constantService",e)}(),function(){"use strict";function e(){var e=new Date,t=e.getMonth()+1,n=t<10?"0"+t:t,o=e.getDate()<10?"0"+e.getDate():e.getDate(),a=e.getHours()<10?"0"+e.getHours():e.getHours(),r=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes(),i="规则-"+e.getFullYear()+"-"+n+"-"+o+"-"+a+":"+r;return{policyName:i}}angular.module("southWest.services").factory("dataservice",e)}(),function(){"use strict";function e(e){return function(t,n){var o={},a={};return function r(i){var l=this,s=arguments;o[i.name]?a[i.name]=!0:(o[i.name]=!0,a[i.name]=!1,t.apply(l,s),e(function(){o[i.name]=!1,a[i.name]&&r.apply(l,s)},n))}}}e.$inject=["$timeout"],angular.module("southWest.services").factory("debounce",e)}(),function(){"use strict";function e(e){var t={};return t.factoryTypes={workstation:"工作站",subnet:"子网",hmi:"HMI",opc_client:"OPC 客户端",opc_server:"OPC 服务器",plc:"PLC","unknown-device":"其它",cnc:"高端数控机床"},t.networkTypes={switch:"网络交换机",router:"路由器","unknown-device":"其它"},t.getFactoryType=function(e){return t.factoryTypes[e]},t.getNetworkType=function(e){return t.networkTypes[e]},t.simplifyModelName=function(t){if(!e.simplifyModelName)return t;if(t&&t.indexOf("/")!==-1){var n=t.split("/"),o=n[0]+"/"+n[1].substring(0,4);return o}return t},t}e.$inject=["$rootScope"],angular.module("southWest.services").factory("deviceTypeService",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i){function l(t){function n(){var n=[];return!t&&n.push(a.getDevices(r.id)),e.all(n).then(function(e){t&&e.push({data:t});for(var n=e[0].data,o=[],a=0;a<n.length;a++){for(var r="",i="",l="",s=0;s<n[a].devicePorts.length;s++)if(n[a].devicePorts[s].isMgmtPort){r=n[a].devicePorts[s].portIp?n[a].devicePorts[s].portIp.split("/")[0]:"",i=n[a].devicePorts[s].portIp?n[a].devicePorts[s].portIp:"",l=n[a].devicePorts[s].mac?n[a].devicePorts[s].mac:"";break}o.push({deviceId:n[a].deviceId,category:n[a].category,iconType:n[a].iconType,ip:r,subnetIp:i,mac:l})}return o})}return r.id?n():i.getDomain().then(function(){return n()})}function s(e,t,n,o){if(!n)return!1;for(var a=0;a<o.length;a++)if(e!==o[a].deviceId&&o[a][t].toLowerCase()===n.toLowerCase())return!0}function c(e,t,n){for(var o=0,a=0;a<n.length;a++)n[a][e]===t&&o++;return!(o<=1)}function d(e,t,n,o,a,r){for(var i=0,l=0;l<o.length;l++)for(var s=o[l][e],c=0;c<s.length;c++)s[c][t]&&s[c][t].toLowerCase()===n.toLowerCase()&&(i++,r&&s[c][a]===r&&i--);return!(i<1)}function u(e,t,n,o){for(var a=0,r=0;r<n.length;r++)if(n[r].deviceId!==t)for(var i=n[r].devicePorts,l=0;l<i.length;l++)i[l][e]&&i[l][e].toLowerCase()===o.toLowerCase()&&a++;return!(a<1)}function p(e,t,n,o){for(var a=0;a<e.length;a++)if(a!==n){var r=e[a];if(t[o]&&t[o].toLowerCase()===r[o].toLowerCase())return!0}return!1}var f={allDevice:l,dupeCheck:s,dupeCheckArrayObject:c,dupeDeepCheckArrayObject:d,dupInOtherDevice:u,checkDupInDevice:p};return f}e.$inject=["$q","$rootScope","$$q","Device","Topology","topologyId","domain"],angular.module("southWest.services").factory("dupeInfo",e)}(),function(){"use strict";angular.module("southWest.services").value("encodeURL",function(e){return e&&Object.keys(e).forEach(function(t){angular.isString(e[t])&&(e[t]=e[t].replace(/\s/g,"%20"))}),e})}(),function(){"use strict";angular.module("southWest.services").factory("Enum",function(){var e={};return{set:function(t,n){e[t]=n},get:function(t){return e[t]}}})}(),function(){"use strict";function e(e,t,n,o){function a(e,t){function n(e){i.push(e)}var o={status:"pdf转化未开始",success:!1};if(!e)return o.status="表格初始化失败，请检查",o;for(var a in e)e.hasOwnProperty(a)&&h.hasOwnProperty(a)&&(e[a]||0===e[a])&&(h[a]=e[a]);h.fullWidth=1070,y.hasOwnProperty(h.theme)&&""!==h.theme||(h.theme="defaults");var r=new jsPDF(h.options,"","","");r.setFontSize(h.fontSize),e.pageNumIndex=[],"html"!==t&&g(e,r),h.pageNumIndex=e.pageNumIndex,h.totalPageNum=e.img&&e.img.length?e.img.length:0,h.totalPageNum=e.img.length,h.firstPageNum=h.firstPageNum>e.pageNumIndex[0]?e.pageNumIndex[0]:h.firstPageNum;var i=[],l=1;if(e.img)for(var s=0;s<e.img.length;s++)d(e.img[s],n);c(null,e.img?h.yOffset+h.chartH*e.img.length+h.lineH*e.img.length:h.yOffset,h,r,h.title,l,i).then(function(){if("html"===t){if(e.img)for(var n=0;n<e.img.length;n++)v=v.replace('<table class="wPDF-table"','<div style="text-align:center;"><img style="width:1000px;height:350px" src="'+i[n]+'"><br /><br /><table class="wPDF-table"');f(v),v=""}else r.save(h.fileName+".pdf"),v=""})}function r(e,t,n,o){for(var a=0;a<e.length;a++)n.addImage(e[a],"JPEG",o.imgxOffset,o.imgyOffset,o.chartW,o.chartH),o.showPageNum&&p(t,o.totalPageNum,n),t<e.length&&n.addPage(t++)}function i(e,t,n){if(e){var o=t?"<table class='wPDF-table' style='background: white; width: "+h.fullWidth+"px; font-size:0.9em;'><thead>":"";o+="<tr style='",o+=h.oddLine?y[h.theme][1]:y[h.theme][2],o+="'>",h.oddLine=!h.oddLine;var a=0;for(var r in e)t?(a++,o+="<th class='col-"+a+"'style='min-width: 110px;'>"+r+"</th>",h.oddLine=!0):(a++,o+="<td style='max-width: 600px;'>"+e[r]+"</td>");return o+=n?"</tr></tbody></table><br /><br />":t?"</tr></thead><tbody>":"</tr>"}return"当前表格数据发生错误，请检查数据"}function l(e){if(e&&e.length){var t="",n=e&&e.length&&e[0];t+=i(n,!0,!1);for(var o=0;o<e.length-1;o++)t+=i(e[o],!1,!1);return t+i(e[e.length-1],!1,!0)}return"blank"}function s(t,n,a,r){var i=e.defer();if(t&&t.length&&a){var l=document.createElement("iframe"),s="auto";return"blank"===t&&(n=0,s="0",t="<table class='wPDF-table'></table>"),r=r?'<div style="margin: 0 auto; width:'+h.fullWidth+'px;"><h2 style="text-align:center; width:100%;">'+r+"</h2></div>":"",l.setAttribute("style","background: white; width: auto; height: "+s+";"),l.setAttribute("id","pdfIframe"),document.body.appendChild(l),o(function(){var e=l.contentDocument||l.contentWindow.document;e.body.innerHTML="<html lang='zh-CN'><head><meta charset='UTF-8'><style>"+y[h.theme][0]+h.styles+"</style></head><body>"+r+t+"</body></html>",v+=v?t:e.body.innerHTML,html2canvas(e.body,{background:"#fff",onrendered:function(e){var t=e.toDataURL("image/jpeg");a.addImage(t,"JPEG",h.xOffset,n),document.body.removeChild(l),i.resolve()}})},10),i.promise}return i.resolve(),i.promise}function c(e,t,n,o,a,i,c){var d=l(null),u=i;return s(d,t,o,a).then(function(){n.showPageNum&&p(u,n.totalPageNum,o),c.length&&r(c,u,o,n)})}function d(e,t,n){var o=new Image;o.crossOrigin="Anonymous",o.onload=function(){var e=document.createElement("CANVAS"),o=e.getContext("2d");e.height=this.height,e.width=this.width,o.drawImage(this,0,0);var a=e.toDataURL(n||"image/jpeg");t(a),e=null},o.src=e}function u(e,t,n){var o=6*n.getStringUnitWidth(e),a=(n.internal.pageSize.width-o)/2;n.text(a,t,e)}function p(e,t,n){n.setFontSize(12),u(e+"/"+t,580,n),n.setFontSize(h.fontSize)}function f(e){try{m(h.fileName+".html",e)}catch(e){}}function m(e,t){var n=window.URL||window.webkitURL||window,o=new Blob([t]),a=document.createElementNS("http://www.w3.org/1999/xhtml","a");a.href=n.createObjectURL(o),a.download=e;var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(r)}function g(e,t){var n=$(".fixed-table-body table"),o=parseInt(n.css("lineHeight")),a=parseInt(n.find("td").css("padding-top")),r=19,i=1,l=0,s=t.internal.pageSize.height;n.find("tbody tr").each(function(t,n){var c=parseInt((parseInt($(n).css("height"))-2*a)/o)*r+2*i;l+=c,l>s?(e.pageNumIndex.push(t),l=c):l>s-30&&0===e.pageNumIndex.length&&!e.img&&(e.pageNumIndex.push(t),l=c)})}var h={fileName:"Report",title:"",chartW:950,chartH:450,imgxOffset:15,imgyOffset:25,firstPageNum:10,NumPerPage:25,xOffset:15,yOffset:25,lineH:15,fontSize:15,showPageNum:!0,totalPageNum:0,options:{orientation:"l",unit:"pt",format:"a4"},styles:"",theme:"",oddLine:!0},v="",y={defaults:["table{border-collapse: collapse;  border: 2px solid black;} table, td, th{border: 1px solid black;} th{color:white; background:gray;}","background:#EEEEEE","background:#CCCCCC"],blueL:["table, td, th{border: none; text-align: center} th{color:white; background:#4F81BD} td{color:black;}","background:#B8CCE4","background:#DBE5F1"],blueD:["table, td, th{border: none; text-align: center} th{color:white; background:black} td{color:white;}","background:#345B91","background:#507FC3"],greenL:["table, td, th{border: none; text-align: center} th{color:white; background:#728F1D} td{color:black;}","background:#C4D896","background:#DAF0D3"],greenD:["table, td, th{border: none; text-align: center} th{color:white; background:black} td{color:white;}","background:#728F1D","background:#9FBF45"],redL:["table, td, th{border: none; text-align: center} th{color:white; background:#90352F} td{color:black;}","background:#F2D8D7","background:#FFEFEF"],redD:["table, td, th{border: none; text-align: center} th{color:white; background:black} td{color:white;}","background:#90352F","background:#BD4F48"]},I={getPdf:a};return I}e.$inject=["$q","$rootScope","$http","$timeout"],angular.module("southWest.services").factory("ePDF",e)}(),function(){"use strict";function e(e,t,n){function o(){return l.isInit||l.totalTodayPromise||(l.totalTodayPromise=n.sysbaseinfo().then(function(n){var o=new Date(n.data||""),a=new Date(o.getFullYear(),o.getMonth(),o.getDate());return e.getCount({$filter:"status eq NEW"},!0).then(function(n){return t.getCount({$filter:"status eq NEW"}).then(function(o){return e.getCount({$filter:"timestamp ge '"+moment(a).utc().format()+"'"},!0).then(function(e){return t.getCount({$filter:"timestamp ge '"+moment(a).utc().format()+"'"}).then(function(t){l.newIncident=n,l.newEvent=o,l.totalNew=n+o,l.todayIncident=e,l.todayEvent=t,l.totalToday=e+t,l.timeGap=l.totalToday>l.countLimitNum[2]?-1:l.totalToday>l.countLimitNum[1]?l.countTimeNum[2]:l.totalToday>l.countLimitNum[0]?l.countTimeNum[1]:l.countTimeNum[0],l.isInit=!0})})})})})),l.totalTodayPromise}function a(e){return l[e]}function r(e,t){l[e]=t,"totalToday"===e&&(l.timeGap=l.totalToday>l.countLimitNum[2]?-1:l.totalToday>l.countLimitNum[1]?l.countTimeNum[2]:l.totalToday>l.countLimitNum[0]?l.countTimeNum[1]:l.countTimeNum[0])}function i(e,t){l[e]+=t,"totalToday"===e&&(l.timeGap=l.totalToday>l.countLimitNum[2]?-1:l.totalToday>l.countLimitNum[1]?l.countTimeNum[2]:l.totalToday>l.countLimitNum[0]?l.countTimeNum[1]:l.countTimeNum[0])}var l={timeGap:5e3,totalIncident:0,newIncident:0,newStrategy:0,totalNew:0,todayIncident:0,todayStrategy:0,totalToday:0,errorIncident:0,newWarnIncident:0,newErrorIncident:0,peakHour:{},countLimitNum:[1e3,5e3,1e4],countTimeNum:[5e3,1e4,2e4],isInit:!1,totalTodayPromise:null},s={init:o,get:a,set:r,change:i};return s}e.$inject=["Incident","Event","apiInfo"],angular.module("southWest.services").factory("evtCnt",e)}(),function(){"use strict";function e(){function e(e){if(void 0===e)return!0;if(!e.match(_))return!0;for(var t=e.split("."),n=0;n<t.length;n++){if(t[n].startsWith("0")&&t[n].length>1)return!0;t[n]=parseInt(t[n])}return 0===t[0]||126===t[0]&&t[1]>155||127===t[0]||126===t[0]&&155===t[1]&&255===t[3]||(0===t[0]||127===t[0]||t[0]>223||("1.0.0.0"===e||"126.255.255.255"===e||"128.0.0.0"===e||"191.255.255.255"===e||"192.0.0.0"===e||"223.255.255.255"===e))}function t(e){return!(e+"").match(W)}function n(e){if(!e.match(x))return!0;for(var t=e.split("."),n=0;n<t.length;n++)if(t[n].startsWith("0")&&t[n].length>1)return!0}function o(e){return!e.match(O)}function a(e){return!e.match(L)}function r(){return j}function i(){return W}function l(){return B}function s(e,t){if(!e.match(B))return!0;var n=e.split("/")[0],o=n.split(".");return o=o.map(function(e){return parseInt(e)}),0===o[0]||127===o[0]||o[0]>223||!t&&("1.0.0.0"===n||"126.255.255.255"===n||"128.0.0.0"===n||"191.255.255.255"===n||"192.0.0.0"===n||"223.255.255.255"===n)}function c(){return _}function d(){return O}function u(){return Q}function p(e,t,n,o){var a="",r=n.split("/");if(t.ip=r[0],2===r.length&&r[0].match(_)&&r[1]&&r[1].match(V)&&r[1]<=32&&r[1]>7){var i="",l=32-parseInt(r[1]);r[1]=parseInt(r[1]);for(var s=0;s<4;s++){var c=r[1]>0?(r[1]=r[1]-8)>0?Array(9).join("1"):Array(r[1]+9).join("1")+Array(1-r[1]).join("0"):"0";a+=parseInt(c,2).toString(),3!==s?a+=".":""}var d=t.ip.split(".");for(s=0;s<d.length;s++){var u=(d[s]>>>0).toString(2);i=i+Array(9-u.length).join("0")+u}e.invalidRange=D(t.deviceId,i,l,o)}else e.invalidRange=!1;t.netMask=a}function f(e){return Q[e]}function m(e){if(!e)return!1;var t=e.split("/");return!(2===t.length&&t[0].match(_)&&t[1]&&t[1]<=32&&t[1]>=8)}function g(e,t){if(!e||!t)return!1;var n=e.split("/"),o=n[0],a=n[1];n=t.split("/");var r=n[0],i=n[1];n=o.split(".");var l=(255&parseInt(n[0]))<<24|(255&parseInt(n[1]))<<16|(255&parseInt(n[2]))<<8|(255&parseInt(n[3]))<<0;n=r.split(".");var s=(255&parseInt(n[0]))<<24|(255&parseInt(n[1]))<<16|(255&parseInt(n[2]))<<8|(255&parseInt(n[3]))<<0;return(l&4294967295<<32-a)===(s&4294967295<<32-a)||(l&4294967295<<32-i)===(s&4294967295<<32-i)}function h(e,t){if(!e||!t)return!1;var n=e.split("/"),o=n[0],a=n[1];n=o.split(".");var r=(255&parseInt(n[0]))<<24|(255&parseInt(n[1]))<<16|(255&parseInt(n[2]))<<8|(255&parseInt(n[3]))<<0;n=t.split(".");var i=(255&parseInt(n[0]))<<24|(255&parseInt(n[1]))<<16|(255&parseInt(n[2]))<<8|(255&parseInt(n[3]))<<0;return(r&4294967295<<32-a)===(i&4294967295<<32-a)}function v(e,t,n){for(var o=0;o<t.length;o++){var a=t[o];if(e.deviceId&&""!==e.deviceId||a.deviceId&&""!==a.deviceId){if(e.deviceId===a.deviceId)continue}else if(e.key===a.key)continue;if("subnet"===a.iconType){if(g(n,a.deviceId&&""!==a.deviceId?a.devicePorts[0].portIp:a.subnetIp))return!0}else if("FACTORY_DEVICE"===a.category){for(var r=0;r<a.devicePorts.length;r++)if(a.devicePorts[r].portIp&&a.devicePorts[r].isMgmtPort&&h(n,a.devicePorts[r].portIp))return!0}else if(a.devicePorts.length)for(var i=0;i<a.devicePorts.length;i++){var l=a.devicePorts[i];if(l.isMgmtPort&&l.portIp&&h(n,l.portIp))return!0}}return!1}function y(e,t){for(var n=0;n<t.length;n++){var o=t[n];if("subnet"===o.iconType)if(o.deviceId&&""!==o.deviceId){if(o.devicePorts.length&&o.devicePorts[0].isMgmtPort&&h(o.devicePorts[0].portIp,e))return!0}else if(o.subnetIp&&h(o.subnetIp,e))return!0}return!1}function I(e,t,n){for(var o=0;o<e.length;o++){var a=e[o];if(a.deviceId!==n&&a.serialNumber===t)return!0}return!1}function D(e,t,n,o){for(var a=!1,r=0;r<o.length;r++)if("FACTORY_DEVICE"===o[r].category&&o[r].ip&&(!e||o[r].deviceId!==e)&&"cloud"!==o[r].iconType){var i=n;"subnet"===o[r].iconType&&32-o[r].subnetIp.split("/")[1]>n&&(i=32-o[r].subnetIp.split("/")[1]);for(var l="",s=o[r].ip.split("."),c=0;c<s.length;c++){var d=(s[c]>>>0).toString(2);l=l+Array(9-d.length).join("0")+d}if(t===l)continue;if(a=parseInt(t,2)>>>i===parseInt(l,2)>>>i)return a}return a}function T(e){var t=e.split(":");if(2!==t.length)return!1;for(var n=[],o=0;o<2;o++){var a=t[o].trim();if(!a.match(/^[0-9]+$/))return!1;var r=parseInt(a);if(r<1||r>65535)return!1;n.push(r)}return!(n[0]>n[1])}function b(e){if(!e.match(F))return!1;for(var t=e.split(","),n=0;n<t.length;n++){var o=t[n].trim();if(o.match(/^[0-9]+$/)){var a=parseInt(o);if(a<1||a>65535)return!1}else{if(!o.match(/^[0-9]+:[0-9]+$/))return!1;if(!T(o))return!1}}return!0}function S(e){return!!e.match(z)}function P(e){return!(e.match(/^[0-9]*$/)&&e<=65535&&e>=0)}function A(e){var t=e.split("/"),n=e.split("-");return!!(2===t.length&&t[0].match(_)&&t[1]&&t[1]<=32&&t[1]>=8)||(!(2!==n.length||!n[0].match(_)||!n[1].match(_))||!!e.match(_))}function C(e){return!!e.match(q)}function k(e){return!!e.match(Y)}function w(t){if(t){var o=t.split("/");if(angular.isArray(o)&&2===o.length){var a=o[0],r=o[1];if(a.length===a.trim().length&&r.length===r.trim().length&&(!s(t)||!e(a)&&!n(r)))return!1}}return!0}function E(t){if(t){var o=t.split("/");if(angular.isArray(o)&&2===o.length){var a=o[0],r=o[1];if(a.length===a.trim().length&&r.length===r.trim().length&&(!s(t,!0)||!e(a)&&!n(r)))return!1}}return!0}function N(e){if(e){if(!s(e))return e;var t=e.split("/");if(2===t.length){for(var n=t[1],o=0;o<Q.length;o++)if(n===Q[o]){n=o;break}return t[0]+"/"+n}}return e}function $(e){var t=e.split(","),n=!0;return t.length>1?t.some(function(e){if(!e.match(W))return n=!1,!0}):e.match(H)||(n=!1),n}function M(e){var t=!0;return e.match(G)||(t=!1),t}function R(e,t){var n=t.indexOf("DISCRETE")>=0,o=t.indexOf("LIMIT")>=0;return n&&o?null!==e.match(K)||null!==e.match(J):n?null!==e.match(K):!o||null!==e.match(J)}function U(e){return!!e&&!!e.match(Z)}var _=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,x=/^(254|252|248|240|224|192|128|0)\.0\.0\.0|255\.(254|252|248|240|224|192|128|0)\.0\.0|255\.255\.(254|252|248|240|224|192|128|0)\.0|255\.255\.255\.(254|252|248|240|224|192|128|0)$/,O=/^(([A-Fa-f0-9]{2}[:]){5}[A-Fa-f0-9]{2}[,]?)+$/,L=/^[a-zA-Z0-9-]{0,62}[a-zA-Z0-9](?:\.[a-zA-Z0-9]{1,62})+$/,B=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)($|(\/([12][0-9]|3[0-2]|[0-9])))$/,V=/^[0-9]+$/,j=/^((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}(-((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}|\/((1|2|3(?=1|2))\d|\d))\b$/,W=/^([0-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])$/,F=/^([0-9]+((\s*)(,|:)(\s*)[0-9]+(\s*))*)$/,H=/^([1-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])(-([1-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])){0,1}$/,G=/^([1-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])(,([1-9]|[1-9]\d|[1-9]\d{2}|[1-9]\d{3}|[1-5]\d{4}|6[0-4]\d{3}|65[0-4]\d{2}|655[0-2]\d|6553[0-5])){0,7}$/,z=/^([A-Za-z][A-Za-z0-9-]*)$/,q=/^[A-Za-z0-9_\-\u4e00-\u9fa5]{3,}$/,Y=/^[A-Za-z0-9_\-\u4e00-\u9fa5]{2,}$/,K=/^(\d|[1-9]\d+)(\.\d+)?([,](\d|[1-9]\d+)(\.\d+)?)*$/,J=/^(\d|[1-9]\d+)(\.\d+)?-(\d|[1-9]\d+)(\.\d+)?$/,Z=/^(?=.*[0-9])(?=.*[!@#$%^&*_])(?=.*[a-zA-Z])[a-zA-Z0-9!@#$%^&*_]{8,25}$/,Q=["0.0.0.0","128.0.0.0","192.0.0.0","224.0.0.0","240.0.0.0","248.0.0.0","252.0.0.0","254.0.0.0","255.0.0.0","255.128.0.0","255.192.0.0","255.224.0.0","255.240.0.0","255.248.0.0","255.252.0.0","255.254.0.0","255.255.0.0","255.255.128.0","255.255.192.0","255.255.224.0","255.255.240.0","255.255.248.0","255.255.252.0","255.255.254.0","255.255.255.0","255.255.255.128","255.255.255.192","255.255.255.224","255.255.255.240","255.255.255.248","255.255.255.252","255.255.255.254","255.255.255.255"],X={validateIp:e,validatePort:t,validateIpRange:s,validateNetMask:n,validateMac:o,validateDomain:a,subnetParser:p,checkRanges:D,getSubnetReg:r,getPortReg:i,getIPRangeReg:l,getIPReg:c,getMACReg:d,getNetMasks:u,subnetValidation:m,checkOverLap:g,subnetOverlap:v,checkIpInSubnet:y,numToNetmask:f,checkSerialNumberDup:I,checkPortInput:b,checkProtocolName:S,checkAuditIpFormat:A,validateFifoAddr:P,validateObjectAssetsName:C,validateShortName:k,validateIpMask:w,validateIpSegment:E,ipLongMaskToIpShortNum:N,validatePortRange:$,validatePortDiscrete:M,validateValueInput:R,validatePsw:U};return X}angular.module("southWest.services").factory("formatVal",e)}(),function(){"use strict";angular.module("southWest.services").factory("heartbeat",["$interval","$http","URI",function(e,t,n){function o(){t.get(n+"/heartbeat",{ignoreLoadingBar:!0})}function a(){l||(l=!0,o(),i=e(function(){o()},5e3))}function r(){e.cancel(i),l=!1}var i,l=!1;return{start:a,end:r}}])}(),function(){"use strict";function e(){function e(e,t,n){for(var o=[],a=[],r=[],i=e.length,l=0;l<i;l++)o.push(e[l].flowIn),a.push(e[l].flowOut),r.push(e[l].x);var s={options:{credits:{enabled:!1},legend:{itemHoverStyle:{color:"#76B900",fontWeight:"bold"},itemStyle:{color:"#AAAAAA"},x:0,y:10},chart:{spacingRight:20,spacingLeft:20,style:{width:"auto",fontFamily:"SourceHanSansCN-Regular, Helvetica, Arial, sans-serif"},backgroundColor:"#272930",height:240,type:"spline",animation:Highcharts.svg},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",borderWidth:0,style:{color:"#E4E4E4"},shared:!0,formatter:function(){var e="时间：<b>"+this.points[0].key+"</b><br/>";return this.points.reduce(function(e,t){return e+t.series.name+"：<b>"+t.y+n+"</b><br/>"},e)}},plotOptions:{},yAxis:{allowDecimals:!1,minRange:1,title:{text:"流量",align:"high",offset:0,rotation:0,y:-20,style:{fontSize:"14px"}},gridLineWidth:0,labels:{style:{color:"#999999"},formatter:function(){return this.value+n}},lineColor:"#283754",lineWidth:2},xAxis:{lineColor:"#283754",lineWidth:2,tickPixelInterval:1,minRange:.5,gridLineWidth:0,minorGridLineColor:"#1f2c3f",minorTickInterval:1,startOnTick:!0,labels:{style:{color:"#999999"}},tickmarkPlacement:"on",tickColor:"#ccd6eb",tickLength:10,tickInterval:1,categories:r,nameToX:!1,crosshair:{enabled:!0}}},series:[{type:"area",name:"输入流量",color:"#4c76e4",fillOpacity:.2,data:o},{type:"area",name:"输出流量 ",color:"#64f035",fillOpacity:.2,data:a}],title:{style:{color:"#E4E4E4",fontSize:"14px"},text:t},loading:!1};return s}function t(e){var t=jQuery.isEmptyObject(e)?0:e.COVERAGE,n={options:{credits:{enabled:!1},chart:{type:"pie",backgroundColor:"#262626",margin:0},title:{text:null},tooltip:{enabled:!1},plotOptions:{pie:{allowPointSelect:!1,borderWidth:0,borderColor:"#262626",dataLabels:{enabled:!1},states:{hover:{enabled:!1}}}}},series:[{animation:!1,name:"InnerCircle",data:[{y:1,color:"#AAA"}],innerSize:"70%",size:"62%"},{animation:!0,name:"MainGraph",data:[{y:t,color:"rgba(245,166,35, 1.0)"},{y:1-t,color:"rgba(245,166,35,0.15)"}],innerSize:"80%"}]};return n}function n(e){var t=jQuery.isEmptyObject(e)?0:e.statsValue,n={options:{credits:{enabled:!1},chart:{type:"pie",backgroundColor:"#262626",margin:0},title:{text:null},tooltip:{enabled:!1},plotOptions:{pie:{allowPointSelect:!1,borderWidth:0,borderColor:"#262626",dataLabels:{enabled:!1},states:{hover:{enabled:!1}}}}},series:[{animation:!1,name:"Run1",data:[{name:"Run1",y:1,color:"#AAA"}],innerSize:"70%",size:"62%"},{animation:!0,name:"Run2",data:[{name:"Run2",y:t,color:"#76B900"},{name:"",y:1-t,color:"rgba(118,185,0,0.15)"}],innerSize:"80%"}]};return n}function o(){var e={options:{credits:{enabled:!1},chart:{backgroundColor:"#262626",margin:0,type:"pie"},tooltip:{enabled:!1},plotOptions:{pie:{data:[{name:"安全",color:"#4A90E2",y:17},{name:"未验证",color:"#AAA",y:50},{name:"危险",color:"#D8711A",y:33}],borderWidth:0,innerSize:"30%",slicedOffset:0,size:"75%"}}},series:[{name:"percentage",type:"pie",dataLabels:{enabled:!0,formatter:function(){return Math.round(100*this.percentage)/100+" %"},distance:-20,style:{fontWeight:"bold"},color:"white"}},{name:"outerLabels",type:"pie",dataLabels:{softConnector:!1,connectorWidth:0,useHTML:!0,verticalAlign:"top",distance:20,style:{fontSize:"14px",fontWeight:"bold"},formatter:function(){if(0!==this.percentage)return'<span style="color:'+this.point.color+'">'+this.point.name+"</span>"}}}],title:{text:null},loading:!1};return e}function a(e,t,n,o,a,r){var i=[],l=[],s={orange:"#ffc521",red:"#fe540f",blue:"#4284f3",green:"#76B900",purple:"#6000C0"};if(r)for(var c=0;c<r.length;c++)r[c]=s[r[c]]||r[c];else{r=[];for(var d=0;d<360;d+=360/t.length){var u={};u.hue=d,u.saturation=90+10*Math.random(),u.lightness=50+10*Math.random(),r.push("hsl("+u.hue+","+u.saturation+"%,"+u.lightness+"%)")}}for(var p=0;p<e.length;p++){i.push({name:t[p],data:[]});for(var f=0;f<e[p].length;f++){var m=new Date(e[p][f].flowTimestamp||e[p][f].timestamp);"hourly"===o?m=(m.getHours()>9?m.getHours().toString():"0"+m.getHours().toString())+":"+(m.getMinutes()>9?m.getMinutes().toString():"0"+m.getMinutes().toString()):"daily"===o&&(m=m.getFullYear().toString()+"-"+(m.getMonth()>9?(m.getMonth()+1).toString():"0"+(m.getMonth()+1).toString())+"-"+(m.getDate()>9?m.getDate().toString():"0"+m.getDate().toString())),0===p&&l.push(m),i[p].data.push(parseInt(e[p][f].value))}}var g={chart:{backgroundColor:"#292d38",type:"column",style:{fontFamily:"SourceHanSansCN-Regular, Helvetica, Arial, sans-serif"}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",borderWidth:0,style:{color:"#E4E4E4"},pointFormatter:function(){if(this.y>0)return'<span style="color:'+this.series.color+'">'+this.series.name+"</span>: <b>"+this.y+"</b><br/>"},shared:!0,hideDelay:0},title:{text:n,style:{color:"#E4E4E4"}},colors:r,plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:"#E4E4E4",style:{textShadow:"0 0 3px black",opacity:100}}},series:{borderWidth:0,dataLabels:{enabled:!0,formatter:function(){if(this.y>0&&this.point.shapeArgs.height>10)return this.y}}}},xAxis:{categories:l,labels:{style:{color:"#999999"}},lineColor:"#434343",lineWidth:1,tickLength:0},yAxis:{allowDecimals:!1,min:0,gridLineColor:"#3E3E3E",labels:{style:{color:"#999999"}},lineColor:"#434343",lineWidth:1,title:{text:a,style:{color:"#A0A0A3"}}},legend:{itemStyle:{color:"#CCCCCC"},itemHoverStyle:{color:"#FFF"},itemHiddenStyle:{color:"#606063"}},series:i};return g}function r(e,t,n,o,a){var r=[],i=[];t=t?t:"规则事件";var l={orange:"#ffc521",red:"#fe540f",blue:"#4284f3",green:"#76B900",purple:"#6000C0"};if(a)for(var s=0;s<a.length;s++)a[s]=l[a[s]]||a[s];else{a=[];for(var c=0;c<360;c+=360/t.length){var d={};d.hue=c,d.saturation=90+10*Math.random(),d.lightness=50+10*Math.random(),a.push("hsl("+d.hue+","+d.saturation+"%,"+d.lightness+"%)")}}r.push({name:t[0],data:[]});for(var u=0;u<e.length;u++)i.push(e[u].signatureName),r[0].data.push(parseInt(e[u].signatureCount));var p={chart:{backgroundColor:"#292d38",type:"column",style:{fontFamily:"SourceHanSansCN-Regular, Helvetica, Arial, sans-serif"}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",borderWidth:0,style:{color:"#E4E4E4"},shared:!0,hideDelay:0},title:{text:n,style:{color:"#E4E4E4"}},colors:a,plotOptions:{column:{stacking:"normal",dataLabels:{enabled:!0,color:"#E4E4E4",style:{textShadow:"0 0 3px black"}}},series:{color:"#D08515",borderWidth:0,dataLabels:{enabled:!0,formatter:function(){if(this.y>0)return this.y}}}},scrollbar:{enabled:!0},xAxis:{categories:i,labels:{style:{color:"#999999"},formatter:function(){return Number.isInteger(this.value)?"":this.value}},lineColor:"#434343",lineWidth:1,tickLength:0,min:0,max:10},yAxis:{allowDecimals:!1,min:0,gridLineColor:"#3E3E3E",labels:{style:{color:"#999999"}},lineColor:"#434343",lineWidth:1,title:{text:o,style:{color:"#A0A0A3"}}},legend:{itemStyle:{color:"#CCCCCC"},itemHoverStyle:{color:"#FFF"},itemHiddenStyle:{color:"#606063"}},series:r};return p}var i={createAreaChartConfig:e,createVulPieChartConfig:t,createItgPieChartConfig:n,getAtkPieChartConfig:o,createBarChartStdConfig:a,createRuleBarChartStdConfig:r};return i}angular.module("southWest.services").factory("HCConfig",e)}(),function(){"use strict";function e(e){return function(t,n,o,a,r){if("signature"===o){var i=[];a.forEach(function(e){i.push(e.policyBlockId)}),e.availableBlocks(n,o,i).then(function(e){t.blockCount=0,t.selectedBlockCount=0,t.selectedSignatureCount=0,t.selectAll=t.selectAllSigs||!1;for(var n=0;n<a.length;n++)a[n].checked=t.selectAllSigs||!1,t.selectedBlockCount=t.selectAllSigs?t.totalNum:0,t.blockCount+=a[n]._signaturesCount,t.blockCount+=a[n]._rulesCount,_.contains(e.data,a[n].policyBlockId)||(a[n].deployed=!0);r&&r(a)})}else e.getPolicyBlockbyPolicyId(n,"ReadyDeploy").then(function(e){t.blockCount=0,t.selectedBlockCount=0,t.selectedSignatureCount=0,t.selectAll=t.selectAllSigs||!1;for(var n=0;n<a.length;n++){a[n].checked=t.selectAllSigs||!1,t.blockCount+=a[n]._signaturesCount,t.blockCount+=a[n]._rulesCount;for(var o=0;o<e.data.length;o++)a[n].policyBlockId===e.data[o].sourceId&&(a[n].deployed=!0)}r&&r(a)})}}e.$inject=["Signature"],angular.module("southWest.services").factory("initializeData",e)}(),function(){"use strict";function e(e,t,n,o){return{request:function(t){var a=["$top","$skip","$select","$from","$filter","$groupby","$orderby","$limit"],r=[];if(t.params||t.url.indexOf("?")>0){var i=t.url.split("?")[1];t.params=t.params||{},i&&_.extend(t.params,_.object(i.split("&").map(function(e){return e.split("=")}))),t.params=_.omit(t.params,function(e,t){if(a.indexOf(t)>=0)return r.push([t,e].join("=")),!0}),r.length&&_.extend(t.params,{encrypt:btoa(n.encrypt(r.join("&"),o.secretKey))}),t.url=t.url.split("?")[0]}return e(function(e){e(t)})},responseError:function(n){var o=t.get("auth");return 401!==n.status&&403!==n.status||o.clear(),e.reject(n)}}}e.$inject=["$q","$injector","$crypto","$rootScope"],angular.module("southWest.services").factory("unauthorized",e)}(),function(){"use strict";function e(e,t){function n(n,o){var a="capstone_"+t.getUserName();if(a){var r=JSON.parse(e.localStorage[a]||"{}");r[n]=o,e.localStorage[a]=JSON.stringify(r)}}function o(n){var o="capstone_"+t.getUserName();if(o){var a=JSON.parse(e.localStorage[o]||"{}");return a[n]}}function a(){var n="capstone_"+t.getUserName();n&&(e.localStorage[n]=JSON.stringify({}))}var r={set:n,get:o,clear:a};return r}e.$inject=["$window","auth"],angular.module("southWest.services").constant("localStorage",window.localStorage).factory("lclStorage",e);
}(),function(){"use strict";function e(e,t){function n(){return t.get("js/logo.json").then(function(t){e.logo=t.data})}var o={getLogo:n};return o}e.$inject=["$rootScope","$http"],angular.module("southWest.services").factory("logo",e)}(),function(){"use strict";function e(e){function t(e,t){var n;return n="中"===t?/^(?=.*[0-9])(?=.*[!@#$%^&*_])(?=.*[a-zA-Z])[a-zA-Z0-9!@#$%^&*_]{8,25}$/:"低"===t?/^[a-zA-Z0-9!@#$%^&*_]{8,25}$/:/^(?=.*[0-9])(?=.*[!@#$%^&*_])(?=.*[a-zA-Z])[a-zA-Z0-9!@#$%^&*_]{12,25}$/,!!e.match(n)}function n(e,n,o,a){var r={oldPassValid:0,newPassValid:0,confirmPassValid:0,allValid:!1};return e&&(r.oldPassValid=2),n&&(t(n,a)?r.newPassValid=2:r.newPassValid=1),2===r.newPassValid&&(n===o?r.confirmPassValid=2:r.confirmPassValid=1),2===r.oldPassValid&&2===r.newPassValid&&2===r.confirmPassValid&&(r.allValid=!0),r}function o(e,n,o){var a={newPassValid:0,confirmPassValid:0,allValid:!1};return e&&(t(e,o)?a.newPassValid=2:a.newPassValid=1),2===a.newPassValid&&(e===n?a.confirmPassValid=2:a.confirmPassValid=1),2===a.newPassValid&&2===a.confirmPassValid&&(a.allValid=!0),a}function a(e){for(var t=0;t<e.length;t++)if("PASSWORD_COMPLEXITY_MANAGEMENT"===e[t].strategyInfo.strategyCode)return e[t];return!1}function r(t){for(var n=0;n<e.passwordComplexity.length;n++){var o=e.passwordComplexity[n];if(o.name===t)return o.message}return""}return{validatePassword:t,validator:o,validatorWithOld:n,getPassComplexity:a,getPassComplexityMessage:r,errorMessages:{oldPass:"当前密码不能为空",newPass:"密码不符合规则",confirmPass:"密码输入不一致"}}}e.$inject=["constantService"],angular.module("southWest.services").factory("passwordValidationService",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l){function s(s){1===n.getUserType()?e.transitionTo("domain"):o.getDevices(r.id).then(function(n){var o;n.data.length?l.isC05&&"高级安全审计员"===t.get("Role")[0].name?e.go("monitor.logger"):l.isC05&&"高级系统管理员"===t.get("Role")[0].name?e.go("setting.systemconsole"):i.findLand("OVERVIEW",1):(s||(s="REAL_TIME_PROTECTION"),a.getDeviceDiscoverred().then(function(n){var a=t.get("privilege").filter(function(e){return"SYSTEM_MANAGEMENT"===e.name})[0].actionValue;n.data.length?(o=t.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue,1===o?a>1?e.transitionTo("setting.systemconsole"):e.transitionTo("myaccount"):e.transitionTo("asset.securitydevice")):(o=t.get("privilege").filter(function(e){return"TOPOLOGY"===e.name})[0].actionValue,1===o?a>1?e.transitionTo("setting.systemconsole"):e.transitionTo("myaccount"):e.transitionTo("topology.singleTopo"))}))})}var c={teleport:s};return c}e.$inject=["$state","Enum","auth","Topology","Device","topologyId","uiCtrl","$rootScope"],angular.module("southWest.services").factory("redirect",e)}(),function(){"use strict";function e(e,t){function n(n){return t.get("js/resource"+n+".json").then(function(t){e.resource=t.data})}var o={getResource:n};return o}e.$inject=["$rootScope","$http"],angular.module("southWest.services").factory("resource",e)}(),function(){"use strict";function e(e,t,n){function o(e,o){t.createPolicy().then(function(t){n.go("rule."+e+".editor",{policyId:t.data.value,tab:o})})}function a(e){for(var t=e.fields,n=0;n<t.length;n++)if("协议"===t[n].name)return t[n].value;return""}function r(e){if(e.createdAt){var t=new Date(e.createdAt+" UTC");return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()+" "+t.getHours()+":"+t.getMinutes()+":"+t.getSeconds()}return""}function i(e){for(var t=e.fields,n=0;n<t.length;n++)if("sourcePort"===t[n].name)return t[n].value;return""}function l(e){for(var t=e.fields,n=0;n<t.length;n++)if("destinationPort"===t[n].name)return t[n].value;return""}return{createPolicy:o,getProtocolType:a,getRuleCreatedAt:r,getSourcePort:i,getDestinationPort:l}}e.$inject=["$rootScope","Signature","$state"],angular.module("southWest.services").factory("ruleService",e)}(),function(){"use strict";function e(e,t){return function(n,o){var a=n;a.enabledEditRuleItem=!0,a.editRules=!1,a.editRuleItem=!1,a.currentTree={},a.ruleItem={},a.selectedRuleItems=[],a.policyBlocks.selectAll=!1,a.createRuleItem=function(){a.editRules=!0,a.currentTree={};var t={currentValue:"[]"};e.getData(t).then(function(e){var t=e.data.nodeTree;a.generateTree(t.nodes)})},a.confirmCreateRule=function(){a.editRules=!1,a.editRuleItem=!1;var t=[];for(var n in a.currentTree)if(a.currentTree[n]&&!a.currentTree[n].active){var o={};o.name=a.currentTree[n].nodeDisplayName,o.value=a.currentTree[n].nodeDisplayValue,t.push(o)}if(t.length>0){var r={};r.priority=a.policyBlocks.rules.length,r.action="DROP",r.fields=t,e.createRule(a.policyBlocks.policyBlockId,r).then(function(e){e.data.checked=!1,a.policyBlocks.rules.push(e.data),a.policyBlocks._rulesCount++})}},a.modifyRuleItem=function(t,n){a.editRules=!0,a.editRuleItem=!0,a.ruleItem=n,a.ruleItemIndex=t;var o={currentValue:angular.toJson(n.fields)};e.getData(o).then(function(e){var t=e.data.nodeTree;a.currentTree=t.nodes,a.generateTree(t.nodes)})},a.confirmRuleEdit=function(){a.editRules=!1;var e=[];for(var n in a.currentTree)if(a.currentTree[n]&&!a.currentTree[n].active){var o={};o.name=a.currentTree[n].nodeDisplayName,o.value=a.currentTree[n].nodeDisplayValue,e.push(o)}t.changeFields(a.policyBlocks.policyBlockId,a.ruleItem.ruleId,e).then(function(e){e.data.checked=a.policyBlocks.rules[a.ruleItemIndex].checked,a.policyBlocks.rules[a.ruleItemIndex]=e.data,a.editRuleItem=!1})},a.cancelRuleEdit=function(){a.editRules=!1,$("#diagram","*").empty()},a.selectRuleItem=function(e){e.checked?(a.selectedRuleItems.push(e.ruleId),a.selectedRuleItems.length===a.policyBlocks.rules.length&&(a.policyBlocks.selectAll=!0)):(a.selectedRuleItems=_.without(a.selectedRuleItems,e.ruleId),a.policyBlocks.selectAll=!1)},a.selectAllRuleItem=function(){a.selectedRuleItems=[],a.policyBlocks.rules.forEach(function(e){e.checked=a.policyBlocks.selectAll,a.policyBlocks.selectAll&&a.selectedRuleItems.push(e.ruleId)})},a.deleteRuleItems=function(){e.deleteRule(a.selectedRuleItems).then(function(e){a.selectedRuleItems.forEach(function(e){var t=_.findIndex(a.policyBlocks.rules,{ruleId:e});a.policyBlocks.rules.splice(t,1),a.policyBlocks._rulesCount--,a.selectedRuleItems=_.without(a.selectedRuleItems,e),a.policyBlocks.selectAll=!1,a.rulePagination&&(a.rulePagination.totalNum-=1,a.rulePagination.numPages=Math.ceil(a.rulePagination.totalNum/a.rulePagination.numPerPage),0===a.policyBlocks.rules.length&&a.rulePagination.currentPage===a.rulePagination.numPages&&(a.rulePagination.currentPage-=1)),_.isObject(o)&&_.isArray(o.data)&&(o.data.splice(_.findIndex(o.data,{ruleId:e}),1),_.isFunction(a.pageChanged)&&a.pageChanged())})})},a.moveUp=function(){var t=a.selectedRuleItems[0],n=_.findIndex(a.policyBlocks.rules,{ruleId:t});if(0!==n){var o=a.policyBlocks.rules[n].priority,r=a.policyBlocks.rules[n-1].priority,i={};i.ruleId=t,i.currentOrder=o,i.targetOrder=r,e.changePriority(a.policyBlocks.policyBlockId,i).then(function(e){a.policyBlocks.rules=e.data,a.policyBlocks.rules.forEach(function(e){e.ruleId===a.selectedRuleItems[0]?e.checked=!0:e.checked=!1})})}},a.moveDown=function(){var t=a.selectedRuleItems[0],n=_.findIndex(a.policyBlocks.rules,{ruleId:t});if(n!==a.policyBlocks.rules.length-1){var o=a.policyBlocks.rules[n].priority,r=a.policyBlocks.rules[n+1].priority,i={};i.ruleId=t,i.currentOrder=o,i.targetOrder=r,e.changePriority(a.policyBlocks.policyBlockId,i).then(function(e){a.policyBlocks.rules=e.data,a.policyBlocks.rules.forEach(function(e){e.ruleId===a.selectedRuleItems[0]?e.checked=!0:e.checked=!1})})}}}}e.$inject=["Custom","Signature"],angular.module("southWest.services").factory("ruleItemEdit",e)}(),function(){"use strict";angular.module("southWest.services").factory("ServiceWorker",["$q",function(e){function t(e){e&&e.postMessage({type:"heartbeat"}),setInterval(function(){e&&e.postMessage({type:"heartbeat"})},3e3)}function n(){return e(function(e){l=l||navigator.serviceWorker.controller,l?e(l):setTimeout(function(){e(n())},1e3)})}function o(){"serviceWorker"in navigator&&(navigator.serviceWorker.ready.then(function(){n().then(function(e){t(e)})}),navigator.serviceWorker.register("/sw.js").then(function(e){l=navigator.serviceWorker.controller?navigator.serviceWorker.controller:e.active}).catch(function(e){}),navigator.serviceWorker.addEventListener("message",function(e){s[e.data.key]&&s[e.data.key].call(null,e)}))}function a(e){n().then(function(t){t&&t.postMessage(e)})}function r(e,t){"function"==typeof t&&(s[e]=t)}function i(e){"string"==typeof e&&(e={key:e}),a({type:"broadcast",message:e})}var l,s={};return{init:o,postMessage:a,getController:n,broadcast:i,on:r}}])}(),function(){"use strict";function e(){function e(e){if(!e||16!==e.length)return!1;var t=e.slice(2,4);if(isNaN(t))return!1;var n=e.slice(4,6);if(isNaN(n))return!1;var o=e.slice(6,7);if(!o.match(/[A-Z]/))return!1;var a=e.slice(7,8);if(isNaN(a)){if(!a.match(/[A-C]/))return!1}else if("0"===a)return!1;var r=e.slice(8);return!isNaN(r)}function t(e,t){var n,o={};if(e&&e.length>=4){var a=e.slice(0,2);if("JA"===a||"JC"===a||"JS"===a)n="KEA";else if("SC"===a)n="KED";else if("ZB"===a)n="KEV";else{if("SS"!==a)return"";n="KEC"}var r=e.slice(2,4),i=e.slice(4,6);if("01"===r){if("JA"===a||"JS"===a)return"";n+="KEC"===n?"-U1000":"-C200"}else if("02"===r){if("JA"===a||"JC"===a||"SS"===a)return"";n+="-C400"}else if("03"===r){if("JC"===a||"JS"===a||"SS"===a)return"";n+="KEA"===n?"02"===i?"-U1000E":"-U1000":"-U800"}else if("04"===r){if("JC"===a||"JS"===a||"SS"===a)return"";n+="KEA"===n?"-U2000":"-U1600"}else{if("05"!==r)return"";if("JC"===a||"JS"===a||"SS"===a)return"";n+="-U1142"}for(var l in t)if(l&&t[l].iconType&&t[l].model===n){o.id=t[l].modelId,o.modelName=t[l].model_name+" / "+t[l].model,o.model=n;break}}return o}var n={validSNFormat:e,getModelBySN:t};return n}angular.module("southWest.services").factory("snVal",e)}(),function(){"use strict";function e(e){var t={};return t.timeOffset=0,t.initialized=!1,t.init=function(){return t.localTime=new Date,e.sysbaseinfo().then(function(e){t.serverTime=new Date(e.data),t.initialized||(t.updateClock(),t.initialized=!0)}),t},t.updateClock=function(){t.localTime.setTime(t.localTime.getTime()+1e3),t.serverTime.setTime(t.serverTime.getTime()+1e3),setTimeout(t.updateClock,1e3)},t}function t(){return function(e,t,n){return e?e.slice(t,n):null}}function n(e,t){var n;return{getTime:function(){return n?t.resolve((new Date).getTime()+n):e.sysbaseinfo().then(function(e){var t=new Date(e.data).getTime();return n=t-(new Date).getTime(),t})},clearCache:function(){n=void 0}}}e.$inject=["apiInfo"],n.$inject=["apiInfo","$q"],angular.module("southWest.services").factory("timerService",e).factory("serverTime",n).filter("fromToFilter",t)}(),function(){"use strict";angular.module("southWest.services").value("topologyId",{id:"",hasNode:!1})}(),function(){"use strict";function e(){function e(e){var t=" Byte";return e>0&&(e>1024&&(e=Math.floor(e/10.24)/100,t=" KB"),e>1024&&(e=Math.floor(e/10.24)/100,t=" MB"),e>1024&&(e=Math.floor(e/10.24)/100,t=" GB"),e>1024&&(e=Math.floor(e/10.24)/100,t=" TB")),e+=t}function t(e,t){if(e>0){if("Byte"===t)return e;if("KB"===t)return e=Math.floor(e/10.24)/100;if("MB"===t)return e=Math.floor(e/10485.76)/100;if("GB"===t)return e=Math.floor(e/10737418.24)/100;if("TB"===t)return e=Math.floor(e/10995116277.76)/100}return e}var n={formatTrafficDataWithUnit:e,formatTrafficDataWithoutUnit:t};return n}angular.module("southWest.services").factory("trafficDataService",e)}(),function(){"use strict";function e(e,t,n){return function(o){function a(e){return"string"!=typeof e?e:e.replace(/[\u00A0-\u9999<>\&]/gim,function(e){return"&#"+e.charCodeAt(0)+";"})}var r=o;r.setSelectedItem=function(e,t){_.contains(r.array[e].value,t)?(r.array[e].value=_.without(r.array[e].value,t),r.customValueIndex?r.customValueIndex--:0,0===r.array[e].value.length&&r.array[e].value.push("请选择"),r.array[e].selectAll=!1):(r.array[e].value=_.without(r.array[e].value,"请选择"),r.array[e].value.push(t),r.array[e].value.length===r.array[e].options.length&&(r.array[e].selectAll=!0))},r.selectAll=function(e){if(_.forEach(r.array[e].options,function(t){t.checked=r.array[e].selectAll,r.array[e].selectAll&&(r.array[e].value=_.without(r.array[e].value,"请选择"),_.contains(r.array[e].value,t.name)||r.array[e].value.push(t.name))}),!r.array[e].selectAll)if(r.customValueIndex>=0){var t=r.array[e].value[r.customValueIndex];r.array[e].value=[],r.array[e].value.push(t),r.customValueIndex=0}else r.array[e].value=[],r.array[e].value.push("请选择")},r.useCustomValue=function(e){r.array[e].custom.enableCustomValue?(r.array[e].value=_.without(r.array[e].value,"请选择"),r.customValueIndex=r.array[e].value.length,r.array[e].value[r.customValueIndex]=""===r.array[e].custom.customValue?"自定义":r.array[e].custom.customValue,r.updateCustomValue(e)):(r.array[e].value.splice(r.customValueIndex,1),0===r.array[e].value.length&&r.array[e].value.push("请选择"),r.array[e].custom.showBracket=!1)},r.changeProtocol=function(e,t){r.array[e].value=[],r.array[e].value.push(t)},r.updateCustomValue=function(e){var t=!1;"fifo地址"!==r.array[e].name&&"起始地址"!==r.array[e].name&&"终止地址"!==r.array[e].name||(r.array[e].custom.invalid=n.validateFifoAddr(r.array[e].custom.customValue)),r.array[e].custom.customValue.toString().indexOf("[")===-1&&r.array[e].custom.customValue.toString().indexOf("]")===-1||(t=!0),r.array[e].value[r.customValueIndex]=""===r.array[e].custom.customValue?"自定义":r.array[e].custom.customValue,r.array[e].custom.customValue.toString().split(",").length>1&&!t?r.array[e].custom.showBracket=!0:r.array[e].custom.showBracket=!1},r.confirmPreviousChange=function(e){function t(e){r.array[e].childrenIds&&r.array[e].childrenIds.forEach(function(e){return n.push(e),t(e)})}var n=[];t(e);for(var o=n.length-1;o>=0;o--)r.array.splice(n[o]);r.redraw()},r.cancelPreivousChange=function(){angular.copy(r.arrayCopy,r.array),r.editPreviousItem=!1},r.showOptions=function(e){angular.copy(r.arrayCopy,r.array);var n=[],o=[];angular.copy(r.array[e].value,n);var a=[];angular.copy(r.array,a),_.forEach(r.array,function(e){e.showOption=!1});var i=[];if(0===e)i=[];else{a[e].value=[];for(var l=0;l<a.length;l++){var s={};s.name=a[l].name,a[l].value=_.without(a[l].value,"请选择"),a[l].value=_.without(a[l].value,"自定义"),a[l].value.length>0&&(s.value=a[l].value.toString(),i.push(s))}}var c={currentValue:JSON.stringify(i)};t.getData(c).then(function(t){var a=t.data.nodeTree,i=e,l=a.nodes[i].nodeDisplayValue.split(",");l=_.without(l,"NONSTANDARD"),l=_.without(l,"所有协议"),r.array[e].options=[];for(var s=0;s<l.length;s++)_.contains(r.array[e].value,l[s])?(r.array[e].options.push({name:l[s],checked:!0}),o.push(l[s]),n=_.without(n,l[s])):r.array[e].options.push({name:l[s],checked:!1});if(angular.copy(o,r.array[e].value),n.length>0&&(r.customValueIndex=r.array[e].value.length,r.array[e].value[r.customValueIndex]=n.toString()),_.isEqual(l,o)?r.array[e].selectAll=!0:r.array[e].selectAll=!1,n.length>0){r.array[e].custom={enableCustomValue:!0,customValue:n.toString(),showBracket:!1};var c=!1;n.toString().indexOf("[")===-1&&n.toString().indexOf("]")===-1||(c=!0),n.length>1&&!c&&(r.array[e].custom.showBracket=!0)}else r.array[e].custom={enableCustomValue:!1,customValue:"",showBracket:!1};r.editPreviousItem=!0})},r.generateTree=function(t){$("#diagram","*").empty();var n=$("#diagram");r.canCreateRule=!0,r.canEditRule=!0;var o=!1,i=!1;if("modbus"===t[0].nodeDisplayValue&&void 0!==t[2]&&!t[2].active&&void 0!==t[3]&&!t[3].active){var l=parseInt(t[2].nodeDisplayValue),s=parseInt(t[3].nodeDisplayValue);l>s&&(r.canCreateRule=!1,r.canEditRule=!1,r.arrayCopy[2].value[0]!==r.array[2].value[0]&&(o=!0),r.arrayCopy[3].value[0]!==r.array[3].value[0]&&(i=!0))}r.array=[],r.previousOptions=[];var c=0;for(var d in t)if(t[d]){var u={};u.name=t[d].nodeDisplayName,u.childrenIds=t[d].childrenIds,u.checked=!1,r.array.push(u);var p="";if(t[d].active){var f=t[d].nodeDisplayValue.split(",");f=_.without(f,"NONSTANDARD"),f=_.without(f,"所有协议"),u.options=[];for(var m=0;m<f.length;m++)u.options.push({name:f[m],checked:!1});u.showOption=!1,u.selectAll=!1,u.custom={enableCustomValue:!1,customValue:"",showBracket:!1},u.value=["请选择"],p='<span class="signature-padding-height signature-text-content" ng-show="editPreviousItem" ng-click="cancelPreivousChange()">{{array['+c+'].value.toString()}}</span><span ng-show="'+c+'==0 && !editPreviousItem"><div class="dropdown display-inline-block" dropdown><button type="button" class="btn btn-default dropdown-toggle btn-text-overflow" dropdown-toggle>{{array['+c+'].value.toString()}}<span class="caret"></span></button><ul class="dropdown-menu" role="menu"><li ng-repeat="option in array['+c+'].options"><p ng-click="changeProtocol('+c+',option.name)">{{option.name}}</p></li></ul></div></span><span ng-show="'+c+'>0 && !editPreviousItem"><div class="dropdown display-inline-block" dropdown><button type="button" class="btn btn-default dropdown-toggle btn-text-overflow" dropdown-toggle><span ng-if="array['+c+"].value.length >1 || array["+c+'].custom.showBracket">{</span>{{array['+c+'].value.toString()}}<span class="caret"></span><span ng-if="array['+c+"].value.length >1 || array["+c+'].custom.showBracket">}</span></button><ul class="dropdown-menu tree" role="menu"><li><div class="signature-dropdown-list"><input custom-checkbox class="input-checkbox-signature" type="checkbox" ng-model="array['+c+'].custom.enableCustomValue" ng-change="useCustomValue('+c+')"/><input class="input-text-signature" type="text" ng-disabled="!array['+c+'].custom.enableCustomValue" ng-change="updateCustomValue('+c+')" ng-model="array['+c+'].custom.customValue" placeholder="自定义"/><span class="input-alert-error" ng-if="array['+c+"].custom.enableCustomValue && array["+c+'].custom.invalid">请输入合法的值</span></div></li><li ng-if="array['+c+'].options.length>0"><div class="signature-dropdown-list"><label><input custom-checkbox class="input-checkbox-signature" type="checkbox" ng-model="array['+c+'].selectAll" ng-change="selectAll('+c+')">All</label></div></li><li class="divider" ng-if="array['+c+'].options.length>0"></li><li ng-repeat="option in array['+c+'].options"><div class="signature-dropdown-list"><label><input custom-checkbox class="input-checkbox-signature" type="checkbox" ng-model="option.checked" ng-change="setSelectedItem('+c+', option.name)">{{option.name | ellipsis:"30"}}</label></div></li></ul></div></span><button class="btn btn-default" ng-if="!editPreviousItem" ng-disabled="array['+c+'].custom.invalid" ng-click="redraw()"><i class="fa fa-check-circle icon-left"></i>确定编辑</button></span>'}else u.value=t[d].nodeDisplayValue.replace(/[{}]/g,"").split(","),p='<span class="signature-padding-height signature-text-content" ng-hide="array['+c+'].showOption" ng-click="showOptions('+c+"); array["+c+'].showOption = true">'+a(t[d].nodeDisplayValue)+'</span><span ng-show="array['+c+"].showOption && "+c+'==0"><div class="dropdown display-inline-block" dropdown><button type="button" class="btn btn-default dropdown-toggle btn-text-overflow" data-toggle="previousDropdown" dropdown-toggle>{{array['+c+'].value.toString()}}<span class="caret"></span></button><ul class="dropdown-menu previous" role="menu"><li ng-repeat="option in array['+c+'].options"><p ng-click="changeProtocol('+c+',option.name)">{{option.name}}</p></li></ul></div></span><span ng-show="array['+c+"].showOption && "+c+'>0"><div class="dropdown display-inline-block" dropdown><button type="button" class="btn btn-default dropdown-toggle btn-text-overflow" data-toggle="dropdown" dropdown-toggle><span ng-if="array['+c+"].value.length >1 || array["+c+'].custom.showBracket">{</span>{{array['+c+'].value.toString()}}<span class="caret"></span><span ng-if="array['+c+"].value.length >1 || array["+c+'].custom.showBracket">}</span></button><ul class="dropdown-menu previous-tree" role="menu"><li><div class="signature-dropdown-list"><input custom-checkbox class="input-checkbox-signature" type="checkbox" ng-model="array['+c+'].custom.enableCustomValue" ng-change="useCustomValue('+c+')"/><input class="input-text-signature" type="text" ng-disabled="!array['+c+'].custom.enableCustomValue" ng-change="updateCustomValue('+c+')" ng-model="array['+c+'].custom.customValue" placeholder="自定义"/><span class="input-alert-error" ng-if="array['+c+"].custom.enableCustomValue && array["+c+'].custom.invalid">请输入合法的值</span></div></li><li ng-if="array['+c+'].options.length>0"><input class="input-checkbox-signature" type="checkbox" ng-model="array['+c+'].selectAll" ng-change="selectAll('+c+')"> All</li><li class="divider" ng-if="array['+c+'].options.length>0"></li><li ng-repeat="option in array['+c+'].options"><div class="signature-dropdown-list"><label><input custom-checkbox class="input-checkbox-signature" type="checkbox" ng-model="option.checked" ng-change="setSelectedItem('+c+', option.name)">{{option.name | ellipsis:"30"}}</label></div></li></ul></div></span><button class="btn btn-default" ng-disabled="array['+c+'].custom.invalid" ng-click="confirmPreviousChange('+c+')" ng-show="array['+c+'].showOption"><i class="fa fa-check-circle icon-left"></i>确定编辑</button><button class="btn btn-default" ng-click="cancelPreivousChange()" ng-show="array['+c+'].showOption"><i class="fa fa-times-circle icon-left"></i>取消编辑</button>',o&&2===c&&(p+='<span class="input-alert-error">终止地址必须大于或者等于起始地址</span>'),i&&3===c&&(p+='<span class="input-alert-error">终止地址必须大于或者等于起始地址</span>');r.arrayCopy=[],angular.copy(r.array,r.arrayCopy);var g,h=t[d].childrenIds?"hasChild":"",v="<li data-id='"+a(t[d].valueNodeId)+"' class='"+h+"'><span class='signature-padding-height'><span id='diamond'></span>"+a(t[d].nodeDisplayName)+": </span>"+p+"</li>",y=angular.element(v),I=e(y)(r);if(0===t[d].valueNodeId)g=n;else{var D=n.find("li[data-id='"+a(t[d].parentId)+"']");0===D.find("ul.tree").length&&D.append("<ul class='tree'>"),g=D.find("ul.tree:first")}g.append(I),$(".dropdown-menu.tree").click(function(e){e.stopPropagation()}),$(".dropdown-menu.previous-tree").click(function(e){e.stopPropagation()}),c++}},r.redraw=function(){for(var e=r.array.length-1;e>=0;e--)(_.contains(r.array[e].value,"请选择")||_.contains(r.array[e].value,"自定义"))&&(r.array[e].value=_.without(r.array[e].value,"自定义"),r.array[e].value=_.without(r.array[e].value,"请选择"),0===r.array[e].value.length&&r.array.splice(e,1));for(var n=[],o=0;o<r.array.length;o++){var a={};if(a.name=r.array[o].name,r.array[o].value.length>1)a.value="{"+r.array[o].value.toString()+"}";else{var i=!1;r.array[o].value.toString().indexOf("[")===-1&&r.array[o].value.toString().indexOf("]")===-1||(i=!0),r.array[o].value.toString().split(",").length>1&&!i?a.value="{"+r.array[o].value.toString()+"}":a.value=r.array[o].value.toString()}n.push(a)}var l={currentValue:JSON.stringify(n)};t.getData(l).then(function(e){var t=e.data.nodeTree;r.showOption=!1,r.currentTree=t.nodes,r.generateTree(t.nodes),r.editPreviousItem=!1})}}}e.$inject=["$compile","Custom","formatVal"],angular.module("southWest.services").factory("tree",e)}(),function(){"use strict";function e(e,t){function n(e,n){var o=t.ucdInfo.filter(function(t){t.ip===e})[0];o&&(o.topoId=n)}function o(e,n){var o;return e?t.ucdInfo?(o=t.ucdInfo.filter(function(t){return t.ip===e})[0])?o:void 0:{topoId:null}:{topoId:n}}function a(e,n,o){return t.isProduction?e?(n?n:"https://")+e:"":e?(n?n:"http://")+e+(o?o:":3000"):""}function r(){return t.ucdInfo}function i(e){var n=t.ucdInfo.filter(function(t){t.ip===e.ip})[0];n?n.topoId=e.topoId:t.ucdInfo.push(e)}function l(e){for(var n=0;n<t.ucdInfo.length;n++)if(t.ucdInfo[n].ip===e)return t.ucdInfo.splice(n,1),!0;return!1}var s={setDomain:n,getDomain:o,getUrl:a,getAllDomains:r,addDomain:i,removeDomain:l};return s}e.$inject=["$q","$rootScope"],angular.module("southWest.services").factory("UCD",e)}(),function(){"use strict";function e(e){function t(t){r(u),u=new d(0,"","","Root","","Root",null,null);for(var a=0;a<e.config.dashboard.length;a++)n(e.config.dashboard[a].target)&&u.addChild(new d(1,e.config.dashboard[a].target,e.config.dashboard[a].state,e.config.dashboard[a].name,e.config.dashboard[a].icon,e.config.dashboard[a].name,[],u));o("MONITOR",e.config.dashboard[0].children,u.getChild("MONITOR"),t),o("SESSION",e.config.dashboard[1].children,u.getChild("SESSION"),t),o("RULE",e.config.dashboard[2].children,u.getChild("RULE"),t),o("NETWORK",e.config.dashboard[3].children,u.getChild("NETWORK"),t),o("OBJECT",e.config.dashboard[4].children,u.getChild("OBJECT"),t),o("STRATEGY",e.config.dashboard[5].children,u.getChild("STRATEGY"),t),o("SETTING",e.config.dashboard[6].children,u.getChild("SETTING"),t),e.rootMenu=u}function n(t){var n=e.customizedMenus.filter(function(e){return e.target===t});return n&&n[0]&&n[0].active}function o(e,t,o,r){if(void 0!==t&&null!==t&&t.length>0){var i=u.getChilds().filter(function(t){return t.getTarget()===e});if(i=i&&i[0]?i[0]:null)for(var l=0;l<t.length;l++)if(n(t[l].target)){var s;1===r&&"SETTING"===e&&"SETTING_USERCONTROL"===t[l].target?(s=new d(2,t[l+1].target,t[l+1].state,t[l+1].name,t[l+1].icon,t[l+1].name,[],o),a(t[l+1].children,s)):(s=new d(2,t[l].target,t[l].state,t[l].name,t[l].icon,t[l].name,[],o),a(t[l].children,s)),i.addChild(s)}}}function a(e,t){if(t&&void 0!==e&&e.length>0)for(var o=0;o<e.length;o++)n(e[o].target)&&t.addChild(new d(3,e[o].target,e[o].state,e[o].name,e[o].icon,e[o].name,[],t))}function r(e){if(e.getChilds()!==[]&&e.getChilds())for(var t=0;t<e.getChilds().length;t++)r(e.getChilds()[t]);e.getParent()&&e.setParent(void 0),e=void 0}function i(e){var t=u.getChild(e);if(t)return t;for(var n=0;n<u.getChilds().length;n++)if(t=u.getChilds()[n].getChild(e))return t}function l(e){var t=i(e);if(t)return t.getParent()?t.getParent():null}function s(e){var t=l(e);if(t)return t.getChilds().filter(function(t){return t.getTarget()!==e})}function c(e){var t=u.getChilds().filter(function(t){return t.getTarget()===e});if(t.length)return t[0];for(var n=0;n<u.getChilds().length;n++){t=u.getChilds()[n].getChilds();for(var o=0;o<t.length;o++)if(t[o].getTarget()===e)return t[o]}}var d=function(e,t,n,o,a,r,i,l,s){var c=e?e:1,d=t?t:"",u=n?n:"",p=o?o:"",f=a?a:"",m=r?r:"",g=i?i:[],h=l?l:null,v=!!s&&s;this.setLevel=function(e){c=e},this.getLevel=function(){return c},this.setTarget=function(e){d=e},this.getTarget=function(){return d},this.setState=function(e){u=e},this.getState=function(){return u},this.setName=function(e){p=e},this.getName=function(){return p},this.setIcon=function(e){f=e},this.getIcon=function(){return f},this.setDescription=function(e){m=e},this.getDescription=function(){return m},this.setParent=function(e){h=e},this.getParent=function(){return h},this.addChild=function(e){g.push(e)},this.getChilds=function(){return g},this.getChild=function(e){var t=g.filter(function(t){return t.getTarget()===e});return t&&t[0]?t[0]:null},this.getSiblings=function(){return this.getParent().getChilds().filter(function(e){return e.getTarget()!==d})},this.getChildByState=function(e){var t=g.filter(function(t){return t.getState()===e});return t&&t[0]?t[0]:null},this.level=c,this.target=d,this.state=u,this.name=p,this.icon=f,this.description=m,this.child=g,this.parent=h,this.expanded=v},u=new d(0,"","","Root","","Root",null,null);u.content=[];var p={init:t,getCurrentNode:i,getParentNode:l,getSiblingNodes:s,getNode:c};return p}e.$inject=["$rootScope"],angular.module("southWest.services").factory("uiTree",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s){function c(e,t,n){return i.sysbaseinfo().then(function(o){t.now=new Date(o.data||""),t.now.setMilliseconds(0),t.startdt=t.now;var a=t.startdt.getFullYear(),r=t.startdt.getMonth()+1;r<10&&(r="0"+r);var i=t.startdt.getDate();i<10&&(i="0"+i);var l=a+"-"+r+"-"+i;t.minDate=l,t.maxDate=angular.copy(n),t.maxTime=new Date(t.maxDate);var s=t.maxTime.getHours();t.maxTime.setHours(s+t.maxTime.getTimezoneOffset()/60+24),t.maxTime.setMinutes(0),t.maxTime.setSeconds(0),t.enddt=moment(t.now).add(2,"minutes").toDate(),t.interval.minutes=2,t.interval.hours=0,t.interval.days=0,t.intervalError=!1,e&&(t.startdt=new Date(e.startDatetime),t.enddt=new Date(e.endDatetime)),t.startdt_date=t.startdt,t.startdt_time=t.startdt,t.enddt_date=t.enddt,t.enddt_time=t.enddt})}function d(e){if(e.interval.minutes>=60){var t=Math.floor(e.interval.minutes/60);e.interval.hours=+(e.interval.hours?e.interval.hours:0)+t,e.interval.minutes=e.interval.minutes%60}if(e.interval.hours>=24){var n=Math.floor(e.interval.hours/24);e.interval.days=+(e.interval.days?e.interval.days:0)+n,e.interval.hours=e.interval.hours%24}}function u(e,n,o){e||t.getDeployedPolicy(o).then(function(e){n.inUsePolicy=e.data})}function p(e){if(e.intervalError=!1,e.intervalErrorMessage="",!(e.interval.days&&"0"!==e.interval.days.toString()||e.interval.hours&&"0"!==e.interval.hours.toString()||e.interval.minutes&&"0"!==e.interval.minutes.toString()))return e.intervalError=!0,void(e.intervalErrorMessage="请输入学习时间");if(e.interval.days&&(isNaN(e.interval.days)?(e.intervalError=!0,e.intervalErrorMessage=e.intervalErrorMessage+" 请在天数区域输入数字"):e.interval.days<0&&(e.intervalError=!0,e.intervalErrorMessage=e.intervalErrorMessage+" 请输入大于0的天数")),e.interval.hours&&(isNaN(e.interval.hours)?(e.intervalError=!0,e.intervalErrorMessage=e.intervalErrorMessage+" 请在小时数区域输入数字"):e.interval.hours<0&&(e.intervalError=!0,e.intervalErrorMessage=e.intervalErrorMessage+" 请输入大于0的小时数")),e.interval.minutes&&(isNaN(e.interval.minutes)?(e.intervalError=!0,e.intervalErrorMessage=e.intervalErrorMessage+" 请在分钟数区域输入数字"):e.interval.minutes<0&&(e.intervalError=!0,e.intervalErrorMessage=e.intervalErrorMessage+" 请输入大于0的分钟数")),!e.intervalError){var t=864e5,n=36e5,o=6e4,a=new Date;a=new Date(a.getTime()+5184e9+59e3);var r=a.getTime(),i=new Date;i=i.getTime()+(e.interval.days?e.interval.days*t:0)+(e.interval.hours?e.interval.hours*n:0)+(e.interval.minutes?e.interval.minutes*o:0);var l=r-i;return Math.round(l/o)<1?(e.intervalError=!0,void(e.intervalErrorMessage="请输入少于60000天的学习时间")):void 0}}function f(e){var t=n.params;t.tab=e;var o=n.current.name;n.go(o,t,{reload:!1,inherit:!0,notify:!1})}function m(e,t){i.sysbaseinfo().then(function(n){t.now=new Date(n.data||""),t.now.setMilliseconds(0);var o=t.now.getTime()-t.startdt.getTime();if(o<=0)t.changeLearning(e);else{if(!(o<6e4))return;t.startdt=t.now,t.changeLearning(e)}})}function g(e,t){for(var n=""+e;n.length<t;)n="0"+n;return n}function h(t,n){var o=(new Date).getTimezoneOffset();o=(o<0?"+":"-")+g(parseInt(Math.abs(o/60)),2)+g(Math.abs(o%60),2);var a={startTime:n.startdt.toISOString(),endTime:n.enddt.toISOString(),timeZoneOffset:o};e.updateLearningTask(t.taskId,a).then(function(){n.learningDetail(t.taskId)}),n.editLearningDetail=!1}function v(t){e.getLearningTasks().then(function(e){if(t.learningTasks=e.data,0===t.learningTasks.length)t.initialView=!0,t.enableAddSchedule=!0;else{t.initialView=!1,t.enableAddSchedule=!0,o.disableDeploy=!1;for(var n=0;n<t.learningTasks.length;n++)"PROCESSING"!==t.learningTasks[n].state&&"PAUSED"!==t.learningTasks[n].state||(o.disableDeploy=!0),"PENDING"!==t.learningTasks[n].state&&"PROCESSING"!==t.learningTasks[n].state&&"PAUSED"!==t.learningTasks[n].state||(I(t.learningTasks[n].taskId,t),t.learningTaskId=t.learningTasks[n].taskId,t.enableAddSchedule=!1)}})}function y(e,t,n){i.sysbaseinfo().then(function(o){function r(t){n.countDownloop=a(function(){var o=new Date,a=Date.UTC(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate(),o.getUTCHours(),o.getUTCMinutes(),o.getUTCSeconds());u=l-(a+t),u<=0&&(n.stopCountDown(),u=0),n.remainTime.days=Math.floor(u/864e5),n.remainTime.hours=Math.floor((u-1e3*n.remainTime.days*3600*24)/36e5),n.remainTime.minutes=Math.floor((u-1e3*n.remainTime.days*3600*24-3600*n.remainTime.hours*1e3)/6e4),n.remainTime.seconds=Math.floor((u-1e3*n.remainTime.days*3600*24-3600*n.remainTime.hours*1e3-60*n.remainTime.minutes*1e3)/1e3);var r=100*(1-u/Math.abs(new Date(e.endDatetime).getTime()-new Date(e.startDatetime).getTime()));r<n.value||(n.value=r)},1e3)}n.remainTime={};var i=new Date(o.data||"").getTime(),l=new Date(e.endDatetime).getTime(),s=new Date,c=Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds()),d=i-c,u=l-i;
u<0&&(u=0),n.remainTime.days=Math.floor(u/864e5),n.remainTime.hours=Math.floor((u-1e3*n.remainTime.days*3600*24)/36e5),n.remainTime.minutes=Math.floor((u-1e3*n.remainTime.days*3600*24-3600*n.remainTime.hours*1e3)/6e4),n.remainTime.seconds=Math.floor((u-1e3*n.remainTime.days*3600*24-3600*n.remainTime.hours*1e3-60*n.remainTime.minutes*1e3)/1e3),n.value=100*(1-u/Math.abs(new Date(e.endDatetime).getTime()-new Date(e.startDatetime).getTime())),t&&"PAUSED"===t||r(d)})}function I(t,n,o){n.taskId=t,e.getTask(t).then(function(a){e.getTaskMac(t).then(function(t){o&&o.$broadcast("refreshTask"),e.getLearningBlocksByRef(a.data._resultRef.baseUrls[0]).then(function(e){n.countOfICRules=e.data.length}),n.detailPanelItem=a.data,n.detailPanelItem.macData=t.data,n.detailPanelItem.startDatetimeLocal=new Date(n.detailPanelItem.startDatetime).toLocaleString(navigator.language,{hour12:!1}),n.detailPanelItem.endDatetimeLocal=new Date(n.detailPanelItem.endDatetime).toLocaleString(navigator.language,{hour12:!1}),n.detailPanelItem.timeDiff=Math.abs(new Date(n.detailPanelItem.startDatetime).getTime()-new Date(n.detailPanelItem.endDatetime).getTime()),n.detailPanelItem.difference={},n.detailPanelItem.difference.days=Math.floor(n.detailPanelItem.timeDiff/864e5),n.detailPanelItem.difference.hours=Math.floor((n.detailPanelItem.timeDiff-1e3*n.detailPanelItem.difference.days*3600*24)/36e5),n.detailPanelItem.difference.mins=(n.detailPanelItem.timeDiff-1e3*n.detailPanelItem.difference.days*3600*24-3600*n.detailPanelItem.difference.hours*1e3)/6e4})})}function D(e){i.sysbaseinfo().then(function(t){e.now=new Date(t.data||""),e.now.setMilliseconds(0);var n,o=e.now.getTime()-e.startdt.getTime();if(o<=0)e.enddt=moment(e.startdt).add(e.interval).toDate(),n=6e4*(e.startdt.getTimezoneOffset()-e.enddt.getTimezoneOffset()),e.enddt=moment(e.enddt).add(n).toDate(),e.setTime();else{if(!(o<6e4))return;e.startdt=e.now,e.enddt=moment(e.startdt).add(e.interval).toDate(),n=6e4*(e.startdt.getTimezoneOffset()-e.enddt.getTimezoneOffset()),e.enddt=moment(e.enddt).add(n).toDate(),e.setTime()}})}function T(t){var n=(new Date).getTimezoneOffset();n=(n<0?"+":"-")+g(parseInt(Math.abs(n/60)),2)+g(Math.abs(n%60),2);var a={startTime:t.startdt.toISOString(),endTime:t.enddt.toISOString(),taskName:t.startdt.toLocaleString(navigator.language,{hour12:!1})+"至"+t.enddt.toLocaleString(navigator.language,{hour12:!1})+"规则学习",timeZoneOffset:n,learningTypes:["WHITELIST"]},r=s.defer();o.protocolDeployTaskPromise=r.promise,e.createLearningTask(a).then(function(e){"REJECT"===e.data.state?(o.addAlert({type:"danger",content:"创建学习任务失败"}),r.resolve("fail"),t.startLearningDefer&&t.startLearningDefer.resolve("fail")):(r.resolve("success"),o.addAlert({type:"success",content:"创建学习任务成功"})),t.checklearningTasks()},function(e){r.resolve("fail"),t.startLearningDefer&&t.startLearningDefer.resolve("fail"),e&&e.data&&e.data.rejectReason?o.addAlert({type:"danger",content:e.data.rejectReason}):o.addAlert({type:"danger",content:"创建学习任务失败"})})}function b(t,n,o){e.pause(t.taskId).then(function(){n.currentlyLearning=!1,o.$broadcast("refreshTask")})}function S(t,n,o){e.resume(t.taskId).then(function(){n.currentlyLearning=!0,o.$broadcast("refreshTask")})}function P(t,n,a){e.stop(t.taskId).then(function(){delete n.detailPanelItem,n.stopCountDown(),n.stopLearningDefer=s.defer(),o.protocolDeployTaskPromise=n.stopLearningDefer.promise,a.$broadcast("refreshTask")})}function A(e){o.$broadcast("refreshPreDeployTable",e)}function C(e){e.$broadcast(n.params.tab)}function k(e,n,o,a,i){o.policyBlock=e,o.rule=n.data[0],o.policy=i.data;for(var l=0;l<o.rule.fields.length;l++){var s=o.rule.fields[l];o.rule[s.name]=s.value}o.rule.protocolType=o.rule["协议"].toUpperCase(),o.getRuleAction=function(e){var t={REJECTBOTH:"阻断",DROP:"丢弃",ALERT:"警告",ALLOW:"允许"};return t[e]},o.getRuleRiskLevel=function(e){var t={LOW:"低",MEDIUM:"中",HIGH:"高"};return t[e]},o.cancel=function(){a.dismiss("cancel")},o.changeAction=function(n,o){t.changeAction(e.policyBlockId,n.ruleId,o)},o.changeRiskLevel=function(e,n){e.riskLevel=n,t.changeRuleRiskLevel(r.id,e.ruleId,n)}}function w(e,n,o,a,r,i){var s=a.policyBlockId;e.enableEdit=!0,e.rulePagination={currentPage:1,numPerPage:5,totalNum:0},e.rulePagination.totalNum=o.data.length,e.rulePagination.numPages=parseInt(e.rulePagination.totalNum/e.rulePagination.numPerPage),"SIGNATURE"===a.type?a.signatures=o.data:(a.rules=o.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage),a.rules.forEach(function(e){e.checked=!1})),e.policyBlocks=a,r(e),i(e,o),e.changeAction=function(e,n){e.action=n,"SIGNATURE"===a.type?l.changeAction(s,e.signatureId,n).then(function(){}):t.changeAction(s,e.ruleId,n).then(function(){})},e.pageChanged=function(){a.rules=o.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage),a.rules.forEach(function(e){e.checked=!1})},e.changeRiskLevel=function(e,n){e.riskLevel=n,t.changeRuleRiskLevel(e.ruleId,e.riskLevel).then(function(e){})},e.ok=function(){n.close("ok")},e.cancel=function(){n.dismiss("cancel")}}var E={initTimePicker:c,calculateValues:d,checkInUsepolicy:u,changeInterval:p,changeURL:f,changeLearningInterval:m,changeLearning:h,checklearningTasks:v,countdown:y,learningDetail:I,setTimeInterval:D,setTime:T,pauseLearning:b,resumeLearning:S,cancelLearning:P,refreshPreDeployTable:A,moveToPreDeployTable:C,showIpRuleDetailCtrl:["policyBlock","items","$scope","$modalInstance","policy",k],showWhiteListRuleDetailCtrl:["$scope","$modalInstance","items","policyBlock","tree","ruleItemEdit",w]};return E}e.$inject=["Learning","Signature","$state","$rootScope","$interval","topologyId","apiInfo","Template","$q"],angular.module("southWest.services").factory("WhiteListService",e)}(),function(){"use strict";function e(e,t,n,o){function a(e,t){function n(e){p.push(e)}var o={status:"pdf转化未开始",success:!1};if(!e)return o.status="表格初始化失败，请检查",o;if(!(e.fieldName&&e.fieldName.length&&e.fieldIndex&&e.fieldIndex.length))return o.status="当前表格数据发生错误，请检查",o;if(e.fieldName.length!==e.fieldIndex.length)return o.status="表头与表格内容列数不一致，请检查",o;var a=i(e.data,e.fieldName,e.fieldIndex);for(var r in e)e.hasOwnProperty(r)&&v.hasOwnProperty(r)&&(e[r]||0===e[r])&&(v[r]=e[r]);v.fullWidth=1070,I.hasOwnProperty(v.theme)&&""!==v.theme||(v.theme="defaults");var l=new jsPDF(v.options,"","","");l.setFontSize(v.fontSize),e.pageNumIndex=[];var s=Math.ceil((a.length-v.firstPageNum)/v.NumPerPage);if("html"!==t)h(e,l);else{for(var c=1;c<s;c++)e.pageNumIndex.push(v.NumPerPage*c);e.pageNumIndex.push(a.length)}v.pageNumIndex=e.pageNumIndex,v.totalPageNum=(s<e.pageNumIndex.length?e.pageNumIndex.length:s)+(e.img&&e.img.length?e.img.length:0),0===e.data.length&&e.img&&(v.totalPageNum=e.img.length),v.firstPageNum=v.firstPageNum>e.pageNumIndex[0]?e.pageNumIndex[0]:v.firstPageNum;var p=[],f=1;if(e.img)for(var g=0;g<e.img.length;g++)u(e.img[g],n);d(a,e.img?v.yOffset+v.chartH*e.img.length+v.lineH*e.img.length:v.yOffset,v,l,v.title,f,p).then(function(){if("html"===t){if(e.img)for(var n=0;n<e.img.length;n++)y=y.replace('<table class="wPDF-table"','<img src="'+p[n]+'"><br /><br /><table class="wPDF-table"');m(y),y=""}else l.save(v.fileName+".pdf"),y=""})}function r(e,t,n,o){for(var a=0;a<e.length;a++)n.addImage(e[a],"JPEG",o.imgxOffset,o.imgyOffset,o.chartW,o.chartH),o.showPageNum&&f(t,o.totalPageNum,n),t<e.length&&n.addPage(t++)}function i(e,t,n){for(var o=[],a=0;a<e.length;a++){for(var r={},i=0;i<t.length;i++){var l=e[a].protocolSourceName;"GOOSE"!==l&&"SV"!==l&&"PNRTDCP"!==l||"sourceIp"!==n[i]&&"destinationIp"!==n[i]?r[t[i]]=e[a][n[i]]:r[t[i]]=""}o.push(r)}return o}function l(e,t,n){if(e){var o=t?"<table class='wPDF-table' style='background: white; width: "+v.fullWidth+"px; font-size:0.9em;'><thead>":"";o+="<tr style='",o+=v.oddLine?I[v.theme][1]:I[v.theme][2],o+="'>",v.oddLine=!v.oddLine;var a=0;for(var r in e)t?(a++,o+="<th class='col-"+a+"'style='min-width: 110px;'>"+r+"</th>",v.oddLine=!0):(a++,o+="<td style='max-width: 600px;'>"+e[r]+"</td>");return o+=n?"</tr></tbody></table><br /><br />":t?"</tr></thead><tbody>":"</tr>"}return"当前表格数据发生错误，请检查数据"}function s(e){if(e&&e.length){var t="",n=e&&e.length&&e[0];t+=l(n,!0,!1);for(var o=0;o<e.length-1;o++)t+=l(e[o],!1,!1);return t+l(e[e.length-1],!1,!0)}return"blank"}function c(t,n,a,r){var i=e.defer();if(t&&t.length&&a){var l=document.createElement("iframe"),s="auto";return"blank"===t&&(n=0,s="0",t="<table class='wPDF-table'></table>"),r=r?'<div style="width:'+v.fullWidth+'px;"><h2 style="text-align:center; width:100%;">'+r+"</h2></div>":"",l.setAttribute("style","background: white; width: auto; height: "+s+";"),l.setAttribute("id","pdfIframe"),document.body.appendChild(l),o(function(){var e=l.contentDocument||l.contentWindow.document;e.body.innerHTML="<html lang='zh-CN'><head><meta charset='UTF-8'><style>"+I[v.theme][0]+v.styles+"</style></head><body>"+r+t+"</body></html>",y+=y?t:e.body.innerHTML,html2canvas(e.body,{background:"#fff",onrendered:function(e){var t=e.toDataURL("image/jpeg");a.addImage(t,"JPEG",v.xOffset,n),document.body.removeChild(l),i.resolve()}})},10),i.promise}return i.resolve(),i.promise}function d(t,n,o,a,i,l,d){var u=s(t.slice(0,o.firstPageNum)),p=l;return c(u,n,a,i).then(function(){if(o.showPageNum&&f(p,o.totalPageNum,a),d.length&&r(d,p,a,o),t.length>o.firstPageNum){var n=[],i=e.when({});0===o.firstPageNum&&n.push(t.slice(0,o.pageNumIndex[0]));for(var l=0;l+1<o.pageNumIndex.length;l++)n.push(t.slice(o.pageNumIndex[l],o.pageNumIndex[l+1]));return n.forEach(function(e){i=i.then(function(){return a.addPage(p++),c(s(e),o.yOffset,a).then(function(){o.showPageNum&&f(p+(d.length?d.length-1:0),o.totalPageNum,a)})})}),i.then(function(){})}})}function u(e,t,n){var o=new Image;o.crossOrigin="Anonymous",o.onload=function(){var e=document.createElement("CANVAS"),o=e.getContext("2d");e.height=this.height,e.width=this.width,o.drawImage(this,0,0);var a=e.toDataURL(n||"image/jpeg");t(a),e=null},o.src=e}function p(e,t,n){var o=6*n.getStringUnitWidth(e),a=(n.internal.pageSize.width-o)/2;n.text(a,t,e)}function f(e,t,n){n.setFontSize(12),p(e+"/"+t,580,n),n.setFontSize(v.fontSize)}function m(e){try{g(v.fileName+".html",e)}catch(e){}}function g(e,t){var n=window.URL||window.webkitURL||window,o=new Blob([t]),a=document.createElementNS("http://www.w3.org/1999/xhtml","a");a.href=n.createObjectURL(o),a.download=e;var r=document.createEvent("MouseEvents");r.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(r)}function h(e,t){var n=$(".fixed-table-body table"),o=parseInt(n.css("lineHeight")),a=parseInt(n.find("td").css("padding-top")),r=19,i=1,l=0,s=t.internal.pageSize.height;n.find("tbody tr").each(function(t,n){var c=parseInt((parseInt($(n).css("height"))-2*a)/o)*r+2*i;l+=c,l>s?(e.pageNumIndex.push(t),l=c):l>s-30&&0===e.pageNumIndex.length&&!e.img&&(e.pageNumIndex.push(t),l=c)}),e.pageNumIndex.length>0?e.pageNumIndex[e.pageNumIndex.length-1]<e.data.length&&e.pageNumIndex.push(e.data.length):e.pageNumIndex.push(e.data.length)}var v={fileName:"Report",title:"",fieldName:[],fieldIndex:[],chartW:950,chartH:450,imgxOffset:15,imgyOffset:25,firstPageNum:10,NumPerPage:25,xOffset:15,yOffset:25,lineH:15,fontSize:15,showPageNum:!0,totalPageNum:0,options:{orientation:"l",unit:"pt",format:"a4"},styles:"",theme:"",oddLine:!0},y="",I={defaults:["table{border-collapse: collapse;  border: 2px solid black;} table, td, th{border: 1px solid black;} th{color:white; background:gray;}","background:#EEEEEE","background:#CCCCCC"],blueL:["table, td, th{border: none; text-align: center} th{color:white; background:#4F81BD} td{color:black;}","background:#B8CCE4","background:#DBE5F1"],blueD:["table, td, th{border: none; text-align: center} th{color:white; background:black} td{color:white;}","background:#345B91","background:#507FC3"],greenL:["table, td, th{border: none; text-align: center} th{color:white; background:#728F1D} td{color:black;}","background:#C4D896","background:#DAF0D3"],greenD:["table, td, th{border: none; text-align: center} th{color:white; background:black} td{color:white;}","background:#728F1D","background:#9FBF45"],redL:["table, td, th{border: none; text-align: center} th{color:white; background:#90352F} td{color:black;}","background:#F2D8D7","background:#FFEFEF"],redD:["table, td, th{border: none; text-align: center} th{color:white; background:black} td{color:white;}","background:#90352F","background:#BD4F48"]},D={getPdf:a};return D}e.$inject=["$q","$rootScope","$http","$timeout"],angular.module("southWest.services").factory("wPDF",e)}(),function(){"use strict";angular.module("southWest.ai",[])}(),function(){"use strict";angular.module("southWest.asset",[])}(),function(){"use strict";angular.module("southWest.asset.factorydevice",[])}(),function(){"use strict";angular.module("southWest.asset.networkdevice",[])}(),function(){"use strict";angular.module("southWest.asset.securitydevice",[])}(),function(){"use strict";angular.module("southWest.asset.ucddevice",[])}(),function(){"use strict";angular.module("southWest.attack",[])}(),function(){"use strict";angular.module("southWest.audit",[])}(),function(){"use strict";angular.module("southWest.audit.behavior",[])}(),function(){"use strict";angular.module("southWest.audit.devicedata",[])}(),function(){"use strict";angular.module("southWest.audit.dpidata",[])}(),function(){"use strict";angular.module("southWest.audit.dpidevicedata",[])}(),function(){"use strict";angular.module("southWest.audit.forumpostdata",[])}(),function(){"use strict";angular.module("southWest.audit.icdevicedata",[])}(),function(){"use strict";angular.module("southWest.audit.searchenginedata",[])}(),function(){"use strict";angular.module("southWest.auth",["ngAnimate"])}(),function(){"use strict";angular.module("southWest.dashboard",[])}(),function(){"use strict";angular.module("southWest.detect",[])}(),function(){"use strict";angular.module("southWest.domain",["ngAnimate"])}(),function(){"use strict";angular.module("southWest.help",[])}(),function(){"use strict";angular.module("southWest.help.monitor",[])}(),function(){"use strict";angular.module("southWest.help.network",[])}(),function(){"use strict";angular.module("southWest.help.object",[])}(),function(){"use strict";angular.module("southWest.help.rule",[])}(),function(){"use strict";angular.module("southWest.help.setting",[])}(),function(){"use strict";angular.module("southWest.help.strategy",[])}(),function(){"use strict";angular.module("southWest.infsafety",[])}(),function(){"use strict";angular.module("southWest.monitor.device",[])}(),function(){"use strict";angular.module("southWest.monitor.incident",[])}(),function(){"use strict";angular.module("southWest.monitor.logger",[])}(),function(){"use strict";angular.module("southWest.monitor",[])}(),function(){"use strict";angular.module("southWest.monitor.overview",[])}(),function(){"use strict";angular.module("southWest.monitor.report_event",[])}(),function(){"use strict";angular.module("southWest.monitor.report_log",[])}(),function(){"use strict";angular.module("southWest.monitor.report_protocol",[])}(),function(){"use strict";angular.module("southWest.myaccount",[])}(),function(){"use strict";angular.module("southWest.network.interface",[])}(),function(){"use strict";angular.module("southWest.network",[])}(),function(){"use strict";angular.module("southWest.network.static_router",[])}(),function(){"use strict";angular.module("southWest.ntpsync",[])}(),function(){"use strict";angular.module("southWest.object.apply",[])}(),function(){"use strict";angular.module("southWest.object.network_asset",[])}(),function(){"use strict";angular.module("southWest.object",[])}(),function(){"use strict";angular.module("southWest.object.schedule",[])}(),function(){"use strict";angular.module("southWest.object.service",[])}(),function(){"use strict";angular.module("southWest.postlog",[])}(),function(){"use strict";angular.module("southWest.privateprotocol",[])}(),function(){"use strict";angular.module("southWest.protocolaudit",[])}(),function(){"use strict";angular.module("southWest.record",[])}(),function(){"use strict";angular.module("southWest.redirect",[])}(),function(){"use strict";angular.module("southWest.reduction",[])}(),function(){"use strict";angular.module("southWest.rule.blacklist",[])}(),function(){"use strict";angular.module("southWest.rule.ipmac",[])}(),function(){"use strict";angular.module("southWest.rule.ipmacsync",[])}(),function(){"use strict";angular.module("southWest.rule.learning",[])}(),function(){"use strict";angular.module("southWest.rule.maliciousdomain",[])}(),function(){"use strict";angular.module("southWest.rule.networklist",[])}(),function(){"use strict";angular.module("southWest.rule",[])}(),function(){"use strict";angular.module("southWest.rule.sync",[])}(),function(){"use strict";angular.module("southWest.rule.whitelist",[])}(),function(){"use strict";angular.module("southWest.securityaudit",[])}(),function(){"use strict";angular.module("southWest.securityauditsetting",[])}(),function(){"use strict";angular.module("southWest.session.flowdata_industry",[])}(),function(){"use strict";angular.module("southWest.session.flowdata_overview",[])}(),function(){"use strict";angular.module("southWest.session.protocol",[])}(),function(){"use strict";angular.module("southWest.session",[])}(),function(){"use strict";angular.module("southWest.session.state",[])}(),function(){"use strict";angular.module("southWest.setting.basic",[])}(),function(){"use strict";angular.module("southWest.setting.reliable",[])}(),function(){"use strict";angular.module("southWest.setting.security_operation",[])}(),function(){"use strict";angular.module("southWest.setting",[])}(),function(){"use strict";angular.module("southWest.setting.switch",[])}(),function(){"use strict";angular.module("southWest.setting.systemconsole",[])}(),function(){"use strict";angular.module("southWest.setting.systemdevice",[])}(),function(){"use strict";angular.module("southWest.strategy.anti_penetration",[])}(),function(){"use strict";angular.module("southWest.strategy.nat",[])}(),function(){"use strict";angular.module("southWest.strategy.security",[])}(),function(){"use strict";angular.module("southWest.strategy.session",[])}(),function(){"use strict";angular.module("southWest.strategy",[])}(),function(){"use strict";angular.module("southWest.systemuser",[])}(),function(){"use strict";angular.module("southWest.todolist",[])}(),function(){"use strict";angular.module("southWest.topology.singleTopo",[])}(),function(){"use strict";angular.module("southWest.topology",[])}(),function(){"use strict";angular.module("southWest.unknown",[])}(),function(){"use strict";angular.module("southWest.vul",[])}(),function(){"use strict";function e(e){e.state("ai",{parent:"dashboard",abstract:!0,template:"<div ui-view></div>"}).state("ai.learning",{url:"/ai/learning/",controller:"learningCtrl as learningCtrl",templateUrl:"templates/rule/learning/index.dcfb9239.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.ai").config(e)}(),function(){"use strict";function e(){var e=this;e.test={}}angular.module("southWest.ai").controller("AICtrl",e)}(),function(){"use strict";function e(e){e.state("asset",{abstract:!0,parent:"dashboard",url:"/asset",controller:"AssetCtrl as asset",templateUrl:"templates/asset/index.3f60f553.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.asset").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l){var s=this;"allInOne"!==o.MW_SETTING&&"remote"!==o.MW_SETTING||e.go("asset.ucddevice"),s.expanded="true"===t.getItem("asset:navbar:expanded"),s.leftNavItemEnabled=l.leftNavItemEnabled,s.toggleExpand=function(){s.expanded=!s.expanded,t.setItem("asset:navbar:expanded",s.expanded)},s.isActive=function(t){return e.current.name.indexOf(t)>-1},s.uiEnable=function(e,t){return n.isShow(e,t)},s.deleteOneDevice=function(t){function n(t,n,o,a,r,i){t.device=o,t.ok=function(){r.all([i.getNodes(t.device.topologyId),i.getLinks(t.device.topologyId)]).then(function(r){for(var l=r[0].data,s={},c=r[1].data,d=[],u=0;u<l.length;u++)l[u].deviceId===t.device.deviceId&&(s[l[u].id]=u);for(var p=0;p<c.length;p++)void 0===s[c[p].nodeID]&&void 0===s[c[p].destinationNodeID]||d.push({id:c[p].id});i.deleteLink(d,t.device.topologyId).then(function(){a.deleteOneDevice(o.deviceId).then(function(){n.close(),"SECURITY_DEVICE"===t.device.category?e.go("asset.securitydevice"):"FACTORY_DEVICE"===t.device.category?e.go("asset.factorydevice"):"NETWORK_DEVICE"===t.device.category&&e.go("asset.networkdevice")})})})},t.cancel=function(){n.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","device","Device","$q","Topology"];var o=a.open({templateUrl:"templates/asset/deleteDevice.4bd25fc1.html",controller:n,size:"sm",resolve:{device:function(){return t}}});o.result.then(function(){},function(){i.info("Modal dismissed at: "+new Date)})}}e.$inject=["$state","localStorage","uiCtrl","$rootScope","$modal","$scope","$log","leftNavCustomMenu"],angular.module("southWest.asset").controller("AssetCtrl",e)}(),function(){"use strict";function e(){function e(){}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/asset/assetSideNav.ca32c3a9.html",link:e};return t}angular.module("southWest.asset").directive("assetSideNav",e)}(),function(){"use strict";function e(e){e.state("asset.factorydevice",{url:"/factorydevice?panel",controller:"FactoryDeviceCtrl as factorydevice",templateUrl:"templates/asset/factorydevice/index.164415d2.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.factorydevice.detail",{parent:"asset",url:"/factorydevice/deviceid/:deviceID?panel",controller:"FactoryDeviceDetailCtrl as factorydetail",templateUrl:"templates/asset/factorydevice/details/details.f2f67977.html",resolve:{alldevice:["$stateParams","dupeInfo",function(e,t){return t.allDevice().then(function(e){return e})}],allDeviceFull:["$stateParams","topologyId","Topology",function(e,t,n){return n.getAllDeviceFull(t.id)}],device:["$stateParams","$q","Device","Topology","topologyId","domain",function(e,t,n,o,a,r){function i(){return n.get(e.deviceID).then(function(e){return t.all([n.getBlocksRef(e.blocksRef.baseUrl),o.getDeviceNodes(e.deviceId)]).then(function(t){return e.rules=t[0],e.nodes=t[1],e._iconName=n.getIconName(e.iconType),e})},function(){return!1})}return a.id?i():r.getDomain().then(function(){return i()})}],models:["Device",function(e){return e.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq FACTORY_DEVICE",$limit:1e6,$orderby:"model_name"})}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.factorydevice.new",{parent:"asset",url:"/factorydevice/new",controller:"FactoryDeviceNewCtrl as newfactory",templateUrl:"templates/asset/factorydevice/details/new.5ac9c488.html",resolve:{alldevice:["$stateParams","dupeInfo",function(e,t){return t.allDevice().then(function(e){return e})}],allDeviceFull:["$stateParams","topologyId","Topology",function(e,t,n){return n.getAllDeviceFull(t.id)}],models:["Device",function(e){return e.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq FACTORY_DEVICE",$limit:1e6,$orderby:"model_name"})}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.asset.factorydevice").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l){var s=this;s.editRight=30===r.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue,e.editMode={},s.contentEnable=function(e){return l.getContentShow(e)},s.defaultTab=s.contentEnable("FACTORY_DEVICE_LIST")?"DEVICE":s.contentEnable("FACTORY_DEVICE_ZONE")?"NODEZONE":"none",s.isEditMode=function(t){return e.editMode["edit"+t]},s.getAllNodeZones=function(){var t={};t.$filter="zoneName ne 'NA'",t.$orderby="zoneName",i.getAllNodeZone(t).then(function(t){e.allNodeZones=t})},s.addNodeZone=function(){e.editMode={},e.isAddNodeZone=!0},s.doAddNodeZone=function(e){i.addNodeZone({zoneName:e}).then(function(){s.cancelAddNodeZone(),o.reload().then(function(){a.addAlert({type:"success",content:"逻辑分区添加成功"})})})},s.cancelAddNodeZone=function(){e.editMode={},e.newZoneName="",e.isAddNodeZone=!1},s.editNodeZone=function(t,n){e.editMode={},e.editMode["edit"+n]=!0,e.inputZoneName=t.zoneName},s.checkUniqueOrNA=function(t,n){if(e.isNotUnique=!1,e.isNA=!1,"NA"===t)return void(e.isNA=!0);var o=e.allNodeZones;for(var a in o){if(void 0!==n&&o[a].zoneName===t&&Number(a)!==n)return void(e.isNotUnique=!0);if(void 0===n&&o[a].zoneName===t)return void(e.isNotUnique=!0)}},s.doEditNodeZone=function(e,t){e.zoneName=t,i.updateZoneName(e).then(function(){s.cancelEditNodeZone(),o.reload().then(function(){a.addAlert({type:"success",content:"逻辑分区修改成功"})})})},s.cancelEditNodeZone=function(){e.editMode={}},s.deleteNodeZones=function(r){function i(e,t,n,r){e.deleteMsg="确认是否删除此记录？",e.deleteFlg=!0,e.ok=function(){n.deleteNodeZones(r,function(n){n?(e.deleteMsg=n,e.deleteFlg=!1,e.ok=function(){t.close()}):(t.close(),o.reload().then(function(){a.addAlert({type:"success",content:"逻辑分区删除成功"})}))})},e.cancel=function(){t.dismiss("cancel")}}i.$inject=["$scope","$modalInstance","Device","items"];var l=t.open({templateUrl:"delete-record-confirmation.html",controller:i,size:"sm",resolve:{items:function(){return e.deleteItems=[],e.deleteItems.push(r),e.deleteItems}}});l.result.then(function(t){e.selected=t},function(){n.info("Modal dismissed at: "+new Date)})}}function t(e,t,n,o,a,r,i,l,s,c,d,u,p){function f(e){t.update(e.deviceId,e).then(function(){t.updateNodeAssociation(e.deviceId,h.editedInfo.nodeZoneId).then(function(){a.reload().then(function(){h.isEdited=!1,o.addAlert({type:"success",content:"修改设备成功"})})},function(e){o.addAlert({type:"danger",content:"修改设备逻辑分区失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})},function(e){o.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}function m(){h.nameError=!h.editedInfo.name||0===h.editedInfo.name.length,h.hasDuplicateSN=!1,h.editedInfo.serialNumber&&(h.hasDuplicateSN=l.checkSerialNumberDup(d,h.editedInfo.serialNumber,h.editedInfo.deviceId)),h.newModel?h.modelError=!h.editedInfo._model_name||0===h.editedInfo._model_name.length:h.modelError=!h.editedInfo.modelId||0===h.editedInfo.modelId.length}function g(e){for(var t in h.forms.models)if(t&&h.forms.models[t].modelId===e){h.editedInfo.modelId=e,h.editedInfo.make=h.forms.models[t].make,h.editedInfo.iconType=h.forms.models[t].iconType?h.forms.models[t].iconType:h.editedInfo.iconType?h.editedInfo.iconType:"unknown-device";break}}var h=this;h.device=n,h.editedInfo={},angular.copy(n,h.editedInfo),h.validate=[];var v=h.forms={};v.models=i;var y={};y.$filter="zoneName ne 'NA'",y.$orderby="zoneName",t.getAllNodeZone(y).then(function(e){v.nodezones=e}),v.models.splice(0,0,{modelId:"new",model_name:"添加设备型号"}),p.isMacNeeded().then(function(t){e.needMac=t}),h.checkAllIpMacValid=function(){h.allIpMacValid=!1;for(var e=0;e<h.editedInfo.devicePorts.length;e++){var t=h.editedInfo.devicePorts[e];if(t.invalidIp||t.hasDuplicateIP||t.invalidRange||t.invalidMac||t.hasDuplicateMAC)return}h.allIpMacValid=!0},h.editIP=function(){h.editedInfo=angular.copy(h.device),h.validateAllIp(),h.validateAllMac(),h.isIPEdited=!0},h.editIPCancel=function(){angular.copy(h.device,h.editedInfo),h.isIPEdited=!1},h.removeIpMac=function(e){h.editedInfo.devicePorts.splice(e,1),h.validateAllIp(),h.validateAllMac(),h.checkAllIpMacValid()},h.addIpMac=function(){h.editedInfo.devicePorts.push({portIp:"",mac:"",isMgmtPort:!0,invalidIp:!0,invalidMac:e.needMac}),h.checkAllIpMacValid()},h.removeLinks=function(e,t){u.deleteLink(t,e)},h.editIPDone=function(){delete h.editedInfo._iconName,delete h.editedInfo.nodes,delete h.editedInfo.rules;var e=[],n=-1;h.editedInfo.devicePorts.length<h.device.devicePorts.length&&(n=h.editedInfo.devicePorts.length);for(var i=0;i<h.editedInfo.devicePorts.length;i++){var l=h.editedInfo.devicePorts[i];delete l.hasDuplicateIP,delete l.hasDuplicateMAC,delete l.invalidIp,delete l.invalidMac,delete l.invalidRange,l.portName="p"+i.toString(),l.mac=l.mac?l.mac.toUpperCase():"",e.push(l.portName)}var s=[];s.push(u.getLinks(h.device.topologyId)),s.push(u.getDeviceNodes(h.device.deviceId)),t.updateAllDevicePorts(h.device.topologyId,h.device.deviceId,h.editedInfo).then(function(){var i=h.device.nodes[0];"subnet"!==h.device.iconType&&(i.ports=e),t.updateNode(i).then(function(){a.reload().then(function(){o.addAlert({type:"success",content:"修改设备端口成功"})})}),n!==-1&&r.all(s).then(function(e){for(var t=e[0].data,o=e[1][0],a=[],r=0;r<t.length;r++){var i=t[r];i.nodeID===o.id&&i.sourcePortName&&parseInt(i.sourcePortName.slice(1))>=n&&a.push({id:i.id})}h.removeLinks(o.topologyId,a)})},function(){o.addAlert({type:"danger",content:"修改设备端口失败"})})},h.editDevice=function(){delete h.device.port,h.editedInfo=angular.copy(h.device),h.editedInfo.nodeZoneId=h.device.nodes[0].nodeZoneId,h.isEdited=!0,m()},h.editCancel=function(){angular.copy(h.device,h.editedInfo),h.newModel=!1,h.isEdited=!1},h.editDone=function(){var e={};if(angular.copy(h.device,e),e.name=h.editedInfo.name,e.serialNumber=h.editedInfo.serialNumber,e.make=h.editedInfo.make,e.iconType=h.editedInfo.iconType,delete e.rules,delete e.nodes,delete e._rulesCount,delete e._signaturesCount,delete e._iconName,delete e._factoryCount,delete e.showRoutingInfo,delete e.ip,delete e.mac,e.serialNumber||delete e.serialNumber,h.newModel){var n={};n.model=h.editedInfo._model_name,n.model_name=h.editedInfo._model_name,n.make=h.editedInfo.make,n.iconType=h.editedInfo.iconType,n.category=1;var a=!1;for(var r in h.forms.models)if(r&&h.forms.models[r].model===n.model&&"N/A"===h.forms.models[r].version&&h.forms.models[r].make===n.make){a=!0,e.modelId=h.forms.models[r].modelId;break}a?(h.newModel=!1,f(e)):t.createModel(n).then(function(t){e.modelId=t.modelId,h.forms.models.splice(1,0,{modelId:t.modelId,model_name:n.model_name}),h.editedInfo.modelId=t.modelId,h.newModel=!1,f(e)},function(e){o.addAlert({type:"danger",content:"添加设备型号失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}else e.modelId=h.editedInfo.modelId,f(e)},h.validateDevice=function(){m()},h.modelChange=function(e){"new"===e?(h.newModel=!0,h.editedInfo.model="",h.editedInfo._model_name="",h.editedInfo.make="",h.editedInfo.modelId=""):(h.newModel=!1,g(e)),h.validateDevice()},h.deviceIpChange=function(e,t){"subnet"===h.device.iconType?(e.invalidIp=l.subnetValidation(e.portIp),e.invalidRange=!e.invalidIp&&l.subnetOverlap(h.device,d,e.portIp)):(e.invalidIp=!e.portIp||l.validateIp(e.portIp),e.hasDuplicateIP=!e.invalidIp&&(c.checkDupInDevice(h.editedInfo.devicePorts,e,t,"portIp")||c.dupInOtherDevice("portIp",h.device.deviceId,d,e.portIp)),e.invalidRange=!e.invalidIp&&!e.hasDuplicateIP&&l.checkIpInSubnet(e.portIp,d))},h.deviceMacChange=function(t,n){t.invalidMac=t.mac&&l.validateMac(t.mac),e.needMac&&!t.mac&&(t.invalidMac=!0),t.mac?t.hasDuplicateMAC=!t.invalidMac&&(c.checkDupInDevice(h.editedInfo.devicePorts,t,n,"mac")||c.dupInOtherDevice("mac",h.device.deviceId,d,t.mac)):t.hasDuplicateMAC=!1},h.validateAllIp=function(){for(var e=0;e<h.editedInfo.devicePorts.length;e++)h.deviceIpChange(h.editedInfo.devicePorts[e],e);h.checkAllIpMacValid()},h.validateAllMac=function(){for(var e=0;e<h.editedInfo.devicePorts.length;e++)h.deviceMacChange(h.editedInfo.devicePorts[e],e);h.checkAllIpMacValid()}}function n(e,t,n,o,a,r,i,l,s,c){function d(){"subnet"===t.device.iconType&&t.device.subnetIp&&r.subnetParser(g,t.device,t.device.subnetIp,i),g.nameError=!t.device.name||0===t.device.name.length,
g.modeError=!t.device.mode||0===t.device.mode.length,g.newModel?g.modelError=!t.device.modelname||0===t.device.modelname.length:g.modelError=!t.device.modelname||0===t.device.modelname.length}function u(t,n){o.createDevice(t).then(function(e){n[0].deviceId=e.deviceId,p(n)},function(t){e.addAlert({type:"danger",content:"添加设备失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}function p(t){o.createNodes(t).then(function(){window.location.href="/asset/factorydevice",e.addAlert({type:"success",content:"添加设备到加入当前拓扑成功"})},function(t){e.addAlert({type:"danger",content:"加入当前拓扑失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}function f(e){for(var n in t.forms.models)if(n&&t.forms.models[n].modelId===e){t.device.modelId=t.forms.models[n].modelId,t.device.model=t.forms.models[n].model,t.device.modelmake=t.forms.models[n].make,t.device.modelprotocol=t.forms.models[n].protocol,t.device.modelversion=t.forms.models[n].version,t.device.modelfirmware=t.forms.models[n].firmwareVersion,t.device.modelserial=t.forms.models[n].model_serialNo,t.device.modelmemo=t.forms.models[n].model_memo;var o=t.forms.models[n].iconType;o?t.device.iconType=o:g.modeChange();break}}function m(){t.device={},t.device.category="FACTORY_DEVICE";var e=t.forms={};e.models=a,e.models.splice(0,0,{modelId:"new",model_name:"添加设备型号"}),t.forms.modes=[{mode:"ENDPOINT",modename:"高端数控机床",icontype:"cnc"},{mode:"ENDPOINT",modename:"HMI",icontype:"hmi"},{mode:"ENDPOINT",modename:"OPC 客户端",icontype:"opc_client"},{mode:"ENDPOINT",modename:"OPC 服务器",icontype:"opc_server"},{mode:"ENDPOINT",modename:"PLC",icontype:"plc"},{mode:"ENDPOINT",modename:"工作站",icontype:"workstation"},{mode:"ENDPOINT",modename:"子网",icontype:"subnet"},{mode:"ENDPOINT",modename:"其它",icontype:"unknown-device"}],t.device.ipmac=[{ip:"",mac:""}],c.isMacNeeded().then(function(e){t.device.needMac=e})}var g=t.newDevice={};m(),g.done=function(){var n={},a={},i=[];n.name=t.device.name,n.modelId=t.device.modelname,n._configMismatch=t.device._configMismatch,n.protectedDevicesNumber=t.device.protectedDevicesNumber,n.cmmnPortnumber=t.device.cmmnPortnumber,n.isProtected=t.device.isProtected,n.iconType=t.device.iconType,n.hasUSB=t.device.hasUSB,n.hasWireless=t.device.hasWireless,n.hasPort=t.device.hasPort,n.serialNumber=t.device.serialNumber,n.devicePorts=[];var l;for(l=0;l<t.device.ipmac.length;l++){var s=t.device.ipmac[l],c={isMgmtPort:!0,portIp:s.ip,mac:s.mac?s.mac.toUpperCase():""};if("subnet"===n.iconType){var d=c.portIp.split("/");c.netMask=r.numToNetmask(d[1])}n.devicePorts.push(c)}a.model=t.device.model?t.device.model:t.device.modelname,a.model_name=t.device.modelname,a.make=t.device.modelmake,a.model_memo=t.device.modelmemo,a.numOfPorts=t.device.modelnumofports,a.iconType=t.device.iconType,a.category=1,i[0]={};for(var p=[],f=0;f<t.device.ipmac.length;f++)p.push("p"+f);if("subnet"!==n.iconType&&(i[0].ports=p),i[0].name=t.device.name,i[0].type=t.device.mode,i[0].zoneName=t.device.name,i[0].importance=1,g.newModel){var m=!1;for(l in t.forms.models)if(l&&t.forms.models[l].model===a.model&&"N/A"===t.forms.models[l].version&&(t.forms.models[l].make===a.make||"N/A"===t.forms.models[l].make&&""===a.make)){m=!0,n.modelId=t.forms.models[l].modelId;break}m?(g.newModel=!1,u(n,i)):o.createModel(a).then(function(e){n.modelId=e.modelId,t.forms.models.splice(1,0,{modelId:e.modelId,model_name:a.model_name}),t.device.modelname=e.modelId,g.newModel=!1,u(n,i)},function(t){e.addAlert({type:"danger",content:"添加设备型号失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}else u(n,i)},g.serialNumberChanged=function(){t.device.serialNumber?g.hasDuplicateSN=r.checkSerialNumberDup(s,t.device.serialNumber,-1):g.hasDuplicateSN=!1},t.removeIpMac=function(e){t.device.ipmac.splice(e,1),g.validateAllIp(),g.validateAllMac()},g.validateDevice=function(){d()},g.clearModelFields=function(){g.newModel=!0,t.device.model="",t.device.modelname="",t.device.modelmake="",t.device.modelprotocol="",t.device.modelversion="",t.device.modelfirmware="",t.device.modelserial="",t.device.modelmemo=""},g.modelChange=function(e){"new"===e?g.clearModelFields():(g.newModel=!1,f(e)),g.validateDevice()},g.modeChange=function(){if(t.device.modename){for(var e in t.forms.modes)if(e&&t.forms.modes[e].modename===t.device.modename.modename){t.device.mode=t.forms.modes[e].mode,t.device.iconType=t.forms.modes[e].icontype,t.digest;break}"子网"===t.device.modename.modename&&(t.device.ipmac=[{ip:"",mac:""}],g.clearModelFields());for(var n=0;n<t.device.ipmac.length;n++){var o=t.device.ipmac[n];o.ip&&g.validateIp(o,n)}g.allIpMacValid(),g.validateDevice()}},g.validateIp=function(e,n){"subnet"===t.device.iconType?(e.invalidIp=!e.ip||r.subnetValidation(e.ip),e.invalidRange=!e.invalidIp&&r.subnetOverlap(t.device,s,e.ip)):(e.invalidIp=!e.ip||r.validateIp(e.ip),e.hasDuplicateIP=!e.invalidIp&&(l.dupInOtherDevice("portIp",-1,s,e.ip)||l.checkDupInDevice(t.device.ipmac,e,n,"ip")),e.invalidRange=!e.invalidIp&&!e.hasDuplicateIP&&r.checkIpInSubnet(e.ip,s))},g.validateMac=function(e,n){e.invalidMac=e.mac&&r.validateMac(e.mac),e.mac?e.hasDuplicateMAC=!e.invalidMac&&(l.dupInOtherDevice("mac",-1,s,e.mac)||l.checkDupInDevice(t.device.ipmac,e,n,"mac")):e.hasDuplicateMAC=!1},t.disableAddNewIp=!0,g.allIpMacValid=function(){t.disableAddNewIp=!0;for(var e=0;e<t.device.ipmac.length;e++){var n=t.device.ipmac[e];if(!n.ip||n.invalidIp||n.hasDuplicateIP||n.invalidRange)return t.disableAddNewIp=!0,!1;if(n.invalidMac||n.hasDuplicateMAC)return t.disableAddNewIp=!0,!1;if(t.device.needMac&&!n.mac)return t.disableAddNewIp=!0,!1}return t.disableAddNewIp=!1,!0},g.validateAllIp=function(){for(var e=0;e<t.device.ipmac.length;e++){var n=t.device.ipmac[e];g.validateIp(n,e)}g.allIpMacValid()},g.validateAllMac=function(){for(var e=0;e<t.device.ipmac.length;e++){var n=t.device.ipmac[e];g.validateMac(n,e)}g.allIpMacValid()},t.addIpMac=function(){t.device.ipmac.push({ip:"",mac:""}),t.disableAddNewIp=!0}}e.$inject=["$scope","$modal","$log","$state","$rootScope","Enum","Device","uiTree"],t.$inject=["$scope","Device","device","$rootScope","$state","$q","models","formatVal","alldevice","dupeInfo","allDeviceFull","Topology","Signature"],n.$inject=["$rootScope","$scope","$q","Device","models","formatVal","alldevice","dupeInfo","allDeviceFull","Signature"],angular.module("southWest.asset.factorydevice").controller("FactoryDeviceCtrl",e).controller("FactoryDeviceDetailCtrl",t).controller("FactoryDeviceNewCtrl",n)}(),function(){"use strict";function e(e,t,n){function o(o,a,r,i){function l(t){t.$orderby&&""!==t.$orderby||(t.$orderby="name");var n=t||{};return n.$filter=d,e.getAll(n)}function s(n){var o=n||{};return o.$filter=d,e.getCount(o,t.id)}function c(t){return e.search("FACTORY_DEVICE",t)}i.disableToolbar=!0;var d="category eq FACTORY_DEVICE";i.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:l,getCount:s,search:c}),i.getType=function(e){return n.getFactoryType(e)}}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/asset/factorydevice/factoryDeviceTable.f5be3780.html",link:o};return a}function t(e){function t(t,n,o,a){function r(t){t.$orderby&&""!==t.$orderby||(t.$orderby=c);var n=t||{};return n.$filter=s,e.getAllNodeZone(n)}function i(t){var n=t||{};return n.$filter=s,e.getNodeZoneCount(n)}function l(t){var n={};return n.$orderby=c,n.$filter=s,n.searchContent=t,e.getAllNodeZone(n)}a.disableToolbar=!0;var s="zoneName ne 'NA'",c="zoneName";a.setConfig({name:"nodeZone",pagination:!0,scrollable:!1,totalCount:!0,getAll:r,getCount:i,search:l})}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/asset/factorydevice/nodeZoneTable.bf8cbc31.html",link:t};return n}e.$inject=["Device","topologyId","deviceTypeService"],t.$inject=["Device"],angular.module("southWest.asset.factorydevice").directive("factoryDeviceTable",e).directive("nodeZoneTable",t)}(),function(){"use strict";function e(e){e.state("asset.networkdevice",{url:"/networkdevice",controller:"NetworkDeviceCtrl as networkdevice",templateUrl:"templates/asset/networkdevice/index.8d59f1bf.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.networkdevice.detail",{parent:"asset",url:"/networkdevice/deviceid/:deviceID?panel",controller:"NetworkDeviceDetailCtrl as networkdetail",templateUrl:"templates/asset/networkdevice/details/details.be1b5265.html",resolve:{alldevice:["$stateParams","dupeInfo",function(e,t){return t.allDevice().then(function(e){return e})}],allDeviceFull:["$stateParams","Topology","topologyId",function(e,t,n){return t.getAllDeviceFull(n.id)}],device:["$stateParams","$q","Device","Topology","topologyId","domain",function(e,t,n,o,a,r){function i(){return n.get(e.deviceID).then(function(e){return t.all([n.getBlocksRef(e.blocksRef.baseUrl),o.getDeviceNodes(e.deviceId)]).then(function(t){return e.rules=t[0],e.nodes=t[1],e._iconName=n.getIconName(e.iconType),e})},function(){return!1})}return a.id?i():r.getDomain().then(function(){return i()})}],models:["Device",function(e){return e.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq NETWORK_DEVICE",$limit:1e6,$orderby:"model_name"})}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.networkdevice.new",{parent:"asset",url:"/networkdevice/new",controller:"NetworkDeviceNewCtrl as newnetwork",templateUrl:"templates/asset/networkdevice/details/new.34b3a072.html",resolve:{alldevice:["$stateParams","dupeInfo",function(e,t){return t.allDevice().then(function(e){return e})}],allDeviceFull:["$stateParams","Topology","topologyId",function(e,t,n){return t.getAllDeviceFull(n.id)}],models:["Device",function(e){return e.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq NETWORK_DEVICE",$limit:1e6,$orderby:"model_name"})}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.asset.networkdevice").config(e)}(),function(){"use strict";function e(e){var t=this;t.editRight=30===e.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue}function t(e,t,n,o,a,r,i,l,s,c){function d(t){e.update(t.deviceId,t).then(function(){f.isEdited=!1,o.reload().then(function(){n.addAlert({type:"success",content:"修改设备成功"})})},function(e){n.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}function u(){f.hasDuplicateSN=!1,f.editedInfo.serialNumber&&(f.hasDuplicateSN=i.checkSerialNumberDup(c,f.editedInfo.serialNumber,f.editedInfo.deviceId)),f.nameError=!f.editedInfo.name||0===f.editedInfo.name.length,f.newModel?f.modelError=!f.editedInfo._model_name||0===f.editedInfo._model_name.length:f.modelError=!f.editedInfo.modelId||0===f.editedInfo.modelId.length}function p(e){for(var t in f.forms.models)if(t&&f.forms.models[t].modelId===e){f.editedInfo.modelId=e,f.editedInfo.make=f.forms.models[t].make,f.editedInfo.iconType=f.forms.models[t].iconType?f.forms.models[t].iconType:f.editedInfo.iconType?f.editedInfo.iconType:"unknown-device";break}}var f=this;f.device=t,f.validateIp=angular.copy(i.getIPReg()),f.validateMac=angular.copy(i.getMACReg()),f.validate=[];var m=f.forms={};m.models=r,m.models.splice(0,0,{modelId:"new",model_name:"添加设备型号"}),f.editIP=function(){f.editedInfo=angular.copy(f.device);for(var e=0;e<f.device.devicePorts.length;e++)if(f.device.devicePorts[e].isMgmtPort){f.editedInfo.ip=f.device.devicePorts[e].portIp,f.editedInfo.mac=f.device.devicePorts[e].mac;break}f.deviceIpChange(),f.deviceMacChange(),f.isIPEdited=!0},f.editIPCancel=function(){f.isIPEdited=!1},f.editIPDone=function(){var t={portIp:f.editedInfo.ip,mac:f.editedInfo.mac?f.editedInfo.mac.toUpperCase():"",portId:f.editedInfo.devicePorts[0].portId};e.updateMgmIpMac(f.device.topologyId,f.device.deviceId,t).then(function(){f.isIPEdited=!1,o.reload().then(function(){n.addAlert({type:"success",content:"修改设备端口成功"})})},function(e){n.addAlert({type:"danger",content:"修改设备端口失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})},f.editDevice=function(){delete f.device.port,f.editedInfo=angular.copy(f.device),f.isEdited=!0,u()},f.editCancel=function(){angular.copy(f.device,f.editedInfo),f.newModel=!1,f.isEdited=!1},f.editDone=function(){var t={};if(angular.copy(f.device,t),t.name=f.editedInfo.name,t.serialNumber=f.editedInfo.serialNumber,t.make=f.editedInfo.make,t.iconType=f.editedInfo.iconType,delete t.rules,delete t.nodes,delete t._rulesCount,delete t._signaturesCount,delete t._iconName,delete t._networkCount,delete t.showRoutingInfo,delete t.ip,delete t.mac,t.serialNumber||delete t.serialNumber,f.newModel){var o={};o.model=f.editedInfo._model_name,o.model_name=f.editedInfo._model_name,o.make=f.editedInfo.make,o.iconType=f.editedInfo.iconType,o.category=2;var a=!1;for(var r in f.forms.models)if(r&&f.forms.models[r].model===o.model&&"N/A"===f.forms.models[r].version&&f.forms.models[r].make===o.make){a=!0,t.modelId=f.forms.models[r].modelId;break}a?(f.newModel=!1,d(t)):e.createModel(o).then(function(e){t.modelId=e.modelId,f.forms.models.splice(1,0,{modelId:e.modelId,model_name:o.model_name}),f.editedInfo.modelId=e.modelId,f.newModel=!1,d(t)},function(e){n.addAlert({type:"danger",content:"添加设备型号失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}else t.modelId=f.editedInfo.modelId,d(t)},f.validateDevice=function(){u()},f.modelChange=function(e){"new"===e?(f.newModel=!0,f.editedInfo.model="",f.editedInfo._model_name="",f.editedInfo.make="",f.editedInfo.modelId=""):(f.newModel=!1,p(e)),f.validateDevice()},f.deviceIpChange=function(){f.invalidIp=f.editedInfo.ip&&i.validateIp(f.editedInfo.ip),!f.invalidIp&&f.editedInfo.ip?(f.hasDuplicateIP=s.dupInOtherDevice("portIp",f.editedInfo.deviceId,c,f.editedInfo.ip),f.invalidRange=!f.hasDuplicateIP&&i.checkIpInSubnet(f.editedInfo.ip,c)):(f.hasDuplicateIP=!1,f.invalidRange=!1)},f.deviceMacChange=function(){f.invalidMac=f.editedInfo.mac&&!f.editedInfo.mac.match(f.validateMac),f.hasDuplicateMAC=!1,f.editedInfo.mac&&!f.invalidMac&&(f.hasDuplicateMAC=s.dupInOtherDevice("mac",f.editedInfo.deviceId,c,f.editedInfo.mac))}}function n(e,t,n,o,a,r,i,l,s){function c(){m.nameError=!t.device.name||0===t.device.name.length,m.modeError=!t.device.mode||0===t.device.mode.length,m.invalidIp=t.device.ip&&r.validateIp(t.device.ip),m.invalidMac=t.device.mac&&!t.device.mac.match(m.validateMac),t.device.ip&&!m.invalidIp?(m.hasDuplicateIP=!m.invalidIp&&l.dupInOtherDevice("portIp",-1,s,t.device.ip),m.invalidRange=!m.invalidIp&&!m.hasDuplicateIP&&r.checkIpInSubnet(t.device.ip,s)):(m.hasDuplicateIP=!1,m.invalidRange=!1),t.device.mac&&!m.invalidMac?m.hasDuplicateMAC=l.dupInOtherDevice("mac",-1,s,t.device.mac):m.hasDuplicateMAC=!1,m.newModel?m.modelError=!t.device.modelname||0===t.device.modelname.length:m.modelError=!t.device.modelname||0===t.device.modelname.length}function d(t,n){o.createDevice(t).then(function(e){n[0].deviceId=e.deviceId,u(n)},function(t){e.addAlert({type:"danger",content:"添加设备失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}function u(t){o.createNodes(t).then(function(){window.location.href="/asset/networkdevice",e.addAlert({type:"success",content:"添加设备到加入当前拓扑成功"})},function(t){e.addAlert({type:"danger",content:"加入当前拓扑失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}function p(e){for(var n in t.forms.models)if(n&&t.forms.models[n].modelId===e){t.device.modelId=t.forms.models[n].modelId,t.device.model=t.forms.models[n].model,t.device.modelmake=t.forms.models[n].make,t.device.modelprotocol=t.forms.models[n].protocol,t.device.modelversion=t.forms.models[n].version,t.device.modelfirmware=t.forms.models[n].firmwareVersion,t.device.modelserial=t.forms.models[n].model_serialNo,t.device.modelmemo=t.forms.models[n].model_memo;var o=t.forms.models[n].iconType;o?t.device.iconType=o:m.modeChange();break}}function f(){t.device={},t.device.category="NETWORK_DEVICE";var e=t.forms={};e.models=a,e.models.splice(0,0,{modelId:"new",model_name:"添加设备型号"}),t.forms.modes=[{mode:"SWITCH",modename:"网络交换机",icontype:"switch"},{mode:"ROUTER",modename:"路由器",icontype:"router"},{mode:"SWITCH",modename:"其它",icontype:"unknown-device"}]}var m=t.newDevice={};m.validateIp=angular.copy(r.getIPReg()),m.validateMac=angular.copy(r.getMACReg());var g;f(),c(),m.done=function(){var n={},a={},r=[];if(t.device.mac?t.device.mac=t.device.mac.toUpperCase():"",n.name=t.device.name,n.modelId=t.device.modelname,n._configMismatch=t.device._configMismatch,n.protectedDevicesNumber=t.device.protectedDevicesNumber,n.cmmnPortnumber=t.device.cmmnPortnumber,n.isProtected=t.device.isProtected,n.iconType=t.device.iconType,n.hasUSB=t.device.hasUSB,n.hasWireless=t.device.hasWireless,n.hasPort=t.device.hasPort,n.serialNumber=t.device.serialNumber,n.devicePorts=[],n.devicePorts[0]={},n.devicePorts[0].isMgmtPort=!0,n.devicePorts[0].portIp=t.device.ip,n.devicePorts[0].mac=t.device.mac,a.model=t.device.model?t.device.model:t.device.modelname,a.model_name=t.device.modelname,a.make=t.device.modelmake,a.model_memo=t.device.modelmemo,a.numOfPorts=t.device.modelnumofports,a.iconType=t.device.iconType,a.category=2,r[0]={},r[0].name=t.device.name,r[0].type=t.device.mode,r[0].zoneName="NA",r[0].importance=1,m.newModel){var i=!1;for(var l in t.forms.models)if(l&&t.forms.models[l].model===a.model&&"N/A"===t.forms.models[l].version&&t.forms.models[l].make===a.make){i=!0,n.modelId=t.forms.models[l].modelId;break}i?(m.newModel=!1,d(n,r)):o.createModel(a).then(function(e){n.modelId=e.modelId,t.forms.models.splice(1,0,{modelId:e.modelId,model_name:a.model_name}),t.device.modelname=e.modelId,m.newModel=!1,d(n,r)},function(t){e.addAlert({type:"danger",content:"添加设备型号失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}else d(n,r)},m.validateDevice=function(){c()},m.modelChange=function(e){"new"===e?(m.newModel=!0,t.device.model="",t.device.modelname="",t.device.modelmake="",t.device.modelprotocol="",t.device.modelversion="",t.device.modelfirmware="",t.device.modelserial="",t.device.modelmemo=""):(m.newModel=!1,p(e)),m.validateDevice()},m.modeChange=function(){if("ROUTER"!==t.device.mode&&(t.device.ip="",t.device.mac=""),t.device.modename){for(var e in t.forms.modes)if(e&&t.forms.modes[e].modename===t.device.modename.modename){t.device.mode=t.forms.modes[e].mode,t.device.iconType=g?g:t.forms.modes[e].icontype;break}m.validateDevice()}},m.serialNumberChanged=function(){t.device.serialNumber?m.hasDuplicateSN=r.checkSerialNumberDup(s,t.device.serialNumber,-1):m.hasDuplicateSN=!1}}e.$inject=["Enum"],t.$inject=["Device","device","$rootScope","$state","$q","models","formatVal","alldevice","dupeInfo","allDeviceFull"],n.$inject=["$rootScope","$scope","$q","Device","models","formatVal","alldevice","dupeInfo","allDeviceFull"],angular.module("southWest.asset.networkdevice").controller("NetworkDeviceCtrl",e).controller("NetworkDeviceDetailCtrl",t).controller("NetworkDeviceNewCtrl",n)}();!function(){"use strict";function e(e,t,n){function o(o,a,r,i){function l(t){t.$orderby&&""!==t.$orderby||(t.$orderby="name");var n=t||{};return n.$filter=d,e.getAll(n)}function s(n){var o=n||{};return o.$filter=d,e.getCount(o,t.id)}function c(t){return e.search("NETWORK_DEVICE",t)}i.disableToolbar=!0;var d="category eq NETWORK_DEVICE";i.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:l,getCount:s,search:c}),i.getType=function(e){return n.getNetworkType(e)}}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/asset/networkdevice/networkDeviceTable.cc36f006.html",link:o};return a}e.$inject=["Device","topologyId","deviceTypeService"],angular.module("southWest.asset.networkdevice").directive("networkDeviceTable",e)}();!function(){"use strict";function e(e){e.state("asset.securitydevice",{url:"/securitydevice?panel",templateUrl:"templates/asset/securitydevice/index.b56b686d.html",controller:"SecurityDeviceCtrl as securitydevice",resolve:{protocols:["Device",function(e){return e.getAllProtocols()}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.securitydevice.detail",{parent:"asset",url:"/securitydevice/deviceid/:deviceID/subcategory/:subCategory?panel",controller:"SecurityDeviceDetailCtrl as securitydetail",templateUrl:"templates/asset/securitydevice/details/details.c8f9f0c4.html",resolve:{protocols:["Device",function(e){return e.getAllProtocols()}],allDeviceFull:["$stateParams","Topology","topologyId",function(e,t,n){return t.getAllDeviceFull(n.id)}],device:["$stateParams","$q","Device","Topology","topologyId","domain","$filter",function(e,t,n,o,a,r,i){function l(r){return n.get(e.deviceID,r).then(function(r){return t.all([n.getBlocksRef(r.blocksRef.baseUrl),o.getDeviceNodes(r.deviceId),n.getDeviceRuleCount(a.id,r.deviceId),n.getDeviceSignatureCount(a.id,r.deviceId)]).then(function(t){r.rules=t[0],r.nodes=t[1],r._rulesCount=t[2],r._signaturesCount=t[3],r._iconName=n.getIconName(r.iconType);var o=r._model_name?r._model_name.split(" /"):[];return"数控审计保护平台"===o[0]&&(r._model_name=i("resFilter")(o[0],"slideAuditTitle")+" /"+o[1]),r.backTo=e.subCategory,r})},function(){return!1})}return a.id?l():r.getDomain().then(function(e){var t="";return e[0]&&e[0].domainInfo&&(t=e[0].domainInfo.currentTopologyId),l(t)})}],models:["Device","$stateParams",function(e,t){return e.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq SECURITY_DEVICE"+(t.subCategory?" and subCategory eq "+t.subCategory:""),$limit:1e6,$orderby:"model_name"})}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.securitydevice.new",{parent:"asset",url:"/securitydevice/new/:subCategory",controller:"SecurityDeviceNewCtrl as securitynew",templateUrl:"templates/asset/securitydevice/details/new.5c34714b.html",resolve:{allDeviceFull:["$stateParams","Topology","topologyId",function(e,t,n){return t.getAllDeviceFull(n.id)}],categories:["Device",function(e){return e.getModels({$select:"category",$limit:1e4})}],models:["Device","$stateParams",function(e,t){return e.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq SECURITY_DEVICE"+(t.subCategory?" and subCategory eq "+t.subCategory:""),$limit:1e6,$orderby:"model_name"})}],subCategory:["$stateParams",function(e){return e.subCategory}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.asset.securitydevice").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c){s.findLand("SECURITY_DEVICE",1);var d=this;d.editRight=30===e.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue,d.hasDCDevice="-C02"!==n.VERSION_NUMBER.slice(-4)&&"-X00"!==n.VERSION_NUMBER.slice(-4)&&"-X01"!==n.VERSION_NUMBER.slice(-4)&&"-X02"!==n.VERSION_NUMBER.slice(-4)&&"-X03"!==n.VERSION_NUMBER.slice(-4)&&"-JA"!==n.VERSION_NUMBER.slice(-5,-2),d.contentEnable=function(e){return c.getContentShow(e)},d.defaultTab=d.contentEnable("NORMAL")?"ALL":d.contentEnable("DATA_COLLECTION_DEVICE")?"DATA_COLLECTION_DEVICE":"none",n.$on("addedToCurrentTopology",function(){a.reload()}),d.uiEnable=function(e,t){return s.isShow(e,t)},o.editNode=function(e){var t=angular.copy(e.protocols);e.origin=t,e.isEdited=!0},o.editNodeCancel=function(e){var t=angular.copy(e.origin);delete e.origin,e.protocols=t,e.isEdited=!1},o.editNodeDone=function(e){var t=[];for(var o in e.protocols)if(o){var a={};a.nodeId=e.id,a.protocolCategory=e.protocols[o].id,t[o]=a}i.updateNodeProtocols(e.id,t).then(function(){n.addAlert({type:"success",content:"更改协议成功"}),r.getDeviceNodes(e.deviceId).then(function(t){for(var n in t)if(n&&t[n].id===e.id){e.updatedAt=t[n].updatedAt;break}})},function(e){n.addAlert({type:"danger",content:"更改协议失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})}),e.isEdited=!1,delete e.origin},o.forms={},o.forms.protocols=[];for(var u in l)if(u){var p={};p.id=l[u],p.label=l[u],o.forms.protocols[u]=p}o.noProtocolTexts={buttonDefaultText:"无"}}function t(e,t,n,o,r,i,l,s,c,d,u,p,f,m,g,h,v){function y(t){for(var n=angular.copy(t),a=0;a<n.devicePorts.length;a++)n.devicePorts[a].isMgmtPort||delete n.devicePorts[a].netMaskIP;e.update(t.deviceId,n).then(function(){w.isEdited=!1,c.reload().then(function(){o.addAlert({type:"success",content:"修改设备成功"})})},function(e){o.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}function I(){w.nameError=!w.editedInfo.name||0===w.editedInfo.name.length,w.serialError=!w.editedInfo.serialNumber||0===w.editedInfo.serialNumber.length,w.serialFormatError=!f.validSNFormat(w.editedInfo.serialNumber),w.hasDuplicateSN=!1,!w.editedInfo.serialNumber||w.serialError||w.serialFormatError||(w.hasDuplicateSN=m.checkSerialNumberDup(h,w.editedInfo.serialNumber,w.editedInfo.deviceId)),w.newModel?w.modelError=!w.editedInfo._model_name||0===w.editedInfo._model_name.length:w.modelError=!w.editedInfo.modelId||0===w.editedInfo.modelId.length}function D(e){for(var t in w.forms.models)if(t&&w.forms.models[t].iconType&&w.forms.models[t].model===e){w.editedInfo.modelId=w.forms.models[t].modelId,w.editedInfo.make=w.forms.models[t].make,w.editedInfo.iconType=w.forms.models[t].iconType?w.forms.models[t].iconType.toLowerCase():"",w.editedInfo.numOfPorts=w.forms.models[t].numOfPorts,w.editedInfo._model_name=w.forms.models[t].model_name+" / "+w.forms.models[t].model;break}}function T(){e.getACLInfo(n.deviceId).then(function(e){w.aclData=angular.copy(e),w.acl.acls_numValidate=[],w.acl.acls_sourceIpValidate=[],w.acl.acls_destinationIpValidate=[],w.acl.acls_sourcePortValidate=[],w.acl.acls_destinationPortValidate=[],w.acl.acls_sourceIpEdit=[],w.acl.acls_destinationIpEdit=[],w.acl.acls_sourcePortEdit=[],w.acl.acls_destinationPortEdit=[],w.acl.acls_sourceIpDisable=[],w.acl.acls_destinationIpDisable=[],w.acl.acls_sourcePortDisable=[],w.acl.acls_destinationPortDisable=[],w.invalidAcl=!1;for(var t=0;t<w.aclData.length;t++)"0.0.0.0/0"===w.aclData[t].sourceIp&&(w.aclData[t].sourceIp="任意"),"0"===w.aclData[t].sourcePort&&(w.aclData[t].sourcePort="任意"),"0.0.0.0/0"===w.aclData[t].destinationIp&&(w.aclData[t].destinationIp="任意"),"0"===w.aclData[t].destinationPort&&(w.aclData[t].destinationPort="任意"),"ANY"===w.aclData[t].protocolType&&(w.aclData[t].protocolType="任意"),"permit"===w.aclData[t].aclAction?w.aclData[t]._aclAction="允许":w.aclData[t]._aclAction="阻断",w.acl.acls_numValidate.push(!0),w.acl.acls_sourceIpValidate.push(!0),w.acl.acls_destinationIpValidate.push(!0),w.acl.acls_sourcePortValidate.push(!0),w.acl.acls_destinationPortValidate.push(!0),w.acl.acls_sourceIpEdit.push("任意"!==w.aclData[t].sourceIp),w.acl.acls_destinationIpEdit.push("任意"!==w.aclData[t].destinationIp),w.acl.acls_sourcePortEdit.push("任意"!==w.aclData[t].sourcePort),w.acl.acls_destinationPortEdit.push("任意"!==w.aclData[t].destinationPort),w.acl.acls_sourceIpDisable.push("OPC_Classic"===w.aclData[t].protocolType),w.acl.acls_destinationIpDisable.push("OPC_Classic"===w.aclData[t].protocolType),w.acl.acls_sourcePortDisable.push("ICMP"===w.aclData[t].protocolType||"OPC_Classic"===w.aclData[t].protocolType),w.acl.acls_destinationPortDisable.push("ICMP"===w.aclData[t].protocolType||"OPC_Classic"===w.aclData[t].protocolType);w.checkValidation()})}function b(e){return e&&!m.validateIpRange(e)}function S(e){var t=angular.copy(m.getPortReg());return e.match(t)}function P(){w.acl.acls_numValidate=[],w.acl.acls_sourceIpValidate=[],w.acl.acls_destinationIpValidate=[],w.acl.acls_sourcePortValidate=[],w.acl.acls_destinationPortValidate=[];for(var t=[],o=0;o<w.aclData.length;o++){"任意"===w.aclData[o].sourceIp&&(w.aclData[o].sourceIp="0.0.0.0/0"),"任意"===w.aclData[o].sourcePort&&(w.aclData[o].sourcePort="0"),"任意"===w.aclData[o].destinationIp&&(w.aclData[o].destinationIp="0.0.0.0/0"),"任意"===w.aclData[o].destinationPort&&(w.aclData[o].destinationPort="0"),"任意"===w.aclData[o].protocolType&&(w.aclData[o].protocolType="ANY"),w.aclData[o].sourceIp.indexOf("/")<0&&(w.aclData[o].sourceIp+="/32"),w.aclData[o].destinationIp.indexOf("/")<0&&(w.aclData[o].destinationIp+="/32");var a={aclNumber:w.aclData[o].aclNumber,aclAction:w.aclData[o].aclAction,aclLog:w.aclData[o].aclLog,sourceIp:w.aclData[o].sourceIp,sourcePort:w.aclData[o].sourcePort,destinationIp:w.aclData[o].destinationIp,destinationPort:w.aclData[o].destinationPort,protocolType:w.aclData[o].protocolType,protocolTypeName:w.aclData[o].protocolType};t.push(e.addACL(n.deviceId,a))}return l.all(t).then(function(){})}function A(){var e=O.join("],[");return e=e&&"["+e+"]",{portMap:e}}function C(e){if(e&&(w.device=e,O=[]),!w.device.port){for(var t=0;t<x.length;t++)w.port[x[t].portName]={};for(var n=0;n<x.length;n++)for(var o=0;o<x.length;o++)n!==o&&void 0===w.port[x[n].portName][x[o].portName]&&(w.port[x[n].portName][x[o].portName]=w.port[x[o].portName][x[n].portName]={model:!0,port:x[n].portName+","+x[o].portName})}}function k(e){e&&!n.port&&(O=e.substring(1,e.length-1).split("],["),O.forEach(function(e){var t=e.split(",");w.port[t[0]][t[1]].model=!1}),n.port=w.port)}var w=this;w.simplifyModelName=v.simplifyModelName,w.isDPIUpgrading=d.isDPIUpgrading();var E;g.allDevice(h).then(function(e){E=e}),o.$on("dpiUpgradeState",function(){w.isDPIUpgrading=d.isDPIUpgrading()}),w.editRight=30===r.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue,w.device=n,w.modelName=w.device._model_name.substring(w.device._model_name.lastIndexOf(" ")+1),w.device.showRoutingInfo=n.nodes[0]&&"ROUTING_IPS"===n.nodes[0].type,w.validateIp=angular.copy(m.getIPReg()),w.validateMac=angular.copy(m.getMACReg()),w.validateSubnet=angular.copy(m.getSubnetReg()),w.validPortEdit=!0,"DATA_COLLECTION_DEVICE"===w.device._subCategory&&t.getDeviceNodes(w.device.deviceId).then(function(e){for(var t in e)if(t){e[t].protocols=[];for(var n in e[t]._nodeProtocolLinks)if(n){var o={};o.id=e[t]._nodeProtocolLinks[n].protocolCategory,o.label=e[t]._nodeProtocolLinks[n].protocolCategory,e[t].protocols[n]=o}}w.device.nodes=e}),w.aclData=[],w.acl={acls_numValidate:[],acls_sourceIpValidate:[],acls_destinationIpValidate:[],acls_sourcePortValidate:[],acls_destinationPortValidate:[],acls_sourceIpEdit:[],acls_destinationIpEdit:[],acls_sourcePortEdit:[],acls_destinationPortEdit:[],acls_sourceIpDisable:[],acls_destinationIpDisable:[],acls_sourcePortDisable:[],acls_destinationPortDisable:[]},w.validate=[],w.subnetsValidate=[],w.nodePortsVisibility=[],i.editNode=function(e){var t=angular.copy(e.protocols);e.origin=t,e.isEdited=!0},i.editNodeCancel=function(e){var t=angular.copy(e.origin);delete e.origin,e.protocols=t,e.isEdited=!1},i.editNodeDone=function(n){var a=[];for(var r in n.protocols)if(r){var i={};i.nodeId=n.id,i.protocolCategory=n.protocols[r].id,a[r]=i}e.updateNodeProtocols(n.id,a).then(function(){o.addAlert({type:"success",content:"更改协议成功"}),t.getDeviceNodes(n.deviceId).then(function(e){for(var t in e)if(t&&e[t].id===n.id){n.updatedAt=e[t].updatedAt;break}})},function(e){o.addAlert({type:"danger",content:"更改协议失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})}),n.isEdited=!1,delete n.origin},i.protocols=[];for(var N in u)if(N){var $={};$.id=u[N],$.label=u[N],i.protocols[N]=$}i.noProtocolTexts={buttonDefaultText:"无"},i.$on("port",function(e,t){var n=w.device.devicePorts.filter(function(e){return e.portId===t.portId});n&&n[0]&&(n[0].linkState=t.linkState)}),i.$on("device",function(e,t){t.deviceId===w.device.deviceId&&(w.device.deviceOnline=t.deviceOnline,w.device.deviceSource=t.deviceSource)});var M=w.forms={};M.models=p,M.netMasks=angular.copy(m.getNetMasks());for(var R=0;R<w.device.nodes.length;R++)if(w.device.nodes[R])for(var U=0;U<w.device.nodes[R].ports.length;U++)w.nodePortsVisibility.push(w.device.nodes[R].ports[U]);
w.checkNodePortsVisibility=function(e){var t=e;return!!_.find(w.nodePortsVisibility,function(e){return e===t})},w.device.devicePorts.forEach(function(e){e.isMgmtPort||(e.netMask&&"0"!==e.netMask?M.netMasks[e.netMask]?e.netMaskIP=M.netMasks[e.netMask]:(e.netMaskIP=e.netMask,e.netMask=M.netMasks.indexOf(e.netMaskIP)):e.netMaskIP="",e._subnets||(e._subnets=[]))}),w.checkPortEdit=function(e,t,n){w.portsEditValidation[n-1]=void 0!==e&&!m.validateIp(e)&&void 0!==t&&t>0,w.validPortEdit=w.portsEditValidation.indexOf(!1)===-1},w.updateNodeProperty=function(t){var n={nodeProperty:t.tempNodeProperty};return t.isedting=!1,e.updateNodeProperty(t.id,n).then(function(e){o.addAlert({type:"success",content:"修改部署属性成功"}),t.nodeProperty=e.nodeProperty},function(){o.addAlert({type:"danger",content:"修改部署属性失败"})})},w.editIP=function(){w.editedInfo=angular.copy(w.device);for(var e=0;e<w.device.devicePorts.length;e++)if(w.device.devicePorts[e].isMgmtPort){w.editedInfo.ip=w.device.devicePorts[e].portIp,w.editedInfo.mac=w.device.devicePorts[e].mac;break}w.invalidIp=!w.editedInfo.ip||m.validateIp(w.editedInfo.ip),w.invalidMac=w.editedInfo.mac&&!w.editedInfo.mac.match(w.validateMac),w.hasDuplicateIP=g.dupeCheck(w.editedInfo.deviceId,"ip",w.editedInfo.ip,E),w.hasDuplicateMAC=g.dupeCheck(w.editedInfo.deviceId,"mac",w.editedInfo.mac,E),w.isIPEdited=!0},w.editIPCancel=function(){C(w.device),k(w.device.notConnectedPortMap),w.isIPEdited=!1},w.editIPDone=function(){for(var t="",n=0;n<w.editedInfo.devicePorts.length;n++){var a=w.editedInfo.devicePorts[n];if(a.isMgmtPort){t=a.portId;break}}var r={portIp:w.editedInfo.ip,mac:w.editedInfo.mac?w.editedInfo.mac.toUpperCase():"",portId:t};e.updateMgmIpMac(w.device.topologyId,w.device.deviceId,r).then(function(){w.isIPEdited=!1,c.reload().then(function(){o.addAlert({type:"success",content:"修改设备管理端口成功"})})},function(e){o.addAlert({type:"danger",content:"修改设备管理端口失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})},w.editDevice=function(){delete w.device.port,w.editedInfo=angular.copy(w.device),w.editedInfo.numOfPorts=w.device.devicePorts.length>0?w.device.devicePorts.length-1:0,w.editedInfo.iconType=w.device.iconType?w.device.iconType.toLowerCase():"",w.isEdited=!0,I()},w.editCancel=function(e){e||angular.copy(w.editedInfo,w.device),C(w.device),k(w.device.notConnectedPortMap),T(),w.isEdited=!1},w.editDone=function(t){var n={};angular.copy(w.device,n),n.name=w.editedInfo.name,n.serialNumber=w.editedInfo.serialNumber,n.make=w.editedInfo.make,n.iconType=w.editedInfo.iconType,n.modelId=w.editedInfo.modelId,delete n.backTo,delete n.rules,delete n.nodes,delete n._rulesCount,delete n._signaturesCount,delete n._iconName,delete n._securityCount,delete n.showRoutingInfo,delete n.ip,delete n.mac,delete n.numOfPorts;var r;for(r=0;r<n.devicePorts.length;r++){var i=n.devicePorts[r];delete i.netMaskIP}if("basic"===t)l.all([e.getNewDevices({$orderby:"name"})]).then(function(t){var r,i=t[0],d=!1;for(var u in i)if(u&&i[u].serialNumber===n.serialNumber){r=i[u];break}if(r)l.when(a(s,l,r,n)).then(function(){e.update(n.deviceId,n).then(function(){e.addToCurrentTopology(r.deviceId,"").then(function(){w.isEdited=!1,c.reload().then(function(){o.addAlert({type:"success",content:"加入当前拓扑成功"})})},function(){o.addAlert({type:"danger",content:"加入当前拓扑失败"})})},function(e){o.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})});else if(w.newModel){var p={};p.model=w.editedInfo._model_name,p.model_name=w.editedInfo._model_name,p.make=w.editedInfo.make,p.iconType=w.editedInfo.iconType,p.category=1,e.createModel(p).then(function(e){n.modelId=e.modelId,w.forms.models.splice(1,0,{modelId:e.modelId,model_name:p.model_name}),w.editedInfo.modelId=e.modelId,w.newModel=!1,y(n,d,r)},function(e){o.addAlert({type:"danger",content:"添加设备型号失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}else n.modelId=w.editedInfo.modelId,y(n,d,r)});else if("ports"===t){for(var d=[],u=0;u<n._remoteRoutings.length;u++)d.push({networkSegment:n._remoteRoutings[u].networkSegment,gateway:n._remoteRoutings[u].gateway});var p=A();n.notConnectedPortMap=p.portMap;for(var f=[],m=0;m<n.devicePorts.length;m++)if(!n.devicePorts[m].isMgmtPort){var g={};g.portId=n.devicePorts[m].portId,g._subnets=[];for(var h=0;h<n.devicePorts[m]._subnets.length;h++)n.devicePorts[m]._subnets[h].subnet&&g._subnets.push({subnet:n.devicePorts[m]._subnets[h].subnet}),delete n.devicePorts[m]._subnets[h].createdAt,delete n.devicePorts[m]._subnets[h].portId,delete n.devicePorts[m]._subnets[h].portRoutingId,delete n.devicePorts[m]._subnets[h].status,delete n.devicePorts[m]._subnets[h].updatedAt;f.push(g)}var v=[];w.device.devicePorts.forEach(function(e){e.isMgmtPort||v.push({portId:e.portId,portIp:e.portIp,netMask:e.netMask})});for(var I=[],D=angular.copy(n),b=0;b<D.devicePorts.length;b++)D.devicePorts[b].isMgmtPort||delete D.devicePorts[b].netMaskIP;I.push(e.update(n.deviceId,D)),I.push(e.updateDevicePort(n.deviceId,v)),I.push(e.routing(D));var S=l.defer();l.all(I).then(function(e){for(var t="",n=0;n<e.length;n++)"undefined"!=typeof e[n].message&&e[n].message.length>0&&(t+=e[n].message+" ");t?o.addAlert({type:"danger",content:"修改设备失败："+t}):(w.isEdited=!1,S.resolve("SUCCESS"),c.reload().then(function(){o.addAlert({type:"success",content:"修改设备成功"})}))},function(e){o.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}else"acl"===t&&w.device.showRoutingInfo&&w.confirmAcl().then(function(){T(),w.isEdited=!1})},w.validateDevice=function(){I()},w.serialNumberChanged=function(e){w.editedInfo.model="",w.editedInfo._model_name="",w.editedInfo.make="",w.editedInfo.modelId="",w.editedInfo.numOfPorts="";var t=f.getModelBySN(e,w.forms.models);t&&D(t.model)},w.configDevice=function(t){var n=angular.copy(t);delete n.backTo,delete n.rules,delete n.nodes,delete n._rulesCount,delete n._securityCount,delete n._signaturesCount,delete n._iconName,delete n._factoryCount,delete n.showRoutingInfo;var a=l.defer();e.configDevice(t.deviceId,t).then(function(){T(),a.resolve("SUCCESS"),o.addAlert({type:"success",content:"配置终端成功"})},function(e){a.resolve("配置终端失败"),o.addAlert({type:"danger",content:"配置终端失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})},w.deployDeviceACL=function(t){var n=angular.copy(t);delete n.backTo,delete n.rules,delete n.nodes,delete n._rulesCount,delete n._securityCount,delete n._signaturesCount,delete n._iconName,delete n._factoryCount,delete n.showRoutingInfo;var a=l.defer();e.deployACL(n).then(function(){T(),a.resolve("SUCCESS"),o.addAlert({type:"success",content:"下发成功"})},function(e){a.resolve("下发失败"),o.addAlert({type:"danger",content:"下发失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})},w.fillValidate=function(){w.validate=[];for(var e=0;e<w.device._remoteRoutings.length;e++)w.validate[e]={networkSegment:!0,gateway:!0};w.subnetsValidate=[],w.device.devicePorts.forEach(function(e){var t=[];e.isMgmtPort?w.subnetsValidate.push(t):(e._subnets.forEach(function(){t.push(!0)}),w.subnetsValidate.push(t))})},w.validateSubnets=function(){for(var e=0;e<w.subnetsValidate.length;e++)for(var t=0;t<w.subnetsValidate[e].length;t++)if(!w.subnetsValidate[e][t])return void(w.invalidSubnet=!0);w.invalidSubnet=!1},w.validateInput=function(){for(var e=!0,t=0;t<w.validate.length;t++)e=e&&w.validate[t].networkSegment&&w.validate[t].gateway;w.invalidPorts=!e},w.addRouteTableItem=function(){w.device._remoteRoutings.push({networkSegment:"",gateway:""}),w.validate.push({networkSegment:!1,gateway:!1}),w.validateInput()},w.deleteRouteTableItem=function(e){w.device._remoteRoutings.splice(e,1),w.validate.splice(e,1),w.validateInput()},w.getSignatureCount=function(){var e=0;if(w.device.rules)for(var t=0;t<w.device.rules.length;t++)e+=w.device.rules[t]._signaturesCount;return e},w.setSendPortFunction=function(e,t,n){w.getPortInfoFunction=e,w.initDeviceView=t,w.portMapToArr=n},w.deviceIpChange=function(){w.invalidIp=!w.editedInfo.ip||m.validateIp(w.editedInfo.ip),w.hasDuplicateIP=!w.invalidIp&&g.dupInOtherDevice("portIp",w.editedInfo.deviceId,h,w.editedInfo.ip),w.invalidRange=!w.invalidIp&&!w.hasDuplicateIP&&m.checkIpInSubnet(w.editedInfo.ip,h)},w.deviceMacChange=function(){w.invalidMac=w.editedInfo.mac&&!w.editedInfo.mac.match(w.validateMac),w.hasDuplicateMAC=!1,w.editedInfo.mac&&!w.invalidMac&&(w.hasDuplicateMAC=g.dupInOtherDevice("mac",w.editedInfo.deviceId,h,w.editedInfo.mac))},T(),w.setErrorClass=function(e){return e?"acl-error":"acl-correct"},w.checkNum=function(e,t){for(var n=!1,o=0;o<w.aclData.length;o++)w.aclData[o].aclNumber.toString()===e&&o!==t&&(n=!0);var a=/\D/;w.acl.acls_numValidate[t]=!(n||null===e||""===e||null!==e.match(a)||e<1||e>1024),w.checkValidation()},w.checkIp=function(e,t,n){"source"===n?w.acl.acls_sourceIpValidate[t]=b(e):w.acl.acls_destinationIpValidate[t]=b(e),w.checkValidation()},w.ipChange=function(e,t){"source"===t?w.acl.acls_sourceIpEdit[e]?w.aclData[e].sourceIp="":w.aclData[e].sourceIp="任意":w.acl.acls_destinationIpEdit[e]?w.aclData[e].destinationIp="":w.aclData[e].destinationIp="任意","source"===t?w.acl.acls_sourceIpEdit[e]?w.acl.acls_sourceIpValidate[e]=!1:w.acl.acls_sourceIpValidate[e]=!0:w.acl.acls_destinationIpEdit[e]?w.acl.acls_destinationIpValidate[e]=!1:w.acl.acls_destinationIpValidate[e]=!0,w.checkValidation()},w.checkPort=function(e,t,n){"source"===n?w.acl.acls_sourcePortValidate[t]=S(e):w.acl.acls_destinationPortValidate[t]=S(e),w.checkValidation()},w.portChange=function(e,t){"source"===t?w.acl.acls_sourcePortEdit[e]?w.aclData[e].sourcePort="":w.aclData[e].sourcePort="任意":w.acl.acls_destinationPortEdit[e]?w.aclData[e].destinationPort="":w.aclData[e].destinationPort="任意","source"===t?w.acl.acls_sourcePortEdit[e]?w.acl.acls_sourcePortValidate[e]=!1:w.acl.acls_sourcePortValidate[e]=!0:w.acl.acls_destinationPortEdit[e]?w.acl.acls_destinationPortValidate[e]=!1:w.acl.acls_destinationPortValidate[e]=!0,w.checkValidation()},w.checkAclProtocol=function(e,t){"ICMP"===e||"OPC_Classic"===e?(w.aclData[t].sourcePort="-1",w.aclData[t].destinationPort="-1",w.acl.acls_sourcePortDisable[t]=!0,w.acl.acls_destinationPortDisable[t]=!0,w.acl.acls_sourcePortEdit[t]=!1,w.acl.acls_destinationPortEdit[t]=!1):(w.acl.acls_sourcePortEdit[t]=!1,w.acl.acls_destinationPortEdit[t]=!1,w.acl.acls_sourcePortDisable[t]=!1,w.acl.acls_destinationPortDisable[t]=!1),"OPC_Classic"===e?(w.aclData[t].sourceIp="任意",w.aclData[t].destinationIp="任意",w.acl.acls_sourceIpDisable[t]=!0,w.acl.acls_destinationIpDisable[t]=!0,w.acl.acls_sourceIpEdit[t]=!1,w.acl.acls_destinationIpEdit[t]=!1):(w.acl.acls_sourceIpEdit[t]=!1,w.acl.acls_destinationIpEdit[t]=!1,w.acl.acls_sourceIpDisable[t]=!1,w.acl.acls_destinationIpDisable[t]=!1),w.portChange(t,"source"),w.portChange(t,"destination"),w.ipChange(t,"source"),w.ipChange(t,"destination")},w.addAcl=function(){for(var e=1,t=0;t<w.aclData.length;t++)e=e>w.aclData[t].aclNumber?e:parseInt(w.aclData[t].aclNumber)+1;w.aclData.push({aclNumber:e,aclAction:"permit",sourceIp:"任意",destinationIp:"任意",protocolType:"任意",sourcePort:"任意",destinationPort:"任意",aclLog:!1}),w.acl.acls_numValidate.push(!0),w.acl.acls_sourceIpValidate.push(!0),w.acl.acls_destinationIpValidate.push(!0),w.acl.acls_sourcePortValidate.push(!0),w.acl.acls_destinationPortValidate.push(!0),w.acl.acls_sourceIpEdit.push(!1),w.acl.acls_destinationIpEdit.push(!1),w.acl.acls_sourcePortEdit.push(!1),w.acl.acls_destinationPortEdit.push(!1),w.checkValidation()},w.deleteSingleAcl=function(t){var o=[{deviceACLId:w.aclData[t].deviceACLId}];e.deleteACL(n.deviceId,o).then(function(){w.aclData.splice(t,1),w.acl.acls_numValidate.splice(t,1),w.acl.acls_sourceIpValidate.splice(t,1),w.acl.acls_destinationIpValidate.splice(t,1),w.acl.acls_sourcePortValidate.splice(t,1),w.acl.acls_destinationPortValidate.splice(t,1),w.acl.acls_sourceIpEdit.splice(t,1),w.acl.acls_destinationIpEdit.splice(t,1),w.acl.acls_sourcePortEdit.splice(t,1),w.acl.acls_destinationPortEdit.splice(t,1),w.acl.acls_sourceIpDisable.splice(t,1),w.acl.acls_destinationIpDisable.splice(t,1),w.acl.acls_sourcePortDisable.splice(t,1),w.acl.acls_destinationPortDisable.splice(t,1),w.checkValidation()})},w.checkValidation=function(){for(var e=!0,t=0;t<w.aclData.length;t++)e=e&&w.acl.acls_numValidate[t]&&w.acl.acls_sourceIpValidate[t]&&w.acl.acls_destinationIpValidate[t]&&w.acl.acls_sourcePortValidate[t]&&w.acl.acls_destinationPortValidate[t];w.invalidAcl=!e},w.confirmAcl=function(){var t=l.defer();if(w.checkValidation(),!w.invalidAcl){for(var o=[],a=0;a<w.aclData.length;a++)void 0!==w.aclData[a].deviceACLId&&o.push(w.aclData[a].deviceACLId);if(o.length>0){var r=[{deviceACLId:o}];e.deleteACL(n.deviceId,r).then(function(){w.checkValidation(),P().then(function(){t.resolve("SUCCESS")})})}else P().then(function(){t.resolve("SUCCESS")})}return t.promise};var x=[],O=[];w.portsEditValidation=[],n.devicePorts.forEach(function(e){e.isMgmtPort?w.mgmt=e:(x.push(e),w.portsEditValidation.push(!0))}),w.port=n.port||{},C(),k(n.notConnectedPortMap),w.changeTopoStatus=function(e,t){w.port[e][t].model?O=O.filter(function(n){return n!==w.port[e][t].port}):O.push(w.port[e][t].port)},w.updateSubnetStatus=function(e,t,o,a){"delete"===o?(n.devicePorts[e]._subnets.splice(t,1),w.subnetsValidate[e].splice(t,1)):"add"===o?(n.devicePorts[e]._subnets.push({subnet:""}),w.subnetsValidate[e].push(!0)):(o=!a||w.validateSubnet.test(a),w.subnetsValidate[e][t]=o),w.validateSubnets()}}function n(e,t,n,o,r,i,l,s,c,d,u,p,f){function m(){T.nameError=!t.device.name||0===t.device.name.length,T.serialError=!t.device.serialNumber||0===t.device.serialNumber.length,T.serialFormatError=!c.validSNFormat(t.device.serialNumber),T.hasDuplicateSN=!1,!t.device.serialNumber||T.serialError||T.serialFormatError||(T.hasDuplicateSN=d.checkSerialNumberDup(p,t.device.serialNumber,-1)),T.modeError=!t.device.mode||0===t.device.mode.length,T.invalidIp=!t.device.ip||d.validateIp(t.device.ip),T.invalidMac=t.device.mac&&!t.device.mac.match(T.validateMac),T.hasDuplicateIP=!T.invalidIp&&u.dupInOtherDevice("portIp",-1,p,t.device.ip),T.invalidRange=!T.invalidIp&&!T.hasDuplicateIP&&d.checkIpInSubnet(t.device.ip,p),T.hasDuplicateMAC=!1,t.device.mac&&!T.invalidMac&&(T.hasDuplicateMAC=u.dupInOtherDevice("mac",-1,p,t.device.mac)),T.newModel?(T.modelError=!t.device.modelname||0===t.device.modelname.length,T.portsError=!t.device.modelnumofports||0===t.device.modelnumofports.length):(T.modelError=!t.device.modelname||0===t.device.modelname.length,T.portsError=!1)}function g(t,n){delete t.backTo,r.createDevice(t).then(function(e){I(n,e.deviceId),h(n)},function(t){e.addAlert({type:"danger",content:"添加设备失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}function h(t){r.createNodes(t).then(function(){window.location.href="/asset/securitydevice"+(""!==l?"?panel="+l:""),e.addAlert({type:"success",content:"添加设备到当前拓扑成功"})},function(t){e.addAlert({type:"danger",content:"加入当前拓扑失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}function v(e,n){t.forms.modes=[],"DATA_COLLECTION_DEVICE"===e||0===n.indexOf("KED")?(t.forms.modes[0]={},t.forms.modes[0].mode="IPS",t.forms.modes[0].modename="数采隔离模式"):0===n.indexOf("KEA")?(t.forms.modes[0]={},t.forms.modes[0].mode="IDS",t.forms.modes[0].modename="监测审计模式"):0===n.indexOf("KEV")?"KEV-U800"===n?(t.forms.modes[0]={},t.forms.modes[0].mode="IPS",t.forms.modes[0].modename="智能保护模式"):(t.forms.modes[0]={},t.forms.modes[1]={},t.forms.modes[0].mode="IPS",t.forms.modes[1].mode="ROUTING_IPS",t.forms.modes[0].modename="智能保护模式",t.forms.modes[1].modename="路由保护模式"):0===n.indexOf("KEC")&&(t.forms.modes[0]={},t.forms.modes[1]={},t.forms.modes[0].mode="IPS",t.forms.modes[1].mode="IDS",t.forms.modes[0].modename="智能保护模式",t.forms.modes[1].modename="监测审计模式"),t.device.mode=t.forms.modes[0].mode}function y(e){for(var n in t.forms.models)if(n&&t.forms.models[n].iconType&&t.forms.models[n].model===e){t.device.modelId=t.forms.models[n].modelId,t.device.model=t.forms.models[n].model,t.device.modelmake=t.forms.models[n].make,t.device.modelprotocol=t.forms.models[n].protocol,t.device.modelversion=t.forms.models[n].version,t.device.modelfirmware=t.forms.models[n].firmwareVersion,t.device.modelserial=t.forms.models[n].model_serialNo,t.device.modelmemo=t.forms.models[n].model_memo,t.device.iconType=t.forms.models[n].iconType.toLowerCase(),t.device.modelnumofports=t.forms.models[n].numOfPorts,t.device.modelsubcategory=t.forms.models[n].subCategory,t.device.modelname=t.forms.models[n].model_name+" / "+t.forms.models[n].model,v(t.forms.models[n].subCategory,t.forms.models[n].model);break}}function I(e,n){e[0]={},e[0].name=t.device.name,e[0].type=t.device.mode,e[0].zoneName="NA",e[0].importance=1,e[0].deviceId=n,e[0].ports=[];for(var o=0;o<t.device.modelnumofports;o++)e[0].ports[o]="p"+o,e[0].name=e[0].name+("_p"+o)}function D(){t.device={},t.device.category="SECURITY_DEVICE";var e=t.forms={};e.models=s,e.modes={}}var T=t.newDevice={};t.simplifyModelName=f.simplifyModelName,T.validateIp=angular.copy(d.getIPReg()),T.validateMac=angular.copy(d.getMACReg()),T.validateSubnet=angular.copy(d.getSubnetReg()),D(),m();var b;u.allDevice(p).then(function(e){b=e}),T.subCategory=l,T.backTo=l,T.done=function(){var i={},s={},c=[];t.device.mac?t.device.mac=t.device.mac.toUpperCase():"",i.name=t.device.name,i.modelId=t.device.modelId,i._configMismatch=t.device._configMismatch,i.protectedDevicesNumber=t.device.protectedDevicesNumber,i.cmmnPortnumber=t.device.cmmnPortnumber,i.isProtected=t.device.isProtected,i.iconType=t.device.iconType?t.device.iconType:"ips",i.hasUSB=t.device.hasUSB,i.hasWireless=t.device.hasWireless,i.hasPort=t.device.hasPort,i.serialNumber=t.device.serialNumber,i.devicePorts=[],i.devicePorts[0]={},i.devicePorts[0].isMgmtPort=!0,i.devicePorts[0].portName="Mgmt",i.devicePorts[0].portIp=t.device.ip,i.devicePorts[0].mac=t.device.mac;for(var d=0;d<t.device.modelnumofports;d++)i.devicePorts[d+1]={},i.devicePorts[d+1].isMgmtPort=!1,i.devicePorts[d+1].portName="p"+d;s.model=t.device.model?t.device.model:t.device.modelname,s.model_name=t.device.modelname,s.make=t.device.modelmake,s.protocol=t.device.modelprotocol,s.version=t.device.modelversion,s.firmwareVersion=t.device.modelfirmware,s.model_serialNo=t.device.modelserial,s.model_memo=t.device.modelmemo,s.numOfPorts=t.device.modelnumofports,s.iconType="ips",s.category=0,s.subCategory="DATA_COLLECTION_DEVICE"===t.device.modelsubcategory?1:0,n.all([r.getNewDevices({$orderby:"name"})]).then(function(d){var u,p=d[0];for(var f in p)if(f&&p[f].serialNumber===i.serialNumber){u=p[f];break}u?n.when(a(o,n,u,i)).then(function(){r.addToCurrentTopology(u.deviceId,"").then(function(){window.location.href="/asset/securitydevice"+(""!==l?"?panel="+l:""),e.addAlert({type:"success",content:"加入当前拓扑成功"})},function(){e.addAlert({type:"danger",content:"加入当前拓扑失败"})})}):T.newModel?r.createModel(s).then(function(e){i.modelId=e.modelId,t.forms.models.splice(1,0,{modelId:e.modelId,model_name:s.model_name}),t.device.modelId=e.modelId,T.newModel=!1,g(i,c)},function(t){e.addAlert({type:"danger",content:"添加设备型号失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})}):g(i,c)})},T.validateDevice=function(){m()},T.serialNumberChanged=function(e){t.device.model="",t.device.modelname="",t.device.modelmake="",t.device.modelmemo="",t.device.modelnumofports="",t.device.mode="",t.forms.modes=[];var n=c.getModelBySN(e,t.forms.models);n&&y(n.model)}}function o(e){function t(e){e.selectedPort="mgmt",e.ports=[{name:"P0/P1",mode:"IDS",status:1,sub:[{name:"P0",status:1},{name:"P1",status:1}]},{name:"P2/P3",mode:"IDS",status:1,sub:[{name:"P2",status:0},{name:"P3",status:1}]}],e.selectPort=function(t){var n;if("P0"===t||"P1"===t)n=0;else{if("P2"!==t&&"P3"!==t)return void(e.selectedPort=t);n=1}"IPS"===e.ports[n].mode?e.selectedPort=e.ports[n].name:e.selectedPort=t},e.is=function(t,n){return e.selectedPort===t||e.selectedPort===n},e.portsWidth=function(){for(var t=1,n=0;n<e.ports.length;n++)t+="IDS"===e.ports[n].mode?2:1;return 290*t}}var n=this;t(n),n.editRight=30===e.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue}function a(e,t,n,o){var a=t.defer();return e.open({size:"sm",templateUrl:"templates/asset/securitydevice/confirm-panel.952c69dd.html",controller:function(e,t){e.title="发现相同序列号设备",e.content1='已安装设备中" '+o.name+' "与自动发现的新设备＂'+n.name+"＂序列号相同（SN: "+o.serialNumber+"）。",e.content2='请注意，此操作可能会导致"'+o.name+'"的设备规格与MAC地址被覆盖。',e.confirm=function(){t.close(),a.resolve()},e.cancel=function(){t.dismiss("cancel"),a.reject()}}}),a.promise}e.$inject=["Enum","$modal","$rootScope","$scope","$state","Topology","Device","protocols","uiCtrl","uiTree"],t.$inject=["Device","Topology","device","$rootScope","Enum","$scope","$q","$modal","$state","System","protocols","models","snVal","formatVal","dupeInfo","allDeviceFull","deviceTypeService"],o.$inject=["Enum"],n.$inject=["$rootScope","$scope","$q","$modal","Device","categories","subCategory","models","snVal","formatVal","dupeInfo","allDeviceFull","deviceTypeService"],angular.module("southWest.asset.securitydevice").controller("SecurityDeviceCtrl",e).controller("SecurityDeviceDetailCtrl",t).controller("SecurityDevicePortsCtrl",o).controller("SecurityDeviceNewCtrl",n)}(),function(){"use strict";function e(e,t,n,o,a){function r(r){function i(){var t={};t.$orderby="name",e.getNewDevices(t).then(function(e){l.table=e})}var l=this;l.simplifyModelName=r.simplifyModelName,l.table=[],l.addModal=function(r){function i(a){r.isAdding=!0,e.addToCurrentTopology(r.deviceId,a).then(function(){r.isAdding=!1;var e=o.get("Role");if(!e[0].defaultRole){var a=o.get("deviceAccess");a||(a=[]),a.push(r.deviceId)}n.reload().then(function(){t.addAlert({type:"success",content:"加入当前拓扑成功"})})},function(e){r.isAdding=!1,t.addAlert({type:"danger",content:"加入当前拓扑失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}function l(){function e(e,t){e.cancel=function(){t.dismiss("cancel")},e.confirm=function(){i(e.vKey),t.close("done")}}e.$inject=["$scope","$modalInstance"],a.open({templateUrl:"templates/asset/securitydevice/verification-panel.015abe97.html",size:"sm",controller:e})}t.isC05?l():i("")},l.removeNewDevice=function(e){l.confirmRemove(e)},l.confirmRemove=function(o){function r(e,t){e.device=o,e.cancel=function(){t.close(!1)},e.confirm=function(){t.close(!0)}}r.$inject=["$scope","$modalInstance"];var i=a.open({templateUrl:"templates/asset/securitydevice/removeNewDeviceModal.ac087d0a.html",size:"sm",controller:r,resolve:{device:function(){return o}}});i.result.then(function(a){a&&e.removeNewDevice(o.deviceId).then(function(){for(var e=0;e<l.table.length;e++)if(l.table[e].deviceId===o.deviceId){l.table.splice(e,1);break}n.reload()},function(){t.addAlert({type:"danger",content:"删除设备失败"+(a&&a.data&&a.data.error?"："+a.data.error:"")})})})},i(),t.$on("device",function(){i()})}var i={scope:!1,restrict:"E",templateUrl:"/templates/asset/securitydevice/securityNewDeviceTable.6bf775c0.html",controller:r,controllerAs:"newdevice",link:function(){}};return i}function t(e,t,o,a,r,i){function l(l,s,c,d){function u(a){a.$orderby&&""!==a.$orderby||(a.$orderby="name");var r=a||{};return r.$filter=m,t.getAll(r).then(function(a){for(var r=0;r<a.length;r++){a[r]._iconName=t.getIconName(a[r].iconType);var l=a[r]._model_name?a[r]._model_name.split(" /"):[];"数控审计保护平台"===l[0]&&(a[r]._model_name=i("resFilter")(l[0],"slideAuditTitle")+" /"+l[1])}var s=a.map(function(e){return o.getDeviceNodes(e.deviceId)});return s.length?e.all(s).then(function(t){var o=a.map(function(e,n){for(var o=[],r=0;r<t[n][0].ports.length;r++)o.push(+t[n][0].ports[r].substr(1));var i=o.sort();t[n][0].portRange="p"+i[0]+"-p"+i[i.length-1],a[n].nodes=t[n]});return e.all(o).then(function(){return n(a)})}):[]})}function p(e){var n=e||{};return n.$filter=m,t.getCount(n,a.id)}function f(e){return t.search("SECURITY_DEVICE",e)}d.disableToolbar=!0;var m="(category eq SECURITY_DEVICE)",g=r.get("Role");if(!g[0].defaultRole){var h=r.get("deviceAccess");h.length?(m+=" and (",m+=h.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),m+=")"):m+=" and (contains(deviceId, 'null'))"}d.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:u,getCount:p,search:f})}function s(e,n){var o=this;o.simplifyModelName=n.simplifyModelName,o.updateNodeProperty=function(n){var o={nodeProperty:n.tempNodeProperty};return n.isedting=!1,t.updateNodeProperty(n.id,o).then(function(t){e.addAlert({type:"success",content:"修改部署属性成功"}),n.nodeProperty=t.nodeProperty},function(){e.addAlert({type:"danger",content:"修改部署属性失败"})})}}var c={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/asset/securitydevice/securityDeviceTable.bc6cc8b1.html",controller:s,controllerAs:"securitydeviceTable",link:l};return c}function n(e){for(var t in e)if(t&&e[t].nodes)for(var n in e[t].nodes)if(n&&e[t].nodes[n].ports&&"IPS"===e[t].nodes[n].type&&1===e[t].nodes[n].online)for(var o in e[t].nodes[n].ports){if(1!==e[t].nodes[n].online)break;if(o&&e[t].nodes[n].ports[o])for(var a in e[t].devicePorts)if(a&&e[t].devicePorts[a].portName===e[t].nodes[n].ports[o]&&1!==e[t].devicePorts[a].linkState){e[t].nodes[n].online=e[t].devicePorts[a].linkState;break}}return e}e.$inject=["Device","$rootScope","$state","Enum","$modal"],t.$inject=["$q","Device","Topology","topologyId","Enum","$filter"],angular.module("southWest.asset.securitydevice").directive("securityNewDeviceTable",e).directive("securityDeviceTable",t)}(),function(){"use strict";function e(e){e.state("asset.ucddevice",{parent:"dashboard",url:"/asset/ucddevice",controller:"UCDDeviceCtrl as ucddevice",templateUrl:"templates/asset/ucddevice/index.fed845ad.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.ucddevice.detail",{parent:"dashboard",url:"/ucddevice/deviceid/:deviceID?panel?ip",controller:"UCDDeviceDetailCtrl as ucddetail",templateUrl:"templates/asset/ucddevice/details/details.8ab5f232.html",resolve:{device:["$stateParams","$q","Device","Topology","topologyId","domain","$rootScope","UCD",function(e,t,n,o,a,r,i,l){function s(){return c=l.getDomain(e.ip),n.get(e.deviceID,c.topoId,c.ip).then(function(a){return t.all([n.getBlocksRef(a.blocksRef.baseUrl,e.ip),o.getDeviceNodes(a.deviceId,e.ip)]).then(function(e){return a.rules=e[0],a.nodes=e[1],a._iconName=n.getIconName(a.iconType),a})},function(){return!1})}return a.id?s():r.getDomain().then(function(){return s()});var c}],models:["$stateParams","topologyId","Device","domain",function(e,t,n,o){function a(){return n.get(e.deviceID).then(function(e){return r(e.category)},function(){return!1})}function r(e){return n.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq "+e,$limit:1e6,$orderby:"model_name"})}return t.id?a():o.getDomain().then(function(){return a()})}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("asset.ucddevice.new",{parent:"dashboard",url:"/ucddevice/new",controller:"UCDDeviceNewCtrl as newucd",templateUrl:"templates/asset/ucddevice/details/new.html",resolve:{models:["Device",function(e){return e.getModels({$select:["modelId","model","model_name","make","protocol","version","firmwareVersion","model_serialNo","model_memo","iconType","numOfPorts","subCategory"],$filter:"category eq NETWORK_DEVICE",$limit:1e6,$orderby:"model_name"})}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.asset.ucddevice").config(e)}(),function(){"use strict";function e(e){var t=this;t.editRight=30===e.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue}function t(e,t,n,r,i,l,s){function c(t){e.update(t.deviceId,t).then(function(){p.isEdited=!1,r.reload().then(function(){n.addAlert({type:"success",content:"修改设备成功"})})},function(e){n.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}function d(){p.nameError=!p.editedInfo.name||0===p.editedInfo.name.length,p.serialError=!p.editedInfo.serialNumber||0===p.editedInfo.serialNumber.length,p.newModel?p.modelError=!p.editedInfo._model_name||0===p.editedInfo._model_name.length:p.modelError=!p.editedInfo.modelId||0===p.editedInfo.modelId.length}function u(e){for(var t in p.forms.models)if(t&&p.forms.models[t].iconType&&p.forms.models[t].modelId===e){p.editedInfo.modelId=e,p.editedInfo.make=p.forms.models[t].make,p.editedInfo.iconType=p.forms.models[t].iconType?p.forms.models[t].iconType:p.editedInfo.iconType?p.editedInfo.iconType:"unknown-device";break}}var p=this;p.device=t,p.validateIp=angular.copy(o),p.validateMac=angular.copy(a),p.validate=[];var f=p.forms={};f.models=l,f.models.splice(0,0,{modelId:"new",model_name:"添加设备型号"}),p.editIP=function(){p.editedInfo=angular.copy(p.device);for(var e=0;e<p.device.devicePorts.length;e++)if(p.device.devicePorts[e].isMgmtPort){p.editedInfo.ip=p.device.devicePorts[e].portIp,p.editedInfo.mac=p.device.devicePorts[e].mac;break}p.invalidIp=p.editedInfo.ip&&!p.editedInfo.ip.match(p.validateIp),p.invalidMac=p.editedInfo.mac&&!p.editedInfo.mac.match(p.validateMac),p.isIPEdited=!0},p.editIPCancel=function(){angular.copy(p.editedInfo,p.device),p.isIPEdited=!1},p.editIPDone=function(){var t={portIp:p.editedInfo.ip,mac:p.editedInfo.mac?p.editedInfo.mac:""};e.updateMgmIpMac(p.device.topologyId,p.device.deviceId,t).then(function(){p.isIPEdited=!1,r.reload().then(function(){n.addAlert({type:"success",content:"修改设备端口成功"})})},function(e){n.addAlert({type:"danger",content:"修改设备端口失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})},p.editDevice=function(){delete p.device.port,p.editedInfo=angular.copy(p.device),p.isEdited=!0,d()},p.editCancel=function(){p.isEdited=!1},p.editDone=function(){var t={};angular.copy(p.device,t),t.name=p.editedInfo.name,t.serialNumber=p.editedInfo.serialNumber,t.make=p.editedInfo.make,t.iconType=p.editedInfo.iconType,delete t.rules,delete t.nodes,delete t._rulesCount,delete t._signaturesCount,delete t._iconName,delete t._networkCount,delete t.showRoutingInfo,delete t.ip,delete t.mac,i.all([e.hasDuplicateSN(t.deviceId,t.serialNumber)]).then(function(o){var a=o[0];if(a)n.addAlert({type:"danger",content:"添加设备失败：设备序列号已经存在。"});else if(p.newModel){var r={};r.model=p.editedInfo._model_name,r.model_name=p.editedInfo._model_name,r.make=p.editedInfo.make,r.iconType=p.editedInfo.iconType,r.category=2,e.createModel(r).then(function(e){t.modelId=e.modelId,p.forms.models.splice(1,0,{modelId:e.modelId,model_name:r.model_name}),p.editedInfo.modelId=e.modelId,p.newModel=!1,c(t)},function(e){n.addAlert({type:"danger",content:"添加设备型号失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}else t.modelId=p.editedInfo.modelId,c(t)})},p.validateDevice=function(){d()},p.serialChange=function(){"SECURITY_DEVICE"===p.editedInfo.category?p.serialNumberChanged(p.editedInfo.serialNumber):"",d()},p.serialNumberChanged=function(e){p.editedInfo.model="",p.editedInfo._model_name="",p.editedInfo.make="",p.editedInfo.modelId="",p.editedInfo.numOfPorts="";var t=s.getModelBySN(e,p.forms.models);t&&(p.editedInfo._model_name=t.modelName,u(t.id))},p.modelChange=function(e){"new"===e?(p.newModel=!0,p.editedInfo.model="",p.editedInfo._model_name="",p.editedInfo.make="",p.editedInfo.modelId=""):(p.newModel=!1,u(e)),p.validateDevice()},p.deviceIpChange=function(){p.invalidIp=p.editedInfo.ip&&!p.editedInfo.ip.match(p.validateIp)},p.deviceMacChange=function(){p.invalidMac=p.editedInfo.mac&&!p.editedInfo.mac.match(p.validateMac)}}function n(e,t,n,r,i){function l(){p.nameError=!t.device.name||0===t.device.name.length,p.modeError=!t.device.mode||0===t.device.mode.length,p.invalidIp=t.device.ip&&!t.device.ip.match(p.validateIp),p.invalidMac=t.device.mac&&!t.device.mac.match(p.validateMac),p.newModel?p.modelError=!t.device.modelname||0===t.device.modelname.length:p.modelError=!t.device.modelname||0===t.device.modelname.length}function s(t,n){r.createDevice(t).then(function(e){n[0].deviceId=e.deviceId,c(n)},function(t){e.addAlert({type:"danger",content:"添加设备失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")
})})}function c(t){r.createNodes(t).then(function(){window.location.href="/asset/networkdevice",e.addAlert({type:"success",content:"添加设备到加入当前拓扑成功"})},function(t){e.addAlert({type:"danger",content:"加入当前拓扑失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})}function d(e){for(var n in t.forms.models)if(n&&t.forms.models[n].modelId===e){t.device.modelId=t.forms.models[n].modelId,t.device.model=t.forms.models[n].model,t.device.modelmake=t.forms.models[n].make,t.device.modelprotocol=t.forms.models[n].protocol,t.device.modelversion=t.forms.models[n].version,t.device.modelfirmware=t.forms.models[n].firmwareVersion,t.device.modelserial=t.forms.models[n].model_serialNo,t.device.modelmemo=t.forms.models[n].model_memo;var o=t.forms.models[n].iconType;o?t.device.modelicontype=o:p.modeChange();break}}function u(){t.device={},t.device.category="NETWORK_DEVICE";var e=t.forms={};e.models=i,e.models.splice(0,0,{modelId:"new",model_name:"添加设备型号"}),t.forms.modes=[{mode:"SWITCH",modename:"网络交换机",icontype:"switch"},{mode:"ROUTER",modename:"路由器",icontype:"router"},{mode:"ENDPOINT",modename:"其它",icontype:"unknown-device"}]}var p=t.newDevice={};p.validateIp=angular.copy(o),p.validateMac=angular.copy(a);var f;u(),l(),p.done=function(){var o={},a={},i=[];o.name=t.device.name,o.modelId=t.device.modelname,o._configMismatch=t.device._configMismatch,o.protectedDevicesNumber=t.device.protectedDevicesNumber,o.cmmnPortnumber=t.device.cmmnPortnumber,o.isProtected=t.device.isProtected,o.iconType=t.device.modelicontype,o.hasUSB=t.device.hasUSB,o.hasWireless=t.device.hasWireless,o.hasPort=t.device.hasPort,o.serialNumber=t.device.serialNumber,o.devicePorts=[],o.devicePorts[0]={},o.devicePorts[0].isMgmtPort=!0,o.devicePorts[0].portIp=t.device.ip,o.devicePorts[0].mac=t.device.mac,a.model=t.device.model?t.device.model:t.device.modelname,a.model_name=t.device.modelname,a.make=t.device.modelmake,a.protocol=t.device.modelprotocol,a.version=t.device.modelversion,a.firmwareVersion=t.device.modelfirmware,a.model_serialNo=t.device.modelserial,a.model_memo=t.device.modelmemo,a.numOfPorts=t.device.modelnumofports,a.iconType=t.device.modelicontype,a.category=2,i[0]={},i[0].name=t.device.name,i[0]._MAC=t.device.mac,i[0]._ip=t.device.ip,i[0].type=t.device.mode,i[0].zoneName="NA",n.all([r.hasDuplicateSN(o.deviceId,o.serialNumber),r.hasDuplicateIP(o.deviceId,t.device.ip)]).then(function(n){var l=n[0],c=n[1];l&&e.addAlert({type:"danger",content:"添加设备失败：设备序列号已经存在。"}),c&&e.addAlert({type:"danger",content:"添加设备失败：设备IP已经存在。"}),l||c||(p.newModel?r.createModel(a).then(function(e){o.modelId=e.modelId,t.forms.models.splice(1,0,{modelId:e.modelId,model_name:a.model_name}),t.device.modelname=e.modelId,p.newModel=!1,s(o,i)},function(t){e.addAlert({type:"danger",content:"添加设备型号失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})}):s(o,i))})},p.validateDevice=function(){l()},p.modelChange=function(e){"new"===e?(p.newModel=!0,t.device.model="",t.device.modelname="",t.device.modelmake="",t.device.modelprotocol="",t.device.modelversion="",t.device.modelfirmware="",t.device.modelserial="",t.device.modelmemo=""):(p.newModel=!1,d(e)),p.validateDevice()},p.modeChange=function(){if("ROUTER"!==t.device.mode&&(t.device.ip="",t.device.mac=""),t.device.modename){for(var e in t.forms.modes)if(e&&t.forms.modes[e].modename===t.device.modename.modename){t.device.mode=t.forms.modes[e].mode,t.device.modelicontype=f?f:t.forms.modes[e].icontype;break}p.validateDevice()}}}e.$inject=["Enum"],t.$inject=["Device","device","$rootScope","$state","$q","models","snVal"],n.$inject=["$rootScope","$scope","$q","Device","models"],angular.module("southWest.asset.ucddevice").controller("UCDDeviceCtrl",e).controller("UCDDeviceDetailCtrl",t).controller("UCDDeviceNewCtrl",n);var o=/^([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$/,a=/^(([A-Fa-f0-9]{2}[:]){5}[A-Fa-f0-9]{2}[,]?)+$/}(),function(){"use strict";function e(e,t,n,o,a,r){function i(t,i,l,s){function c(t){t.$orderby&&""!==t.$orderby||(t.$orderby="name");var n=t||{};return n.$filter=p,e.getAll(n).then(function(t){for(var n=0;n<t.length;n++){t[n]._iconName=e.getIconName(t[n].iconType);for(var o=0;o<t[n].devicePorts.length;o++)t[n].devicePorts[o].isMgmtPort&&(t[n].mmIP=t[n].devicePorts[o].portIp)}var i=t.map(function(e){return r.getDeviceNodes(e.deviceId)});return i.length?a.all(i).then(function(n){var o=t.map(function(o,a){return t[a].nodes=n[a],e.getNodeRules(t[a].nodes).then(function(e){o.nodes=e})});return a.all(o).then(function(){return t})}):[]})}function d(t){var n=t||{};return n.$filter=p,e.getCount(n)}function u(t){return e.search("SECURITY_DEVICE",t)}s.disableToolbar=!0;var p="category eq SECURITY_DEVICE";s.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:c,getCount:d,search:u}),s.getSecondLevelTableData=function(t){for(var r,i=0;i<t.devicePorts.length;i++)if(t.devicePorts[i].isMgmtPort){r=t.devicePorts[i].portIp;break}a.all([o.autoLogin(r,"")]).then(function(){var t=[];t.$orderby&&""!==t.$orderby||(t.$orderby="name");var o=t||{};o.$filter="category ne SECURITY_DEVICE";var a,i=n.ucdInfo;i&&i.filter(function(e){a=e.ip===r?e.topoId:e.topoId}),e.getAll(o,a,r).then(function(e){s.secondLevelTable=e})})}}var l={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/asset/ucddevice/ucdDeviceTable.964a482a.html",link:i};return l}e.$inject=["Device","UCD","$rootScope","auth","$q","Topology"],angular.module("southWest.asset.ucddevice").directive("ucdDeviceTable",e)}(),function(){"use strict";function e(e){e.state("attack",{parent:"dashboard",url:"/attack",controller:"AttackCtrl as attack",templateUrl:"templates/attack/index.6ae661bb.html",resolve:{state:["$rootScope",function(e){e.currentState="ATTACKPATH"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.attack").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c){function d(e,t){o.uploadMultipleFiles(e,t).then(function(e){},function(e){l.addAlert({type:"danger",content:e.data.error})})}var u,p,f=this;e.attackDirective={selectedDevice:null},e.topo={},e.uploader=new Object({}),f.editSelectedDevice,f.queryArray=[],f.attackTarget=[],f.targetQuery=[],f.targetElement=[],f.attackDevcie=[],f.attackDeviceTableShow=[],f.deviceSelectedName=null,f.attackPathArray=[],f.targets=[],f.switchPath=function(t){o.getPath(s.id).then(function(n){e.currentPath=n.data[t],o.getAttackTarget(e.currentPath.pathId).then(function(e){0===e.data.length?(f.attackTarget=e.data,f.attackTarget.push("default")):(f.attackTarget=e.data,f.attackTarget.push("default"))})})},f.addPath=function(t){t>=1?(p.setAttackedTargetArray(f.attackTarget),o.createAttackPath(s.id,{pathName:"攻击路径"+(t+1)}).then(function(t){e.currentPath=t.data,p=new r,p.setTopologyId(e.currentPath.topologyId),p.setPathId(e.currentPath.pathId),p.setName(e.currentPath.pathName),f.attackPathArray.push(p)})):0===t&&c.getDomain().then(function(){o.getPath(s.id).then(function(n){if(n.data.length){e.currentPath=n.data[0];for(var a=0;a<n.data.length;a++)p=new r(n.data[a]),f.attackPathArray.push(p);f.getAllTargets()}else o.createAttackPath(s.id,{pathName:"攻击路径"+(t+1)}).then(function(t){e.currentPath=t.data,p=new r,p.setTopologyId(e.currentPath.topologyId),p.setPathId(e.currentPath.pathId),p.setName(e.currentPath.pathName),f.attackPathArray.push(p)})})}),f.attackTarget=["default"]},f.getAllPath=function(t){0===t?f.addPath(0):o.getPath(s.id).then(function(n){if(n.data.length)for(var a=0;a<n.data.length;a++)p=new r(n.data[a]),f.attackPathArray.push(p);else o.createAttackPath(s.id,{pathName:"攻击路径"+(t+1)}).then(function(t){e.currentPath=t.data,p=new r,p.setTopologyId(e.currentPath.topologyId),p.setPathId(e.currentPath.pathId),p.setName(e.currentPath.pathName),f.attackPathArray.push(p),f.getAllTargets()})})},f.getAllTargets=function(){o.getAttackTarget(e.currentPath.pathId).then(function(e){f.attackTarget.splice(-1,1);for(var t=0;t<e.data.length;t++)f.attackTarget.push(e.data[t]);f.attackTarget.push("default")})},f.attackDeviceTableToggle=function(e){f.attackDeviceTableShow[e]=!f.attackDeviceTableShow[e]},f.attackDeviceTableHide=function(e){f.attackDeviceTableShow[e]=!1},f.createTargetTab=function(e){for(var t=0;t<f.targetQuery.length;t++)t!==e&&(f.targetQuery[t]=!1);f.targetQuery[e]=!f.targetQuery[e]},f.editTargetTab=function(t){f.createTargetTab(t),o.getAttackTarget(e.currentPath.pathId).then(function(n){f.selectedTarget=n.data[t].selectedTarget,f.selectedMethod=n.data[t].attackMethod,f.selectedDescription=n.data[t].customDescription,f.selectedResult=n.data[t].description,f.deviceSelectedName=n.data[t].targetName,f.attackDevice=n.data[t].attackTargetList,f.attackAttachedFile=n.data[t].attachedFile,e.attackDirective.selectedDevice=n.data[t].selectedTarget,f.editTargetId=n.data[t].targetId})},f.clearTab=function(){f.selectedMethod=null,f.selectedDescription=null,f.selectedResult=null,f.deviceSelectedName=null,f.attackDevice=null},f.createAttackTarget=function(){u=new a,f.attackTarget.push(1)},f.relation=function(){f.relations=[],o.getQuery().then(function(e){f.targets=e.data,f.addQueryElement(0)})},f.addQueryElement=function(){var e={};e.selectedSearchField=f.targets[0].searchField,e.selectedSearchName=f.targets[0].searchName,e.selectedOperator=n("selectConvert")(f.targets[0].operatorType[0]).toString(),e.detail=f.targets[0],f.queryArray.length>0?e.relatedCondition="and":e.relatedCondition="none",e.method="select",o.getQueryDetail(s.id,e.selectedSearchName).then(function(t){e.infor=t.data,e.selectedInfor=e.infor[0],f.queryArray.push(e)})},f.getQueryDetail=function(){o.getQueryDetail(s.id).then(function(e){f.queryDetail=e.data})},f.deleteQueryElement=function(e){f.queryArray.splice(e,1)},f.setDefaultTargetValue=function(e,t){f.queryArray[t].selectedOperator=n("selectConvert")(f.queryArray[t].detail.operatorType[0]).toString(),f.queryArray[t].selectedSearchName=f.queryArray[t].detail.searchName,f.queryArray[t].selectedSearchField=f.queryArray[t].detail.searchField,o.getQueryDetail(s.id,f.queryArray[t].detail.searchName).then(function(e){f.queryDetail=e.data,f.queryArray[t].infor=e.data,f.queryArray[t].selectedInfor=e.data[0]})},f.sendQueryRequest=function(){u.setQuery(f.queryArray);for(var t="nodes?$filter=",a=0;a<f.queryArray.length;a++)"none"!==f.queryArray[a].relatedCondition&&(t+=" "+f.queryArray[a].relatedCondition+" "),f.queryArray[a].selectedOperator=n("selectConvertBack")(f.queryArray[a].selectedOperator),t+="co"===f.queryArray[a].selectedOperator?"contains("+f.queryArray[a].selectedSearchName+", '"+f.queryArray[a].selectedInfor+"')":f.queryArray[a].selectedSearchName+" "+f.queryArray[a].selectedOperator+" '"+f.queryArray[a].selectedInfor+"'";o.getAttackTargetFilter(e.currentPath.topologyId,e.currentPath.pathId,t).then(function(e){f.attackDevice=e.data})},f.getInputDevice=function(e){f.editSelectedDevice=e},f.deviceChecked=function(){f.editSelectedDevice&&(f.deviceSelectedName=f.editSelectedDevice.nodeName,u.setSelectedDevice(f.editSelectedDevice.nodeId))},f.setAttackMethod=function(){f.attackMethod=["自定义手段"]},f.sendMethod=function(){f.selectedMethod===f.attackMethod[0];var e={method:f.selectedMethod,description:f.selectedDescription};e.method||(e.method=null),e.description||(e.description=null),u.setMethod(e)},f.checkshit=function(){},f.finish=function(t){var n=[];f.selectedResult||(f.selectedResult=null),u.setResult(f.selectedResult),u.updateAttackedDevice();for(var a=0;a<f.attackDevice.length;a++)n.push(f.attackDevice[a].nodeId);if(f.attackTarget.length-1-t<=0){var r={targetName:f.deviceSelectedName,queryConditions:"",selectedTarget:u.selectedId,selectedTargetList:n,attackMethod:u.attackMethod.method,customDescription:u.attackMethod.description,description:f.selectedResult,targetOrder:t+1,createdAt:new Date};o.createAttackTarget(e.currentPath.pathId,r).then(function(t){f.attackTarget.splice(-1,1),f.attackTarget.push(t.data),f.createAttackTarget();for(var n=0;n<e.uploader.array.length;n++)d(t.data.targetId,e.uploader.array[n])})}else{var i={targetId:f.editTargetId,targetName:f.deviceSelectedName,queryConditions:"",selectedTarget:f.selectedTarget,selectedTargetList:n,attackMethod:f.selectedMethod,customDescription:f.selectedDescription,description:f.selectedResult};o.editAttackTarget(e.currentPath.pathId,f.editTargetId,i).then(function(t){for(var n=0;n<f.attackTarget.length;n++){var o=f.attackTarget[n];o.targetId===t.data.targetId&&(f.attackTarget[n].targetName=t.data.targetName)}for(var a=0;a<e.uploader.array.length;a++)d(t.data.targetId,e.uploader.array[a])})}},l.$on("delete-file",function(e,t){f.attackAttachedFile.splice(t,1)}),f.closeAlert=function(e){f.alerts.splice(e,1)},f.createAttackTarget(),f.getAllPath(0),f.relation(),f.setAttackMethod(),f.tried=function(){}}e.$inject=["$scope","$compile","$filter","Attack","AttackedDevice","AttackedPath","Topology","$rootScope","topologyId","domain"],angular.module("southWest.attack").controller("AttackCtrl",e)}(),function(){"use strict";function e(e){function t(t,n,o,a){function r(){return e.getAttackTarget(t.currentPath.pathId).then(function(){return 0})}function i(){return e.getAttackTarget(t.currentPath.pathId).then(function(){return 0})}function l(){}a.setConfig({name:"events",pagination:!1,scrollable:!1,totalCount:!1,getAll:r,getCount:i,search:l}),a.disableSearch=!0}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/attack/table.3715b95c.html",link:t};return n}function t(){function e(){function e(e){e.nodeTemplate=n(go.Node,"Auto",n(go.Panel,"Vertical",n(go.TextBlock,{margin:10,stroke:"red"},new go.Binding("text","key")),n(go.Picture,{margin:10,width:90,height:100,background:"#353535"},new go.Binding("source","img")),n(go.Panel,n(go.Shape,{alignment:go.Spot.Bottom,click:t,figure:"Ellipse",width:50,height:50,fill:"lime",strokeWidth:2,stroke:"yellow"}),n(go.Shape,{position:new go.Point(13,13),figure:"ThickCross",fill:"white",width:25,height:25,stroke:null})))),e.linkTemplate=n(go.Link,{routing:go.Link.Orthogonal,corner:5},n(go.Shape));var o=[{key:"攻击者",img:"images/hacker.b5acdf82.png"},{key:"pc-2",img:"images/pc-2.7c2cd12e.png",parent:"攻击者"}];e.model=new go.TreeModel(o)}function t(e,t){var n=t.part,o=n.diagram;o.startTransaction("add node and link");var a={key:"pc",img:"images/workstation-icon.4bb4089c.png",parent:n.data.key};o.model.addNodeData(a),o.commitTransaction("add node and link")}var n=go.GraphObject.make,o=n(go.Diagram,"multiplePath",{initialContentAlignment:go.Spot.TopCenter,"undoManager.isEnabled":!0});e(o),o.layout=n(go.TreeLayout,{angle:90})}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/attack/multiple.9bc3398b.html",link:e};return t}function n(e,t,n,o,a){function r(r){function i(e){function t(e){var t=e.diagram;t.startTransaction("highlight"),t.clearHighlighteds(),e.isHighlighted=!0,e.findNodesOutOf().each(function(e){e.isHighlighted=!0}),t.commitTransaction("highlight")}var a=[],i=go.GraphObject.make,l=1,s=i(go.Diagram,"topologyPath",{initialContentAlignment:go.Spot.Center,initialScale:null===localStorage.getItem("monitor:topology.scale."+l)?1:parseFloat(localStorage.getItem("monitor:topology.scale."+l)),"toolManager.mouseWheelBehavior":go.ToolManager.WheelZoom,"undoManager.isEnabled":!0});s.nodeTemplate=i(go.Node,"Auto",{margin:50,width:80,height:95,click:function(e,n,o){t(n,o)}},new go.Binding("location","loc",go.Point.parse),i(go.Shape,{stroke:"yellow",strokeWidth:0,name:"SHAPE",fill:"#2a2b31"}),i(go.Panel,"Vertical",{toolTip:i(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},i(go.Shape,"Rectangle",{isPanelMain:!0,maxSize:new go.Size(500,NaN)}),i(go.Panel,"Vertical",{margin:10},i(go.TextBlock,{text:"",alignment:go.Spot.Left,stroke:"white",overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN)},new go.Binding("text","text"))))},i(go.Panel,"Vertical",{},i(go.Panel,{width:65,height:55,background:"#1c1f1f",portId:"",fromSpot:go.Spot.None,toSpot:go.Spot.None},i(go.Shape,"RoundedRectangle",{stroke:"red",fill:"#1c1f1f",strokeWidth:2,opacity:1,width:63,height:53,visible:!1},new go.Binding("visible","targetOrder",function(e){return!!e})),i(go.Picture,{margin:new go.Margin(12,0,0,8),width:50,height:35,background:"#1c1f1f",imageStretch:go.GraphObject.Uniform},new go.Binding("source","img"))),i(go.TextBlock,{margin:new go.Margin(2,2,2,2),stroke:"white",background:"#1c1f1f",isMultiline:!1,width:60,textAlign:"center",overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,name:"TEXT"},new go.Binding("text","text")))),i(go.Shape,"Ellipse",{alignment:go.Spot.TopLeft,fill:"red",width:20,height:20,margin:0,stroke:"red",visible:!1},new go.Binding("visible","targetOrder",function(e){return!!e})),i(go.TextBlock,{alignment:go.Spot.TopLeft,stroke:"white",width:20,height:20,font:"bold 10pt serif",margin:new go.Margin(3,0,0,6),visible:!0},new go.Binding("text","targetOrder"))),s.linkTemplate=i(go.Link,{curve:go.Link.JumpOver},new go.Binding("routing","link"),i(go.Shape,new go.Binding("strokeWidth","strokeWidth"),new go.Binding("stroke","color")),i(go.Shape,{strokeWidth:3},new go.Binding("stroke","color"),new go.Binding("toArrow","toArrow"),new go.Binding("fill","color")));for(var c=[],d=0;d<e.nodes.length;d++){var u=o.getIconName(e.nodes[d]._iconType),p="images/";["IPS","IDS","ROUTING_IPS","INLINE_IDS"].indexOf(e.nodes[d].type)>=0&&(p+="devices/security/");var f={key:e.nodes[d].id,text:e.nodes[d].name,img:p+u+"-icon.png",loc:e.nodes[d].x+" "+e.nodes[d].y};c.push(f)}for(var m=[],g=0;g<e.links.length;g++){var h={from:e.links[g].nodeID,to:e.links[g].destinationNodeID,color:"gray",toArrow:"",strokeWidth:"1",link:go.Link.AvoidsNodes};m.push(h)}n.getAttackTarget(r.currentPath.pathId).then(function(e){if(e.data.length>1){for(var t=1;t<e.data.length;t++){var n={from:e.data[t-1].selectedTarget,to:e.data[t].selectedTarget,color:"red",toArrow:"Standard",strokeWidth:"3",link:go.Link.Normal,targetOrder:e.data[t].targetOrder};a.push(n)}for(var o=0;o<e.data.length;o++)for(var r=0;r<c.length;r++)e.data[o].selectedTarget===c[r].key.toString()&&(c[r].targetOrder=e.data[o].targetOrder)}var i=m.concat(a);s.model=new go.GraphLinksModel(c,i)}),s.click=function(){s.startTransaction("no highlighteds"),s.clearHighlighteds(),s.commitTransaction("no highlighteds")},r.zoom=function(e){s.scale*=e},r.show_image=function(){var e=s.makeImage({type:"image/jpeg",scale:1});document.body.appendChild(e)}}e.getTopo(a.id).then(function(n){r.topo.topo=n;var o=n.topologyId,a=e.getNodes(o),l=e.getLinks(o),s=[];s.push(a),s.push(l),t.all(s).then(function(e){if(e[0].data)for(var t=0;t<e[0].data.length;){var n=!1;if(e[1].data)for(var o=e[0].data[t].id,a=0;a<e[1].data.length;a++)if(e[1].data[a].nodeID===o||e[1].data[a].destinationNodeID===o){n=!0;break}n?t++:e[0].data.splice(t,1)}r.topo.topo.nodes=e[0].data,r.topo.topo.links=e[1].data,i(r.topo.topo)})})}var i={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/attack/topology.02bc8d36.html",link:r};return i}function o(e,t,n){function o(o,a){function r(e){for(var t=0;t<e.target.files.length;t++)u=o.uploader.array.push(e.target.files[t]);u&&i()}function i(){p.val(""),o.uploader.action="上传",o.uploader.hasFile=!1,o.uploader.msg="上传文件";var e={};angular.copy(o.uploader,e),o.uploaderArray.push(e),t(function(){o.uploader.msg=""},1e3)}function l(e){}function s(e){o.uploader.array.splice(e,1)}function c(t){e.downloadTargetFile(t.fileId).then(function(e){window.open("./"+e.data.filePath,"_self")})}function d(t,o){e.deleteTargetFile(t.fileId).then(function(e){e.data&&n.$broadcast("delete-file",o)})}var u,p=a.find("#selector");o.uploader.action="添加附件",o.uploader.create=i,o.uploader.cancel=s,o.uploader.download=l,o.uploader.downloadAPI=c,o.uploader.deleteAPI=d,o.uploader.array=[],o.uploaderArray=[],p.on("change",r),o.$on("$destroy",function(){p.off("change",r)}),function(){t(function(){},3e3)}()}var a={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/attack/upload.ae46aece.html",link:o};return a}e.$inject=["Attack"],n.$inject=["Topology","$q","Attack","Device","topologyId"],o.$inject=["Attack","$timeout","$rootScope"],angular.module("southWest.attack").directive("attackTable",e).directive("attackMultiple",t).directive("attackTopology",n).directive("attackUpload",o)}(),function(){"use strict";function e(){function e(e,t,n,o){function a(){}function r(){}function i(){}o.setConfig({setPosition:!1,isEdited:!1,isInfsafety:!1,isAttackPath:!0,EditTopo:a,drawInfsafety:r,drawAttackPath:i})}var t={scope:!1,restrict:"E",replace:!0,require:"^cdiagram",templateUrl:"/templates/attack/optimize-diagram.c6ece08f.html",link:e};return t}angular.module("southWest.attack").directive("attackNewDiagram",e)}(),function(){"use strict";function e(){return function(e){e&&(this.selectedId=e.selectedId,this.attackMethod=e.attackMethod,this.attackResult=e.attackResult,this.queryArray=e.queryArray),this.setQuery=function(e){this.queryArray=e,this.table=[]},this.getQuery=function(){return this.queryArray},this.getTable=function(){return this.table},this.setSelectedDevice=function(e){this.selectedId=e},this.getSelectedDevice=function(){return this.selectedId},this.setMethod=function(e){this.attackMethod=e},this.getMethod=function(){return this.attackMethod},this.setResult=function(e){this.attackResult=e},this.getResult=function(){return this.attackResult},this.updateAttackedDevice=function(){}}}function t(){return function(e){e&&(this.pathName=e.pathName,this.attackedTargetArray=e.attackedTargetArray,this.topologyId=e.topologyId,this.pathId=e.pathId,this.createTime=e.createTime,this.lastModifiedTime=e.lastModifiedTime),this.setName=function(e){this.pathName=e},this.getName=function(){return this.pathName},this.setAttackedTargetArray=function(e){this.attackedTargetArray=e},this.getAttackedTargetArray=function(){return this.attackedTargetArray},this.setTopologyId=function(e){this.topologyId=e},this.getTopologyId=function(){return this.topologyId},this.setPathId=function(e){this.pathId=e},this.getPathId=function(){return this.pathId},this.setCreateTime=function(e){this.createTime=e},this.getCreateTime=function(){return this.createTime},this.setLastModifiedTime=function(e){this.lastModifiedTime=e},this.getLastModifiedTime=function(){return this.lastModifiedTime}}}angular.module("southWest.attack").service("AttackedPath",t).service("AttackedDevice",e)}(),function(){"use strict";function e(e){e.state("audit",{abstract:!0,parent:"securityaudit",url:"/audit",controller:"AuditCtrl as audit",templateUrl:"templates/audit/index.c9510b41.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}],topo:["domain",function(e){e.getDomain()}]}})}e.$inject=["$stateProvider"],angular.module("southWest.audit").config(e)}(),function(){"use strict";function e(e,t,n,o,a){var r=this;r.expanded="true"===t.getItem("audit:navbar:expanded"),r.toggleExpand=function(){r.expanded=!r.expanded,t.setItem("audit:navbar:expanded",r.expanded)},r.isActive=function(t){return e.current.name.indexOf(t)>-1},r.leftNavItemEnabled=o.leftNavItemEnabled,r.uiEnable=function(e,t){return n.isShow(e,t)},r.JAStyle={},a.isJAXX&&(r.JAStyle={"margin-left":"-25px","margin-right":"-20px","margin-top":"-10px"}),Highcharts.createElement("link",{href:"//fonts.googleapis.com/css?family=Unica+One",rel:"stylesheet",type:"text/css"},null,document.getElementsByTagName("head")[0]),Highcharts.theme={colors:["#2b908f","#90ee7e","#f45b5b","#7798BF","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"],chart:{backgroundColor:{linearGradient:{x1:0,y1:0,x2:1,y2:1,x3:2,y3:2},stops:[[0,"#333333"],[1,"#333333"],[1,"#333333"]]},style:{fontFamily:"'Unica One', sans-serif"},plotBorderColor:"#606063"},title:{style:{color:"#E0E0E3",textTransform:"uppercase",fontSize:"20px"}},subtitle:{style:{color:"#E0E0E3",textTransform:"uppercase"}},xAxis:{gridLineColor:"#707073",labels:{style:{color:"#E0E0E3"}},lineColor:"#707073",minorGridLineColor:"#505053",tickColor:"#707073",title:{style:{color:"#A0A0A3"}}},yAxis:{gridLineColor:"#707073",labels:{style:{color:"#E0E0E3"}},lineColor:"#707073",minorGridLineColor:"#505053",tickColor:"#707073",tickWidth:1,title:{style:{color:"#A0A0A3"}}},tooltip:{backgroundColor:"rgba(0, 0, 0, 0.85)",style:{color:"#F0F0F0"}},plotOptions:{series:{dataLabels:{color:"#B0B0B3"},marker:{lineColor:"#333"}},boxplot:{fillColor:"#505053"},candlestick:{lineColor:"white"},errorbar:{color:"white"}},legend:{itemStyle:{color:"#E0E0E3"},itemHoverStyle:{color:"#FFF"},itemHiddenStyle:{color:"#606063"}},credits:{style:{color:"#666"}},labels:{style:{color:"#707073"}},drilldown:{activeAxisLabelStyle:{color:"#F0F0F3"},activeDataLabelStyle:{color:"#F0F0F3"}},navigation:{buttonOptions:{symbolStroke:"#DDDDDD",theme:{fill:"#505053"}}},rangeSelector:{buttonTheme:{fill:"#505053",stroke:"#000000",style:{color:"#CCC"},states:{hover:{fill:"#707073",stroke:"#000000",style:{color:"white"}},select:{fill:"#000003",stroke:"#000000",style:{color:"white"}}}},inputBoxBorderColor:"#505053",inputStyle:{backgroundColor:"#333",color:"silver"},labelStyle:{color:"silver"}},navigator:{handles:{backgroundColor:"#666",borderColor:"#AAA"},outlineColor:"#CCC",maskFill:"rgba(255,255,255,0.1)",series:{color:"#7798BF",lineColor:"#A6C7ED"},xAxis:{gridLineColor:"#505053"}},scrollbar:{barBackgroundColor:"#808083",barBorderColor:"#808083",buttonArrowColor:"#CCC",buttonBackgroundColor:"#606063",buttonBorderColor:"#606063",rifleColor:"#FFF",trackBackgroundColor:"#404043",trackBorderColor:"#404043"},legendBackgroundColor:"rgba(0, 0, 0, 0.5)",background2:"#505053",dataLabelsColor:"#B0B0B3",textColor:"#C0C0C0",contrastTextColor:"#F0F0F3",maskColor:"rgba(255,255,255,0.3)"},Highcharts.setOptions(Highcharts.theme)}e.$inject=["$state","localStorage","uiCtrl","leftNavCustomMenu","$rootScope"],angular.module("southWest.audit").controller("AuditCtrl",e)}(),function(){"use strict";function e(){function e(){}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/audit/auditSideNav.dda60b0d.html",link:e};return t}angular.module("southWest.audit").directive("auditSideNav",e)}(),function(){"use strict";function e(e){e.state("audit.behavior",{url:"/behavior",controller:"BehaviorCtrl as BehaviorCtrl",templateUrl:"templates/audit/behavior/index.ca8b13cd.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.audit.behavior").config(e)}(),function(){"use strict";function e(e,t,n){function o(){var e=36e5;a(e).then(function(e){r(e)})}function a(o){return t.sysbaseinfo().then(function(t){var a=new Date(t.data||""),r=new Date(a-o);return l.endTimeStr=i(a),l.startTimeStr=i(r),l.reportTime=l.endTimeStr,n.getBehaviorDatas(l.startTimeStr,l.endTimeStr).then(function(t){return e.$$childTail.dtable.refresh(),t})})}function r(e){$("#behavior-audit-bar-chart").highcharts(n.behaviorBarChart(e))}function i(e){return e.getUTCFullYear()+"-"+(e.getUTCMonth()+1>9?e.getUTCMonth()+1:"0"+(e.getUTCMonth()+1))+"-"+(e.getUTCDate()>9?e.getUTCDate():"0"+e.getUTCDate())+"T"+(e.getUTCHours()>9?e.getUTCHours():"0"+e.getUTCHours())+":"+(e.getUTCMinutes()>9?e.getUTCMinutes():"0"+e.getUTCMinutes())+":"+(e.getUTCSeconds()>9?e.getUTCSeconds():"0"+e.getUTCSeconds())+"Z"}var l=this;o(),l.changeBarChart=function(){var e=1;"1h"===l.totalTime?e=36e5:"1d"===l.totalTime?e=864e5:"1w"===l.totalTime&&(e=6048e5),a(e).then(function(e){r(e)})}}e.$inject=["$scope","apiInfo","behaviordata"],angular.module("southWest.audit.behavior").controller("BehaviorCtrl",e)}(),function(){"use strict";function e(e,t,n,o){function a(a,r,i,l){function s(){return a.$parent.$parent.BehaviorCtrl.startTimeStr&&a.$parent.$parent.BehaviorCtrl.endTimeStr?e.getBehaviorDatas(a.$parent.$parent.BehaviorCtrl.startTimeStr,a.$parent.$parent.BehaviorCtrl.endTimeStr):o.sysbaseinfo().then(function(){return null})}function c(){return o.sysbaseinfo().then(function(){return null})}var d=["usrIp","shoppingNum","newsNum","videoNum","sportNum","entertainmentNum","financeNum","gamesNum","novelNum","otherNum","totalNum","visitTimestamp"];l.disableToolbar=!0,l.setConfig({pagination:!1,scrollable:!1,totalCount:!1,getAll:s,getCount:c,fields:d}),a.openExportPanel=function(){function o(t,n){t.addPsw="1",t.validatePsw=function(e){var t=/^(?=.*[a-zA-Z])(?=.*\d)(?=.*(_|[^\w])).+$/g;return e&&e.match(t)&&e.length>=8},t.download=function(t){n.close(),e.getAllExport(a.$parent.$parent.BehaviorCtrl.startTimeStr,a.$parent.$parent.BehaviorCtrl.endTimeStr,t).then(function(e){window.open("./"+e,"_self")})},t.cancel=function(){n.dismiss("cancel")}}o.$inject=["$scope","$modalInstance"];var r=t.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:o,size:"sm"});r.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},a.showDetailWindow=function(a){function r(t,n){function r(){o.sysbaseinfo().then(function(){var t=echarts.init(document.getElementById("behavior-audit-radar-chart"));t.setOption(e.behaviorRadarChart(a))})}t.behavior=a,window.onload=r(),t.cancel=function(){n.dismiss("cancel")}}r.$inject=["$scope","$modalInstance"];var i=t.open({templateUrl:"/templates/audit/behavior/behaviorDetail.ac700bd3.html",controller:r,size:"sm"});i.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})}}var r={scope:!0,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/audit/behavior/behaviorTable.66d6ce8c.html",link:a};return r}e.$inject=["behaviordata","$modal","$log","apiInfo"],angular.module("southWest.audit.behavior").directive("behaviorTable",e)}(),function(){"use strict";function e(e){e.state("audit.devicedata",{url:"/devicedata",controller:"DevicedataCtrl as devicedata",templateUrl:"templates/audit/devicedata/index.972a174b.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.audit.devicedata").config(e)}(),function(){"use strict";function e(e,t){e.refresh=function(){t.reload()}}e.$inject=["$scope","$state"],angular.module("southWest.audit.devicedata").controller("DevicedataCtrl",e)}(),function(){"use strict";function e(e,n,o,a){function r(r,i,l,s){function c(e){return o.getDevicedataCount(e)}function d(e){return u(e)}function u(e){return o.getDevicedataList(e).then(function(e){return e.length?n.all(e).then(function(){return e.map(function(t,n){e[n].recvBytes=a.formatTrafficDataWithUnit(e[n].recvBytes),e[n].sendBytes=a.formatTrafficDataWithUnit(e[n].sendBytes)}),e}):[]})}var p=["totalBytes","deviceName","ipAddr","macAddr","recvSpeed","sendSpeed"];s.disableToolbar=!0,s.setConfig({name:"devicedata",pagination:!0,scrollable:!1,totalCount:!0,getAll:u,getCount:c,search:d,fields:p,dateTimeRange:"flowTimestamp"}),r.showStats=function(n){t(e,n,o,r)}}var i={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/audit/devicedata/devicedataTable.4cd21bbb.html",link:r};return i}function t(e,t,n){var o=e.open({size:"lg",templateUrl:"/templates/audit/devicedata/devicedataStats.4ada6a98.html",controller:function(e,o){e.deviceName=t.deviceName,n.getDevicedataStats(t.deviceId,36e5).then(function(o){$("#devicedata-stats-line-chart").highcharts(n.lineChart(e,o.data,t.deviceId))}),e.confirm=function(){o.close()},e.cancel=function(){o.dismiss("cancel")}}});o.result}e.$inject=["$modal","$q","dpidata","trafficDataService"],angular.module("southWest.audit.devicedata").directive("devicedataTable",e)}(),function(){"use strict";function e(e){e.state("audit.dpidata",{url:"/dpidata",controller:"DPIDataCtrl as dpidata",templateUrl:"templates/audit/dpidata/index.00ca2881.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.audit.dpidata").config(e)}(),function(){"use strict";function e(e,t,o,a,r,i,l,s){function c(){e.getOverView(36e5).then(function(e){u.overViewData=e.data,u.showTotalLineChart()})}function d(){var t=1;"1h"===u.protocolTime?t=36e5:"24h"===u.protocolTime?t=864e5:"168h"===u.protocolTime&&(t=6048e5),e.getProtocolView(t).then(function(e){u.protocolViewData=e,u.showProtocolPieChart()})}var u=this;u.protocolTime="1h",
c(),d(),u.showTotalLineChart=function(){var t=[],n={name:"数据流量",data:function(){var e=[];if(!u.overViewData)return e;if(u.overViewData.length<1)return e.push({x:(new Date).getTime(),y:0}),e;var t=0-u.overViewData.length;for(t;t<0;t+=1){var n=new Date(u.overViewData[t+u.overViewData.length].timestamp).getTime(),o=Math.floor(u.overViewData[t+u.overViewData.length].totalBytes/10.24)/100;e.push({x:n,y:o})}return e}()};t.push(n);var o={title:null,legendEnable:!0};$("#dpi-overview-line-chart").highcharts(e.totalLineChart(t,o,r))},u.showProtocolPieChart=function(){u.protocolTotal=0,u.protocolNum=0,u.reportTime=new Date;for(var t={title:null},o=0;o<u.protocolViewData.length;o++)u.protocolNum++,u.protocolTotal+=u.protocolViewData[o].totalBytes;if(u.protocolTotal>0){u.protocolTotal=s.formatTrafficDataWithUnit(u.protocolTotal);var a=u.protocolTotal.substring(u.protocolTotal.indexOf(" ")+1);$("#dpi-protocol-pie-chart").highcharts(e.pieChart(u.protocolViewData,t,a))}else t={title:null},$("#dpi-protocol-pie-chart").highcharts(e.pieChart(u.protocolViewData,t));n($("#dpi-protocol-pie-chart").highcharts())},u.changeProtocolPieChart=function(){d()},u.showDeviceLine=function(){if(u.selectedDevices){var t=[],n=["#7cb5ec","#f45b5b","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#91e8e1"];if(u.selectedDevices.length>3)return 0;for(var o=[],a=function(e){var t=[];if(!u.deviceData[e])return t;if(u.deviceData[e].length<1)return t.push({x:(new Date).getTime(),y:0}),t;var n=0-u.deviceData[e].length;for(n;n<0;n+=1){var o=new Date(u.deviceData[e][n+u.deviceData[e].length].startTime).getTime(),a=Math.floor(u.deviceData[e][n+u.deviceData[e].length].totalBytes/10.24)/100;t.push({x:o,y:a})}return t},i=0;i<u.selectedDevices.length;i++){o.push(u.selectedDevices[i].deviceId);var l={name:u.selectedDevices[i].name,color:n[i],data:a(i)};t.push(l)}var s={title:null,legendEnable:!0,deviceIds:o};u.deviceLineChart=e.deviceLineChart(t,s,r),$("#dpi-deviceview-line-chart").highcharts(u.deviceLineChart)}}}function t(){return function(e,t){if(e)return t=+t,e.slice(t)}}function n(e){var t=400;if(e){var n=e.hasData()?t:t/2;n!==e.chartHeight&&e.setSize(e.chartWidth,n,!1)}}e.$inject=["mwdata","$modal","$rootScope","$q","$scope","topologyId","uiCtrl","trafficDataService"],angular.module("southWest.audit.dpidata").controller("DPIDataCtrl",e).filter("pagination",t)}(),function(){"use strict";function e(e){e.state("audit.dpidevice_data",{url:"/dpidevicedata",controller:"DPIDeviceDataCtrl as dpidevicedata",templateUrl:"templates/audit/dpidevicedata/index.f15d92d0.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("audit.dpidevice_data.detail",{parent:"audit",url:"/dpidevicedata/deviceid/:deviceID/boxid/:boxId/dpiIp/:dpiIp/",controller:"DPIDeviceTrafficDataCtrl as dpidevicetrafficdata",templateUrl:"templates/audit/dpidevicedata/details.9f37bcec.html",resolve:{device:["$stateParams","$q","Device","Topology","topologyId","domain","$filter",function(e,t,n,o,a,r,i){function l(){return n.get(e.deviceID).then(function(e){var t=e._model_name?e._model_name.split(" /"):[];return"数控审计保护平台"===t[0]&&(e._model_name=i("resFilter")(t[0],"slideAuditTitle")+" /"+t[1]),e},function(){return!1})}return a.id?l():r.getDomain().then(function(){return l()})}],boxID:["$stateParams",function(e){return e.boxId}],dpiIp:["$stateParams",function(e){return e.dpiIp}],state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.audit.dpidevicedata").config(e)}(),function(){"use strict";function e(e,t,o,a,r){function i(){l().then(function(){s()})}function l(){return t.sysbaseinfo().then(function(t){var n=new Date(t.data||""),o=n-24e3,a=new Date(o),r=a-36e5,i=new Date(r);return e.getDpiDevices(i,a).then(function(e){d.dpidevices=e})})}function s(){if(d.dpiTraffics=[],d.dpidevices)return t.sysbaseinfo().then(function(t){for(var n=new Date(t.data||""),a=n-24e3,r=new Date(a),i=r-36e5,l=new Date(i),s=[],c=0;c<d.dpidevices.length;c++)s.push(e.getDpiTrafficRealTime(d.dpidevices[c].boxId,l,r));o.all(s).then(function(e){for(var t=0;t<d.dpidevices.length;t++)e[t].data.length>0?d.dpiTraffics.push(e[t].data):d.dpiTraffics.push({timestamp:e[t].endTime,totalBytes:0});d.showDeviceLineChart()})})}function c(){var t=1;"1h"===d.totalTime?t=36e5:"24h"===d.totalTime?t=864e5:"168h"===d.totalTime&&(t=6048e5),e.getDpiTrafficTotal(t).then(function(e){d.dpiTrafficStats=e,d.showDevicePieChart()})}var d=this;a.reloadDevices=!1,i(),d.showDeviceLineChart=function(){if(d.dpidevices){for(var t=[],o=["#91e8e1","#2b908f","#e4d354","#f15c80","#8085e9","#f7a35c","#90ed7d","#f45b5b","#7cb5ec"],r=[],i=function(e){var t=[];if(!d.dpiTraffics[e])return t;if(d.dpiTraffics[e].length<1)return t.push({x:(new Date).getTime(),y:0}),t;var n=0-d.dpiTraffics[e].length;for(n;n<0;n+=1){var o=new Date(d.dpiTraffics[e][n+d.dpiTraffics[e].length].timestamp).getTime(),a=Math.floor(d.dpiTraffics[e][n+d.dpiTraffics[e].length].totalBytes/10.24)/100;t.push({x:o,y:a})}return t},l=0;l<d.dpidevices.length;l++){r.push(d.dpidevices[l].boxId);var s={boxId:d.dpidevices[l].boxId,name:d.dpidevices[l].deviceName,color:o.pop(),data:i(l)};if(t.push(s),4===l)break}var c={title:null,legendEnable:!0,boxIds:r};$("#dpidevice-realtime-line-chart").highcharts(e.deviceLineChart(t,c,o,a)),n($("#dpidevice-realtime-line-chart").highcharts())}},d.showDevicePieChart=function(){d.totalDevices=d.dpiTrafficStats.length,d.totalBytes=0,d.reportTime=new Date;for(var t={title:null},o=0;o<d.dpiTrafficStats.length;o++)d.totalBytes+=d.dpiTrafficStats[o].totalBytes;if(d.totalBytes>0){d.totalBytes=r.formatTrafficDataWithUnit(d.totalBytes);var a=d.totalBytes.substring(d.totalBytes.indexOf(" ")+1);$("#dpidevice-total-pie-chart").highcharts(e.devicePieChart(d.dpiTrafficStats,t,a))}else t={title:null},$("#dpidevice-total-pie-chart").highcharts(e.devicePieChart(d.dpiTrafficStats,t,"KB"));n($("#dpidevice-total-pie-chart").highcharts())},d.changeLineChart=function(){i()},d.changePieChart=function(){l().then(function(){c()})}}function t(e,t,o,a,r,i,l,s,c){function d(){return t.sysbaseinfo().then(function(t){var n=new Date(t.data||""),o=n-24e3,r=new Date(o),i=r-36e5,l=new Date(i);e.getSelectedProtocols(a,l,r).then(function(e){f.protocols=e,u()})})}function u(){f.protocolRealTimeData=[],f.protocols&&t.sysbaseinfo().then(function(t){for(var n=new Date(t.data||""),o=n-24e3,r=new Date(o),i=r-36e5,s=new Date(i),c=[],d=0;d<f.protocols.length;d++)c.push(e.getProtocolRealTime(a,f.protocols[d].trafficId,s,r));l.all(c).then(function(e){for(var t=0;t<f.protocols.length;t++)e[t].data.length>0?f.protocolRealTimeData.push(e[t].data):f.protocolRealTimeData.push({timestamp:e[t].endTime,totalBytes:0});f.showProtocolLine()})})}function p(){var t=36e5;f.protocolTime&&"1h"!==f.protocolTime&&("24h"===f.protocolTime?t=864e5:"168h"===f.protocolTime&&(t=6048e5)),e.getProtocolTotal(a,t).then(function(e){f.protocolTotalData=e,f.showProtocolPieChart()})}var f=this;f.simplifyModelName=c.simplifyModelName,f.device=o,f.boxID=a,f.dpiIp=r,d(),f.showProtocolLine=function(){if(f.protocols){for(var t=[],o=["#2b908f","#90ee7e","#f45b5b","#7798BF","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"].reverse(),r=[],l=function(e){var t=[];if(!f.protocolRealTimeData[e])return t;if(f.protocolRealTimeData[e].length<1)return t.push({x:(new Date).getTime(),y:0}),t;var n=0-f.protocolRealTimeData[e].length;for(n;n<0;n+=1){var o=new Date(f.protocolRealTimeData[e][n+f.protocolRealTimeData[e].length].timestamp).getTime(),a=Math.floor(f.protocolRealTimeData[e][n+f.protocolRealTimeData[e].length].totalBytes/10.24)/100;t.push({x:o,y:a})}return t},s=0;s<f.protocols.length;s++){r.push(f.protocols[s].trafficId);var c={name:f.protocols[s].protocolName,color:o.pop(),data:l(s)};t.push(c)}var d={title:null,legendEnable:!0,protocolIds:r,boxID:a};$("#dpidevice-protocol-line-chart").highcharts(e.protocolLineChart(t,d,o,i)),n($("#dpidevice-protocol-line-chart").highcharts())}},f.showProtocolPieChart=function(){f.protocolTotal=0,f.protocolNum=f.protocolTotalData.length,f.protocolReportTime=new Date;for(var t={title:null},o=0;o<f.protocolTotalData.length;o++)f.protocolTotal+=f.protocolTotalData[o].totalBytes;if(f.protocolTotal>0){f.protocolTotal=s.formatTrafficDataWithUnit(f.protocolTotal);var a=f.protocolTotal.substring(f.protocolTotal.indexOf(" ")+1);$("#dpidevice-protocol-pie-chart").highcharts(e.protocolPieChar(f.protocolTotalData,t,a))}else t={title:null},$("#dpidevice-protocol-pie-chart").highcharts(e.protocolPieChar(f.protocolTotalData,t,"KB"));n($("#dpidevice-protocol-pie-chart").highcharts())},f.changeLineChart=function(){d()},f.changePieChart=function(){p()}}function n(e){var t=400;if(e){var n=e.hasData()?t:t/2;n!==e.chartHeight&&e.setSize(e.chartWidth,n,!1)}}e.$inject=["dpidevicedata","apiInfo","$q","$scope","trafficDataService"],t.$inject=["dpidevicedata","apiInfo","device","boxID","dpiIp","$scope","$q","trafficDataService","deviceTypeService"],angular.module("southWest.audit.dpidevicedata").controller("DPIDeviceDataCtrl",e).controller("DPIDeviceTrafficDataCtrl",t)}(),function(){"use strict";function e(e,t){function n(n,o,a,r){function i(n){return t.getDpiTrafficList(n).then(function(t){return t.length?e.all(t).then(function(){return t.map(function(e,n){t[n].maxSpeed=Math.floor(t[n].maxSpeed/10.24)/100+" KB/s",t[n].minSpeed=Math.floor(t[n].minSpeed/10.24)/100+" KB/s",t[n].avgSpeed=Math.floor(t[n].avgSpeed/10.24)/100+" KB/s"}),t}):[]})}function l(e){return t.getDpiTrafficCount(e)}var s=["deviceName","dpiIp","dpiPort","maxSpeed","minSpeed","avgSpeed","percent","timestamp"];r.disableToolbar=!0,r.setConfig({name:"devicedata",pagination:!0,numPerPage:5,scrollable:!1,totalCount:!0,fields:s,getAll:i,getCount:l}),n.$watch(function(){return n.reloadDevices},function(){n.reloadDevices===!0&&n.$parent.dtable.getTableData()})}var o={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/audit/dpidevicedata/dpidevicedataTable.5449f02e.html",link:n};return o}e.$inject=["$q","dpidevicedata"],angular.module("southWest.audit.dpidevicedata").directive("dpidevicedataTable",e)}(),function(){"use strict";function e(e){var t=this;t.gotoTimeControl=function(t){e.menuName=t}}e.$inject=["$rootScope"],angular.module("southWest.audit.forumpostdata").controller("ForumPostDataCtrl",e)}(),function(){"use strict";function e(e,t,n,o){function a(a,r,i,l){function s(){var e=[{name:"postTimestamp",display:"日期",input:"timerange",option:!0,value:[],options:[]},{name:"usrIp",display:"IP地址",input:"ipAdress",option:!1,value:""},{name:"usrMac",display:"MAC地址",input:"macAdress",option:!1,value:""},{name:"forumName",display:"论坛名称",input:"string",option:!1,value:""}],t={name:"audit",pagination:!0,scrollable:!1,totalCount:!0,getAll:u,getCount:c,search:d,fields:p,advancedSearch:"forumpost"};l.query=l.isSearching=l.advancedSearchQuery="",angular.extend(t,{advancedSearchOptions:e,disabledTimeOptions:!0}),l.setConfig(t)}function c(e){return t.getForumpostCount(e)}function d(e){return a.params=e,u(e)}function u(e){return e.$orderby&&""!==e.$orderby||(e.$orderby="postTimestamp desc"),a.params=e,t.getForumpostAll(e).then(function(e){return e})}var p=["usrIp","usrMac","forumName","postTimestamp"];s(),a.openExportPanel=function(e){function r(e,n){e.addPsw="1",e.validatePsw=function(e){var t=/^(?=.*[a-zA-Z])(?=.*\d)(?=.*(_|[^\w])).+$/g;return e&&e.match(t)&&e.length>=8},e.download=function(e){n.close(),i.$orderby="postTimestamp desc",t.getForumpostExport(i,e).then(function(e){window.open("./"+e,"_self")})},e.cancel=function(){n.dismiss("cancel")}}r.$inject=["$scope","$modalInstance"];var i=e?a.params:{};i.$limit=1e5;var l=n.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:r,size:"sm"});l.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},l.showDetailWindow=function(t){e.all([]).then(function(){function e(e,n){e.getData=function(){var n=t;n.forumName=t.forumName,n.postTimestamp=t.postTimestamp,n.usrIp=t.usrIp,n.usrMac=t.usrMac,n.title=t.title,n.postContent=t.postContent,e.forumpostDataDetail=n},e.getData(),e.cancel=function(){n.dismiss("cancel")},e.done=function(){n.close("done")},e.trim=function(e){return e=null===e||void 0===e?"":String(e),e.replace(/(^\s*)|(\s*$)/g,"")}}e.$inject=["$scope","$modalInstance"];var o=n.open({templateUrl:"templates/audit/forumpostdata/detailforumpost.d443f7a6.html",size:"lg",controller:e});o.result.then(function(e){},function(){})})}}var r={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/audit/forumpostdata/forumpost.ce5faff0.html",link:a};return r}e.$inject=["$q","Audit","$modal","$log"],angular.module("southWest.audit.forumpostdata").directive("forumPostTable",e)}(),function(){"use strict";function e(e){e.state("audit.icdevice_data",{url:"/icdevicedata",controller:"ICDeviceDataCtrl as icdevicedata",templateUrl:"templates/audit/icdevicedata/index.46cc14a8.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("audit.icdevice_data.detail",{parent:"audit",url:"/icdevicedata/deviceid/:deviceID/deviceInfo/:deviceInfo",controller:"ICDeviceProtocolTrafficDataCtrl as icdeviceprotocoltrafficdata",templateUrl:"templates/audit/icdevicedata/icDeviceProtocolTraffic.5dec4f1f.html",resolve:{deviceId:["$stateParams",function(e){return e.deviceID}],deviceInfo:["$stateParams",function(e){return e.deviceInfo}],state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.audit.icdevicedata").config(e)}(),function(){"use strict";function e(e,t,o,a,r,i){function l(){s();var e=r(function(){s()},24e3);o.$on("$destroy",function(){r.cancel(e)})}function s(){o.reloadDevices=!0,t.sysbaseinfo().then(function(t){var a=new Date(t.data||""),r=a-24e3,i=new Date(r),l=i-36e5,s=new Date(l);e.getTopTrafficDevice(s,i,5).then(function(e){c(e).then(function(){n($("#icdevice-device-line-chart").highcharts()),o.reloadDevices=!1})})})}function c(n){var o=5,r=$("#icdevice-device-line-chart").highcharts(),i=r?r.series||[]:[];if(r&&i){var l=function(e,t){for(var n=0;n<t.length;n++)if(t[n].options.id===e.deviceId)return t[n]},s=function(){var e=[];i.forEach(function(t){e.push(t.color)});for(var t=0;t<p.length;t++)if($.inArray(p[t],e)<0)return p[t];return p[p.length-1]};return t.sysbaseinfo().then(function(t){var c=new Date(t.data||""),d=c-24e3,u=[];i.forEach(function(e){for(var t=0;t<n.length;t++)if(void 0!==e&&e.options.id===n[t].deviceId)return;u.push(e)}),u.forEach(function(e){e.remove(!1)});for(var p=[],f=0;f<n.length&&f<=o;f++){var m=n[f],g=l(m,i),h=void 0===g,v=new Date(d),y=h?36e5:24e3,I=v-y,D=new Date(I);h?r.addSeries({id:m.deviceId,name:void 0===m.Id||null===m.Id?m.deviceName+" ("+m.deviceId+")":m.deviceName,color:s()}):g.update({name:void 0===m.Id||null===m.Id?m.deviceName+" ("+m.deviceId+")":m.deviceName}),p.push(e.getDeviceTraffic(m,D,v))}return a.all(p).then(function(e){for(var t=0;t<n.length&&t<=o;t++){for(var a=l(e[t].device,i),s=e[t].endTime.getTime(),c=0;c<e[t].data.length;c++){var d=new Date(e[t].data[c].timestamp).getTime(),u=Math.floor(e[t].data[c].totalBytes/10.24)/100;a&&a.addPoint([d,u],!1,!1)}0===e[t].data.length&&i[t]&&i[t].addPoint([s,0],!1,!1),r.redraw()}})})}return a.when(!1)}function d(){a.all([t.sysbaseinfo()]).then(function(){o.reloadDevices=!1,f.showDeviceLine(),l()})}function u(){var t=1;f.timeSpan=f.timeSpan||"1h","1h"===f.timeSpan?t=36e5:"24h"===f.timeSpan?t=864e5:"168h"===f.timeSpan&&(t=6048e5),e.getDeviceTrafficStatistics(t).then(function(e){f.trafficsStaticsData=e,f.showDeviceTrafficPieChart()})}var p=["#7cb5ec","#f45b5b","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#91e8e1"],f=this;f.showDeviceLine=function(){var t={title:null,legendEnable:!0,deviceIds:[]};$("#icdevice-device-line-chart").highcharts(e.deviceLineChart([],t))},f.showDeviceTrafficPieChart=function(){var t={title:null},o=0;f.trafficsStaticsData.forEach(function(e){o+=e.totalBytes}),f.totalDevices=f.trafficsStaticsData.length,f.totalTraffics=i.formatTrafficDataWithUnit(o),f.reportTime=new Date;var a=f.totalTraffics.substring(f.totalTraffics.indexOf(" ")+1);$("#icdevice-traffic-statistics-pie-chart").highcharts(e.devicePieChart(f.trafficsStaticsData,t,a)),n($("#icdevice-traffic-statistics-pie-chart").highcharts())},f.changeDeviceLineChart=function(){a.all([t.sysbaseinfo()]).then(function(){f.showDeviceLine(),s()})},f.changeDeviceTrafficPieChartTimeSpan=function(){u()},d()}function t(e,t,o,a,r,i,l,s){function c(){d();var e=l(function(){d()},24e3);r.$on("$destroy",function(){l.cancel(e)})}function d(){o.getSelectedProtocols(g.deviceId).then(function(e){u(e).then(function(){n($("#icdevice-traffic-statistics-pie-chart").highcharts())})})}function u(e){var t=$("#icdevice-device-protocol-line-chart").highcharts(),n=t?t.series||[]:[],r=g.deviceId;if(t&&n&&e.length){var l=function(e,t){for(var n=0;n<t.length;n++)if(t[n].name===e.protocolName)return!0;return!1},s=function(){var e=[];n.forEach(function(t){e.push(t.color)});for(var t=0;t<m.length;t++)if($.inArray(m[t],e)<0)return m[t];return m[m.length-1]};return a.sysbaseinfo().then(function(a){var c=new Date(a.data||""),d=c-24e3,u=[];n.forEach(function(t){for(var n=0;n<e.length;n++)if(t&&t.name===e[n].protocolName)return;u.push(t)}),u.forEach(function(e){e.remove(!1)});for(var p=[],f=0;f<e.length;f++){var m=e[f],g=l(m,n)===!1,h=new Date(d),v=g?36e5:24e3,y=h-v,I=new Date(y);g&&t.addSeries({name:m.protocolName,color:s()}),p.push(o.getProtocolTraffic(r,m.trafficId,I,h))}return i.all(p).then(function(o){for(var a=0;a<e.length;a++){for(var r=o[a].endTime.getTime(),i=0;i<o[a].data.length;i++){var l=new Date(o[a].data[i].timestamp).getTime(),s=Math.floor(o[a].data[i].totalBytes/10.24)/100;n[a]&&n[a].addPoint([l,s],!1,!1)}0===o[a].data.length&&n[a]&&n[a].addPoint([r,0],!1,!1),t.redraw()}})})}return i.when(!1)}function p(){i.all([a.sysbaseinfo()]).then(function(e){g.showProtocolLine(),c()})}function f(){var e=1;g.timeSpan=g.timeSpan||"1h","1h"===g.timeSpan?e=36e5:"24h"===g.timeSpan?e=864e5:"168h"===g.timeSpan&&(e=6048e5),o.getProtocolTrafficStatistics(g.deviceId,e).then(function(e){g.trafficsStaticsData=e,g.showProtocolTrafficPieChart()})}var m=["#2b908f","#90ee7e","#f45b5b","#7798BF","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"],g=this;g.deviceId=e;var h=decodeURI(t).split("|");g.device={deviceName:h[2],ipAddr:h[1],macAddr:h[0]},g.showProtocolLine=function(){var e={title:null,legendEnable:!0};$("#icdevice-device-protocol-line-chart").highcharts(o.protocolLineChart([],e))},g.showProtocolTrafficPieChart=function(){var e={title:null},t=0;g.trafficsStaticsData.forEach(function(e){t+=e.totalBytes}),g.protocolReportTime=new Date,g.totalTraffics=s.formatTrafficDataWithUnit(t);var a=g.totalTraffics.substring(g.totalTraffics.indexOf(" ")+1);$("#icdevice-traffic-statistics-pie-chart").highcharts(o.protocolPieChart(g.trafficsStaticsData,e,a)),n($("#icdevice-traffic-statistics-pie-chart").highcharts())},g.changeProtocolLineChart=function(){i.all([a.sysbaseinfo()]).then(function(){g.showProtocolLine(),c()})},g.changeDeviceTrafficPieChartTimeSpan=function(){f()},p()}function n(e){var t=400;if(e){var n=e.hasData()?t:t/2;n!==e.chartHeight&&e.setSize(e.chartWidth,n,!1)}}e.$inject=["icdevicedata","apiInfo","$scope","$q","$interval","trafficDataService"],t.$inject=["deviceId","deviceInfo","icdevicedata","apiInfo","$scope","$q","$interval","trafficDataService"],angular.module("southWest.audit.icdevicedata").controller("ICDeviceDataCtrl",e).controller("ICDeviceProtocolTrafficDataCtrl",t)}(),function(){"use strict";function e(e,t,n){function o(o,a,r,i){function l(e){return t.sysbaseinfo().then(function(t){var o=new Date(t.data||""),a=o-24e3,r=new Date(a),i=r-36e5,l=new Date(i);return n.getDeviceTrafficCount(l,r,e)})}function s(o){return t.sysbaseinfo().then(function(t){var a=new Date(t.data||""),r=a-24e3,i=new Date(r),l=i-36e5,s=new Date(l);return n.getDeviceTrafficList(s,i,o).then(function(t){return t.length?e.all(t).then(function(){return t.map(function(e,n){t[n].avgRecvSpeed=Math.floor(t[n].avgRecvSpeed/10.24)/100+" KB/s",t[n].avgSendSpeed=Math.floor(t[n].avgSendSpeed/10.24)/100+" KB/s",t[n].timestamp=new Date(t[n].timestamp).getTime()}),t}):[]})})}var c=["totalBytes","deviceName","ipAddr","macAddr","recvBytes","sendBytes","percent","createdAt"];i.disableToolbar=!0,i.setConfig({name:"devicedata",pagination:!0,numPerPage:5,scrollable:!1,totalCount:!0,fields:c,getAll:s,getCount:l}),o.$watch(function(){return o.reloadDevices},function(){o.reloadDevices===!0&&o.$parent.dtable.getTableData()})}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/audit/icdevicedata/icdevicedataTable.255aac63.html",link:o};return a}e.$inject=["$q","apiInfo","icdevicedata"],angular.module("southWest.audit.icdevicedata").directive("icdevicedataTable",e)}(),function(){"use strict";function e(e){var t=this;t.gotoTimeControl=function(t){e.menuName=t}}e.$inject=["$rootScope"],angular.module("southWest.audit.searchenginedata").controller("SearchEngineDataCtrl",e)}(),function(){"use strict";function e(e,t,n,o){function a(e,a,r,i){function l(){var e=[{name:"searchTimestamp",display:"日期",input:"timerange",option:!0,value:[],options:[]},{name:"usrIp",display:"IP地址",input:"ipAdress",option:!1,value:""},{name:"usrMac",display:"MAC地址",input:"macAdress",option:!1,value:""},{name:"searchContent",display:"搜索内容",input:"string",option:!1,value:""},{name:"searchName",display:"搜索引擎",input:"string",option:!1,value:""}],t={name:"audit",pagination:!0,scrollable:!1,totalCount:!0,getAll:d,getCount:s,search:c,fields:u,advancedSearch:"searchengine"};i.query=i.isSearching=i.advancedSearchQuery="",angular.extend(t,{advancedSearchOptions:e,disabledTimeOptions:!0}),i.setConfig(t)}function s(e){return t.getSearchengineCount(e)}function c(t){return e.params=t,d(t)}function d(n){return n.$orderby&&""!==n.$orderby||(n.$orderby="searchTimestamp desc"),e.params=n,t.getSearchengineAll(n).then(function(e){return e})}var u=["usrIp","usrMac","searchName","searchContent","searchTimestamp"];l(),e.openExportPanel=function(a){function r(e,n){e.addPsw="1",e.validatePsw=function(e){var t=/^(?=.*[a-zA-Z])(?=.*\d)(?=.*(_|[^\w])).+$/g;return e&&e.match(t)&&e.length>=8},e.download=function(e){n.close(),i.$orderby="searchTimestamp desc",t.getSearchengineExport(i,e).then(function(e){window.open("./"+e,"_self")})},e.cancel=function(){n.dismiss("cancel")}}r.$inject=["$scope","$modalInstance"];var i=a?e.params:{};i.$limit=1e5;var l=n.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:r,size:"sm"});l.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var r={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/audit/searchenginedata/searchengine.dcc4857c.html",link:a};return r}e.$inject=["$q","Audit","$modal","$log"],angular.module("southWest.audit.searchenginedata").directive("searchEngineTable",e)}(),function(){"use strict";function e(e){e.state("auth",{parent:"root",url:"/login",views:{"@":{controller:"AuthCtrl as auth",templateUrl:"templates/auth/index.c50090f1.html"}},resolve:{curTime:["mOverview",function(e){return e.getCurtime()}]}})}e.$inject=["$stateProvider"],angular.module("southWest.auth").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c){function d(){n.getVerifyCodeImage().then(function(e){u.imageData=e.data})}var u=this;u.curYear=c?c.split("-")[0]:(new Date).getFullYear(),u.user={};var p=s.initializeEngine();e.$on("$destroy",function(){p.destroy()}),d();var f,m={},g=navigator.userAgent.toLowerCase();(f=g.match(/rv:([\d.]+)\) like gecko/))?m.ie=f[1]:(f=g.match(/msie ([\d.]+)/))?m.ie=f[1]:(f=g.match(/firefox\/([\d.]+)/))?m.firefox=f[1]:(f=g.match(/chrome\/([\d.]+)/))?m.chrome=f[1]:(f=g.match(/opera.([\d.]+)/))?m.opera=f[1]:(f=g.match(/version\/([\d.]+).*safari/))?m.safari=f[1]:0,u.isIE=m.ie,u.hostname=window.document.location.host,u.unKeyPress=function(e){e&&(u.error="")},u.pwKeyPress=function(e){13===e?u.login():u.error=""},u.openInitializedModal=function(t){function n(e,t,n){e.items=n,e.ok=function(){t.close(e.items)},e.cancel=function(){t.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","items"];var o=r.open({animation:e.animationsEnabled,templateUrl:"InitializedModal.html",controller:n,size:"sm",resolve:{items:function(){var e=t;return e}}});o.result.then(function(){},function(){a.info("Modal dismissed at: "+new Date)}),e.toggleAnimation=function(){e.animationsEnabled=!e.animationsEnabled}},u.login=function(){n.getSecretKey().then(function(e){var o=e.data,a={username:btoa(l.encrypt(u.user.username,o)),password:btoa(l.encrypt(u.user.password,o)),verifycode:btoa(u.user.verifycode)};n.login(a).then(function(e){if(e.done){var n={},o=t.rootMenu.getChilds();if(o&&null!==o&&o.length>0){var a=o[0].getChilds();if(a&&null!==a&&a.length>0){var r=a[0].getChilds();n=r&&null!==r&&r.length>0?{target:r[0].getTarget(),state:r[0].getState(),isLogin:!0}:{target:a[0].getTarget(),state:a[0].getState(),isLogin:!0}}else n={target:o[0].getTarget(),state:o[0].getState(),isLogin:!0}}else n={target:"MONITOR_OVERVIEW",state:"monitor.overview",isLogin:!0};i.teleport(n)}else u.error=e.msg,u.user.verifycode="","验证码输入不匹配或者验证码登录超时"===e.msg?$("#login_text_verifycode").focus():"登录失败，账户不存在或密码错误"===e.msg&&(u.user.password="",$("#login_text_password").focus()),d()})},function(){u.error="登录服务超时，请重新登录！"})},u.getVerifyCodeImage=function(){d()},o.userToken().then(function(e){var t={};e&&(t={target:"MONITOR_OVERVIEW",state:"monitor.overview",isLogin:!0},i.teleport(t))}),e.slideInterval=5e3,e.slides=[{bg:"images/auth/banner01.c2d3073f.png"},{bg:"images/auth/banner02.a878651e.png"},{bg:"images/auth/banner03.2d7d745e.png"}]}e.$inject=["$scope","$rootScope","auth","SystemUser","$log","$modal","uiCtrl","$crypto","canvasBg","curTime"],angular.module("southWest.auth").controller("AuthCtrl",e)}(),function(e,t){"use strict";function n(e){function t(t){t.currentIndex=0,t.next=function(){t.currentIndex<t.slides.length-1?t.currentIndex++:t.currentIndex=0},t.$watch("currentIndex",function(){t.slides.forEach(function(e){e.visible=!1}),t.slides[t.currentIndex].visible=!0});var n=e(function(){t.next()},3e3);t.$on("$destroy",function(){e.cancel(n)})}var n={restrict:"AE",scope:!1,link:t};return n}n.$inject=["$interval"],t.module("southWest.auth").directive("loginSlide",n)}(window,angular),function(){"use strict";function e(e){e.state("dashboard",{parent:"root",abstract:!0,views:{"@":{controller:"DashboardCtrl as dashboard",templateUrl:"templates/dashboard/index.8d4106c1.html"}},resolve:{}}).state("other",{})}e.$inject=["$stateProvider"],angular.module("southWest.dashboard").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m,g,h){function v(){I(),D()}function y(){if(Date.now()-o.lastIncidentRecieved>=6e4||!o.lastIncidentRecieved){if(T.soundOptionCheck(),!o.soundOff){var e=new Audio("images/sound/alert.f24df0f4.mp3");e.play()}o.lastIncidentRecieved=Date.now(),T.flashes=1,setTimeout(function(){delete T.flashes,n.$digest()},5e3),n.$digest()}}function I(){o.redDot=i.get("totalNew")>0}function D(){r.all([u.get({$filter:"timestamp ge '"+moment().hour(-24).utc().format()+"'"}),u.getCount(),p.sysbaseinfo()]).then(function(e){T.alarms.list=e[0],T.alarms.countNew=e[1],T.alarms.currentTime=e[2].data})}var T=this;T.topoName="",T.policyName="",T.isRootUser=!1,T.alarms={list:null,countNew:0},T.isMyAccountAvailable=!1;var b=o.rootMenu.getChild("SETTING");void 0!==b&&null!==b&&(b=b.getChilds(),b=b.filter(function(e){return"setting.myaccount"===e.state}),T.isMyAccountAvailable=void 0!==b&&null!==b&&b.length>0),T.isActive=function(e){return 0===t.current.name.indexOf(e.getState().split("_")[0])},T.showVersionModal=function(){function e(e,t){e.cancel=function(){t.dismiss("cancel")},e.done=function(){t.close("done")}}e.$inject=["$scope","$modalInstance"];var t=s.open({templateUrl:"templates/dashboard/version-modal.2b959f10.html",controller:e,backdropClass:"version-modal-backdrop",backdrop:!0,windowClass:"version-modal-window"});t.result.then(function(e){},function(){})},o.$$listeners.updateDashboardHeader=[],o.$on("updateDashboardHeader",function(){v()}),o.userlock=localStorage.getItem("lockUser"),o.VERSION_NUMBER&&(T.lockShow="-C05"===o.VERSION_NUMBER.slice(-4)),T.getClass=function(){var e=t.current.name;return"page-"+e.replace(/\./g,"-")},T.getTargetUrl=function(e){for(var t=o.rootMenu.getChilds(),n=0;n<t.length;n++){var a=t[n];if(a.target===e.target){var r=a.getChilds();if(r&&r!==[]&&r.length>0){var i=r[0];return i.getChilds()&&i.getChilds()!==[]&&0!==i.getChilds().length?i.getChilds()[0].state:i.state}return a.state}}return"myaccount"},T.isBlurred=function(e){return"other"===e||!l.hasNode&&"topology"!==e&&"detect"!==e&&"conduct"!==e&&"domain"!==e&&"setting"!==e&&"asset"!==e},T.menuEnabled=function(e){if(o.rootMenu)for(var t=0;t<o.rootMenu.getChilds().length;t++)if(e.target===o.rootMenu.getChilds()[t].target)return!0;return!1},T.expanded="true"===localStorage.getItem("navbar:expanded"),T.closeOtherSecondLvMenu=function(){o.rootMenu.getChildByState(t.current.name.split(".")[0]).getChilds().forEach(function(e){e.expanded=!1})},T.toggleExpand=function(e){void 0!==e?T.expanded=e:T.expanded=!T.expanded,T.expanded?T.closeOtherSecondLvMenu():e!==!1&&(o.rootMenu.getChildByState(t.current.name.split(".")[0]).getChildByState(t.current.name.split(".")[0]+"."+t.current.url.split("/")[1]).expanded=!0),localStorage.setItem("navbar:expanded",T.expanded)},o.displaySubMenus=function(e,t){return!t&&(e.getSiblings().forEach(function(e){e.expanded=!1}),void(e.expanded=!e.expanded))},o.subMenusSelected=function(e,t){return!t&&(!!e.expanded&&o.isSubMenusActive(e))},o.isSubMenusActive=function(e){return _.some(e.getChilds(),function(e){return 0===t.current.name.indexOf(e.getState())&&e.getState().indexOf(".")>0})},T.logout=c.logout,T.userRole=c.getUserRole(),T.user=function(){return"admin"===c.getUserName()?"管理员":(1===c.getUserType()?T.isRootUser=!0:T.isRootUser=!1,c.getUserName())},T.updateAlarms=function(){T.alarms.countNew&&u.update()},o.openHelp=function(){window.open("/help/index.html?"+t.current.name.replace(/\./g,"_")+".html")},T.keepAlive=function(){h.keepAlive(),"1"===o.userlock&&a(T.keepAlive,24e4)},T.lockUsr=function(){localStorage.setItem("lockUser","1"),o.userlock="1",T.keepAlive()},T.unKeyPress=function(e){e&&(T.error="")},T.pwKeyPress=function(e){13===e?T.unlockUsr():T.error=""},T.unlockUsr=function(){T.usr.username=c.getUserName(),c.unlockUser(T.usr).then(function(){localStorage.setItem("lockUser","0"),o.userlock="0",T.usr={}},function(){T.error="密码错误"})};var S=f(function(e){o.redDot=!0,o.$broadcast("incoming",e)},3e3);n.$on("incoming",function(e,t){y(t)}),T.soundOptionCheck=function(){o.soundOff=m.get("soundMode"),T.receiveIncidents=m.get("InciStatus"),T.receiveEvents=m.get("EveStatus")},d.listen("UPDATE",n,function(e){"INCIDENT"===e.sseType?(o.$broadcast("newIncidentInsert",e.content),S(e.content),T.newEventSSE=!0):"EVENT"===e.sseType?("insert"===e.content.action&&o.$broadcast("newEventInsert",e.content),S(e.content),T.newEventSSE=!0):"ALL_IN_ONE_TOPOLOGY"===e.sseType?"uploaded"===e.content.action&&o.$broadcast("allinOneTopologyUploaded",e):"ALARM"===e.sseType?(D(),o.$broadcast(e.content.name,e.content),o.$broadcast("incoming",e.content)):"PORT"===e.sseType?o.$broadcast("port",e.content):"PORT_STATUS"===e.sseType?"normal"===o.MW_SETTING&&(o.redWarning="ERROR"===e.content?e.content:"DOWN"===e.content&&e.content,o.$broadcast("portStatus",e.content)):"INTRUSION_DETECTION"===e.sseType?o.$broadcast("intrusionDetection",e.content):"LEARNING"===e.sseType?o.$broadcast("learning",e.content):"LEARNED_IP_MAC"===e.sseType?o.$broadcast("learnedIpMac",e.content):"LEARNING_RESULT"===e.sseType?o.$broadcast("learningResult",e.content):"DEVICE_UPDATE"===e.sseType?(o.$broadcast("device",e.content),"normal"!==o.MW_SETTING&&(o.redWarning=e.content.deviceOnline===-1&&"ERROR",o.$broadcast("portStatus",e.content.deviceOnline===-1&&"ERROR"))):"DPI_UPGRADE_STATE"===e.sseType?o.$broadcast("dpiUpgradeState",e.content):"TOPOLOGY_DISCOVERY"===e.sseType?o.$broadcast("topologyDiscover",e.content):"INFO_COLLECTION_DPI"===e.sseType||"INFO_COLLECTION_MW"===e.sseType||"INFO_COLLECTION_CONFIGURATION"===e.sseType?"DEBUG"===e.content.action?o.$broadcast("debuginfoCollect",e.content):"CONF_BACKUP"===e.content.action&&o.$broadcast("confBakCollect",e.content):"INFO_RESTORE_CONFIGURATION"===e.sseType?"CONF_BACKUP"===e.content.action&&o.$broadcast("confBakRestore",e.content):(o.$broadcast(e.content.name,e.content),
o.$broadcast("incoming",e.content))},function(){o.sseUpdateConnected=!0,o.$broadcast("sseUpdateConnected")}),T.getEnableMenus=function(){for(var e=o.rootMenu.getChilds(),t=[],n=0;n<e.length;n++){var a=e[n];if(o.parsedMenu)for(var r=0;r<o.parsedMenu[0].length;r++){var i=o.parsedMenu[0][r];a.target===i.target&&i.active&&t.push(a)}}return t},n.checkLast=function(t){if(t){var n=e.get("ulLeftWidth"),o=T.getEnableMenus(),a=$("#topUl"),r=a.find("li"),i=0,l=!1;if(o.length>0)for(var s=0;s<o.length;s++)o[s].state&&s>8&&T.isActive(o[s].state)&&(l=!0),i+=r[s].offsetWidth;l&&(i+=20,a[0].style.width=i+"px",a[0].style.left=n+"px")}},T.slideTopBar=function(t){var n=$("#topMenu"),o=$("#topUl"),a=o.find("li"),r=0;if(a.length>0)for(var i=0;i<a.length;i++)r+=a[i].offsetWidth;r+=20,o[0].style.width=r+"px";var l=n[0].offsetWidth,s=o[0].offsetWidth,c=o[0].offsetLeft,d=s-l,u=(d+c)/l>=1?l:d+c,p=0;t?Math.abs(c)<d&&(p=c-u,p>=0&&(p=0),e.remove("ulLeftWidth"),e.put("ulLeftWidth",p),o[0].style.left=p+"px"):c<0&&(p=d>l?Math.abs(c)%l===0?c+l:c+d%l:c+d,e.remove("ulLeftWidth"),e.put("ulLeftWidth",p),o[0].style.left=p+"px")}}e.$inject=["$cookieStore","$state","$scope","$rootScope","$timeout","$q","evtCnt","topologyId","$modal","auth","sse","Alarm","apiInfo","debounce","Enum","domain","SystemUser"],angular.module("southWest.dashboard").controller("DashboardCtrl",e)}(),function(){"use strict";function e(e){e.state("detect",{parent:"dashboard",url:"/detect?panel",controller:"DetectCtrl as detect",templateUrl:"templates/detect/index.eb7571a4.html",zhName:"入侵检测",resolve:{intrusionDetectionId:["Topology","Detect","domain",function(e,t,n){return n.getDomain().then(function(e){return e[0].domainInfo.currentTopologyId||(e[0].domainInfo.currentTopologyId=0),t.getId(e[0].domainInfo.currentTopologyId)})}],vulnerabilityCount:["Detect",function(e){return e.getVulnerabilityCount().then(function(e){return e})}],state:["$rootScope",function(e){e.currentState="INTRUSION_DETECTION"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.detect").config(e)}(),function(){"use strict";function e(e,n,o,a,r,i,l,s,c,d,u,p,f,m,g,h,v,y,I,D,T,b){function S(){R=I(N,1e4),e.$on("$destroy",function(){I.cancel(R)})}function P(){I.cancel(R)}function A(){V&&(W.intrusionDetectionHandler(),W.startDetectionHandler()),V=!1}function C(){if(!V){W.intrusionDetectionHandler=s.$on("intrusionDetection",function(t,n){if(W.noVulnerability=!1,"realTimeDetection"===n.type&&"STARTED"===n.detectionState?(e.chart&&(e.chart.series[0].setData([]),e.chart.series[1].setData([]),e.chart.series[2].setData([])),W.showStopNotification=!1,W.inUse=!0,e.detectionStarted()):"realTimeDetection"===n.type&&"COMPLETE"===n.detectionState?(W.inUse=!1,W.makeStopNotification(n.content.userName)):"realTimeIntrusionFlowdata"===n.type&&"PROCESSING"===n.detectionState&&(W.inUse=!0),"offlineIntrusionIncident"===n.type&&L||"realTimeIntrusionIncident"===n.type&&!L)k(n.content);else if("offlineIntrusionFlowdata"===n.type&&L||"realTimeIntrusionFlowdata"===n.type&&!L)w(n.content);else if("offlineDetection"===n.type&&"COMPLETE"===n.detectionState){W.inUseOffline=!1,e.offlineDeferred.promise&&(e.offlineDeferred.resolve(),e.chart.redraw());var r={$filter:"intrusionDetectionId eq '"+B+"'"};o.getPatternTableCount(a.id,r).then(function(e){0===e&&(W.noVulnerability=!0)}),A(),N(),P()}});var t=function(){if(L&&W.showGraph)if(e.offlineDeferred=d.defer(),e.offlinePromise=e.offlineDeferred.promise,s.startOfflineAnalyze){s.startOfflineAnalyze=!1;var t={};t.intrusionDetectionId=O,t.detectionType="OFFLINE",o.startAnalyze(a.id,t)}else!W.inUseOffline&&L&&o.lowlevelactor(a.id,B)};s.sseUpdateConnected&&t(),W.startDetectionHandler=s.$on("sseUpdateConnected",function(){t()}),V=!0}}function k(t){var n=[];M.resolve("success"),t.forEach(function(t){t.x>j?n.push(t):e.chart.series[1].addPoint(t)}),N(),n.length>0&&h(function(){k(n)},3e3)}function w(t){M.resolve("success"),t.forEach(function(t){e.chart&&e.chart.series&&e.chart.series[0]&&(L?e.chart.series[0].addPoint(t,W.inUseOffline):e.chart.series[0].addPoint(t),t[0]>j&&(j=t[0]))})}function E(t,n){"ERROR"===n?(e.showNotification=!0,e.eth1Error=!0,e.eth1Down=!1,M.resolve("eth1 error"),M=d.defer(),A()):"DOWN"===n?(e.showNotification=!0,e.eth1Error=!1,e.eth1Down=!0,M.resolve("eth1 down"),M=d.defer(),A()):(e.waitingSSEPromise=M.promise,e.showNotification=!1,e.eth1Error=!1,e.eth1Down=!1,"online"===c.params.panel&&C(),W.inUse||M.resolve("online not in use"))}function N(){o.getPattern(a.id,B).then(function(t){e.intrusionPattern=t})}a.id||(a.id=0),e.PatternDetailPanel=!1,e.showNotification=!1;var M=d.defer();e.offlineDeferred={};var R,U="REALTIME"===g[0].detectionType?0:1,_="OFFLINE"===g[0].detectionType?0:1,x=g[U].intrusionDetectionId,O=g[_].intrusionDetectionId,L=!0,B=L?O:x,V=!1,j=0,W=this;if(W.fileUploaded=g[_].fileUploaded,W.lastOffLineUpdate=new Date(g[_].updatedAt),W.lastOffLineUpdate=moment(W.lastOffLineUpdate).format("YYYY-MM-DD HH:mm:ss"),W.showGraph=!1,W.inUse=g[U].inUse,W.inUseOffline=g[_].inUse,W.noVulnerability=!1,W.lv2MenuEnabledByTarget=b.lv2MenuEnabledByTarget,e.pv=T.get("privilege").filter(function(e){return e.name===s.currentState})[0].actionValue,W.canEdit=(4&e.pv)>0,W.noBlackListWarning=!0,i.getDeployedPolicy("BLACKLIST").then(function(e){W.BlackListDeployed=e.data.length>0}),L&&W.showGraph&&!W.inUseOffline||o.initialstate(a.id,B).then(function(e){W.showRealtimeGraph=e}),0===v){var F=u.open({backdrop:"static",templateUrl:"redirect.html",controller:["$scope","$modalInstance",function(e,t){e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});F.result.then(function(){window.history.back()},function(){window.history.back()})}else s.redWarning?E(null,s.redWarning):L||(N(),S(),C());if(L||(s.$$listeners.portStatus=[],s.$on("portStatus",function(e,t){E(e,t)})),e.$on("$destroy",function(){A()}),W.startOffLine=function(){C()},W.uiEnable=function(e,t){return f.isShow(e,t)},L)e.graphConfigOffline=o.graph2("offline",e);else{W.inUse&&(e.waitingSSEPromise=M.promise,(0===v||s.redWarning)&&(M.resolve("no vulnerability database"),M=d.defer()));var H=new Date(g[U].startTime);isNaN(H)?e.graphConfigOnline=o.graph2("online",e,p("date")(new Date,"medium")):e.graphConfigOnline=o.graph2("online",e,p("date")(H,"medium"))}e.stopDetect=function(){var e=u.open({templateUrl:"stopDetectConfirm.html",controller:["$scope","$modalInstance",function(e,t){e.ok=function(){t.close("ok");var e={};e.intrusionDetectionId=x,e.detectionType="REALTIME",e.userName=D.getUserName(),o.stopAnalyze(a.id,e).then(function(e){})},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});e.result.then(function(e){},function(){})},e.startDetect=function(e){var t={};t.intrusionDetectionId=x,t.detectionType="REALTIME",o.startAnalyze(a.id,t).then(function(){W.inUse=!0,W.showStopNotification=!1,e&&e()})},e.detectionStarted=function(){o.getId(a.id).then(function(t){g=t,"REALTIME"===t[0].detectionType?e.graphConfigOnline=o.graph2("online",e,p("date")(new Date(t[0].startTime),"medium")):e.graphConfigOnline=o.graph2("online",e,p("date")(new Date(t[1].startTime),"medium"))})},e.startRealtimeDetect=function(){e.startDetect(function(){W.showRealtimeGraph=!0})};var G=W.uploader=new r({url:l+"/files/topology/"+a.id+"/"+O+"/pcapupload",autoUpload:!1,queueLimit:1,filters:[{fn:function(e){return"pcap"===e.name.split(".").pop()||(s.addAlert({type:"danger",content:e.name+"不是pcap文件！"}),!1)}}]}),z=!1;W.makeStopNotification=function(t){g[U].userName&&(e.ppl=" "+g[U].userName+" "),t&&(e.ppl=" "+t+" "),W.showStopNotification=!0},W.makeStopNotification(),function(){W.inUse?W.showStopNotification=!1:W.showStopNotification=!0}(),G.onAfterAddingFile=function(t){o.deletePcap(a.id,B).then(function(){z||(e.open(G),z=!0),t.upload()})},W.goBack=function(){c.go("detect",{panel:"offline"})},e.showPatternDetail=function(t){e.signatureId=t,e.currentPage={value:1},e.numPerPage=10;var n={$skip:(e.currentPage.value-1)*e.numPerPage,$limit:e.numPerPage,$orderby:"timestamp desc",$filter:"intrusionDetectionId eq '"+B+"' and signatureId eq "+t},r={$filter:"intrusionDetectionId eq '"+B+"' and signatureId eq "+t},i=[];i.push(o.getPatternDetail(a.id,B,t)),i.push(o.getPatternTable(a.id,n)),i.push(o.getPatternTableCount(a.id,r)),d.all(i).then(function(t){e.patternDetail=t[0],e.patternTable=t[1],e.totalNum=t[2],e.PatternDetailPanel=!0;var n=(new Date).getTime();$("#touch-logo").attr("src","images/exact-touchid-logo-animation.696b5394.gif?"+n)})},e.pageChanged=function(){var t={$skip:(e.currentPage.value-1)*e.numPerPage,$limit:e.numPerPage,$orderby:"timestamp desc",$filter:"intrusionDetectionId eq '"+B+"' and signatureId eq "+e.signatureId};o.getPatternTable(a.id,t).then(function(t){e.patternTable=t})},e.goBack=function(){e.PatternDetailPanel=!1},e.open=function(e){var n=u.open({templateUrl:"templates/detect/offlinePopup.4bb882d1.html",controller:t,backdrop:"static",size:"lg",resolve:{uploader:function(){return e},offlineId:function(){return O}}});n.result.then(function(){z=!1,e.clearQueue(),s.startOfflineAnalyze=!0,W.showGraph=!0,W.startOffLine(),W.inUseOffline=!0},function(){z=!1,e.clearQueue()})},e.showDetail=function(e){var t=u.open({templateUrl:"templates/detect/pattern/detail.f88d7d7d.html",controller:["$scope","$modalInstance","detail",function(e,t,n){e.detail=n,e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}],size:"lg",resolve:{detail:function(){return o.getIncidentDetail(a.id,e)}}});t.result.then(function(){},function(){})}}function t(e,t,n,o,a){function r(){a.userToken()}e.uploader=n,e.uploading=!1;var i=o(r,2e4);e.$on("$destroy",function(){i&&o.cancel(i)}),e.startAnalyze=function(){t.close()},e.cancel=function(){t.dismiss("cancel")},n.onProgressAll=function(){e.uploading=!0},n.onCompleteAll=function(){e.uploading=!1,i&&o.cancel(i)}}e.$inject=["$scope","Topology","Detect","topologyId","FileUploader","Signature","URI","$rootScope","$state","$q","$modal","$filter","uiCtrl","uiTree","intrusionDetectionId","$timeout","vulnerabilityCount","$stateParams","$interval","auth","Enum","leftNavCustomMenu"],t.$inject=["$scope","$modalInstance","uploader","$interval","SystemUser"],angular.module("southWest.detect").controller("DetectCtrl",e)}(),function(){"use strict"}(),function(){"use strict";function e(e){e.state("domain",{parent:"dashboard",url:"/domain",controller:"DomainCtrl as domain",templateUrl:"templates/domain/index.c52fa81b.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}],strategyInfo:["System",function(e){return e.getStrategyInfo()}]}})}e.$inject=["$stateProvider"],angular.module("southWest.domain").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d){function u(e){var t=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])($|(\/([12][0-9]|3[0-2]|[0-9])))$/;return e.match(t)}function p(){g.validation.all=g.validation.name&&g.validation.code}function f(){var e={domainName:g.currentEditDomain.domainInfo.domainName,domainCode:g.currentEditDomain.domainInfo.domainCode,domainInfoId:g.currentEditDomain.domainInfo.domainInfoId,_subnets:g.currentEditDomain.domainInfo._subnets};o.updateDomain(e).then(function(){g.editingDomain=!1,g.updatingUser=!1,g.creatingDomain=!1,g.getDomainData(!1),g.confirmUserEdit()},function(e){i.addAlert({type:"danger",content:"区域修改失败！"+e.data.error})})}function m(){var e=g.isOnlyDomain?"admin":"admin@"+g.currentEditDomain.domainInfo.domainCode,t={user:{name:e,passwordHash:g.currentEditDomain.user.password,stuffName:g.currentEditDomain.user.stuffName,locked:"on"===g.currentEditDomain.user.locked},domainInfo:{domainName:g.currentEditDomain.domainInfo.domainName,domainCode:g.currentEditDomain.domainInfo.domainCode,isMultiDomains:!g.isOnlyDomain}};o.addDomain(t).then(function(){g.editingDomain=!1,g.editingUser=!1,g.updatingUser=!1,g.creatingDomain=!1,g.DomainCreating=!1,g.getDomainData(!0),l.isRemote()&&a.syncDataToAllInOne().then(function(){},function(e){}),i.addAlert({type:"success",content:"区域添加成功！"})},function(e){g.DomainCreating=!1,g.updatingUser=!1,i.addAlert({type:"danger",content:"用户信息同步失败！"})})}var g=this;g.leftColClass="domain-left-col-shrink",g.rightColClass="domain-right-col-expend",g.initOption="single",g.seletedDomain=[],g.editingDomain=!1,g.editingUser=!1,g.creatingDomain=!1,g.noDomain=!1,g.isOnlyDomain=!1,g.orderWordSet="",g.searchWordset="",g.currentEditDomain="",g.modified=!1,g.updatingUser=!1,g.validation={name:!1,code:!1,all:!1,ip:[],mask:[],passowrd:!1};var h=function(e,t){var n=r.open({animation:!0,templateUrl:"domainConfirmPanel.html",size:"sm",controller:["$scope","$modalInstance",function(n,o){n.cancel=function(){o.dismiss("cancel")},n.ok=function(){g.currentEditDomain=angular.copy(e);for(var n=0;n<g.seletedDomain.length;n++)g.seletedDomain[n]=!1;g.seletedDomain[t]=!0,g.editingDomain=!1,g.editingUser=!1,g.creatingDomain=!1,o.close()}}]});n.result.then(function(){},function(){})};g.passwordComplexityStrategy=d.getPassComplexity(s.data),g.passwordComplexityMessage=d.getPassComplexityMessage(g.passwordComplexityStrategy.strategyRules[0].ruleData),g.passwordErrormessages=d.errorMessages,g.showRightCol=function(e,t){if(g.editingDomain||g.creatingDomain||g.editingUser)h(e,t);else{g.currentEditDomain=angular.copy(e);for(var n=0;n<g.seletedDomain.length;n++)g.seletedDomain[n]=!1;g.seletedDomain[t]=!0,g.editingDomain=!1,g.editingUser=!1,g.creatingDomain=!1}},g.setSearchWord=function(){g.searchWordset=g.searchWord,g.getDomainData(!0)},g.setTableOrder=function(e){e===g.orderWordSet?g.orderWordSet="-"+e:g.orderWordSet=e},g.selectAll=function(){for(var e=0;e<g.domainDatas.length;e++)g.domainDatas[e].selected=g.selectAllValue},g.isSelected=function(){for(var e=0;e<g.seletedDomain.length;e++)if(g.seletedDomain[e])return!0;return!1},g.switchOnlyDomain=function(){g.isOnlyDomain?(g.currentEditDomain.domainInfo.domainName="default",g.currentEditDomain.domainInfo.domainCode="default",g.currentEditDomain.domainInfo._subnets=[{domainSubnetMask:"255.255.255.255",domainIp:"0.0.0.0",description:""}],g.validation.name=!0,g.validation.code=!0,g.validation.ip=[!0],g.validation.mask=[!0],g.validation.all=!0):(g.currentEditDomain.domainInfo.domainName="",g.currentEditDomain.domainInfo.domainCode="",g.currentEditDomain.domainInfo._subnets=[{domainSubnetMask:"",domainIp:"",description:""}],g.validation.name=!1,g.validation.code=!1,g.validation.ip=[!1],g.validation.mask=[!1],g.validation.all=!1)},g.editDomain=function(){g.editingDomain=!0,g.validation.ip=[],g.validation.mask=[];for(var e=0;e<g.currentEditDomain.domainInfo._subnets.length;e++)g.validation.ip.push(!0),g.validation.mask.push(!0);g.validation.name=!0,g.validation.code=!0,g.editUser(),p()},g.addDomain=function(e){g.creatingDomain=!0,g.editingDomain=!1,g.editingUser=!1,g.noDomain=!1,g.isOnlyDomain=e,g.currentEditDomain={user:{name:e?"admin":"",passwordHash:"",stuffName:"",locked:"off"},domainInfo:{domainName:e?"default":"",domainCode:e?"default":"",isMultiDomains:!e,_subnets:[{domainSubnetMask:e?"255.255.255.255":"",domainIp:e?"0.0.0.0":"",description:""}]}},g.validation.all=!1,g.validation.ip=[],g.validation.mask=[],g.validation.ip.push(e),g.validation.mask.push(e),g.validation.password=!1,g.validation.name=e,g.validation.code=e,p()},g.addSelectedDomain=function(){"single"===g.initOption?g.addDomain(!0):"multiple"===g.initOption&&g.addDomain(!1)},g.confirmDomainEdit=function(){g.updatingUser=!0,g.creatingDomain?m():g.isOnlyDomain?g.confirmUserEdit():f()},g.cancelDomainEdit=function(){g.editingDomain=!1,g.creatingDomain=!1;for(var e=0;e<g.seletedDomain.length;e++)g.seletedDomain[e]&&(g.currentEditDomain=angular.copy(g.domainDatas[e]));g.domainDatas.length<1&&(g.noDomain=!0),g.cancelUserEdit()},g.editUser=function(){g.modified=!1,delete g.currentEditDomain.user.password,delete g.currentEditDomain.user.checkpassword,g.validation.newPassword=0,g.validation.confirmPassword=0,g.editingUser=!0,g.validation.password=!0,g.currentEditDomain.user.locked=g.currentEditDomain.user.locked?"on":"off"},g.confirmUserEdit=function(){if(g.updatingUser=!0,void 0===g.currentEditDomain.user.password||0===g.currentEditDomain.user.password.length)o.lockUser("on"===g.currentEditDomain.user.locked?"lock":"unlock",g.currentEditDomain.user.userId).then(function(){i.addAlert({type:"success",content:"区域信息修改成功！"}),g.currentEditDomain.user.locked="on"===g.currentEditDomain.user.locked,g.editingUser=!1,g.updatingUser=!1},function(e){i.addAlert({type:"danger",content:"区域信息修改失败！"+e.data.error}),g.cancelUserEdit(),g.updatingUser=!1});else{var e={userId:g.currentEditDomain.user.userId,name:g.currentEditDomain.user.name,failedLoginAttemptCount:g.currentEditDomain.user.failedLoginAttemptCount,locked:"on"===g.currentEditDomain.user.locked,createdBy:g.currentEditDomain.user.createdBy,updatedBy:g.currentEditDomain.user.updatedBy,createdAt:g.currentEditDomain.user.createdAt,updatedAt:g.currentEditDomain.user.updatedAt,_roles:g.currentEditDomain.user._roles,stuffName:g.currentEditDomain.user.stuffName,passwordHash:g.currentEditDomain.user.password};o.updateUser(e).then(function(t){o.lockUser(e.locked?"lock":"unlock",e.userId).then(function(e){g.editingUser=!1,g.updatingUser=!1,i.addAlert({type:"success",content:"区域信息修改成功！"}),g.currentEditDomain.user.locked="on"===g.currentEditDomain.user.locked},function(e){i.addAlert({type:"danger",content:"区域信息修改失败！"+e.data.error}),g.cancelUserEdit(),g.updatingUser=!1})},function(e){i.addAlert({type:"danger",content:"区域信息修改失败！"+e.data.error}),g.cancelUserEdit(),g.updatingUser=!1})}g.getDomainData(!1)},g.cancelUserEdit=function(){g.editingUser=!1;for(var e=0;e<g.seletedDomain.length;e++)g.seletedDomain[e]&&(g.currentEditDomain=angular.copy(g.domainDatas[e]))},g.cancelOnlyUserEdit=function(){g.creatingDomain=!1,g.editingDomain=!1,g.editingUser=!1,g.getDomainData(!1),g.currentEditDomain=angular.copy(g.domainDatas[0])},g.getDomainData=function(e){o.getDomainByKeyword(g.searchWordset).then(function(t){if(angular.forEach(t,function(e){var t=n("date")(e.user.updatedAt,"yyyy-MM-dd HH:mm:ss");e.user.updatedAt=t}),g.domainDatas=t,g.domainDatas.length>0?g.noDomain=!1:g.noDomain=!0,e){g.seletedDomain=[],g.domainDatas.length>0?(g.seletedDomain.push(!0),g.currentEditDomain=angular.copy(g.domainDatas[0]),g.currentEditDomain.domainInfo.isMultiDomains?g.isOnlyDomain=!1:g.isOnlyDomain=!0):(g.currentEditDomain="",g.addDomain(!0));for(var o=1;o<g.domainDatas.length;o++)g.seletedDomain.push(!1)}})},g.getDomainData(!0),g.addSubnet=function(){var e={domainSubnetMask:"",domainIp:"",description:""};g.currentEditDomain.domainInfo._subnets.push(e),g.checkSubnet()},g.deleteSubnet=function(e){g.currentEditDomain.domainInfo._subnets.pop(e),g.checkSubnet()},g.checkName=function(e){!e||e.length<5||e.length>20?g.validation.name=!1:g.validation.name=!0,p()},g.checkCode=function(e){!e||e.length<1||e.length>10?g.validation.code=!1:g.validation.code=!0,p()},g.checkSubnet=function(){g.validation.ip=[],g.validation.mask=[];for(var e=0;e<g.currentEditDomain.domainInfo._subnets.length;e++)g.validation.ip.push(!!u(g.currentEditDomain.domainInfo._subnets[e].domainIp)),g.validation.mask.push(!!u(g.currentEditDomain.domainInfo._subnets[e].domainSubnetMask));p()},g.checkIp=function(e,t){g.validation.ip[t]=!!u(e),p()},g.checkMask=function(e,t){g.validation.mask[t]=!!u(e),p()},g.checkPassword=function(){var e=d.validator(g.currentEditDomain.user.password,g.currentEditDomain.user.checkpassword,g.passwordComplexityStrategy.strategyRules[0].ruleData);g.validation.newPassword=e.newPassValid,g.validation.confirmPassword=e.confirmPassValid,g.validation.password=e.allValid}}e.$inject=["$scope","$state","$filter","domain","System","$modal","$rootScope","uiCtrl","strategyInfo","constantService","passwordValidationService"],angular.module("southWest.domain").controller("DomainCtrl",e)}(),function(){"use strict";function e(e){e.state("help",{abstract:!0,parent:"dashboard",url:"/help",controller:"HelpCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html"})}e.$inject=["$stateProvider"],angular.module("southWest.help").config(e)}(),function(){"use strict";function e(e,t,n){var o=this;o.prefixId="help",o.subMenus=n.rootMenu.getChild("HELP"),o.expanded="true"===t.getItem("help:navbar:expanded"),o.toggleExpand=function(){o.expanded=!o.expanded,t.setItem("help:navbar:expanded",o.expanded)},o.isActive=function(t){return e.current.name.indexOf(t.getState())>-1}}e.$inject=["$state","localStorage","$rootScope"],angular.module("southWest.help").controller("HelpCtrl",e)}(),function(){"use strict";function e(e){e.state("help.monitor_overview",{url:"/monitor/overview",template:"<div>test help monitor overview</div>"}).state("help.monitor_incident",{parent:"help",url:"/monitor/incident",template:"<div>test help monitor incident</div>"}).state("help.monitor_logger",{parent:"help",url:"/monitor/logger",template:"<div>test help monitor logger</div>"}).state("help.monitor_report",{parent:"help",url:"/monitor/report",template:"<div>test help monitor report</div>"})}e.$inject=["$stateProvider"],angular.module("southWest.help.monitor").config(e)}(),function(){"use strict";function e(e){e.state("help.network_interface",{url:"/network/interface",template:"<div>test help network interface</div>"}).state("help.network_static_router",{parent:"help",url:"/network/static_router",template:"<div>test help network static_router</div>"})}e.$inject=["$stateProvider"],angular.module("southWest.help.network").config(e)}(),function(){"use strict";function e(e){e.state("help.object_network_asset",{url:"/object/network_asset",template:"<div>test help object network_asset</div>"}).state("help.object_service",{parent:"help",url:"/object/service",template:"<div>test help object service</div>"}).state("help.object_apply",{parent:"help",url:"/object/apply",template:"<div>test help object apply</div>"}).state("help.object_schedule",{parent:"help",url:"/object/schedule",template:"<div>test help object schedule</div>"})}e.$inject=["$stateProvider"],angular.module("southWest.help.object").config(e)}(),function(){"use strict";function e(e){e.state("help.rule_blacklist",{url:"/rule/blacklist",template:"<div>test help rule blacklist</div>"}).state("help.rule_whitelist",{parent:"help",url:"/rule/whitelist",template:"<div>test help rule whitelist</div>"}).state("help.rule_ipmac",{parent:"help",url:"/rule/ipmac",template:"<div>test help rule ipmac</div>"})}e.$inject=["$stateProvider"],angular.module("southWest.help.rule").config(e)}(),function(){"use strict";function e(e){e.state("help.setting_basic",{url:"/setting/basic",template:"<div>test help setting basic</div>"}).state("help.setting_reliable",{parent:"help",url:"/setting/reliable",template:"<div>test help setting reliable</div>"}).state("help.setting_update",{parent:"help",url:"/setting/update",template:"<div>test help settingupdate</div>"})}e.$inject=["$stateProvider"],angular.module("southWest.help.setting").config(e)}(),function(){"use strict";function e(e){e.state("help.strategy_security",{url:"/strategy/security",template:"<div>test help strategy security</div>"}).state("help.strategy_nat",{parent:"help",url:"/strategy/nat",template:"<div>test help strategy nat</div>"}).state("help.strategy_session",{parent:"help",url:"/strategy/session",template:"<div>test help strategy session</div>"}).state("help.strategy_anti_penetration",{parent:"help",url:"/strategy/anti_penetration",template:"<div>test help strategy anti_penetration</div>"})}e.$inject=["$stateProvider"],angular.module("southWest.help.strategy").config(e)}(),function(){"use strict";function e(e){e.state("infsafety",{parent:"dashboard",url:"/infsafety",controller:"InfsafetyCtrl as infsafety",templateUrl:"templates/infsafety/index.ce01cb8f.html",zhName:"结构安全性",resolve:{infsafetyId:["infSafety",function(e){return e.getId().then(function(e){return e.value})}],state:["$rootScope",function(e){e.currentState="STRUCTURE_SAFETY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.infsafety").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r){function i(){var e=r.open({templateUrl:"calculationError.html",controller:["$scope","$modalInstance",function(e,t){e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});e.result.then(function(e){},function(){})}function l(){var e=r.open({templateUrl:"selectionError.html",controller:["$scope","$modalInstance",function(e,t){e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});e.result.then(function(e){},function(){})}var s=this;s.selected="",e.infsafetyId=t,e.options={source:[],target:[],analyze:[]},s.resultOptions=e.resultOptions={shortestPath:{dropDown:!1,table:!1},itemInThread:{dropDown:!1,table:!1},optimizationPlan:{dropDown:!1,table:!1}},s.showResult=!1,s.selectOption=e.selectOption=function(t){s.selected=e.selected=t},e.disableCalculation={value:!0},s.resetResult=function(){a.$broadcast("infsafetyResult",-1)},s.toggleSuggestedPosition=function(){},s.startCalculation=function(){s.selected="";var r={};r._selectedSourceNameList=e.options.source,r._selectedTargetNameList=e.options.target,_.contains(e.options.analyze,"vimp")&&(r.vimp=1),_.contains(e.options.analyze,"useVulner")&&(r.useVulner=1);for(var c in e.resultOptions)e.resultOptions[c]&&(e.resultOptions[c].dropDown=!1,e.resultOptions[c].table=!1);r._selectedSourceNameList.length&&r._selectedTargetNameList.length?n.calculate(o,t,r).then(function(t){function o(e,t){return e-t}a.$broadcast("infsafetyResult",t),e.result=t,e.result.pathSafetyLength=Object.keys(e.result.pathSafty).length;var r=e.result.pathSafty,l=e.pathSafetyData=[{name:"低危",color:"#79B900",y:0,visible:!1},{name:"中危",color:"#FEDA00",y:0,visible:!1},{name:"高危",color:"#FE540F",y:0,visible:!1}];for(var c in r)r[c]&&(r[c]<=60?(l[2].y++,delete l[2].visible):r[c]>=80?(l[0].y++,delete l[0].visible):(l[1].y++,delete l[1].visible));e.nodeSafety=[],e.dangerousNode=0;for(var d in e.result.nodeSafty)e.result.nodeSafty[d]&&(e.nodeSafety.push(e.result.nodeSafty[d]),e.result.nodeSafty[d]<=60&&e.dangerousNode++);e.nodeSafety.sort(o),e.optimizationPlanCount=0,e.result.mostImprLink.length&&e.optimizationPlanCount++,void 0!==e.result.mostImprNode&&e.nodeMap[e.result.mostImprNode]&&e.optimizationPlanCount++,e.result.usbNode.length&&e.optimizationPlanCount++,e.result.cloudNode.length&&e.optimizationPlanCount++,e.chartConfig=n.pieChart(l,e.filterPathSafety,e.result.allSafe),Object.keys(e.result.pathSafty).length?s.showResult=!0:i()}):l()},s.showResultOption=function(t){if(e.resultOptions[t].dropDown)e.resultOptions[t].dropDown=!1,e.resultOptions[t].table=!1;else for(var n in e.resultOptions)e.resultOptions[n]&&(n===t?(e.resultOptions[n].dropDown=!0,e.resultOptions[n].table=!0):(e.resultOptions[n].dropDown=!1,e.resultOptions[n].table=!1))},s.showResultOptionTable=function(t){e.resultOptions.shortestPath.table=!1,e.resultOptions.itemInThread.table=!1,e.resultOptions.optimizationPlan.table=!1,e.resultOptions[t].table=!0},e.initializeData=function(t){var n="source"===e.selected?"nodeName":"target"===e.selected?"nodeName":"id";e.count=0;for(var o=0;o<t.length;o++)_.contains(e.options[e.selected],t[o][n])?(t[o].checked=!0,e.count++):t[o].checked=!1;return e.count===t.length?e.selectAll=!0:e.selectAll=!1,t},e.initializeAnalyzeData=function(t){var n="source"===e.selected?"nodeName":"target"===e.selected?"nodeName":"id";e.count=0;for(var o=0;o<t.length;o++)_.contains(e.options[e.selected],t[o][n])||0===o?(t[o].checked=!0,e.count++):t[o].checked=!1;return e.count===t.length?e.selectAll=!0:e.selectAll=!1,t}}e.$inject=["$scope","infsafetyId","infSafety","topologyId","$rootScope","$modal"],angular.module("southWest.infsafety").controller("InfsafetyCtrl",e)}(),function(){"use strict";function e(e,t){function n(n){function o(){e.source(t,n.infsafetyId).then(function(e){n.table=n.initializeData(e)})}n.table=[],n.check=function(e,t){_.contains(n.options.source,e)?(n.options.source=_.without(n.options.source,e),n.count--):(n.options.source.push(e),n.count++),t?n.selectAll=n.options.source.length===n.table.length:n.selectAll=!1,n.options.source.length&&n.options.target.length?n.disableCalculation.value=!1:n.disableCalculation.value=!0},n.checkAll=function(e){if(n.options.source=[],n.count=e?n.table.length:0,e)for(var t=0;t<n.table.length;t++)n.table[t].checked=!0,n.options.source.push(n.table[t].nodeName);else for(var o=0;o<n.table.length;o++)n.table[o].checked=!1;n.options.source.length&&n.options.target.length?n.disableCalculation.value=!1:n.disableCalculation.value=!0},o()}var o={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/infsafety/tables/source-table.7502bca5.html",link:n};return o}function t(e,t){function n(n){function o(){e.target(t,n.infsafetyId).then(function(e){n.table=n.initializeData(e)})}n.table=[],n.check=function(e,t){_.contains(n.options.target,e)?(n.options.target=_.without(n.options.target,e),n.count--):n.options.target.push(e),t?(n.selectAll=n.options.target.length===n.table.length,n.count++):n.selectAll=!1,n.options.source.length&&n.options.target.length?n.disableCalculation.value=!1:n.disableCalculation.value=!0},n.checkAll=function(e){if(n.options.target=[],n.count=e?n.table.length:0,e)for(var t=0;t<n.table.length;t++)n.table[t].checked=!0,n.options.target.push(n.table[t].nodeName);else for(var o=0;o<n.table.length;o++)n.table[o].checked=!1;n.options.source.length&&n.options.target.length?n.disableCalculation.value=!1:n.disableCalculation.value=!0},o()}var o={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/infsafety/tables/target-table.b2f12b1a.html",link:n};return o}function n(e){function t(t){function n(){e.analyze().then(function(e){t.table=t.initializeAnalyzeData(e)})}t.table=[],t.check=function(e,n){_.contains(t.options.analyze,e)?(t.options.analyze=_.without(t.options.analyze,e),t.count--):t.options.analyze.push(e),n?(t.selectAll=t.options.analyze.length===t.table.length,t.count++):t.selectAll=!1},t.checkAll=function(e){if(t.options.analyze=[],t.count=e?t.table.length:0,e)for(var n=0;n<t.table.length;n++)t.table[n].checked=!0,t.options.analyze.push(t.table[n].id);else for(var o=0;o<t.table.length;o++)t.table[o].checked=!1},n()}var n={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/infsafety/tables/analyze-table.c40160d0.html",link:t};return n}function o(){function e(e){e.table=[];var t=e.result.pathSafty;if(void 0!==t)for(var n in t)if(t[n]){var o={},a=n.substring(1,n.length-1).split(/,\s+/);o.items=a,o.source=a[0],o.target=a[a.length-1],o.count=a.length,o.score=t[n],e.table.push(o)}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/infsafety/tables/shortest-path-table.ed8150dd.html",link:e};return t}function a(){function e(e){e.table=[];var t=e.result.nodeSafty;for(var n in t)if(t[n]){var o={};o.id=n,o.score=t[n],e.table.push(o)}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/infsafety/tables/item-in-thread-table.4b3f4afd.html",link:e};return t}function r(){function e(e){e.table=[];var t={};e.result.mostImprLink.length&&(t={},t.method="增加安全设备方案",t.location=e.nodeMap[e.result.mostImprLink[0]].name+" ---- "+e.nodeMap[e.result.mostImprLink[1]].name,t.suggestion="增加保护设备",e.table.push(t)),void 0!==e.result.mostImprNode&&e.nodeMap[e.result.mostImprNode]&&(t={},t.method="设备升级方案",t.location=e.nodeMap[e.result.mostImprNode].name,t.suggestion="升级此设备",e.table.push(t)),e.result.usbNode.length&&e.result.usbNode.forEach(function(n){t={},t.method="禁用USB设备",t.location=e.nodeMap[n].name,t.suggestion="禁用此设备USB",e.table.push(t)}),e.result.cloudNode.length&&e.result.cloudNode.forEach(function(n){t={},t.method="更改外网接入模式",t.location=e.nodeMap[n].name,t.suggestion="阻止此外网接入模式",e.table.push(t)})}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/infsafety/tables/optimization-plan-table.4f93b868.html",link:e};return t}e.$inject=["infSafety","topologyId"],t.$inject=["infSafety","topologyId"],n.$inject=["infSafety"],angular.module("southWest.infsafety").directive("sourceTable",e).directive("targetTable",t).directive("analyzeTable",n).directive("shortestPathTable",o).directive("itemInThreadTable",a).directive("optimizationPlanTable",r);
}(),function(){"use strict";function e(){function e(e,t,n,o){function a(){}function r(){}function i(){}o.setConfig({setPosition:!1,isEdited:!1,isInfsafety:!0,isAttackPath:!1,EditTopo:a,drawInfsafety:r,drawAttackPath:i})}var t={scope:!1,restrict:"E",replace:!0,require:"^cdiagram",templateUrl:"/templates/infsafety/optimize-diagram.c6ece08f.html",link:e};return t}angular.module("southWest.infsafety").directive("infsafetyNewDiagram",e)}(),function(){"use strict";function e(e){e.state("monitor.device",{url:"/device?panel",controller:"DeviceCtrl as device",templateUrl:"templates/monitor/device/index.b450cfd0.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}}).state("monitor.device.detail",{parent:"dashboard",url:"/monitor/device/:deviceID?ip?allInOneIP",controller:"DeviceDetailCtrl as detail",templateUrl:"templates/monitor/device/details/details.c5f5fd69.html",resolve:{device:["$stateParams","$q","Device","Topology","topologyId","domain","UCD",function(e,t,n,o,a,r,i){function l(){return n.get(e.deviceID,s.topoId,s.ip).then(function(e){for(var r=0;r<e.length;r++)if("SECURITY_DEVICE"===e[r].category){e=e[r];break}var i=n.getCount({$filter:"category eq FACTORY_DEVICE"});return t.all([n.getBlocksRef(e.blocksRef.baseUrl,s.ip),o.getDeviceNodes(e.deviceId,s.ip),n.getDeviceRuleCount(s.topoId?s.topoId:a.id,e.deviceId,s.ip),n.getDeviceSignatureCount(s.topoId?s.topoId:a.id,e.deviceId,s.ip),i,n.getDeviceDomainRuleCount(s.topoId?s.topoId:a.id,e.deviceId)]).then(function(t){return e.rules=t[0],e.nodes=t[1],e._rulesCount=t[2],e._signaturesCount=t[3],e._iconName=n.getIconName(e.iconType),e._factoryCount=t[4],e._domainRulesCount=t[5],e})},function(){return!1})}var s=i.getDomain(e.allInOneIP||e.ip,a.id);return a.id?l():r.getDomain().then(function(){return l()})}],deviceIncidents:["$stateParams","Incident","Topology","topologyId","domain",function(e,t,n,o,a){function r(){var n=new Date,o=new Date(n.getFullYear(),n.getMonth(),n.getDate());return t.getIncidentsByDevice(e.deviceID,moment(o).utc().format()).then(function(e){return e})}return o.id?r():a.getDomain().then(function(){return r()})}],allInOneIP:["$stateParams",function(e){return e.allInOneIP}],state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.monitor.device").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c){function d(){var e=a.getCount(null,i.id),t="",n=s.get("Role");if(!n[0].defaultRole){var r=s.get("deviceAccess");r.length?(t+=" and (",t+=r.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),t+=")"):t+=" and (contains(deviceId, 'null'))"}var l=a.getCount({$filter:"category eq SECURITY_DEVICE"+t},i.id),c=a.getIpsidsCount(),d=a.getCount({$filter:"category eq SECURITY_DEVICE"},i.id),p=a.getCount({$filter:"category eq FACTORY_DEVICE"},i.id),f=a.getCount({$filter:"category eq NETWORK_DEVICE"},i.id);o.all([e,l,c,d,p,f]).then(function(e){u.overview={},u.overview.all=e[0],u.overview.managedSecurityCount=e[1],u.overview.ipsidsRate=e[2].ips+" / "+e[2].ids,u.overview.securityCount=e[3],u.overview.factoryCount=e[4],u.overview.networkCount=e[5]})}var u=this;return u.contentEnable=function(e){return c.getContentShow(e)},u.defaultTab=u.contentEnable("PROTECTION_SECURITY_DEVICE")?"SECURITY_DEVICE":u.contentEnable("PROTECTION_FACTORY_DEVICE")?"FACTORY_DEVICE":u.contentEnable("PROTECTION_NETWORK_DEVICE")?"NETWORK_DEVICE":"none",i.id?d():l.getDomain().then(function(){return d()})}function t(e,t,n,o,a,r,i,l,s,c,d,u,p,f){function m(){return e.get(r.deviceID,y.topoId,y.ip).then(function(t){for(var n=0;n<t.length;n++)if("SECURITY_DEVICE"===t[n].category){t=t[n];break}var a=e.getCount({$filter:"category eq FACTORY_DEVICE"});return o.all([e.getBlocksRef(t.blocksRef.baseUrl,y.ip),l.getDeviceNodes(t.deviceId,y.ip),e.getDeviceRuleCount(y.topoId?y.topoId:s.id,t.deviceId,y.ip),e.getDeviceSignatureCount(y.topoId?y.topoId:s.id,t.deviceId,y.ip),a,e.getDeviceDomainRuleCount(y.topoId?y.topoId:s.id,t.deviceId)]).then(function(n){t.rules=n[0],t.nodes=n[1],t._rulesCount=n[2],t._signaturesCount=n[3],t._iconName=e.getIconName(t.iconType);var o=t._model_name?t._model_name.split(" /"):[];"数控审计保护平台"===o[0]&&(t._model_name=f("resFilter")(o[0],"slideAuditTitle")+" /"+o[1]),t._factoryCount=n[4],t._domainRulesCount=n[5],h=t})},function(){return!1})}function g(){var e=new Date,t=new Date(e.getFullYear(),e.getMonth(),e.getDate());return u.getIncidentsByDevice(r.deviceID,moment(t).utc().format()).then(function(e){D=e})}var h,v=this,y=d.getDomain(r.allInOneIP||r.ip,s.id),I=[];if(!s.id)return c.getDomain().then(function(){I.push(m())});I.push(m());var D;return s.id?(I.push(g()),void o.all(I).then(function(){function r(){"SECURITY_DEVICE"===v.device.category&&(e.getDPIInfo(h.topologyId,h.deviceId,a).then(function(t){v.message=t.data,v.message?S.resolve("success"):v.message={boxId:"",cpuUsage:0,maxCpuUsage:0,minCpuUsage:0,freeMemory:1024e3,totalMemory:1024e3,maxMemoryUsage:0,minMemoryUsage:0,diskUsageInMegabytes:0,diskInMegabytes:1e3,maxDiskUsageInMegabytes:0,minDiskUsageInMegabytes:0,sysUpTime:0,alarmStatus:!0,cpuState:"NORMAL",memoryState:"NORMAL",diskState:"WARNING",createdAt:"2015-04-15T22:43:56Z",updatedAt:"2015-04-15T22:43:56Z",startDatetime:"2015-04-15T22:43:56Z",topologyId:"0"},v.timer={second:Math.floor(v.message.sysUpTime%60),minute:Math.floor(v.message.sysUpTime/60%60),hour:Math.floor(v.message.sysUpTime/3600%24),day:Math.floor(v.message.sysUpTime/86400)};var o=[{y:Math.round(100*v.message.diskUsageInMegabytes/v.message.diskInMegabytes),color:"#76b900"},{y:100*(v.message.diskInMegabytes-v.message.diskUsageInMegabytes)/v.message.diskInMegabytes,color:"#1f1f1f"}],a=[{y:0===v.message.totalMemory?0:Math.round(100*(v.message.totalMemory-v.message.freeMemory)/v.message.totalMemory),color:"#76b900"},{y:0===v.message.totalMemory?1e6:100*v.message.freeMemory/v.message.totalMemory,color:"#1f1f1f"}];n.deviceCPUUsage?(n.deviceHardDriveUsage=e.pieChart(o,Math.round(100*v.message.diskInMegabytes/1024)/100,l),n.deviceRAMUsage=e.pieChart(a,Math.round(100*v.message.totalMemory/1048576)/100,l),c(v.lineChart),d(v.lineChart,v.message.cpuUsage)):(n.deviceHardDriveUsage=e.pieChart(o,Math.round(100*v.message.diskInMegabytes/1024)/100,l),n.deviceRAMUsage=e.pieChart(a,Math.round(100*v.message.totalMemory/1048576)/100,l),v.testdata={data:[{name:"CPU使用率",data:[null,null,null,null,null,null,null,null,null,null,v.message.cpuUsage,v.message.cpuUsage]}]},n.deviceCPUUsage=e.lineChart(v.testdata,s))}),b=setTimeout(r,1e4))}function l(e){}function s(e){v.lineChart=e}function c(e){e.series[0].removePoint(0,!1)}function d(e,t){e.series[0].addPoint(t)}function u(){e.getACLInfo(h.deviceId).then(function(e){v.aclData=angular.copy(e),v.acl.acls_numValidate=[],v.acl.acls_sourceIpValidate=[],v.acl.acls_destinationIpValidate=[],v.acl.acls_sourcePortValidate=[],v.acl.acls_destinationPortValidate=[],v.acl.acls_sourceIpEdit=[],v.acl.acls_destinationIpEdit=[],v.acl.acls_sourcePortEdit=[],v.acl.acls_destinationPortEdit=[],v.acl.acls_sourcePortDisable=[],v.acl.acls_destinationPortDisable=[],v.invalidAcl=!1;for(var t=0;t<v.aclData.length;t++)"0.0.0.0/0"===v.aclData[t].sourceIp&&(v.aclData[t].sourceIp="ANY"),"0"===v.aclData[t].sourcePort&&(v.aclData[t].sourcePort="ANY"),"0.0.0.0/0"===v.aclData[t].destinationIp&&(v.aclData[t].destinationIp="ANY"),"0"===v.aclData[t].destinationPort&&(v.aclData[t].destinationPort="ANY"),"permit"===v.aclData[t].aclAction?v.aclData[t]._aclAction="允许":v.aclData[t]._aclAction="阻断",v.acl.acls_numValidate.push(!0),v.acl.acls_sourceIpValidate.push(!0),v.acl.acls_destinationIpValidate.push(!0),v.acl.acls_sourcePortValidate.push(!0),v.acl.acls_destinationPortValidate.push(!0),v.acl.acls_sourceIpEdit.push("ANY"!==v.aclData[t].sourceIp),v.acl.acls_destinationIpEdit.push("ANY"!==v.aclData[t].destinationIp),v.acl.acls_sourcePortEdit.push("ANY"!==v.aclData[t].sourcePort),v.acl.acls_destinationPortEdit.push("ANY"!==v.aclData[t].destinationPort),v.acl.acls_sourcePortDisable.push("ICMP"===v.aclData[t].protocolType||"OPC_Classic"===v.aclData[t].protocolType),v.acl.acls_destinationPortDisable.push("ICMP"===v.aclData[t].protocolType||"OPC_Classic"===v.aclData[t].protocolType);v.checkValidation()})}function f(e){var t=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])($|(\/([12][0-9]|3[0-2]|[0-9])))$/;return e.match(t)}function m(e){var t=/^[1-9]+[0-9]*]*$/;return!!t.test(e)&&!(parseInt(e)<1||parseInt(e)>65535)}function g(){v.acl.acls_numValidate=[],v.acl.acls_sourceIpValidate=[],v.acl.acls_destinationIpValidate=[],v.acl.acls_sourcePortValidate=[],v.acl.acls_destinationPortValidate=[];for(var t=[],n=0;n<v.aclData.length;n++){"ANY"===v.aclData[n].sourceIp&&(v.aclData[n].sourceIp="0.0.0.0/0"),"ANY"===v.aclData[n].sourcePort&&(v.aclData[n].sourcePort="0"),"ANY"===v.aclData[n].destinationIp&&(v.aclData[n].destinationIp="0.0.0.0/0"),"ANY"===v.aclData[n].destinationPort&&(v.aclData[n].destinationPort="0"),v.aclData[n].sourceIp.indexOf("/")<0&&(v.aclData[n].sourceIp+="/32"),v.aclData[n].destinationIp.indexOf("/")<0&&(v.aclData[n].destinationIp+="/32");var a={aclNumber:v.aclData[n].aclNumber,aclAction:v.aclData[n].aclAction,aclLog:v.aclData[n].aclLog,sourceIp:v.aclData[n].sourceIp,sourcePort:v.aclData[n].sourcePort,destinationIp:v.aclData[n].destinationIp,destinationPort:v.aclData[n].destinationPort,protocolType:v.aclData[n].protocolType,protocolTypeName:v.aclData[n].protocolType};t.push(e.addACL(h.deviceId,a))}return o.all(t).then(function(e){})}function y(){var e=A.join("],[");return e=e&&"["+e+"]",{portMap:e}}function I(e){if(e&&(v.device=e,A=[]),!v.device.port){for(var t=0;t<P.length;t++)v.port[P[t].portName]={};for(var n=0;n<P.length;n++)for(var o=0;o<P.length;o++)n!==o&&void 0===v.port[P[n].portName][P[o].portName]&&(v.port[P[n].portName][P[o].portName]=v.port[P[o].portName][P[n].portName]={model:!0,port:P[n].portName+","+P[o].portName})}}function T(e){e&&!h.port&&(A=e.substring(1,e.length-1).split("],["),A.forEach(function(e){var t=e.split(",");v.port[t[0]][t[1]].model=!1}),h.port=v.port)}v.simplifyModelName=p.simplifyModelName,v.device=h,v.device.showRoutingInfo=h.nodes[0]&&"ROUTING_IPS"===h.nodes[0].type,v.deviceIncidents=D,v.validateIp=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)($|(\/([12][0-9]|3[0-2]|[0-9])))$/,v.validateSubnet=/^((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}(-((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}|\/((1|2|3(?=1|2))\d|\d))\b$/,v.aclData=[],v.acl={acls_numValidate:[],acls_sourceIpValidate:[],acls_destinationIpValidate:[],acls_sourcePortValidate:[],acls_destinationPortValidate:[],acls_sourceIpEdit:[],acls_destinationIpEdit:[],acls_sourcePortEdit:[],acls_destinationPortEdit:[],acls_sourcePortDisable:[],acls_destinationPortDisable:[]},v.validate=[],v.subnetsValidate=[];var b,S=o.defer();v.waitingDPI=S.promise,"normal"!==t.MW_SETTING?o.all([i.autoLogin(a,"")]).then(function(){r()}):r(),n.$on("$destroy",function(){clearTimeout(b)}),v.device.devicePorts.forEach(function(e){e.isMgmtPort||e._subnets||(e._subnets=[])}),v.editDevice=function(){delete v.device.port,v.editedInfo=angular.copy(v.device),v.isEdited=!0},v.editCancel=function(){angular.copy(v.editedInfo,v.device),I(v.device),T(v.device.notConnectedPortMap),u(),v.isEdited=!1},v.editDone=function(){v.isEdited=!1;var n={};v.device.name=v.editedInfo.name,angular.copy(v.device,n),delete n.rules,delete n.nodes,delete n._policyCount,delete n._signaturesCount,delete n._iconName,delete n._factoryCount,delete n.showRoutingInfo;for(var o=[],a=0;a<n._remoteRoutings.length;a++)o.push({networkSegment:n._remoteRoutings[a].networkSegment,gateway:n._remoteRoutings[a].gateway});var r=y();n.notConnectedPortMap=r.portMap;for(var i=[],l=0;l<n.devicePorts.length;l++)if(!n.devicePorts[l].isMgmtPort){var s={};s.portId=n.devicePorts[l].portId,s._subnets=[];for(var c=0;c<n.devicePorts[l]._subnets.length;c++)n.devicePorts[l]._subnets[c].subnet&&s._subnets.push({subnet:n.devicePorts[l]._subnets[c].subnet});i.push(s)}v.confirmAcl().then(function(){u(),e.routing(n).then(function(e){"SUCCESS"===e.state?t.addAlert({type:"success",content:"编辑设备成功"}):t.addAlert({type:"danger",content:e.reason?"编辑设备失败："+e.reason:"编辑设备失败"})})})},v.fillValidate=function(){v.validate=[];for(var e=0;e<v.device._remoteRoutings.length;e++)v.validate[e]={networkSegment:!0,gateway:!0};v.subnetsValidate=[],v.device.devicePorts.forEach(function(e){var t=[];e.isMgmtPort?v.subnetsValidate.push(t):(e._subnets.forEach(function(){t.push(!0)}),v.subnetsValidate.push(t))})},v.validateSubnets=function(){for(var e=0;e<v.subnetsValidate.length;e++)for(var t=0;t<v.subnetsValidate[e].length;t++)if(!v.subnetsValidate[e][t])return void(v.invalidSubnet=!0);v.invalidSubnet=!1},v.validateInput=function(){for(var e=!0,t=0;t<v.validate.length;t++)e=e&&v.validate[t].networkSegment&&v.validate[t].gateway;v.invalidPorts=!e},v.addRouteTableItem=function(){v.device._remoteRoutings.push({networkSegment:"",gateway:""}),v.validate.push({networkSegment:!1,gateway:!1}),v.validateInput()},v.deleteRouteTableItem=function(e){v.device._remoteRoutings.splice(e,1),v.validate.splice(e,1),v.validateInput()},v.getSignatureCount=function(){var e=0;if(v.device.rules)for(var t=0;t<v.device.rules.length;t++)e+=v.device.rules[t]._signaturesCount;return e},v.setSendPortFunction=function(e,t,n){v.getPortInfoFunction=e,v.initDeviceView=t,v.portMapToArr=n},v.updateDevice=function(e){v.device=e},u(),v.setErrorClass=function(e){return e?"acl-error":"acl-correct"},v.checkNum=function(e,t){for(var n=!1,o=0;o<v.aclData.length;o++)v.aclData[o].aclNumber.toString()===e&&o!==t&&(n=!0);var a=/\D/;v.acl.acls_numValidate[t]=!(n||null===e||""===e||null!==e.match(a)||e<1||e>1024),v.checkValidation()},v.checkIp=function(e,t,n){"source"===n?v.acl.acls_sourceIpValidate[t]=f(e):v.acl.acls_destinationIpValidate[t]=f(e),v.checkValidation()},v.ipChange=function(e,t){"source"===t?v.acl.acls_sourceIpEdit[e]?v.aclData[e].sourceIp="":v.aclData[e].sourceIp="ANY":v.acl.acls_destinationIpEdit[e]?v.aclData[e].destinationIp="":v.aclData[e].destinationIp="ANY","source"===t?v.acl.acls_sourceIpEdit[e]?v.acl.acls_sourceIpValidate[e]=!1:v.acl.acls_sourceIpValidate[e]=!0:v.acl.acls_destinationIpEdit[e]?v.acl.acls_destinationIpValidate[e]=!1:v.acl.acls_destinationIpValidate[e]=!0,v.checkValidation()},v.checkPort=function(e,t,n){"source"===n?v.acl.acls_sourcePortValidate[t]=m(e):v.acl.acls_destinationPortValidate[t]=m(e),v.checkValidation()},v.portChange=function(e,t){"source"===t?v.acl.acls_sourcePortEdit[e]?v.aclData[e].sourcePort="":v.aclData[e].sourcePort="ANY":v.acl.acls_destinationPortEdit[e]?v.aclData[e].destinationPort="":v.aclData[e].destinationPort="ANY","source"===t?v.acl.acls_sourcePortEdit[e]?v.acl.acls_sourcePortValidate[e]=!1:v.acl.acls_sourcePortValidate[e]=!0:v.acl.acls_destinationPortEdit[e]?v.acl.acls_destinationPortValidate[e]=!1:v.acl.acls_destinationPortValidate[e]=!0,v.checkValidation()},v.checkAclProtocol=function(e,t){"ICMP"===e||"OPC_Classic"===e?(v.aclData[t].sourcePort="-1",v.aclData[t].destinationPort="-1",v.acl.acls_sourcePortDisable[t]=!0,v.acl.acls_destinationPortDisable[t]=!0,v.acl.acls_sourcePortEdit[t]=!1,v.acl.acls_destinationPortEdit[t]=!1):(v.acl.acls_sourcePortEdit[t]=!1,v.acl.acls_destinationPortEdit[t]=!1,v.acl.acls_sourcePortDisable[t]=!1,v.acl.acls_destinationPortDisable[t]=!1),v.portChange(t,"source"),v.portChange(t,"destination")},v.addAcl=function(){for(var e=1,t=0;t<v.aclData.length;t++)e=e>v.aclData[t].aclNumber?e:parseInt(v.aclData[t].aclNumber)+1;v.aclData.push({aclNumber:e,aclAction:"permit",sourceIp:"ANY",destinationIp:"ANY",protocolType:"ANY",sourcePort:"ANY",destinationPort:"ANY",aclLog:!1}),v.acl.acls_numValidate.push(!0),v.acl.acls_sourceIpValidate.push(!0),v.acl.acls_destinationIpValidate.push(!0),v.acl.acls_sourcePortValidate.push(!0),v.acl.acls_destinationPortValidate.push(!0),v.acl.acls_sourceIpEdit.push(!1),v.acl.acls_destinationIpEdit.push(!1),v.acl.acls_sourcePortEdit.push(!1),v.acl.acls_destinationPortEdit.push(!1),v.checkValidation()},v.deleteSingleAcl=function(t){var n=[{deviceACLId:v.aclData[t].deviceACLId}];e.deleteACL(h.deviceId,n).then(function(){v.aclData.splice(t,1),v.acl.acls_numValidate.splice(t,1),v.acl.acls_sourceIpValidate.splice(t,1),v.acl.acls_destinationIpValidate.splice(t,1),v.acl.acls_sourcePortValidate.splice(t,1),v.acl.acls_destinationPortValidate.splice(t,1),v.acl.acls_sourceIpEdit.splice(t,1),v.acl.acls_destinationIpEdit.splice(t,1),v.acl.acls_sourcePortEdit.splice(t,1),v.acl.acls_destinationPortEdit.splice(t,1),v.acl.acls_sourcePortDisable.splice(t,1),v.acl.acls_destinationPortDisable.splice(t,1),v.checkValidation()})},v.checkValidation=function(){for(var e=!0,t=0;t<v.aclData.length;t++)e&=v.acl.acls_numValidate[t]&&v.acl.acls_sourceIpValidate[t]&&v.acl.acls_destinationIpValidate[t]&&v.acl.acls_sourcePortValidate[t]&&v.acl.acls_destinationPortValidate[t];v.invalidAcl=!e},v.confirmAcl=function(){var t=o.defer();if(v.checkValidation(),!v.invalidAcl){for(var n=[],a=0;a<v.aclData.length;a++)void 0!==v.aclData[a].deviceACLId&&n.push(v.aclData[a].deviceACLId);if(n.length>0){var r=[{deviceACLId:n}];e.deleteACL(h.deviceId,r).then(function(e){v.checkValidation(),g().then(function(){t.resolve("SUCCESS")})})}else g().then(function(){t.resolve("SUCCESS")})}return t.promise};var P=[],A=[];v.validateIp=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)($|(\/([12][0-9]|3[0-2]|[0-9])))$/,v.validateSubnet=/^((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}(-((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}|\/((1|2|3(?=1|2))\d|\d))\b$/,h.devicePorts.forEach(function(e){e.isMgmtPort?v.mgmt=e:P.push(e)}),v.port=h.port||{},I(),T(h.notConnectedPortMap),v.changeTopoStatus=function(e,t){v.port[e][t].model?A=A.filter(function(n){return n!==v.port[e][t].port}):A.push(v.port[e][t].port)},v.updateSubnetStatus=function(e,t,n,o){"delete"===n?(h.devicePorts[e]._subnets.splice(t,1),v.subnetsValidate[e].splice(t,1)):"add"===n?(h.devicePorts[e]._subnets.push({subnet:""}),v.subnetsValidate[e].push(!0)):(n=!o||v.validateSubnet.test(o),v.subnetsValidate[e][t]=n),v.validateSubnets()}})):c.getDomain().then(function(){I.push(g())})}function n(e,t,n,o){function a(){function t(){return{category:{$select:"make",$filter:"category eq "+a.category,$limit:1e6},make:{$select:"model",$filter:"category eq "+a.category+" and make eq '"+a.make+"'",$limit:1e6},model:{$select:"version",$filter:"category eq "+a.category+" and make eq '"+a.make+"' and model eq '"+a.model+"'",$limit:1e6}}}var a=e.device={},i=e.forms={};a.category="SECURITY_DEVICE",a.name="新设备",i.category=_.uniq(o,"category").map(function(e){return e.category});var l=i.category.indexOf("NETWORK_DEVICE");i.category.splice(l,1),function e(o){if("version"===o)return void(r.select=e);var l=t(),s=l[o].$select;n.getModels(l[o]).then(function(e){return i[s]=_.unique(e,s).map(function(e){return e[s]}),a[s]="",s}).then(function(t){e(t)})}("category")}var r=e.newDevice={};r.step=1,a(),r.previous=function(){r.step--},r.next=function(){r.step++},r.done=function(){e.device.modelIdentifier=e.device.model,delete e.device.model,n.createDevice(e.device).then(function(e){}),t.close("done")},r.cancel=function(){t.dismiss("cancel")}}function o(){function e(e){e.selectedPort="mgmt",e.ports=[{name:"P0/P1",mode:"IDS",status:1,sub:[{name:"P0",status:1},{name:"P1",status:1}]},{name:"P2/P3",mode:"IDS",status:1,sub:[{name:"P2",status:0},{name:"P3",status:1}]}],e.selectPort=function(t){var n;if("P0"===t||"P1"===t)n=0;else{if("P2"!==t&&"P3"!==t)return void(e.selectedPort=t);n=1}"IPS"===e.ports[n].mode?e.selectedPort=e.ports[n].name:e.selectedPort=t},e.is=function(t,n){return e.selectedPort===t||e.selectedPort===n},e.portsWidth=function(){for(var t=1,n=0;n<e.ports.length;n++)t+="IDS"===e.ports[n].mode?2:1;return 290*t}}var t=this;e(t)}e.$inject=["$rootScope","$state","$modal","$q","Device","Topology","topologyId","domain","Enum","uiTree"],t.$inject=["Device","$rootScope","$scope","$q","allInOneIP","$stateParams","auth","Topology","topologyId","domain","UCD","Incident","deviceTypeService","$filter"],n.$inject=["$scope","$modalInstance","Device","categories"],angular.module("southWest.monitor.device").controller("DeviceCtrl",e).controller("DeviceDetailCtrl",t).controller("DeviceModelCtrl",o)}(),function(){"use strict";function e(e,t,n,o,a,i,l){function s(s,c,d,u){function p(o){o.$orderby&&""!==o.$orderby||(o.$orderby="name");var a=o||{};return a.$filter=g,t.getAll(a).then(function(o){for(var a=0;a<o.length;a++){o[a]._iconName=t.getIconName(o[a].iconType);var i=o[a]._model_name?o[a]._model_name.split(" /"):[];"数控审计保护平台"===i[0]&&(o[a]._model_name=l("resFilter")(i[0],"slideAuditTitle")+" /"+i[1])}var s=o.map(function(e){return n.getDeviceNodes(e.deviceId)});return s.length?e.all(s).then(function(n){var a=o.map(function(e,a){for(var r=[],i=0;i<n[a][0].ports.length;i++)r.push(+n[a][0].ports[i].substr(1));var l=r.sort();return n[a][0].portRange="p"+l[0]+"-p"+l[l.length-1],o[a].nodes=n[a],t.getNodeRules(o[a].nodes).then(function(t){e.nodes=t})});return e.all(a).then(function(){return r(o)})}):[]})}function f(e){var n=e||{};return n.$filter=g,t.getCount(n,a.id)}function m(e){return t.search("SECURITY_DEVICE",e)}s.simplifyModelName=i.simplifyModelName,u.disableToolbar=!0;var g="category eq SECURITY_DEVICE",h=o.get("Role");if(!h[0].defaultRole){var v=o.get("deviceAccess");v.length?(g+=" and (",g+=v.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),g+=")"):g+=" and (contains(deviceId, 'null'))"}u.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:p,getCount:f,search:m})}var c={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/device/securityDevice.21deca05.html",link:s};return c}function t(e,t,n){function o(o,a,r,i){function l(t){t.$orderby&&""!==t.$orderby||(t.$orderby="name");var n=t||{};return n.$filter=d,e.getAll(n)}function s(n){var o=n||{};return o.$filter=d,e.getCount(o,t.id)}function c(t){return e.search("FACTORY_DEVICE",t)}i.disableToolbar=!0;var d="category eq FACTORY_DEVICE";i.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:l,getCount:s,search:c}),i.getType=function(e){return n.getFactoryType(e)}}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/device/factoryDevice.87cfc266.html",link:o};return a}function n(e,t,n){function o(o,a,r,i){function l(t){t.$orderby&&""!==t.$orderby||(t.$orderby="name");var n=t||{};return n.$filter=d,e.getAll(n)}function s(n){var o=n||{};return o.$filter=d,e.getCount(o,t.id)}function c(t){return e.search("NETWORK_DEVICE",t)}i.disableToolbar=!0;var d="category eq NETWORK_DEVICE";i.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:l,getCount:s,search:c}),i.getType=function(e){return n.getNetworkType(e)}}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/device/networkDevice.a9d70356.html",link:o};return a}function o(){function e(e){e.validateIp=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)($|(\/([12][0-9]|3[0-2]|[0-9])))$/,e.validateSubnet=/^((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}(-((\b|\.)(1|2(?!5(?=6|7|8|9)|6|7|8|9))?\d{1,2}){4}|\/((1|2|3(?=1|2))\d|\d))\b$/}var t={scope:{device:"=",isEdit:"@"},restrict:"E",replace:!0,templateUrl:"/templates/monitor/device/details/details-device-view.536c5b41.html",link:e};return t}function a(e){function t(t,n,o,a){function r(n){return e.getBlocksRef(t.detail.device.blocksRef.baseUrl,n)}function i(n){return e.getBlocksRefCount(t.detail.device.blocksRef.baseUrl,n)}function l(t){return e.search("FACTORY_DEVICE",t)}a.disableToolbar=!0,t.disableToolbarButtons=!0,a.setConfig({name:"rules",pagination:!0,scrollable:!1,totalCount:!0,getAll:r,getCount:i,search:l})}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/device/details/details-device-rules.e586cda9.html",link:t};return n}function r(e){for(var t in e)if(t&&e[t].nodes)for(var n in e[t].nodes)if(n&&e[t].nodes[n].ports&&"IPS"===e[t].nodes[n].type&&1===e[t].nodes[n].online)for(var o in e[t].nodes[n].ports){if(1!==e[t].nodes[n].online)break;if(o&&e[t].nodes[n].ports[o])for(var a in e[t].devicePorts)if(a&&e[t].devicePorts[a].portName===e[t].nodes[n].ports[o]&&1!==e[t].devicePorts[a].linkState){e[t].nodes[n].online=e[t].devicePorts[a].linkState;break}}return e}e.$inject=["$q","Device","Topology","Enum","topologyId","deviceTypeService","$filter"],t.$inject=["Device","topologyId","deviceTypeService"],n.$inject=["Device","topologyId","deviceTypeService"],a.$inject=["Device"],angular.module("southWest.monitor.device").directive("securityDevice",e).directive("factoryDevice",t).directive("networkDevice",n).directive("deviceView",o).directive("deviceRules",a)}(),function(){"use strict";function e(e,t,n,o,a,r){function i(i,l,s,c){function d(o){o.$orderby&&""!==o.$orderby||(o.$orderby="name");var a=o||{};return a.$filter=m,t.getAll(a).then(function(o){for(var a=0;a<o.length;a++){o[a]._iconName=t.getIconName(o[a].iconType);for(var r=0;r<o[a].devicePorts.length;r++)o[a].devicePorts[r].isMgmtPort&&(o[a].mmIP=o[a].devicePorts[r].portIp)}var i=o.map(function(e){return n.getDeviceNodes(e.deviceId)});return i.length?e.all(i).then(function(n){var a=o.map(function(e,a){return o[a].nodes=n[a],t.getNodeRules(o[a].nodes).then(function(t){e.nodes=t})});return e.all(a).then(function(){return f(o)})}):[]})}function u(e){var n=e||{};return n.$filter=m,t.getCount(n)}function p(e){return t.search("SECURITY_DEVICE",e)}function f(e){for(var t in e)if(t&&e[t].nodes)for(var n in e[t].nodes)if(n&&e[t].nodes[n].ports&&"IPS"===e[t].nodes[n].type&&1===e[t].nodes[n].online)for(var o in e[t].nodes[n].ports){if(1!==e[t].nodes[n].online)break;if(o&&e[t].nodes[n].ports[o])for(var a in e[t].devicePorts)if(a&&e[t].devicePorts[a].portName===e[t].nodes[n].ports[o]&&1!==e[t].devicePorts[a].linkState){e[t].nodes[n].online=e[t].devicePorts[a].linkState;break}}return e}c.disableToolbar=!0;var m="category eq SECURITY_DEVICE",g=o.get("Role");if(!g[0].defaultRole){var h=o.get("deviceAccess");h.length?(m+=" and (",m+=h.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),m+=")"):m+=" and (contains(deviceId, 'null'))"}c.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:d,getCount:u,search:p}),c.getSecondLevelTableData=function(n){for(var o,i=0;i<n.devicePorts.length;i++)if(n.devicePorts[i].isMgmtPort){o=n.devicePorts[i].portIp;break}e.all([a.autoLogin(o,"")]).then(function(){var e=[];e.$orderby&&""!==e.$orderby||(e.$orderby="name");var n=e||{};n.$filter="category ne SECURITY_DEVICE";var a,i=r.ucdInfo;i&&i.filter(function(e){a=e.ip===o?e.topoId:e.topoId}),t.getAll(n,a,o).then(function(e){c.secondLevelTable=e})})}}var l={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/device/ucdDevice.247b8fcd.html",link:i};return l}e.$inject=["$q","Device","Topology","Enum","auth","$rootScope"],angular.module("southWest.monitor.device").directive("ucdDevice",e)}(),function(){"use strict";function e(e){e.state("monitor.incident",{url:"/incident",controller:"IncidentCtrl as incident",templateUrl:"templates/monitor/incident/index.b9df8eb1.html",resolve:{state:["$rootScope",function(e){e.currentState="INCIDENT EVENT"}]}}).state("monitor.incident.graph",{url:"/graph?panel",resolve:{menuState:function(){return"monitor.incident"}}}).state("monitor.incident.list",{url:"/list?panel",resolve:{menuState:function(){return"monitor.incident"}}}).state("monitor.incident.detail",{parent:"dashboard",url:"/monitor/incident/:eventId",controller:"IncidentDetailCtrl as detail",templateUrl:"templates/monitor/incident/detail.5cdaa82e.html",resolve:{detail:["$stateParams","$q","Incident","domain","apiInfo","secretKey",function(e,t,n,o,a,r){var i={};return a.sysbaseinfo().then(function(o){var a=new Date(o.data),r=new Date(a.getFullYear(),a.getMonth(),a.getDate());return i.startOfDay=r,n.getIncidentById(e.eventId).then(function(e){return i.incident=e,t.all([n.getAsset(i.incident.sourceIp),n.getAsset(i.incident.destinationIp)])}).then(function(e){i.nodes={};var t=e[0].length>0?e[0][0]:{};t.category="ASSET",i.nodes[0]=t,i.nodes[1]={},i.nodes[1].category="SECURITY_DEVICE",i.nodes[1].name="防火墙";var n=e[1].length>0?e[1][0]:{};return n.category="ASSET",i.nodes[2]=n,i})})}],state:["$rootScope",function(e){e.currentState="INCIDENT"}],menuState:function(){return"monitor.incident"}}})}e.$inject=["$stateProvider"],angular.module("southWest.monitor.incident").config(e)}(),function(){"use strict";function e(e,t,n,o){var a=this;a.shouldFlashEvent=!1,a.shouldFlashIncident=!1,a.notInitTodayCount=!0,a.notInitIncidentCount=!0,a.notInitPeakHour=!0,a.notInitErrorCount=!0,o.getTodayIncidentCount().then(function(e){a.todayCount=e,a.notInitTodayCount=!1}),o.getUnreadIncidentCount().then(function(e){a.unReadIncidentCount=e,a.notInitIncidentCount=!1}),o.getPeakHour().then(function(e){a.peakHour=e,a.notInitPeakHour=!1}),o.getErrorCount().then(function(e){a.errorIncidentCount=e,a.notInitErrorCount=!1}),a.defaultTab="incident",a.clickIncRow=function(e){"NEW"===e.status&&(o.updateIncidentStatus(e.incidentId),e.status="READ",a.unReadIncidentCount--)},t.$on("newIncidentInsert",function(){a.showRefreshConfirmation?e(function(){a.shouldFlashIncident=!0},2e3):a.shouldFlashIncident=!0}),a.showRefreshMessage=function(){a.showRefreshConfirmation=!0,e(function(){a.showRefreshConfirmation=!1},2e3)},a.getAllCounts=function(){a.notInitTodayCount=!0,a.notInitIncidentCount=!0,a.notInitPeakHour=!0,a.notInitErrorCount=!0,n.all([o.getTodayIncidentCount(),o.getUnreadIncidentCount(),o.getPeakHour(),o.getErrorCount()]).then(function(e){a.todayCount=e[0],a.notInitTodayCount=!1,a.unReadIncidentCount=e[1],a.notInitIncidentCount=!1,a.peakHour=e[2],a.notInitPeakHour=!1,a.errorIncidentCount=e[3],a.notInitErrorCount=!1})},a.refreshCounts=function(){a.shouldFlashIncident===!0&&a.getAllCounts()}}function t(e){var t=this;t.incident=e.incident,t.incident&&t.incident.packet&&(t.incident.packet.hb_sliced=t.incident.packet.hb&&Array.isArray(t.incident.packet.hb)?t.incident.packet.hb.slice(0,57):[]),t.nodes=e.nodes,t.expend=!1}angular.module("southWest.monitor.incident").controller("IncidentCtrl",["$timeout","$scope","$q","Incident",e]).controller("IncidentDetailCtrl",["detail",t])}(),function(){"use strict";function e(e,n,o,a,r,i,l,s,c,d){function u(u,p,f,m){function g(e){return e.$orderby&&""!==e.$orderby||(e.$orderby="incidentId desc"),u.params=e,n.getIncidents(e).then(function(e){if(0===y.length)return e;var t=y.slice();return e.map(function(e){for(var n=0;n<t.length;n++)if(t[n]===e.incidentId)return e.checkbox=!0,t.splice(n,1),e;return e})})}function h(e){return n.getIncidentCount(e)}function v(e){return e.$orderby&&""!==e.$orderby||(e.$orderby="incidentId desc"),u.params=e,n.getIncidents(e)}var y=[];if(u.checkToSelect=!1,u.markAllRead=function(){t(e,n,"read",u,l)},u.markAllDeleted=function(){t(e,n,"delete",u,l,d.defer())},m){var I=["sourceIp","destinationIp","sourcePort","destinationPort","matchedKey","enumString"];m.setConfig({name:"incident",pagination:!0,scrollable:!1,totalCount:!0,getAll:g,getCount:h,search:v,fields:I,predicate:"incidentId",reverse:!0,advancedSearch:"incidents",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"level",display:"事件等级",input:"checkbox",option:!0,value:"-1",options:[{value:"-1",text:"全部"},{value:"WARN",text:"警告"},{value:"DROP",text:"丢弃"},{value:"REJECTBOTH",text:"阻断"}]},{name:"sourceIp",display:"起源IP地址",input:"string",option:!1,value:""},{name:"destinationIp",display:"目标IP地址",input:"string",option:!1,
value:""},{name:"sourcePort",display:"起源端口",input:"string",option:!1,value:""},{name:"destinationPort",display:"目标端口",input:"string",option:!1,value:""},{name:"matchedKey",display:"规则",input:"string",option:!1,value:""}]})}else{var D=u.dtable={};n.getAll().then(function(e){D.table=e})}u.openImportPanel=function(t){function n(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new a({url:r+"/incidents/topology/"+i.id+"/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){l.addAlert({type:"danger",content:"导入安全事件失败： "+t.error})},e.uploader.onSuccessItem=function(){c(function(){s.reload()},2e3),l.addAlert({type:"success",content:"导入安全事件成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}var d=e.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:n,size:"sm",resolve:{extension:function(){return t}}});d.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},u.openExportPanel=function(t){function a(e,t){e.addPsw="1",e.validatePsw=function(e){var t=/^(?=.*[a-zA-Z])(?=.*\d)(?=.*(_|[^\w])).+$/g;return e&&e.match(t)&&e.length>=8&&e.length<25},e.download=function(e){t.close(),n.getAllExport(r,e).then(function(e){window.open("./"+e,"_self")},function(){l.addAlert({type:"danger",content:"导出数据失败，请稍后重试"})})},e.cancel=function(){t.dismiss("cancel")}}var r=t?u.params:{};r.$limit=1e5,r.$skip=0,r.$orderby&&""!==r.$orderby||(r.$orderby="incidentId desc");var i=e.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:["$scope","$modalInstance",a],size:"sm"});i.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var p={scope:!1,restrict:"E",require:"^?dtable",replace:!0,templateUrl:"/templates/monitor/incident/incidentTable.f568f364.html",link:u};return p}function t(e,t,n,o,a,r){var i=e.open({size:"sm",templateUrl:"templates/monitor/incident/confirmation.5342a33c.html",controller:["$scope","$modalInstance",function(e,t){e.content="delete"===n?"清除所有事件":"标记所有未读成已读",e.confirm=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}]});i.result.then(function(){"delete"===n?(a.deleteAllIncidentsPromise=r.promise,t.deletedAll("incident").then(function(e){r.resolve("success"),0===e?(o.incident.unReadIncidentCount=0,o.incident.todayCount=0,o.incident.errorIncidentCount=0,o.dtable.table=[],o.dtable.totalNum=0):a.addAlert({type:"danger",content:"删除安全事件失败： 错误码"+e})})):"read"===n&&t.markAllRead("incident").then(function(){o.incident.unReadIncidentCount=0,angular.forEach(o.dtable.table,function(e){e.status="READ"})})},function(){})}function n(e,t,n,o,a,r){return{restrict:"E",replace:!0,templateUrl:"/templates/monitor/incident/timeline.bf56d3cd.html",controller:function(){},controllerAs:"timeline",link:function(t,i){var l,s=t.timeline;s.getServerTime=function(){return moment().subtract(l||0)},r.getCurtime().then(function(e){l=moment().valueOf()-moment(e).valueOf(),s.init()}),s.init=function(e){s.destroy(),s.initOptions(e),s.setup()},s.initOptions=function(e){s.defaultOptions={timeRulerDuration:36e5,zoom:5,updateDuration:2e4,showFilter:!0,pausing:!1,realtime:!0},e=_.assign(s.defaultOptions,e);var t=_.zipObject(_.range(1,11).map(function(e,t){return[e,27+6*t]}));s.pausing=e.pausing,s.scrolling=!0,s.$wrap=i.find(".wrap"),s.title="实时事件时间线",s.widthPerMinute=t[e.zoom],s.timeRulerDuration=e.timeRulerDuration,s.updateDuration=e.updateDuration,s.templateUrl="incidentPopoverTemplate",s.showFilter=e.showFilter,s.types=["WARN","DROP","REJECTBOTH"],s.typeMap={WARN:{icon:"fa-warning",color:"#fb9700",filter:!0,name:"警告"},DROP:{icon:"fa-trash",color:"#fe540f",filter:!0,name:"丢弃"},REJECTBOTH:{icon:"fa-ban",color:"#c9420c",filter:!0,name:"阻断"}}},s.setup=function(){s.bindEvent(),s.calcTime(),s.initSize(),s.calcTimeRuler(),s.render(),s.initIncidents()},s.openConfigModal=function(e){n.open({templateUrl:"configTemplate",scope:t,controller:["$scope","$modalInstance","$rootScope",function(t,n,o){"ngInject";t.config=_.clone(s.defaultOptions),t.config.dateInput=t.config.dateInput||s.timeRulerEnd._d,t.config.timeInput=t.config.timeInput||s.timeRulerEnd._d,e&&(t.config.realtime=!t.config.realtime),t.cancel=function(){n.dismiss("cancel")},t.setConfig=function(){if(!t.config.realtime){if(!t.config.dateInput||!t.config.timeInput)return o.addAlert({type:"danger",content:"请选择结束时间"});t.time=moment(t.config.dateInput).format("YYYY-MM-DD")+" "+moment(t.config.timeInput).format("HH:mm:ss")}var e={realtime:t.config.realtime,dateInput:t.config.dateInput,timeInput:t.config.timeInput,pausing:!t.config.realtime,subtractTime:t.time?s.getServerTime().valueOf()-moment(t.time).valueOf():0,showFilter:t.config.showFilter,zoom:t.config.zoom};s.init(e),n.close("done")}}],size:"sm"})},s.groupIncidentsData=function(e){var t=_.groupBy(e,function(e){return moment(e.time).unix()});return t},s.initIncidents=function(){s.needUpdate=!1,a.getTimelineIncidents({start:s.timeRulerStart.utc().format(),end:s.timeRulerEnd.utc().format()}).then(function(e){return e.filter(function(e){return e.total>0})}).then(function(e){s.incidents=s.filterIncidents(s.groupIncidentsData(e)),s.maxCountPerSecond=Math.max.apply(null,e.map(function(e){return e.total}))})},s.updateIncidents=function(){a.getTimelineIncidents({start:s.timeRulerEnd.utc().format(),end:s.timeRulerEnd.add(s.updateDuration).utc().format()}).then(function(e){return e.filter(function(e){return e.total>0})}).then(function(e){s.incidents=_.omit(_.assign(s.incidents,s.filterIncidents(s.groupIncidentsData(e))),function(e,t){return parseInt(t)<s.timeRulerStart.unix()}),s.maxCountPerSecond=Math.max(Math.max.apply(null,e.map(function(e){return e.total})),s.maxCountPerSecond)})},t.$watch("timeline.typeMap",function(){s.incidents=s.filterIncidents(s.incidents)},!0),s.filterIncidents=function(e){return _.mapValues(e,function(e){return e.map(function(e){return{time:moment(e.time).unix(),data:_.mapValues(e.data,function(e,t){return _.assign(e,{filter:!s.typeMap||s.typeMap[t].filter})}),total:_.values(e.data).filter(function(e){return e.filter}).map(function(e){return e.count}).reduce(function(e,t){return e+t},0)}})})},t.$watch("timeline.maxCountPerSecond",function(){s.calcYAxis()}),s.calcYAxis=function(){if(s.maxCountPerSecond&&s.maxCountPerSecond>0){var e=s.maxCountPerSecond<10?10:Math.pow(10,Math.floor(Math.log10(s.maxCountPerSecond)));s.maxYAxis=Math.ceil((s.maxCountPerSecond+1)/e)*e;var t=s.maxYAxis<9?s.maxYAxis:10;s.YAxis=_.range(s.maxYAxis/t,s.maxYAxis+1,s.maxYAxis/t)}},s.initSize=function(){s.elementWidth=i.width(),s.elementHeight=i.height()},s.clickDocumentListener=function(){s.activePopover&&s.activePopover.popover("hide").parent().removeClass("active"),delete s.activePopover,s.mouseleave()},s.bindEvent=function(){$(window).on("resize",_.throttle(function(){e.cancel(s.resumeTimer),s.pausing=!0,s.resumeTimer=e(function(){s.pausing=!1},500),s.initSize(),s.$wrap.stop().css({left:"",right:parseInt(s.$wrap.css("right"))}),t.$digest()},100)),$(window).on("click",s.clickDocumentListener),$(window).on("keydown",_.throttle(function(e){switch(e.keyCode){case 37:s.prev(),$(window).trigger("click");break;case 39:s.next(),$(window).trigger("click")}},200))},s.floorTime=function(e,t){return e.subtract(e.unix()%t*1e3)},s.calcTime=function(){s.timeRulerEnd=s.floorTime(s.getServerTime().subtract(s.defaultOptions.subtractTime||0),20),s.timeRulerStart=s.floorTime(s.getServerTime().subtract(s.defaultOptions.subtractTime||0).subtract(s.timeRulerDuration),20),s.subTitle=s.timeRulerStart.format("HH:mm:ss")+"至"+s.timeRulerEnd.format("HH:mm:ss")},s.calcTimeRuler=function(){var e,t,n;s.calcTime(),s.timeRulerList=_.range(Math.ceil(s.timeRulerDuration/s.updateDuration)+10).map(function(n,o){return e=moment(1e3*s.timeRulerStart.unix()+o*s.updateDuration),t=e.unix()%300===0?"lg":e.unix()%60===0?"md":e.unix()%20===0?"sm":"xs",{className:t,unix:e.unix(),format:e.unix()%300===0?e.format("HH:mm'"):e.unix()%60===0?e.format("mm'"):"",full:e.format("HH:mm:ss"),start:e.utc().format(),end:e.add(s.updateDuration).utc().format()}}),s.wrapWidth=s.widthPerMinute/3*s.timeRulerList.length,s.scrolling?s.$wrap.css({left:"",right:s.offset-s.widthPerMinute/3}):(n=parseInt(s.$wrap.css("left")),s.$wrap.css({right:"",left:n+s.widthPerMinute/3})),s.lastOffset=s.offset||0,s.offset=(s.timeRulerEnd.unix()+100+s.timeRulerEnd.millisecond()/1e3-s.timeRulerList[s.timeRulerList.length-1].unix)*s.widthPerMinute/60,s.scrolling?s.$wrap.stop().animate({right:s.offset},500):s.$wrap.animate({left:n},500)},s.render=function(){s.nowDate=s.getServerTime().format("YYYY-MM-DD"),s.nowTime=s.getServerTime().format("hh:mm:ss"),s.defaultOptions.realtime&&(s.renderTimer=e(function(){s.needUpdate=!0,s.render()},s.updateDuration),!s.pausing&&s.needUpdate&&(s.defaultOptions.realtime&&s.updateIncidents(),s.calcTimeRuler()))},s.pause=function(){e.cancel(s.resumeTimer),s.pausing=!0},s.resume=function(){s.pausing=!1},s.resumeScrolling=function(){s.scrolling=!0,e(function(){s.$wrap.css({left:"",right:parseInt(s.$wrap.css("right"))})})},s.initDragOptions=function(){s.dragOptions={axis:"x",refreshPositions:!0,cancel:""},s.dragSettings={animate:!0,onStart:"timeline.startDrag",onStop:"timeline.stopDrag",onDrag:"timeline.dragging"}},s.initDragOptions(),s.startDrag=function(){s.activePopover&&s.activePopover.popover("hide"),delete s.activePopover,e.cancel(s.resumeTimer),s.$wrap.stop(),s.isDragging=!0,s.scrolling=!1,s.pausing=!0},s.stopDrag=function(){s.isDragging=!1,e.cancel(s.resumeTimer),s.resumeTimer=e(function(){s.pausing=!1},500)},s.dragging=function(e,t){t.position.left=s.limitRange(t.position.left,s.elementWidth-s.wrapWidth-s.offset,0)},s.limitRange=function(e,t,n){return e<t?t:e>n?n:e},s.mouseenter=function(){s.pause()},s.mouseleave=function(){s.isDragging||s.activePopover||(s.resumeTimer=e(function(){s.resume()},200))},s.popover=function(e,t){s.isDragging||s.activePopover&&s.activePopover.is(e.currentTarget)||($(e.currentTarget).popover("show"),$(e.currentTarget).data("bs.popover").$tip.find(".popover-content").html($("#incidentPopoverTemplate").html()),o($(e.currentTarget).data("bs.popover").$tip)(t))},s.popoverHide=function(e){s.activePopover&&s.activePopover.is(e.currentTarget)||$(e.currentTarget).popover("hide")},s.clickIncidentItem=function(t,n){s.activePopover&&s.activePopover.is(t.currentTarget)||e(function(){s.pause(),$(t.currentTarget).popover("show").parent().addClass("active"),$(".popover-timeline .popover-content").html($("#incidentClickPopoverTemplate").html()),o($(".popover-timeline .popover-content"))(n),s.activePopover=$(t.currentTarget)})},s.clickProtocolItem=function(t,o,a){e(function(){s.pause()});var r=n.open({templateUrl:"protocolIncidentsTemplate",controller:["$scope","protocol","time","level",function(e,t,n,o){"ngInject";e.protocol=t,e.time=n,e.level=o,e.cancel=function(){r.dismiss("cancel")}}],resolve:{protocol:function(){return t},time:function(){return o},level:function(){return a}},size:"lg"})},s.moveLeft=function(){s.pause(),s.scrolling=!1,s.$wrap.stop().css({right:"",left:parseInt(s.$wrap.css("left"))}).animate({left:0},500,function(){s.resume()})},s.moveRight=function(){s.pause(),s.scrolling=!0,s.$wrap.stop().css({left:"",right:parseInt(s.$wrap.css("right"))}).animate({right:s.offset},500,function(){s.resume()})},s.noPrev=!0,s.noNext=!0,t.$watch("timeline.activePopover",function(){s.hasSelected=!!s.activePopover,s.noPrev=!(s.activePopover&&s.activePopover.parents(".group").prev().length>0),s.noNext=!(s.activePopover&&s.activePopover.parents(".group").next().length>0)}),s.prev=function(){if(!s.noPrev&&s.activePopover){var e=s.activePopover.parents(".group").prev().find(".bar").eq(s.activePopover.index());s.$wrap.stop().css({right:"",left:parseInt(s.$wrap.css("left"))}).animate({left:parseInt(s.$wrap.css("left"))+s.widthPerMinute/3},200,function(){e.triggerHandler("click")})}},s.next=function(){if(!s.noNext&&s.activePopover){var t=s.activePopover.parents(".group").next().find(".bar").eq(s.activePopover.index());parseInt(s.$wrap.css("left"))<s.elementWidth-s.wrapWidth-s.offset?e(function(){t.triggerHandler("click")}):s.$wrap.stop().css({left:"",right:parseInt(s.$wrap.css("right"))}).animate({right:parseInt(s.$wrap.css("right"))+s.widthPerMinute/3},200,function(){t.triggerHandler("click")})}},s.canPrev=function(){s.activePopover.parent().prev()},s.toggleTimeMode=function(){s.openConfigModal(!0)},s.destroy=function(){s.activePopover&&s.activePopover.popover("hide"),e.cancel(s.renderTimer),$(window).off("resize"),$(window).off("click"),$(window).off("keydown"),_.each(_.keys(s),function(e){"function"!=typeof s[e]&&delete s[e]})},t.$on("$destroy",s.destroy)}}}function o(e){return{restrict:"A",scope:{delayRemoveClass:"@"},link:function(t,n){n.hasClass(t.delayRemoveClass)&&e(function(){n.removeClass(t.delayRemoveClass)})}}}function a(e,t){function n(n,o,a,r){function i(e){return e.$filter="(appLayerProtocol eq '"+n.$parent.protocol.name+"') and (level eq "+n.$parent.level+") and (timestamp ge '"+n.$parent.time.start+"' and timestamp le '"+n.$parent.time.end+"')",t.getIncidents(e)}function l(){return e.resolve(n.protocol.count)}r.setConfig({name:"incident",pagination:!0,scrollable:!1,totalCount:!0,getAll:i,getCount:l}),r.disableSearch=!0}return{scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/incident/timelineIncidentTable.a33da01b.html",link:n}}angular.module("southWest.monitor.incident").directive("incidentTable",["$modal","Incident","$log","FileUploader","URI","topologyId","$rootScope","$state","$timeout","$q",e]).directive("timeline",["$timeout","$window","$modal","$compile","Incident","mOverview",n]).directive("delayRemoveClass",["$timeout",o]).directive("timelineIncidentTable",["$q","Incident",a])}(),function(){"use strict";function e(e){e.state("monitor.logger",{url:"/logger?panel",controller:"LoggerCtrl as logger",templateUrl:"templates/monitor/logger/index.6e0a3607.html",resolve:{state:["$rootScope",function(e){e.currentState="LOG_MANAGEMENT"}]}}).state("monitor.logger.detail",{parent:"dashboard",url:"/monitor/logger/:logName",controller:"LoggerDetailCtrl as loggerDetail",templateUrl:"templates/monitor/logger/detail.a7e0873e.html"})}e.$inject=["$stateProvider"],angular.module("southWest.monitor.logger").config(e)}(),function(){"use strict";function e(){var e=this;e.editRight=!0,e.showImportBtn=!1,e.showExportBtn=!0}function t(e,t,n){var o=this;o.detailLog="LOADING",o.logInfo=JSON.parse(n.getItem("logItem")),t.get(e.logName).then(function(e){o.detailLog=e})}t.$inject=["$stateParams","Logger","localStorage"],angular.module("southWest.monitor.logger").controller("LoggerCtrl",e).controller("LoggerDetailCtrl",t)}(),function(){"use strict";function e(e,t,n,o,a){function r(r,i,l,s){function c(n){return n.$orderby&&""!==n.$orderby?n.$orderby+=", operationLogId desc":n.$orderby="operationLogId desc",r.params=n,t.getAll(n).then(function(n){return n.length?e.all(n).then(function(){var o=n.map(function(e,o){return n[o].timestamp=new Date(n[o].timestamp),"DpiUserCmdLog"===n[o].subServiceType||"DpifwPacketAccounting"===n[o].subServiceType||"DpiUserLogin"===n[o].subServiceType?t.get(n[o].operationLogId,n[o].subServiceType).then(function(t){e.detail=t}):void 0});return e.all(o).then(function(){return n})}):[]})}function d(e){var n=e||{};return t.getCount(n)}function u(e){return c(e)}var p=["user","user_ip","operationName"];s.setConfig({name:"log",pagination:!0,scrollable:!1,totalCount:!0,getAll:c,getCount:d,search:u,fields:p,advancedSearch:"logs",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"user_ip",display:"IP",input:"string",option:!1,value:""},{name:"user",display:"用户",input:"string",option:!1,value:""},{name:"operationName",display:"内容",input:"string",option:!1,value:""}]}),r.openExportPanel=function(e){function i(e,n){e.addPsw="1",e.validatePsw=function(e){return a.validatePsw(e)},e.download=function(e){n.close(),l.$orderby="operationLogId desc",t.getAllExport(l,e).then(function(e){window.open("./"+e,"_self")})},e.cancel=function(){n.dismiss("cancel")}}i.$inject=["$scope","$modalInstance"];var l=e?r.params:{};l.$limit=1e5;var s=n.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:i,size:"sm"});s.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var i={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/logger/logTab.efec54ba.html",link:r};return i}function t(e,t,n,o,a,r,i,l,s,c){function d(d,u,p,f){function m(t){return void 0===f.selectAllValue&&null===f.selectAllValue||(f.selectAllValue=!1,f.selectedItems={}),t.$orderby&&""!==t.$orderby?t.$orderby+=", operationLogId desc":t.$orderby="operationLogId desc",d.params=t,t.$filter=(t.$filter?t.$filter+" and ":"")+"(serviceType eq MW_LOGIN_LOGOUT)",e.getAll(t).then(function(e){return e})}function g(t){var n=t||{};return n.$filter=(n.$filter?n.$filter+" and ":"")+"(serviceType eq MW_LOGIN_LOGOUT)",e.getCount(n)}function h(e){return m(e)}var v=["user","user_ip","operationName"];f.setConfig({name:"log",pagination:!0,scrollable:!1,totalCount:!0,getAll:m,getCount:g,search:h,fields:v,advancedSearch:"logs",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"user_ip",display:"IP",input:"string",option:!1,value:""},{name:"user",display:"用户",input:"string",option:!1,value:""},{name:"operationName",display:"内容",input:"string",option:!1,value:""}]}),d.openImportPanel=function(e){function s(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new o({url:a+"/operationlogs/all/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){r.addAlert({type:"danger",content:"导入日志失败： "+t.error})},e.uploader.onSuccessItem=function(){l(function(){i.reload()},2e3),r.addAlert({type:"success",content:"导入日志成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}s.$inject=["$scope","$modalInstance","extension"];var c=t.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:s,size:"sm",resolve:{extension:function(){return e}}});c.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},d.openExportPanel=function(o){function a(t,n){t.addPsw="1",t.validatePsw=function(e){return c.validatePsw(e)},t.download=function(t){n.close(),r.$filter=(r.$filter?r.$filter+" and ":"")+"(serviceType eq MW_LOGIN_LOGOUT)",r.$orderby="operationLogId desc",e.getAllExport(r,t,"MW_LOGIN").then(function(e){window.open("./"+e,"_self")})},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var r=o?d.params:{};r.$limit=1e5;var i=t.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:a,size:"sm"});i.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},f.selectedItems={},f.selectAll=function(){f.selectedItems={},f.table.forEach(function(e){f.selectedItems[e.operationLogId]=f.selectAllValue})},f.selectItem=function(){var e=!1,t=!0;f.table.forEach(function(n){f.selectedItems[n.operationLogId]?e=!0:t=!1}),e===!0&&t===!1?f.selectAllValue=null:e===!0&&t===!0?f.selectAllValue=!0:f.selectAllValue=!1},d.deleteSelected=function(){var t=f.selectedItems,n=[];if(t)for(var o in t)t[o]&&n.push(o);if(0!==n.length){var a=s.defer();d.deletePromise=a.promise,e.deleteLogPl(n).then(function(){a.resolve("success"),r.addAlert({type:"success",content:"日志删除成功"})},function(e){a.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志删除失败："+e.data:"日志删除失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}else r.addAlert({type:"info",content:"请至少选中一条日志"})},d.markAllDeleted=function(){if(0!==f.table.length){var t=s.defer();d.deletePromise=t.promise,e.clearLogPl().then(function(){t.resolve("success"),r.addAlert({type:"success",content:"日志清空成功"})},function(e){t.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志清空失败："+e.data:"日志清空失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/logger/logplTab.0b2ad149.html",link:d};return u}function n(e,t,n,o,a,r,i,l,s,c){function d(d,u,p,f){function m(t){return void 0===f.selectAllValue&&null===f.selectAllValue||(f.selectAllValue=!1,f.selectedItems={}),t.$orderby&&""!==t.$orderby?t.$orderby+=", operationLogId desc":t.$orderby="operationLogId desc",d.params=t,t.$filter=(t.$filter?t.$filter+" and ":"")+"(serviceType eq MW)",e.getAll(t).then(function(e){return e})}function g(t){var n=t||{};return n.$filter=(n.$filter?n.$filter+" and ":"")+"(serviceType eq MW)",e.getCount(n)}function h(e){return m(e)}var v=["user","user_ip","operationName"];f.setConfig({name:"log",pagination:!0,scrollable:!1,totalCount:!0,getAll:m,getCount:g,search:h,fields:v,advancedSearch:"logs",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"user_ip",display:"IP",input:"string",option:!1,value:""},{name:"user",display:"用户",input:"string",option:!1,value:""},{name:"operationName",display:"内容",input:"string",option:!1,value:""}]}),d.openImportPanel=function(e){function s(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new o({url:a+"/operationlogs/all/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){r.addAlert({type:"danger",content:"导入日志失败： "+t.error})},e.uploader.onSuccessItem=function(){l(function(){i.reload()},2e3),r.addAlert({type:"success",content:"导入日志成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}s.$inject=["$scope","$modalInstance","extension"];var c=t.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:s,size:"sm",resolve:{extension:function(){return e}}});c.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},d.openExportPanel=function(o){function a(t,n){t.addPsw="1",t.validatePsw=function(e){return c.validatePsw(e)},t.download=function(t){n.close(),r.$filter=(r.$filter?r.$filter+" and ":"")+"((serviceType eq MW) or (serviceType eq DPILOG))",r.$orderby="operationLogId desc",e.getAllExport(r,t,"MW_OPER").then(function(e){window.open("./"+e,"_self")})},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var r=o?d.params:{};r.$limit=1e5;var i=t.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:a,size:"sm"});i.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},f.selectedItems={},f.selectAll=function(){f.selectedItems={},f.table.forEach(function(e){f.selectedItems[e.operationLogId]=f.selectAllValue})},f.selectItem=function(){var e=!1,t=!0;f.table.forEach(function(n){f.selectedItems[n.operationLogId]?e=!0:t=!1}),e===!0&&t===!1?f.selectAllValue=null:e===!0&&t===!0?f.selectAllValue=!0:f.selectAllValue=!1},d.deleteSelected=function(){var t=f.selectedItems,n=[];if(t)for(var o in t)t[o]&&n.push(o);if(0!==n.length){var a=s.defer();d.deletePromise=a.promise,e.deleteLogPl(n).then(function(){a.resolve("success"),r.addAlert({type:"success",content:"日志删除成功"})},function(e){a.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志删除失败："+e.data:"日志删除失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}else r.addAlert({type:"info",content:"请至少选中一条日志"})},d.markAllDeleted=function(){if(0!==f.table.length){var t=s.defer();d.deletePromise=t.promise,e.clearLogPf().then(function(){t.resolve("success"),r.addAlert({type:"success",content:"日志清空成功"})},function(e){t.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志清空失败："+e.data:"日志清空失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/logger/logpfTab.4c6ec2ca.html",link:d};return u}function o(e,t,n,o,a,r,i,l,s,c){function d(d,u,p,f){function m(t){return void 0===f.selectAllValue&&null===f.selectAllValue||(f.selectAllValue=!1,f.selectedItems={}),t.$orderby&&""!==t.$orderby?t.$orderby+=", timestamp desc, user":t.$orderby="timestamp desc, user",d.params=t,e.getDPILogs(t,"DpiUserLogin").then(function(e){return e})}function g(t){var n=t||{};return e.getDPILogCount(n,"DpiUserLogin")}function h(e){return m(e)}var v=["user","user_ip","login_result","reason","boxId"];f.setConfig({name:"log",pagination:!0,scrollable:!1,totalCount:!0,getAll:m,getCount:g,search:h,fields:v,advancedSearch:"DpiUserCmd",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"user_ip",display:"IP",input:"string",option:!1,value:""},{name:"user",display:"用户",input:"string",option:!1,value:""},{name:"login_result",display:"登录状态",input:"string",option:!1,value:""},{name:"reason",display:"原因",input:"string",option:!1,value:""},{name:"boxId",display:"序列号",input:"string",option:!1,value:""}]}),d.openImportPanel=function(e){function s(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new o({url:a+"/operationlogs/type/DpiUserLogin/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){r.addAlert({type:"danger",content:"导入日志失败： "+t.error})},e.uploader.onSuccessItem=function(){l(function(){i.reload()},2e3),r.addAlert({type:"success",content:"导入日志成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}s.$inject=["$scope","$modalInstance","extension"];var c=t.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:s,size:"sm",resolve:{extension:function(){return e}}});c.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},d.openExportPanel=function(o){function a(t,n){t.addPsw="1",t.validatePsw=function(e){return c.validatePsw(e)},t.download=function(t){n.close(),r.$orderby="dpiUserLoginId desc",e.getDPILogsExport(r,"DpiUserLogin",t).then(function(e){window.open("./"+e,"_self")})},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var r=o?d.params:{};r.$limit=1e5;var i=t.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:a,size:"sm"});i.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},f.selectedItems={},f.selectAll=function(){f.selectedItems={},f.table.forEach(function(e){f.selectedItems[e.dpiUserLoginId]=f.selectAllValue})},f.selectItem=function(){var e=!1,t=!0;f.table.forEach(function(n){f.selectedItems[n.dpiUserLoginId]?e=!0:t=!1}),e===!0&&t===!1?f.selectAllValue=null:e===!0&&t===!0?f.selectAllValue=!0:f.selectAllValue=!1},d.deleteSelected=function(){var t=f.selectedItems,n=[];if(t)for(var o in t)t[o]&&n.push(o);if(0!==n.length){var a=s.defer();d.deletePromise=a.promise,e.deleteLogDl(n).then(function(){a.resolve("success"),r.addAlert({type:"success",content:"日志删除成功"})},function(e){a.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志删除失败："+e.data:"日志删除失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}else r.addAlert({type:"info",content:"请至少选中一条日志"})},d.markAllDeleted=function(){if(0!==f.table.length){var t=s.defer();d.deletePromise=t.promise,e.clearLogDl().then(function(){t.resolve("success"),r.addAlert({type:"success",content:"日志清空成功"})},function(e){t.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志清空失败："+e.data:"日志清空失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/logger/logdlTab.8cb7e156.html",link:d};return u}function a(e,t,n,o,a,r,i,l,s,c){function d(d,u,p,f){function m(t){return void 0===f.selectAllValue&&null===f.selectAllValue||(f.selectAllValue=!1,f.selectedItems={}),t.$orderby&&""!==t.$orderby?t.$orderby+=", timestamp desc, cmd, boxId":t.$orderby="timestamp desc, cmd, boxId",d.params=t,e.getDPILogs(t,"DpiUserCmdLog").then(function(e){return e})}function g(t){var n=t||{};return e.getDPILogCount(n,"DpiUserCmdLog")}function h(e){return m(e)}var v=["user","user_ip","cmd","cmd_result","boxId"];f.setConfig({name:"log",pagination:!0,scrollable:!1,totalCount:!0,getAll:m,getCount:g,search:h,fields:v,advancedSearch:"DpiUserCmd",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"user_ip",display:"IP",input:"string",option:!1,value:""},{name:"user",display:"用户",input:"string",option:!1,value:""},{name:"cmd",display:"输入命令",input:"string",option:!1,value:""},{name:"cmd_result",display:"执行结果",input:"string",option:!1,value:""},{name:"boxId",display:"序列号",input:"string",option:!1,value:""}]}),d.openImportPanel=function(e){function s(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new o({url:a+"/operationlogs/type/DpiUserCmdLog/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){r.addAlert({type:"danger",content:"导入日志失败： "+t.error})},e.uploader.onSuccessItem=function(){l(function(){i.reload()},2e3),r.addAlert({type:"success",content:"导入日志成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}s.$inject=["$scope","$modalInstance","extension"];var c=t.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:s,size:"sm",resolve:{extension:function(){return e}}});c.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},d.openExportPanel=function(o){function a(t,n){t.addPsw="1",t.validatePsw=function(e){return c.validatePsw(e)},t.download=function(t){n.close(),r.$orderby="dpiUserCmdLogId desc",e.getDPILogsExport(r,"DpiUserCmdLog",t).then(function(e){window.open("./"+e,"_self")})},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var r=o?d.params:{};r.$limit=1e5;var i=t.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:a,size:"sm"});i.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},f.selectedItems={},f.selectAll=function(){f.selectedItems={},f.table.forEach(function(e){f.selectedItems[e.dpiUserCmdLogId]=f.selectAllValue})},f.selectItem=function(){var e=!1,t=!0;f.table.forEach(function(n){f.selectedItems[n.dpiUserCmdLogId]?e=!0:t=!1}),e===!0&&t===!1?f.selectAllValue=null:e===!0&&t===!0?f.selectAllValue=!0:f.selectAllValue=!1},d.deleteSelected=function(){var t=f.selectedItems,n=[];if(t)for(var o in t)t[o]&&n.push(o);if(0!==n.length){var a=s.defer();d.deletePromise=a.promise,e.deleteLogDc(n).then(function(){a.resolve("success"),r.addAlert({type:"success",content:"日志删除成功"})},function(e){a.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志删除失败："+e.data:"日志删除失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}else r.addAlert({type:"info",content:"请至少选中一条日志"})},d.markAllDeleted=function(){if(0!==f.table.length){var t=s.defer();d.deletePromise=t.promise,e.clearLogDc().then(function(){t.resolve("success"),r.addAlert({type:"success",content:"日志清空成功"})},function(e){t.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志清空失败："+e.data:"日志清空失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/logger/logdcTab.a0f0fed3.html",link:d};return u}function r(e,t,n,o,a,r,i,l,s,c){function d(d,u,p,f){function m(t){return void 0===f.selectAllValue&&null===f.selectAllValue||(f.selectAllValue=!1,f.selectedItems={}),t.$orderby&&""!==t.$orderby||(t.$orderby="fwFlowdataId desc"),d.params=t,e.getDPILogs(t,"DpifwPacketAccounting").then(function(e){return e})}function g(t){var n=t||{};return e.getDPILogCount(n,"DpifwPacketAccounting")}function h(e){return m(e)}var v=["sourceIp","sourceMac","sourcePort","destinationIp","destinationMac","destinationPort","ipVersion","protocolTypeName","result","policyName"];f.setConfig({name:"log",pagination:!0,scrollable:!1,totalCount:!0,getAll:m,getCount:g,search:h,fields:v,advancedSearch:"DpiUserCmd",advancedSearchOptions:[{name:"packetTimestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"sourceIp",display:"源IP地址",input:"string",option:!1,value:""},{name:"sourceMac",display:"源MAC地址",input:"string",option:!1,value:""},{name:"sourcePort",display:"源端口",input:"string",option:!1,value:""},{name:"destinationIp",display:"目标IP地址",input:"string",
option:!1,value:""},{name:"destinationMac",display:"目标MAC地址",input:"string",option:!1,value:""},{name:"destinationPort",display:"目标端口",input:"string",option:!1,value:""},{name:"ipVersion",display:"IP版本",input:"string",option:!1,value:""},{name:"protocolTypeName",display:"协议类型",input:"string",option:!1,value:""},{name:"result",display:"动作",input:"string",option:!1,value:""},{name:"policyName",display:"策略",input:"string",option:!1,value:""}]}),d.openImportPanel=function(e){function s(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new o({url:a+"/operationlogs/type/DpifwPacketAccounting/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){r.addAlert({type:"danger",content:"导入日志失败： "+t.error})},e.uploader.onSuccessItem=function(){l(function(){i.reload()},2e3),r.addAlert({type:"success",content:"导入日志成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}s.$inject=["$scope","$modalInstance","extension"];var c=t.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:s,size:"sm",resolve:{extension:function(){return e}}});c.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},d.openExportPanel=function(o){function a(t,n){t.addPsw="1",t.validatePsw=function(e){return c.validatePsw(e)},t.download=function(t){n.close(),r.$orderby="fwFlowdataId desc",e.getDPILogsExport(r,"DpifwPacketAccounting",t).then(function(e){window.open("./"+e,"_self")})},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var r=o?d.params:{};r.$limit=1e5;var i=t.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:a,size:"sm"});i.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})},f.selectedItems={},f.selectAll=function(){f.selectedItems={},f.table.forEach(function(e){f.selectedItems[e.fwFlowdataId]=f.selectAllValue})},f.selectItem=function(){var e=!1,t=!0;f.table.forEach(function(n){f.selectedItems[n.fwFlowdataId]?e=!0:t=!1}),e===!0&&t===!1?f.selectAllValue=null:e===!0&&t===!0?f.selectAllValue=!0:f.selectAllValue=!1},d.deleteSelected=function(){var t=f.selectedItems,n=[];if(t)for(var o in t)t[o]&&n.push(o);if(0!==n.length){var a=s.defer();f.deletePromise=a.promise,e.deleteLogDf(n).then(function(){a.resolve("success"),r.addAlert({type:"success",content:"日志删除成功"})},function(e){a.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志删除失败："+e.data:"日志删除失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}else r.addAlert({type:"info",content:"请至少选中一条日志"})},d.markAllDeleted=function(){if(0!==f.table.length){var t=s.defer();d.deletePromise=t.promise,e.clearLogDf().then(function(){t.resolve("success"),r.addAlert({type:"success",content:"日志清空成功"})},function(e){t.resolve("fail"),r.addAlert({type:"danger",content:e.data?"日志清空失败："+e.data:"日志清空失败"})}).finally(function(){f.selectAllValue=!1,d.$parent.dtable.refresh()})}}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/logger/logdfTab.76b935b5.html",link:d};return u}function i(e,t,n,o,a,r,i,l,s,c,d){function u(u,p,f,m){function g(e){void 0===m.selectAllValue&&null===m.selectAllValue||(m.selectAllValue=!1,m.selectedItems={}),e.$orderby&&""!==e.$orderby||(e.$orderby="eventId desc"),u.params=e;var n=e||{};return n.$filter=(n.$filter?n.$filter+" and ":"")+"level ne INFO",t.getAll(n).then(function(e){if(0===I.length)return e;var t=I.slice();return e.map(function(e){for(var n=0;n<t.length;n++)if(t[n]===e.eventId)return e.checkbox=!0,t.splice(n,1),e;return e})})}function h(e){return t.search().then(function(t){if(t&&t.length){e.$filter="("+e.$filter;for(var n=0;n<t.length;n++){var o=t[n].typeName.lastIndexOf(".");e.$filter+=" or "+t[n].typeName.slice(++o,++o).toLowerCase()+t[n].typeName.slice(o)+" eq "+t[n].stringValue}e.$filter+=")"}})}function v(e){return h(e).then(function(){return t.getCount(e)})}function y(e){return e.$orderby&&""!==e.$orderby||(e.$orderby="eventId desc"),h(e).then(function(){return u.params=e,t.getAll(e)})}var I=[],D=["sourceName","content"],T=[{text:"所有日志类型",value:"-1"},{text:"设备状态",value:"DPI_ON_OFF"},{text:"接口状态",value:"IF_UP_DOWN"},{text:"BYPASS",value:"DPI_BYPASS"},{text:"RAID状态",value:"RAID_STATUS"},{text:"系统自检测",value:"SYSTEM_CHECK"},{text:"开机自检",value:"SELFTEST_RESULT"},{text:"分区告警",value:"PARTITION_WARNING"},{text:"关键进程",value:"SYS_EVENT"},{text:"平台系统事件",value:"MW_EVENT"}];m.searchBar=function(e){m.query=e,m.currentPage=1,m.getTableData()},m.doAdvancedSearch=function(){m.query="",m.advancedSearchApply(),m.isSearching=m.advancedSearchQuery},m.setConfig({name:"log",pagination:!0,scrollable:!1,totalCount:!0,getAll:g,getCount:v,search:y,fields:D,predicate:"eventId",reverse:!0,advancedSearch:"events",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"level",display:"日志等级",input:"checkbox",option:!0,value:-1,options:[{value:"-1",text:"信息和警告"},{value:"WARN",text:"警告"},{value:"INFO",text:"信息"}]},{name:"sysEventType",display:"日志类型",input:"checkbox",option:!0,value:-1,options:T},{name:"sourceName",display:"设备",input:"string",option:!1,value:""},{name:"content",display:"内容",input:"string",option:!1,value:""}]}),u.openImportPanel=function(t){function n(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new a({url:r+"/events/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){i.addAlert({type:"danger",content:"导入系统日志失败： "+t.error})},e.uploader.onSuccessItem=function(){s(function(){l.reload()},2e3),i.addAlert({type:"success",content:"导入系统日志成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","extension"];var c=e.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:n,size:"sm",resolve:{extension:function(){return t}}});c.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},u.openExportPanel=function(n){function a(e,n){e.addPsw="1",e.validatePsw=function(e){return d.validatePsw(e)},e.download=function(e){n.close(),t.getAllExport(r,e).then(function(e){window.open("./"+e,"_self")})},e.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var r=n?u.params:{};r.$limit=1e5;var i=e.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:a,size:"sm"});i.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},m.selectedItems={},m.selectAll=function(){m.selectedItems={},m.table.forEach(function(e){m.selectedItems[e.eventId]=m.selectAllValue})},m.selectItem=function(){var e=!1,t=!0;m.table.forEach(function(n){m.selectedItems[n.eventId]?e=!0:t=!1}),e===!0&&t===!1?m.selectAllValue=null:e===!0&&t===!0?m.selectAllValue=!0:m.selectAllValue=!1},u.deleteSelected=function(){var e=m.selectedItems,t=[];if(e)for(var o in e)e[o]&&t.push(o);if(0!==t.length){var a=c.defer();m.deletePromise=a.promise,n.deleteEvent(t).then(function(){a.resolve("success"),i.addAlert({type:"success",content:"日志删除成功"})},function(e){a.resolve("fail"),i.addAlert({type:"danger",content:e.data?"日志删除失败："+e.data:"日志删除失败"})}).finally(function(){m.selectAllValue=!1,u.$parent.dtable.refresh()})}else i.addAlert({type:"info",content:"请至少选中一条日志"})},u.markAllDeleted=function(){if(0!==m.table.length){var e=c.defer();u.deletePromise=e.promise,n.clearEvents().then(function(){e.resolve("success"),i.addAlert({type:"success",content:"日志清空成功"})},function(t){e.resolve("fail"),i.addAlert({type:"danger",content:t.data?"日志清空失败："+t.data:"日志清空失败"})}).finally(function(){m.selectAllValue=!1,u.$parent.dtable.refresh()})}}}var p={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/event/eventTable.38ddac7d.html",link:u};return p}function l(){function e(){}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/monitor/logger/bookmarkTab.81618ba7.html",link:e};return t}function s(){function e(e,t){if("undefined"!=typeof e.screenshotCanvas){var n=e.screenshotCanvas.toDataURL(),o=t.find("#sc-canvas"),a=o[0].getContext("2d"),r=new Image;r.onload=function(){a.drawImage(r,0,0,o[0].width,o[0].height)},r.src=n}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/monitor/logger/screenshotTab.2fe8c526.html",link:e};return t}e.$inject=["$q","Logger","$modal","$log","formatVal"],t.$inject=["Logger","$modal","$log","FileUploader","URI","$rootScope","$state","$timeout","$q","formatVal"],n.$inject=["Logger","$modal","$log","FileUploader","URI","$rootScope","$state","$timeout","$q","formatVal"],o.$inject=["Logger","$modal","$log","FileUploader","URI","$rootScope","$state","$timeout","$q","formatVal"],a.$inject=["Logger","$modal","$log","FileUploader","URI","$rootScope","$state","$timeout","$q","formatVal"],r.$inject=["Logger","$modal","$log","FileUploader","URI","$rootScope","$state","$timeout","$q","formatVal"],i.$inject=["$modal","Event","Logger","$log","FileUploader","URI","$rootScope","$state","$timeout","$q","formatVal"],angular.module("southWest.monitor.logger").directive("logTab",e).directive("logplTab",t).directive("logpfTab",n).directive("logdlTab",o).directive("logdcTab",a).directive("logdfTab",r).directive("bookmarkTab",l).directive("screenshotTab",s).directive("eventTable",i)}(),function(){"use strict";function e(e){e.state("monitor",{abstract:!0,parent:"dashboard",url:"/monitor",controller:"MonitorCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html"})}e.$inject=["$stateProvider"],angular.module("southWest.monitor").config(e)}(),function(){"use strict";function e(e,t,n){var o=this;o.prefixId="monitor",o.subMenus=n.rootMenu.getChild("MONITOR"),o.expanded="true"===t.getItem("monitor:navbar:expanded"),o.toggleExpand=function(){o.expanded=!o.expanded,t.setItem("monitor:navbar:expanded",o.expanded)},o.isActive=function(t){return e.current.name.indexOf(t.getState())>-1}}function t(e){var t=this;t.activatePanel=function(e,n){n>=0?t.active=e+n:t.active=e},t.isActive=function(e,n){return n>=0?t.active===e+n:t.active===e},t.returnPanel=function(e,t){return e+t},e.params.panel&&t.activatePanel(e.params.panel),t.activateTab=function(e){t.activeTab=e},t.isActiveTab=function(e){return t.activeTab===e},e.params.tab?t.activateTab(e.params.tab):t.activateTab("learning"),t.activateView=function(e){t.activeView=e},t.isActiveView=function(e){return t.activeView===e},t.activeBtn=function(e,n){n>=0?t.actBtn===e+n?t.actBtn="":t.actBtn=e+n:t.actBtn=e},t.isActiveBtn=function(e,n){return n>=0?t.actBtn===e+n:t.actBtn===e}}e.$inject=["$state","localStorage","$rootScope"],t.$inject=["$state"],angular.module("southWest.monitor").controller("MonitorCtrl",e).controller("TabCtrl",t)}(),function(){"use strict";function e(e){e.state("monitor.overview",{url:"/overview",controller:"OverviewCtrl as overview",templateUrl:"templates/monitor/overview/index.e77b4066.html"})}e.$inject=["$stateProvider"],angular.module("southWest.monitor.overview").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s){function c(e){return 24*parseInt(e.days)*3600*1e3+3600*parseInt(e.hours)*1e3+60*parseInt(e.minutes)*1e3}function d(e){for(var t=0,n=["Kbps","Mbps","Gbps","Tbps"];e>=1024;)e/=1024,t++;return n[t]}function u(e,t){return e.map(function(e){return _.extend({},e,{flowIn:p(e.flowIn,t),flowOut:p(e.flowOut,t)})})}function p(e,t){var n=["Kbps","Mbps","Gbps","Tbps"],o=n.indexOf(t);return parseFloat((e/Math.pow(1024,o)).toFixed(2))}var f=this;f.getETHList$=l.Observable.fromPromise(n.getETHList()),f.systemUsage$$=l.Observable.timer(0,5e3).flatMap(function(){return l.Observable.fromPromise(n.getSystemUsage())}).multicast(new l.Subject),f.systemUsage__=f.systemUsage$$.connect(),f.systemUsage_=f.systemUsage$$.subscribe(function(e){f.CPU=parseInt(e.cpu.toFixed(0)),f.memory=parseInt(e.memory.toFixed(0)),f.storage=parseInt(e.storage.toFixed(0)),f.memoryFree=e.memoryFree,f.partitionFree=e.partitionFree,void 0===f.uptime&&e.uptime&&(f.uptime=c(e.uptime)),f.ETHList&&f.ETHList.forEach(function(t){t.status=e.ethernet&&e.ethernet[t.name]})}),n.getCurtime().then(function(e){f.time=new Date(e)}),f.manualRefreshOfUnreadCount=!1,f.shouldFlashUnreadCount=!1,f.shouldFlash=!1,f.getUnreadCount=function(){a.all([r.getUnreadIncidentCount(),r.getUnreadStrategyCount()]).then(function(e){f.unreadCount=e[0]+e[1],f.unreadCount>1e6?f.manualRefreshOfUnreadCount=!0:f.manualRefreshOfUnreadCount=!1})},f.getUnreadCount(),r.getHistoryIncidentCount().then(function(e){f.historyCount=e}),i.getSignatureDeployedCount().then(function(e){f.signatureCount=e.data.statsValue}),e.$on("newIncidentInsert",function(){f.shouldFlashUnreadCount=f.manualRefreshOfUnreadCount}),f.chartAreaConfig={},f.ETHList_=l.Observable.combineLatest(f.getETHList$,f.systemUsage$$,function(e,t){return[e,t]}).subscribe(function(e){var t=2;f.ETHList?_.each(f.ETHList,function(t){t.status=e[1].ethernet&&e[1].ethernet[t.name]}):f.ETHList=_.map(e[0],function(n){return{name:n,checked:e[1].ethernet&&"down"!==e[1].ethernet[n]&&t-- >0,status:e[1].ethernet&&e[1].ethernet[n]}})}),e.$watch("overview.ETHFrequency",_.debounce(function(e){f.ETHFrequencyObj=_.find(f.ETHFrequencyList,{value:e})},200)),f.ETHFrequencyObj$=s(e,"overview.ETHFrequencyObj",!0).filter(function(e){return e.newValue}).map(function(e){return e.newValue}),f.ETHList$=s(e,"overview.ETHList",!0).filter(function(e){function t(e){return e.filter(function(e){return e.checked}).map(function(e){return e.name})}var n=t(e.newValue||[]),o=t(e.oldValue||[]),a=n.some(function(e){return o.indexOf(e)<0});return e.newValue&&a}).debounce(200).map(function(e){return e.newValue}),f.ETHData$=f.ETHFrequencyObj$.combineLatest(f.ETHList$,function(e,t){return[t,e]}).filter(function(e){return e[0]&&e[1]}).flatMap(function(e){f.loadingDefer&&f.loadingDefer.resolve(),f.loadingDefer=a.defer(),f.loadingPromise=f.loadingDefer.promise,f.pauser$$&&f.pauser$$.onNext(!0),f.pauser$$=new l.Subject;var r;return"mon"!==e[1].value&&(r=l.Observable.interval(e[1].time).flatMap(function(){return l.Observable.fromPromise(n.getETHData(e[0],1,e[1]).catch(function(){return[]}))}).takeUntil(f.pauser$$)),l.Observable.fromPromise(n.getETHData(e[0],30,e[1]).catch(function(){return{}})).merge(r||l.Observable.empty()).filter(function(e){return f.loadingDefer&&f.loadingDefer.resolve(),!_.isEmpty(e)}).map(function(e,n){0===n?f.chartAreaConfig=_.mapValues(e,function(e){var t=d(_.max(_.flatten(e.map(function(e){return[e.flowIn,e.flowOut]})))),n=o.createAreaChartConfig(u(e,t),f.ETHFrequencyObj.title,t);return n.categories=e.map(function(e){return e.originTime}),n.unit=t,n}):_.forIn(f.chartAreaConfig,function(n,o){var a=e[o].filter(function(e){return moment(e.originTime)-moment(_.last(n.categories))>2e3});a=u(a,n.unit),a.length&&n.getHighcharts&&n.getHighcharts().options&&a.forEach(function(e){t(function(){n.newPoint=[[e.x,e.flowIn],[e.x,e.flowOut]],n.categories.shift(),n.categories.push(e.originTime)})})})})}),f.ETHData_=f.ETHData$.subscribe(),f.ETHFrequencyList=[{name:"5秒钟",value:"sec",time:5e3,title:"过去150秒流量统计",unit:"Kbps",format:"mm:ss"},{name:"1分钟",value:"min",time:6e4,title:"过去30分钟流量统计",unit:"Kbps",format:"HH:mm"},{name:"1天",value:"day",time:864e5,title:"过去30天流量统计",unit:"Mbps",format:"MM-DD"},{name:"1月",value:"mon",time:2592e6,title:"过去30个月流量统计",unit:"Gbps",format:"YY-MM"}],f.ETHFrequency="sec",e.$on("$destroy",function(){f.systemUsage$$.observers&&f.systemUsage$$.observers.forEach(function(e){e.dispose()}),f.ETHList_.dispose(),f.systemUsage_.dispose(),f.systemUsage__.dispose(),f.ETHData_.dispose(),f.pauser$$&&f.pauser$$.onNext(!0)})}e.$inject=["$scope","$timeout","mOverview","HCConfig","$q","Incident","Dashboard","rx","observeOnScope"],angular.module("southWest.monitor.overview").controller("OverviewCtrl",e)}(),function(){"use strict";function e(){var e={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/monitor/overview/ovHeader.c3d6b911.html",controller:["$timeout","$window","$scope","$state","mOverview","Incident",function(e,t,n,o,a,r){"ngInject";function i(e,t){return{chart:{type:"pie",backgroundColor:"transparent",options3d:{enabled:!0,alpha:45},marginTop:-10,spacingTop:0},title:{text:""},subtitle:{text:""},plotOptions:{pie:{innerSize:50,size:105,depth:30,colors:["#2c97de","#2dbda8","#84b547","#e76d3b","#cc3e4a"],dataLabels:{color:"#aaa",connectorColor:"#aaa",style:{fontSize:"11px",fontWeight:"bold",textShadow:"none"},format:"{point.name}<br>{y}条",distance:5,connectorPadding:5},tooltip:{headerFormat:"",pointFormatter:function(){return'<span style="color:'+this.color+'">●</span>'+this.name+": <b>"+this.y+"条</b><br/><span>占比：<b>"+(this.y/this.total*100).toFixed(2)+"%</b></span>"}},events:{click:function(e){o.go(t[e.point.name])}}}},series:e}}var l;n.$on("newIncidentInsert",function(){n.shouldFlashTodayCount=!0}),n.getTodayCount=function(){r.getTodayIncidentCount().then(function(e){n.todayCount=e})},n.getTodayCount(),n.initIncidentChart=function(){a.getIncidentData(moment().startOf("day").utc().format()).then(function(e){e&&e.length&&document.getElementById("incident-chart")?(l=echarts.init(document.getElementById("incident-chart")),l.setOption({grid:{left:"5%",right:"5%",bottom:"5%",top:"5%",containLabel:!0},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},xAxis:{axisLabel:{textStyle:{color:"#999"}},axisTick:{show:!1},axisLine:{show:!1},type:"value",z:10},yAxis:{axisLabel:{textStyle:{color:"#999"}},type:"category",data:_.map(e,function(e){return e.name})},series:[{name:"事件数",type:"bar",itemStyle:{normal:{color:function(e){return["#2c97de","#2dbda8","#84b547","#e76d3b","#cc3e4a"].reverse()[e.dataIndex]}}},data:_.map(e,function(e){return e.num}),animationDelay:function(e){return 200*e}}],animationEasing:"ease",animationDelayUpdate:function(e){return 100*e}})):$("#incident-chart").html("没有数据")})},n.refreshIncidentBoard=function(){n.getTodayCount(),n.initIncidentChart()},n.initRuleChart=function(){a.getRuleData().then(function(e){n.overview.ruleCount=_(e).map(function(e){return e.num}).reduce(function(e,t){return e+t},0);var t=i([{name:"规则类别",data:_.map(e,function(e){return[e.name,e.num]})}],{"白名单规则":"rule.whitelist_manager","黑名单规则":"rule.blacklist","IPMAC规则":"rule.ipmac"});$("#rule-chart").highcharts(t)})},n.initStrategyChart=function(){a.getStrategyData().then(function(e){n.overview.strategyDeployCount=_(e).map(function(e){return e.num}).reduce(function(e,t){return e+t},0);var t=i([{name:"策略类别",data:_.map(e,function(e){return[e.name,e.num]})}],{"安全策略":"strategy.security","SNAT策略":"strategy.nat_snat","DNAT策略":"strategy.nat_dnat","会话策略":"strategy.session"});$("#strategy-chart").highcharts(t)})},angular.element(t).bind("resize",function(){l&&l.resize()}),n.$on("$destroy",function(){angular.element(t).unbind("resize")})}]};return e}function t(){var e={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/monitor/overview/ovIncidence.439420e1.html",controller:["$timeout","$window","$scope","$state","SessionStateModel","apiInfo","$interval",function(e,t,n,o,a,r,i){"ngInject";function l(){r.sysbaseinfo().then(function(e){n.sessionTrend||(n.sessionTrend=echarts.init(document.getElementById("session_trend")),n.sessionTrend.setOption(c));var t=n.sessionTrend,o=t.getOption(),r=new Date(e.data||""),i=60,l=o.series[0].data,d=l.length<1?new Date(r.getTime()-1e3*i):new Date(new Date(l[l.length-1][0]).getTime()+1e3);r=r.getTime()-d.getTime()>1e3*i?new Date(d.getTime()+1e3*i):r,a.getSessionCount(d,r).then(function(e){if(e&&e.length>0){n.noSessionData=!1,l.length+e.length>=i&&l.splice(0,l.length+e.length-i),e.forEach(function(e){l.push(e)});var o=l[l.length-1][0],a=l[0][0];t.setOption({xAxis:{max:o,min:a},series:[{data:l}]}),s.sessionCount=e[e.length-1][1]}else n.noSessionData=!0,s.sessionCount=0})})}var s=n.overview,c={tooltip:{trigger:"axis",position:"right",formatter:function(e){return e.length&&e[0].value?"时间："+moment(e[0].value[0]).format("YYYY-MM-DD HH:mm:ss")+"<br>会话数量："+e[0].value[1]:""},padding:10,backgroundColor:"#000",textStyle:{color:"#fff"}},color:["#64f035"],grid:{left:"1%",right:"1%",bottom:"1%",top:"1%",containLabel:!1},xAxis:[{type:"time",boundaryGap:!1,interval:1e3,axisLine:{show:!0,lineStyle:{color:"#283754",opacity:1,width:2}},axisTick:!1,splitLine:{show:!0,lineStyle:{color:"#144d94",opacity:.1}}}],yAxis:[{type:"value",interval:1e3,axisLine:{show:!0,lineStyle:{color:"#283754",opacity:1,width:2}},axisTick:!1,splitLine:{show:!0,lineStyle:{color:"#144d94",opacity:.1}}}],series:[{type:"line",animation:!1,lineStyle:{color:"#64f035"},areaStyle:{normal:{color:"#64f035",opacity:.2}},data:[]}]};n.initSessionTrend=function(){l();var e=5e3;s.sessionInterval=i(l,e)},s.navigate=function(e){o.go(e)},angular.element(t).bind("resize",function(){n.sessionTrend.resize()}),n.$on("$destroy",function(){angular.element(t).unbind("resize"),angular.isDefined(s.sessionInterval)&&i.cancel(s.sessionInterval)})}]};return e}function n(){function e(){}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/monitor/overview/ovEvent.5744ee88.html",link:e};return t}function o(e){return{scope:{percent:"=",name:"@",surplus:"=?"},restrict:"E",replace:!0,templateUrl:"/templates/monitor/overview/circleMeter.50f44ab2.html",link:function(t){function n(t,n,a){var r=(new Date).getTime(),i=e(function(){var l=(new Date).getTime()-r;l>a?(o(n),e.cancel(i)):o(Math.round(l/a*(n-t)+t))},33.3)}function o(e){t.displayPercent=e,t.deg=e/100*360;var n=a-t.deg,o=r+l*Math.cos(n*Math.PI/180),d=i-l*Math.sin(n*Math.PI/180);e<100?t.d="M "+r+","+i+" L "+o+","+d+" A "+l+","+l+" 0 1,0 "+s+","+c+" Z":t.d="M0 0 H 140 V 140 H 0 L 0 0"}var a=270,r=66,i=66,l=66,s=r+l*Math.cos(a*Math.PI/180),c=i-l*Math.sin(a*Math.PI/180);o(t.percent||0),t.$watch("percent",function(e,t){e!==t&&(t=t||0,e=e||0,n(t,e,300))})}}}function a(){return{restrict:"A",scope:{manualFetch:"=",fetchAction:"&",blink:"@"},link:function(e,t){e.$watch("manualFetch",function(n){t[{true:"addClass",false:"removeClass"}[!!n]](e.blink||"blink")}),t.on("click",function(){e.manualFetch===!0&&(e.manualFetch=!1),e.fetchAction()})}}}function r(e){return{restrict:"E",scope:{time:"=",uptime:"=",size:"@"},replace:!0,templateUrl:"/templates/monitor/overview/systemTime.f15396f2.html",link:function(t,n){function o(t,n){d=t?new Date(t).getTime()-(new Date).getTime():0,u=new Date(n||0).getTime()-(new Date).getTime(),e.cancel(p),r(),p=e(r,40)}function a(e){var t=Math.PI/180;return e*t}function r(){var e=new Date((new Date).getTime()+d),n=moment.duration((new Date).getTime()+u);t.timeString=moment(e).format("YYYY年MM月DD日<br>HH:mm:ss"),t.uptimeString=Math.floor(n.asDays())+"天"+n.hours()+"小时"+n.minutes()+"分";var o=e.getHours(),r=e.getMinutes(),i=e.getSeconds(),c=e.getMilliseconds(),p=i+c/1e3,f=r+p/60;l=s.createRadialGradient(t.size/2,t.size/2,5,t.size/2,t.size/2,.6*t.size),l.addColorStop(0,"#21232e"),l.addColorStop(1,"#0f1015"),s.fillStyle=l,s.fillRect(0,0,t.size,t.size),s.beginPath(),s.arc(t.size/2,t.size/2,.44*t.size,a(270),a(30*o-90)),s.stroke(),s.beginPath(),s.arc(t.size/2,t.size/2,.41*t.size,a(270),a(6*f-90)),s.stroke(),s.beginPath(),s.arc(t.size/2,t.size/2,.38*t.size,a(270),a(6*p-90)),s.stroke()}t.size=parseInt(t.size||500);var i=n.find("canvas");i.attr("width",t.size).attr("height",t.size);var l,s=i[0].getContext("2d"),c="#3bace7";s.strokeStyle=c,s.lineWidth=1.5,s.shadowColor="#484d66";var d,u,p;t.$watch("[time, uptime]",function(e){o.apply(null,e)}),t.$on("$destroy",function(){e.cancel(p)})}}}function i(){return{scope:!0,restrict:"E",replace:!0,templateUrl:"/templates/monitor/overview/errorIncident.6f5e2732.html",link:function(e){e.addIncident=function(t){e.incidentList.unshift(t),e.incidentList.length>4&&e.incidentList.pop()}},controller:["$scope","mOverview","$state",function(e,t,n){"ngInject";e.incidentList=[],e.goToIncidentState=function(){n.go("monitor.incident")},e.$on("newIncidentInsert",function(t,n){e.addIncident(n)}),t.getErrorIncidents(4).then(function(t){t.forEach(function(t){e.addIncident(t)})})}]}}o.$inject=["$interval"],r.$inject=["$interval"],angular.module("southWest.monitor.overview").directive("ovHeader",e).directive("ovEvent",n).directive("ovIncidence",t).directive("circleMeter",o).directive("manualFetch",a).directive("systemTime",r).directive("errorIncident",i)}(),function(){"use strict";function e(e){e.state("monitor.report_event",{parent:"monitor",url:"/report/event",controller:"ReportEventCtrl as revent",templateUrl:"templates/monitor/report/event/index.6989b1bc.html"})}e.$inject=["$stateProvider"],angular.module("southWest.monitor.report_event").config(e)}(),function(){"use strict";function e(e,t,n,o){function a(e,t,n,o,a){var r,i,l,s,c,d,u,p,f=[0,0,0],m=[0,0,0];switch(t){case"level":switch(n){case"d":r=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.map(function(e){switch(e.subType){case 1:i[e.timeInterval]=i[e.timeInterval]+e.count,f[0]=f[0]+e.count;break;case 2:l[e.timeInterval]=l[e.timeInterval]+e.count,f[1]=f[1]+e.count;break;case 3:s[e.timeInterval]=s[e.timeInterval]+e.count,f[2]=f[2]+e.count}0!==e.subType&&(p[e.timeInterval]=p[e.timeInterval]+e.count)});break;case"w":r=[];var g=[];i=[0,0,0,0,0,0,0],l=[0,0,0,0,0,0,0],s=[0,0,0,0,0,0,0],p=[0,0,0,0,0,0,0];for(var h=new Date(o),v=0;v<7;v++){var y=h.getFullYear(),I=h.getMonth(),D=h.getDate();r.push(y+"-"+I+"-"+D),g.push(D),h.setDate(h.getDate()+1)}e.map(function(e){for(var t=0;t<g.length;t++)if(e.timeInterval===g[t]){switch(e.subType){case 1:i[t]=i[t]+e.count,f[0]=f[0]+e.count;break;case 2:l[t]=l[t]+e.count,f[1]=f[1]+e.count;break;case 3:s[t]=s[t]+e.count,f[2]=f[2]+e.count}0!==e.subType&&(p[t]=p[t]+e.count)}});break;case"m":r=[],i=[],l=[],s=[],p=[];for(var T=!1,b=new Date(o),S=new Date(a);!T;){var P=b.getFullYear(),A=b.getMonth()+1,C=b.getDate();r.push(P+"-"+A+"-"+C),i.push(0),l.push(0),s.push(0),p.push(0),b.setDate(b.getDate()+1),b>=S&&(T=!0)}e.map(function(e){switch(e.subType){case 1:i[e.timeInterval-1]=i[e.timeInterval-1]+e.count,f[0]=f[0]+e.count;break;case 2:l[e.timeInterval-1]=l[e.timeInterval-1]+e.count,f[1]=f[1]+e.count;break;case 3:s[e.timeInterval-1]=s[e.timeInterval-1]+e.count,f[2]=f[2]+e.count}0!==e.subType&&(p[e.timeInterval-1]=p[e.timeInterval-1]+e.count)})}break;case"risk":switch(n){case"d":r=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],p=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.map(function(e){switch(e.subType){case 0:c[e.timeInterval]=c[e.timeInterval]+e.count,m[0]=m[0]+e.count;break;case 1:d[e.timeInterval]=d[e.timeInterval]+e.count,m[1]=m[1]+e.count;break;case 2:u[e.timeInterval]=u[e.timeInterval]+e.count,m[2]=m[2]+e.count}3!==e.subType&&(p[e.timeInterval]=p[e.timeInterval]+e.count)});break;case"w":r=[];var k=[];c=[0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0],u=[0,0,0,0,0,0,0],p=[0,0,0,0,0,0,0];for(var w=new Date(o),E=0;E<7;E++){var N=w.getFullYear(),$=w.getMonth()+1,M=w.getDate();r.push(N+"-"+$+"-"+M),k.push(M),w.setDate(w.getDate()+1)}e.map(function(e){for(var t=0;t<k.length;t++)if(e.timeInterval===k[t]){switch(e.subType){case 0:c[t]=c[t]+e.count,m[0]=m[0]+e.count;break;case 1:d[t]=d[t]+e.count,m[1]=m[1]+e.count;break;case 2:u[t]=u[t]+e.count,m[2]=m[2]+e.count}3!==e.subType&&(p[t]=p[t]+e.count)}});break;case"m":r=[],c=[],d=[],u=[],p=[];for(var R=!1,U=new Date(o),_=new Date(a);!R;){var x=U.getFullYear(),O=U.getMonth()+1,L=U.getDate();r.push(x+"-"+O+"-"+L),c.push(0),d.push(0),u.push(0),p.push(0),U.setDate(U.getDate()+1),U>=_&&(R=!0)}e.map(function(e){switch(e.subType){case 0:c[e.timeInterval-1]=c[e.timeInterval-1]+e.count,m[0]=m[0]+e.count;break;case 1:d[e.timeInterval-1]=d[e.timeInterval-1]+e.count,m[1]=m[1]+e.count;break;case 2:u[e.timeInterval-1]=u[e.timeInterval-1]+e.count,m[2]=m[2]+e.count}3!==e.subType&&(p[e.timeInterval-1]=p[e.timeInterval-1]+e.count)})}}var B="level"===t?"事件等级信息":"风险等级信息",V="level"===t?["警告","丢弃","阻断","总计"]:["低","中","高","总计"],j=[];switch(t){case"level":j.push({name:"警告",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#CCCC00",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:i}),j.push({name:"丢弃",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#3366CC",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:l}),j.push({name:"阻断",type:"bar",barWidth:30,barGap:"10%",stack:"总量",itemStyle:{normal:{color:"#FF9933",barBorderRadius:0,label:{show:!1,position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:s});break;case"risk":j.push({name:"低",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#99CC33",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:c}),j.push({name:"中",type:"bar",barWidth:30,barGap:"10%",stack:"总量",itemStyle:{normal:{color:"#FF9933",barBorderRadius:0,label:{show:!1,position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:d}),j.push({name:"高",type:"bar",barWidth:30,barGap:"10%",stack:"总量",itemStyle:{normal:{color:"#CC6699",barBorderRadius:0,label:{show:!1,position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:u})}j.push({name:"总计",type:"line",symbolSize:5,symbol:"circle",itemStyle:{normal:{color:"#009999",barBorderRadius:0,label:{show:!0,position:"top",formatter:function(e){return e.value>0?e.value:""}}}},data:p});var W={backgroundColor:"rgba(52,71,88,0.3)",title:{text:B,subtext:"",x:"center",textStyle:{color:"#fff",fontSize:"22"},subtextStyle:{color:"#90979c",fontSize:"16"}},tooltip:{trigger:"axis",axisPointer:{type:"shadow",textStyle:{color:"#fff"}}},grid:{borderWidth:0,top:80,bottom:95,textStyle:{color:"#fff"}},legend:{x:"center",top:"8%",textStyle:{color:"#90979c"},data:V},calculable:!0,xAxis:[{type:"category",axisLine:{lineStyle:{color:"#90979c"}},splitLine:{show:!1},axisTick:{show:!1},splitArea:{show:!1},axisLabel:{interval:0,rotate:45},data:r}],yAxis:[{type:"value",splitLine:{show:!0},axisLine:{lineStyle:{color:"#90979c"}},axisTick:{show:!1},axisLabel:{interval:0},splitArea:{show:!1}}],dataZoom:[{show:!0,height:30,xAxisIndex:[0],bottom:30,start:0,end:100,handleIcon:"path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z",handleSize:"110%",handleStyle:{color:"#d3dee5"},textStyle:{color:"#fff"},borderColor:"#90979c"}],series:j},F="level"===t?"事件等级统计信息":"风险等级统计信息",H="level"===t?"事件等级":"风险等级",G="level"===t?["警告","丢弃","阻断"]:["低","中","高"],z="level"===t?[{value:f[0],name:"警告",label:{normal:{show:function(){return 0!==f[0]}()},emphasis:{show:function(){return 0!==f[0]}()}},labelLine:{normal:{show:function(){return 0!==f[0]}()},emphasis:{show:function(){return 0!==f[0]}()}},itemStyle:{normal:{color:"#CCCC00"}}},{value:f[1],name:"丢弃",label:{normal:{show:function(){return 0!==f[1]}()},emphasis:{show:function(){return 0!==f[1]}()}},labelLine:{normal:{show:function(){return 0!==f[1]}()},emphasis:{show:function(){return 0!==f[1]}()}},itemStyle:{normal:{color:"#3366CC"}}},{value:f[2],name:"阻断",label:{normal:{show:function(){return 0!==f[2]}()},emphasis:{show:function(){return 0!==f[2]}()}},labelLine:{normal:{show:function(){return 0!==f[2]}()},emphasis:{show:function(){return 0!==f[2]}()}},itemStyle:{normal:{color:"#FF9933"}}}]:[{value:m[0],name:"低",label:{normal:{show:function(){return 0!==m[0]}()},emphasis:{show:function(){return 0!==m[0]}()}},labelLine:{normal:{show:function(){return 0!==m[0]}()},emphasis:{show:function(){return 0!==m[0]}()}},itemStyle:{normal:{color:"#99CC33"}}},{value:m[1],name:"中",label:{normal:{show:function(){return 0!==m[1]}()},emphasis:{show:function(){return 0!==m[1];
}()}},labelLine:{normal:{show:function(){return 0!==m[1]}()},emphasis:{show:function(){return 0!==m[1]}()}},itemStyle:{normal:{color:"#FF9933"}}},{value:m[2],name:"高",label:{normal:{show:function(){return 0!==m[2]}()},emphasis:{show:function(){return 0!==m[2]}()}},labelLine:{normal:{show:function(){return 0!==m[2]}()},emphasis:{show:function(){return 0!==m[2]}()}},itemStyle:{normal:{color:"#CC6699"}}}],q={backgroundColor:"rgba(52,71,88,0.3)",title:{text:F,x:"center",textStyle:{color:"#fff",fontSize:"22"},subtextStyle:{color:"#90979c",fontSize:"16"}},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{x:"center",y:"11%",textStyle:{color:"#90979c"},data:G},toolbox:{show:!0,feature:{mark:{show:!0},magicType:{show:!0,type:["pie","funnel"]}}},calculable:!0,series:[{name:H,type:"pie",radius:[20,110],center:["50%","60%"],roseType:"radius",data:z}]};return[W,q]}function r(){l&&l.setOption({dataZoom:[{show:!0,height:30,xAxisIndex:[0],bottom:30,start:0,end:100,handleIcon:"path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z",handleSize:"110%",handleStyle:{color:"#d3dee5"},textStyle:{color:"#fff"},borderColor:"#90979c"}]})}var i=this;i.incident={},i.incident.viewDetail=!1,i.incident.curPage=0,i.incident.numPerPage=10,i.incident.detail={},i.incident.isInputSrcIp=!1,i.incident.isInputDstIp=!1,i.incident.inputSrcIp="",i.incident.inputDstIp="",i.incident.selectType="level",i.reportPromise=null,i.incident.editSetting=function(){i.incident.editMode=!0,i.incident.tempSetting=angular.copy(i.incident.setting)},i.incident.confirmSetting=function(){if(i.incident.editMode=!1,i.incident.settingData.schedulingJob.jobData=i.incident.tempSetting.level,"daily"===i.incident.tempSetting.frequency)i.incident.settingData.schedulingJobMeta[0].dayOfMonth="*",i.incident.settingData.schedulingJobMeta[0].month="*",i.incident.settingData.schedulingJobMeta[0].dayOfWeek="?",i.incident.settingData.schedulingJobMeta[0].year="*";else if("weekly"===i.incident.tempSetting.frequency){i.incident.settingData.schedulingJobMeta[0].dayOfMonth="?",i.incident.settingData.schedulingJobMeta[0].month="*";var e=["","星期天","星期一","星期二","星期三","星期四","星期五","星期六"];i.incident.settingData.schedulingJobMeta[0].dayOfWeek=e.indexOf(i.incident.tempSetting.weekday).toString(),i.incident.settingData.schedulingJobMeta[0].year="*"}else i.incident.settingData.schedulingJobMeta[0].dayOfMonth="1",i.incident.settingData.schedulingJobMeta[0].month="*",i.incident.settingData.schedulingJobMeta[0].dayOfWeek="?",i.incident.settingData.schedulingJobMeta[0].year="*";n.setScheduleSetting(i.incident.settingData).then(function(){i.incident.getData(),i.incident.curPage=0})},i.incident.cancelSetting=function(){i.incident.editMode=!1},i.incident.getData=function(){var e,t,o=["","星期天","星期一","星期二","星期三","星期四","星期五","星期六"];return n.getScheduleSetting("INCIDENT_REPORT").then(function(a){return i.incident.settingData=a,"*"===a.schedulingJobMeta[0].dayOfMonth?(e="daily",t="星期一"):"?"===a.schedulingJobMeta[0].dayOfMonth?(e="weekly",t=o[a.schedulingJobMeta[0].dayOfWeek]):(e="monthly",t="星期一"),i.incident.setting={frequency:e,weekday:t},n.getStartTime().then(function(e){if(e){i.incident.Start=new Date(e.timestamp),i.incident.Start.setHours(0,0,0,0),i.incident.End=new Date,i.incident.Data=[];var t,n;if(i.incident.End.setHours(23,59,59,999),"monthly"===i.incident.setting.frequency&&i.incident.Start.setDate(1),"weekly"===i.incident.setting.frequency){t=new Date(i.incident.Start);for(var o=0;o<7;o++){if(t.getDay()===a.schedulingJobMeta[0].dayOfWeek-1){t.setHours(0,0,0,0),t.setTime(t.getTime()-1);break}t.setDate(t.getDate()+1)}if(t>=i.incident.End&&(i.incident.End=new Date(t)),t>i.incident.Start){var r=new Date(t);r.setDate(t.getDate()-7),n={start:new Date(r.getTime()+1),end:new Date(t)},i.incident.Data.push(n),i.incident.Start.setTime(t.getTime()+1)}}for(;i.incident.Start<i.incident.End;)"daily"===i.incident.setting.frequency&&(t=new Date(i.incident.Start),t.setHours(23,59,59,999),n={start:new Date(i.incident.Start),end:new Date(t)},i.incident.Data.push(n),i.incident.Start.setTime(t.getTime()+1)),"weekly"===i.incident.setting.frequency&&(t=new Date(i.incident.Start),t.setDate(i.incident.Start.getDate()+7),n={start:new Date(i.incident.Start),end:new Date(t-1)},i.incident.Data.push(n),i.incident.Start=new Date(t)),"monthly"===i.incident.setting.frequency&&(t=new Date(i.incident.Start),t.setMonth((parseInt(i.incident.Start.getMonth())+1).toString()),n={start:new Date(i.incident.Start),end:new Date(t)},i.incident.Data.push(n),i.incident.Start.setMonth((parseInt(i.incident.Start.getMonth())+1).toString()));i.incident.Data&&(i.incident.Data.reverse(),i.incident.pagenation(i.incident.curPage,i.incident.numPerPage))}else i.incident.eventStart=null,i.incident.curData=[],i.incident.maxPage=1})})},i.incident.getData(),i.incident.pagenation=function(e,t){i.incident.maxPage=Math.ceil(i.incident.Data.length/t),e=e<0?0:e>i.incident.maxPage-1?i.incident.maxPage-1:e,i.incident.curData=i.incident.Data.slice(e*t,e*t+t)},i.incident.changePage=function(e){i.incident.curPage=i.incident.curPage+e<0?0:i.incident.curPage+e>i.incident.maxPage-1?i.incident.maxPage-1:i.incident.curPage+e,i.incident.pagenation(i.incident.curPage,i.incident.numPerPage)},i.incident.gotoPageHead=function(){i.incident.curPage=0,i.incident.curData=i.incident.Data.slice(0,i.incident.numPerPage)},i.incident.gotoPageEnd=function(){i.incident.curPage=i.incident.maxPage-1,i.incident.curData=i.incident.Data.slice(i.incident.curPage*i.incident.numPerPage,i.incident.Data.length)};var l,s;e.getReportIp=function(e,t){var o=i.incident.currentIncident.start.toISOString().slice(0,i.incident.currentIncident.start.toISOString().length-5)+"+00:00",a=i.incident.currentIncident.end.toISOString().slice(0,i.incident.currentIncident.end.toISOString().length-5)+"+00:00";return n.getReportIp(t,e,o,a).then(function(e){var t=[];return e.map(function(e){t.push({name:e,value:e})}),t})},i.incident.ipSelectedChanged=function(e){"src"===e?(i.incident.isInputSrcIp=!0,i.incident.isInputDstIp=!1):"dst"===e&&(i.incident.isInputSrcIp=!1,i.incident.isInputDstIp=!0)},i.incident.typeSelectedChanged=function(){void 0!==i.incident.currentIncident&&null!==i.incident.currentIncident&&i.incident.showDetail(i.incident.currentIncident,!0)},i.incident.showDetail=function(e,t){i.viewDetail=!0,i.incident.currentIncident=e,i.incident.detail.title="事件_"+("daily"===i.incident.setting.frequency?"每日":"weekly"===i.incident.setting.frequency?"每周":"每月")+"报告_"+e.start.getFullYear()+"-"+(parseInt(e.start.getMonth())+1)+"-"+e.start.getDate();var r=e.start.toISOString().slice(0,e.start.toISOString().length-5)+"+00:00",c=e.end.toISOString().slice(0,e.end.toISOString().length-5)+"+00:00",d="daily"===i.incident.setting.frequency?"d":"weekly"===i.incident.setting.frequency?"w":"m";t||(i.incident.selectType="level",i.incident.selectedSourceIp="",i.incident.selectedDestIp="",i.incident.inputSrcIp="",i.incident.inputDstIp="",i.incident.isInputSrcIp=!1,i.incident.isInputDstIp=!1);var u=i.incident.inputSrcIp&&""!==i.incident.inputSrcIp.trim()?i.incident.inputSrcIp.trim():"0",p=i.incident.inputDstIp&&""!==i.incident.inputDstIp.trim()?i.incident.inputDstIp.trim():"0",f=o.defer();i.reportPromise=f.promise,n.getReport(i.incident.selectType,u,p,r,c,d).then(function(t){f.resolve("success");var n=a(t,i.incident.selectType,d,e.start,e.end);l=echarts.init(document.getElementById("chart_bar_line")),l.setOption(n[0]),s=echarts.init(document.getElementById("chart_pie")),s.setOption(n[1])}).then(function(){f.resolve("fail")})},i.incident.confirmInputSrcIp=function(){i.incident.isInputSrcIp=!1,void 0!==i.incident.currentIncident&&null!==i.incident.currentIncident&&i.incident.showDetail(i.incident.currentIncident,!0)},i.incident.confirmInputDstIp=function(){i.incident.isInputDstIp=!1,void 0!==i.incident.currentIncident&&null!==i.incident.currentIncident&&i.incident.showDetail(i.incident.currentIncident,!0)},i.incident.outPutReport=function(){r();var e=l.getDataURL({type:"jpeg",backgroundColor:"rgba(52,71,88,1)"}),t=s.getDataURL({type:"jpeg",backgroundColor:"rgba(52,71,88,1)"}),o=i.incident.currentIncident.start.toISOString().slice(0,i.incident.currentIncident.start.toISOString().length-5)+"+00:00",a=i.incident.currentIncident.end.toISOString().slice(0,i.incident.currentIncident.end.toISOString().length-5)+"+00:00",c=i.incident.inputSrcIp&&""!==i.incident.inputSrcIp.trim()?i.incident.inputSrcIp.trim():"0",d=i.incident.inputDstIp&&""!==i.incident.inputDstIp.trim()?i.incident.inputDstIp.trim():"0";n.getOutPutReport(e,t,c,d,o,a,"incident").then(function(e){window.open("./"+e,"_self")})}}e.$inject=["$scope","$state","Incident","$q"],angular.module("southWest.monitor.report_event").controller("ReportEventCtrl",e)}(),function(){"use strict";function e(e){function t(t,o,a,r){function i(n){var o={$orderby:"timestamp",$limit:10,$filter:s.filter};return n&&n.$skip&&(o.$skip=n.$skip),n&&n.$limit&&(o.$limit=n.$limit),e.getAll(o).then(function(e){return e.map(function(e){e.action="DROP"===e.action?"丢弃":"WARN"===e.action?"警告":"ALERT"===e.action?"警告":"REJECTBOTH"===e.action?"阻断":""}),setTimeout(function(){s.data=e?e:[],s.currPage=t.dtable.currentPage,s.numPages=t.dtable.numPages},10),e?e:[]})}function l(){var t={$orderby:"timestamp",$limit:n,$filter:s.filter};return e.getCount(t)}var s=t.incidentdata;r.disableToolbar=!0,r.setConfig({name:"incident",pagination:!0,numPerPage:n,scrollable:!1,totalCount:!0,getAll:i,getCount:l})}var o={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/report/event/incident-table.46e8189a.html",link:t};return o}function t(e){function t(t,o,a,r){function i(n){var o={$orderby:"timestamp",$limit:10,$filter:s.filter};return n&&n.$skip&&(o.$skip=n.$skip),n&&n.$limit&&(o.$limit=n.$limit),e.getAll(o).then(function(e){return e.map(function(e){e.action="REJECTBOTH"===e.action?"阻断":"WARN"===e.action?"警告":"ALERT"===e.action?"警告":"DROP"===e.action?"丢弃":""}),setTimeout(function(){s.data=e?e:[],s.currPage=t.dtable.currentPage,s.numPages=t.dtable.numPages},10),e?e:[]})}function l(){var t={$orderby:"timestamp",$limit:n,$filter:s.filter};return e.getCount(t)}var s=t.eventdata;r.disableToolbar=!0,r.setConfig({name:"event",pagination:!0,numPerPage:n,scrollable:!1,totalCount:!0,getAll:i,getCount:l})}var o={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/report/event/event-table.5f5f2352.html",link:t};return o}e.$inject=["Incident"],t.$inject=["Event"],angular.module("southWest.monitor.report_event").directive("incidentReportTable",e).directive("eventReportTable",t);var n=100}(),function(){"use strict";function e(e){e.state("monitor.report_log",{parent:"monitor",url:"/report/log",controller:"ReportLoggerCtrl as rlogger",templateUrl:"templates/monitor/report/log/index.bd2d4c10.html"})}e.$inject=["$stateProvider"],angular.module("southWest.monitor.report_log").config(e)}(),function(){"use strict";function e(e,t,n,o,a){function r(e,t,n,o){var a,r,i,l,s,c,d,u,p=[0,0,0,0,0,0];switch(t){case"d":a=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],c=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.map(function(e){switch(e.type){case 0:r[e.timeInterval]=r[e.timeInterval]+e.count,p[0]=p[0]+e.count;break;case 1:i[e.timeInterval]=i[e.timeInterval]+e.count,p[1]=p[1]+e.count;break;case 2:l[e.timeInterval]=l[e.timeInterval]+e.count,p[2]=p[2]+e.count;break;case 3:s[e.timeInterval]=s[e.timeInterval]+e.count,p[3]=p[3]+e.count;break;case 4:c[e.timeInterval]=c[e.timeInterval]+e.count,p[4]=p[4]+e.count;break;case 5:d[e.timeInterval]=d[e.timeInterval]+e.count,p[5]=p[5]+e.count}u[e.timeInterval]=u[e.timeInterval]+e.count});break;case"w":a=[];var f=[];r=[0,0,0,0,0,0,0],i=[0,0,0,0,0,0,0],l=[0,0,0,0,0,0,0],s=[0,0,0,0,0,0,0],c=[0,0,0,0,0,0,0],d=[0,0,0,0,0,0,0],u=[0,0,0,0,0,0,0];for(var m=new Date(n),g=0;g<7;g++){var h=m.getFullYear(),v=m.getMonth()+1,y=m.getDate();a.push(h+"-"+v+"-"+y),f.push(y),m.setDate(m.getDate()+1)}e.map(function(e){for(var t=0;t<f.length;t++)if(e.timeInterval===f[t]){switch(e.type){case 0:r[t]=r[t]+e.count,p[0]=p[0]+e.count;break;case 1:i[t]=i[t]+e.count,p[1]=p[1]+e.count;break;case 2:l[t]=l[t]+e.count,p[2]=p[2]+e.count;break;case 3:s[t]=s[t]+e.count,p[3]=p[3]+e.count;break;case 4:c[t]=c[t]+e.count,p[4]=p[4]+e.count;break;case 5:d[t]=d[t]+e.count,p[5]=p[5]+e.count}u[t]=u[t]+e.count}});break;case"m":a=[],r=[],i=[],l=[],s=[],c=[],d=[],u=[];for(var I=!1,D=new Date(n),T=new Date(o);!I;){var b=D.getFullYear(),S=D.getMonth()+1,P=D.getDate();a.push(b+"-"+S+"-"+P),r.push(0),s.push(0),l.push(0),i.push(0),c.push(0),d.push(0),u.push(0),D.setDate(D.getDate()+1),D>=T&&(I=!0)}e.map(function(e){switch(e.type){case 0:r[e.timeInterval-1]=r[e.timeInterval-1]+e.count,p[0]=p[0]+e.count;break;case 1:i[e.timeInterval-1]=i[e.timeInterval-1]+e.count,p[1]=p[1]+e.count;break;case 2:l[e.timeInterval-1]=l[e.timeInterval-1]+e.count,p[2]=p[2]+e.count;break;case 3:s[e.timeInterval-1]=s[e.timeInterval-1]+e.count,p[3]=p[3]+e.count;break;case 4:c[e.timeInterval-1]=c[e.timeInterval-1]+e.count,p[4]=p[4]+e.count;break;case 5:d[e.timeInterval-1]=d[e.timeInterval-1]+e.count,p[5]=p[5]+e.count}u[e.timeInterval-1]=u[e.timeInterval-1]+e.count})}var A={backgroundColor:"rgba(52,71,88,0.3)",title:{text:"日志分类信息",subtext:"",x:"center",textStyle:{color:"#fff",fontSize:"22"},subtextStyle:{color:"#90979c",fontSize:"16"}},tooltip:{trigger:"axis",axisPointer:{type:"shadow",textStyle:{color:"#fff"}}},grid:{borderWidth:0,top:80,bottom:95,textStyle:{color:"#fff"}},legend:{x:"center",top:"8%",textStyle:{color:"#90979c"},data:["MW操作","MW登录","DPI操作","DPI登录","系统日志","策略日志","总计"]},calculable:!0,xAxis:[{type:"category",axisLine:{lineStyle:{color:"#90979c"}},splitLine:{show:!1},axisTick:{show:!1},splitArea:{show:!1},axisLabel:{interval:0,rotate:45},data:a}],yAxis:[{type:"value",splitLine:{show:!0},axisLine:{lineStyle:{color:"#90979c"}},axisTick:{show:!1},axisLabel:{interval:0},splitArea:{show:!1}}],dataZoom:[{show:!0,height:30,xAxisIndex:[0],bottom:30,start:0,end:100,handleIcon:"path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z",handleSize:"110%",handleStyle:{color:"#d3dee5"},textStyle:{color:"#fff"},borderColor:"#90979c"}],series:[{name:"MW操作",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#336699",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:r},{name:"MW登录",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#99CC33",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:i},{name:"DPI操作",type:"bar",barWidth:30,barGap:"10%",stack:"总量",itemStyle:{normal:{color:"#FF9900",barBorderRadius:0,label:{show:!1,position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:l},{name:"DPI登录",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#FFCC00",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:s},{name:"系统日志",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#CC6600",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:c},{name:"策略日志",type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:"#996600",label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:d},{name:"总计",type:"line",symbolSize:10,symbol:"circle",itemStyle:{normal:{color:"#009999",barBorderRadius:0,label:{show:!0,position:"top",formatter:function(e){return e.value>0?e.value:""}}}},data:u}]},C=[{value:p[0],name:"MW操作",label:{normal:{show:function(){return 0!==p[0]}()},emphasis:{show:function(){return 0!==p[0]}()}},labelLine:{normal:{show:function(){return 0!==p[0]}()},emphasis:{show:function(){return 0!==p[0]}()}},itemStyle:{normal:{color:"#336699"}}},{value:p[1],name:"MW登录",label:{normal:{show:function(){return 0!==p[1]}()},emphasis:{show:function(){return 0!==p[1]}()}},labelLine:{normal:{show:function(){return 0!==p[1]}()},emphasis:{show:function(){return 0!==p[1]}()}},itemStyle:{normal:{color:"#99CC33"}}},{value:p[2],name:"DPI操作",label:{normal:{show:function(){return 0!==p[2]}()},emphasis:{show:function(){return 0!==p[2]}()}},labelLine:{normal:{show:function(){return 0!==p[2]}()},emphasis:{show:function(){return 0!==p[2]}()}},itemStyle:{normal:{color:"#FF9900"}}},{value:p[3],name:"DPI登录",label:{normal:{show:function(){return 0!==p[3]}()},emphasis:{show:function(){return 0!==p[3]}()}},labelLine:{normal:{show:function(){return 0!==p[3]}()},emphasis:{show:function(){return 0!==p[3]}()}},itemStyle:{normal:{color:"#FFCC00"}}},{value:p[4],name:"系统日志",label:{normal:{show:function(){return 0!==p[4]}()},emphasis:{show:function(){return 0!==p[4]}()}},labelLine:{normal:{show:function(){return 0!==p[4]}()},emphasis:{show:function(){return 0!==p[4]}()}},itemStyle:{normal:{color:"#CC6600"}}},{value:p[5],name:"策略日志",label:{normal:{show:function(){return 0!==p[5]}()},emphasis:{show:function(){return 0!==p[5]}()}},labelLine:{normal:{show:function(){return 0!==p[5]}()},emphasis:{show:function(){return 0!==p[5]}()}},itemStyle:{normal:{color:"#996600"}}}],k={backgroundColor:"rgba(52,71,88,0.3)",title:{text:"日志统计信息",x:"center",textStyle:{color:"#fff",fontSize:"22"},subtextStyle:{color:"#90979c",fontSize:"16"}},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{x:"center",y:"11%",textStyle:{color:"#90979c"},data:["MW操作","MW登录","DPI操作","DPI登录","系统日志","策略日志"]},toolbox:{show:!0,feature:{mark:{show:!0},magicType:{show:!0,type:["pie","funnel"]}}},calculable:!0,series:[{name:"日志统计",type:"pie",radius:[20,110],center:["50%","60%"],roseType:"radius",data:C}]};return[A,k]}function i(){s&&s.setOption({dataZoom:[{show:!0,height:30,xAxisIndex:[0],bottom:30,start:0,end:100,handleIcon:"path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z",handleSize:"110%",handleStyle:{color:"#d3dee5"},textStyle:{color:"#fff"},borderColor:"#90979c"}]})}var l=this;l.logger={},l.viewDetail=!1,l.logger.curPage=0,l.logger.numPerPage=10,l.logger.detail={login:{},operation:{},system:{}},l.reportPromise=null,l.logger.editSetting=function(){l.logger.editMode=!0,l.logger.tempSetting=angular.copy(l.logger.setting)},l.logger.confirmSetting=function(){if(l.logger.editMode=!1,"daily"===l.logger.tempSetting.frequency)l.logger.settingData.schedulingJobMeta[0].dayOfMonth="*",l.logger.settingData.schedulingJobMeta[0].month="*",l.logger.settingData.schedulingJobMeta[0].dayOfWeek="?",l.logger.settingData.schedulingJobMeta[0].year="*";else if("weekly"===l.logger.tempSetting.frequency){l.logger.settingData.schedulingJobMeta[0].dayOfMonth="?",l.logger.settingData.schedulingJobMeta[0].month="*";var e=["","星期天","星期一","星期二","星期三","星期四","星期五","星期六"];l.logger.settingData.schedulingJobMeta[0].dayOfWeek=e.indexOf(l.logger.tempSetting.weekday).toString(),l.logger.settingData.schedulingJobMeta[0].year="*"}else l.logger.settingData.schedulingJobMeta[0].dayOfMonth="1",l.logger.settingData.schedulingJobMeta[0].month="*",l.logger.settingData.schedulingJobMeta[0].dayOfWeek="?",l.logger.settingData.schedulingJobMeta[0].year="*";n.setScheduleSetting(l.logger.settingData).then(function(){l.logger.getData(),l.logger.curPage=0})},l.logger.cancelSetting=function(){l.logger.editMode=!1},l.logger.getData=function(){var e,t,o=["","星期天","星期一","星期二","星期三","星期四","星期五","星期六"];return n.getScheduleSetting("LOG_REPORT").then(function(a){return l.logger.settingData=a,"*"===a.schedulingJobMeta[0].dayOfMonth?(e="daily",t="星期一"):"?"===a.schedulingJobMeta[0].dayOfMonth?(e="weekly",t=o[a.schedulingJobMeta[0].dayOfWeek]):(e="monthly",t="星期一"),l.logger.setting={frequency:e,weekday:t},n.getStartTime().then(function(e){if(e){l.logger.Start=new Date(e.timestamp),l.logger.Start.setHours(0,0,0,0),l.logger.End=new Date,l.logger.Data=[];var t,n;if(l.logger.End.setHours(23,59,59,999),"monthly"===l.logger.setting.frequency&&l.logger.Start.setDate(1),"weekly"===l.logger.setting.frequency){t=new Date(l.logger.Start);for(var o=0;o<7;o++){if(t.getDay()===a.schedulingJobMeta[0].dayOfWeek-1){t.setHours(0,0,0,0),t.setTime(t.getTime()-1);break}t.setDate(t.getDate()+1)}if(t>=l.logger.End&&(l.logger.End=new Date(t)),t>l.logger.Start){var r=new Date(t);r.setDate(t.getDate()-7),n={start:new Date(r.getTime()+1),end:new Date(t)},l.logger.Data.push(n),l.logger.Start.setTime(t.getTime()+1)}}for(;l.logger.Start<l.logger.End;)"daily"===l.logger.setting.frequency&&(t=new Date(l.logger.Start),t.setHours(23,59,59,999),n={start:new Date(l.logger.Start),end:new Date(t)},l.logger.Data.push(n),l.logger.Start.setDate(l.logger.Start.getDate()+1)),"weekly"===l.logger.setting.frequency&&(t=new Date(l.logger.Start),t.setDate(l.logger.Start.getDate()+7),n={start:new Date(l.logger.Start),end:new Date(t-1)},l.logger.Data.push(n),l.logger.Start=new Date(t)),"monthly"===l.logger.setting.frequency&&(t=new Date(l.logger.Start),t.setMonth((parseInt(l.logger.Start.getMonth())+1).toString()),n={start:new Date(l.logger.Start),end:new Date(t)},l.logger.Data.push(n),l.logger.Start.setMonth((parseInt(l.logger.Start.getMonth())+1).toString()));l.logger.Data&&(l.logger.Data.reverse(),l.logger.pagenation(l.logger.curPage,l.logger.numPerPage))}else l.logger.eventStart=null,l.logger.curData=[],l.logger.maxPage=1})})},l.logger.getData(),l.logger.pagenation=function(e,t){l.logger.maxPage=Math.ceil(l.logger.Data.length/t),e=e<0?0:e>l.logger.maxPage-1?l.logger.maxPage-1:e,l.logger.curData=l.logger.Data.slice(e*t,e*t+t)},l.logger.changePage=function(e){l.logger.curPage=l.logger.curPage+e<0?0:l.logger.curPage+e>l.logger.maxPage-1?l.logger.maxPage-1:l.logger.curPage+e,l.logger.pagenation(l.logger.curPage,l.logger.numPerPage)},l.logger.gotoPageHead=function(){l.logger.curPage=0,l.logger.curData=l.logger.Data.slice(0,l.logger.numPerPage)},l.logger.gotoPageEnd=function(){l.logger.curPage=l.logger.maxPage-1,l.logger.curData=l.logger.Data.slice(l.logger.curPage*l.logger.numPerPage,l.logger.Data.length)};var s,c;l.logger.showDetail=function(e){l.logger.detail.title="日志_"+("daily"===l.logger.setting.frequency?"每日":"weekly"===l.logger.setting.frequency?"每周":"每月")+"报告_"+e.start.getFullYear()+"-"+(parseInt(e.start.getMonth())+1)+"-"+e.start.getDate(),l.logger.currentLogger=e;var t=e.start.toISOString().slice(0,e.start.toISOString().length-5)+"+00:00",o=e.end.toISOString().slice(0,e.end.toISOString().length-5)+"+00:00",i="daily"===l.logger.setting.frequency?"d":"weekly"===l.logger.setting.frequency?"w":"m";l.viewDetail=!0;var d=a.defer();l.reportPromise=d.promise,n.getReport(t,o,i).then(function(t){d.resolve("success");var n=r(t,i,e.start,e.end);s=echarts.init(document.getElementById("chart_bar_line")),s.setOption(n[0]),c=echarts.init(document.getElementById("chart_pie")),c.setOption(n[1])}).then(function(){d.resolve("fail")})},l.logger.outPutReport=function(){i();var e=s.getDataURL({type:"jpeg",backgroundColor:"rgba(52,71,88,1)"}),t=c.getDataURL({type:"jpeg",backgroundColor:"rgba(52,71,88,1)"}),o=l.logger.currentLogger.start.toISOString().slice(0,l.logger.currentLogger.start.toISOString().length-5)+"+00:00",a=l.logger.currentLogger.end.toISOString().slice(0,l.logger.currentLogger.end.toISOString().length-5)+"+00:00";n.getOutPutReport(e,t,o,a,"log").then(function(e){window.open("./"+e,"_self")})}}e.$inject=["$scope","$state","Logger","$filter","$q"],angular.module("southWest.monitor.report_log").controller("ReportLoggerCtrl",e)}(),function(){"use strict";function e(e){function t(t,n,a,r){function i(n){var a={$orderby:"timestamp",$limit:o,$filter:s.filter};return n&&n.$skip&&(a.$skip=n.$skip),n&&n.$limit&&(a.$limit=n.$limit),e.getAll(a).then(function(e){return e.map(function(e){e.timestamp=new Date(e.timestamp)}),setTimeout(function(){s.data=e?e:[],s.currPage=t.dtable.currentPage,s.numPages=t.dtable.numPages},10),e?e:[]})}function l(){var t={$orderby:"timestamp",$limit:o,$filter:s.filter};return e.getCount(t)}var s=t.logindata;r.disableToolbar=!0,r.setConfig({name:"log",pagination:!0,numPerPage:o,scrollable:!1,totalCount:!0,getAll:i,getCount:l})}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/report/log/allLogs.3a64b5a9.html",link:t};return n}function t(e){function t(t,n,a,r){function i(n){var a={$orderby:"timestamp",$limit:o,$filter:s.filter};return n&&n.$skip&&(a.$skip=n.$skip),n&&n.$limit&&(a.$limit=n.$limit),e.getAll(a).then(function(e){return e.map(function(e){e.timestamp=new Date(e.timestamp)}),setTimeout(function(){s.data=e?e:[],s.currPage=t.dtable.currentPage,s.numPages=t.dtable.numPages},10),e?e:[]})}function l(){var t={$orderby:"timestamp",$limit:o,$filter:s.filter};return e.getCount(t)}var s=t.operationdata;r.disableToolbar=!0,r.setConfig({name:"log",pagination:!0,numPerPage:o,scrollable:!1,totalCount:!0,getAll:i,getCount:l})}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/report/log/consoleLoginLogs.52cf927f.html",link:t};return n}function n(e){function t(t,n,a,r){function i(n){var a={$orderby:"timestamp",$limit:o,$filter:s.filter};return n&&n.$skip&&(a.$skip=n.$skip),n&&n.$limit&&(a.$limit=n.$limit),e.getAll(a).then(function(e){return e.map(function(e){e.timestamp=new Date(e.timestamp)}),setTimeout(function(){s.data=e?e:[],s.currPage=t.dtable.currentPage,s.numPages=t.dtable.numPages},10),e?e:[]})}function l(){var t={$orderby:"timestamp",$limit:o,$filter:s.filter};return e.getCount(t)}var s=t.systemdata;r.disableToolbar=!0,r.setConfig({name:"log",pagination:!0,numPerPage:o,scrollable:!1,totalCount:!0,getAll:i,getCount:l})}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/monitor/report/log/consoleLogs.47906d1c.html",link:t};return n}e.$inject=["Logger"],t.$inject=["Logger"],n.$inject=["Logger"],angular.module("southWest.monitor.report_log").directive("loginLogs",e).directive("operationLogs",t).directive("systemLogs",n);var o=100}(),function(){"use strict";function e(e){e.state("monitor.report_protocol",{parent:"monitor",url:"/report/protocol",controller:"ReportProtocolCtrl as rprotocol",templateUrl:"templates/monitor/report/protocol/index.cce3f923.html"})}e.$inject=["$stateProvider"],angular.module("southWest.monitor.report_protocol").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i){function l(e,t,n,o){var a,r,i,l;switch(t){case"d":a=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],l=0,e.map(function(e,t){r[t]=r[t]+Number(e.value),i[t]=i[t]+Number(e.value),l+=Number(e.value)});break;case"w":a=[];var s=[];r=[0,0,0,0,0,0,0],i=[0,0,0,0,0,0,0],l=0;for(var c=new Date(n),d=0;d<7;d++){var u=c.getFullYear(),p=c.getMonth()+1,f=c.getDate();a.push(u+"-"+p+"-"+f),s.push(f),c.setDate(c.getDate()+1)}e.map(function(e,t){r[t]=r[t]+Number(e.value),i[t]=i[t]+Number(e.value),l+=Number(e.value)});break;case"m":a=[],r=[],i=[],l=0;for(var m=!1,g=new Date(n),h=new Date(o);!m;){var v=g.getFullYear(),y=g.getMonth()+1,I=g.getDate();a.push(v+"-"+y+"-"+I),r.push(0),i.push(0),g.setDate(g.getDate()+1),g>=h&&(m=!0)}e.map(function(e,t){r[t]=r[t]+Number(e.value),i[t]=i[t]+Number(e.value),l+=Number(e.value)})}return[a,r,i,l]}function s(e,t,n){var o={backgroundColor:"rgba(52,71,88,0.3)",title:{text:"协议统计",subtext:"",x:"center",textStyle:{color:"#fff",fontSize:"22"},subtextStyle:{color:"#90979c",fontSize:"16"}},tooltip:{trigger:"axis",axisPointer:{type:"shadow",textStyle:{color:"#fff"}}},grid:{borderWidth:0,top:100,bottom:95,textStyle:{color:"#fff"}},legend:{x:"center",top:"8%",textStyle:{color:"#90979c"},data:[e,"总计"]},calculable:!0,xAxis:[{type:"category",axisLine:{lineStyle:{color:"#90979c"}},splitLine:{show:!1},axisTick:{show:!1},splitArea:{show:!1},axisLabel:{interval:0,rotate:45},data:n[0]}],yAxis:[{type:"value",splitLine:{show:!0},axisLine:{lineStyle:{color:"#90979c"}},axisTick:{show:!1},axisLabel:{interval:0},splitArea:{show:!1}}],dataZoom:[{show:!0,height:30,xAxisIndex:[0],bottom:30,start:0,end:100,handleIcon:"path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z",handleSize:"110%",handleStyle:{color:"#d3dee5"},textStyle:{color:"#fff"},borderColor:"#90979c"}],series:[{name:e,type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:t,label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:n[1]},{name:"总计",type:"line",symbolSize:10,symbol:"circle",itemStyle:{normal:{color:"#009999",barBorderRadius:0,label:{show:!0,position:"top",formatter:function(e){return e.value>0?e.value:""}}}},data:n[2]}]},a=[{value:n[3],name:e,label:{normal:{show:function(){return 0!==n[3]}()},emphasis:{show:function(){return 0!==n[3]}()}},labelLine:{normal:{show:function(){return 0!==n[3]}()},emphasis:{show:function(){return 0!==n[3]}()}},itemStyle:{normal:{color:t}}}],r={backgroundColor:"rgba(52,71,88,0.3)",title:{text:"协议统计",x:"center",textStyle:{color:"#fff",fontSize:"22"},subtextStyle:{color:"#90979c",fontSize:"16"}},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{x:"center",y:"11%",textStyle:{color:"#90979c"},data:[e]},toolbox:{show:!0,feature:{mark:{show:!0},magicType:{show:!0,type:["pie","funnel"]}}},calculable:!0,series:[{name:"协议统计",type:"pie",radius:[20,110],center:["50%","60%"],roseType:"radius",data:a}]};return[o,r]}function c(e,t,o,a,r,l){i.getGrouped(o[0].toLowerCase(),r,l.start,l.end).then(function(i){var s=d(i);u(e[0],t[0],o[0],a[0],s),p(e[1],t[1],o[0],a[0],s),a.splice(0,1),o.splice(0,1),n(function(){m.viewDetail&&o.length>0&&c([g,h],t,o,a,r,l)},500)},function(){m.viewDetail&&o.length>0&&c([g,h],t,o,a,r,l)})}function d(e){var t=[],n=[],o=0;return e.map(function(e){t.push(Number(e.value)),n.push(Number(e.value)),o+=Number(e.value)}),[t,n,o]}function u(e,t,n,o,a){var r=t.legend.data.length;t.legend.data.splice(r-1,1,n);var i=t.series.splice(r-1,1);i[0].data.map(function(e,t){a[1][t]=a[1][t]+e});var l={name:n,type:"bar",stack:"总量",barWidth:30,barGap:"10%",itemStyle:{normal:{color:o,label:{show:!1,textStyle:{color:"#fff"},position:"inside",formatter:function(e){return e.value>0?e.value:""}}}},data:a[0]},s={name:"总计",type:"line",symbolSize:10,symbol:"circle",itemStyle:{normal:{color:"#009999",barBorderRadius:0,label:{show:!0,position:"top",formatter:function(e){return e.value>0?e.value:""}}}},data:a[1]};t.series.push(l),e.setOption(t),t.legend.data.push("总计"),t.series.push(s),e.setOption(t)}function p(e,t,n,o,a){var r={value:a[2],name:n,label:{normal:{show:function(){return 0!==a[2]}()},emphasis:{show:function(){return 0!==a[2]}()}},labelLine:{normal:{show:function(){return 0!==a[2]}()},emphasis:{show:function(){return 0!==a[2]}()}},itemStyle:{normal:{color:o}}};t.legend.data.push(n),t.series[0].data.push(r),e.setOption(t)}function f(){g&&g.setOption({dataZoom:[{show:!0,height:30,xAxisIndex:[0],bottom:30,start:0,end:100,handleIcon:"path://M306.1,413c0,2.2-1.8,4-4,4h-59.8c-2.2,0-4-1.8-4-4V200.8c0-2.2,1.8-4,4-4h59.8c2.2,0,4,1.8,4,4V413z",handleSize:"110%",handleStyle:{color:"#d3dee5"},textStyle:{color:"#fff"},borderColor:"#90979c"}]})}var m=this;m.protocol={},m.viewDetail=!1,m.protocol.curPage=0,m.protocol.numPerPage=10,m.protocol.detail={login:{},
operation:{},system:{}},m.reportPromise=null,m.protocol.editSetting=function(){m.protocol.editMode=!0,m.protocol.tempSetting=angular.copy(m.protocol.setting)},m.protocol.confirmSetting=function(){if(m.protocol.editMode=!1,"daily"===m.protocol.tempSetting.frequency)m.protocol.settingData.schedulingJobMeta[0].dayOfMonth="*",m.protocol.settingData.schedulingJobMeta[0].month="*",m.protocol.settingData.schedulingJobMeta[0].dayOfWeek="?",m.protocol.settingData.schedulingJobMeta[0].year="*";else if("weekly"===m.protocol.tempSetting.frequency){m.protocol.settingData.schedulingJobMeta[0].dayOfMonth="?",m.protocol.settingData.schedulingJobMeta[0].month="*";var e=["","星期天","星期一","星期二","星期三","星期四","星期五","星期六"];m.protocol.settingData.schedulingJobMeta[0].dayOfWeek=e.indexOf(m.protocol.tempSetting.weekday).toString(),m.protocol.settingData.schedulingJobMeta[0].year="*"}else m.protocol.settingData.schedulingJobMeta[0].dayOfMonth="1",m.protocol.settingData.schedulingJobMeta[0].month="*",m.protocol.settingData.schedulingJobMeta[0].dayOfWeek="?",m.protocol.settingData.schedulingJobMeta[0].year="*";o.setScheduleSetting(m.protocol.settingData).then(function(){m.protocol.getData(),m.protocol.curPage=0})},m.protocol.cancelSetting=function(){m.protocol.editMode=!1},m.protocol.getData=function(){var e,t,n=["","星期天","星期一","星期二","星期三","星期四","星期五","星期六"];return o.getScheduleSetting("PROTOCOL_REPORT").then(function(a){return m.protocol.settingData=a,"*"===a.schedulingJobMeta[0].dayOfMonth?(e="daily",t="星期一"):"?"===a.schedulingJobMeta[0].dayOfMonth?(e="weekly",t=n[a.schedulingJobMeta[0].dayOfWeek]):(e="monthly",t="星期一"),m.protocol.setting={frequency:e,weekday:t},o.getStartTime().then(function(e){if(e){m.protocol.Start=new Date(e.flowTimestamp=e.flowTimestamp?e.flowTimestamp:e.packetTimestamp),m.protocol.Start.setHours(0,0,0,0),m.protocol.End=new Date,m.protocol.Data=[];var t,n;if(m.protocol.End.setHours(23,59,59,999),"monthly"===m.protocol.setting.frequency&&m.protocol.Start.setDate(1),"weekly"===m.protocol.setting.frequency){t=new Date(m.protocol.Start);for(var o=0;o<7;o++){if(t.getDay()===a.schedulingJobMeta[0].dayOfWeek-1){t.setHours(0,0,0,0),t.setTime(t.getTime()-1);break}t.setDate(t.getDate()+1)}if(t>=m.protocol.End&&(m.protocol.End=new Date(t)),t>m.protocol.Start){var r=new Date(t);r.setDate(t.getDate()-7),n={start:new Date(r.getTime()+1),end:new Date(t)},m.protocol.Data.push(n),m.protocol.Start.setTime(t.getTime()+1)}}for(;m.protocol.Start<m.protocol.End;)"daily"===m.protocol.setting.frequency&&(t=new Date(m.protocol.Start),t.setHours(23,59,59,999),n={start:new Date(m.protocol.Start),end:new Date(t)},m.protocol.Data.push(n),m.protocol.Start.setDate(m.protocol.Start.getDate()+1)),"weekly"===m.protocol.setting.frequency&&(t=new Date(m.protocol.Start),t.setDate(m.protocol.Start.getDate()+7),n={start:new Date(m.protocol.Start),end:new Date(t-1)},m.protocol.Data.push(n),m.protocol.Start=new Date(t)),"monthly"===m.protocol.setting.frequency&&(t=new Date(m.protocol.Start),t.setMonth((parseInt(m.protocol.Start.getMonth())+1).toString()),n={start:new Date(m.protocol.Start),end:new Date(t)},m.protocol.Data.push(n),m.protocol.Start.setMonth((parseInt(m.protocol.Start.getMonth())+1).toString()));m.protocol.Data&&(m.protocol.Data.reverse(),m.protocol.pagenation(m.protocol.curPage,m.protocol.numPerPage))}else m.protocol.eventStart=null,m.protocol.curData=[],m.protocol.maxPage=1})})},m.protocol.getData(),m.protocol.pagenation=function(e,t){m.protocol.maxPage=Math.ceil(m.protocol.Data.length/t),e=e<0?0:e>m.protocol.maxPage-1?m.protocol.maxPage-1:e,m.protocol.curData=m.protocol.Data.slice(e*t,e*t+t)},m.protocol.changePage=function(e){m.protocol.curPage=m.protocol.curPage+e<0?0:m.protocol.curPage+e>m.protocol.maxPage-1?m.protocol.maxPage-1:m.protocol.curPage+e,m.protocol.pagenation(m.protocol.curPage,m.protocol.numPerPage)},m.protocol.gotoPageHead=function(){m.protocol.curPage=0,m.protocol.curData=m.protocol.Data.slice(0,m.protocol.numPerPage)},m.protocol.gotoPageEnd=function(){m.protocol.curPage=m.protocol.maxPage-1,m.protocol.curData=m.protocol.Data.slice(m.protocol.curPage*m.protocol.numPerPage,m.protocol.Data.length)};var g,h;m.protocol.showDetail=function(e){m.protocol.detail.title="协议_"+("daily"===m.protocol.setting.frequency?"每日":"weekly"===m.protocol.setting.frequency?"每周":"每月")+"报告_"+e.start.getFullYear()+"-"+(parseInt(e.start.getMonth())+1)+"-"+e.start.getDate(),m.protocol.currentProtocol=e;var t=e.start.toISOString().slice(0,e.start.toISOString().length-5)+"+00:00",o=e.end.toISOString().slice(0,e.end.toISOString().length-5)+"+00:00",a="daily"===m.protocol.setting.frequency?"d":"weekly"===m.protocol.setting.frequency?"w":"m";m.viewDetail=!0;var d=r.defer();m.reportPromise=d.promise;var u="daily"===m.protocol.setting.frequency?"hourly":"daily",p=["#1D3D87","#521A88","#4372A0","#107F6D","#522A58","#40A191","#6591BC","#6C4072","#35549A","#CCCCCC","#67329B","#C0D54A","#DFC948","#9FB042","#6AA13F","#BE9C3E","#AC9A5F","#BA3B5F","#DF35EC","#F94E92","#A1A3A5"],f=["HTTP","FTP","Telnet","SMTP","POP3","Modbus","OPCDA","S7","DNP3","IEC104","MMS","ProfinetIO","EnipTcp","EnipUdp","EnipIO","OPCUA","SNMP","FOCAS"];i.getGrouped(f[0].toLowerCase(),u,e.start,e.end).then(function(r){var i=l(r,a,t,o),v=s(f[0],p[0],i);d.resolve("success"),g=echarts.init(document.getElementById("chart_bar_line")),g.setOption(v[0]),h=echarts.init(document.getElementById("chart_pie")),h.setOption(v[1]),p.splice(0,1),f.splice(0,1),n(function(){m.viewDetail&&f.length>0&&c([g,h],v,f,p,u,e)},500)})},m.protocol.outPutReport=function(){f();var e=g.getDataURL({type:"jpeg",backgroundColor:"rgba(52,71,88,1)"}),t=h.getDataURL({type:"jpeg",backgroundColor:"rgba(52,71,88,1)"}),n=m.protocol.currentProtocol.start.toISOString().slice(0,m.protocol.currentProtocol.start.toISOString().length-5)+"+00:00",a=m.protocol.currentProtocol.end.toISOString().slice(0,m.protocol.currentProtocol.end.toISOString().length-5)+"+00:00";o.getOutPutReport(e,t,n,a,"protocol").then(function(e){window.open("./"+e,"_self")})}}e.$inject=["$scope","$state","$timeout","ProtocolReport","$filter","$q","Audit"],angular.module("southWest.monitor.report_protocol").controller("ReportProtocolCtrl",e)}(),function(){"use strict";function e(e){e.state("setting.myaccount",{parent:"setting",url:"/myaccount",controller:"MyAccountCtrl as myaccount",templateUrl:"templates/myaccount/index.ad1c0d46.html",resolve:{accountUsers:["SystemUser","secretKey",function(e,t){return e.getUsers()}],strategyInfo:["System","secretKey",function(e,t){return e.getStrategyInfo()}]}})}e.$inject=["$stateProvider"],angular.module("southWest.myaccount").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s){var c=this;e.currentState="MY_ACCOUNT",c.success={show:!1},c.error={showPassword:!1,showConfirmPassword:!1},a.getUserName()?(delete c.user,c.user=o.users.filter(function(e){return e.name===a.getUserName()})[0],c.user||"root"!==a.getUserName()||(c.user={},c.user.stuffName="root",c.user.name="root")):e.$on("username",function(e,t){c.user=t}),c.passwordComplexityStrategy=s.getPassComplexity(i.data),c.passwordComplexityMessage=s.getPassComplexityMessage(c.passwordComplexityStrategy.strategyRules[0].ruleData),c.passwordErrormessages=s.errorMessages,c.passwordValid=!1,c.validatePassword=function(){var e=s.validatorWithOld(c.user.oldPassword,c.user.newPassword,c.user.confirmNewPassword,c.passwordComplexityStrategy.strategyRules[0].ruleData);c.oldPassValid=e.oldPassValid,c.newPassValid=e.newPassValid,c.confirmPassValid=e.confirmPassValid,c.passwordValid=e.allValid},c.changePassword=function(){c.passwordValid=!1,c.error={showPassword:!1,showConfirmPassword:!1},c.user.newPassword===c.user.confirmNewPassword?t.updateMyPassword(c.user.oldPassword,c.user.newPassword).then(function(e){delete c.user.oldPassword,delete c.user.newPassword,delete c.user.confirmNewPassword,c.oldPassValid=0,c.newPassValid=0,c.confirmPassValid=0,c.error={showPassword:!1,showConfirmPassword:!1},c.success.show=!0,setTimeout(function(){c.success.show=!1},3e3)},function(e){c.error.showPassword=""!==e.data.error,c.error.message=e.data.error,c.validatePassword(),setTimeout(function(){c.error.showPassword=!1},3e3)}):(c.error.showConfirmPassword=!0,c.error.messageConfirm="密码不一致")}}e.$inject=["$rootScope","SystemUser","System","accountUsers","auth","uiCtrl","strategyInfo","constantService","passwordValidationService"],angular.module("southWest.myaccount").controller("MyAccountCtrl",e)}(),function(){"use strict";function e(e){e.state("network.interface",{url:"/interface",templateUrl:"templates/network/interface/index.3019fedf.html",resolve:{state:["$rootScope",function(e){e.currentState="NETWORK"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.network.interface").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i){function l(l,s,c,d){function u(){return e.getNetInterfaceDatas()}function p(){return e.getNetInterfaceDataCounts()}function f(e){return!(e&&!t.validateObjectAssetsName(e))}function m(e){var t=h.table;if(e&&t)for(var n=0;n<t.length;n++)if(t[n].interfaceName===e)return!0;return!1}function g(e){var t=String(e);return!(t.startsWith("0")&&"0"!==t||isNaN(t))&&Number(t)>=0&&Number(t)<=253}var h=d;d.disableToolbar=!0,d.setConfig({pagination:!1,scrollable:!1,totalCount:!1,getAll:u,getCount:p}),l.addSubInterface=function(){function o(n,o){n.interfaceData={interfaceType:"SUB",ipType:0,subIndex:""},n.tableData=l.dtable.table,n.isEditing=!0,n.isNew=!0,e.getInterfaceNames({$filter:"(interfaceType eq 'ETH')"}).then(function(e){n.interfaceData.subEthInterfaceName=e&&e.length>0?e[0]:"",n.interfaceNames=e}),n.error={subIndex:!0,interfaceName:!1,ipAddressMask:!0},n.setDefaultValue=function(e){angular.forEach(n.tableData,function(t){"ETH"===t.interfaceType&&t.interfaceName===e&&(n.interfaceData.ssh=t.ssh,n.interfaceData.https=t.https,n.interfaceData.ping=t.ping)})},n.checkNameVal=function(){g(n.interfaceData.subIndex)?(n.error.subIndex=!1,n.interfaceData.interfaceName=n.interfaceData.subEthInterfaceName+":"+n.interfaceData.subIndex,n.error.interfaceName=m(n.interfaceData.interfaceName)):(n.error.subIndex=!0,n.error.interfaceName=!1)},n.validateIpType=function(){n.error.ipAddressMask=1!==n.interfaceData.ipType&&t.validateIpMask(n.interfaceData.ipAddressMask)},n.validateIpMask=function(){n.error.ipAddressMask=t.validateIpMask(n.interfaceData.ipAddressMask)},n.ok=function(){var s=[];1===n.interfaceData.ipType?n.interfaceData.ipAddressMask="":n.interfaceData.ipAddressMask=t.ipLongMaskToIpShortNum(n.interfaceData.ipAddressMask);var c=a.defer();l.configPromise=c.promise,e.isIpRangeDuplicate(n.interfaceData).then(function(t){o.close("done"),t.data===!0?(r.addAlert({type:"danger",content:"子接口"+n.interfaceData.interfaceName+"添加失败，其他接口有相同网段IP。"}),c.resolve("fail")):(s.push(e.addNetInterfaceData(n.interfaceData)),a.all(s).then(function(){i(function(){c.resolve("success"),r.addAlert({type:"success",content:"子接口"+n.interfaceData.interfaceName+"添加成功"}),l.$parent.dtable.getTableData()},4e3)},function(e){c.resolve("fail"),r.addAlert({type:"danger",content:"子接口"+n.interfaceData.interfaceName+"添加失败"+(e.data?"："+e.data:"")})}).finally(function(){}))})},n.cancel=function(){o.dismiss("cancel")}}o.$inject=["$scope","$modalInstance"];var s=n.open({templateUrl:"/templates/network/interface/subInterface.3547b019.html",controller:o,backdrop:"static",size:"sm"});s.result.then(function(){},function(){})},l.addVlanInterface=function(){function o(n,o){n.interfaceData={interfaceType:"VLAN",ipType:0,vlanType:"ACCESS",vlanId:""},n.isEditing=!0,n.isNew=!0,e.getInterfaceNames({$filter:"(interfaceType eq 'ETH')"}).then(function(e){n.interfaceData.vlanEthInterfaceName=e&&e.length>0?e[0]:"",n.interfaceNames=e}),n.error={vlanId:!0,interfaceName:!1,ipAddressMask:!1},n.checkNameVal=function(){g(n.interfaceData.vlanId)?(n.error.vlanId=!1,n.interfaceData.interfaceName=n.interfaceData.interfaceType+n.interfaceData.vlanId+"_"+n.interfaceData.vlanEthInterfaceName,n.error.interfaceName=m(n.interfaceData.interfaceName)):(n.error.vlanId=!0,n.error.interfaceName=!1)},n.validateIpType=function(){n.error.ipAddressMask=1!==n.interfaceData.ipType&&(!!n.interfaceData.ipAddressMask&&t.validateIpMask(n.interfaceData.ipAddressMask))},n.validateIpMask=function(){n.error.ipAddressMask=!!n.interfaceData.ipAddressMask&&t.validateIpMask(n.interfaceData.ipAddressMask)},n.ok=function(){var s=[];1===n.interfaceData.ipType?n.interfaceData.ipAddressMask="":n.interfaceData.ipAddressMask=t.ipLongMaskToIpShortNum(n.interfaceData.ipAddressMask);var c=a.defer();l.configPromise=c.promise,e.isIpRangeDuplicate(n.interfaceData).then(function(t){o.close("done"),t.data===!0?(r.addAlert({type:"danger",content:"VLAN接口"+n.interfaceData.interfaceName+"添加失败，其他接口有相同网段IP。"}),c.resolve("fail")):(s.push(e.addNetInterfaceData(n.interfaceData)),a.all(s).then(function(){i(function(){c.resolve("success"),r.addAlert({type:"success",content:"VLAN接口"+n.interfaceData.interfaceName+"添加成功"}),l.$parent.dtable.getTableData()},4e3)},function(e){c.resolve("fail"),r.addAlert({type:"danger",content:"VLAN接口"+n.interfaceData.interfaceName+"添加失败"+(e.data?"："+e.data:"")})}).finally(function(){}))})},n.cancel=function(){o.dismiss("cancel")}}o.$inject=["$scope","$modalInstance"];var s=n.open({templateUrl:"/templates/network/interface/vlanInterface.f894de09.html",controller:o,backdrop:"static",size:"sm"});s.result.then(function(){},function(){})},l.addBriInterface=function(){function s(n,o){n.interfaceData={interfaceType:"BRI",ipType:0,briInterfaceName:""},n.isEditing=!0,n.isNew=!0,e.getInterfaceListByBri().then(function(e){n.interfaceListByBRI=e,angular.forEach(n.interfaceListByBRI,function(e){angular.forEach(e,function(e){e.value=!1})})}),n.error={interfaceName:!0,ipAddressMask:!1},n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',n.checkNameVal=function(){var e=!f(n.interfaceData.interfaceName);e||(e=m(n.interfaceData.interfaceName),n.nameValMsg=e?"已创建该名称的接口，请更换其他接口名称":'支持中文、字母、数字、"-"、"_"的组合，3-20个字符'),n.error.interfaceName=!n.interfaceData.interfaceName||e},n.validateIpMask=function(){n.error.ipAddressMask=!!n.interfaceData.ipAddressMask&&t.validateIpMask(n.interfaceData.ipAddressMask)},n.checkInterfaceByBri=function(){var e="";angular.forEach(n.interfaceListByBRI,function(t){angular.forEach(t,function(t){t.value===!0&&(e=""===e?t.name:e+";"+t.name)})}),n.interfaceData.briInterfaceName=e},n.ok=function(){var s=[];1===n.interfaceData.ipType?n.interfaceData.ipAddressMask="":n.interfaceData.ipAddressMask=t.ipLongMaskToIpShortNum(n.interfaceData.ipAddressMask);var c=a.defer();l.configPromise=c.promise,e.isIpRangeDuplicate(n.interfaceData).then(function(t){o.close("done"),t.data===!0?(r.addAlert({type:"danger",content:"桥接口"+n.interfaceData.interfaceName+"添加失败，其他接口有相同网段IP。"}),c.resolve("fail")):(s.push(e.addNetInterfaceData(n.interfaceData)),a.all(s).then(function(){i(function(){c.resolve("success"),r.addAlert({type:"success",content:"桥接口"+n.interfaceData.interfaceName+"添加成功"}),l.$parent.dtable.getTableData()},4e3)},function(e){c.resolve("fail"),r.addAlert({type:"danger",content:"桥接口"+n.interfaceData.interfaceName+"添加失败"+(e.data?"："+e.data:"")})}).finally(function(){}))})},n.cancel=function(){o.dismiss("cancel")}}s.$inject=["$scope","$modalInstance"];var c=n.open({templateUrl:"/templates/network/interface/briInterface.54662c71.html",controller:s,backdrop:"static",size:"sm"});c.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},l.showDetail=function(t){function a(n,o){n.interfaceData=t,n.isEditing=!1,n.isNew=!1,"ETH"===t.interfaceType?(n.interfaceNames=[t.interfaceName],n.interfaceData.confer=n.interfaceData.confer?n.interfaceData.confer+"":"0",n.interfaceData.speed=n.interfaceData.speed?n.interfaceData.speed+"":"0"):"SUB"===t.interfaceType?n.interfaceNames=[t.subEthInterfaceName]:"VLAN"===t.interfaceType?n.interfaceNames=[t.vlanEthInterfaceName]:"BRI"===t.interfaceType&&e.getInterfaceListByBri(t.interfaceName).then(function(e){n.interfaceListByBRI=e,angular.forEach(n.interfaceListByBRI,function(e){angular.forEach(e,function(e){e.used=!0,t.briInterfaceName.indexOf(e.name)!==-1?e.value=!0:e.value=!1})})}),n.cancel=function(){o.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var r="";"ETH"===t.interfaceType?r="/templates/network/interface/ethInterface.b345ff02.html":"SUB"===t.interfaceType?r="/templates/network/interface/subInterface.3547b019.html":"VLAN"===t.interfaceType?r="/templates/network/interface/vlanInterface.f894de09.html":"BRI"===t.interfaceType&&(r="/templates/network/interface/briInterface.54662c71.html");var i=n.open({templateUrl:r,controller:a,backdrop:!0,size:"sm"});i.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},l.editInterface=function(s){function c(n,o){n.interfaceData=angular.copy(s),"BRI"===n.interfaceData.interfaceType&&void 0===n.interfaceData.briInterfaceName&&(n.interfaceData.briInterfaceName=""),n.isEditing=!0,n.isNew=!1,n.error={},1===n.interfaceData.ipType?n.error.ipAddressMask=!1:"SUB"===s.interfaceType?n.error.ipAddressMask=t.validateIpMask(n.interfaceData.ipAddressMask):n.error.ipAddressMask=!!n.interfaceData.ipAddressMask&&t.validateIpMask(n.interfaceData.ipAddressMask),"ETH"===s.interfaceType?(n.interfaceNames=[],n.interfaceNames.push(s.interfaceName),n.interfaceData.confer=n.interfaceData.confer?n.interfaceData.confer+"":"0",n.interfaceData.speed=n.interfaceData.speed?n.interfaceData.speed+"":"0"):"SUB"===s.interfaceType?n.interfaceNames=[s.subEthInterfaceName]:"VLAN"===s.interfaceType?n.interfaceNames=[s.vlanEthInterfaceName]:"BRI"===s.interfaceType&&e.getInterfaceListByBri(s.interfaceName).then(function(e){n.interfaceListByBRI=e,angular.forEach(n.interfaceListByBRI,function(e){angular.forEach(e,function(e){s.briInterfaceName.indexOf(e.name)!==-1?e.value=!0:e.value=!1})})}),n.validateIpType=function(){1===n.interfaceData.ipType?(n.interfaceData.ipAddressMask=s.ipAddressMask,n.error.ipAddressMask=!1):"SUB"===s.interfaceType?n.error.ipAddressMask=t.validateIpMask(n.interfaceData.ipAddressMask):n.error.ipAddressMask=!!n.interfaceData.ipAddressMask&&t.validateIpMask(n.interfaceData.ipAddressMask)},n.validateIpMask=function(){"SUB"===s.interfaceType?n.error.ipAddressMask=t.validateIpMask(n.interfaceData.ipAddressMask):n.error.ipAddressMask=!!n.interfaceData.ipAddressMask&&t.validateIpMask(n.interfaceData.ipAddressMask)};var c=/^([2][5][6-9]|[2][6-9][0-9]|[3-9][0-9][0-9]|[1][0-4][0-9][0-9]|[1][5][0][0])$/;n.validateMTU=function(){n.error.mtu=!n.interfaceData.mtu||!n.interfaceData.mtu.match(c)},n.validateMac=function(){n.error.mac=!n.interfaceData.mac||t.validateMac(n.interfaceData.mac)},n.checkInterfaceByBri=function(){var e="";angular.forEach(n.interfaceListByBRI,function(t){angular.forEach(t,function(t){t.value===!0&&(e=""===e?t.name:e+";"+t.name)})}),n.interfaceData.briInterfaceName=e},n.changeConfer=function(){"0"===n.interfaceData.confer?n.interfaceData.speed="0":n.interfaceData.speed="1000"},n.ok=function(){var c=[];1===n.interfaceData.ipType?n.interfaceData.ipAddressMask="":n.interfaceData.ipAddressMask=t.ipLongMaskToIpShortNum(n.interfaceData.ipAddressMask);var d=a.defer();l.configPromise=d.promise,e.isIpRangeDuplicate(n.interfaceData).then(function(t){o.close("done"),t.data===!0?(r.addAlert({type:"danger",content:"接口"+n.interfaceData.interfaceName+"修改失败，其他接口有相同网段IP。"}),d.resolve("fail")):(c.push(e.editNetInterfaceData(n.interfaceData)),a.all(c).then(function(){i(function(){d.resolve("success"),r.addAlert({type:"success",content:"接口"+s.interfaceName+"修改成功"}),l.$parent.dtable.getTableData()},4e3)},function(e){d.resolve("fail"),r.addAlert({type:"danger",content:"接口"+s.interfaceName+"修改失败"+(e.data?"："+e.data:"")})}).finally(function(){}))})},n.cancel=function(){o.dismiss("cancel")}}c.$inject=["$scope","$modalInstance"];var d="";"ETH"===s.interfaceType?d="/templates/network/interface/ethInterface.b345ff02.html":"VLAN"===s.interfaceType?d="/templates/network/interface/vlanInterface.f894de09.html":"SUB"===s.interfaceType?d="/templates/network/interface/subInterface.3547b019.html":"BRI"===s.interfaceType&&(d="/templates/network/interface/briInterface.54662c71.html");var u=n.open({templateUrl:d,controller:c,backdrop:"static",size:"sm"});u.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},l.deleteInterface=function(t){e.checkBeforeDelete(t).then(function(n){if(n.data)r.addAlert({type:"danger",content:"接口"+t.interfaceName+"删除失败,已经被"+n.data+"引用。"});else{var o=a.defer();l.configPromise=o.promise,e.deleteNetInterfaceData(t).then(function(){i(function(){o.resolve("success"),r.addAlert({type:"success",content:"接口"+t.interfaceName+"删除成功"}),l.$parent.dtable.getTableData()},4e3)},function(e){o.resolve("fail"),r.addAlert({type:"danger",content:"接口"+t.interfaceName+"删除失败"+(e.data?"："+e.data:"")})})}})}}var s={scope:!0,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/network/interface/interfaceTable.c841062a.html",link:l};return s}e.$inject=["interfaceModel","formatVal","$modal","$log","$q","$rootScope","$timeout"],angular.module("southWest.network.interface").directive("interfaceTable",e)}(),function(){"use strict";function e(e){e.state("network",{abstract:!0,parent:"dashboard",url:"/network",controller:"NetworkCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html"})}e.$inject=["$stateProvider"],angular.module("southWest.network").config(e)}(),function(){"use strict";function e(e,t,n){var o=this;o.prefixId="network",o.subMenus=n.rootMenu.getChild("NETWORK"),o.expanded="true"===t.getItem("network:navbar:expanded"),o.toggleExpand=function(){o.expanded=!o.expanded,t.setItem("network:navbar:expanded",o.expanded)},o.isActive=function(t){return e.current.name.indexOf(t.getState())>-1}}e.$inject=["$state","localStorage","$rootScope"],angular.module("southWest.network").controller("NetworkCtrl",e)}(),function(){"use strict";function e(e){e.state("network.static_router",{url:"/static_router",templateUrl:"templates/network/static_router/index.0dfadfc2.html",resolve:{state:["$rootScope",function(e){e.currentState="NETWORK"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.network.static_router").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r){function i(i,l,s,c){function d(e){return u(e)}function u(e){var t=e||{};return i.skip=e.$skip||0,r.getStaticRouterDatas(t)}function p(e){var t=e||{};return r.getStaticRouterDatasCount(t)}var f=["destIpMask","outInterfaceName","gateWayNextJump","manageScope"];r.getOutInterfaceNames().then(function(e){var t=[{text:"所有出接口",value:"-1"}];e.forEach(function(e){"any"===e?t.push({text:"任意",value:"any"}):t.push({text:e,value:"'"+e+"'"})}),c.setConfig({name:"item",numPerPage:10,pagination:!0,scrollable:!1,totalCount:!0,getAll:u,getCount:p,search:d,fields:f,advancedSearch:"item",advancedSearchOptions:[{name:"destIpMask",display:"目的IP掩码",input:"string",option:!1,value:""},{name:"outInterfaceName",display:"出接口",input:"checkbox",option:!0,value:"-1",options:t},{name:"gateWayNextJump",display:"网关",input:"string",option:!1,value:""},{name:"manageScope",display:"管理距离",input:"string",option:!1,value:""}]})});var m=function(e){return a.go(a.current,e,{reload:!0,inherit:!1,notify:!0})};c.selectedItems={},c.selectAll=function(){c.selectedItems={},c.table.forEach(function(e){c.selectedItems[e.routeId]=c.selectAllValue})},c.selectItem=function(){var e=!1,t=!0;c.table.forEach(function(n){c.selectedItems[n.routeId]?e=!0:t=!1}),e===!0&&t===!1?c.selectAllValue=null:e===!0&&t===!0?c.selectAllValue=!0:c.selectAllValue=!1},c.addNew=function(){function a(n,o,a){n.routerData={},n.isEditing=!0,r.getOutInterfaceNames({$filter:"(interfaceType ne 'SUB')"}).then(function(e){n.routerData.outInterfaceName=e[0],n.interfaces=e}),n.error={destIpMask:!0,gateWayNextJump:!0},n.validateDestIpMask=function(e){"0.0.0.0/0"===e?n.error.destIpMask=!1:n.error.destIpMask=a.validateIpSegment(e)},n.validateGateWayNextJump=function(e){n.error.gateWayNextJump=a.validateIp(e)},n.changeInterface=function(e){n.routerData.outInterfaceName=e,"any"!==n.routerData.outInterfaceName?n.error.gateWayNextJump=!1:n.error.gateWayNextJump=!n.routerData.gateWayNextJump||a.validateIp(n.routerData.gateWayNextJump)};var i=/^([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$/;n.validateManageScope=function(e){n.error.manageScope=""!==e&&!e.match(i)},n.ok=function(){var i=t.defer();n.configPromise=i.promise,n.routerData.destIpMask=a.ipLongMaskToIpShortNum(n.routerData.destIpMask),"any"!==n.routerData.outInterfaceName&&(n.routerData.gateWayNextJump=""),r.addStaticRouterData(n.routerData).then(function(){m().then(function(){e.addAlert({type:"success",content:"静态路由添加成功"})})},function(t){e.addAlert({type:"danger",content:t.data?"静态路由添加失败："+t.data:"静态路由添加失败"})}).finally(function(){n.configPromise=null,o.close("done")})},n.cancel=function(){o.dismiss("cancel")}}a.$inject=["$scope","$modalInstance","formatVal"];var i=n.open({templateUrl:"/templates/network/static_router/staticRouter.0e45d5c6.html",size:"sm",backdrop:"static",controller:a});i.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},c.edit=function(a){function i(n,o,i){n.routerData=angular.copy(a),n.isEditing=!0,r.getOutInterfaceNames({$filter:"(interfaceType ne 'SUB')"}).then(function(e){n.interfaces=e}),n.error={destIpMask:"0.0.0.0/0"!==n.routerData.destIpMask&&i.validateIpMask(n.routerData.destIpMask),gateWayNextJump:"any"===n.routerData.outInterfaceName&&i.validateIp(n.routerData.gateWayNextJump)},n.validateDestIpMask=function(e){"0.0.0.0/0"===e?n.error.destIpMask=!1:n.error.destIpMask=i.validateIpSegment(e)},n.validateGateWayNextJump=function(e){n.error.gateWayNextJump=i.validateIp(e)},n.changeInterface=function(e){n.routerData.outInterfaceName=e,"any"!==n.routerData.outInterfaceName?n.error.gateWayNextJump=!1:n.error.gateWayNextJump=!n.routerData.gateWayNextJump||i.validateIp(n.routerData.gateWayNextJump)};var l=/^([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])$/;n.validateManageScope=function(e){n.error.manageScope=""!==e&&!e.match(l)},n.ok=function(){r.isIpRangeDuplicate(n.routerData).then(function(i){if(i.data===!0)e.addAlert({type:"danger",content:"静态路由添加失败，其他静态路由有相同的网段目的IP掩码。"});else{var l=t.defer();n.configPromise=l.promise,delete n.routerData.priority,r.editStaticRouterData(n.routerData).then(function(){a.routeId===n.routerData.routeId&&(a.destIpMask=n.routerData.destIpMask,a.gateWayNextJump=n.routerData.gateWayNextJump,a.outInterfaceName=n.routerData.outInterfaceName,a.manageScope=n.routerData.manageScope),e.addAlert({type:"success",content:"静态路由修改成功"})},function(t){e.addAlert({type:"danger",content:t.data?"静态路由修改失败："+t.data:"静态路由修改失败"})}).finally(function(){n.configPromise=null,o.close("done")})}})},n.cancel=function(){o.dismiss("cancel")}}i.$inject=["$scope","$modalInstance","formatVal"];var l=n.open({templateUrl:"/templates/network/static_router/staticRouter.0e45d5c6.html",size:"sm",backdrop:"static",controller:i});l.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},c.delete=function(){var n=c.selectedItems,o=[];if(n)for(var a in n)if(n[a])for(var i=0;i<c.table.length;i++)c.table[i].routeId+""===a&&o.push({destIpMask:c.table[i].destIpMask,gateWayNextJump:c.table[i].gateWayNextJump,outInterfaceName:c.table[i].outInterfaceName,routeId:c.table[i].routeId});if(0!==o.length){var l=t.defer();c.deletePromise=l.promise,r.deleteStaticRouterData(o).then(function(){l.resolve("success"),e.addAlert({type:"success",content:"静态路由删除成功"}),m()},function(t){l.resolve("fail"),e.addAlert({type:"danger",content:t.data?"静态路由删除失败："+t.data:"静态路由删除失败"})})}else e.addAlert({type:"info",content:"请至少选中一条静态路由"})}}var l={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/network/static_router/staticRouterTable.c273cb2c.html",link:i};return l}e.$inject=["$rootScope","$q","$modal","$log","$state","staticRouterModel"],angular.module("southWest.network.static_router").directive("staticRouterTable",e)}(),function(){"use strict";function e(e){e.state("ntpsync",{abstract:!0,parent:"dashboard",url:"/ntpsync",controller:"SettingCtrl as setting",templateUrl:"templates/ntpsync/index.d8daecbd.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_POLICY"}]}}).state("ntpsync.setting",{url:"/setting",controller:"SystemConsoleCtrl as sysconsole",templateUrl:"templates/ntpsync/setting.d15c69ff.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_POLICY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.ntpsync").config(e)}(),function(){"use strict";function e(){var e=this;e.test={}}angular.module("southWest.ntpsync").controller("NtpSncCtrl",e)}(),function(){"use strict";function e(e){e.state("object.apply_predefined",{url:"/apply/predefined",controller:"AppPredefineCtrl as appPre",templateUrl:"templates/object/apply/predefine.74a77500.html",resolve:{state:["$rootScope",function(e){e.currentState="OBJECT"}]}}).state("object.apply_customizedefined",{url:"/apply/customizedefined",controller:"AppCustomizeCtrl as appCus",templateUrl:"templates/object/apply/customize.7ec9081a.html",resolve:{state:["$rootScope",function(e){e.currentState="OBJECT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.object.apply").config(e)}(),function(){"use strict";function e(){}function t(){}angular.module("southWest.object.apply").controller("AppPredefineCtrl",e).controller("AppCustomizeCtrl",t)}(),function(){"use strict";function e(e,t,n){function o(o,a,r,i){function l(e){var t=e||{};return o.skip=e.$skip||0,n.getAll(t)}function s(e){var t=e||{};return n.getCount(t)}function c(e){return l(e)}i.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:l,getCount:s,search:c,fields:["name","appId","description"],advancedSearch:"predefineApps",advancedSearchOptions:[{name:"name",display:"应用名",input:"string",option:!1,value:""},{name:"appId",display:"应用Id",input:"string",option:!1,value:""},{name:"description",display:"描述",input:"string",option:!1,value:""}]}),i.selectedItems={},i.selectAll=function(){i.selectedItems={},i.table.forEach(function(e){i.selectedItems[e.name]=i.selectAllValue})},i.viewApply=function(n){function o(e,t){e.viewApply=n,e.protocols=["TCP","UDP"],e.viewApply.type=e.viewApply.tcpPort?"TCP":e.viewApply.udpPort?"UDP":"",e.changeProtocol=function(){"TCP"===e.viewApply.type?e.tcpudpPort=e.viewApply.tcpPort:"UDP"===e.viewApply.type&&(e.tcpudpPort=e.viewApply.udpPort)},e.changeProtocol(),e.signatures=e.viewApply.traitInfos,e.ok=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}o.$inject=["$scope","$modalInstance"];var a=e.open({templateUrl:"apply-predefine-view.html",size:"lg",controller:o});a.result.then(function(){},function(){t.info("Modal dismissed at: "+new Date)})}}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/apply/predefineTable.06572b71.html",link:o};return a}function t(e,t,n,o,a,r,i,l,s){function c(c,d,u,p){function f(e){var t=e||{};return c.skip=e.$skip||0,s.getAll(t)}function m(e){var t=e||{};return s.getCount(t)}function g(e){return f(e)}function h(e){var t=[{value:"-1",text:"全部"}];return angular.isArray(e)&&e.forEach(function(e){t.push({value:e,text:e})}),t}n.all([s.getProtocols(),s.getPredefineApps()]).then(function(e){c.protocols=e[0],c.predefineapps=e[1],p.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:f,getCount:m,search:g,fields:["name","type","inherit"],advancedSearch:"customizedApps",advancedSearchOptions:[{name:"name",display:"应用名",input:"string",option:!1,value:""},{name:"type",display:"承载协议",input:"checkbox",option:!0,options:h(c.protocols)},{name:"inherit",display:"继承",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:!0,text:"是"},{value:!1,text:"否"}]}]})}),p.selectedItems={},p.selectAll=function(){p.selectedItems={},p.table.forEach(function(e){p.selectedItems[e.name]=p.selectAllValue})},p.selectedChanged=function(){var e=!0,t=!1,n=!1;p.table.forEach(function(o){n=void 0!==p.selectedItems[o.name]&&null!==p.selectedItems[o.name]&&p.selectedItems[o.name],t=t||n,e=e&&n}),p.selectAllValue=!!e||!!t&&null},c.privilegeName="OBJECT_APPLICATION";var v=i.get("privilege").filter(function(e){
return e.name===c.privilegeName}),y=v&&v.length>0?v[0].actionValue:1;c.isNoEditPri=y<28,p.addNewApply=function(){function n(n,a,r,i){function s(e){var t=p.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}function d(e){return!(e&&!i.validateObjectAssetsName(e))}function u(e){return!(e&&!i.validatePortDiscrete(e))}n.newApply={},n.newAppSigunature={action:"EXTEND"},n.signatures=[{}],n.protocols=c.protocols,n.newApply.type=c.protocols&&c.protocols.length>0?c.protocols[0]:"",n.predefineapps=c.predefineapps,n.newAppSigunature.predefineapp=c.predefineapps&&c.predefineapps.length>0?c.predefineapps[0]:"",n.checkNameVal=function(e){var t=d(e);return t?(t=s(e),t||(n.nameValMsg="已定义该名称的应用，请更换其他应用名称")):n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},n.checkPortVal=function(e,t){var o=u(e);if(!o){var a="请输入有效端口号（用逗号分隔最多8个端口）";"server"===t?n.serverPortValMsg=a:"client"===t&&(n.clientPortValMsg=a)}return o},n.changeSignatureAction=function(){"MANUAL"!==n.newAppSigunature.action&&(n.signatures=[{}])},n.addNewSignature=function(e){e&&n.signatures.push({})},n.deleteSignature=function(e){n.signatures.splice(e,1)},n.ok=function(i){i&&(n.newApply.inherit="EXTEND"===n.newAppSigunature.action,n.newApply.inherit?n.newApply.predefineName=n.newAppSigunature.predefineapp:n.newApply.traitInfos=n.signatures,n.isAddingApply=!0,r.addNewApply([n.newApply],function(r,i){var s=n.$on("closeAddModal",function(){n.isAddingApply=!1,a.close(),s()});if(i)n.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"自定义应用添加失败："+i.data:"自定义应用添加失败"});else{var c=r.taskId;!function a(r){var i=o(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(n.$emit("closeAddModal"),t.reload().then(function(){e.addAlert({type:"success",content:"自定义应用添加成功"})}),o.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"自定义应用添加失败："+l.data.reason:"自定义应用添加失败"}),o.cancel(i)):("PENDING"===l.data.state,r>0?a(r-1):(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:"自定义应用添加超时"}),o.cancel(i)))})},1e3)}(30)}}))},n.cancel=function(){a.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","ApplyCustomize","formatVal"];var i=a.open({templateUrl:"apply-customize-add-new.html",size:"lg",controller:n});i.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},p.viewApply=function(e){function t(t,n){t.isViewOnly=!0,t.editApply=e,t.newAppSigunature={},t.newAppSigunature.action=e.inherit?"EXTEND":"MANUAL",e.inherit?(t.newAppSigunature.predefineapp=t.editApply.predefineName,t.signatures=t.editApply.traitInfos=[{}]):(t.newAppSigunature.predefineapp=c.predefineapps&&c.predefineapps.length>0?c.predefineapps[0]:"",t.signatures=t.editApply.traitInfos),t.protocols=c.protocols,t.predefineapps=c.predefineapps,t.checkNameVal=function(){return!0},t.checkPortVal=function(){return!0},t.ok=function(){n.close()},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance"];var n=a.open({templateUrl:"apply-customize-edit.html",size:"lg",controller:t});n.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},p.editApply=function(n){function i(a,r,i,s){function d(e){var t=p.table,o=!0;return e&&t&&t.some(function(t){if(t.name===e&&e!==n.name)return o=!1,!0}),o}function u(e){return!(e&&!s.validateObjectAssetsName(e))}function f(e){return!(e&&!s.validatePortDiscrete(e))}a.isEditDisabled=!0,a.editApply=angular.copy(n),a.newAppSigunature={},a.newAppSigunature.action=n.inherit?"EXTEND":"MANUAL",n.inherit?(a.newAppSigunature.predefineapp=a.editApply.predefineName,a.signatures=a.editApply.traitInfos=[{}]):(a.newAppSigunature.predefineapp=c.predefineapps&&c.predefineapps.length>0?c.predefineapps[0]:"",a.signatures=a.editApply.traitInfos),a.protocols=c.protocols,a.predefineapps=c.predefineapps,a.checkNameVal=function(e){var t=u(e);return t?(t=d(e),t||(a.nameValMsg="已定义该名称的应用，请更换其他应用名称")):a.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},a.checkPortVal=function(e,t){var n=f(e);if(!n){var o="请输入有效端口号（用逗号分隔最多8个端口）";"server"===t?a.serverPortValMsg=o:"client"===t&&(a.clientPortValMsg=o)}return n},a.changeSignatureAction=function(){"MANUAL"!==a.newAppSigunature.action&&(a.signatures=[{}])},a.addNewSignature=function(e){e&&a.signatures.push({})},a.deleteSignature=function(e){a.signatures.splice(e,1)},a.ok=function(n){n&&(a.editApply.inherit="EXTEND"===a.newAppSigunature.action,a.editApply.inherit?(a.editApply.predefineName=a.newAppSigunature.predefineapp,a.editApply.traitInfos=[{}]):a.editApply.traitInfos=a.signatures,a.isEdittingApply=!0,i.updateApply([a.editApply],function(n,i){var s=a.$on("closeAddModal",function(){a.isEdittingApply=!1,r.close(),s()});if(i)a.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"自定义应用修改失败："+i.data:"自定义应用修改失败"});else{var c=n.taskId;!function n(r){var i=o(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(a.$emit("closeAddModal"),t.reload().then(function(){e.addAlert({type:"success",content:"自定义应用修改成功"})}),o.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(a.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"自定义应用修改失败："+l.data.reason:"自定义应用修改失败"}),o.cancel(i)):("PENDING"===l.data.state,r>0?n(r-1):(a.$emit("closeAddModal"),e.addAlert({type:"danger",content:"自定义应用修改超时"}),o.cancel(i)))})},1e3)}(30)}}))},a.cancel=function(){r.dismiss("cancel")}}i.$inject=["$scope","$modalInstance","ApplyCustomize","formatVal"];var s=a.open({templateUrl:"apply-customize-edit.html",size:"lg",controller:i});s.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},p.deleteApply=function(){var a=p.selectedItems,r=[];if(a)for(var i in a)a[i]&&r.push(i);if(0!==r.length){var c=n.defer();e.applyDeleteTaskPromise=c.promise,s.deleteApply(r,function(n,a){if(a)e.addAlert({type:"danger",content:a.data?"自定义应用删除失败："+a.data:"自定义应用删除失败"}),c.resolve("fail");else{var r=n.taskId;!function n(a){var i=o(function(){l.getTask(r).then(function(r){"SUCCESS"===r.data.state?(t.reload().then(function(){e.addAlert({type:"success",content:"自定义应用删除成功"})}),c.resolve("success"),o.cancel(i)):"FAILED"===r.data.state||"REJECTED"===r.data.state?(e.addAlert({type:"danger",content:r.data.reason?"自定义应用删除失败："+r.data.reason:"自定义应用删除失败"}),c.resolve("fail"),o.cancel(i)):("PENDING"===r.data.state,a>0?n(a-1):(e.addAlert({type:"danger",content:"自定义应用删除超时"}),c.resolve("timeout"),o.cancel(i)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条自定义应用"})}}var d={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/apply/customizeTable.f8cbf727.html",link:c};return d}e.$inject=["$modal","$log","ApplyPredefine"],t.$inject=["$rootScope","$state","$q","$timeout","$modal","$log","Enum","Task","ApplyCustomize"],angular.module("southWest.object.apply").directive("appPredefineTable",e).directive("appCustomizeTable",t)}(),function(){"use strict";function e(e){e.state("object.network_asset_address",{url:"/network_asset/address",controller:"IpPoolCtrl as ipPool",templateUrl:"templates/object/network_asset/ipPool.de0d14e0.html"}).state("object.network_asset_security_area",{url:"/network_asset/security_area",controller:"SecurityAreaCtrl as secarea",templateUrl:"templates/object/network_asset/securityArea.eb6b4d9a.html"}).state("object.network_asset_device_asset",{url:"/network_asset/device_asset",controller:"DeviceAssetCtrl as dvcasset",templateUrl:"templates/object/network_asset/deviceAsset.35d2a384.html",resolve:{task:["$rootScope",function(e){e.dvcAssetTask||(e.dvcAssetTask={})}]}})}e.$inject=["$stateProvider"],angular.module("southWest.object.network_asset").config(e)}(),function(){"use strict";function e(){}function t(){}function n(e,t,n,o,a){var r=this;r.securityarea=null,r.quickTransferTo=function(i,l){var s=[],c=[],d=[];if(i)for(var u in i)if(i[u]){for(var p=0;p<l.table.length;p++)l.table[p].name===u&&(c.push(l.table[p].securityAreaName),d.push(l.table[p].assetId));s.push(u)}if(0!==s.length){if(!r.securityarea)return void e.addAlert({type:"info",content:"请指定想要转至的安全区域"});var f={assetNames:s.join(","),secNames:c.join(","),assetIds:d.join(","),securityarea:r.securityarea},m=t.defer();e.dvcAssetTask.promise=m.promise,e.dvcAssetTask.message="设备资产转换中，请稍侯...",a.quickTransferTo(f).then(function(t,a){if(a)e.addAlert({type:"danger",content:a.data?"设备资产转换失败："+a.data:"设备资产转换失败"}),m.resolve("fail");else{var r=t.taskId;!function t(a){var i=n(function(){o.getTask(r).then(function(o){"SUCCESS"===o.data.state?(l.getTableData(),e.addAlert({type:"success",content:"设备资产转换成功"}),m.resolve("success"),n.cancel(i)):"FAILED"===o.data.state||"REJECTED"===o.data.state?(e.addAlert({type:"danger",content:o.data.reason?"设备资产转换失败："+o.data.reason:"设备资产转换失败"}),m.resolve("fail"),n.cancel(i)):("PENDING"===o.data.state,a>0?t(a-1):(e.addAlert({type:"danger",content:"设备资产转换超时"}),m.resolve("timeout"),n.cancel(i)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条设备资产"})}}n.$inject=["$rootScope","$q","$timeout","Task","DeviceAsset"],angular.module("southWest.object.network_asset").controller("IpPoolCtrl",e).controller("SecurityAreaCtrl",t).controller("DeviceAssetCtrl",n)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c){function d(d,u,p,f){function m(e){var t=e||{};return d.skip=e.$skip||0,c.getAll(t)}function g(e){var t=e||{};return c.getCount(t)}function h(e){return m(e)}var v=f;f.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:m,getCount:g,search:h,fields:["name","interfaceName","ipAddress","enable"],advancedSearch:"addressPools",advancedSearchOptions:[{name:"name",display:"地址池名称",input:"string",option:!1,value:""},{name:"interfaceName",display:"接口",input:"string",option:!1,value:""},{name:"ipAddress",display:"IP段",input:"string",option:!1,value:""},{name:"enable",display:"启动",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:!0,text:"开启"},{value:!1,text:"关闭"}]}]});var y=function(e){return a.go(a.current,e,{reload:!0,inherit:!1,notify:!0})};f.selectedItems={},f.selectAll=function(){f.selectedItems={},f.table.forEach(function(e){f.selectedItems[e.name]=f.selectAllValue})},f.selectedChanged=function(){var e=!0,t=!1,n=!1;f.table.forEach(function(o){n=void 0!==f.selectedItems[o.name]&&null!==f.selectedItems[o.name]&&f.selectedItems[o.name],t=t||n,e=e&&n}),f.selectAllValue=!!e||!!t&&null},d.privilegeName="OBJECT_ASSET";var I=l.get("privilege").filter(function(e){return e.name===d.privilegeName}),D=I&&I.length>0?I[0].actionValue:1;d.isNoEditPri=D<28,d.isSwitchIpPool={},d.switchIpPoolMsg={},f.changeStartStatus=function(t){var n=t.enable?"启动":"关闭";d.isSwitchIpPool[t.name]=!0,d.switchIpPoolMsg[t.name]=n,c.switchIpPool(t.name,t.enable,function(o,a){if(a)d.isSwitchIpPool[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:a.data?"地址池("+t.name+")"+n+"失败："+a.data:"地址池("+t.name+")"+n+"失败"});else{var i=o.taskId;!function o(a){var l=r(function(){s.getTask(i).then(function(i){"SUCCESS"===i.data.state?(d.isSwitchIpPool[t.name]=!1,e.addAlert({type:"success",content:"地址池("+t.name+")"+n+"成功"}),r.cancel(l)):"FAILED"===i.data.state||"REJECTED"===i.data.state?(d.isSwitchIpPool[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:i.data.reason?"地址池("+t.name+")"+n+"失败："+i.data.reason:"地址池("+t.name+")"+n+"失败"}),r.cancel(l)):("PENDING"===i.data.state,a>0?o(a-1):(d.isSwitchIpPool[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:"地址池("+t.name+")"+n+"超时"}),r.cancel(l)))})},1e3)}(30)}})},f.addNewIp=function(){function t(t,n,o,a){function l(e){var t=v.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}function c(e){return!(e&&!a.validateObjectAssetsName(e))}t.newIpPool={},t.placeHolder="192.168.1.2/255.255.255.0",o.getTypes().then(function(e){t.newIpPool.type=e&&e.length>0?e[0]:"",t.types=e}),t.interfaces=["any"],o.getInterfaces().then(function(e){e=i("spliceContentFromArray")(e,["agl0","ha"]),t.newIpPool.interfaceName=e&&e.length>0?e[0]:"any",t.interfaces=t.interfaces.concat(e)}),t.checkNameVal=function(e){var n=c(e);return n?(n=l(e),n||(t.nameValMsg="已创建该名称的地址池，请更换其他地址池名称")):t.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',n},t.checkIpRangeVal=function(e){if(e){var n;if("IPRANGE"===t.newIpPool.type){if(n=e.split("-"),!angular.isArray(n)||2!==n.length)return!1;var o=n[0],r=n[1];if(a.validateIp(o)||a.validateIp(r))return!1}else if("0.0.0.0/0"!==$.trim(e)&&"0.0.0.0/0.0.0.0"!==$.trim(e)&&a.validateIpSegment(e))return!1}return!0},t.changeType=function(e){t.newIpPool.type=e,t.newIpPool.ipAddress="","IPRANGE"===e?t.placeHolder="192.168.1.2-192.168.2.2":t.placeHolder="192.168.1.2/255.255.255.0"},t.changeInterface=function(e){t.newIpPool.interfaceName=e},t.ok=function(a){a&&(t.isAddingIpPool=!0,o.addNewIpPool([t.newIpPool],function(o,a){var i=t.$on("closeAddModal",function(){t.isAddingIpPool=!1,n.close(),i()});if(a)t.$emit("closeAddModal"),e.addAlert({type:"danger",content:a.data?"地址池添加失败："+a.data:"地址池添加失败"});else{var l=o.taskId;!function n(o){var a=r(function(){s.getTask(l).then(function(i){"SUCCESS"===i.data.state?(t.$emit("closeAddModal"),y().then(function(){e.addAlert({type:"success",content:"地址池添加成功"})}),r.cancel(a)):"FAILED"===i.data.state||"REJECTED"===i.data.state?(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data.reason?"地址池添加失败："+i.data.reason:"地址池添加失败"}),r.cancel(a)):("PENDING"===i.data.state,o>0?n(o-1):(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:"地址池添加超时"}),r.cancel(a)))})},1e3)}(30)}}))},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","IpPool","formatVal"];var a=n.open({templateUrl:"ip-pool-add-new.html",size:"sm",controller:t});a.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},f.viewIp=function(e){function t(t,n){t.isViewOnly=!0,t.ipPool=e,t.checkNameVal=function(){return!0},t.checkIpRangeVal=function(){return!0},t.ok=function(){n.close()},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance"];var a=n.open({templateUrl:"ip-pool-edit.html",size:"sm",controller:t});a.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},f.editIp=function(t){function a(n,o,a,l){function c(e){var n=v.table,o=!0;return e&&n&&n.some(function(n){if(n.name===e&&n.name!==t.name)return o=!1,!0}),o}function d(e){return!(e&&!l.validateObjectAssetsName(e))}n.isEditDisabled=!0,n.ipPool=angular.copy(t),n.placeHolder="192.168.1.2/255.255.255.0",a.getTypes().then(function(e){n.types=e}),n.interfaces=["any"],a.getInterfaces().then(function(e){e=i("spliceContentFromArray")(e,["agl0","ha"]),n.interfaces=n.interfaces.concat(e)}),n.checkNameVal=function(e){var t=d(e);return t?(t=c(e),t||(n.nameValMsg="已创建该名称的地址池，请更换其他地址池名称")):n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},n.checkIpRangeVal=function(e){if(e){var t;if("IPRANGE"===n.ipPool.type){if("0.0.0.0-0.0.0.0"!==$.trim(e)){if(t=e.split("-"),!angular.isArray(t)||2!==t.length)return!1;var o=t[0],a=t[1];if(l.validateIp(o)||l.validateIp(a))return!1}}else if("0.0.0.0/0"!==$.trim(e)&&"0.0.0.0/0.0.0.0"!==$.trim(e)&&l.validateIpSegment(e))return!1}return!0},n.changeType=function(e){n.ipPool.type=e,n.ipPool.ipAddress="","IPRANGE"===e?n.placeHolder="192.168.1.2-192.168.2.2":n.placeHolder="192.168.1.2/255.255.255.0"},n.changeInterface=function(e){n.ipPool.interfaceName=e},n.ok=function(t){t&&(n.isEdittingIpPool=!0,a.updateIpPool([n.ipPool],function(t,a){var i=n.$on("closeAddModal",function(){n.isEdittingIpPool=!1,o.close(),i()});if(a)n.$emit("closeAddModal"),e.addAlert({type:"danger",content:a.data?"地址池修改失败："+a.data:"地址池修改失败"});else{var l=t.taskId;!function t(o){var a=r(function(){s.getTask(l).then(function(i){"SUCCESS"===i.data.state?(n.$emit("closeAddModal"),y().then(function(){e.addAlert({type:"success",content:"地址池修改成功"})}),r.cancel(a)):"FAILED"===i.data.state||"REJECTED"===i.data.state?(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data.reason?"地址池修改失败："+i.data.reason:"地址池修改失败"}),r.cancel(a)):("PENDING"===i.data.state,o>0?t(o-1):(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:"地址池修改超时"}),r.cancel(a)))})},1e3)}(30)}}))},n.cancel=function(){o.dismiss("cancel")}}a.$inject=["$scope","$modalInstance","IpPool","formatVal"];var l=n.open({templateUrl:"ip-pool-edit.html",size:"sm",controller:a});l.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},f.deleteIp=function(){var n=f.selectedItems,o=[];if(n)for(var a in n)n[a]&&o.push(a);if(0!==o.length){var i=t.defer();e.ipPoolDeleteTaskPromise=i.promise,c.deleteIpPool(o,function(t,n){if(n)e.addAlert({type:"danger",content:n.data?"地址池删除失败："+n.data:"地址池删除失败"}),i.resolve("fail");else{var o=t.taskId;!function t(n){var a=r(function(){s.getTask(o).then(function(o){"SUCCESS"===o.data.state?(y().then(function(){e.addAlert({type:"success",content:"地址池删除成功"})}),i.resolve("success"),r.cancel(a)):"FAILED"===o.data.state||"REJECTED"===o.data.state?(e.addAlert({type:"danger",content:o.data.reason?"地址池删除失败："+o.data.reason:"地址池删除失败"}),i.resolve("fail"),r.cancel(a)):("PENDING"===o.data.state,n>0?t(n-1):(e.addAlert({type:"danger",content:"地址池删除超时"}),i.resolve("timeout"),r.cancel(a)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条地址池"})}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/network_asset/ipPoolTable.5c886ec5.html",link:d};return u}function t(e,t,n,o,a,r,i,l,s,c){function d(i,d,u,p){function f(e){var t=e||{};return i.skip=e.$skip||0,c.getAll(t)}function m(e){var t=e||{};return c.getCount(t)}function g(e){return f(e)}function h(e){var t={};if(e){var n=e.split(",");n.forEach(function(e){t[e]=!0})}return t}var v=p;p.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:f,getCount:m,search:g,fields:["name","enable"],advancedSearch:"securityAreas",advancedSearchOptions:[{name:"name",display:"安全区域名",input:"string",option:!1,value:""},{name:"enable",display:"启动",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:!0,text:"开启"},{value:!1,text:"关闭"}]}]});var y=function(e){return a.go(a.current,e,{reload:!0,inherit:!1,notify:!0})};p.selectedItems={},p.selectAll=function(){p.selectedItems={},p.table.forEach(function(e){p.selectedItems[e.name]=p.selectAllValue})},p.selectedChanged=function(){var e=!0,t=!1,n=!1;p.table.forEach(function(o){n=void 0!==p.selectedItems[o.name]&&null!==p.selectedItems[o.name]&&p.selectedItems[o.name],t=t||n,e=e&&n}),p.selectAllValue=!!e||!!t&&null},i.privilegeName="OBJECT_ASSET";var I=l.get("privilege").filter(function(e){return e.name===i.privilegeName}),D=I&&I.length>0?I[0].actionValue:1;i.isNoEditPri=D<28,i.isSwitchArea={},i.switchAreaMsg={},p.changeStartStatus=function(t){var n=t.enable?"启动":"关闭";i.isSwitchArea[t.name]=!0,i.switchAreaMsg[t.name]=n,c.switchSecurityArea(t.securityAreaId,t.name,t.enable,function(o,a){if(a)i.isSwitchArea[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:a.data?"安全区域("+t.name+")"+n+"失败："+a.data:"安全区域("+t.name+")"+n+"失败"});else{var l=o.taskId;!function o(a){var c=r(function(){s.getTask(l).then(function(l){"SUCCESS"===l.data.state?(i.isSwitchArea[t.name]=!1,e.addAlert({type:"success",content:"安全区域("+t.name+")"+n+"成功"}),r.cancel(c)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(i.isSwitchArea[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:l.data.reason?"安全区域("+t.name+")"+n+"失败："+l.data.reason:"安全区域("+t.name+")"+n+"失败"}),r.cancel(c)):("PENDING"===l.data.state,a>0?o(a-1):(i.isSwitchArea[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:"安全区域("+t.name+")"+n+"超时"}),r.cancel(c)))})},1e3)}(30)}})},p.addNewSecurityArea=function(){function t(t,n,o,a){function i(e){var t=v.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}function l(e){return!(e&&!a.validateObjectAssetsName(e))}t.newSecurityArea={},t.selectedInterfaces={},t.isGettingInterfaces=!0,o.getInterfaces().then(function(e){t.briInterfaceNames=[],angular.isArray(e)&&e.forEach(function(e){"BRI"===e.interfaceType&&e.briInterfaceName&&Array.prototype.push.apply(t.briInterfaceNames,e.briInterfaceName.split(";"))});var n=[];e.map(function(e){"agl0"!==e.interfaceName&&"ha"!==e.interfaceName&&"SUB"!==e.interfaceType&&n.push(e)}),t.interfaces=n,t.isGettingInterfaces=!1},function(){t.isGettingInterfaces=!1}),t.checkNameVal=function(e){var n=l(e);return n?(n=i(e),n||(t.nameValMsg="已创建该名称的安全区域，请更换其他安全区域名称")):t.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',n},t.ok=function(a){if(a){t.newSecurityArea._interfaceNames=[];for(var i in t.selectedInterfaces)t.selectedInterfaces[i]&&t.newSecurityArea._interfaceNames.push(i);if(0===t.newSecurityArea._interfaceNames.length)return void e.addAlert({type:"danger",content:"安全区域添加失败,请选择接口!"});t.newSecurityArea._interfaceNames=t.newSecurityArea._interfaceNames.join(";"),t.isAddingArea=!0,o.addNewSecurityArea([t.newSecurityArea],function(o,a){var i=t.$on("closeAddModal",function(){t.isAddingArea=!1,n.close(),i()});if(a)t.$emit("closeAddModal"),e.addAlert({type:"danger",content:a.data?"安全区域添加失败："+a.data:"安全区域添加失败"});else{var l=o.taskId;!function n(o){var a=r(function(){s.getTask(l).then(function(i){"SUCCESS"===i.data.state?(t.$emit("closeAddModal"),y().then(function(){e.addAlert({type:"success",content:"安全区域添加成功"})}),r.cancel(a)):"FAILED"===i.data.state||"REJECTED"===i.data.state?(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data.reason?"安全区域添加失败："+i.data.reason:"安全区域添加失败"}),r.cancel(a)):("PENDING"===i.data.state,o>0?n(o-1):(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:"安全区域添加超时"}),r.cancel(a)))})},1e3)}(30)}})}},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","SecurityArea","formatVal"];var a=n.open({templateUrl:"security-area-add-new.html",size:"lg",controller:t});a.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.viewSecurityArea=function(e){function t(t,n){t.isViewOnly=!0,t.editSecurityArea=e,t.selectedInterfaces=h(e._interfaceNames),t.isGettingInterfaces=!0,c.getInterfaces().then(function(e){t.briInterfaceNames=[],angular.isArray(e)&&e.forEach(function(e){"BRI"===e.interfaceType&&e.briInterfaceName&&Array.prototype.push.apply(t.briInterfaceNames,e.briInterfaceName.split(";"))});var n=[];e.map(function(e){"agl0"!==e.interfaceName&&"ha"!==e.interfaceName&&"SUB"!==e.interfaceType&&n.push(e)}),t.interfaces=n,t.isGettingInterfaces=!1},function(){t.isGettingInterfaces=!1}),t.checkNameVal=function(){return!0},t.ok=function(){n.close()},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance"];var a=n.open({templateUrl:"security-area-edit.html",size:"lg",controller:t});a.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.editSecurityArea=function(t){function a(n,o,a,i){function l(e){var n=v.table,o=!0;return e&&n&&n.some(function(n){if(n.name===e&&n.name!==t.name)return o=!1,!0}),o}function c(e){return!(e&&!i.validateObjectAssetsName(e))}n.isEditDisabled=!0,n.editSecurityArea=angular.copy(t),n.selectedInterfaces=h(t._interfaceNames),n.isGettingInterfaces=!0,a.getInterfaces().then(function(e){n.briInterfaceNames=[],angular.isArray(e)&&e.forEach(function(e){"BRI"===e.interfaceType&&e.briInterfaceName&&Array.prototype.push.apply(n.briInterfaceNames,e.briInterfaceName.split(";"))});var t=[];e.map(function(e){"agl0"!==e.interfaceName&&"ha"!==e.interfaceName&&"SUB"!==e.interfaceType&&t.push(e)}),n.interfaces=t,n.isGettingInterfaces=!1},function(){n.isGettingInterfaces=!1}),n.checkNameVal=function(e){var t=c(e);return t?(t=l(e),t||(n.nameValMsg="已创建该名称的安全区域，请更换其他安全区域名称")):n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},n.ok=function(t){if(t){n.editSecurityArea._interfaceNames=[];for(var i in n.selectedInterfaces)n.selectedInterfaces[i]&&n.editSecurityArea._interfaceNames.push(i);if(0===n.editSecurityArea._interfaceNames.length)return void e.addAlert({type:"danger",content:"安全区域修改失败,请选择接口!"});n.editSecurityArea._interfaceNames=n.editSecurityArea._interfaceNames.join(";"),n.isEdittingArea=!0,a.updateSecurityArea([n.editSecurityArea],function(t,a){var i=n.$on("closeAddModal",function(){n.isEdittingArea=!1,o.close(),i()});if(a)n.$emit("closeAddModal"),e.addAlert({type:"danger",content:a.data?"安全区域修改失败："+a.data:"安全区域修改失败"});else{var l=t.taskId;!function t(o){var a=r(function(){s.getTask(l).then(function(i){"SUCCESS"===i.data.state?(n.$emit("closeAddModal"),y().then(function(){e.addAlert({type:"success",content:"安全区域修改成功"})}),r.cancel(a)):"FAILED"===i.data.state||"REJECTED"===i.data.state?(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data.reason?"安全区域修改失败："+i.data.reason:"安全区域修改失败"}),r.cancel(a)):("PENDING"===i.data.state,o>0?t(o-1):(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:"安全区域修改超时"}),r.cancel(a)))})},1e3)}(30)}})}},n.cancel=function(){o.dismiss("cancel")}}a.$inject=["$scope","$modalInstance","SecurityArea","formatVal"];var i=n.open({templateUrl:"security-area-edit.html",size:"lg",controller:a});i.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.deleteSecurityArea=function(){var n=p.selectedItems,o=[];if(n)for(var a in n)if(n[a])for(var i=0;i<p.table.length;i++)p.table[i].name===a&&o.push(a+","+p.table[i].securityAreaId);if(0!==o.length){var l=t.defer();e.secAreaDeleteTaskPromise=l.promise,c.deleteSecurityArea(o,function(t,n){if(n)e.addAlert({type:"danger",content:n.data?"安全区域删除失败："+n.data:"安全区域删除失败"}),l.resolve("fail");else{var o=t.taskId;!function t(n){var a=r(function(){s.getTask(o).then(function(o){"SUCCESS"===o.data.state?(y().then(function(){e.addAlert({type:"success",content:"安全区域删除成功"})}),l.resolve("success"),r.cancel(a)):"FAILED"===o.data.state||"REJECTED"===o.data.state?(e.addAlert({type:"danger",content:o.data.reason?"安全区域删除失败："+o.data.reason:"安全区域删除失败"}),l.resolve("fail"),r.cancel(a)):("PENDING"===o.data.state,n>0?t(n-1):(e.addAlert({type:"danger",content:"安全区域删除超时"}),l.resolve("timeout"),r.cancel(a)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条安全区域"})}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/network_asset/securityAreaTable.332a351f.html",link:d};return u}function n(e,t,n,o,a,r,i,l){function s(s,c,d,u){function p(e){var t=e||{};return s.skip=e.$skip||0,l.getAll(t)}function f(e){var t=e||{};return l.getCount(t)}function m(e){return p(e)}function g(e){var t=[{value:"-1",text:"全部"}];return angular.isArray(e)&&e.forEach(function(e){t.push({value:e,text:e})}),t}function h(e){var t=u.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}function v(e){return!(e&&!r.validateObjectAssetsName(e))}t.all([l.getSecurityAreaNames(),l.getTypes()]).then(function(e){u.securityareas=e[0],s.types=e[1],u.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:p,getCount:f,search:m,fields:["name","kind","make","model","ipAddress","macAddress","securityAreaName","inputType","enable"],advancedSearch:"deviceAssets",advancedSearchOptions:[{name:"name",display:"名称",input:"string",option:!1,value:""},{name:"kind",display:"类型",input:"checkbox",option:!0,parser:"string",options:g(s.types)},{name:"make",display:"厂商",input:"string",option:!1,value:""},{name:"model",display:"型号",input:"string",option:!1,value:""},{name:"ipAddress",display:"IP地址",input:"string",option:!1,value:""},{name:"macAddress",display:"MAC地址",input:"string",option:!1,value:""},{name:"securityAreaName",display:"安全区域",input:"checkbox",option:!0,parser:"string",options:g(u.securityareas)},{name:"inputType",display:"录入方式",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:0,text:"手动"},{value:1,text:"自动"}]},{name:"enable",display:"启动",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:!0,text:"开启"},{value:!1,text:"关闭"}]}]})});var y=function(e){return n.go(n.current,e,{reload:!0,inherit:!1,notify:!0})};u.selectedItems={},u.selectAll=function(){u.selectedItems={},u.table.forEach(function(e){u.selectedItems[e.name]=u.selectAllValue})},u.selectedChanged=function(){var e=!0,t=!1,n=!1;u.table.forEach(function(o){n=void 0!==u.selectedItems[o.name]&&null!==u.selectedItems[o.name]&&u.selectedItems[o.name],t=t||n,e=e&&n}),u.selectAllValue=!!e||!!t&&null},s.privilegeName="OBJECT_ASSET";var I=i.get("privilege").filter(function(e){return e.name===s.privilegeName}),D=I&&I.length>0?I[0].actionValue:1;s.isNoEditPri=D<28,s.isSwitchAction={},s.switchActionMsg={},u.changeStartStatus=function(t){var n=t.enable?"启动":"关闭";s.isSwitchAction[t.name]=!0,s.switchActionMsg[t.name]=n,l.switchDeviceAsset(t.assetId,t.name,t.enable,function(r,i){if(i)s.isSwitchAction[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:i.data?"设备资产("+t.name+")"+n+"失败："+i.data:"设备资产("+t.name+")"+n+"失败"});else{var l=r.taskId;!function r(i){var c=o(function(){a.getTask(l).then(function(a){"SUCCESS"===a.data.state?(s.isSwitchAction[t.name]=!1,e.addAlert({type:"success",content:"设备资产("+t.name+")"+n+"成功"}),o.cancel(c)):"FAILED"===a.data.state||"REJECTED"===a.data.state?(s.isSwitchAction[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:a.data.reason?"设备资产("+t.name+")"+n+"失败："+a.data.reason:"设备资产("+t.name+")"+n+"失败"}),o.cancel(c)):("PENDING"===a.data.state,i>0?r(i-1):(s.isSwitchAction[t.name]=!1,t.enable=!t.enable,e.addAlert({type:"danger",content:"设备资产("+t.name+")"+n+"超时"}),o.cancel(c)))})},1e3)}(30)}})},s.checkNameVal=function(e){var t=v(e);return t?(t=h(e),t||(s.nameValMsg="已创建该名称的设备资产")):s.nameValMsg="支持中文、字母、数字等组合3-20个字符",t},s.checkIpVal=function(e){if(e.split("/").length>1)return!1;if(e&&r.validateIpRange(e)){var t=e.split("/");if(!angular.isArray(t)||2!==t.length)return!1;var n=t[0],o=t[1];if(r.validateIp(n)||r.validateNetMask(o))return!1}return!0},s.checkMacVal=function(e){if(e){var t=!r.validateMac(e);return t&&(t=1!==("0x"+e.slice(0,2)&1)),t}return!0},u.addNewDeviceAsset=function(){s.isAddDeviceAsset=!0,s.isEditDeviceAssetId="",s.newDeviceAsset={},s.newDeviceAsset.securityAreaName=u.securityareas&&u.securityareas.length>0?u.securityareas[0]:"",s.newDeviceAsset.kind="",s.newDeviceAsset.macAddress="00:00:00:00:00:00",s.$watch("newDeviceAsset.kind",function(e){var t=e;l.getFactories(t).then(function(e){s.factories=e,s.newDeviceAsset.make="",s.manualFactory()})}),s.$watch("newDeviceAsset.make",function(e,t){if(e!==t){var n=e;l.getModels(s.newDeviceAsset.kind,n).then(function(e){s.models=e,s.newDeviceAsset.model=s.models&&s.models.length>0?s.models[0]:"",s.manualModel()})}}),s.manualType=function(){s.newDeviceAsset.kind?s.newDeviceAsset.manual_kind=!1:s.newDeviceAsset.manual_kind=!0},s.manualFactory=function(){s.newDeviceAsset.make?s.newDeviceAsset.manual_make=!1:s.newDeviceAsset.manual_make=!0},s.manualModel=function(){s.newDeviceAsset.model?s.newDeviceAsset.manual_model=!1:s.newDeviceAsset.manual_model=!0},u.ok=function(t){t&&(delete s.newDeviceAsset.manual_kind,delete s.newDeviceAsset.manual_make,delete s.newDeviceAsset.manual_model,s.isAddingDeviceAsset=!0,l.addNewDeviceAsset([s.newDeviceAsset],function(t,n){if(n)e.addAlert({type:"danger",content:n.data?"设备资产添加失败："+n.data:"设备资产添加失败"}),s.isAddingDeviceAsset=!1;else{var r=t.taskId;!function t(n){var i=o(function(){a.getTask(r).then(function(a){"SUCCESS"===a.data.state?(y().then(function(){e.addAlert({type:"success",content:"设备资产添加成功"})}),s.isAddingDeviceAsset=!1,o.cancel(i)):"FAILED"===a.data.state||"REJECTED"===a.data.state?(e.addAlert({type:"danger",content:a.data.reason?"设备资产添加失败："+a.data.reason:"设备资产添加失败"}),s.isAddingDeviceAsset=!1,o.cancel(i)):("PENDING"===a.data.state,n>0?t(n-1):(e.addAlert({type:"danger",content:"设备资产添加超时"}),s.isAddingDeviceAsset=!1,o.cancel(i)))})},1e3)}(30)}}))},u.cancel=function(){s.isAddDeviceAsset=!1}},u.editDeviceAsset=function(t){s.isAddDeviceAsset=!1,s.isEditDeviceAssetId=t.assetId,s.editDeviceAsset=angular.copy(t),s.editInputInfo={},s.editInputInfo.manual_kind=!1,s.editInputInfo.manual_make=!1,s.editInputInfo.manual_model=!1;var n=s.types.filter(function(e){return e===s.editDeviceAsset.kind});void 0!==n&&null!==n&&n.length>0?(n=n[0],l.getFactories(n).then(function(e){s.factories=e;
var t=e.filter(function(e){return e===s.editDeviceAsset.make});void 0!==t&&null!==t&&t.length>0?(t=t[0],l.getModels(s.editDeviceAsset.kind,t).then(function(e){s.models=e;var t=e.filter(function(e){return e===s.editDeviceAsset.model});void 0!==t&&null!==t&&t.length>0?(s.models=e,t=t[0]):(s.editInputInfo.manual_model=!0,s.editInputInfo.editInputModel=s.editDeviceAsset.model)})):(s.editInputInfo.manual_make=!0,s.editInputInfo.manual_model=!0,s.editInputInfo.editInputMake=s.editDeviceAsset.make,s.editInputInfo.editInputModel=s.editDeviceAsset.model)})):(s.editInputInfo.editInputKind=s.editDeviceAsset.kind,s.editInputInfo.editInputMake=s.editDeviceAsset.make,s.editInputInfo.editInputModel=s.editDeviceAsset.model,s.editInputInfo.manual_kind=!0,s.editInputInfo.manual_make=!0,s.editInputInfo.manual_model=!0),s.manualType=function(){s.editDeviceAsset.kind?(s.editInputInfo.manual_kind=!1,l.getFactories(s.editDeviceAsset.kind).then(function(e){s.factories=e,s.editDeviceAsset.make=s.factories&&s.factories.length>0?s.factories[0]:"",s.manualFactory()})):(s.factories=[],s.editInputInfo.manual_kind=!0,s.editInputInfo.manual_make=!0,s.editInputInfo.manual_model=!0)},s.manualFactory=function(){s.editDeviceAsset.make?(s.editInputInfo.manual_make=!1,l.getModels(s.editDeviceAsset.kind,s.editDeviceAsset.make).then(function(e){s.models=e,s.editDeviceAsset.model=s.models&&s.models.length>0?s.models[0]:"",s.manualModel()})):(s.models=[],s.editInputInfo.manual_make=!0,s.editInputInfo.manual_model=!0)},s.manualModel=function(){s.editDeviceAsset.model?s.editInputInfo.manual_model=!1:s.editInputInfo.manual_model=!0},u.ok=function(t){t&&(s.editInputInfo.manual_kind&&(s.editDeviceAsset.kind=s.editInputInfo.editInputKind),s.editInputInfo.manual_make&&(s.editDeviceAsset.make=s.editInputInfo.editInputMake),s.editInputInfo.manual_model&&(s.editDeviceAsset.model=s.editInputInfo.editInputModel),s.isEdittingDeviceAsset=!0,l.updateDeviceAsset([s.editDeviceAsset],function(t,n){if(n)e.addAlert({type:"danger",content:n.data?"设备资产修改失败："+n.data:"设备资产修改失败"}),s.isEdittingDeviceAsset=!1;else{var r=t.taskId;!function t(n){var i=o(function(){a.getTask(r).then(function(a){"SUCCESS"===a.data.state?(y().then(function(){e.addAlert({type:"success",content:"设备资产修改成功"})}),s.isEdittingDeviceAsset=!1,o.cancel(i)):"FAILED"===a.data.state||"REJECTED"===a.data.state?(e.addAlert({type:"danger",content:a.data.reason?"设备资产修改失败："+a.data.reason:"设备资产修改失败"}),s.isEdittingDeviceAsset=!1,o.cancel(i)):("PENDING"===a.data.state,n>0?t(n-1):(e.addAlert({type:"danger",content:"设备资产修改超时"}),s.isEdittingDeviceAsset=!1,o.cancel(i)))})},1e3)}(30)}}))},u.cancel=function(){s.isEditDeviceAssetId=""}},u.deleteDeviceAsset=function(){var n=u.selectedItems,r=[];if(n)for(var i in n)if(n[i])for(var s=0;s<u.table.length;s++)u.table[s].name===i&&r.push(i+","+u.table[s].securityAreaName+","+u.table[s].assetId);if(0!==r.length){var c=t.defer();e.dvcAssetTask.promise=c.promise,e.dvcAssetTask.message="设备资产删除中，请稍侯...",l.deleteDeviceAsset(r,function(t,n){if(n)e.addAlert({type:"danger",content:n.data?"设备资产删除失败："+n.data:"设备资产删除失败"}),c.resolve("fail");else{var r=t.taskId;!function t(n){var i=o(function(){a.getTask(r).then(function(a){"SUCCESS"===a.data.state?(y().then(function(){e.addAlert({type:"success",content:"设备资产删除成功"})}),c.resolve("success"),o.cancel(i)):"FAILED"===a.data.state||"REJECTED"===a.data.state?(e.addAlert({type:"danger",content:a.data.reason?"设备资产删除失败："+a.data.reason:"设备资产删除失败"}),c.resolve("fail"),o.cancel(i)):("PENDING"===a.data.state,n>0?t(n-1):(e.addAlert({type:"danger",content:"设备资产删除超时"}),c.resolve("timeout"),o.cancel(i)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条设备资产"})}}var c={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/network_asset/deviceAssetTable.85087b3b.html",link:s};return c}e.$inject=["$rootScope","$q","$modal","$log","$state","$timeout","$filter","Enum","Task","IpPool"],t.$inject=["$rootScope","$q","$modal","$log","$state","$timeout","$filter","Enum","Task","SecurityArea"],n.$inject=["$rootScope","$q","$state","$timeout","Task","formatVal","Enum","DeviceAsset"],angular.module("southWest.object.network_asset").directive("ipPoolTable",e).directive("securityAreaTable",t).directive("deviceAssetTable",n)}(),function(){"use strict";function e(e){e.state("object",{abstract:!0,parent:"dashboard",url:"/network",controller:"ObjectCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html"})}e.$inject=["$stateProvider"],angular.module("southWest.object").config(e)}(),function(){"use strict";function e(e,t,n){var o=this;o.prefixId="object",o.subMenus=e.rootMenu.getChild("OBJECT"),o.subMenus.getChilds().some(function(t){if(e.isSubMenusActive(t))return e.displaySubMenus(t),t.expanded=!0,!0}),o.entry=function(e,t){o.currentTarget=t,o.currentState=e,"ip_pool"===e?n.go("object.networkassets.ippool"):"security_domain"===e?n.go("object.networkassets.securitydomain"):"device_assets"===e?n.go("object.networkassets.device"):"svc_predefine"===e?n.go("object.service.predefine"):"svc_define"===e?n.go("object.service.define"):"app_predefine"===e?n.go("object.app.predefine"):"app_define"===e?n.go("object.app.define"):n.go("object."+e)},o.isActive=function(e){return n.current.name.indexOf(e.getState())>-1},o.expanded="true"===localStorage.getItem("object:navbar:expanded"),o.toggleExpand=function(){o.expanded=!o.expanded,localStorage.setItem("object:navbar:expanded",o.expanded)}}e.$inject=["$rootScope","$scope","$state"],angular.module("southWest.object").controller("ObjectCtrl",e)}(),function(){"use strict";function e(e){e.state("object.schedule",{url:"/schedule",controller:"ScheduleCtrl",templateUrl:"templates/object/schedule/index.80b4efef.html",resolve:{state:["$rootScope",function(e){e.currentState="OBJECT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.object.schedule").config(e)}(),function(){"use strict";function e(){}angular.module("southWest.object.schedule").controller("ScheduleCtrl",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s){function c(c,d,u,p){function f(e){var t=e||{};return c.skip=e.$skip||0,s.getAll(t)}function m(e){var t=e||{};return s.getCount(t)}function g(e){return f(e)}var h=p;p.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:f,getCount:m,search:g,fields:["name","type","description"],advancedSearch:"times",advancedSearchOptions:[{name:"name",display:"名称",input:"string",option:!1,value:""},{name:"start",display:"开始",input:"timerange",option:!0,value:[],options:[]},{name:"finish",display:"结束",input:"timerange",option:!0,value:[],options:[]},{name:"type",display:"循环",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:"LOOP",text:"是"},{value:"ONCE",text:"否"}]},{name:"description",display:"描述",input:"string",option:!1,value:""}]}),p.selectedItems={},p.selectAll=function(){p.selectedItems={},p.table.forEach(function(e){p.selectedItems[e.name]=p.selectAllValue})},c.privilegeName="OBJECT_SCHEDULE";var v=i.get("privilege").filter(function(e){return e.name===c.privilegeName}),y=v&&v.length>0?v[0].actionValue:1;c.isNoEditPri=y<28,p.addSingleSchedule=function(){function t(t,n,o,i){function s(e){var t=h.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}function c(e){return!(e&&!i.validateShortName(e))}var d=moment(e.currentTime).milliseconds(0).toDate(),u=moment(e.currentTime).add(1,"days").milliseconds(0).toDate();t.newSchedule={startDate:d,startTime:d,endDate:u,endTime:u},t.checkNameVal=function(e){var n=c(e);return n?(n=s(e),n||(t.nameValMsg="已创建该名称的时间表，请更换其他时间表名称")):t.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，2-20个字符',n},t.invalidStartDateTime="",t.invalidEndDateTime="",t.checkDateTimeVal=function(n){var o=t.newSchedule,a=moment(o.startDate).format("YYYY-MM-DD")+"T"+moment(o.startTime).format("HH:mm:ss");a=moment(a).utc().format();var r=moment(o.endDate).format("YYYY-MM-DD")+"T"+moment(o.endTime).format("HH:mm:ss");r=moment(r).utc().format();var i=moment(e.currentTime).utc().format();t.invalidStartDateTime="",t.invalidEndDateTime="","Invalid date"===a&&(t.invalidStartDateTime="开始日期/时间不合法"),"Invalid date"===r&&(t.invalidEndDateTime="结束日期/时间不合法"),0===t.invalidStartDateTime.length&&0===t.invalidEndDateTime.length&&(a>=r&&("startdate"===n||"starttime"===n?t.invalidStartDateTime="开始时间要在结束时间之前":"enddate"!==n&&"endtime"!==n||(t.invalidEndDateTime="结束时间要在开始时间之后")),a<i&&(t.invalidStartDateTime="开始时间不可在当前时间之前"),r<i&&(t.invalidEndDateTime="结束时间不可在当前时间之前"))},t.ok=function(i){if(i){var s=angular.copy(t.newSchedule);s.start=moment(s.startDate).format("YYYY-MM-DD")+"T"+moment(s.startTime).format("HH:mm:ss"),s.finish=moment(s.endDate).format("YYYY-MM-DD")+"T"+moment(s.endTime).format("HH:mm:ss"),delete s.startDate,delete s.startTime,delete s.endDate,delete s.endTime,t.isAddingSchedule=!0,o.addSingleSchedule([s],function(o,i){var s=t.$on("closeAddModal",function(){t.isAddingSchedule=!1,n.close(),s()});if(i)t.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"时间表添加失败："+i.data:"时间表添加失败"});else{var c=o.taskId;!function n(o){var i=r(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(t.$emit("closeAddModal"),a.reload().then(function(){e.addAlert({type:"success",content:"时间表添加成功"})}),r.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"时间表添加失败："+l.data.reason:"时间表添加失败"}),r.cancel(i)):("PENDING"===l.data.state,o>0?n(o-1):(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:"时间表添加超时"}),r.cancel(i)))})},1e3)}(30)}})}},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","ObjectSchedule","formatVal"];var i=n.open({templateUrl:"object-schedule-single-new.html",size:"sm",controller:t});i.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.viewSingleSchedule=function(e){function t(t,n){t.isViewOnly=!0,t.editSchedule=e;var o=new Date(t.editSchedule.start),a=new Date(t.editSchedule.finish);t.editSchedule.startDate=o,t.editSchedule.startTime=o,t.editSchedule.endDate=a,t.editSchedule.endTime=a,t.checkNameVal=function(){return!0},t.invalidStartDateTime="",t.invalidEndDateTime="",t.checkDateTimeVal=function(){},t.ok=function(){n.close()},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance"];var a=n.open({templateUrl:"object-schedule-single-edit.html",size:"sm",controller:t});a.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.editSingleSchedule=function(t){function i(n,o,i,s){function c(e){var n=h.table,o=!0;return e&&n&&n.some(function(n){if(n.name===e&&e!==t.name)return o=!1,!0}),o}function d(e){return!(e&&!s.validateShortName(e))}n.editSchedule=angular.copy(t);var u=new Date(n.editSchedule.start),p=new Date(n.editSchedule.finish);n.editSchedule.startDate=u,n.editSchedule.startTime=u,n.editSchedule.endDate=p,n.editSchedule.endTime=p,n.checkNameVal=function(e){var t=d(e);return t?(t=c(e),t||(n.nameValMsg="已创建该名称的时间表，请更换其他时间表名称")):n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，2-20个字符',t},n.invalidStartDateTime="",n.invalidEndDateTime="",n.checkDateTimeVal=function(t){var o=n.editSchedule,a=moment(o.startDate).format("YYYY-MM-DD")+"T"+moment(o.startTime).format("HH:mm:ss");a=moment(a).utc().format();var r=moment(o.endDate).format("YYYY-MM-DD")+"T"+moment(o.endTime).format("HH:mm:ss");r=moment(r).utc().format();var i=moment(e.currentTime).utc().format();n.invalidStartDateTime="",n.invalidEndDateTime="","Invalid date"===a&&(n.invalidStartDateTime="开始日期/时间不合法"),"Invalid date"===r&&(n.invalidEndDateTime="结束日期/时间不合法"),0===n.invalidStartDateTime.length&&0===n.invalidEndDateTime.length&&(a>=r&&("startdate"===t||"starttime"===t?n.invalidStartDateTime="开始时间要在结束时间之前":"enddate"!==t&&"endtime"!==t||(n.invalidEndDateTime="结束时间要在开始时间之后")),a<i&&(n.invalidStartDateTime="开始时间不可在当前时间之前"),r<i&&(n.invalidEndDateTime="结束时间不可在当前时间之前"))},n.ok=function(t){if(t){var s=angular.copy(n.editSchedule);s.start=moment(s.startDate).format("YYYY-MM-DD")+"T"+moment(s.startTime).format("HH:mm:ss"),s.finish=moment(s.endDate).format("YYYY-MM-DD")+"T"+moment(s.endTime).format("HH:mm:ss"),delete s.startDate,delete s.startTime,delete s.endDate,delete s.endTime,n.isEdittingSchedule=!0,s.type="ONCE",i.updateSchedule([s],function(t,i){var s=n.$on("closeAddModal",function(){n.isEdittingSchedule=!1,o.close(),s()});if(i)n.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"时间表修改失败："+i.data:"时间表修改失败"});else{var c=t.taskId;!function t(o){var i=r(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(n.$emit("closeAddModal"),a.reload().then(function(){e.addAlert({type:"success",content:"时间表修改成功"})}),r.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"时间表修改失败："+l.data.reason:"时间表修改失败"}),r.cancel(i)):("PENDING"===l.data.state,o>0?t(o-1):(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:"时间表修改超时"}),r.cancel(i)))})},1e3)}(30)}})}},n.cancel=function(){o.dismiss("cancel")}}i.$inject=["$scope","$modalInstance","ObjectSchedule","formatVal"];var s=n.open({templateUrl:"object-schedule-single-edit.html",size:"sm",controller:i});s.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.addLoopSchedule=function(){function t(t,n,o,i){function s(e){var t=h.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}function c(e){return!(e&&!i.validateShortName(e))}var d=moment(e.currentTime).milliseconds(0).toDate(),u=moment(e.currentTime).add(1,"hours").milliseconds(0).toDate();t.newSchedule={startTime:d,endTime:u},t.loop={},t.checkNameVal=function(e){var n=c(e);return n?(n=s(e),n||(t.nameValMsg="已创建该名称的时间表，请更换其他时间表名称")):t.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，2-20个字符',n},t.invalidStartTime="",t.invalidEndTime="",t.checkTimeVal=function(e){var n=t.newSchedule,o=moment(n.startTime).utc().format(),a=moment(n.endTime).utc().format();t.invalidStartTime="",t.invalidEndTime="","Invalid date"===o&&(t.invalidStartTime="开始时间不合法"),"Invalid date"===a&&(t.invalidEndTime="结束时间不合法"),0===t.invalidStartTime.length&&0===t.invalidEndTime.length&&o>=a&&("starttime"===e?t.invalidStartTime="开始时间要在结束时间之前":"endtime"===e&&(t.invalidEndTime="结束时间要在开始时间之后"))},t.loopValMsg="",t.$watch("[loop.mon, loop.tue, loop.wed, loop.thu, loop.fri, loop.sat, loop.sun]",function(){t.isLoopChecked=!1;for(var e in t.loop)if(t.loop[e]){t.isLoopChecked=!0;break}}),t.ok=function(i){if(t.loopValMsg="",i){if(!t.isLoopChecked)return void(t.loopValMsg="请选择循环周期");var s=angular.copy(t.newSchedule);s.start=moment(s.startTime).format("HH:mm:ss"),s.finish=moment(s.endTime).format("HH:mm:ss"),delete s.startTime,delete s.endTime,angular.merge(s,t.loop),t.isAddingSchedule=!0,o.addLoopSchedule([s],function(o,i){var s=t.$on("closeAddModal",function(){t.isAddingSchedule=!1,n.close(),s()});if(i)t.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"时间表添加失败："+i.data:"时间表添加失败"});else{var c=o.taskId;!function n(o){var i=r(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(t.$emit("closeAddModal"),a.reload().then(function(){e.addAlert({type:"success",content:"时间表添加成功"})}),r.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"时间表添加失败："+l.data.reason:"时间表添加失败"}),r.cancel(i)):("PENDING"===l.data.state,o>0?n(o-1):(t.$emit("closeAddModal"),e.addAlert({type:"danger",content:"时间表添加超时"}),r.cancel(i)))})},1e3)}(30)}})}},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","ObjectSchedule","formatVal"];var i=n.open({templateUrl:"object-schedule-loop-new.html",size:"sm",controller:t});i.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.viewLoopSchedule=function(e){function t(t,n){t.isViewOnly=!0,t.editSchedule=e,t.editSchedule.startTime=new Date(t.editSchedule.start),t.editSchedule.endTime=new Date(t.editSchedule.finish),t.loop={mon:t.editSchedule.mon,tue:t.editSchedule.tue,wed:t.editSchedule.wed,thu:t.editSchedule.thu,fri:t.editSchedule.fri,sat:t.editSchedule.sat,sun:t.editSchedule.sun},t.checkNameVal=function(){return!0},t.invalidStartTime="",t.invalidEndTime="",t.checkTimeVal=function(){},t.loopValMsg="",t.ok=function(){n.close()},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance"];var a=n.open({templateUrl:"object-schedule-loop-edit.html",size:"sm",controller:t});a.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.editLoopSchedule=function(t){function i(n,o,i,s){function c(e){var n=h.table,o=!0;return e&&n&&n.some(function(n){if(n.name===e&&e!==t.name)return o=!1,!0}),o}function d(e){return!(e&&!s.validateShortName(e))}n.editSchedule=angular.copy(t),n.editSchedule.startTime=new Date(n.editSchedule.start),n.editSchedule.endTime=new Date(n.editSchedule.finish),n.loop={},n.checkNameVal=function(e){var t=d(e);return t?(t=c(e),t||(n.nameValMsg="已创建该名称的时间表，请更换其他时间表名称")):n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，2-20个字符',t},n.invalidStartTime="",n.invalidEndTime="",n.checkTimeVal=function(e){var t=n.editSchedule,o=moment(t.startTime).utc().format(),a=moment(t.endTime).utc().format();n.invalidStartTime="",n.invalidEndTime="","Invalid date"===o&&(n.invalidStartTime="开始时间不合法"),"Invalid date"===a&&(n.invalidEndTime="结束时间不合法"),0===n.invalidStartTime.length&&0===n.invalidEndTime.length&&o>=a&&("starttime"===e?n.invalidStartTime="开始时间要在结束时间之前":"endtime"===e&&(n.invalidEndTime="结束时间要在开始时间之后"))},n.loopValMsg="",n.$watch("[loop.mon, loop.tue, loop.wed, loop.thu, loop.fri, loop.sat, loop.sun]",function(){n.isLoopChecked=!1;for(var e in n.loop)if(n.loop[e]){n.isLoopChecked=!0;break}}),n.loop={mon:n.editSchedule.mon,tue:n.editSchedule.tue,wed:n.editSchedule.wed,thu:n.editSchedule.thu,fri:n.editSchedule.fri,sat:n.editSchedule.sat,sun:n.editSchedule.sun},n.ok=function(t){if(n.loopValMsg="",t){if(!n.isLoopChecked)return void(n.loopValMsg="请选择循环周期");var s=angular.copy(n.editSchedule);s.start=moment(s.startTime).format("HH:mm:ss"),s.finish=moment(s.endTime).format("HH:mm:ss"),delete s.startTime,delete s.endTime,angular.merge(s,n.loop),n.isEdittingSchedule=!0,s.type="LOOP",i.updateSchedule([s],function(t,i){var s=n.$on("closeAddModal",function(){n.isEdittingSchedule=!1,o.close(),s()});if(i)n.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"时间表修改失败："+i.data:"时间表修改失败"});else{var c=t.taskId;!function t(o){var i=r(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(n.$emit("closeAddModal"),a.reload().then(function(){e.addAlert({type:"success",content:"时间表修改成功"})}),r.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"时间表修改失败："+l.data.reason:"时间表修改失败"}),r.cancel(i)):("PENDING"===l.data.state,o>0?t(o-1):(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:"时间表修改超时"}),r.cancel(i)))})},1e3)}(30)}})}},n.cancel=function(){o.dismiss("cancel")}}i.$inject=["$scope","$modalInstance","ObjectSchedule","formatVal"];var s=n.open({templateUrl:"object-schedule-loop-edit.html",size:"sm",controller:i});s.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},p.deleteSchedule=function(){var n=p.selectedItems,o=[];if(n)for(var i in n)n[i]&&o.push(i);if(0!==o.length){var c=t.defer();e.scheduleDeleteTaskPromise=c.promise,s.deleteSchedule(o,function(t,n){if(n)e.addAlert({type:"danger",content:n.data?"时间表删除失败："+n.data:"时间表删除失败"}),c.resolve("fail");else{var o=t.taskId;!function t(n){var i=r(function(){l.getTask(o).then(function(o){"SUCCESS"===o.data.state?(a.reload().then(function(){e.addAlert({type:"success",content:"时间表删除成功"})}),c.resolve("success"),r.cancel(i)):"FAILED"===o.data.state||"REJECTED"===o.data.state?(e.addAlert({type:"danger",content:o.data.reason?"时间表删除失败："+o.data.reason:"时间表删除失败"}),c.resolve("fail"),r.cancel(i)):("PENDING"===o.data.state,n>0?t(n-1):(e.addAlert({type:"danger",content:"时间表删除超时"}),c.resolve("timeout"),r.cancel(i)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条时间表"})}}var d={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/schedule/scheduleTable.166140fb.html",link:c};return d}e.$inject=["$rootScope","$q","$modal","$log","$state","$timeout","Enum","Task","ObjectSchedule"],angular.module("southWest.object.schedule").directive("objectScheduleTable",e)}(),function(){"use strict";function e(e){e.state("object.service_predefined",{url:"/service/predefined",controller:"SvcPredefineCtrl as svcPre",templateUrl:"templates/object/service/predefine.c889c254.html",resolve:{state:["$rootScope",function(e){e.currentState="OBJECT"}]}}).state("object.service_customizedefined",{url:"/service/customizedefined",controller:"SvcCustomizeCtrl as svcCus",templateUrl:"templates/object/service/customize.aa494705.html",resolve:{state:["$rootScope",function(e){e.currentState="OBJECT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.object.service").config(e)}(),function(){"use strict";function e(){}function t(){}angular.module("southWest.object.service").controller("SvcPredefineCtrl",e).controller("SvcCustomizeCtrl",t)}(),function(){"use strict";function e(e){function t(t,n,o,a){function r(n){var o=n||{};return t.skip=n.$skip||0,e.getAll(o)}function i(t){var n=t||{};return e.getCount(n)}function l(e){return r(e)}a.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:r,getCount:i,search:l,fields:["name","description"],advancedSearch:"predefineServers",advancedSearchOptions:[{name:"name",display:"服务名称",input:"string",option:!1,value:""},{name:"description",display:"描述",input:"string",option:!1,value:""},{name:"createdBy",display:"端口",input:"string",option:!1,value:""}]}),a.selectedItems={},a.selectAll=function(){a.selectedItems={},a.table.forEach(function(e){a.selectedItems[e.name]=a.selectAllValue})}}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/service/predefineTable.d36ab05a.html",link:t};return n}function t(e,t,n,o,a,r,i,l,s){function c(c,d,u,p){function f(e){var t=e||{};return c.skip=e.$skip||0,s.getAll(t)}function m(e){var t=e||{};return s.getCount(t)}function g(e){return f(e)}p.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:f,getCount:m,search:g,fields:["name","description"],advancedSearch:"customizedServers",advancedSearchOptions:[{name:"name",display:"服务名称",input:"string",option:!1,value:""},{name:"description",display:"描述",input:"string",option:!1,value:""},{name:"createdBy",display:"端口",input:"string",option:!1,value:""}]}),p.selectedItems={},p.selectAll=function(){p.selectedItems={},p.table.forEach(function(e){p.selectedItems[e.name]=p.selectAllValue})},p.selectedChanged=function(){var e=!0,t=!1,n=!1;p.table.forEach(function(o){n=void 0!==p.selectedItems[o.name]&&null!==p.selectedItems[o.name]&&p.selectedItems[o.name],t=t||n,e=e&&n}),p.selectAllValue=!!e||!!t&&null},c.privilegeName="OBJECT_SERVICE";var h=i.get("privilege").filter(function(e){return e.name===c.privilegeName}),v=h&&h.length>0?h[0].actionValue:1;c.isNoEditPri=v<28,p.addNewService=function(){function n(n,a,r,i){function s(e){var t=p.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}function c(e){return!(e&&!i.validateObjectAssetsName(e))}function d(e,t,n){return!e||!(i.validatePort(e)||Number(e)<1)||!(!t||"ANY"!==e.toUpperCase()||"ANY"===n)}n.newService={},n.newRule={type:"TCP"},n.rules=[],n.checkNameVal=function(e){var t=c(e);return t?(t=s(e),t||(n.nameValMsg="已定义该名称的服务，请更换其他服务名称")):n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},n.checkDestPortVal=function(e,t){n.isDestPortsInvalid=!1;var o=t<=0,a=n.newRule.minDstPort,r=n.newRule.maxDstPort,i=n.newRule.minSrcPort?n.newRule.minSrcPort.toUpperCase():"",l=!a||d(a,!0,i),s=!r||d(r,!1),c=l&&s;return c?a&&r&&Number(a)>Number(r)&&(n.isDestPortsInvalid=!0,n.destPortValMsg="端口输入不合法,最大端口不能小于最小端口"):(n.destPortValMsg="请输入有效"+(l?s?"":"最大":"最小")+"端口号",(o&&l||!o&&s)&&(c=!0)),c},n.checkSourcePortVal=function(e,t){n.isSourcePortsInvalid=!1;var o=t<=0,a=n.newRule.minSrcPort,r=n.newRule.maxSrcPort,i=n.newRule.minDstPort?n.newRule.minDstPort.toUpperCase():"",l=!a||d(a,!0,i),s=!r||d(r,!1),c=l&&s;return c?a&&r&&Number(a)>Number(r)&&(n.isSourcePortsInvalid=!0,n.sourcePortValMsg="端口输入不合法,最大端口不能小于最小端口"):(n.sourcePortValMsg="请输入有效"+(l?s?"":"最大":"最小")+"端口号",(o&&l||!o&&s)&&(c=!0)),c},n.$watch("[newRule.minSrcPort, newRule.minDstPort]",function(e){e[0]&&"ANY"===e[0].toUpperCase()?(n.newRule.maxSrcPort="",n.srcMaxPortHide=!0):n.srcMaxPortHide=!1,e[1]&&"ANY"===e[1].toUpperCase()?(n.newRule.maxDstPort="",n.destMaxPortHide=!0):n.destMaxPortHide=!1}),n.$watch("[newRule.minSrcPort, newRule.minDstPort, newRule.maxSrcPort, newRule.maxDstPort]",function(e){e[0]&&"ANY"!==e[0].toUpperCase()&&!e[2]&&(n.newRule.maxSrcPort=e[0]),e[2]&&"ANY"!==e[2].toUpperCase()&&!e[0]&&(n.newRule.minSrcPort=e[2]),e[1]&&"ANY"!==e[1].toUpperCase()&&!e[3]&&(n.newRule.maxDstPort=e[1]),e[3]&&"ANY"!==e[3].toUpperCase()&&!e[1]&&(n.newRule.minDstPort=e[3])}),n.addNewRule=function(e){if(e){var t=angular.copy(n.newRule);n.rules.push(t)}},n.deleteRule=function(e){n.rules.splice(e,1)},n.ok=function(i){i&&(n.newService.serverRules=n.rules,n.isAddingService=!0,r.addNewService([n.newService],function(r,i){var s=n.$on("closeAddModal",function(){n.isAddingService=!1,a.close(),s()});if(i)n.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"自定义服务添加失败："+i.data:"自定义服务添加失败"});else{var c=r.taskId;!function a(r){var i=o(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(n.$emit("closeAddModal"),t.reload().then(function(){e.addAlert({type:"success",content:"自定义服务添加成功"})}),o.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"自定义服务添加失败："+l.data.reason:"自定义服务添加失败"}),o.cancel(i)):("PENDING"===l.data.state,r>0?a(r-1):(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:"自定义服务添加超时"}),o.cancel(i)))})},1e3)}(30)}}))},n.cancel=function(){a.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","ServiceCustomize","formatVal"];var i=a.open({templateUrl:"service-customize-add-new.html",size:"lg",controller:n});i.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},p.editService=function(n){function i(a,r,i,s){function c(e){var t=p.table,o=!0;return e&&t&&t.some(function(t){if(t.name===e&&t.name!==n.name)return o=!1,!0}),o}function d(e){return!(e&&!s.validateObjectAssetsName(e))}function u(e,t,n){return!e||!(s.validatePort(e)||Number(e)<1)||!(!t||"ANY"!==e.toUpperCase()||"ANY"===n)}a.isEditDisabled=!0,a.editService=angular.copy(n),a.newRule={type:"TCP"},a.rules=[],angular.isArray(a.editService.serverRules)&&(a.rules=a.editService.serverRules),a.checkNameVal=function(e){var t=d(e);return t?(t=c(e),t||(a.nameValMsg="已定义该名称的服务，请更换其他服务名称")):a.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},a.checkDestPortVal=function(e,t){a.isDestPortsInvalid=!1;var n=t<=0,o=a.newRule.minDstPort,r=a.newRule.maxDstPort,i=a.newRule.minSrcPort?a.newRule.minSrcPort.toUpperCase():"",l=!o||u(o,!0,i),s=!r||u(r,!1),c=l&&s;return c?o&&r&&Number(o)>Number(r)&&(a.isDestPortsInvalid=!0,a.destPortValMsg="端口输入不合法,最大端口不能小于最小端口"):(a.destPortValMsg="请输入有效"+(l?s?"":"最大":"最小")+"端口号",(n&&l||!n&&s)&&(c=!0)),c},a.checkSourcePortVal=function(e,t){a.isSourcePortsInvalid=!1;var n=t<=0,o=a.newRule.minSrcPort,r=a.newRule.maxSrcPort,i=a.newRule.minDstPort?a.newRule.minDstPort.toUpperCase():"",l=!o||u(o,!0,i),s=!r||u(r,!1),c=l&&s;return c?o&&r&&Number(o)>Number(r)&&(a.isSourcePortsInvalid=!0,a.sourcePortValMsg="端口输入不合法,最大端口不能小于最小端口"):(a.sourcePortValMsg="请输入有效"+(l?s?"":"最大":"最小")+"端口号",(n&&l||!n&&s)&&(c=!0)),c},a.$watch("[newRule.minSrcPort, newRule.minDstPort]",function(e){e[0]&&"ANY"===e[0].toUpperCase()?(a.newRule.maxSrcPort="",a.srcMaxPortHide=!0):a.srcMaxPortHide=!1,e[1]&&"ANY"===e[1].toUpperCase()?(a.newRule.maxDstPort="",a.destMaxPortHide=!0):a.destMaxPortHide=!1}),a.$watch("[newRule.minSrcPort, newRule.minDstPort, newRule.maxSrcPort, newRule.maxDstPort]",function(e){e[0]&&"ANY"!==e[0].toUpperCase()&&!e[2]&&(a.newRule.maxSrcPort=e[0]),e[2]&&"ANY"!==e[2].toUpperCase()&&!e[0]&&(a.newRule.minSrcPort=e[2]),e[1]&&"ANY"!==e[1].toUpperCase()&&!e[3]&&(a.newRule.maxDstPort=e[1]),e[3]&&"ANY"!==e[3].toUpperCase()&&!e[1]&&(a.newRule.minDstPort=e[3])}),a.addNewRule=function(e){if(e){var t=angular.copy(a.newRule);a.rules.push(t)}},a.deleteRule=function(e){a.rules.splice(e,1)},a.ok=function(n){n&&(a.isEdittingService=!0,i.updateService([a.editService],function(n,i){var s=a.$on("closeAddModal",function(){a.isEdittingService=!1,r.close(),s()});if(i)a.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"自定义服务修改失败："+i.data:"自定义服务修改失败"});else{var c=n.taskId;!function n(r){var i=o(function(){l.getTask(c).then(function(l){"SUCCESS"===l.data.state?(a.$emit("closeAddModal"),t.reload().then(function(){e.addAlert({type:"success",content:"自定义服务修改成功"})}),o.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(a.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"自定义服务修改失败："+l.data.reason:"自定义服务修改失败"}),o.cancel(i)):("PENDING"===l.data.state,r>0?n(r-1):(a.$emit("closeAddModal"),e.addAlert({type:"danger",content:"自定义服务修改超时"}),o.cancel(i)))})},1e3)}(30)}}))},a.cancel=function(){r.dismiss("cancel")}}i.$inject=["$scope","$modalInstance","ServiceCustomize","formatVal"];var s=a.open({templateUrl:"service-customize-edit.html",size:"lg",controller:i});s.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},p.viewService=function(e){function t(t,n){t.isViewOnly=!0,t.editService=e,t.newRule={type:"TCP"},t.rules=t.editService.serverRules,t.checkNameVal=function(){return!0},t.checkDestPortVal=function(){return!0},t.checkSourcePortVal=function(){return!0},t.ok=function(){n.close()},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance"];var n=a.open({templateUrl:"service-customize-edit.html",size:"lg",controller:t});n.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},p.deleteService=function(){var a=p.selectedItems,r=[];if(a)for(var i in a)a[i]&&r.push(i);if(0!==r.length){var c=n.defer();e.serviceDeleteTaskPromise=c.promise,s.deleteService(r,function(n,a){if(a)e.addAlert({type:"danger",content:a.data?"自定义服务删除失败："+a.data:"自定义服务删除失败"}),c.resolve("fail");else{var r=n.taskId;!function n(a){var i=o(function(){l.getTask(r).then(function(r){"SUCCESS"===r.data.state?(t.reload().then(function(){e.addAlert({type:"success",content:"自定义服务删除成功"})}),c.resolve("success"),o.cancel(i)):"FAILED"===r.data.state||"REJECTED"===r.data.state?(e.addAlert({type:"danger",content:r.data.reason?"自定义服务删除失败："+r.data.reason:"自定义服务删除失败"}),c.resolve("fail"),o.cancel(i)):("PENDING"===r.data.state,a>0?n(a-1):(e.addAlert({type:"danger",content:"自定义服务删除超时"}),c.resolve("timeout"),o.cancel(i)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条自定义服务"})}}var d={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/object/service/customizeTable.52aa8000.html",link:c};return d}e.$inject=["ServicePredefine"],t.$inject=["$rootScope","$state","$q","$timeout","$modal","$log","Enum","Task","ServiceCustomize"],angular.module("southWest.object.service").directive("svcPredefineTable",e).directive("svcCustomizeTable",t)}(),function(){"use strict";function e(e){e.state("postlog",{url:"/postlog",controller:"PostLogCtrl as postlog",templateUrl:"templates/postlogin/index.5652521b.html"})}e.$inject=["$stateProvider"],angular.module("southWest.postlog").config(e)}(),function(){"use strict";function e(e){var t=this;t.$state=e,t.tabs=[],t.tabs[0]=[{state:"Topology",name:"网络拓扑",enabled:!0},{state:"monitor.overview",name:"实时监控",enabled:!0},{state:"safety",name:"安全性分区",enabled:!0},{state:"other",name:"结构安全性"},{state:"attack",name:"攻击路径",enabled:!0}],t.tabs[1]=[{state:"detect",name:"入侵检测",enabled:!0},{state:"track",name:"事件追踪",enabled:!0},{state:"process",name:"流程审计",enabled:!0},{state:"other",name:"漏洞扫描"},{state:"other",name:"完整性验证"
},{state:"other",name:"优化方案"}],t.tabs[2]=[{state:"report",name:"报告管理",enabled:!0}]}e.$inject=["$state"],angular.module("southWest.postlog").controller("PostLogCtrl",e)}(),function(){"use strict";function e(){function e(e){var t=e;"undefined"==typeof e.plSidebarSwitch&&(e.plSidebarSwitch=0),"undefined"==typeof e.plCurrentTab&&(e.plCurrentTab=0),t.selectSideItem=function(t){switch(e.plSidebarSwitch=t,e.plCurrentTab=0,t){case 0:e.topVal="35px";break;case 1:e.topVal="176px";break;case 2:e.topVal="318px";break;default:e.topVal="35px"}},t.selectTab=function(t){e.plCurrentTab=t}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/postlogin/sidebar.b75df19e.html",link:e};return t}function t(e){function t(t){var n=t;n.logout=e.logout}var n={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/postlogin/container.6d1a0a83.html",link:t};return n}t.$inject=["auth"],angular.module("southWest.postlog").directive("plSidebar",e).directive("plContainer",t)}(),function(){"use strict";function e(e){e.state("privateprotocol",{parent:"dashboard",url:"/privateprotocol",controller:"PrivateProtocolCtrl as privateprotocol",templateUrl:"templates/privateprotocol/index.b8824daa.html",resolve:{protocols:["PrivateProtocol",function(e){return e.getProtocols()}],hiddenPorts:["PrivateProtocol",function(e){return e.getHiddenPorts()}],state:["$rootScope",function(e){e.currentState="SETTINGS_PROTOCOL"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.privateprotocol").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i){function l(){for(var e in p.protocols)p.protocols[e]&&(p.protocols[e].message="")}function s(e){var t=+e;return t>=1&&t<=65535&&e===t.toString()}function c(){var e=!1;for(var t in p.protocols)p.protocols[t]&&!p.protocols[t].disabled&&(p.protocols[t].protocolPort&&0!==p.protocols[t].protocolPort.length?s(p.protocols[t].protocolPort.toString())||(p.protocols[t].message="请输入合法的端口码",e=!0):(p.protocols[t].message="请输入端口码",e=!0));return!e}function d(){var e,t,n,o=!1;for(n=p.protocols.length,e=0;e<n;e++)if(!p.protocols[e].disabled&&p.protocols[e].protocolPort&&0!==p.protocols[e].protocolPort.length)for(t=e+1;t<n;t++)!p.protocols[t].disabled&&p.protocols[t].protocolPort&&0!==p.protocols[t].protocolPort.length&&p.protocols[e].protocolPort.toString()===p.protocols[t].protocolPort.toString()&&(p.protocols[e].message="重复",p.protocols[t].message="重复",o=!0);return!o}function u(){var e=!1;for(var t in p.protocols)if(p.protocols[t]&&!p.protocols[t].disabled){if(!p.protocols[t].protocolPort||0===p.protocols[t].protocolPort.length)continue;for(var n in p.hiddenPorts)if(p.hiddenPorts[n].toString()===p.protocols[t].protocolPort.toString()){p.protocols[t].message=p.hiddenPorts[n]+"为网络端口，请输入其他端口码",e=!0;break}}return!e}e.refresh=function(){t.reload()};var p=this;p.protocols=a,p.hiddenPorts=r,p.noErrors=!0,p.edit=function(){p.oldprotocols=angular.copy(p.protocols),p.isEditing=!0},p.cancel=function(){p.protocols=p.oldprotocols,p.isEditing=!1},p.confirm=function(){o.updateAll(p.protocols).then(function(){p.isEditing=!1},function(e){for(var t in p.protocols)if(p.protocols[t]&&p.protocols[t].privateProtocolId===e.privateProtocolId&&e.info){p.protocols[t].message=e.info;break}})},p.showConfirmUI=function(){function e(e,t){e.msg={text:"",list:"",qus:"确定所有修改？"};for(var n=0;n<p.protocols.length;n++)0===p.oldprotocols[n].disabled&&1===p.protocols[n].disabled&&(e.msg.text+=e.msg.text?"":"请注意，关闭已经启用的私有协议会影响到引用过此私有协议的内容，包括：学习到的与此私有协议相关行为规则；引用此私有协议的手写规则；将来此事件的处理方式等。",e.msg.list+=e.msg.list?p.oldprotocols[n].protocolName+"， ":"以下私有协议将被关闭: "+p.oldprotocols[n].protocolName+"， ");e.cancel=function(){p.cancel(),t.dismiss("cancel")},e.done=function(){p.confirm(),t.close("done")}}e.$inject=["$scope","$modalInstance"];var t=i.open({templateUrl:"templates/privateprotocol/confirm-panel.d9f32561.html",size:"sm",controller:e});t.result.then(function(){},function(){})},p.switch=function(e,t){0===t&&e.protocolPort&&"-1"===e.protocolPort.toString()&&(e.protocolPort=""),e.disabled=t,this.checkAllPorts()},p.checkAllPorts=function(){l();var e=c(),t=d(),n=u();p.noErrors=e&&t&&n}}e.$inject=["$scope","$state","$rootScope","PrivateProtocol","protocols","hiddenPorts","$modal"],angular.module("southWest.privateprotocol").controller("PrivateProtocolCtrl",e)}(),function(){"use strict";function e(e){e.state("protocolaudit",{parent:"dashboard",url:"/protocolaudit",controller:"AuditTableCtrl as audittable",templateUrl:"templates/protocolaudit/index.e7fb8ad7.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.protocolaudit").config(e)}(),function(){"use strict";function e(e,t,n){var o=this;o.showImportBtn="-C05"===n.VERSION_NUMBER.slice(-4)}e.$inject=["$scope","$state","$rootScope"],angular.module("southWest.protocolaudit").controller("AuditTableCtrl",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u){function p(a,p,f,m){function g(e){a.protocol=e,v(e)}function h(e,t){if(e){var n=e.nodeDisplayValue.split(",");n.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())});var o=!1;n.map(function(e){return"NONSTANDARD"===e?void(o=!0):(e={name:e,value:e},void t.push(e))})}}function v(e){"modbus"!==e||A.modbus.init||u.getData({currentValue:'[{"name":"协议","value":"modbus"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.modbus.func),A.modbus.init=!0}),"opcda"!==e||A.opcda.init||u.getData({currentValue:'[{"name":"协议","value":"opcda"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.opcda.opc),A.opcda.init=!0}),"s7"!==e||A.s7.init||u.getData({currentValue:'[{"name":"协议","value":"S7"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.s7.pdu),A.s7.init=!0}),"dnp3"!==e||A.dnp3.init||u.getData({currentValue:'[{"name":"协议","value":"dnp3"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.dnp3.func),A.dnp3.init=!0}),"iec104"!==e||A.iec104.init||u.getData({currentValue:'[{"name":"协议","value":"iec104"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.iec104.causetx),h(e.data.nodeTree.nodes[2],A.iec104.asdu),A.iec104.init=!0}),"mms"!==e||A.mms.init||u.getData({currentValue:'[{"name":"协议","value":"mms"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.mms.pdu),h(e.data.nodeTree.nodes[2],A.mms.serviceRequest),A.mms.init=!0}),"profinetio"!==e||A.profinetio.init||u.getData({currentValue:'[{"name":"协议","value":"profinetio"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.profinetio.func),h(e.data.nodeTree.nodes[2],A.profinetio.opp),h(e.data.nodeTree.nodes[3],A.profinetio.dataType),A.profinetio.init=!0}),"pnrtdcp"!==e||A.pnrtdcp.init||u.getData({currentValue:'[{"name":"协议","value":"PNRTDCP"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.pnrtdcp.dcpoption),h(e.data.nodeTree.nodes[2],A.pnrtdcp.servicetype),h(e.data.nodeTree.nodes[3],A.pnrtdcp.serviceid),h(e.data.nodeTree.nodes[4],A.pnrtdcp.frameid),A.pnrtdcp.init=!0}),"eniptcp"!==e||A.eniptcp.init||u.getData({currentValue:'[{"name":"协议","value":"ENIP-TCP"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.eniptcp.command),h(e.data.nodeTree.nodes[2],A.eniptcp.serviceName),h(e.data.nodeTree.nodes[3],A.eniptcp.addressType),h(e.data.nodeTree.nodes[4],A.eniptcp.dataType),A.eniptcp.init=!0}),"enipudp"!==e||A.enipudp.init||u.getData({currentValue:'[{"name":"协议","value":"ENIP-UDP"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.enipudp.command),A.enipudp.init=!0}),"enipio"!==e||A.enipio.init||u.getData({currentValue:'[{"name":"协议","value":"ENIP-IO"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.enipio.addressType),h(e.data.nodeTree.nodes[2],A.enipio.dataType),A.enipio.init=!0}),"goose"!==e||A.goose.init||u.getData({currentValue:'[{"name":"协议","value":"GOOSE"}]'}).then(function(){A.goose.init=!0}),"sv"!==e||A.sv.init||u.getData({currentValue:'[{"name":"协议","value":"SV"}]'}).then(function(e){h(e.data.nodeTree.nodes[2],A.sv.smpSynch),A.sv.init=!0}),"opcua"!==e||A.opcua.init||u.getData({currentValue:'[{"name":"协议","value":"opcua_tcp"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.opcua.serviceId),A.opcua.init=!0}),"snmp"!==e||A.snmp.init||u.getData({currentValue:'[{"name":"协议","value":"snmp"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.snmp.pduType),A.snmp.init=!0}),"focas"!==e||A.focas.init||u.getData({currentValue:'[{"name":"协议","value":"focas"}]'}).then(function(e){h(e.data.nodeTree.nodes[1],A.focas.command),h(e.data.nodeTree.nodes[2],A.focas.type),h(e.data.nodeTree.nodes[3],A.focas.function_key),h(e.data.nodeTree.nodes[4],A.focas.func),A.focas.init=!0});var t=[{name:"packetTimestamp",display:"日期",input:"timerange",option:!0,value:[],options:[]},{name:"sourceIp",display:"源IP地址",input:"ipAdress",option:!1,value:""},{name:"sourceMac",display:"源MAC地址",input:"macAdress",option:!1,value:""},{name:"sourcePort",display:"源端口",input:"portNum",option:!1,value:""},{name:"destinationIp",display:"目标IP地址",input:"ipAdress",option:!1,value:""},{name:"destinationMac",display:"目标MAC地址",input:"macAdress",option:!1,value:""},{name:"destinationPort",display:"目标端口",input:"portNum",option:!1,value:""}];b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac"],"modbus"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","func","startAddr","endAddr"],t.push({name:"func",display:"功能码",input:"list_checkbox",option:!0,value:[],options:A.modbus.func}),t.push({name:"startAddr",display:"起始地址",input:"string",option:!1,value:""}),t.push({name:"endAddr",display:"终止地址",input:"string",option:!1,value:""})),"opcda"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","opInt","opCode"],t.push({name:"opInt",display:"操作接口",input:"list_checkbox",option:!0,value:[],options:A.opcda.opc}),t.push({name:"opCode",display:"操作码",input:"string",option:!1,value:""})),"s7"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","pduType","opType","dataType"],t.push({name:"pduType",display:"PDU类型",input:"list_checkbox",option:!0,value:[],options:A.s7.pdu}),t.push({name:"opType",display:"操作类型",input:"string",option:!1,value:""}),t.push({name:"dataType",display:"数据类型",input:"string",option:!1,value:""})),"dnp3"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","func"],t.push({name:"func",display:"功能码",input:"list_checkbox",option:!0,value:[],options:A.dnp3.func})),"iec104"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","causetxType","asduType"],t.push({name:"causetxType",display:"Causetx类型",input:"list_checkbox",option:!0,value:[],options:A.iec104.causetx}),t.push({name:"asduType",display:"Asdu类型",input:"list_checkbox",option:!0,value:[],options:A.iec104.asdu})),"mms"===e&&t.push({name:"pduType",display:"PDU类型",input:"list_checkbox",option:!0,value:[],options:A.mms.pdu}),"profinetio"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","func","opInt","dataType"],t.push({name:"func",display:"功能码",input:"list_checkbox",option:!0,value:[],options:A.profinetio.func}),t.push({name:"opInt",display:"操作接口",input:"list_checkbox",option:!0,value:[],options:A.profinetio.opp}),t.push({name:"dataType",display:"数据类型",input:"list_checkbox",option:!0,value:[],options:A.profinetio.dataType})),"pnrtdcp"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","frameid","serviceid","servicetype","dcpoption","dcpsuboption"],t.push({name:"frameid",display:"frame标识号",input:"list_checkbox",option:!0,value:[],options:A.pnrtdcp.frameid}),t.push({name:"serviceid",display:"服务标识号",input:"list_checkbox",option:!0,value:[],options:A.pnrtdcp.serviceid}),t.push({name:"servicetype",display:"服务类型",input:"list_checkbox",option:!0,value:[],options:A.pnrtdcp.servicetype})),"eniptcp"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","command","serviceName","addressType","dataType"],t.push({name:"command",display:"命令",input:"list_checkbox",option:!0,value:[],options:A.eniptcp.command})),"enipudp"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","command"],t.push({name:"command",display:"命令",input:"list_checkbox",option:!0,value:[],options:A.enipudp.command})),"enipio"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","addressType","dataType"],t.push({name:"addressType",display:"地址类型",input:"list_checkbox",option:!0,value:[],options:A.enipio.addressType}),t.push({name:"dataType",display:"数据类型",input:"list_checkbox",option:!0,value:[],options:A.enipio.dataType})),"goose"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","datSet","goID"]),"sv"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","svID","smpSynch"],t.push({name:"smpSynch",display:"采样同步",input:"list_checkbox",option:!0,value:[],options:A.sv.smpSynch})),"opcua"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","serviceid"],t.push({name:"serviceid",display:"服务码",input:"list_checkbox",option:!0,value:[],options:A.opcua.serviceId})),"snmp"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","pduType"],t.push({name:"pduType",display:"PDU类型",input:"list_checkbox",option:!0,value:[],options:A.snmp.pduType})),"focas"===e&&(b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac","command","type","function_key","func"],t.push({name:"command",display:"命令",input:"list_checkbox",option:!0,value:[],options:A.focas.command}),t.push({name:"type",display:"操作类型",input:"list_checkbox",option:!0,value:[],options:A.focas.type}),t.push({name:"function_key",display:"按键",input:"list_checkbox",option:!0,value:[],options:A.focas.function_key}),t.push({name:"func",display:"功能码",input:"list_checkbox",option:!0,value:[],options:A.focas.func}));var n={name:"audit",pagination:!0,scrollable:!1,totalCount:!0,getAll:D,getCount:y,search:I,fields:b,advancedSearch:"protocol"};m.query=m.isSearching=m.advancedSearchQuery="",angular.extend(n,{advancedSearchOptions:t}),m.disableToolbar=!0,m.setConfig(n)}function y(e){var n=""!==m.advancedSearchQuery||""!==m.query;return t.getCount(e,a.protocol,n)}function I(e){return a.params=e,D(e)}function D(n){n.$orderby&&""!==n.$orderby||(n.$orderby="packetTimestamp desc");var o=""!==m.advancedSearchQuery||""!==m.query;return a.protocol&&"normal"!==a.protocol&&(_.contains(n.$filter,a.protocol)||(n.$filter+=" and (contains(protocolSourceName,'"+a.protocol+"'))")),a.params=n,t.getAll(n,a.protocol,o).then(function(t){return t.length>0&&o?e.all(t).then(function(){return t.map(function(e,n){"goose"!==t[n].protocolSourceName&&"sv"!==t[n].protocolSourceName||(t[n].flowTimestamp=t[n].packetTimestamp);var o=t[n].flowTimestamp||t[n].packetTimestamp;t[n].flowTimestampLocal=new Date(o),t[n].getDetails=T}),t}):[]})}function T(e){e.detail||a.factoryProtocolOptions&&a.factoryProtocolOptions.filter(function(e){return a.protocol===e.value})[0]||(e.flowTimestampLocal=new Date(e.flowTimestampLocal),t.get(e.flowdataHeadId,e.protocolSourceName).then(function(t){for(var n in t)n&&(t[n].packetTimestampLocal=new Date(t[n].packetTimestamp));e.detail=t||[]}))}var b=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort","sourceMac","destinationMac"];v("normal"),a.protocolOptions=[{display:"所有协议",value:"normal",type:"normal"},{display:"HTTP",value:"http",type:"normal"},{display:"FTP",value:"ftp",type:"normal"},{display:"POP3",value:"pop3",type:"normal"},{display:"SMTP",value:"smtp",type:"normal"},{display:"Telnet",value:"telnet",type:"normal"},{display:"SNMP",value:"snmp",type:"normal"}],a.factoryProtocolOptions=[{display:"Modbus",value:"modbus",type:"factory"},{display:"OPCDA",value:"opcda",type:"factory"},{display:"S7",value:"s7",type:"factory"},{display:"DNP3",value:"dnp3",type:"factory"},{display:"IEC104",value:"iec104",type:"factory"},{display:"MMS",value:"mms",type:"factory"},{display:"Profinetio",value:"profinetio",type:"factory"},{display:"Pnrtdcp",value:"pnrtdcp",type:"factory"},{display:"Goose",value:"goose",type:"factory"},{display:"SV",value:"sv",type:"factory"},{display:"EnipTcp",value:"eniptcp",type:"factory"},{display:"EnipUdp",value:"enipudp",type:"factory"},{display:"EnipIo",value:"enipio",type:"factory"},{display:"OPCUA",value:"opcua",type:"factory"}];var S=s.VERSION_NUMBER.split("-"),P=S[S.length-1];"X02"===P&&a.factoryProtocolOptions.push({display:"FOCAS",value:"focas",type:"factory"}),a.protocol=a.protocolOptions[0].value,a.changeProtocol=g;var A={modbus:{func:[]},opcda:{opc:[]},s7:{pdu:[]},dnp3:{func:[]},iec104:{causetx:[],asdu:[]},mms:{pdu:[],serviceRequest:[]},profinetio:{func:[],opp:[],dataType:[]},pnrtdcp:{frameid:[],serviceid:[],servicetype:[],dcpoption:[],dcpsuboption:[]},eniptcp:{command:[],serviceName:[],addressType:[],dataType:[]},enipudp:{command:[]},enipio:{addressType:[],dataType:[]},goose:{datSet:[],goID:[]},sv:{svID:[],smpSynch:[]},opcua:{serviceId:[]},snmp:{pduType:[],version:[],community:[]},focas:{command:[],type:[],function_key:[],func:[]}},C=this;C.sTime,C.eTime,s.$on("getPoolLinesDetail",function(e,t,n,o,r,i){C.sTime=t,C.eTime=n;var l="(((sourceIp eq '"+o+"') and (destinationIp eq '"+r+"')) or ((sourceIp eq '"+r+"') and (destinationIp eq '"+o+"')))  and   (packetTimestamp gt '"+C.sTime+"' and packetTimestamp lt '"+C.eTime+"') and (protocolSourceName eq '"+i+"')";a.protocol=i,m.disableToolbar=!0,m.getDataByCustomParameter(l)}),a.openImportPanel=function(e){function t(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new r({url:i+"/auditlogs/topology/"+l.id+"/import",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){s.addAlert({type:"danger",content:"导入协议审计失败： "+t.error})},e.uploader.onSuccessItem=function(){d(function(){c.reload()},2e3),s.addAlert({type:"success",content:"导入协议审计成功！"})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","extension"];var a=n.open({templateUrl:"templates/includes/confirmInputPanel.cd9b13a0.html",controller:t,size:"sm",resolve:{extension:function(){return e}}});a.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},a.openExportPanel=function(e,r){function i(e,n){e.addPsw="1",e.validatePsw=function(e){var t=/^(?=.*[a-zA-Z])(?=.*\d)(?=.*(_|[^\w])).+$/g;return e&&e.match(t)&&e.length>=8},e.download=function(e){n.close(),t.getAllExport(l,e,r).then(function(e){window.open("./"+e,"_self")})},e.cancel=function(){n.dismiss("cancel")}}i.$inject=["$scope","$modalInstance"],r="normal"===r?"all":r;var l=e?a.params:{};l.$limit=1e5;var s=n.open({templateUrl:"templates/includes/confirmOutputPanel.a4b90361.html",controller:i,size:"sm"});s.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},a.supportIpAndPort=function(e){switch(e.toLowerCase()){case"goose":case"sv":case"pnrtdcp":return!1;default:return!0}},m.showDetailWindow=function(o){e.all([]).then(function(){function r(n,r){n.getData=function(){var e=o;e.unitSize="B",e.packetLenth&&e.packetLenth>=1024&&(e.packetLenth/=1024,e.unitSize="KB"),e.packetLenth&&e.packetLenth>=1024&&(e.packetLenth/=1024,e.unitSize="MB"),e.flowTimestampLocal=o.flowTimestampLocal,e.sourceIp=o.sourceIp,e.sourceMac=o.sourceMac,e.sourcePort=o.sourcePort,e.destinationIp=o.destinationIp,e.destinationMac=o.destinationMac,e.destinationPort=o.destinationPort,e.protocolSourceName=o.protocolSourceName,n.auditDataDetail=e},n.getData(),n.cancel=function(){r.dismiss("cancel")},n.done=function(){r.close("done")},n.trim=function(e){return e=null===e||void 0===e?"":String(e),e.replace(/(^\s*)|(\s*$)/g,"")},n.supportIpAndPort=function(e){return a.supportIpAndPort(e)},n.exportFile=function(o,a){var r=o?n.params:{};r.$limit=1e5,e.all().then(function(){t.getAuditProtocolExport(r,n.auditDataDetail.fileZipPsw,n.auditDataDetail.protocolSourceName,a).then(function(e){window.open("./"+e,"_self")})})}}r.$inject=["$scope","$modalInstance"];var i=n.open({templateUrl:"templates/protocolaudit/detail-panel.f1d00c99.html",size:"lg",controller:r});i.result.then(function(e){},function(){})})}}var f={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/protocolaudit/auditTab.1af33ec5.html",link:p};return f}function t(e,t,n){function o(o,a,r,i){function l(){var e=o.auditDataDetail;return n.getDetailsCount(e.flowdataHeadId,e.protocolSourceName.toLowerCase()).then(function(e){return e})}function s(t){t.$orderby&&""!==t.$orderby||(t.$orderby="packetTimestamp desc"),o.params=t;var a=o.auditDataDetail,r=a.protocolSourceName.toLowerCase();return n.getDetails(o.params,a.flowdataHeadId,r).then(function(t){return t.length?e.all(t).then(function(){return d(t,r)}):[]})}function c(e){var t=[];switch(e){case"http":t=["记录时间","目标URL"];break;case"ftp":t=["记录时间","使用账号","输入命令"];break;case"telnet":t=["记录时间","使用账号","输入命令"];break;case"smtp":t=["记录时间","源信箱地址","目的信箱地址"];break;case"pop3":t=["记录时间","源信箱地址","目的信箱地址"];break;case"modbus":t=["记录时间","功能码","起始地址","终止地址"];break;case"opcda":t=["记录时间","操作接口","操作码"];break;case"s7":t=["记录时间","PDU类型","操作类型","数据类型"];break;case"dnp3":t=["记录时间","功能码"];break;case"iec104":t=["记录时间","Causetx类型","Asdu类型"];break;case"mms":t=["记录时间","PDU类型","服务请求类型"];break;case"profinetio":t=["记录时间","功能码","操作接口","数据类型"];break;case"pnrtdcp":t=["记录时间","frame标识号","服务标识号","服务类型","选项","子选项"];break;case"enipio":t=["记录时间","地址类型","数据类型"];break;case"eniptcp":t=["记录时间","命令","服务码","地址类型","数据类型"];break;case"enipudp":t=["记录时间","命令"];break;case"goose":t=["记录时间","数据集","GO标识号"];break;case"sv":t=["记录时间","SV编号","采样同步"];break;case"snmp":t=["记录时间","PDU类型","版本","团体名"];break;case"opcua":t=["记录时间","服务码"];break;case"focas":t=["记录时间","命令","操作类型","按键","功能码"]}return t}function d(e,n){var o=[];switch(n){case"http":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.url))});break;case"ftp":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.accountName,e.command))});break;case"telnet":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.accountName,e.command))});break;case"smtp":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.souceMailAddress,e.destMailAddress))});break;case"pop3":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.souceMailAddress,e.destMailAddress))});break;case"modbus":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.func,e.startAddr,e.endAddr))});break;case"opcda":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.opInt,e.opCode))});break;case"s7":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.pduType,e.opType,e.dataType))});break;case"dnp3":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.func))});break;case"iec104":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.causetxType,e.asduType))});break;case"mms":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.pduType,e.serviceRequest))});break;case"profinetio":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.func,e.opInt,e.dataType))});break;case"pnrtdcp":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.frameid,e.serviceid,e.servicetype,e.dcpoption,e.dcpsuboption))});break;case"enipio":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.addressType,e.dataType))});break;case"eniptcp":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.command,e.serviceName,e.addressType,e.dataType))});break;case"enipudp":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.command))});break;case"goose":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.datSet,e.goID))});break;case"sv":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.svID,e.smpSynch))});break;case"snmp":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.pduType,e.version,e.community))});break;case"opcua":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.serviceId))});break;case"focas":e.map(function(e){o.push(new Array(t("date")(new Date(e.packetTimestamp),"yyyy-MM-dd HH:mm:ss"),e.command,e.type,e.function_key,e.func))})}return o}var u={name:"audit",pagination:!0,scrollable:!1,totalCount:!0,numPerPage:8,getAll:s,getCount:l};i.setConfig(u),i.disableToolbar=!0,o.listInfoHead=c(o.auditDataDetail.protocolSourceName.toLowerCase())}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/protocolaudit/auditDetailTab.fb71e61b.html",link:o};return a}e.$inject=["$q","Audit","$modal","$log","$filter","FileUploader","URI","topologyId","$rootScope","$state","$timeout","Custom"],t.$inject=["$q","$filter","Audit"],angular.module("southWest.protocolaudit").directive("auditFullTable",e).directive("auditDetailTable",t)}(),function(){"use strict";function e(e){e.state("record",{parent:"dashboard",url:"/record",controller:"RecordCtrl as record",templateUrl:"templates/record/index.a0f08b35.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.record").config(e)}(),function(){"use strict";function e(e,t,n,o){var a=this;n.deleteArray=[],a.generateRecord=function(){e.generateRecord().then(function(e){n.$$childHead.refreshTable()})},a.downloadRecord=function(e){window.open("./"+e,"_self")},a.deleteRecord=function(a){function r(t,n,o,a){t.items=o,t.ok=function(){e.deleteRecord(o).then(a),n.close()},t.cancel=function(){n.dismiss("cancel")}}r.$inject=["$scope","$modalInstance","items","cb"],n.deleteArray.push(a);var i=t.open({templateUrl:"delete-record-confirmation.html",controller:r,size:"sm",resolve:{items:function(){return n.deleteArray},cb:function(){return n.$$childHead.refreshTable}}});i.result.then(function(e){n.selected=e},function(){o.info("Modal dismissed at: "+new Date)})}}e.$inject=["Record","$modal","$scope","$log"],angular.module("southWest.record").controller("RecordCtrl",e)}(),function(){"use strict";function e(e){function t(t,n,o,a){function r(t){return t.$orderby&&""!==t.$orderby||(t.$orderby="createdAt desc"),e.getBackupLogs(t).then(function(e){return e})}function i(t){return e.getBackupLogsCount(t).then(function(e){return e})}function l(t){return t.$orderby&&""!==t.$orderby||(t.$orderby="createdAt desc"),e.getBackupLogs(t).then(function(e){return e})}var s=["logname","createdAt"];a.setConfig({name:"条记录",pagination:!0,scrollable:!1,totalCount:!0,getAll:r,getCount:i,search:l,fields:s,dateTimeRange:"createdAt"}),t.refreshTable=function(){a.getTableData()}}var n={scope:!1,restrict:"E",replace:!0,require:"^dtable",templateUrl:"/templates/record/record-table.97d5e20b.html",link:t};return n}e.$inject=["Record"],angular.module("southWest.record").directive("recordTable",e)}(),function(){"use strict";function e(e){e.state("redirect",{parent:"dashboard",url:"/",controller:"RedirectCtrl as redirect",resolve:{state:["$rootScope",function(e){e.currentState="REAL_TIME_PROTECTION"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.redirect").config(e)}(),function(){"use strict";function e(e,t){var n={privilege:"REAL_TIME_PROTECTION",curState:"redirect",state:"monitor.overview",isLogin:!1};e.centraliztion&&(n={privilege:"SYSTEM_MANAGEMENT",curState:"redirect",state:"setting.systemconsole",isLogin:!1}),t.teleport(n)}e.$inject=["$rootScope","uiCtrl"],angular.module("southWest.redirect").controller("RedirectCtrl",e)}(),function(){"use strict";function e(e){e.state("reduction",{parent:"dashboard",url:"/reduction",controller:"ReductionCtrl as reductionctrl",templateUrl:"templates/reduction/index.921b2f75.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.reduction").config(e)}(),function(){"use strict";function e(e,t){e.refresh=function(){t.reload()}}e.$inject=["$scope","$state"],angular.module("southWest.reduction").controller("ReductionCtrl",e)}(),function(){"use strict";function e(e,t,n,o){function a(e,a,r,i){function l(e){var n="(protocolSourceName eq 'ftpcontrol' or protocolSourceName eq 'telnet' or protocolSourceName eq 'hexagon')",o=e||{};return o.$filter=o.$filter?o.$filter+" and "+n:n,t.getReductionCount(o)}function s(e){return c(e)}function c(e){e.$orderby&&""!==e.$orderby||(e.$orderby="flowTimestamp desc");var n="(protocolSourceName eq 'ftpcontrol' or protocolSourceName eq 'telnet' or protocolSourceName eq 'hexagon')",o=e||{};return o.$filter=o.$filter?o.$filter+" and "+n:n,t.getAllReduction(o).then(function(e){return e.map(function(e){e.flowTimestampLocal=e.flowTimestamp?new Date(e.flowTimestamp):null}),e})}var d=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort"];i.setConfig({name:"reduction",pagination:!0,scrollable:!1,totalCount:!0,getAll:c,getCount:l,search:s,fields:d,dateTimeRange:"flowTimestamp"}),i.protocolSourceName={protocolSourceName:""},i.showDetailWindow=function(e,a){function r(r,i){r.getData=function(){var n;return r.auditDataDetail&&(n={cmdZipPsw:r.auditDataDetail.cmdZipPsw,zipPsw:r.auditDataDetail.zipPsw,fileZipPsw:r.auditDataDetail.fileZipPsw}),t.get(e,a).then(function(e){return e?(e.unitSize="B",e.flowTimestampLocal=e.flowTimestamp?new Date(e.flowTimestamp):null,e.packetLenth&&e.packetLenth>1024&&(e.packetLenth/=1024,e.unitSize="KB"),e.packetLenth&&e.packetLenth>1024&&(e.packetLenth/=1024,e.unitSize="MB"),e.flowdataHead&&e.flowdataHead.protocolSourceName&&"ftpcontrol"===e.flowdataHead.protocolSourceName?t.getViewCommand(e).then(function(t){e._commands=t.toString(),r.auditDataDetail=e,r.auditDataDetail.cmdZipPsw=n?n.cmdZipPsw:"",r.auditDataDetail.zipPsw=n?n.zipPsw:"",r.auditDataDetail.fileZipPsw=n?n.fileZipPsw:""}):(r.auditDataDetail=e,r.auditDataDetail.cmdZipPsw=n?n.cmdZipPsw:"",r.auditDataDetail.zipPsw=n?n.zipPsw:"",void(r.auditDataDetail.fileZipPsw=n?n.fileZipPsw:""))):void o.addAlert({type:"danger",content:"无法打开详细信息"})})},r.getData(),r.cancel=function(){i.dismiss("cancel")},r.done=function(){i.close("done")},r.downloadCommand=function(){r.getData().then(function(){t.getDownloadCommand(r.auditDataDetail).then(function(e){window.open("./"+e.data,"_self")}),i.close("done")})},r.downloadFile=function(e,o,a){var i=function(){t.getDownloadFileZipPath(r.auditDataDetail,e).then(function(e){var t=new Blob([e.data],{type:"application/zip"});saveAs(t,o?o+".zip":"file.zip")})};r.getData().then(function(){function e(e,t){e.fileName=o,e.cancel=function(){t.dismiss("cancel")},e.confirm=function(){i(),t.close("done")}}if(e.$inject=["$scope","$modalInstance"],a){var t=n.open({templateUrl:"templates/reduction/confirmDownload.25f1d968.html",size:"sm",controller:e});t.result.then(function(e){},function(){})}else i()})},r.downloadZip=function(){r.getData().then(function(){t.getDownloadZipPath(r.auditDataDetail).then(function(e){window.open("./"+e.data,"_self")},function(){i.close("done"),o.addAlert({type:"danger",content:"文件下载失败"})}),i.close("done")})}}r.$inject=["$scope","$modalInstance"],"telnet"===a&&(a+="stream");
var i=n.open({templateUrl:"templates/reduction/detail-panel.3a406aa1.html",size:"sm",controller:r});i.result.then(function(e){},function(){})},i.refresh=function(){c({})}}var r={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/reduction/reductionTab.b0c950a7.html",link:a};return r}e.$inject=["$q","Audit","$modal","$rootScope"],angular.module("southWest.reduction").directive("reductionTable",e)}(),function(){"use strict";function e(e,t,n){function o(e,o,a,r){function i(e){return t.getCount(e)}function l(e){return s(e)}function s(e){e.$orderby&&""!==e.$orderby||(e.$orderby="flowTimestamp desc");var n=e||{};return t.getSep("ftpcontrol",n).then(function(e){for(var t=0;t<e.length;t++)e[t].flowTimestampLocal=new Date(e[t].flowTimestamp);return e})}var c=["protocolSourceName","sourceIp","sourcePort","destinationIp","destinationPort"];r.setConfig({name:"audit",pagination:!0,scrollable:!1,totalCount:!0,getAll:s,getCount:i,search:l,fields:c,dateTimeRange:"flowTimestamp"}),r.protocolSourceName={protocolSourceName:""},r.showDetailWindow=function(e){function o(e,n,o){e.cancel=function(){n.dismiss("cancel")},e.auditData=o,e.done=function(){n.close("done")},e.download=function(){t.getDownloadZipPath(e.auditData).then(function(e){window.open("./"+e.data,"_self")}),n.close("done")}}o.$inject=["$scope","$modalInstance","auditData"];var a=n.open({templateUrl:"templates/reduction/detail-ftp-panel.68f65480.html",size:"sm",controller:o,resolve:{auditData:function(){return t.getFtpControlFlowData(e).then(function(e){return e.unitSize="B",e.packetLenth>1024&&(e.packetLenth/=1024,e.unitSize="KB"),e.packetLenth>1024&&(e.packetLenth/=1024,e.unitSize="MB"),e})}}});a.result.then(function(e){},function(){})},r.refresh=function(){s({})}}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/reduction/reductionFtpTab.fe0be71e.html",link:o};return a}e.$inject=["$q","Audit","$modal"],angular.module("southWest.reduction").directive("reductionFtpTable",e)}(),function(){"use strict";function e(e){e.state("rule.blacklist",{url:"/blacklist/:tab",controller:"blacklistSignatureCtrl as signature",templateUrl:"templates/rule/blacklist/index.9c78b056.html",resolve:{deployedPolicyArr:["Signature","secretKey",function(e,t){return e.getDeployedPolicy("BLACKLIST").then(function(e){return e.data})}],policiesArr:["Signature","secretKey",function(e,t){return e.getPolicies("BLACKLIST").then(function(e){return _.filter(e.data,function(e){return e._blocksCount>0})})}]}}).state("rule.blacklist.editor",{parent:"rule",url:"/blacklist/editor/:policyId/:tab",controller:"blacklistEditorCtrl as editor",templateUrl:"templates/rule/blacklist/editor.acce6724.html",resolve:{policiesArr:["Signature","secretKey",function(e,t){return e.getPolicies("BLACKLIST").then(function(e){return _.filter(e.data,function(e){return e._blocksCount>0})})}],menuState:function(){return"rule.blacklist"}}}).state("rule.blacklist.policyDetail",{parent:"rule",url:"/blacklist/policyDetail/:policyId",controller:"blacklistPolicyDetailCtrl as policyDetail",templateUrl:"templates/rule/blacklist/policyDetail.d57a9896.html",resolve:{menuState:function(){return"rule.blacklist"}}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.blacklist").config(e)}(),function(){"use strict";function e(e){function t(t,n,o,a,r,i,l,s,c,d,u){var p=this;p.dpiSelectAll=!1,p.selectDPI=[];var f="category eq SECURITY_DEVICE";p.selectAllDPI=function(){for(var e=0;e<p.selectDPI.length;e++)p.selectDPI[e]=!!p.dpiData[e].deviceOnline&&p.dpiSelectAll},p.deployAll=function(){for(var e=[],n=!0,o=0;o<p.selectDPI.length;o++)p.selectDPI[o]&&(e.push(p.dpiData[o].serialNumber),n=!1);return n?void r.addAlert({type:"danger",content:"请先选择需要部署规则的设备！"}):void i.deployAll(e,"BLACKLIST").then(function(e){p.showEdit=!1;var n=e.data.taskId,o=l.defer();r.isDeployingAll=!0,r.deployAllTaskPromise=o.promise,function e(a){var i=d(function(){u.getTask(n,r.currentIp).then(function(n){"SUCCESS"===n.data.state?(t.reload(),r.addAlert({type:"success",content:"部署成功"}),o.resolve("success"),d.cancel(i),r.isDeployingAll=!1):"FAILED"===n.data.state?(r.addAlert({type:"danger",content:n.data.reason?"部署失败："+n.data.reason:"部署失败"}),o.resolve("fail"),d.cancel(i),r.isDeployingAll=!1):a>0?e(a-1):(o.resolve("timeout"),r.addAlert({type:"danger",content:"部署超时"}),r.isDeployingAll=!1)})},1e3)}(120)},function(e){p.showEdit=!1,r.addAlert({type:"danger",content:e.data.rejectReason?"部署失败："+e.data.rejectReason:"部署失败"})})},function(){var t={$filter:f};e.getAll(t).then(function(t){var n=t.map(function(e){p.selectDPI.push(!1),e.deployRulesNum=0;for(var t=0;t<e.devicePorts.length;t++)e.deployRulesNum+=e.devicePorts[t].deployedRulesNumber,e.devicePorts[t].isMgmtPort&&(e.mgmtIp=e.devicePorts[t].portIp);return!r.domainLogin[e.mgmtIp]&&s.isRemote()?c.autoLogin(e.mgmtIp).then(function(){return a.getDeviceNodes(e.deviceId,e.mgmtIp)}):a.getDeviceNodes(e.deviceId,e.mgmtIp)});return n.length?l.all(n).then(function(n){var o=t.map(function(o,a){return t[a].nodes=n[a],e.getNodeRules(t[a].nodes,o.mgmtIp).then(function(e){o.deployRulesNum=e[a].rules})});return l.all(o).then(function(){p.dpiData=t})}):[]})}()}var n={restrict:"E",scope:!1,templateUrl:"/templates/rule/blacklist/signature-all-dpi-table.e81e342a.html",controller:t,controllerAs:"blacklistAllDpi",link:function(){}};return n}e.$inject=["Device"],angular.module("southWest.rule.blacklist").directive("blacklistAllDpiTable",e)}(),function(){"use strict";angular.module("southWest.rule.blacklist").controller("blacklistSignatureCtrl",["$scope","Signature","$state","$rootScope","Dashboard","Enum","uiCtrl","UCD","uiTree","deployedPolicyArr","policiesArr","ruleService",function(e,t,n,o,a,r,i,l,s,c,d,u){function p(){f.deployedPanelCount=0,t.getDeployedPolicy("BLACKLIST").then(function(e){e.data.length>0&&a.getSignatureDeployedCount().then(function(e){f.deployedPanelCount=e.data.statsValue})}),f.policyManagementCount=0,t.getPolicies("BLACKLIST").then(function(e){f.policyManagementCount=e.data.length})}var f=this;f.showDash=null,f.tab=null,f.deployedPanelCount=0,f.policyManagementCount=0,f.showUI=!1;var m={blocks:[]},g=[];f.contentEnable=function(e){return"SIGNATURE_MANAGEMENT"===e?d.length>0:"DEPLOYED_BLACK_LIST"===e?c.length>0:void 0},f.createPolicy=function(e){t.createPolicy().then(function(t){n.go("rule.blacklist.editor",{policyId:t.data.value,tab:e})})},e.getDeployedPolicies=function(){return m},e.getPolicies=function(){return g},e.refreshDeployPanel=function(){f.getDeployedPolicy(),p()},o.$on("$stateChangeSuccess",function(e,t,o,a,r){n.previous={},n.previous.state=a.name,n.previous.params=r}),f.canEdit=!0,n.params.tab?(f.showUI=!0,f.tab=n.params.tab):f.canEdit?c.length?(f.tab="deployedPanel",f.showUI=!0):d.length?(f.tab="policyManagement",f.showUI=!0):(f.showUI=!1,u.createPolicy("blacklist","signatures")):(f.showUI=!0,f.tab="deployedPanel"),f.getDeployedPolicy=function(){var n={};t.getDeployedPolicy("BLACKLIST").then(function(t){t.data.length>0?(f.showDash=!1,n=t.data[0],m=n,e.$broadcast("refreshDeployedTable")):f.showDash=!0})},f.getPolicies=function(){t.getPolicies("BLACKLIST").then(function(t){e.allPolicies=t.data,e.$broadcast("refreshPolicy",t.data)})},"deployedPanel"===f.tab?f.getDeployedPolicy():"policyManagement"===f.tab&&f.getPolicies(),p(),f.hasDeployedPolicy=!0,0===c.length&&(f.hasDeployedPolicy=!1)}]).controller("blacklistPolicyDetailCtrl",["$scope","$state","Signature","System","$rootScope",function(e,t,n,o,a){var r=this,i=[];a.$on("refreshRuleCurrentIp",function(){t.go("rule.whitelist_manager")}),e.getPolicy=function(){return r.policy},e.getPolicyBlock=function(){return i},n.getPolicy(t.params.policyId).then(function(e){return r.policy=e.data,n.getPolicyBlockbyPolicyId(e.data.policyId,"ReadyDeploy",null,null)}).then(function(t){i=t.data,e.$broadcast("refreshPolicy")}),a.$on("$stateChangeSuccess",function(e,n,o,a,r){t.previous={},t.previous.state=a.name,t.previous.params=r})}]).controller("blacklistEditorCtrl",["$scope","$timeout","$state","localStorage","$rootScope","Signature","$log","$interval","policiesArr",function(e,t,n,o,a,r,i,l,s){var c=this;c.hasPolicies=s.length>0,n.previous?o.setItem("previous",JSON.stringify(n.previous)):n.previous=JSON.parse(o.getItem("previous")),c.goBack=function(){window.history.back()},c.getPolicyId=function(){return n.params.policyId},c.refreshPreDeployTable=function(e){a.$broadcast("refreshPreDeployTable",e)},c.moveToPreDeployTable=function(){e.$broadcast(n.params.tab),e.$broadcast("updateLeftSelectAllStatus")}}])}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s,c){"ngInject";function d(e,t,n,r,i){"SIGNATURE"===r.type?r.signatures=n.data:r.rules=n.data,e.policyBlocks=r,e.deployedPolicy=i.data.inUse,e.changeAction=function(e,t){e.action=t,"SIGNATURE"===r.type?a.changeAction(r.policyBlockId,e.signatureId,t).then(function(e){}):o.changeAction(r.policyBlockId,e.ruleId,t).then(function(e){})},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}function u(){var e={$skip:(f.currentPage-1)*f.numPerPage,$limit:f.numPerPage,$orderby:"createdAt,priority,name"};f.predicate&&(e.sorting=(f.reverse?"-":"+")+f.predicate),f.policy=t.getDeployedPolicies(),o.getPolicyBlockbyPolicyId(m,"ReadyDeploy",null,e).then(function(e){f.table=e.data}),o.getPolicyBlockCountbyPolicyId(m,"ReadyDeploy",null,null).then(function(e){f.totalNum=e.data||0})}function p(){r.getRuleDeployedCount().then(function(e){f.policyRuleDeployedCount=e.data.statsValue}),r.getSignatureDeployedCount().then(function(e){f.policySignatueFixedCount=e.data.statsValue}),r.getBlackListPolicyUpdateTime().then(function(e){f.updateTime=e}),i.getIncidentCount({$filter:"level ne INFO"},!0).then(function(e){f.incidentCount=e})}var f=this;f.currentPage=1,f.numPerPage=10,f.table=[];var m=t.getDeployedPolicies().policyId;u(),p();var g=t.$on("refreshDeployedTable",function(){m=t.getDeployedPolicies().policyId,u(),p()});t.$on("destroy",function(){g()}),t.createPolicy=function(t){o.createPolicy().then(function(n){e.go("rule.blacklist.editor",{policyId:n.data.value,tab:t})})},f.cleanDeploy=function(){o.cleanDeploy("BLACKLIST").then(function(n){var o=n.data.taskId;!function n(a){var r=s(function(){c.getTask(o,l.currentIp).then(function(o){"SUCCESS"===o.data.state?(t.refreshDeployPanel(),l.$broadcast("updateDashboardHeader"),l.addAlert({type:"success",content:"清空已部署规则成功"}),s.cancel(r),e.go("rule.blacklist",{tab:"policyManagement"})):"FAILED"===o.data.state?(l.addAlert({type:"danger",content:"清空已部署规则失败"}),s.cancel(r)):a>0?n(a-1):(l.addAlert({type:"danger",content:"清空已部署规则超时"}),s.cancel(r))})},1e3)}(10)},function(e){l.addAlert({type:"danger",content:"清空已部署规则失败"})})},f.showDetail=function(e){var t=n.open({templateUrl:"/templates/rule/blacklist/policyContent-signature.8c9613b2.html",controller:["$scope","$modalInstance","items","policyBlock","policy",d],backdrop:!0,size:"lg",resolve:{items:function(){return"SIGNATURE"===e.type?o.getSignaturesbyBlockId(e.policyBlockId):o.getRulesbyBlockId(e.policyBlockId)},policyBlock:function(){return e},policy:function(){return o.getPolicyByPolicyId(m)}}});t.result.then(function(e){},function(){})},f.pageChanged=function(){u()},l.$on("refreshRuleCurrentIp",function(){e.reload()})}e.$inject=["$state","$scope","$modal","Signature","Template","Dashboard","Incident","$rootScope","$timeout","Task"];var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/blacklist/deployed-table.0df535a6.html",controller:e,controllerAs:"deployedPolicies",link:function(){}};return t}function t(){function e(e,t,n,o,a){function r(e){if(e&&e.length)for(var t=0;t<e.length;t++)void 0===e[t].checked&&(e[t].checked=!1),l.ruleDeployed=l.ruleDeployed||e[t].inUse;return e}function i(){var e={offset:(l.currentPage-1)*l.numPerPage,limit:l.numPerPage};l.predicate&&(e.sorting=(l.reverse?"-":"+")+l.predicate),l.table=r(t.allPolicies)}var l=this;l.ruleDeployed=!1,l.currentPage=1,l.numPerPage=20,l.table=[],l.showPolicyDetail=!1,l.selectAll=!1,l.createPolicy=function(){n.createPolicy().then(function(e){a.go("rule.blacklist.editor",{policyId:e.data.value,tab:"signatures"})})},l.deletePolicy=function(t){var r=o.open({templateUrl:"/templates/rule/blacklist/confirmDelete.df36b5dd.html",controller:["$scope","$modalInstance","policyId",function(t,o,r){t.cancel=function(){o.dismiss("cancel")},t.delete=function(){var t=[];n.deletePolicySetByPolicyId(r).then(function(n){t.push(n);for(var o="",r=0;r<t.length;r++)"undefined"!=typeof t[r].message&&t[r].message.length>0&&(o+=t[r].message+" ");o?a.reload().then(function(){e.addAlert({type:"danger",content:"删除漏洞集失败："+o})}):a.reload().then(function(){e.addAlert({type:"success",content:"删除漏洞集成功"})})},function(t){a.reload().then(function(){e.addAlert({type:"danger",content:"删除漏洞集失败："+t.data.error})})}),o.dismiss("cancel")},t.msg={title:"删除漏洞集",text:"删除漏洞集合，将同时删除此集合中所有的漏洞，这个步骤无法还原。",qus:"确定删除漏洞集？",buttonText:"确定",fontAwesomeText:"fa-check text-green icon-left"}}],size:"sm",resolve:{policyId:function(){return t}}});r.result.then(function(){},function(){})},l.toggle=function(){for(var e=0;e<l.table.length;e++)l.table[e].checked=l.selectAll},i();var s=t.$on("refreshPolicy",function(){i()});t.$on("destroy",function(){s()})}var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/blacklist/policy-management-table.10a8bf7c.html",controller:["$rootScope","$scope","Signature","$modal","$state",e],controllerAs:"policies",link:function(){}};return t}function n(){function e(e,t,n,o,a,r,i,l,s,c,d,u){"ngInject";function p(e,t,a,r,i){"SIGNATURE"===r.type?r.signatures=a.data:r.rules=a.data,e.policyBlocks=r,e.deployedPolicy=i.data.inUse,e.changeAction=function(e,t){e.action=t,"SIGNATURE"===r.type?o.changeAction(r.policyBlockId,e.signatureId,t).then(function(e){}):n.changeAction(r.policyBlockId,e.ruleId,t).then(function(e){})},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}function f(){var e={$skip:(m.currentPage-1)*m.numPerPage,$limit:m.numPerPage,$orderby:"createdAt,priority,name"};m.predicate&&(e.sorting=(m.reverse?"-":"+")+m.predicate),n.getPolicyBlockbyPolicyId(g,"ReadyDeploy",null,e).then(function(e){m.table=e.data}),n.getPolicyBlockCountbyPolicyId(g,"ReadyDeploy").then(function(e){m.totalNum=e.data||0})}var m=this;m.currentPage=1,m.numPerPage=20,m.table=[];var g=a.policyId,h=e.$on("refreshPolicy",function(){f()});e.$on("destroy",function(){h()}),m.deploy=function(){var e=0,o=t.open({templateUrl:"/templates/rule/blacklist/confirmDeploy.8cda062f.html",controller:["$scope","$modalInstance",function(e,t){e.msg={text:"部署新规则将会覆盖原部署规则，这个步骤无法还原。",qus:"确定部署新规则？",buttonText:"部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"规则将无法部署以下未连线设备：",hasIDS:!1,hasIDSText:"以下监测审计设备上的阻断规则会被智能替换为告警。",noProtocolWarning:!1,noProtocolWarningText:"以下数采隔离设备没有选择数采隔离协议。如果部署规则，经过以下隔离设备的所有的协议流量将会被阻止。",isShowDeviceUpgradingMsg:!1},e.ok=function(){e.msg.isShowDeviceUpgradingMsg?t.dismiss("cancel"):t.close()},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});o.result.then(function(){n.deploy(g).then(function(t){var n=t.data.taskId,o=s.defer();i.deployTaskPromise=o.promise,i.deployTaskPromise.then(function(e){"success"===e&&u.go("rule.blacklist",{tab:"deployedPanel"})}),function e(t){var a=r(function(){l.getTask(n,i.currentIp).then(function(n){"SUCCESS"===n.data.state?(i.addAlert({type:"success",content:"部署成功"}),i.$broadcast("updateDashboardHeader"),o.resolve("success"),r.cancel(a)):"FAILED"===n.data.state?(i.addAlert({type:"danger",content:n.data.reason?"部署失败："+n.data.reason:"部署失败"}),o.resolve("fail"),r.cancel(a)):t>0?e(t-1):(o.resolve("timeout"),i.addAlert({type:"danger",content:"部署超时"}))})},1e3)}(120+15*e)},function(e){i.addAlert({type:"danger",content:e.data.rejectReason?"部署失败："+e.data.rejectReason:"部署失败"})})},function(){})},f(),m.pageChanged=function(){f()},m.showDetail=function(e){var o=t.open({templateUrl:"/templates/rule/blacklist/policyContent-signature.8c9613b2.html",controller:["$scope","$modalInstance","items","policyBlock","policy",p],backdrop:!0,size:"lg",resolve:{items:function(){return"SIGNATURE"===e.type?n.getSignaturesbyBlockId(e.policyBlockId):n.getRulesbyBlockId(e.policyBlockId)},policyBlock:function(){return e},policy:function(){return n.getPolicyByPolicyId(g)}}});o.result.then(function(e){},function(){})}}e.$inject=["$scope","$modal","Signature","Template","$stateParams","$timeout","$rootScope","Task","$q","CommonService","System","$state"];var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/blacklist/policy-detail-table.199b115f.html",controller:e,controllerAs:"policyItem",link:function(){}};return t}angular.module("southWest.rule.blacklist").directive("blacklistDeployedTable",e).directive("blacklistPolicyManagementTable",t).directive("blacklistPolicyDetailTable",n)}(),function(){"use strict";function e(e,t,n,o,a,r,i){"ngInject";function l(l,s,c,d){function u(e){var t=e||{};return t.$orderby="priority,name",t.$filter&&delete t.$filter,r.getAll(I,"NoDeploy","signature",p(),f(),m(),g(),t)}function p(){var e="";if(y.advancedSearch.enable){for(var t in b[0].options)b[0].options[t].value===!0&&(e+=b[0].options[t].name+",");e=e.substring(0,e.length-1)}return e}function f(){var e="";return y.advancedSearch.enable&&""!==b[1].value.trim()&&(e=b[1].value),e}function m(){var e="";return y.advancedSearch.enable&&""!==b[3].value.trim()&&(e=b[3].value),e}function g(){var e="";return y.advancedSearch.enable&&""!==b[4].value.trim()&&(e=b[4].value),e}function h(e){var t=e||{};return t.$filter&&delete t.$filter,r.getCount(I,"NoDeploy","signature",p(),f(),m(),g(),t)}function v(e){return o.getAll({$filter:T(e)})}var y=d;y.table=[],y.blockCount=0,y.selectedBlockCount=0,y.selectedSignatureCount=0,y.selectAll=!1,y.selectAllCheckBox=!0,y.selectAllSigs=!1,y.selectAllSigsText="",y.updateNumPerPage=function(){},y.disableToolbar=!0,y.selectAllSignature=function(){y.selectAllCheckBox=!y.selectAllCheckBox,y.selectAllSigs=!y.selectAllSigs,y.selectAllSigsText=y.selectAllSigs?"清除全部勾选":"全选所有漏洞",y.selectAll=y.selectAllSigs,y.selectedBlockCount=y.selectAllSigs?y.totalNum:0;for(var e=0;e<y.table.length;e++)y.table[e].checked=y.selectAllSigs},y.selectAllSigsText="全选所有漏洞",l.$on("updateLeftSelectAllStatus",function(){y.selectAllSigs||(y.selectAll=!1)});var I=e.policyId;y.typeSelected="请选择",y.valueChanged=function(){y.typeSelected="";for(var e in b[0].options)b[0].options[e].value===!0&&(y.typeSelected+=b[0].options[e].name+",");""===y.typeSelected?y.typeSelected="请选择":y.typeSelected=y.typeSelected.substring(0,y.typeSelected.length-1)},angular.element("input.signature").bind("change",function(e){var t=e.target.files[0];if(t){var n=t;y.uploadSignature(n),this.value=null}}),l.$on("signatures",function(){for(var e=[],t=0;t<y.table.length;t++)y.table[t].checked&&!y.table[t].deployed&&e.push(y.table[t].policyBlockId);if(y.selectAllSigs){var o={$limit:1e6,$orderby:"priority,name"};r.getAll(I,"NoDeploy","signature",p(),f(),m(),g(),o).then(function(t){e=t.map(function(e){return e.policyBlockId}),n.unlockPromise=r.unlock(I,i.policyName,e,"BLACKLIST").then(function(e){for(var t=0;t<y.table.length;t++)y.table[t].checked&&!y.table[t].deployed&&(y.table[t].deployed=!0);n.$broadcast("refreshPreDeployTable",e.data)})})}else e.length>0&&!y.selectAllSigs&&(n.unlockPromise=r.unlock(I,i.policyName,e,"BLACKLIST").then(function(e){for(var t=0;t<y.table.length;t++)y.table[t].checked&&!y.table[t].deployed&&(y.table[t].deployed=!0);n.$broadcast("refreshPreDeployTable",e.data)}))}),y.uploadSignature=function(e){r.signatureIsValid(e,I).then(function(n){if("success"===n.data.message)return r.uploadSignature(e,I);var o=t.open({templateUrl:"/templates/rule/blacklist/confirmUpload.0c5d6dd0.html",controller:["$scope","$modalInstance",function(e,t){e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}],backdrop:!0,size:"sm"});return o.result.then(function(){return r.uploadSignature(e,I)},function(){})}).then(function(e){e=e.data,d.getTableData(),d.getTableDataCount(),n.addAlert({type:"success",content:"上传成功"+(e.newSids.length>0?", 增加"+e.newSids.length+"条漏洞规则":"")+(e.updatedSids.length>0?", 更新"+e.updatedSids.length+"条漏洞规则":"")+(e.deletedSids&&e.deletedSids.length>0?", 删除"+e.deletedSids.length+"条漏洞规则":"")+(e.invalidSids.length>0?", "+e.invalidSids.length+"条无效漏洞规则":"")})}).catch(function(e){n.addAlert({type:"danger",content:"上传失败"+(e.error?": "+e.error:e.data.message?e.data.message:"")})})};var D=function(e,t,n,o){"SIGNATURE"===o.type?o.signatures=n.data:o.rules=n.data,e.policyBlocks=o,e.changeAction=function(e,t){e.action=t,"SIGNATURE"===o.type?a.changeAction(o.policyBlockId,e.signatureId,t).then(function(e){}):r.changeAction(o.policyBlockId,e.ruleId,t).then(function(e){})},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}};y.showDetail=function(e){var n=t.open({templateUrl:"/templates/rule/blacklist/policyContent-signature.8c9613b2.html",controller:["$scope","$modalInstance","items","policyBlock",D],backdrop:!0,size:"lg",resolve:{items:function(){return r.getSignaturesbyBlockId(e.policyBlockId)},policyBlock:function(){return e}}});n.result.then(function(e){},function(){})},y.countSelected=function(e){e.checked?(y.selectedBlockCount++,y.selectedSignatureCount+=e._signaturesCount):(y.selectedBlockCount--,y.selectedSignatureCount-=e._signaturesCount);for(var t=0,n=0,o=0;o<y.table.length;o++)y.table[o].deployed||(t++,y.table[o].checked&&n++);var a=n>0,r=n===t;y.selectAll=!!a&&(!!r||null)},y.toggle=function(){y.selectedBlockCount=0,y.selectedSignatureCount=0;for(var e=0;e<y.table.length;e++)y.table[e].deployed||(y.table[e].checked=y.selectAll,y.selectAll&&(y.selectedBlockCount++,y.selectedSignatureCount+=y.table[e]._signaturesCount))},n.$on("refreshSignatureTable",function(){d.getTableData()});var T=function(e){var t=["name","make","modelIdentifier","serialNumber","_zoneNames","devicePorts","portsNumber","protectedDevicesNumber"];return t.map(function(t){return"contains("+t+", '"+e+"')"}).join(" or ")},b=[];b.push({name:"type",display:"类型",input:"list_checkbox",option:!0,value:[],options:[{name:"botnet",value:"false"},{name:"code_execution",value:"false"},{name:"dos",value:"false"},{name:"info_leak",value:"false"},{name:"misc_activity",value:"false"},{name:"overflow",value:"false"},{name:"scan",value:"false"},{name:"sql_injection",value:"false"},{name:"trojan",value:"false"},{name:"worm",value:"false"},{name:"xss",value:"false"}]}),b.push({name:"description",display:"描述",input:"string",option:!1,value:""}),b.push({}),b.push({name:"sid",display:"特征编号",input:"string",option:!1,value:""}),b.push({name:"signame",display:"特征名称",input:"string",option:!1,value:""});var S={name:"signature",pagination:!0,scrollable:!1,totalCount:!1,advancedSearch:{enable:!0},getAll:u,getCount:h,search:v,fields:[]};y.disableSearch=!0,y.query=y.isSearching=y.advancedSearchQuery="",angular.extend(S,{advancedSearchOptions:b}),y.setConfig(S)}var s={restrict:"E",scope:!1,require:"^dtable",replace:!0,templateUrl:"/templates/rule/blacklist/signature-table.75a85016.html",link:l};return s}e.$inject=["$stateParams","$modal","$rootScope","Device","Template","Signature","dataservice"],angular.module("southWest.rule.blacklist").directive("blacklistSignatureTable",e)}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f){"ngInject";function m(){n.getPolicyBlockCountbyPolicyId(D,"ReadyDeploy").then(function(e){I.totalNum=e.data||0})}function g(e){var t={$skip:(I.currentPage-1)*I.numPerPage,$limit:I.numPerPage,$orderby:"createdAt,priority,name"};I.predicate&&(t.sorting=(I.reverse?"-":"+")+I.predicate);var a=[];a.push(n.getPolicyByPolicyId(D)),a.push(c.getCurDate()),u.all(a).then(function(a){if(a[0]&&a[1]){if(a[0].data)return I.policy=a[0].data,I.enableDefaultRuleEdit=!0,i.policyName=I.policy.name,I.policy.inUse&&e&&(I.foreverDeployed=o.alreadyDeployed=I.alreadyDeployed=!0),n.getPolicyBlockbyPolicyId(D,"ReadyDeploy",null,t);if(a[1].data){I.enableDefaultRuleEdit=!1;var r=a[1].data;r=r.replace(" ","T"),r+="Z",r=moment(r).format("YYYY-MM-DD HH:mm:ss"),r=r.replace(" ","-"),r=r.substring(0,r.lastIndexOf(":"));var l="规则-"+r;i.policyName=l,I.policy={name:i.policyName}}else{I.enableDefaultRuleEdit=!1;var s=new Date,c=s.getMonth()+1,d=c<10?"0"+c:c,u=s.getDate()<10?"0"+s.getDate():s.getDate(),p=s.getHours()<10?"0"+s.getHours():s.getHours(),f=s.getMinutes()<10?"0"+s.getMinutes():s.getMinutes(),m="规则-"+s.getFullYear()+"-"+d+"-"+u+"-"+p+":"+f;i.policyName=m,I.policy={name:i.policyName}}}}).then(function(t){if(t){0===t.data.length&&e&&(I.foreverDeployed=o.alreadyDeployed=I.alreadyDeployed=!1),I.policy.blocks=t.data,I.table=y(t.data);for(var n=0;n<I.table.length;n++)h(I.table[n].policyBlockId)}})}function h(e){n.getSignaturesbyBlockId(e).then(function(e){v(e.data[0])})}function v(e){for(var t=0;t<I.table.length;t++)I.table[t].policyBlockId===e._policyBlockId&&(I.table[t].sigAction=e.action)}function y(e){I.blockCount=0;for(var t=0;t<e.length;t++)"SIGNATURE"===e[t].type?I.blockCount+=e[t]._signaturesCount:I.blockCount+=e[t]._rulesCount;return n.getPolicySignatureRulesCount(D).then(function(e){o.disableDeploy=e&&0===e.data}),e}var I=this;I.currentPage=1,I.numPerPage=10,I.policy={},I.table=[],I.disableRearrange=!0,I.actions=["允许","警告","阻断"],I.foreverDeployed=o.alreadyDeployed=I.alreadyDeployed=!1,I.blockCount=0,I.enableDefaultRuleEdit=!1,I.isDPIUpgrading=s.isDPIUpgrading(),o.disableDeploy=!1,o.$on("dpiUpgradeState",function(){I.isDPIUpgrading=s.isDPIUpgrading()});var D=d.policyId;o.$$listeners.refreshPreDeployTable=[],o.$on("refreshPreDeployTable",function(e,t){(t>0||t.length)&&(o.alreadyDeployed=I.alreadyDeployed=!1,I.enableDefaultRuleEdit=!0,n.getPolicyByPolicyId(D).then(function(e){e.data&&(I.policy=e.data)}),g(),m())}),I.deleteAllPredeployPolicy=function(){function e(e,t,n,a){e.done=function(){n.deleteAllBlocksByPolicyIdandType(D,"SIGNATURE").then(function(){I.pageChanged(),o.addAlert({type:"success",content:"删除规则成功"})},function(e){a.reload().then(function(){o.addAlert({type:"danger",content:"学习规则删除失败："+e.data.error})})}),t.close("done")},e.cancel=function(){t.dismiss("cancel")}}var n=t.open({templateUrl:"templates/rule/blacklist/confirmDeleteAllPreDeploy.7171e8dd.html",controller:["$scope","$modalInstance","Signature","$state",e],size:"sm"});n.result.then(function(){},function(){p.info("Modal dismissed at: "+new Date)})},I.changeDefaultRuleAction=function(e,t,a){var r=null,i=null;"supportRuleAction"===t?(r=a,i=e.unknownRuleAction):"unknownRuleAction"===t&&(r=e.supportRuleAction,i=a),n.changeDefaultRuleAction(D,r,i).then(function(t){o.alreadyDeployed=I.alreadyDeployed=!1,e.supportRuleAction=t.data.supportRuleAction,e.unknownRuleAction=t.data.unknownRuleAction})},I.changeName=function(){n.changePolicyName(D,I.policy.name).then(function(e){i.policyName=e.data.name,o.$broadcast("updateDashboardHeader")})},I.changeAction=function(e,t){I.alreadyDeployed=!1;var o={action:t};n.changeActionToAllinOnePolicyBlock(e.policyBlockId,o).then(function(){})},I.changeActionToAll=function(e){I.alreadyDeployed=!1;var t=u.defer();o.ActionPromise=t.promise;var a={action:e};n.changeActionToAllInOnePolicy(D,a).then(function(){t.resolve("success"),I.pageChanged()},function(){t.resolve("fail")})},I.removePolicyBlockFromPolicy=function(){},g(!0),m(),I.pageChanged=function(){g(),m()};var T=function(e,t,o,a,r,i,s){e.enableEdit=!0,e.enableAction=s,"SIGNATURE"===a.type?a.signatures=o.data:a.rules=o.data,e.changePolicyBlockAction=function(e,t){var o={action:t};n.changeActionToAllinOnePolicyBlock(e.policyBlockId,o).then(function(){})},e.changeRiskLevel=function(e,t){e.riskLevel=t,n.changeSignatureRiskLevel(e.signatureId,e.riskLevel).then(function(e){})},e.policyBlocks=a,r(e),i(e),e.changeAction=function(e,t){I.alreadyDeployed=!1,e.action=t,"SIGNATURE"===a.type?l.changeAction(a.policyBlockId,e.signatureId,t).then(function(){}):n.changeAction(a.policyBlockId,e.ruleId,t).then(function(){})},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}};I.showDetail=function(e,a){a||(I.alreadyDeployed=!1),I.alreadyDeployed=!1;var r=t.open({templateUrl:"/templates/rule/blacklist/policyContent.ffb34732.html",controller:["$scope","$modalInstance","items","policyBlock","tree","ruleItemEdit","enable",T],windowClass:"blacklist-modal",backdrop:!0,size:"lg",resolve:{items:function(){return"SIGNATURE"===e.type?n.getSignaturesbyBlockId(e.policyBlockId):n.getRulesbyBlockId(e.policyBlockId)},policyBlock:function(){return e},enable:function(){return a}}});r.result.then(function(){},function(){n.getPolicySignatureRulesCount(D).then(function(e){o.disableDeploy=e&&0===e.data})})},I.deleteAllPredeployPolicy=function(){function e(e,t,n,a){e.done=function(){var e=[];e.push(n.deleteAllBlocksByPolicyIdandType(D,"SIGNATURE")),u.all(e).then(function(e){for(var t="",n=0;n<e.length;n++)"undefined"!=typeof e[n].message&&e[n].message.length>0&&(t+=e[n].message+" ");t?o.addAlert({type:"danger",content:"删除规则失败："+t}):a.reload().then(function(){o.addAlert({type:"success",content:"删除规则成功"})})},function(e){o.addAlert({type:"danger",content:"删除规则失败："+e.data.error})}),t.close("done")},e.cancel=function(){t.dismiss("cancel")}}e.$inject=["$scope","$modalInstance","Signature","$state"];var n=t.open({templateUrl:"templates/rule/whitelist/confirmDeleteAllPreDeploy.370eefce.html",controller:e,size:"sm"});n.result.then(function(){},function(){p.info("Modal dismissed at: "+new Date)})},I.deletePredeployPolicy=function(e){I.alreadyDeployed=!1,o.$broadcast("refreshSignatureTable");var t=[e.policyBlockId];n.deleteBlocksByBlockIds(t).then(function(){I.pageChanged(),o.addAlert({type:"success",content:"删除规则成功"})},function(e){o.addAlert({type:"danger",content:"删除规则失败："+e.data.error})})},I.deploy=function(){var e=0,i=t.open({templateUrl:"/templates/rule/blacklist/confirmDeploy.8cda062f.html",controller:["$scope","$modalInstance",function(e,t){e.msg={text:"部署新规则将会覆盖原部署规则，这个步骤无法还原。",qus:"确定部署新规则？",buttonText:"部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"规则将无法部署以下未连线设备：",hasIDS:!1,hasIDSText:"以下监测审计设备上的阻断规则会被智能替换为告警。",noProtocolWarning:!1,noProtocolWarningText:"以下数采隔离设备没有选择数采隔离协议。如果部署规则，经过以下隔离设备的所有的协议流量将会被阻止。",isShowDeviceUpgradingMsg:!1},e.ok=function(){e.msg.isShowDeviceUpgradingMsg?t.dismiss("cancel"):t.close()},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});i.result.then(function(){return 0===I.table.length?void o.addAlert({type:"danger",content:"没有有效的规则，不可部署"}):void n.deploy(D).then(function(t){var n=t.data.taskId,i=u.defer();o.deployTaskPromise=i.promise,o.deployTaskPromise.then(function(e){"success"===e&&f.go("rule.blacklist",{tab:"deployedPanel"})}),function e(t){var l=a(function(){r.getTask(n,o.currentIp).then(function(n){if("SUCCESS"===n.data.state){o.addAlert({type:"success",content:"部署成功"});for(var r=0;r<I.table.length;r++)I.table[r].status="ACTIVE";I.foreverDeployed=o.alreadyDeployed=I.alreadyDeployed=!0,o.$broadcast("updateDashboardHeader"),i.resolve("success"),a.cancel(l)}else"FAILED"===n.data.state?(o.addAlert({type:"danger",content:n.data.reason?"部署失败："+n.data.reason:"部署失败"}),i.resolve("fail"),a.cancel(l)):t>0?e(t-1):(i.resolve("timeout"),o.addAlert({type:"danger",content:"部署超时"}))})},1e3)}(120+15*e)},function(e){o.addAlert({type:"danger",content:e.data.rejectReason?"部署失败："+e.data.rejectReason:"部署失败"})})})}}e.$inject=["$scope","$modal","Signature","$rootScope","$timeout","Task","dataservice","Template","System","apiInfo","$stateParams","$q","$log","$state"];var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/blacklist/pre-deploy-table.7d958e91.html",controllerAs:"policyblocks",controller:e};return t}angular.module("southWest.rule.blacklist").directive("blacklistPreDeployTable",e)}(),function(){"use strict";function e(e,t,n){function o(o,a,r,i,l,s,c){function d(e){for(var t=0;t<e.length;t++)for(var n=0;n<e[t].devicePorts.length;n++)e[t].devicePorts[n].isMgmtPort&&(e[t].mac=e[t].devicePorts[n].mac,e[t].ip=e[t].devicePorts[n].portIp)}function u(){var o={$filter:f};e.getAll(o).then(function(a){var s=a.map(function(a){p.selectDPI.push(!1),a.deployRulesNum=0;for(var r=0;r<a.devicePorts.length;r++)a.deployRulesNum+=a.devicePorts[r].deployedRulesNumber,
a.devicePorts[r].isMgmtPort&&(a.mgmtIp=a.devicePorts[r].portIp);return o={$filter:m},l.isRemote()?i.domainLogin[a.mgmtIp]?e.getAllForIpMacBinding(o,null,a.mgmtIp).then(function(t){return a.ipmac=t,n.getIPMACPolicy(null,a.mgmtIp).then(function(t){return a.ipmacPolicy=t.data,e.getAll(o,null).then(function(e){a.factoryDevice=e,d(a.factoryDevice)})})}):t.autoLogin(a.mgmtIp).then(function(){return e.getAllForIpMacBinding(o,null,a.mgmtIp).then(function(t){return a.ipmac=t,n.getIPMACPolicy(null,a.mgmtIp).then(function(t){return a.ipmacPolicy=t.data,e.getAll(o,null,a.mgmtIp).then(function(e){a.factoryDevice=e,d(a.factoryDevice)})})})}):e.getAllForIpMacBinding(o,null,a.mgmtIp).then(function(t){return a.ipmac=t,n.getIPMACPolicy(null,a.mgmtIp).then(function(t){return a.ipmacPolicy=t.data,e.getAll(o).then(function(e){a.factoryDevice=e,d(a.factoryDevice)})})})});return s.length?r.all(s).then(function(){p.dpiData=a}):[]})}var p=this;p.actionAll="DROP",p.turnOnAll=!1,p.dpiSelectAll=!1,p.selectDPI=[];var f="category eq SECURITY_DEVICE",m="category eq FACTORY_DEVICE";p.selectAllDPI=function(){for(var e=0;e<p.selectDPI.length;e++)p.selectDPI[e]=!!p.dpiData[e].deviceOnline&&p.dpiSelectAll},p.isEmpty=function(){return!p.selectDPI.filter(function(e){return e===!0})[0]},p.deploy=function(){if(p.isEmpty())return void i.addAlert({type:"danger",content:"请先选择需要部署规则的设备！"});var t={};t.ipMacAction=p.actionAll;for(var a=[],l=0;l<p.dpiData.length;l++)if(p.selectDPI[l]){for(var d=[],f=0;f<p.dpiData[l].factoryDevice.length;f++)for(var m=0;m<p.dpiData[l].factoryDevice[f].devicePorts.length;m++)p.dpiData[l].factoryDevice[f].devicePorts[m].isMgmtPort&&p.dpiData[l].factoryDevice[f].devicePorts[m].mac&&d.push(p.dpiData[l].factoryDevice[f].deviceId);a.push(n.changeIPMACAction(t,p.dpiData[l].mgmtIp)),d.length&&(p.turnOnAll?a.push(e.createIPMACBinding(null,d,p.dpiData[l].mgmtIp)):a.push(e.deleteIPMACBinding(null,p.dpiData[l].mgmtIp)))}r.all(a).then(function(){for(var e=[],t=0;t<p.dpiData.length;t++)p.selectDPI[t]&&e.push(p.dpiData[t].serialNumber);n.deployAll(e,"IPMAC").then(function(e){p.showEdit=!1;var t=e.data.taskId,n=r.defer();i.isDeployingAll=!0,i.deployAllTaskPromise=n.promise,function e(a){var r=s(function(){c.getTask(t,i.currentIp).then(function(t){"SUCCESS"===t.data.state?(o.reload(),i.addAlert({type:"success",content:"部署成功"}),n.resolve("success"),s.cancel(r),i.isDeployingAll=!1,u()):"FAILED"===t.data.state?(i.addAlert({type:"danger",content:t.data.reason?"部署失败："+t.data.reason:"部署失败"}),n.resolve("fail"),s.cancel(r),i.isDeployingAll=!1):a>0?e(a-1):(n.resolve("timeout"),i.addAlert({type:"danger",content:"部署超时"}),i.isDeployingAll=!1)})},1e3)}(120)})})},u()}var a={scope:!1,restrict:"E",templateUrl:"/templates/rule/ipmac/ipmac-all-dpi-table.ece35b22.html",controller:o,controllerAs:"IpMacAllDpi",link:function(){}};return a}e.$inject=["Device","auth","Signature"],angular.module("southWest.rule.ipmac").directive("ipmacAllDpiTable",e)}(),function(){"use strict";function e(e){e.state("rule.ipmac",{url:"/ipmac",controller:"IPMACCtrl as ipmac",templateUrl:"templates/rule/ipmac/index.03d32323.html",resolve:{allAreas:["SecurityArea","secretKey",function(e,t){return e.getAllSecurityAreaAndAssets({}).then(function(e){return e})}]}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.ipmac").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d){function u(e,t,n,o,a,i){e.msg={text:"部署新规则将会覆盖原部署规则，这个步骤无法还原。",qus:"确定部署新规则？",buttonText:"部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"规则将无法部署以下未连线设备：",hasIDSText:"以下监测审计设备上的阻断规则会被智能替换为告警。"},e.deploy=function(){var e=[];e.push(p.changeIPMACAction(i)),e.push(p.changeIPMACSwitch());var n=s.defer();t.deployTaskPromise=n.promise,s.all(e).then(function(e){e[0]&&e[1]?r.deploy(a.policyId).then(function(e){p.isEditing=!1;var a=e.data.taskId;!function e(r){var i=o(function(){l.getTask(a).then(function(a){"SUCCESS"===a.data.state?(t.$broadcast("updateDashboardHeader"),o.cancel(i),p.ipmac.lockedType="DEPLOYED",t.addAlert({type:"success",content:"部署成功"}),n.resolve("success")):"FAILED"===a.data.state?(t.addAlert({type:"danger",content:a.reason?"部署失败："+a.reason:"部署失败"}),n.resolve("fail"),o.cancel(i)):r>0?e(r-1):(n.resolve("timeout"),t.addAlert({type:"danger",content:"部署超时"}),p.reload())})},4e3)}(120)},function(e){t.addAlert({type:"danger",content:e.data.rejectReason?"部署失败："+e.data.rejectReason:"部署失败"})}):(p.isEditing=!1,t.addAlert({type:"danger",content:"IP/MAC绑定处理规则部署失败"}),n.resolve("fail"),p.reload())})},e.ok=function(){e.deploy(),n.close()},e.cancel=function(){n.dismiss("cancel")}}u.$inject=["$scope","$rootScope","$modalInstance","$timeout","ipmac","table"];var p=this;p.binding="on",p.rule="alert",p.log="on",p.show={ip:[],mac:[]},p.validIP=/^([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$/,p.validMAC=/^(([A-Fa-f0-9]{2}[:]){5}[A-Fa-f0-9]{2}[,]?)+$/,p.isEditing=!1,p.ipmac={},p.unknownDeviceAction="DROP",p.array=[],p.isDPIUpgrading=a.isDPIUpgrading(),i.$on("dpiUpgradeState",function(){p.isDPIUpgrading=a.isDPIUpgrading()}),i.$on("refreshRuleCurrentIp",function(){c.reload()}),e.$watch(function(){p.switchStatus=!!e.dtable&&e.dtable.enableIpmac||p.enabledUnknowDeviceMonite||p.enableArpAntiDeception}),p.editRight=p.editRight&&p.editRight[0]&&30===p.editRight[0].actionValue,p.getIPMACStatus=function(){r.getIPMACPolicy().then(function(e){p.ipmac=e.data})},p.getIPMACSwitch=function(){r.getIPMACSwitch().then(function(e){e.data.map(function(e){if("IP_MAC"===e.subscriptionType&&0===e.operationStatus){if("unknow_device_monite"===e.subscriptionName)switch(p.enabledUnknowDeviceMonite="OFF"!==e.subscriptionStatus,e.subscriptionStatus){case"ON_REJECTBOTH":p.unknownDeviceAction="REJECTBOTH";break;case"ON_DROP":p.unknownDeviceAction="DROP";break;default:p.unknownDeviceAction="ALERT"}}else"ARP_ANTIDECEPTION"===e.subscriptionType&&0===e.operationStatus&&"arp_antideception"===e.subscriptionName&&(p.enableArpAntiDeception="OFF"!==e.subscriptionStatus)})})},p.reload=function(){i.$broadcast("ipmacTableRefresh",function(){p.getIPMACStatus(),p.getIPMACSwitch()})},p.deploy=function(o){var a=n.open({animation:e.animationsEnabled,templateUrl:"/templates/rule/ipmac/confirmIPMAC.bcffe96c.html",controller:u,size:"sm",resolve:{ipmac:function(){return p.ipmac},table:function(){return o}}});a.result.then(function(){},function(){t.info("Modal dismissed at: "+new Date)})},p.editIPMAC=function(e){p.isEditing=!0,p.tableBindingIsNotEmptyBool=!1;for(var t=0;t<e.length;t++)if(e[t]._ipmacBoolean){p.tableBindingIsNotEmptyBool=!0;break}p.IPMACTableTmp=[],p.errorPool={pool:[],errorIndex:[],errorDup:[],bool:!0},p.oldIpmacData=angular.copy(e),p.validateBindingTable(e)},p.areaSelect=function(e){if(e._ipmacBoolean)for(var t=0;t<e.assetInfos.length;t++)e.assetInfos[t]._ipmacBoolean=!0;else for(var n=0;n<e.assetInfos.length;n++)e.assetInfos[n]._ipmacBoolean=!1},p.assetSelect=function(e){for(var t=0,n=0;n<e.length;n++){for(var o=0;o<e[n].assetInfos.length;o++)e[n].assetInfos[o]._ipmacBoolean&&t++;e[n].assetInfos.length>0&&e[n].assetInfos.length===t&&(e[n]._ipmacBoolean=e[n].assetInfos[0]._ipmacBoolean,t=0)}},p.validateBindingTable=function(e){var t,n=0;for(t=0;t<e.length;t++){for(var o=0;o<e[t].assetInfos.length;o++)e[t].assetInfos[o]._ipmacBoolean||(p.enabledUnknowDeviceMonite=!1,p.enableArpAntiDeception=!1,n++);e[t].assetInfos.length===n&&(e[t]._ipmacBoolean=!1),n=0}},p.selectAll=function(e,t){if(t){e.selectAll=!0;for(var n=0;n<e.table.length;n++){for(var o=0;o<e.table[n].assetInfos.length;o++)e.table[n].assetInfos[o]._ipmacBoolean=!0,e.table[n].assetInfos[o]._ipmac=1;e.table[n]._ipmacBoolean=!0,e.table[n]._ipmac=1}}},p.selectNone=function(e,t){if(t){e.selectAll=!0;for(var n=0;n<e.table.length;n++){for(var o=0;o<e.table[n].assetInfos.length;o++)e.table[n].assetInfos[o]._ipmacBoolean=!0;e.table[n]._ipmacBoolean=!0}}else{e.selectAll=!1;for(var a=0;a<e.table.length;a++){for(var r=0;r<e.table[a].assetInfos.length;r++)e.table[a].assetInfos[r]._ipmacBoolean=!1;e.table[a]._ipmacBoolean=!1}}p.switchStatus=!p.switchStatus,e.enableIpmac=!!p.switchStatus},p.confirmEdit=function(e){p.deploy(e)},p.cancelEdit=function(){p.isEditing=!1,p.reload()},p.changeIPMACSwitch=function(){var e={};return e.ipMac=p.enabledUnknowDeviceMonite?"REJECTBOTH"===p.unknownDeviceAction?"ON_REJECTBOTH":"DROP"===p.unknownDeviceAction?"ON_DROP":"ON_ALARM":"OFF",e.arpAntiDeception=!!p.enableArpAntiDeception,r.changeIPMACSwitch(e).then(function(){return!0},function(e){return i.addAlert({type:"danger",content:"编辑未知设备接入监控失败"+(e&&e.data&&e.data.rejectReason?"："+e.data.rejectReason:"")}),!1})},p.changeIPMACAction=function(e){var t={};return t.ipMacAction=p.ipmac.ipMacAction,r.changeIPMACAction(t).then(function(){var t=angular.copy(e);p.array=[];for(var n=0;n<t.length;n++)for(var o=0;o<t[n].assetInfos.length;o++)t[n].assetInfos[o]._ipmacBoolean?t[n].assetInfos[o]._ipmac=1:t[n].assetInfos[o]._ipmac=0,delete t[n].assetInfos[o]._ipmacBoolean,p.array.push(t[n].assetInfos[o]);return p.array.length>0?d.createIPMACBinding(p.array).then(function(e){}):(d.deleteIPMACBinding().then(function(e){}),p.tableBindingIsNotEmptyBool=!1),!0})},p.getIPMACStatus(),p.getIPMACSwitch()}e.$inject=["$scope","$log","$modal","Device","System","Signature","$rootScope","Task","$q","$state","DeviceAsset"],angular.module("southWest.rule.ipmac").controller("IPMACCtrl",e)}(),function(){"use strict";function e(e,t){function n(n,o,a,r){function i(t){return t.enable=1,t.$orderby&&""!==t.$orderby||(t.$orderby="name"),e.getAllSecurityAreaAndAssets(t).then(function(e){return r.allValidAreas=e,r.importAreas=[],r.dropdownAreas=[],r.allValidAreas.forEach(function(e){"1"===e._ipmacRefers?r.importAreas.push(e):r.dropdownAreas.push(e)}),r.importAreas})}function l(t){return e.getCount(t)}var s=["sourceName","dpiName","destinationName","appLayerProtocol"];r.disableToolbar=!0,r.validIP=/^([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.([0-9]|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])$/,r.open=!1,r.selectedItems={},r.dropdownAreas=[],r.importAreas=[],r.setConfig({name:"device",pagination:!1,scrollable:!1,totalCount:!0,getAll:i,getCount:l,fields:s}),n.checkAll=function(){var e=r.table.filter(function(e){return e._ipmacBoolean});r.enableIpmac=!!e&&e.length>0},r.initSelectAll=function(){r.selectAll=!0;for(var e=0;e<r.importAreas.length;e++){for(var t=0;t<r.importAreas[e].assetInfos.length;t++)1===r.importAreas[e].assetInfos[t]._ipmac?r.importAreas[e].assetInfos[t]._ipmacBoolean=!0:r.importAreas[e].assetInfos[t]._ipmacBoolean=!1;var n=r.importAreas[e].assetInfos.filter(function(e){return e._ipmacBoolean});r.importAreas[e]._ipmacBoolean=!!n&&n.length>0}var o=r.importAreas.filter(function(e){return e._ipmacBoolean});r.enableIpmac=!!o&&o.length>0},r.selectAllorNone=function(){if(r.selectAll){r.selectAll=!1;for(var e=0;e<r.table.length;e++){for(var t=0;t<r.table[e].assetInfos.length;t++)r.table[e].assetInfos[t]._ipmacBoolean=!1;r.table[e]._ipmacBoolean=!1}}else{r.selectAll=!0;for(var n=0;n<r.table.length;n++){for(var o=0;o<r.table[n].assetInfos.length;o++)r.table[n].assetInfos[o]._ipmacBoolean=!0;r.table[n]._ipmacBoolean=!0}}r.enableIpmac=!!r.selectAll||r.enableIpmac,r.current=!0},r.import=function(){r.open=!1;var e=r.dropdownAreas,t=r.selectedItems;for(var n in t)if(t.hasOwnProperty(n)&&t[n])for(var o=0;o<r.dropdownAreas.length;o++)r.dropdownAreas[o].name===n&&(r.importAreas.push(r.dropdownAreas[o]),e.splice(o,1));r.dropdownAreas=e,r.selectedItems=[]},r.deleteSecurityArea=function(e){for(var t=0;t<r.importAreas.length;t++)if(r.importAreas[t].name===e.name){r.dropdownAreas.push(e),r.importAreas.splice(t,1);break}},t.$on("ipmacTableRefresh",function(e,t){r.refresh(),t()}),r.toggleCurrent=function(e,t){void 0!==t?e.current=t:e.current=!e.current}}var o={scope:!1,restrict:"E",require:"^?dtable",replace:!0,templateUrl:"/templates/rule/ipmac/table/table.69f19651.html",link:n};return o}e.$inject=["SecurityArea","$rootScope"],angular.module("southWest.rule.ipmac").directive("ipmacTable",e)}(),function(){"use strict";function e(e){e.state("rule.ipmacsync",{url:"/rule/ipmacsync?panel",controller:"ipmacsyncCtrl as ipmacsyncCtrl",templateUrl:"templates/rule/ipmacsync/index.6269a19e.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.ipmacsync").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m,g){var h=this;h.state=n.current.name,h.syncTask=null,h.editRight=s.get("privilege").filter(function(e){return"POLICY"===e.name}),h.editRight=h.editRight&&h.editRight[0]&&30===h.editRight[0].actionValue,h.isDPIUpgrading=l.isDPIUpgrading(),o.$on("dpiUpgradeState",function(){h.isDPIUpgrading=l.isDPIUpgrading()}),h.checkSyncInitial=function(){m.getLatestSyncTask("IPMAC").then(function(e){var n=a.defer();if(e.data.length>0)if(h.syncTask=e.data[0],"PENDING"===h.syncTask.state||"PROCESSING"===h.syncTask.state){h.syncTask.hasSyncingTask=!0;var r=e.data[0].taskId;h.syncTaskPromise=n.promise,function e(a){var i=t(function(){d.getTask(r).then(function(r){"SUCCESS"===r.data.state?(o.$broadcast("updateDashboardHeader"),n.resolve("success"),t.cancel(i),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!0,o.addAlert({type:"success",content:"检测规则同步成功"}),m.getSyncResultCount(p.id,{$filter:"ruleType eq IPMAC"}).then(function(e){h.syncTask.ipmacSyncResultCount=e})):"FAILED"===r.data.state?(n.resolve("fail"),t.cancel(i),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:r.data.reason?"检测规则同步失败："+r.data.reason:"检测规则同步失败"})):a>0?e(a-1):(n.resolve("timeout"),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:"检测规则同步超时"}))})},1e3)}(3600)}else h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!0,m.getSyncResultCount(p.id,{$filter:"ruleType eq IPMAC"}).then(function(e){h.syncTask.ipmacSyncResultCount=e})})},h.start=function(e){function t(t,r,i,s,c){var u;s.getDevices(c.id).then(function(e){l.getDPIUpgradeInfo().then(function(n){u=!!n.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],t.check={checkDisconnect:!0},t.msg={title:"检测规则同步",text:"检测规则同步会把DPI设备上部署的规则和监管平台上的规则进行比较。此操作可能需要几分钟时间。",qus:"确定开始检测规则同步？",buttonText:"检测规则同步",fontAwesomeText:"fa-search-plus",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法检测以下未连线设备的规则：",isShowDeviceUpgradingMsg:u},t.deviceDisconnetedPool=[];var o=[];o.push(s.getLinks(c.id));for(var r=0;r<e.data.length;r++)"SECURITY_DEVICE"===e.data[r].category&&(1!==e.data[r].deviceOnline?(t.msg.isShowDeviceDisconnectedMsg=!0,t.check.checkDisconnect=!1,t.deviceDisconnetedPool.push(e.data[r].name)):(t.msg.isShowDeviceConnectedCnt++,o.push(s.getDeviceNodes(e.data[r].deviceId))));a.all(o).then(function(){0===t.msg.isShowDeviceConnectedCnt&&(t.msg.text="没有设备在线，无法检测规则同步。",t.msg.qus="",t.msg.buttonText="关闭",t.msg.fontAwesomeText=""),t.msg.isShowDeviceUpgradingMsg&&(t.msg.text="DPI设备升级中，请稍后再试。",t.msg.qus="",t.msg.buttonText="关闭",t.msg.fontAwesomeText="")})})}),t.start=function(){m.checkSyncRules(c.id,"IPMAC").then(function(t){var r=a.defer();h.syncTaskPromise=r.promise,e&&(t.data.hasSyncingTask=h.syncTask.hasSyncingTask,t.data.hasSyncedTask=h.syncTask.hasSyncedTask,h.hasSyncResult()&&(t.data.ipmacSyncResultCount=h.syncTask.ipmacSyncResultCount)),h.syncTask=t.data;var l=h.syncTask.taskId;!function e(t){var a=i(function(){d.getTask(l).then(function(l){"SUCCESS"===l.data.state?(o.$broadcast("updateDashboardHeader"),r.resolve("success"),i.cancel(a),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!0,o.addAlert({type:"success",content:"检测规则同步成功"}),m.getSyncResultCount(c.id,{$filter:"ruleType eq IPMAC"}).then(function(e){h.syncTask.ipmacSyncResultCount=e,n.reload()})):"FAILED"===l.data.state?(r.resolve("fail"),i.cancel(a),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:l.data.reason?"检测规则同步失败："+l.data.reason:"检测规则同步失败"})):t>0?e(t-1):(r.resolve("timeout"),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:"检测规则同步超时"}))})},1e3)}(3600)},function(e){var t=409===e.status;o.addAlert({type:"danger",content:e.data.error?"检测规则同步失败："+e.data.error:"检测规则同步失败"+(t?"， 正在检测中， 请稍后再试。":"")})})},t.ok=function(){0===t.msg.isShowDeviceConnectedCnt||t.msg.isShowDeviceUpgradingMsg?r.dismiss("cancel"):(t.start(),r.close())},t.cancel=function(){r.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId"];var i=r.open({controller:t,templateUrl:"/templates/rule/ipmacsync/confirmStart.05e3d523.html",size:"sm"});i.result.then(function(){},function(){})},h.add=function(e,t){function i(r,i,l){r.ok=function(){var r=a.defer(),s="IPMAC"===t?"IPMAC":"";m.addSyncResultToLib(p.id,s,l).then(function(){r.resolve("success"),i.close(),e.getTableData(),o.addAlert({type:"success",content:"加入模板库成功"}),"IPMAC"===t&&(h.syncTask.ipmacSyncResultCount-=l.length),n.go("unknown.ipmac",{topologyId:p.id})},function(e){r.resolve("fail"),i.close(),o.addAlert({type:"danger",content:e.data.error?"加入模板库失败："+e.data.error:"加入模板库失败"})}),i.close()},r.cancel=function(){i.close()}}i.$inject=["$scope","$modalInstance","rules"];var l=r.open({templateUrl:"templates/rule/ipmacsync/confirmAdd.2681f148.html",controller:i,size:"sm",resolve:{rules:function(){var n=e.table,o=[];if(e.selectAllRules)m.getSyncResult(p.id,{$filter:"ruleType eq "+t,$limit:1e6}).then(function(e){for(var t=0;t<e.length;t++)o.push(e[t])});else for(var a=0;a<n.length;a++)if(n[a].checked){var r=angular.copy(n[a]);delete r.checked,o.push(r)}return o}}});l.result.then(function(){},function(){})},h.hasSyncingTask=function(){return h.syncTask&&h.syncTask.hasSyncingTask},h.hasSyncedTask=function(){return h.syncTask&&h.syncTask.hasSyncedTask},h.hasSyncResult=function(){return h.syncTask&&h.syncTask.hasSyncedTask&&h.syncTask.ipmacSyncResultCount>0},h.lastSyncSuccess=function(){return h.syncTask&&"SUCCESS"===h.syncTask.state},h.getProtocolType=g.getProtocolType,h.getSourcePort=g.getSourcePort,h.getDestinationPort=g.getDestinationPort,h.getRuleCreatedAt=g.getRuleCreatedAt,h.getIpmacStr=function(e){for(var t,n,o=e.fields,a=0;a<o.length;a++)"IP"===o[a].name?t=o[a].value:"MAC"===o[a].name&&(n=o[a].value);return t+"/"+n}}e.$inject=["$scope","$timeout","$state","$rootScope","$q","$modal","$interval","System","Enum","WhiteListService","Task","Topology","topologyId","Signature","SyncRules","ruleService"],angular.module("southWest.rule.ipmacsync").controller("ipmacsyncCtrl",e)}(),function(){"use strict";function e(e,t){function n(n,o,a,r){function i(o){return o.$orderby&&""!==o.$orderby?o.$orderby+=", priority":o.$orderby="priority",o.$filter&&""!==o.$filter?o.$filter+=" and ruleType eq IPMAC":o.$filter="ruleType eq IPMAC",n.params=o,e.getSyncResult(t.id,o).then(function(e){c.selectAllRules||(c.selectAll=!1,c.selectedDomainCount=0);for(var t=0;t<e.length;t++){var n=e[t];c&&(n.checked=c.selectAllRules)}return e})}function l(n){n.$filter&&""!==n.$filter?n.$filter+=" and ruleType eq IPMAC":n.$filter="ruleType eq IPMAC";var o=n||{};return e.getSyncResultCount(t.id,o)}function s(e){return c&&(c.selectAllRules=!0,c.selectAllRule()),i(e)}r.disableToolbar=!0,r.setConfig({name:"rules",pagination:!0,scrollable:!1,totalCount:!1,getAll:i,getCount:l,search:s});var c=r;c.table=[],c.selectedRuleCount=0,c.selectAll=!1,c.selectAllRules=!1,c.selectAllRulesText="",c.selectAllRule=function(){c.selectAllRules=!c.selectAllRules,c.selectAllRulesText=c.selectAllRules?"清除全部勾选":"全选所有规则",c.selectAll=c.selectAllRules,c.selectedRuleCount=c.selectAllRules?c.totalNum:0;for(var e=0;e<c.table.length;e++)c.table[e].checked=c.selectAllRules},c.selectAllRulesText="全选所有规则",c.countSelected=function(e){e.checked?c.selectedRuleCount++:(c.selectedRuleCount--,c.selectAll=!1)},c.toggle=function(){c.selectedRuleCount=0;for(var e=0;e<c.table.length;e++)c.table[e].deployed||(c.table[e].checked=c.selectAll,c.selectAll&&c.selectedRuleCount++)}}var o={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/rule/ipmacsync/syncIpmacResultTable.c0625ad3.html",link:n};return o}e.$inject=["SyncRules","topologyId"],angular.module("southWest.rule.ipmacsync").directive("syncIpmacResultTable",e)}(),function(){"use strict";function e(e){e.state("rule.whitelist_learning",{url:"/whitelist/learning",controller:"learningCtrl as learningCtrl",templateUrl:"templates/rule/learning/index.dcfb9239.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.learning").config(e)}(),function(){"use strict";function e(e,o,a,r,i,l,s,c,d,u,p,f,m){function g(){I.startdt=new Date((new Date).getTime()+D),I.startdt_date=I.startdt,I.startdt_time=I.startdt}function h(){I.now=new Date((new Date).getTime()+(D-1e3)),I.now.setSeconds(0)}function v(e,t,n){e.learningItems=n,e.recordTab={},e.tabs=[{name:"设备活动",active:!0,disable:!1},{name:"未知设备活动",active:!1,disable:!1}],e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss("cancel")}}function y(e,t,n){e.macItems=n,e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss("cancel")},e.updateMac=function(t){var n=angular.copy(t);n.assetMac=n.realMac,i.setTaskMac(n).then(function(){l.addAlert({type:"success",content:"MAC地址更新完成"}),i.getTaskMac(t.taskId).then(function(t){I.detailPanelItem.macData=e.macItems=t.data})},function(){l.addAlert({type:"danger",content:"MAC地址更新失败"})})}}v.$inject=["$scope","$modalInstance","items"],y.$inject=["$scope","$modalInstance","items"];var I=this;I.state=a.current.name,I.learningTasks=[],I.detailPanel={},I.showDetailPanel=!1,I.editLearningDetail=!1,I.isCollapsed=!0,I.taskId=null,I.interval=angular.copy(t),I.eventHandler={},I.viewLearningDetail=!1,I.countOfICRules=0,I.countOfIPRules=0,I.action=30,I.disabledAdd=!1,m.get("privilege").filter(function(e){"RULE_WHITELIST"===e.name&&(I.action=e.actionValue)}),I.titleshow=30===I.action,I.goBack=function(){window.history.back()},I.eventHandler.learningHandler=l.$on("learning",function(t,n){I.startLearningDefer&&I.startLearningDefer.resolve("success"),"LEARNING_STOPPED"===n.learningEventType&&(I.stopLearningDefer&&I.stopLearningDefer.resolve("success"),I.learningAbort||a.reload().then(function(){l.addAlert({type:"success",content:"学习任务完成"})}),I.learningAbort=!1),I.showDetailPanel||!I.enableAddSchedule?(I.learningDetail(I.taskId),e.$broadcast("refreshTask"),e.$broadcast("refreshLearningTable"),I.getTask().then(function(e){i.getLearningBlocksByRef(e.data._resultRef.baseUrls[0]).then(function(e){I.countOfICRules=e.data.length})})):I.checklearningTasks()}),I.eventHandler.learningResultHandler=l.$on("learningResult",function(t,n){I.detailPanelItem&&n.taskId&&n.taskId===I.detailPanelItem.taskId&&(I.detailPanelItem.learningResult=n.learningResult),I.showDetailPanel?(I.learningDetail(I.taskId),e.$broadcast("refreshTask"),e.$broadcast("refreshLearningTable")):I.checklearningTasks()}),I.eventHandler.learnedIpMacHandler=l.$on("learnedIpMac",function(e,t){I.detailPanelItem&&t.taskId&&t.taskId===I.detailPanelItem.taskId&&(I.detailPanelItem.macData=t)}),e.$on("$destroy",function(){I.eventHandler.learningHandler(),I.eventHandler.learningResultHandler(),I.eventHandler.learnedIpMacHandler()}),a.previous?r.setItem("previous",JSON.stringify(a.previous)):a.previous=JSON.parse(r.getItem("previous"));var D,T,b;e.$on("$destroy",function(){u.cancel(T),u.cancel(b)}),I.initTimePicker=function(e){p.initTimePicker(e,I,n).then(function(){D=I.startdt?new Date(I.startdt).getTime()-(new Date).getTime():0,u.cancel(T),u.cancel(b),g(),h(),T=u(g,40),b=u(h,40)})},I.cancelRenderTime=function(){u.cancel(T)},e.$watch("[learningCtrl.startdt_date, learningCtrl.startdt_time]",function(e){e&&e[0]&&e[1]&&(I.startdt=new Date(e[0].getFullYear(),e[0].getMonth(),e[0].getDate(),e[1].getHours(),e[1].getMinutes(),e[1].getSeconds())),I.intervalError=!1,I.intervalError=I.startdt<I.now}),I.calculateValues=function(){p.calculateValues(I)},I.checkInUsepolicy=function(e){p.checkInUsepolicy(e,I,"WHITELIST")},I.changeInterval=function(){p.changeInterval(I)},I.getPolicyId=function(){return a.params.policyId},I.getTask=function(){return i.getTask(I.taskId)},I.changeURL=function(e){p.changeURL(e)},I.changeLearningInterval=function(e){p.changeLearningInterval(e,I)},I.changeLearning=function(e){p.changeLearning(e,I)},I.checklearningTasks=function(){p.checklearningTasks(I)},I.remove=function(e){I.learningAbort=!0,I.stopCountDown(),I.initTimePicker(),i.removeLearningTask(e.taskId).then(function(){I.interval=angular.copy(t),I.checklearningTasks(),I.detailPanelItem=null},function(){I.detailPanelItem=null}).catch(function(){}).finally(function(){o(function(){I.disabledAdd=!1},5e3)})},I.openRecord=function(){var t=c.open({templateUrl:"/templates/rule/whitelist/device-activity-record.b0270c40.html",controller:v,size:"sm",resolve:{items:function(){return I.detailPanelItem.learningResult}}});t.result.then(function(t){e.selected=t},function(){d.info("Modal dismissed at: "+new Date)})},I.openIPMACRecord=function(){var t=c.open({templateUrl:"/templates/rule/whitelist/mac-activity-record.9be67985.html",controller:y,size:"lg",resolve:{items:function(){return I.detailPanelItem.macData}}});t.result.then(function(t){e.selected=t},function(){d.info("Modal dismissed at: "+new Date)})},I.countdown=function(e,t){p.countdown(e,t,I)},I.stopCountDown=function(){I.countDownloop&&u.cancel(I.countDownloop)},I.learningDetail=function(t){p.learningDetail(t,I,e)},I.setTimeInterval=function(){I.startLearningDefer=f.defer(),p.setTimeInterval(I)},I.setTime=function(){p.setTime(I)},I.pauseLearning=function(t){p.pauseLearning(t,I,e)},I.resumeLearning=function(t){p.resumeLearning(t,I,e)},I.cancelLearning=function(t){p.cancelLearning(t,I,e)},I.startLearning=function(){I.currentlyLearning=!0},I.refreshPreDeployTable=function(e){p.refreshPreDeployTable(e)},I.moveToPreDeployTable=function(){p.moveToPreDeployTable(e)},I.hasSuccessTask=function(){for(var e=0;e<I.learningTasks.length;e++){var t=I.learningTasks[e];if("SUCCESS"===t.state)return!0}return!1},I.editPolicy=function(e){s.createPolicy().then(function(t){a.go("rule."+e+"_manager.editor",{policyId:t.data.value,tab:"total"})})}}e.$inject=["$scope","$timeout","$state","localStorage","Learning","$rootScope","Signature","$modal","$log","$interval","WhiteListService","$q","Enum"],angular.module("southWest.rule.learning").controller("learningCtrl",e);var t={days:0,hours:0,minutes:2},n="2199-12-31"}(),function(){"use strict";function e(e){e.state("rule.maliciousdomain",{url:"/rule/maliciousdomain?panel",controller:"MaliciousDomainCtrl as maliciousdomain",templateUrl:"templates/rule/maliciousdomain/index.22a8d235.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],switchOn:["System","secretKey",function(e,t){return e.getJobStrategyInfo("MALICIOUS_DOMAIN_SCAN").then(function(e){return"true"===e.data.schedulingJob.jobData})}],policyId:["Signature","domain","secretKey",function(e,t,n){return t.getDomain().then(function(t){return e.getMaliciousDomainPolicy(t[0].domainInfo.currentTopologyId).then(function(e){return e.data[0].policyId})})}],waitingDomainCount:["Signature","secretKey",function(e,t){return e.getMaliciousDomainCount({$select:["domainName"],$filter:"deployStatus ne DEPLOYED"})}],deployedDomainCount:["Signature","secretKey",function(e,t){return e.getMaliciousDomainCount({$select:["domainName"],$filter:"deployStatus eq DEPLOYED"})}]}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.maliciousdomain").config(e)}(),function(){"use strict";function e(e,n,o,a,r,i,l,s,c,d,u,p,f,m){function g(e){var t=e.table,n=[];if(e.selectAllDomains){var o="";return e.query?o=" and (contains(domainName,'"+e.query+"'))":e.advancedSearchQuery&&(o=" and "+e.advancedSearchQuery),d.getMaliciousDomains({$filter:"deployStatus ne DEPLOYED"+o,$limit:1e6}).then(function(e){for(var t=0;t<e.length;t++)n.push(e[t]);return n})}for(var a=0;a<t.length;a++)t[a].checked&&(delete t[a].checked,n.push(t[a]));return n}function h(n,o,a){o.selectAll=!1,o.selectedDomainCount=0;for(var i=[],l=0;l<n.length;l++)n[l].maliciousDomainStatus!==a&&(n[l].maliciousDomainStatus=a,i.push(d.changeActionToMaliciousDomain(n[l])));if(i.length){var s="忽略";"ACTIVATED"===a&&(s="激活"),t(o,!0),r.all(i).then(function(){t(o,!1),o.getTableData(),e.addAlert({type:"success",content:s+"全部选中域名规则成功"})},function(n){t(o,!1);var a=n.config&&n.config.data?n.config.data.domainName:"";e.addAlert({type:"danger",content:(n.data.error?s+"域名规则失败："+n.data.error:s+"域名规则失败")+(a?": "+a:"")})})}}var v=this;v.editRight=l.get("privilege").filter(function(e){return"POLICY"===e.name}),v.editRight=v.editRight&&v.editRight[0]&&30===v.editRight[0].actionValue,v.isDPIUpgrading=i.isDPIUpgrading(),e.$on("dpiUpgradeState",function(){v.isDPIUpgrading=i.isDPIUpgrading()}),v.switchOn=u,v.waitingDomainCount=f,v.deployedDomainCount=m,v.new=function(t){function o(n,o,a,i){n.newDomains=[];var l={};l.domainName="",l.action="ALERT",l.domainProtocolType="DNS",n.newDomains.push(l),n.addMaliciousDomain=function(){var a=r.defer(),i=[];for(var l in n.newDomains)if(l){var s=angular.copy(n.newDomains[l]);delete s.invalidDomain,delete s.hasDuplicateDomain,i.push(d.addMaliciousDomain(s))}r.all(i).then(function(){a.resolve("success"),o.close(),t.getTableData(),e.addAlert({type:"success",content:"增加域名规则成功"}),v.waitingDomainCount+=n.newDomains.length},function(t){var n=t.config&&t.config.data?t.config.data.domainName:"";a.resolve("fail"),o.close(),e.addAlert({type:"danger",content:(t.data.error?"增加域名规则失败："+t.data.error:"增加域名规则失败")+(n?": "+n:"")})})},n.ok=function(){n.addMaliciousDomain()},n.cancel=function(){o.close()},n.add=function(){var e={};e.domainName="",e.action="ALERT",e.domainProtocolType="DNS",e.invalidDomain=!0,n.newDomains.push(e)},n.delete=function(e){n.newDomains.splice(e,1)},n.validate=function(){n.allNewDomainValid=!1;for(var e=!1,t=0;t<n.newDomains.length;t++){var o=n.newDomains[t];o.invalidDomain?e=!0:(n.validateDulplcate(o),o.hasDuplicateDomain&&(e=!0))}n.allNewDomainValid=!e},n.validateDulplcate=function(e){if(e.hasDuplicateDomain=!1,e.domainName&&!e.invalidDomain){for(var t=0,o=0;o<n.newDomains.length;o++)if(n.newDomains[o].domainName.toUpperCase()===e.domainName.toUpperCase()&&(t++,t>1))return void(e.hasDuplicateDomain=!0);for(var r=0;r<a.length;r++)if(a[r].domainName.toUpperCase()===e.domainName.toUpperCase())return void(e.hasDuplicateDomain=!0);for(var l=0;l<i.length;l++)if(i[l].domainName.toUpperCase()===e.domainName.toUpperCase())return void(e.hasDuplicateDomain=!0)}},n.validateFormat=function(e){e.invalidDomain=!e.domainName||s.validateDomain(e.domainName)}}o.$inject=["$scope","$modalInstance","waitingDomains","deployedDomains"];var i=a.open({animation:n.animationsEnabled,templateUrl:"/templates/rule/maliciousdomain/new.7384395e.html",controller:o,size:"sm",resolve:{waitingDomains:function(){return d.getMaliciousDomains({$filter:"deployStatus ne DEPLOYED",$limit:1e6}).then(function(e){return e})},deployedDomains:function(){return d.getMaliciousDomains({$filter:"deployStatus eq DEPLOYED",$limit:1e6}).then(function(e){return e})}}});i.result.then(function(){},function(){})},v.changeStatus=function(t,n){t.maliciousDomainStatus=n;var o="";o="ACTIVATED"===n?"INACTIVATED":"ACTIVATED";var a=angular.copy(t);delete a.isdoing,delete a.checked,t.isdoing=!0,d.changeActionToMaliciousDomain(a).then(function(){t.isdoing=!1},function(n){t.isdoing=!1,t.maliciousDomainStatus=o,e.addAlert({type:"danger",content:n.data.error?"更改域名规则失败："+n.data.error:"更改域名规则失败"})})},v.changeStatusSelected=function(e,t){var n=g(e);n instanceof Array?h(n,e,t):n.then(function(n){h(n,e,t)})},v.delete=function(t,n){function o(n,o,a){n.domain=a,n.ok=function(){a.isdoing=!0,d.deleteMaliciousDomain(a.maliciousDomainId).then(function(){a.isdoing=!1,t.getTableData(),
e.addAlert({type:"success",content:"忽略域名规则成功"}),v.waitingDomainCount--},function(t){a.isdoing=!1,e.addAlert({type:"danger",content:t.data.error?"忽略域名规则失败："+t.data.error:"忽略域名规则失败"})}),o.close()},n.cancel=function(){a.isdoing=!1,o.close()}}o.$inject=["$scope","$modalInstance","domain"];var r=a.open({templateUrl:"templates/rule/maliciousdomain/confirmDelete.13968eae.html",controller:o,size:"sm",resolve:{domain:function(){return n}}});r.result.then(function(){},function(){})},v.deleteSelected=function(n){function o(o,a,i){o.ok=function(){var o=r.defer(),l=[];for(var s in i)s&&l.push(d.deleteMaliciousDomain(i[s].maliciousDomainId));t(n,!0),r.all(l).then(function(){t(n,!1),o.resolve("success"),a.close(),n.getTableData(),e.addAlert({type:"success",content:"忽略全部选中域名规则成功"}),v.waitingDomainCount-=i.length},function(r){t(n,!1);var i=r.config&&r.config.data?r.config.data.domainName:"";o.resolve("fail"),a.close(),e.addAlert({type:"danger",content:(r.data.error?"忽略域名规则失败："+r.data.error:"忽略域名规则失败")+(i?": "+i:"")})}),a.close()},o.cancel=function(){t(n,!1),a.close()}}o.$inject=["$scope","$modalInstance","domains"];var i=a.open({templateUrl:"templates/rule/maliciousdomain/confirmDelete.13968eae.html",controller:o,size:"sm",resolve:{domains:function(){var e=n.table,t=[];if(n.selectAllDomains){var o="";n.query?o=" and (contains(domainName,'"+n.query+"'))":n.advancedSearchQuery&&(o=" and "+n.advancedSearchQuery),d.getMaliciousDomains({$filter:"deployStatus ne DEPLOYED"+o,$limit:1e6}).then(function(e){for(var n=0;n<e.length;n++)t.push(e[n])})}else for(var a=0;a<e.length;a++)if(e[a].checked){var r={};r.maliciousDomainId=e[a].maliciousDomainId,r.domainName=e[a].domainName,r.action=e[a].action,t.push(r)}return t}}});i.result.then(function(){},function(){})},v.change=function(t,n){if(t.action!==n){var o=angular.copy(t.action);t.action=n;var a=angular.copy(t);delete a.isdoing,delete a.checked,t.isdoing=!0,d.changeActionToMaliciousDomain(a).then(function(){t.isdoing=!1},function(n){t.isdoing=!1,t.action=o,e.addAlert({type:"danger",content:n.data.error?"更改域名规则失败："+n.data.error:"更改域名规则失败"})})}},v.changeSelected=function(n,o){function i(o,a,i,l){o.action=i,o.ok=function(){var o=r.defer(),s=[];for(var c in l)if(c){var u=angular.copy(l[c]);u.action=i,s.push(d.changeActionToMaliciousDomain(u))}t(n,!0),r.all(s).then(function(){t(n,!1),o.resolve("success"),a.close();for(var r=n.table,l=0;l<r.length;l++)r[l].checked&&(r[l].action=i);e.addAlert({type:"success",content:"更改全部选中域名规则成功"})},function(r){t(n,!1);var i=r.config&&r.config.data?r.config.data.domainName:"";o.resolve("fail"),a.close(),e.addAlert({type:"danger",content:(r.data.error?"更改域名规则失败："+r.data.error:"更改域名规则失败")+(i?": "+i:"")})}),a.close()},o.cancel=function(){t(n,!1),a.close()}}i.$inject=["$scope","$modalInstance","action","domains"];var l=a.open({templateUrl:"templates/rule/maliciousdomain/confirmChange.e9ee3fa9.html",controller:i,size:"sm",resolve:{action:function(){return o},domains:function(){var e=n.table,t=[];if(n.selectAllDomains){var o="";n.query?o=" and (contains(domainName,'"+n.query+"'))":n.advancedSearchQuery&&(o=" and "+n.advancedSearchQuery),d.getMaliciousDomains({$filter:"deployStatus ne DEPLOYED"+o,$limit:1e6}).then(function(e){for(var n=0;n<e.length;n++)t.push(e[n])})}else for(var a=0;a<e.length;a++)if(e[a].checked){var r={};r.maliciousDomainId=e[a].maliciousDomainId,r.domainName=e[a].domainName,r.action=e[a].action,t.push(r)}return t}}});l.result.then(function(){},function(){})},v.deploy=function(n){function o(o,a,l,s,u,f){var m;s.getDevices(u.id).then(function(e){i.getDPIUpgradeInfo().then(function(t){m=!!t.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],o.check={checkDisconnect:!0},o.msg={title:"部署新域名规则",text:"部署新域名规则将会增加新规则到已部署的域名规则, 未激活的规则将不会被部署。",qus:"确定部署域名规则？",buttonText:"部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法部署域名规则到以下未连线设备：",isShowDeviceUpgradingMsg:m},o.deviceDisconnetedPool=[];var n=[];n.push(s.getLinks(u.id));for(var a=0;a<e.data.length;a++)"SECURITY_DEVICE"===e.data[a].category&&(1!==e.data[a].deviceOnline?(o.msg.isShowDeviceDisconnectedMsg=!0,o.check.checkDisconnect=!1,o.deviceDisconnetedPool.push(e.data[a].name)):(o.msg.isShowDeviceConnectedCnt++,n.push(s.getDeviceNodes(e.data[a].deviceId))));r.all(n).then(function(){0===o.msg.isShowDeviceConnectedCnt&&(o.msg.text="没有设备在线，无法部署域名规则。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText=""),o.msg.isShowDeviceUpgradingMsg&&(o.msg.text="DPI设备升级中，请稍后再试。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText="")})})}),o.deploy=function(){t(n,!0),d.deployMaliciousDomains("inc",p,f).then(function(o){var a=r.defer(),i=o.data.taskId;e.deployTaskPromise=a.promise,function o(r){var s=l(function(){c.getTask(i).then(function(i){"SUCCESS"===i.data.state?(e.$broadcast("updateDashboardHeader"),a.resolve("success"),l.cancel(s),n.getTableData(),e.addAlert({type:"success",content:"部署域名规则成功"}),v.waitingDomainCount-=f.length,v.deployedDomainCount+=f.length):"FAILED"===i.data.state?(t(n,!1),e.addAlert({type:"danger",content:i.data.reason?"部署域名规则失败："+i.data.reason:"部署域名规则失败"}),a.resolve("fail"),l.cancel(s)):r>0?o(r-1):(t(n,!1),a.resolve("timeout"),e.addAlert({type:"danger",content:"部署域名规则超时"}))})},1e3)}(120)},function(o){t(n,!1);var a=409===o.status;e.addAlert({type:"danger",content:o.data.error?"部署域名规则失败："+o.data.error:"部署域名规则失败"+(a?"， 正在部署中， 请稍后再试。":"")})})},o.ok=function(){0===o.msg.isShowDeviceConnectedCnt||o.msg.isShowDeviceUpgradingMsg?a.dismiss("cancel"):(o.deploy(),a.close())},o.cancel=function(){t(n,!1),a.dismiss("cancel")}}o.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId","domains"];var l=a.open({controller:o,templateUrl:"/templates/rule/maliciousdomain/confirmDeploy.dac31cc2.html",size:"sm",resolve:{domains:function(){var e=n.table,t=[];if(n.selectAllDomains){var o="";n.query?o=" and (contains(domainName,'"+n.query+"'))":n.advancedSearchQuery&&(o=" and "+n.advancedSearchQuery),d.getMaliciousDomains({$filter:"deployStatus ne DEPLOYED"+o,$limit:1e6}).then(function(e){for(var n=0;n<e.length;n++)"ACTIVATED"===e[n].maliciousDomainStatus&&t.push(e[n])})}else for(var a=0;a<e.length;a++)if(e[a].checked&&"ACTIVATED"===e[a].maliciousDomainStatus){var r={};r.maliciousDomainId=e[a].maliciousDomainId,r.domainName=e[a].domainName,r.action=e[a].action,t.push(r)}return t}}});l.result.then(function(){},function(){})},v.clear=function(n){function o(o,a,l,s,u){var f;s.getDevices(u.id).then(function(e){i.getDPIUpgradeInfo().then(function(t){f=!!t.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],o.check={checkDisconnect:!0},o.msg={title:"清空已部署规则",text:"清空已部署规则将会删除全部已经部署的域名规则。",qus:"确定清空已部署规则？",buttonText:"清空已部署规则",fontAwesomeText:"fa-times-circle-o",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法清空以下未连线设备上的全部已经部署的域名规则：",isShowDeviceUpgradingMsg:f},o.deviceDisconnetedPool=[];var n=[];n.push(s.getLinks(u.id));for(var a=0;a<e.data.length;a++)"SECURITY_DEVICE"===e.data[a].category&&(1!==e.data[a].deviceOnline?(o.msg.isShowDeviceDisconnectedMsg=!0,o.check.checkDisconnect=!1,o.deviceDisconnetedPool.push(e.data[a].name)):(o.msg.isShowDeviceConnectedCnt++,n.push(s.getDeviceNodes(e.data[a].deviceId))));r.all(n).then(function(){0===o.msg.isShowDeviceConnectedCnt&&(o.msg.text="没有设备在线，无法清空已部署规则。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText=""),o.msg.isShowDeviceUpgradingMsg&&(o.msg.text="DPI设备升级中，请稍后再试。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText="")})})}),o.clear=function(){t(n,!0),d.deployMaliciousDomains("clear",p,[]).then(function(o){var a=r.defer(),i=o.data.taskId;e.deployTaskPromise=a.promise,function o(r){var s=l(function(){c.getTask(i).then(function(i){"SUCCESS"===i.data.state?(e.$broadcast("updateDashboardHeader"),a.resolve("success"),l.cancel(s),n.getTableData(),e.addAlert({type:"success",content:"清空已部署域名规则成功"}),v.waitingDomainCount+=v.deployedDomainCount,v.deployedDomainCount=0):"FAILED"===i.data.state?(t(n,!1),e.addAlert({type:"danger",content:i.data.reason?"清空已部署规则失败："+i.data.reason:"清空已部署规则失败"}),a.resolve("fail"),l.cancel(s)):r>0?o(r-1):(t(n,!1),a.resolve("timeout"),e.addAlert({type:"danger",content:"清空已部署规则超时"}))})},1e3)}(120)},function(o){t(n,!1);var a=409===o.status;e.addAlert({type:"danger",content:o.data.error?"清空已部署规则失败："+o.data.error:"清空已部署规则失败"+(a?"， 正在部署中， 请稍后再试。":"")})}),a.close()},o.ok=function(){0===o.msg.isShowDeviceConnectedCnt||o.msg.isShowDeviceUpgradingMsg?a.dismiss("cancel"):(o.clear(),a.close())},o.cancel=function(){t(n,!1),a.close()}}o.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId"];var l=a.open({templateUrl:"templates/rule/maliciousdomain/confirmDeploy.dac31cc2.html",controller:o,size:"sm"});l.result.then(function(){},function(){})},v.deleteDeployed=function(t,n){function o(n,o,a,l,s,u){n.domain=u;var f;l.getDevices(s.id).then(function(e){i.getDPIUpgradeInfo().then(function(t){f=!!t.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],n.check={checkDisconnect:!0},n.msg={title:"删除已部署域名规则",text:"删除已部署域名规则将会删除已经部署的该项域名规则。",qus:"确定删除已部署域名规则 "+u.domainName+" ？",buttonText:"删除已部署规则",fontAwesomeText:"fa-trash-o",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法删除以下未连线设备上的已部署域名规则：",isShowDeviceUpgradingMsg:f},n.deviceDisconnetedPool=[];var o=[];o.push(l.getLinks(s.id));for(var a=0;a<e.data.length;a++)"SECURITY_DEVICE"===e.data[a].category&&(1!==e.data[a].deviceOnline?(n.msg.isShowDeviceDisconnectedMsg=!0,n.check.checkDisconnect=!1,n.deviceDisconnetedPool.push(e.data[a].name)):(n.msg.isShowDeviceConnectedCnt++,o.push(l.getDeviceNodes(e.data[a].deviceId))));r.all(o).then(function(){0===n.msg.isShowDeviceConnectedCnt&&(n.msg.text="没有设备在线，无法删除已部署域名规则。",n.msg.qus="",n.msg.buttonText="关闭",n.msg.fontAwesomeText=""),n.msg.isShowDeviceUpgradingMsg&&(n.msg.text="DPI设备升级中，请稍后再试。",n.msg.qus="",n.msg.buttonText="关闭",n.msg.fontAwesomeText="")})})}),n.deleteDeployed=function(){u.isdoing=!0;var n=[],i=angular.copy(u);delete i.isdoing,delete i.checked,n.push(i),d.deployMaliciousDomains("del",p,n).then(function(n){var o=r.defer(),i=n.data.taskId;e.deployTaskPromise=o.promise,function n(r){var l=a(function(){c.getTask(i).then(function(i){"SUCCESS"===i.data.state?(e.$broadcast("updateDashboardHeader"),o.resolve("success"),a.cancel(l),t.getTableData(),e.addAlert({type:"success",content:"删除已部署域名规则成功"}),v.waitingDomainCount++,v.deployedDomainCount--):"FAILED"===i.data.state?(u.isdoing=!1,e.addAlert({type:"danger",content:i.data.reason?"删除已部署域名规则失败："+i.data.reason:"删除已部署域名规则失败"}),o.resolve("fail"),a.cancel(l)):r>0?n(r-1):(u.isdoing=!1,o.resolve("timeout"),e.addAlert({type:"danger",content:"删除已部署域名规则超时"}))})},1e3)}(120)},function(t){u.isdoing=!1;var n=409===t.status;e.addAlert({type:"danger",content:t.data.error?"删除已部署域名规则失败："+t.data.error:"删除已部署域名规则失败"+(n?"， 正在部署中， 请稍后再试。":"")})}),o.close()},n.ok=function(){0===n.msg.isShowDeviceConnectedCnt||n.msg.isShowDeviceUpgradingMsg?o.dismiss("cancel"):(n.deleteDeployed(),o.close())},n.cancel=function(){u.isdoing=!1,o.close()}}o.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId","domain"];var l=a.open({templateUrl:"templates/rule/maliciousdomain/confirmDeploy.dac31cc2.html",controller:o,size:"sm",resolve:{domain:function(){return n}}});l.result.then(function(){},function(){})},v.deleteSelectedDeployed=function(n){function o(o,a,l,s,u,f){var m;s.getDevices(u.id).then(function(e){i.getDPIUpgradeInfo().then(function(t){m=!!t.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],o.check={checkDisconnect:!0},o.msg={title:"删除全部选中已部署域名规则",text:"删除全部选中已部署域名规则将会删除全部选中的已经部署的域名规则。",qus:"确定删除全部选中已部署域名规则？",buttonText:"删除已部署规则",fontAwesomeText:"fa-trash-o",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法删除以下未连线设备上的已部署域名规则：",isShowDeviceUpgradingMsg:m},o.deviceDisconnetedPool=[];var n=[];n.push(s.getLinks(u.id));for(var a=0;a<e.data.length;a++)"SECURITY_DEVICE"===e.data[a].category&&(1!==e.data[a].deviceOnline?(o.msg.isShowDeviceDisconnectedMsg=!0,o.check.checkDisconnect=!1,o.deviceDisconnetedPool.push(e.data[a].name)):(o.msg.isShowDeviceConnectedCnt++,n.push(s.getDeviceNodes(e.data[a].deviceId))));r.all(n).then(function(){0===o.msg.isShowDeviceConnectedCnt&&(o.msg.text="没有设备在线，无法删除已部署域名规则。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText=""),o.msg.isShowDeviceUpgradingMsg&&(o.msg.text="DPI设备升级中，请稍后再试。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText="")})})}),o.deleteSelectedDeployed=function(){t(n,!0),d.deployMaliciousDomains("del",p,f).then(function(o){var a=r.defer(),i=o.data.taskId;e.deployTaskPromise=a.promise,function o(r){var s=l(function(){c.getTask(i).then(function(i){"SUCCESS"===i.data.state?(e.$broadcast("updateDashboardHeader"),a.resolve("success"),l.cancel(s),n.getTableData(),e.addAlert({type:"success",content:"删除已部署域名规则成功"}),v.waitingDomainCount+=f.length,v.deployedDomainCount-=f.length):"FAILED"===i.data.state?(t(n,!1),e.addAlert({type:"danger",content:i.data.reason?"删除已部署域名规则失败："+i.data.reason:"删除已部署域名规则失败"}),a.resolve("fail"),l.cancel(s)):r>0?o(r-1):(t(n,!1),a.resolve("timeout"),e.addAlert({type:"danger",content:"删除已部署域名规则超时"}))})},1e3)}(120)},function(o){t(n,!1);var a=409===o.status;e.addAlert({type:"danger",content:o.data.error?"删除已部署域名规则失败："+o.data.error:"删除已部署域名规则失败"+(a?"， 正在部署中， 请稍后再试。":"")})}),a.close()},o.ok=function(){0===o.msg.isShowDeviceConnectedCnt||o.msg.isShowDeviceUpgradingMsg?a.dismiss("cancel"):(o.deleteSelectedDeployed(),a.close())},o.cancel=function(){t(n,!1),a.close()}}o.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId","domains"];var l=a.open({templateUrl:"templates/rule/maliciousdomain/confirmDeploy.dac31cc2.html",controller:o,size:"sm",resolve:{domains:function(){var e=n.table,t=[];if(n.selectAllDomains){var o="";n.query?o=" and (contains(domainName,'"+n.query+"'))":n.advancedSearchQuery&&(o=" and "+n.advancedSearchQuery),d.getMaliciousDomains({$filter:"deployStatus eq DEPLOYED"+o,$limit:1e6}).then(function(e){for(var n=0;n<e.length;n++)t.push(e[n])})}else for(var a=0;a<e.length;a++)if(e[a].checked){var r={};r.maliciousDomainId=e[a].maliciousDomainId,r.domainName=e[a].domainName,r.action=e[a].action,t.push(r)}return t}}});l.result.then(function(){},function(){})},v.changeDeployed=function(t,n){function o(t,o,a,l,s,u,f){var m;l.getDevices(s.id).then(function(e){i.getDPIUpgradeInfo().then(function(o){m=!!o.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],t.check={checkDisconnect:!0};var a="DENY"===n?"阻断":"ALERT"===n?"警告":"ALLOW"===n?"允许":"";t.msg={title:a+"已部署域名",text:a+"已部署域名将会更改已经部署的该项域名规则处理方式为"+a+"。",qus:"确定更改已部署域名规则 "+f.domainName+" ？",buttonText:"更改已部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法更改以下未连线设备上的已部署域名规则：",isShowDeviceUpgradingMsg:m},t.deviceDisconnetedPool=[];var i=[];i.push(l.getLinks(s.id));for(var c=0;c<e.data.length;c++)"SECURITY_DEVICE"===e.data[c].category&&(1!==e.data[c].deviceOnline?(t.msg.isShowDeviceDisconnectedMsg=!0,t.check.checkDisconnect=!1,t.deviceDisconnetedPool.push(e.data[c].name)):(t.msg.isShowDeviceConnectedCnt++,i.push(l.getDeviceNodes(e.data[c].deviceId))));r.all(i).then(function(){0===t.msg.isShowDeviceConnectedCnt&&(t.msg.text="没有设备在线，无法更改已部署域名规则。",t.msg.qus="",t.msg.buttonText="关闭",t.msg.fontAwesomeText=""),t.msg.isShowDeviceUpgradingMsg&&(t.msg.text="DPI设备升级中，请稍后再试。",t.msg.qus="",t.msg.buttonText="关闭",t.msg.fontAwesomeText="")})})}),t.changeDeployed=function(){f.isdoing=!0;var t=[],n=angular.copy(f);delete n.isdoing,delete n.checked,t.push(n),d.deployMaliciousDomains("inc",p,t).then(function(t){var n=r.defer(),o=t.data.taskId;e.deployTaskPromise=n.promise,function t(r){var i=a(function(){c.getTask(o).then(function(o){"SUCCESS"===o.data.state?(e.$broadcast("updateDashboardHeader"),f.isdoing=!1,n.resolve("success"),a.cancel(i),e.addAlert({type:"success",content:"更改已部署域名规则成功"})):"FAILED"===o.data.state?(f.action=u,f.isdoing=!1,e.addAlert({type:"danger",content:o.data.reason?"更改已部署域名规则失败："+o.data.reason:"更改已部署域名规则失败"}),n.resolve("fail"),a.cancel(i)):r>0?t(r-1):(f.action=u,f.isdoing=!1,n.resolve("timeout"),e.addAlert({type:"danger",content:"更改已部署域名规则超时"}))})},1e3)}(120)},function(t){f.action=u,f.isdoing=!1;var n=409===t.status;e.addAlert({type:"danger",content:t.data.error?"更改已部署域名规则失败："+t.data.error:"更改已部署域名规则失败"+(n?"， 正在部署中， 请稍后再试。":"")})}),o.close()},t.ok=function(){0===t.msg.isShowDeviceConnectedCnt||t.msg.isShowDeviceUpgradingMsg?(f.action=u,o.dismiss("cancel")):(t.changeDeployed(),o.close())},t.cancel=function(){f.action=u,f.isdoing=!1,o.close()}}if(o.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId","oldAction","domain"],t.action!==n){var l=angular.copy(t.action);t.action=n;var s=a.open({templateUrl:"templates/rule/maliciousdomain/confirmDeploy.dac31cc2.html",controller:o,size:"sm",resolve:{oldAction:function(){return l},domain:function(){return t}}});s.result.then(function(){},function(){t.action=l})}},v.changeSelectedDeployed=function(n,o){function l(o,a,l,s,u,f,m){var g;s.getDevices(u.id).then(function(e){i.getDPIUpgradeInfo().then(function(t){g=!!t.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],o.check={checkDisconnect:!0};var n="DENY"===f?"阻断":"ALERT"===f?"警告":"ALLOW"===f?"允许":"";o.msg={title:n+"全部选中已部署域名",text:n+"全部选中已部署域名将会更改全部选中的已经部署的域名规则处理方式为"+n+"。",qus:"确定更改已部署域名规则？",buttonText:"更改已部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法更改以下未连线设备上的已部署域名规则：",isShowDeviceUpgradingMsg:g},o.deviceDisconnetedPool=[];var a=[];a.push(s.getLinks(u.id));for(var i=0;i<e.data.length;i++)"SECURITY_DEVICE"===e.data[i].category&&(1!==e.data[i].deviceOnline?(o.msg.isShowDeviceDisconnectedMsg=!0,o.check.checkDisconnect=!1,o.deviceDisconnetedPool.push(e.data[i].name)):(o.msg.isShowDeviceConnectedCnt++,a.push(s.getDeviceNodes(e.data[i].deviceId))));r.all(a).then(function(){0===o.msg.isShowDeviceConnectedCnt&&(o.msg.text="没有设备在线，无法更改已部署域名规则。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText=""),o.msg.isShowDeviceUpgradingMsg&&(o.msg.text="DPI设备升级中，请稍后再试。",o.msg.qus="",o.msg.buttonText="关闭",o.msg.fontAwesomeText="")})})}),o.changeSelectedDeployed=function(){t(n,!0),d.deployMaliciousDomains("inc",p,m).then(function(o){var a=r.defer(),i=o.data.taskId;e.deployTaskPromise=a.promise,function o(r){var s=l(function(){c.getTask(i).then(function(i){if("SUCCESS"===i.data.state){e.$broadcast("updateDashboardHeader"),t(n,!1),a.resolve("success"),l.cancel(s);for(var c=n.table,d=0;d<c.length;d++)c[d].checked&&(c[d].action=f);e.addAlert({type:"success",content:"更改已部署域名规则成功"})}else"FAILED"===i.data.state?(t(n,!1),a.resolve("fail"),l.cancel(s),e.addAlert({type:"danger",content:i.data.reason?"更改已部署域名规则失败："+i.data.reason:"更改已部署域名规则失败"})):r>0?o(r-1):(t(n,!1),a.resolve("timeout"),e.addAlert({type:"danger",content:"更改已部署域名规则超时"}))})},1e3)}(120)},function(o){t(n,!1);var a=409===o.status;e.addAlert({type:"danger",content:o.data.error?"更改已部署域名规则失败："+o.data.error:"更改已部署域名规则失败"+(a?"， 正在部署中， 请稍后再试。":"")})})},o.ok=function(){0===o.msg.isShowDeviceConnectedCnt||o.msg.isShowDeviceUpgradingMsg?a.dismiss("cancel"):(o.changeSelectedDeployed(),a.close())},o.cancel=function(){t(n,!1),a.dismiss("cancel")}}l.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId","action","domains"];var s=a.open({controller:l,templateUrl:"/templates/rule/maliciousdomain/confirmDeploy.dac31cc2.html",size:"sm",resolve:{action:function(){return o},domains:function(){var e=n.table,t=[];if(n.selectAllDomains){var a="";n.query?a=" and (contains(domainName,'"+n.query+"'))":n.advancedSearchQuery&&(a=" and "+n.advancedSearchQuery),d.getMaliciousDomains({$filter:"deployStatus eq DEPLOYED"+a,$limit:1e6}).then(function(e){for(var n=0;n<e.length;n++){var a=e[n];a.action=o,t.push(a)}})}else for(var r=0;r<e.length;r++)if(e[r].checked){var i={};i.maliciousDomainId=e[r].maliciousDomainId,i.domainName=e[r].domainName,i.action=o,t.push(i)}return t}}});s.result.then(function(){},function(){})}}function t(e,t){for(var n in e.table)n&&(t&&e.table[n].checked?e.table[n].isdoing=!0:delete e.table[n].isdoing)}e.$inject=["$rootScope","$scope","$state","$modal","$q","System","Enum","formatVal","Task","Signature","switchOn","policyId","waitingDomainCount","deployedDomainCount"],angular.module("southWest.rule.maliciousdomain").controller("MaliciousDomainCtrl",e)}(),function(){"use strict";function e(e){function t(t,n,o,a){function r(n){return n.$orderby&&""!==n.$orderby?n.$orderby+=", domainName":n.$orderby="domainName",n.$filter&&""!==n.$filter?n.$filter+=" and deployStatus eq DEPLOYED":n.$filter="deployStatus eq DEPLOYED",t.params=n,e.getMaliciousDomains(n).then(function(e){c.selectAllDomains||(c.selectAll=!1,c.selectedDomainCount=0);for(var t=0;t<e.length;t++){var n=e[t];c&&(n.checked=c.selectAllDomains)}return e})}function i(t){t.$filter&&""!==t.$filter?t.$filter+=" and deployStatus eq DEPLOYED":t.$filter="deployStatus eq DEPLOYED";var n=t||{};return e.getMaliciousDomainCount(n)}function l(e){return c&&(c.selectAllDomains=!0,c.selectAllDomain()),r(e)}var s=["domainName"];a.setConfig({name:"rules",pagination:!0,scrollable:!1,totalCount:!1,getAll:r,getCount:i,search:l,fields:s,advancedSearch:"maliciousdomains",advancedSearchOptions:[{name:"deployedTime",display:"部署时间",input:"timerange",option:!0,value:[],options:[]},{name:"domainName",display:"域名",input:"string",option:!1,value:""},{name:"action",display:"处理方式",input:"checkbox",option:!0,value:-1,options:[{value:-1,text:"全部"},{value:"ALLOW",text:"允许"},{value:"ALERT",text:"警告"},{value:"DENY",text:"阻断"}]}]});var c=a;c.table=[],c.selectedDomainCount=0,c.selectAll=!1,c.selectAllDomains=!1,c.selectAllDomainsText="",c.selectAllDomain=function(){c.selectAllDomains=!c.selectAllDomains,c.selectAllDomainsText=c.selectAllDomains?"清除全部勾选":"全选所有规则",c.selectAll=c.selectAllDomains,c.selectedDomainCount=c.selectAllDomains?c.totalNum:0;for(var e=0;e<c.table.length;e++)c.table[e].checked=c.selectAllDomains},c.selectAllDomainsText="全选所有规则",c.countSelected=function(e){e.checked?c.selectedDomainCount++:(c.selectedDomainCount--,c.selectAll=!1)},c.toggle=function(){c.selectedDomainCount=0;for(var e=0;e<c.table.length;e++)c.table[e].deployed||(c.table[e].checked=c.selectAll,c.selectAll&&c.selectedDomainCount++)}}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/rule/maliciousdomain/deployedTab.f6d7e700.html",link:t};return n}function t(e){function t(t,n,o,a){function r(n){return n.$orderby&&""!==n.$orderby?n.$orderby+=", domainName":n.$orderby="domainName",n.$filter&&""!==n.$filter?n.$filter+=" and deployStatus ne DEPLOYED":n.$filter="deployStatus ne DEPLOYED",t.params=n,e.getMaliciousDomains(n).then(function(e){c.selectAllDomains||(c.selectAll=!1,c.selectedDomainCount=0);for(var t=0;t<e.length;t++){var n=e[t];c&&(n.checked=c.selectAllDomains)}return e})}function i(t){t.$filter&&""!==t.$filter?t.$filter+=" and deployStatus ne DEPLOYED":t.$filter="deployStatus ne DEPLOYED";var n=t||{};return e.getMaliciousDomainCount(n)}function l(e){return c&&(c.selectAllDomains=!0,c.selectAllDomain()),r(e)}var s=["domainName"];a.setConfig({name:"rules",pagination:!0,scrollable:!1,totalCount:!1,getAll:r,getCount:i,search:l,fields:s,advancedSearch:"maliciousdomains",advancedSearchOptions:[{name:"createdAt",display:"创建时间",input:"timerange",option:!0,value:[],options:[]},{name:"domainName",display:"域名",input:"string",option:!1,value:""},{name:"action",display:"处理方式",input:"checkbox",option:!0,value:-1,options:[{value:-1,text:"全部"},{value:"ALLOW",text:"允许"},{value:"ALERT",text:"警告"},{value:"DENY",text:"阻断"}]}]});var c=a;c.table=[],c.selectedDomainCount=0,c.selectedActivatedDomainCount=0,c.selectAll=!1,c.selectAllDomains=!1,c.selectAllDomainsText="",c.selectAllDomain=function(){c.selectAllDomains=!c.selectAllDomains,c.selectAllDomainsText=c.selectAllDomains?"清除全部勾选":"全选所有规则",c.selectAll=c.selectAllDomains,c.selectedDomainCount=c.selectAllDomains?c.totalNum:0,c.selectedActivatedDomainCount=c.selectAllDomains?c.totalNum:0;for(var e=0;e<c.table.length;e++)c.table[e].checked=c.selectAllDomains},c.selectAllDomainsText="全选所有规则",c.countSelected=function(e){e.checked?(c.selectedDomainCount++,"ACTIVATED"===e.maliciousDomainStatus&&c.selectedActivatedDomainCount++):(c.selectedDomainCount--,"ACTIVATED"===e.maliciousDomainStatus&&c.selectedActivatedDomainCount--,c.selectAll=!1)},c.toggle=function(){c.selectedDomainCount=0,c.selectedActivatedDomainCount=0;for(var e=0;e<c.table.length;e++)c.table[e].deployed||(c.table[e].checked=c.selectAll,c.selectAll&&(c.selectedDomainCount++,"ACTIVATED"===c.table[e].maliciousDomainStatus&&c.selectedActivatedDomainCount++))}}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/rule/maliciousdomain/waitingTab.1a5ca5a1.html",link:t};return n}e.$inject=["Signature"],t.$inject=["Signature"],angular.module("southWest.rule.maliciousdomain").directive("deployedTab",e).directive("waitingTab",t)}(),function(){"use strict";function e(e){e.state("rule.networklist",{url:"/rule/networklist/?tab",controller:"networkListCtrl as networkListCtrl",templateUrl:"templates/rule/networklist/index.b18f26cd.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],domainInfo:["domain",function(e){return e.getDomain()}],deployedPolicyArr:["Signature","secretKey",function(e,t){return e.getDeployedPolicy("IP_RULE").then(function(e){return e.data})}],policiesArr:["Signature","secretKey",function(e,t){return e.getPolicies("IP_RULE").then(function(e){return e.data})}]}}).state("rule.networklist.editor",{parent:"rule",url:"/rule/networklist/editor/:topologyId?policyId?tab",controller:"networkEditorCtrl as editor",templateUrl:"templates/rule/whitelist/editor.f6f04128.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],domainInfo:["domain",function(e){return e.getDomain()}],policiesArr:["Signature",function(e){return e.getPolicies("IP_RULE").then(function(e){return e.data})}]}}).state("rule.networklist.policyDetail",{parent:"rule",url:"/rule/networklist/policyDetail/:topologyId?policyId",controller:"policyDetailCtrl as policyDetail",templateUrl:"templates/rule/whitelist/policyDetail.ae64608b.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.networklist").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u){function p(){f.deployedPanelCount=0,t.getDeployedPolicy("IP_RULE").then(function(e){if(e.data.length>0){var t=e.data[0];r.getIPRuleDeployedCount(t.topologyId).then(function(e){f.deployedPanelCount=e.data.statsValue})}})}var f=this;f.showDash=null,f.tab=null,f.deployedPanelCount=0,f.policyManagementCount=0,f.eventHandler={},f.showUI=!1;var m=a.getTopo(l.id),g={blocks:[]},h=[];f.topologyId=l.id,f.contentEnable=function(e){return s.getContentShow(e)},f.createPolicy=function(e){var o=l.id;o&&t.createPolicy().then(function(t){n.go("rule.whitelist.editor",{topologyId:o,policyId:t.data.value,tab:e}),f.showUI=!0})},e.getCurrentTopoId=function(){return f.currentTopoId},e.getDeployedPolicies=function(){return g},e.getPolicies=function(){return h},e.refreshDeployPanel=function(){f.getDeployedPolicy(),p()},m.then(function(e){e&&e.topologyId&&(f.currentTopoId=e.topologyId,p()),t.getPolicies("IP_RULE").then(function(e){f.policyManagementCount=e.data.length})}),f.eventHandler.stateChangeSuccessHandler=o.$on("$stateChangeSuccess",function(e,t,o,a,r){n.previous={},n.previous.state=a.name,n.previous.params=r}),n.params.tab?(f.showUI=!0,f.tab=n.params.tab):f.canEdit?c.length?(f.tab="deployedPanel",f.showUI=!0):d.length?(f.tab="policyManagement",f.showUI=!0):(f.showUI=!1,u.createPolicy("networklist","total")):(f.showUI=!0,f.tab="deployedPanel"),e.$on("destroy",function(){f.eventHandler.stateChangeSuccessHandler(),f.eventHandler.privilegeHandler?f.eventHandler.privilegeHandler():null}),f.getDeployedPolicy=function(){var n={};m.then(function(){f.currentTopoId&&t.getDeployedPolicy("IP_RULE").then(function(t){t.data.length>0?(f.showDash=!1,n=t.data[0],g=n,e.$broadcast("refreshDeployedTable")):f.showDash=!0})})},f.getPolicies=function(){m.then(function(){f.currentTopoId&&t.getPolicies("IP_RULE").then(function(t){e.allPolicies=t.data,e.$broadcast("refreshPolicy",t.data)})})},"deployedPanel"===f.tab?f.getDeployedPolicy():"policyManagement"===f.tab&&f.getPolicies(),f.hasDeployedPolicy=!0,0===c.length&&(f.hasDeployedPolicy=!1)}function t(e,t,a,r,i,l,s,c,d,u,p,f,m,g,h,v){function y(e,t,n){e.learningItems=n,e.recordTab={},e.tabs=[{name:"设备活动",active:!0,disable:!1},{name:"未知设备活动",active:!1,disable:!1}],e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss("cancel")}}function I(e,t,n){e.macItems=n,e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss("cancel")},e.updateMac=function(t){var n=angular.copy(t);n.assetMac=n.realMac,i.setTaskMac(n).then(function(){l.addAlert({type:"success",content:"MAC地址更新完成"}),i.getTaskMac(t.taskId).then(function(t){D.detailPanelItem.macData=e.macItems=t.data})},function(){l.addAlert({type:"danger",content:"MAC地址更新失败"})})}}y.$inject=["$scope","$modalInstance","items"],I.$inject=["$scope","$modalInstance","items"];var D=this;D.state=a.current.name,D.learningTasks=[],D.detailPanel={},D.showDetailPanel=!1,D.editLearningDetail=!1,D.isCollapsed=!0,D.taskId=null,D.setInterval=!0,D.interval=angular.copy(n),D.eventHandler={},D.isDPIUpgrading=s.isDPIUpgrading(),D.learningType="IP_RULE",D.topologyId=v.id,D.hasPolicies=f.length>0,D.eventHandler.dpiUpgradeStateHandler=l.$on("dpiUpgradeState",function(){D.isDPIUpgrading=s.isDPIUpgrading()}),D.goBack=function(){window.history.back()},D.eventHandler.learningHandler=l.$on("learning",function(t,n){"LEARNING_STOPPED"===n.learningEventType&&(D.learningAbort||l.addAlert({type:"success",content:"学习任务完成"}),D.learningAbort=!1),D.showDetailPanel?(D.learningDetail(D.taskId),e.$broadcast("refreshTask"),e.$broadcast("refreshLearningTable")):D.checklearningTasks()}),D.eventHandler.learningResultHandler=l.$on("learningResult",function(t,n){D.detailPanelItem&&n.taskId&&n.taskId===D.detailPanelItem.taskId&&(D.detailPanelItem.learningResult=n.learningResult),D.showDetailPanel?(D.learningDetail(D.taskId),e.$broadcast("refreshTask"),e.$broadcast("refreshLearningTable")):D.checklearningTasks()}),D.eventHandler.learnedIpMacHandler=l.$on("learnedIpMac",function(e,t){D.detailPanelItem&&t.taskId&&t.taskId===D.detailPanelItem.taskId&&(D.detailPanelItem.macData=t)}),e.$on("$destroy",function(){D.eventHandler.dpiUpgradeStateHandler(),D.eventHandler.learningHandler(),D.eventHandler.learningResultHandler(),D.eventHandler.learnedIpMacHandler()}),a.previous?r.setItem("previous",JSON.stringify(a.previous)):a.previous=JSON.parse(r.getItem("previous")),D.initTimePicker=function(e){h.initTimePicker(e,D,o)},e.$watch("[editor.startdt_date, editor.startdt_time]",function(e){e&&e[0]&&e[1]&&(D.startdt=new Date(e[0].getFullYear(),e[0].getMonth(),e[0].getDate(),e[1].getHours(),e[1].getMinutes(),e[1].getSeconds())),D.intervalError=!1,D.intervalError=D.startdt<D.now||D.startdt>=D.enddt||D.enddt>D.maxTime}),e.$watch("[editor.enddt_date, editor.enddt_time]",function(e){e&&e[0]&&e[1]&&(D.enddt=new Date(e[0].getFullYear(),e[0].getMonth(),e[0].getDate(),e[1].getHours(),e[1].getMinutes(),e[1].getSeconds())),D.intervalError=!1,D.intervalError=D.startdt<D.now||D.startdt>=D.enddt||D.enddt>D.maxTime}),D.calculateValues=function(){h.calculateValues(D)},D.checkInUsepolicy=function(e){h.checkInUsepolicy(e,D,"WHITELIST")},D.changeInterval=function(){h.changeInterval(D);
},D.getTopologyId=function(){return a.params.topologyId},D.getPolicyId=function(){return a.params.policyId},D.getTask=function(){return i.getTask(D.taskId)},D.changeURL=function(e){h.changeURL(e)},D.changeLearningInterval=function(e){h.changeLearningInterval(e,D)},D.changeLearning=function(e){h.changeLearning(e,D)},D.checklearningTasks=function(){h.checklearningTasks(D)},D.remove=function(e){D.learningAbort=!0,i.removeLearningTask(e.taskId).then(function(){D.interval=angular.copy(n),D.checklearningTasks(),D.detailPanelItem=null})},D.openRecord=function(){var t=d.open({templateUrl:"/templates/rule/whitelist/device-activity-record.b0270c40.html",controller:y,size:"sm",resolve:{items:function(){return D.detailPanelItem.learningResult}}});t.result.then(function(t){e.selected=t},function(){u.info("Modal dismissed at: "+new Date)})},D.openIPMACRecord=function(){var t=d.open({templateUrl:"/templates/rule/whitelist/mac-activity-record.9be67985.html",controller:I,size:"lg",resolve:{items:function(){return D.detailPanelItem.macData}}});t.result.then(function(t){e.selected=t},function(){u.info("Modal dismissed at: "+new Date)})},D.countdown=function(e,t){h.countdown(e,t,D)},D.stopCountDown=function(){D.countDownloop&&p.cancel(D.countDownloop)},D.learningDetail=function(t){h.learningDetail(t,D,e)},D.setTimeInterval=function(e){h.setTimeInterval(e,D)},D.setTime=function(){h.setTime(D)},D.pauseLearning=function(t){h.pauseLearning(t,D,e)},D.resumeLearning=function(t){h.resumeLearning(t,D,e)},D.cancelLearning=function(t){h.cancelLearning(t,D,e)},D.startLearning=function(){D.currentlyLearning=!0},D.refreshPreDeployTable=function(e){h.refreshPreDeployTable(e)},D.moveToPreDeployTable=function(){h.moveToPreDeployTable(e)}}e.$inject=["$scope","Signature","$state","$rootScope","Topology","Dashboard","Enum","topologyId","uiTree","deployedPolicyArr","policiesArr","ruleService"],t.$inject=["$scope","$timeout","$state","localStorage","Learning","$rootScope","System","Signature","$modal","$log","$interval","policiesArr","Topology","Custom","WhiteListService","topologyId"],angular.module("southWest.rule.networklist").controller("networkListCtrl",e).controller("networkEditorCtrl",t);var n={days:0,hours:0,minutes:2},o="2199-12-31"}(),function(){"use strict";function e(e){e.state("rule",{parent:"dashboard",abstract:!0,controller:"RuleCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html",url:"/rule"})}e.$inject=["$stateProvider"],angular.module("southWest.rule").config(e)}(),function(){"use strict";function e(e,t){var n=this;n.prefixId="rule",n.subMenus=e.rootMenu.getChild("RULE"),n.expanded="true"===localStorage.getItem("rule:navbar:expanded"),n.toggleExpand=function(){n.expanded=!n.expanded,localStorage.setItem("rule:navbar:expanded",n.expanded)},n.isActive=function(e){return t.current.name.indexOf(e.getState())>-1}}e.$inject=["$rootScope","$state"],angular.module("southWest.rule").controller("RuleCtrl",e)}(),function(){"use strict";function e(e){e.state("rule.sync",{url:"/rule/sync?panel",controller:"syncCtrl as syncCtrl",templateUrl:"templates/rule/sync/index.4cad2912.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.sync").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m,g){var h=this;h.state=n.current.name,h.syncTask=null,h.editRight=s.get("privilege").filter(function(e){return"POLICY"===e.name}),h.editRight=h.editRight&&h.editRight[0]&&30===h.editRight[0].actionValue,h.isDPIUpgrading=l.isDPIUpgrading(),o.$on("dpiUpgradeState",function(){h.isDPIUpgrading=l.isDPIUpgrading()}),h.checkSyncInitial=function(){m.getLatestSyncTask("WHITELIST").then(function(e){var n=a.defer();if(e.data.length>0)if(h.syncTask=e.data[0],"PENDING"===h.syncTask.state||"PROCESSING"===h.syncTask.state){h.syncTask.hasSyncingTask=!0;var r=e.data[0].taskId;h.syncTaskPromise=n.promise,function e(a){var i=t(function(){d.getTask(r).then(function(r){"SUCCESS"===r.data.state?(o.$broadcast("updateDashboardHeader"),n.resolve("success"),t.cancel(i),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!0,o.addAlert({type:"success",content:"检测规则同步成功"}),m.getSyncResultCount(p.id,{$filter:"ruleType eq WHITELIST"}).then(function(e){h.syncTask.icSyncResultCount=e,m.getSyncResultCount(p.id,{$filter:"ruleType eq IPRULES"}).then(function(e){h.syncTask.ipSyncResultCount=e})})):"FAILED"===r.data.state?(n.resolve("fail"),t.cancel(i),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:r.data.reason?"检测规则同步失败："+r.data.reason:"检测规则同步失败"})):a>0?e(a-1):(n.resolve("timeout"),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:"检测规则同步超时"}))})},1e3)}(3600)}else h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!0,m.getSyncResultCount(p.id,{$filter:"ruleType eq WHITELIST"}).then(function(e){h.syncTask.icSyncResultCount=e,m.getSyncResultCount(p.id,{$filter:"ruleType eq IPRULES"}).then(function(e){h.syncTask.ipSyncResultCount=e})})})},h.start=function(e){function t(t,r,i,s,c){var u;s.getDevices(c.id).then(function(e){l.getDPIUpgradeInfo().then(function(n){u=!!n.data.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],t.check={checkDisconnect:!0},t.msg={title:"检测规则同步",text:"检测规则同步会把安全设备上部署的规则和监管平台上的规则进行比较。此操作可能需要几分钟时间。",qus:"确定开始检测规则同步？",buttonText:"检测规则同步",fontAwesomeText:"fa-search-plus",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"无法检测以下未连线设备的规则：",isShowDeviceUpgradingMsg:u},t.deviceDisconnetedPool=[];var o=[];o.push(s.getLinks(c.id));for(var r=0;r<e.data.length;r++)"SECURITY_DEVICE"===e.data[r].category&&(1!==e.data[r].deviceOnline?(t.msg.isShowDeviceDisconnectedMsg=!0,t.check.checkDisconnect=!1,t.deviceDisconnetedPool.push(e.data[r].name)):(t.msg.isShowDeviceConnectedCnt++,o.push(s.getDeviceNodes(e.data[r].deviceId))));a.all(o).then(function(){0===t.msg.isShowDeviceConnectedCnt&&(t.msg.text="没有设备在线，无法检测规则同步。",t.msg.qus="",t.msg.buttonText="关闭",t.msg.fontAwesomeText=""),t.msg.isShowDeviceUpgradingMsg&&(t.msg.text="安全设备升级中，请稍后再试。",t.msg.qus="",t.msg.buttonText="关闭",t.msg.fontAwesomeText="")})})}),t.start=function(){m.checkSyncRules(c.id,"WHITELIST").then(function(t){var r=a.defer();h.syncTaskPromise=r.promise,e&&(t.data.hasSyncingTask=h.syncTask.hasSyncingTask,t.data.hasSyncedTask=h.syncTask.hasSyncedTask,h.hasSyncResult()&&(t.data.icSyncResultCount=h.syncTask.icSyncResultCount,t.data.ipSyncResultCount=h.syncTask.ipSyncResultCount)),h.syncTask=t.data;var l=h.syncTask.taskId;!function e(t){var a=i(function(){d.getTask(l).then(function(l){"SUCCESS"===l.data.state?(o.$broadcast("updateDashboardHeader"),r.resolve("success"),i.cancel(a),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!0,o.addAlert({type:"success",content:"检测规则同步成功"}),m.getSyncResultCount(c.id,{$filter:"ruleType eq WHITELIST"}).then(function(e){h.syncTask.icSyncResultCount=e,m.getSyncResultCount(c.id,{$filter:"ruleType eq IPRULES"}).then(function(e){h.syncTask.ipSyncResultCount=e}),n.reload()})):"FAILED"===l.data.state?(r.resolve("fail"),i.cancel(a),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:l.data.reason?"检测规则同步失败："+l.data.reason:"检测规则同步失败"})):t>0?e(t-1):(r.resolve("timeout"),h.syncTask.hasSyncingTask=!1,h.syncTask.hasSyncedTask=!1,o.addAlert({type:"danger",content:"检测规则同步超时"}))})},1e3)}(3600)},function(e){var t=409===e.status;o.addAlert({type:"danger",content:e.data.error?"检测规则同步失败："+e.data.error:"检测规则同步失败"+(t?"， 正在检测中， 请稍后再试。":"")})})},t.ok=function(){0===t.msg.isShowDeviceConnectedCnt||t.msg.isShowDeviceUpgradingMsg?r.dismiss("cancel"):(t.start(),r.close())},t.cancel=function(){r.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","$timeout","Topology","topologyId"];var i=r.open({controller:t,templateUrl:"/templates/rule/sync/confirmStart.05e3d523.html",size:"sm"});i.result.then(function(){},function(){})},h.add=function(e,t){function n(n,r,i){n.ok=function(){var n=a.defer(),l="WHITELIST"===t?"WHITELIST":"IPRULES"===t?"IP_RULE":"";m.addSyncResultToLib(p.id,l,i).then(function(){n.resolve("success"),r.close(),e.getTableData(),o.addAlert({type:"success",content:"加入模板库成功"}),"WHITELIST"===t?h.syncTask.icSyncResultCount-=i.length:"IPRULES"===t&&(h.syncTask.ipSyncResultCount-=i.length)},function(e){n.resolve("fail"),r.close(),o.addAlert({type:"danger",content:e.data.error?"加入模板库失败："+e.data.error:"加入模板库失败"})}),r.close()},n.cancel=function(){r.close()}}n.$inject=["$scope","$modalInstance","rules"];var i=r.open({templateUrl:"templates/rule/sync/confirmAdd.2681f148.html",controller:n,size:"sm",resolve:{rules:function(){var n=e.table,o=[];if(e.selectAllRules)m.getSyncResult(p.id,{$filter:"ruleType eq "+t,$limit:1e6}).then(function(e){for(var t=0;t<e.length;t++)o.push(e[t])});else for(var a=0;a<n.length;a++)if(n[a].checked){var r=angular.copy(n[a]);delete r.checked,o.push(r)}return o}}});i.result.then(function(){},function(){})},h.detail=function(e){function t(e,t,n,o){e.rule=n,e.cancel=function(){t.close()},e.getProtocolType=o.getProtocolType,e.getRuleCreatedAt=o.getRuleCreatedAt,e.getSourcePort=o.getSourcePort,e.getDestinationPort=o.getDestinationPort}t.$inject=["$scope","$modalInstance","rule","ruleService"];var n="WHITELIST"===e.ruleType?"ic":"IPRULES"===e.ruleType?"ip":"",o=r.open({templateUrl:"templates/rule/sync/"+n+"RuleContent.html",controller:t,size:"lg",resolve:{rule:function(){return e}}});o.result.then(function(){},function(){})},h.goedit=function(e){var t="WHITELIST"===e?"whitelist":"IPRULES"===e?"networklist":"";f.createPolicy().then(function(e){n.go("rule."+t+".editor",{topologyId:p.id,policyId:e.data.value,tab:"templates"})})},h.hasSyncingTask=function(){return h.syncTask&&h.syncTask.hasSyncingTask},h.hasSyncedTask=function(){return h.syncTask&&h.syncTask.hasSyncedTask},h.hasSyncResult=function(){return h.syncTask&&h.syncTask.hasSyncedTask&&(h.syncTask.icSyncResultCount>0||h.syncTask.ipSyncResultCount>0)},h.lastSyncSuccess=function(){return h.syncTask&&"SUCCESS"===h.syncTask.state},h.getProtocolType=g.getProtocolType,h.getSourcePort=g.getSourcePort,h.getDestinationPort=g.getDestinationPort,h.getRuleCreatedAt=g.getRuleCreatedAt,h.editPolicy=function(e){var t=p.id;t&&f.createPolicy().then(function(o){n.go("rule."+e+".editor",{topologyId:t,policyId:o.data.value,tab:"total"})})}}e.$inject=["$scope","$timeout","$state","$rootScope","$q","$modal","$interval","System","Enum","WhiteListService","Task","Topology","topologyId","Signature","SyncRules","ruleService"],angular.module("southWest.rule.sync").controller("syncCtrl",e)}(),function(){"use strict";function e(e,t){function n(n,o,a,r){function i(o){return c&&(c.selectAllRules=!0,c.selectAllRule()),o.$orderby&&""!==o.$orderby?o.$orderby+=", priority":o.$orderby="priority",o.$filter&&""!==o.$filter?o.$filter+=" and ruleType eq WHITELIST":o.$filter="ruleType eq WHITELIST",n.params=o,e.getSyncResult(t.id,o).then(function(e){return e})}function l(n){n.$filter&&""!==n.$filter?n.$filter+=" and ruleType eq WHITELIST":n.$filter="ruleType eq WHITELIST";var o=n||{};return e.getSyncResultCount(t.id,o)}function s(e){return c&&(c.selectAllRules=!0,c.selectAllRule()),i(e)}r.disableToolbar=!0,r.setConfig({name:"rules",pagination:!0,scrollable:!1,totalCount:!1,getAll:i,getCount:l,search:s});var c=r;c.table=[],c.selectedRuleCount=0,c.selectAll=!1,c.selectAllRules=!1,c.selectAllRulesText="",c.selectAllRule=function(){c.selectAllRules=!c.selectAllRules,c.selectAllRulesText=c.selectAllRules?"清除全部勾选":"全选所有规则",c.selectAll=c.selectAllRules,c.selectedRuleCount=c.selectAllRules?c.totalNum:0;for(var e=0;e<c.table.length;e++)c.table[e].checked=c.selectAllRules},c.selectAllRulesText="全选所有规则",c.countSelected=function(e){e.checked?c.selectedRuleCount++:(c.selectedRuleCount--,c.selectAll=!1)},c.toggle=function(){c.selectedRuleCount=0;for(var e=0;e<c.table.length;e++)c.table[e].deployed||(c.table[e].checked=c.selectAll,c.selectAll&&c.selectedRuleCount++)}}var o={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/rule/sync/syncIcResultTable.45898ed9.html",link:n};return o}function t(e,t){function n(n,o,a,r){function i(o){return c&&(c.selectAllRules=!0,c.selectAllRule()),o.$orderby&&""!==o.$orderby?o.$orderby+=", priority":o.$orderby="priority",o.$filter&&""!==o.$filter?o.$filter+=" and ruleType eq IPRULES":o.$filter="ruleType eq IPRULES",n.params=o,e.getSyncResult(t.id,o).then(function(e){return e})}function l(n){n.$filter&&""!==n.$filter?n.$filter+=" and ruleType eq IPRULES":n.$filter="ruleType eq IPRULES";var o=n||{};return e.getSyncResultCount(t.id,o)}function s(e){return c&&(c.selectAllRules=!0,c.selectAllRule()),i(e)}r.disableToolbar=!0,r.setConfig({name:"rules",pagination:!0,scrollable:!1,totalCount:!1,getAll:i,getCount:l,search:s});var c=r;c.table=[],c.selectedRuleCount=0,c.selectAll=!1,c.selectAllRules=!1,c.selectAllRulesText="",c.selectAllRule=function(){c.selectAllRules=!c.selectAllRules,c.selectAllRulesText=c.selectAllRules?"清除全部勾选":"全选所有规则",c.selectAll=c.selectAllRules,c.selectedRuleCount=c.selectAllRules?c.totalNum:0;for(var e=0;e<c.table.length;e++)c.table[e].checked=c.selectAllRules},c.selectAllRulesText="全选所有规则",c.countSelected=function(e){e.checked?c.selectedRuleCount++:(c.selectedRuleCount--,c.selectAll=!1)},c.toggle=function(){c.selectedRuleCount=0;for(var e=0;e<c.table.length;e++)c.table[e].deployed||(c.table[e].checked=c.selectAll,c.selectAll&&c.selectedRuleCount++)}}var o={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/rule/sync/syncIpResultTable.354e2b2e.html",link:n};return o}e.$inject=["SyncRules","topologyId"],t.$inject=["SyncRules","topologyId"],angular.module("southWest.rule.sync").directive("syncIcResultTable",e).directive("syncIpResultTable",t)}(),function(){"use strict";function e(e,o,a){function r(o,r,i,l,s,c,d,u,p,f){function m(){var t={$filter:h};e.getAll(t).then(function(t){var n=t.map(function(e){g.selectDPI.push(!1),e.deployRulesNum=0;for(var t=0;t<e.devicePorts.length;t++)e.deployRulesNum+=e.devicePorts[t].deployedRulesNumber,e.devicePorts[t].isMgmtPort&&(e.mgmtIp=e.devicePorts[t].portIp);return c.domainLogin[e.mgmtIp]||!f.isRemote()?d.getDeviceNodes(e.deviceId):p.autoLogin(e.mgmtIp).then(function(){return d.getDeviceNodes(e.deviceId)})});return n.length?u.all(n).then(function(n){var o=t.map(function(o,r){return t[r].nodes=n[r],e.getNodeRules(t[r].nodes).then(function(e){return o.nodes=e,f.isRemote()?a.getLearningTasks(o.mgmtIp).then(function(e){o.learning=e.data}):a.getLearningTasks().then(function(e){o.learning=e.data})})});return u.all(o).then(function(){g.dpiData=t})}):[]})}var g=this;g.dpiSelectAll=!1,g.selectDPI=[];var h="category eq SECURITY_DEVICE";g.setInterval=!0,g.interval=angular.copy(t),g.selectAllDPI=function(){for(var e=0;e<g.dpiData.length;e++)g.selectDPI[e]=(!g.dpiData[e].learning[0]||"SUCCESS"===g.dpiData[e].learning[0].state)&&g.dpiSelectAll},g.initTimePicker=function(e){a.getCurrentTime().then(function(t){g.now=new Date(t.data[0].currentTime),g.now.setSeconds(0),g.now.setMilliseconds(0),g.startdt=g.now;var o=g.startdt.getFullYear(),a=g.startdt.getMonth()+1;a<10&&(a="0"+a);var r=g.startdt.getDate();r<10&&(r="0"+r);var i=o+"-"+a+"-"+r;g.minDate=i,g.maxDate=angular.copy(n),g.enddt=moment(g.now).add(2,"minutes").toDate(),e&&(g.startdt=new Date(e.startDatetime),g.enddt=new Date(e.endDatetime))})},g.calculateValues=function(){if(g.interval.minutes>=60){var e=Math.floor(g.interval.minutes/60);g.interval.hours=+(g.interval.hours?g.interval.hours:0)+e,g.interval.minutes=g.interval.minutes%60}if(g.interval.hours>=24){var t=Math.floor(g.interval.hours/24);g.interval.days=+(g.interval.days?g.interval.days:0)+t,g.interval.hours=g.interval.hours%24}},g.changeInterval=function(){if(g.intervalError=!1,g.intervalErrorMessage="",!(g.interval.days&&"0"!==g.interval.days.toString()||g.interval.hours&&"0"!==g.interval.hours.toString()||g.interval.minutes&&"0"!==g.interval.minutes.toString()))return g.intervalError=!0,void(g.intervalErrorMessage="请输入学习时间");if(g.interval.days&&(isNaN(g.interval.days)?(g.intervalError=!0,g.intervalErrorMessage=g.intervalErrorMessage+" 请在天数区域输入数字"):g.interval.days<0&&(g.intervalError=!0,g.intervalErrorMessage=g.intervalErrorMessage+" 请输入大于0的天数")),g.interval.hours){if(isNaN(g.interval.hours)?(g.intervalError=!0,g.intervalErrorMessage=g.intervalErrorMessage+" 请在小时数区域输入数字"):g.interval.hours<0&&(g.intervalError=!0,g.intervalErrorMessage=g.intervalErrorMessage+" 请输入大于0的小时数"),g.interval.minutes&&(isNaN(g.interval.minutes)?(g.intervalError=!0,g.intervalErrorMessage=g.intervalErrorMessage+" 请在分钟数区域输入数字"):g.interval.minutes<0&&(g.intervalError=!0,g.intervalErrorMessage=g.intervalErrorMessage+" 请输入大于0的分钟数")),g.intervalError)return;var e=864e5,t=36e5,n=6e4,o=new Date(g.maxDate+" 23:59:59"),a=g.now.getTimezoneOffset(),r=o.getTimezoneOffset(),i=o.getTime(),l=g.now.getTime()+(g.interval.days?g.interval.days*e:0)+(g.interval.hours?g.interval.hours*t:0)+(g.interval.minutes?g.interval.minutes*n:0)+(r-a)*n,s=i-l;if(Math.round(s/n)<1)return g.intervalError=!0,void(g.intervalErrorMessage="请输入少于"+Math.floor((i-g.now.getTime())/e)+"天的学习时间")}},g.setTimeInterval=function(e){a.getCurrentTime().then(function(t){if(g.now=new Date(t.data[0].currentTime),g.now.setMilliseconds(0),e)g.now=new Date(t.data[0].currentTime),g.now.setMilliseconds(0),g.startdt=g.now,g.enddt=moment(g.startdt).add(g.interval).toDate(),g.setTime();else{var n=g.now.getTime()-g.startdt.getTime();if(n<=0)g.setTime();else{if(!(n<6e4))return;g.startdt=g.now,g.setTime()}}})},g.setTime=function(){function e(e,t){for(var n=""+e;n.length<t;)n="0"+n;return n}for(var t=[],n=!0,o=0;o<g.selectDPI.length;o++)g.selectDPI[o]&&(t.push(g.dpiData[o].serialNumber),n=!1);if(n)return void c.addAlert({type:"danger",content:"请先选择需要部署规则的设备！"});var r=(new Date).getTimezoneOffset();r=(r<0?"+":"-")+e(parseInt(Math.abs(r/60)),2)+e(Math.abs(r%60),2);var i={startTime:g.startdt.toISOString(),endTime:g.enddt.toISOString(),taskName:g.startdt.toLocaleString(navigator.language,{hour12:!1})+"至"+g.enddt.toLocaleString(navigator.language,{hour12:!1})+"规则学习",timeZoneOffset:r,boxIds:t};a.createLearningTaskAll(i).then(function(e){"REJECT"===e.data.state?c.addAlert({type:"danger",content:"创建学习任务失败"}):setTimeout(function(){c.addAlert({type:"success",content:"创建学习任务成功"}),g.showEdit=!1,g.refreshPage()},500)},function(e){e&&e.data&&e.data.rejectReason&&c.addAlert({type:"danger",content:e.data.rejectReason})})},m(),g.refreshPage=function(){m()}}var i={restrict:"E",scope:!1,templateUrl:"/templates/rule/whitelist/signature-all-dpi-table.a5717260.html",controller:r,controllerAs:"whitelistAllDpi",link:function(){}};return i}e.$inject=["Device","Template","Learning"],angular.module("southWest.rule.whitelist").directive("whitelistAllDpiTable",e);var t={days:0,hours:0,minutes:2},n="2199-12-31"}(),function(){"use strict";function e(e){e.state("rule.whitelist_manager",{parent:"rule",url:"/whitelist/manager",controller:["Signature","$q","ruleService","$state",function(e,t,n,o){var a=[];a.push(e.getDeployedPolicy("WHITELIST")),a.push(e.getPolicies("WHITELIST")),t.all(a).then(function(e){e[1].data=_.filter(e[1].data,function(e){return e._blocksCount>0}),e[0].data.length?o.go("rule.whitelist_manager.deploy",{tab:"deployedPanel"}):e[1].data.length?o.go("rule.whitelist_manager.deploy",{tab:"policyManagement"}):n.createPolicy("whitelist_manager","total")})}]}).state("rule.whitelist_manager.editor",{parent:"rule",url:"/whitelist/manager/editor/:policyId/:tab",controller:"editorCtrl as editor",templateUrl:"templates/rule/whitelist/editor.f6f04128.html",resolve:{menuState:function(){return"rule.whitelist_manager"}}}).state("rule.whitelist_manager.policyDetail",{parent:"rule",url:"/whitelist/manager/policyDetail/:policyId",controller:"policyDetailCtrl as policyDetail",templateUrl:"templates/rule/whitelist/policyDetail.ae64608b.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],menuState:function(){return"rule.whitelist_manager"}}}).state("rule.whitelist_manager.deploy",{parent:"rule",url:"/whitelist/manager/deploy/:tab",controller:"SignatureCtrl as signature",templateUrl:"templates/rule/whitelist/index.a5086c49.html",resolve:{deployedPolicyArr:["Signature","secretKey",function(e,t){return e.getDeployedPolicy("WHITELIST").then(function(e){return e.data})}],policiesArr:["Signature","secretKey",function(e,t){return e.getPolicies("WHITELIST").then(function(e){return _.filter(e.data,function(e){return e._blocksCount>0})})}],menuState:function(){return"rule.whitelist_manager"}}})}e.$inject=["$stateProvider"],angular.module("southWest.rule.whitelist").config(e)}(),function(){"use strict";angular.module("southWest.rule.whitelist").controller("editorCtrl",["$scope","$timeout","$state","localStorage","Learning","$rootScope","System","Signature","$modal","$log","$interval","Custom","WhiteListService",function(n,o,a,r,i,l,s,c,d,u,p,f,m){function g(e,t,n){"ngInject";e.learningItems=n,e.recordTab={},e.tabs=[{name:"设备活动",active:!0,disable:!1},{name:"未知设备活动",active:!1,disable:!1}],e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss("cancel")}}function h(e,t,n){"ngInject";e.macItems=n,e.ok=function(){t.close(e.selected.item)},e.cancel=function(){t.dismiss("cancel")},e.updateMac=function(t){var n=angular.copy(t);n.topoMac=n.realMac,i.setTaskMac(n).then(function(){l.addAlert({type:"success",content:"MAC地址更新完成"}),i.getTaskMac(t.taskId).then(function(t){v.detailPanelItem.macData=e.macItems=t.data})},function(){l.addAlert({type:"danger",content:"MAC地址更新失败"})})}}g.$inject=["$scope","$modalInstance","items"],h.$inject=["$scope","$modalInstance","items"];var v=this;v.state=a.current.name,v.learningTasks=[],v.detailPanel={},v.showDetailPanel=!1,v.editLearningDetail=!1,v.isCollapsed=!0,v.taskId=null,v.setInterval=!0,v.interval=angular.copy(e),v.eventHandler={},v.learningType="WHITELIST",l.$on("refreshRuleCurrentIp",function(){a.go("rule.whitelist_manager")}),v.toLearning=function(){a.go("rule.whitelist_learning")},v.hasPolicies=a.params.hasPolicies,v.goBack=function(){window.history.back()},v.eventHandler.learningHandler=l.$on("learning",function(e,t){"LEARNING_STOPPED"===t.learningEventType&&(v.learningAbort||l.addAlert({type:"success",content:"学习任务完成"}),v.learningAbort=!1),v.showDetailPanel?(v.learningDetail(v.taskId),n.$broadcast("refreshTask"),n.$broadcast("refreshLearningTable")):v.checklearningTasks()},null,l.currentIp),v.eventHandler.learningResultHandler=l.$on("learningResult",function(e,t){v.detailPanelItem&&t.taskId&&t.taskId===v.detailPanelItem.taskId&&(v.detailPanelItem.learningResult=t.learningResult),v.showDetailPanel?(v.learningDetail(v.taskId),n.$broadcast("refreshTask"),n.$broadcast("refreshLearningTable")):v.checklearningTasks()}),v.eventHandler.learnedIpMacHandler=l.$on("learnedIpMac",function(e,t){v.detailPanelItem&&t.taskId&&t.taskId===v.detailPanelItem.taskId&&(v.detailPanelItem.macData=t)}),n.$on("$destroy",function(){v.eventHandler.learningHandler(),v.eventHandler.learningResultHandler(),v.eventHandler.learnedIpMacHandler()}),a.previous?r.setItem("previous",JSON.stringify(a.previous)):a.previous=JSON.parse(r.getItem("previous")),v.initTimePicker=function(e){m.initTimePicker(e,v,t)},v.calculateValues=function(){m.calculateValues(v)},v.checkInUsepolicy=function(e){m.checkInUsepolicy(e,v,"WHITELIST")},v.changeInterval=function(){m.changeInterval(v)},v.getPolicyId=function(){return a.params.policyId},v.getTask=function(){return i.getTask(v.taskId)},v.changeURL=function(e){m.changeURL(e)},v.changeLearningInterval=function(e){m.changeLearningInterval(e,v)},v.changeLearning=function(e){m.changeLearning(e,v)},v.checklearningTasks=function(){m.checklearningTasks(v)},v.remove=function(t){v.learningAbort=!0,i.removeLearningTask(t.taskId).then(function(){v.interval=angular.copy(e),v.checklearningTasks(),v.detailPanelItem=null})},v.openRecord=function(){var e=d.open({templateUrl:"/templates/rule/whitelist/device-activity-record.b0270c40.html",controller:g,size:"sm",resolve:{items:function(){return v.detailPanelItem.learningResult}}});e.result.then(function(e){n.selected=e},function(){u.info("Modal dismissed at: "+new Date)})},v.openIPMACRecord=function(){var e=d.open({templateUrl:"/templates/rule/whitelist/mac-activity-record.9be67985.html",controller:h,size:"lg",resolve:{items:function(){return v.detailPanelItem.macData}}});e.result.then(function(e){n.selected=e},function(){u.info("Modal dismissed at: "+new Date)})},v.countdown=function(e,t){m.countdown(e,t,v)},v.stopCountDown=function(){v.countDownloop&&p.cancel(v.countDownloop)},v.learningDetail=function(e){m.learningDetail(e,v,n)},v.setTimeInterval=function(e){m.setTimeInterval(e,v)},v.setTime=function(){m.setTime(v)},v.pauseLearning=function(e){m.pauseLearning(e,v,n)},v.resumeLearning=function(e){m.resumeLearning(e,v,n)},v.cancelLearning=function(e){m.cancelLearning(e,v,n)},v.startLearning=function(){v.currentlyLearning=!0},v.refreshPreDeployTable=function(e){m.refreshPreDeployTable(e)},v.moveToPreDeployTable=function(){n.$broadcast("rebuildselectedPolicy"),n.$broadcast("updateLeftSelectAllStatus"),m.moveToPreDeployTable(n)}}]).controller("policyDetailCtrl",["$scope","$state","Signature","$rootScope",function(e,t,n,o){var a=this;t.current.name.indexOf("networklist")!==-1?a.protocolType="networklist":a.protocolType="whitelist_manager";var r=[];a.eventHandler={},o.$on("refreshRuleCurrentIp",function(){t.go("rule.whitelist_manager")}),e.getPolicy=function(){return a.policy},e.viewPolicyDetail=function(e){t.go("rule."+a.protocolType+".editor",{policyId:e,tab:"learning"})},e.goBack=function(){t.go("rule."+a.protocolType,{tab:"policyManagement"})},e.getPolicyBlock=function(){return r},n.getPolicy(t.params.policyId).then(function(e){return a.policy=e.data,n.getPolicyBlockbyPolicyId(e.data.policyId,"ReadyDeploy",null,null,"WHITELIST")}).then(function(t){r=t.data,e.$broadcast("refreshPolicy")}),a.eventHandler.stateChangeSuccessHandler=o.$on("$stateChangeSuccess",function(e,n,o,a,r){t.previous={},t.previous.state=a.name,t.previous.params=r}),e.$on("destroy",function(){a.eventHandler.stateChangeSuccessHandler()})}]).controller("SignatureCtrl",["$scope","Signature","$state","$rootScope","Device","$q","Dashboard","Enum","uiTree","deployedPolicyArr","policiesArr","ruleService",function(e,t,n,o,a,r,i,l,s,c,d,u){function p(){f.deployedPanelCount=0,t.getDeployedPolicy("WHITELIST").then(function(e){e.data.length>0&&i.getRuleDeployedCount().then(function(e){f.deployedPanelCount=e.data.statsValue})}),f.policyManagementCount=0,t.getPolicies("WHITELIST").then(function(e){f.policyManagementCount=e.data.length})}var f=this;f.showDash=null,f.tab=null,f.deployedPanelCount=0,f.policyManagementCount=0,f.eventHandler={},f.showUI=!1;var m={blocks:[]},g=[];f.contentEnable=function(e){return"POLICY_MANAGEMENT"===e?d.length>=0:"DEPLOYED_WHITE_LIST"===e?c.length>0:void 0},o.$on("refreshRuleCurrentIp",function(){n.reload()}),f.createPolicy=function(e){t.createPolicy().then(function(t){n.go("rule.whitelist_manager.editor",{policyId:t.data.value,tab:e}),f.showUI=!0})},e.getDeployedPolicies=function(){return m},e.getPolicies=function(){return g},e.refreshDeployPanel=function(){f.getDeployedPolicy(),p()},f.eventHandler.stateChangeSuccessHandler=o.$on("$stateChangeSuccess",function(e,t,o,a,r){n.previous={},n.previous.state=a.name,n.previous.params=r}),f.canEdit=!1,n.params.tab?(f.showUI=!0,f.tab=n.params.tab):f.canEdit?c.length?(f.tab="deployedPanel",f.showUI=!0):d.length?(f.tab="policyManagement",f.showUI=!0):(f.showUI=!1,u.createPolicy("whitelist_manager","total")):(f.showUI=!0,f.tab="deployedPanel"),e.$on("destroy",function(){f.eventHandler.stateChangeSuccessHandler(),f.eventHandler.privilegeHandler?f.eventHandler.privilegeHandler():null}),f.getDeployedPolicy=function(){var n={};t.getDeployedPolicy("WHITELIST").then(function(t){t.data.length>0?(f.showDash=!1,n=t.data[0],m=n,e.$broadcast("refreshDeployedTable")):f.showDash=!0})},f.getPolicies=function(){t.getPolicies("WHITELIST").then(function(t){f.policyManagementCount=t.data.length,e.allPolicies=t.data,e.$broadcast("refreshPolicy",t.data)})},"deployedPanel"===f.tab?f.getDeployedPolicy():"policyManagement"===f.tab&&f.getPolicies(),p(),f.hasDeployedPolicy=!0,0===c.length&&(f.hasDeployedPolicy=!1)}]);var e={days:0,hours:0,minutes:2},t="2199-12-31"}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s,c,d,u){function p(){var t={$skip:(m.currentPage-1)*m.numPerPage,$limit:m.numPerPage,$orderby:"priority"};m.predicate&&(t.sorting=(m.reverse?"-":"+")+m.predicate),m.policy=e.getDeployedPolicies(),n.getPolicyBlockbyPolicyId(g,"ReadyDeploy",null,t,"WHITELIST").then(function(e){m.table=e.data}),n.getPolicyBlockbyPolicyId(g,"ReadyDeploy",null,t,"WHITELIST").then(function(e){m.totalNum=e.data||0})}function f(){a.getRuleDeployedCount().then(function(e){m.policyRuleDeployedCount=e.data.statsValue}),a.getWhiteListPolicyUpdateTime().then(function(e){m.updateTime=e}),r.getIncidentCount({$filter:"level ne INFO"},!0).then(function(e){m.incidentCount=e})}var m=this;m.currentPage=1,m.numPerPage=20,m.table=[],m.policyType="whitelist_manager";var g=e.getDeployedPolicies().policyId;p(),f();var h=e.$on("refreshDeployedTable",function(){g=e.getDeployedPolicies().policyId,p(),f()});e.$on("destroy",function(){h()}),e.createPolicy=function(){n.createPolicy().then(function(e){d.go("rule."+m.policyType+".editor",{policyId:e.data.value,tab:"total"})})},m.cleanDeploy=function(){var o=t.open({templateUrl:"/templates/rule/whitelist/confirmCleanDeploy.01f29679.html",controller:["$scope","$modalInstance",function(e,t){"ngInject";e.check={checkDisconnect:!0},e.msg={text:"清空已部署规则将会把系统还原至无规则部署的状态，这个步骤无法还原。",qus:"确定清空已部署规则？",buttonText:"清空已部署规则",fontAwesomeText:"fa-times-circle-o",isShowDeviceConnectedCnt:1,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"规则将无法部署以下未连线设备："},e.ok=function(){0===e.msg.isShowDeviceConnectedCnt?t.dismiss("cancel"):t.close()},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});o.result.then(function(){var t="WHITELIST";n.cleanDeploy(t).then(function(t){var n=t.data.taskId;!function t(o){var a=l(function(){s.getTask(n,i.currentIp).then(function(n){"SUCCESS"===n.data.state?(e.refreshDeployPanel(),i.$broadcast("updateDashboardHeader"),i.addAlert({type:"success",content:"清空已部署规则成功"}),l.cancel(a),d.go("rule.whitelist_manager.deploy",{tab:"policyManagement"})):"FAILED"===n.data.state?(i.addAlert({type:"danger",content:"清空已部署规则失败"}),l.cancel(a)):o>0?t(o-1):(i.addAlert({type:"danger",content:"清空部署规则超时"}),l.cancel(a))})},1e3)}(10)},function(){i.addAlert({type:"danger",content:"清空已部署规则失败"})})})},m.showDetail=function(e){var a="/templates/rule/whitelist/policyContent.6483cfd3.html",r=["$scope","$modalInstance","items","policyBlock","policy",function(e,t,a,r,i){e.rulePagination={currentPage:1,numPerPage:5,totalNum:0},e.rulePagination.totalNum=a.data.length,e.rulePagination.numPages=parseInt(e.rulePagination.totalNum/e.rulePagination.numPerPage),"SIGNATURE"===r.type?r.signatures=a.data:r.rules=a.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage),e.policyBlocks=r,e.deployedPolicy=i.data.inUse,e.changeAction=function(e,t){e.action=t,"SIGNATURE"===r.type?o.changeAction(r.policyBlockId,e.signatureId,t).then(function(){}):n.changeAction(r.policyBlockId,e.ruleId,t).then(function(){})},e.pageChanged=function(){r.rules=a.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage)},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}];d.current.name.indexOf("networklist")!==-1&&(a="/templates/rule/whitelist/ip-rule-policy-content.28076fcd.html",r=u.showIpRuleDetailCtrl);var i=t.open({templateUrl:a,controller:r,size:"lg",backdrop:!0,resolve:{items:function(){return"SIGNATURE"===e.type?n.getSignaturesbyBlockId(e.policyBlockId):n.getRulesbyBlockId(e.policyBlockId)},policyBlock:function(){return e},policy:function(){
return n.getPolicyByPolicyId(g)}}});i.result.then(function(){})},m.pageChanged=function(){p()}}var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/whitelist/deployed-table.75bfac79.html",controller:["$scope","$modal","Signature","Template","Dashboard","Incident","$rootScope","$timeout","Task","Topology","$state","WhiteListService",e],controllerAs:"whiteDeployedPolicies",link:function(){}};return t}function t(){function e(e,t,n,o,a){function r(e){if(e&&e.length)for(var t=0;t<e.length;t++)void 0===e[t].checked&&(e[t].checked=!1),l.ruleDeployed=l.ruleDeployed||e[t].inUse;return e}function i(){var t={offset:(l.currentPage-1)*l.numPerPage,limit:l.numPerPage};l.predicate&&(t.sorting=(l.reverse?"-":"+")+l.predicate),l.table=r(e.allPolicies)}var l=this;l.ruleDeployed=!1,l.policyType="whitelist_manager",l.currentPage=1,l.numPerPage=20,l.table=[],l.showPolicyDetail=!1,l.selectAll=!1,l.createPolicy=function(){t.createPolicy().then(function(e){n.go("rule."+l.policyType+".editor",{policyId:e.data.value,tab:"total"})})},l.viewDetail=function(e){n.go("rule."+l.policyType+".policyDetail",{policyId:e})},l.deletePolicy=function(e){var r=o.open({templateUrl:"/templates/rule/whitelist/confirmDelete.15129611.html",controller:["$scope","$modalInstance","policyId",function(e,o,r){"ngInject";e.cancel=function(){o.dismiss("cancel")},e.delete=function(){t.deletePolicySetByPolicyId(r).then(function(e){e.message?n.reload().then(function(){a.addAlert({type:"danger",content:"删除规则失败："+e.message})}):n.reload().then(function(){a.addAlert({type:"success",content:"删除规则成功"})})},function(e){n.reload().then(function(){a.addAlert({type:"danger",content:"删除规则集失败："+e.data.error})})}),o.dismiss("cancel")},e.msg={title:"删除规则集",text:"删除规则集合，将同时删除此规则中所有的规则项，这个步骤无法还原。",qus:"确定删除规则集？",buttonText:"确定",fontAwesomeText:"fa-check text-green icon-left"}}],size:"sm",resolve:{policyId:function(){return e}}});r.result.then(function(){},function(){})},l.toggle=function(){for(var e=0;e<l.table.length;e++)l.table[e].checked=l.selectAll},i();var s=e.$on("refreshPolicy",function(){i()});e.$on("destroy",function(){s()})}var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/whitelist/policy-management-table.3711ae20.html",controller:["$scope","Signature","$state","$modal","$rootScope",e],controllerAs:"policies",link:function(){}};return t}function n(){function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m){function g(){var e={$skip:(h.currentPage-1)*h.numPerPage,$limit:h.numPerPage};h.predicate&&(e.sorting=(h.reverse?"-":"+")+h.predicate),n.getPolicyBlockbyPolicyId(v,"ReadyDeploy",null,e,"WHITELIST").then(function(e){h.table=e.data}),n.getPolicyBlockbyPolicyId(v,"ReadyDeploy",null,e,"WHITELIST").then(function(e){h.totalNum=e.data||0})}var h=this;h.policyType="whitelist_manager",h.currentPage=1,h.numPerPage=20,h.table=[];var v=a.policyId,y=e.$on("refreshPolicy",function(){g()});e.$on("destroy",function(){y()}),h.deploy=function(){var e=0,o=t.open({templateUrl:"/templates/rule/whitelist/confirmDeploy.7f3280e8.html",controller:["$scope","$modalInstance",function(e,t){"ngInject";var n;e.check={checkIDS:!0,checkProtocol:!0,checkDisconnect:!0,checkBlacklistOnly:!0},e.msg={text:"部署新规则将会覆盖原部署规则，这个步骤无法还原。",qus:"确定部署新规则？",buttonText:"部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"规则将无法部署以下未连线设备：",hasIDS:!1,hasIDSText:"以下监测审计设备上的阻断规则会被智能替换为告警。",noProtocolWarning:!1,noProtocolWarningText:"以下数采隔离设备没有选择数采隔离协议。如果部署规则，经过以下隔离设备的所有的协议流量将会被阻止。",hasWhitelistPort:!1,blacklistOnlyWarningText:"以下设备只能部署黑名单。白名单将无法部署到以下设备:",isShowDeviceUpgradingMsg:n},e.ok=function(){e.msg.isShowDeviceUpgradingMsg?t.dismiss("cancel"):t.close()},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});o.result.then(function(){n.deploy(v).then(function(t){var n=t.data.taskId,o=s.defer();i.deployTaskPromise=o.promise,i.deployTaskPromise.then(function(e){"success"===e&&f.go("rule.whitelist_manager.deploy",{tab:"deployedPanel"})}),function e(t){var a=r(function(){l.getTask(n,i.currentIp).then(function(n){"SUCCESS"===n.data.state?(i.addAlert({type:"success",content:"部署成功"}),i.$broadcast("updateDashboardHeader"),o.resolve("success"),r.cancel(a)):"FAILED"===n.data.state?(i.addAlert({type:"danger",content:n.data.reason?"部署失败："+n.data.reason:"部署失败"}),o.resolve("fail"),r.cancel(a)):t>0?e(t-1):(o.resolve("timeout"),i.addAlert({type:"danger",content:"部署超时"}))})},1e3)}(120+15*e)},function(e){i.addAlert({type:"danger",content:e.data.rejectReason?"部署失败："+e.data.rejectReason:"部署失败"})})})},g(),h.pageChanged=function(){g()},h.export=function(e){var t="";t=f.current.name.indexOf("networklist")!==-1?"IPRULES":"WHITELIST",n.exportWhitelistTemplate(e,t).then(function(e){window.open("./"+e,"_self")})},h.showDetail=function(e){var a="/templates/rule/whitelist/policyContent.6483cfd3.html",r=["$scope","$modalInstance","items","policyBlock","policy",function(e,t,a,r,i){e.rulePagination={currentPage:1,numPerPage:5,totalNum:0},e.rulePagination.totalNum=a.data.length,e.rulePagination.numPages=parseInt(e.rulePagination.totalNum/e.rulePagination.numPerPage),"SIGNATURE"===r.type?r.signatures=a.data:r.rules=a.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage),e.policyBlocks=r,e.deployedPolicy=i.data.inUse,e.changeRiskLevel=function(e,t){e.riskLevel=t,n.changeRuleRiskLevel(e.ruleId,e.riskLevel).then(function(e){})},e.changeAction=function(e,t){e.action=t,"SIGNATURE"===r.type?o.changeAction(r.policyBlockId,e.signatureId,t).then(function(){}):n.changeAction(r.policyBlockId,e.ruleId,t).then(function(){})},e.pageChanged=function(){r.rules=a.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage)},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}];f.current.name.indexOf("networklist")!==-1&&(a="/templates/rule/whitelist/ip-rule-policy-content.28076fcd.html",r=m.showIpRuleDetailCtrl);var i=t.open({templateUrl:a,controller:r,size:"lg",backdrop:!0,resolve:{items:function(){return"SIGNATURE"===e.type?n.getSignaturesbyBlockId(e.policyBlockId):n.getRulesbyBlockId(e.policyBlockId)},policyBlock:function(){return e},policy:function(){return n.getPolicyByPolicyId(v)}}});i.result.then(function(){})}}var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/whitelist/policy-detail-table.0fba2758.html",controller:["$scope","$modal","Signature","Template","$stateParams","$timeout","$rootScope","Task","$q","Device","Topology","CommonService","System","$state","WhiteListService",e],controllerAs:"policyItem",link:function(){}};return t}function o(e,t,n,o,a,r,i,l,s,c){function d(d,u,p,f){function m(e){var n=e||{};return t.getAll(v,"NoDeploy",null,n,f.policyType)}function g(e){var n=e||{};return t.getCount(v,"NoDeploy",null,n,f.policyType)}var h=f;h.table=[],h.blockCount=0,h.selectedBlockCount=0,h.selectedRuleCount=0,h.disableToolbar=!0,h.selectAllSigsText="",f.policyType="WHITELIST";var v=n.policyId;f.setConfig({name:"signature",pagination:!0,scrollable:!1,totalCount:!1,getAll:m,getCount:g,fields:[],predicate:"updatedAt",reverse:!0}),f.disableSearch=!0,d.$on("updateLeftSelectAllStatus",function(){h.selectAllSigs||(h.selectAll=!1)}),d.$on("total",function(){var e,t,n=[];if(h.selectAllSigs){var o=[];o.push(a.getPolicyBlockbyPolicyId(v,"NoDeploy",null,{$limit:1e4,$orderby:"createdAt desc"},f.policyType)),o.push(a.getPolicyBlockbyPolicyId(v,"ReadyDeploy",null,{$limit:1e4,$orderby:"createdAt desc"},f.policyType)),c.all(o).then(function(o){var a=o[0].data&&o[0].data.length,r=o[1].data&&o[1].data.length,c=!1;if(a){for(e=0;e<o[0].data.length;e++){if(r)for(t=0;t<o[1].data.length;t++)if(o[0].data[e].policyBlockId===o[1].data[t].sourceId){c=!0;break}c||n.push(o[0].data[e].policyBlockId),c=!1}i.unlockPromise=l.unlock(v,s.policyName,n,f.policyType).then(function(e){for(var t=0;t<h.table.length;t++)h.table[t].checked&&!h.table[t].deployed&&(h.table[t].deployed=!0);i.$broadcast("refreshPreDeployTable",e.data)})}})}else{for(var r=0;r<h.table.length;r++)h.table[r].checked&&!h.table[r].deployed&&n.push(h.table[r].policyBlockId);n.length>0&&(i.unlockPromise=l.unlock(v,s.policyName,n,f.policyType).then(function(e){for(var t=0;t<h.table.length;t++)h.table[t].checked&&!h.table[t].deployed&&(h.table[t].deployed=!0);i.$broadcast("refreshPreDeployTable",e.data)}))}}),h.toggle=function(){h.selectedBlockCount=0,h.selectedRuleCount=0;for(var e=0;e<h.table.length;e++)h.table[e].deployed||(h.table[e].checked=h.selectAll,h.selectAll&&(h.selectedBlockCount++,h.selectedRuleCount+=h.table[e]._rulesCount))},i.$on("refreshLeftTable",function(){f.getTableData()}),d.getDateTime=function(e){var t=new Date(e);return t.toLocaleString("en-GB")},f.showDetail=function(t){var n="/templates/rule/whitelist/policyContent.6483cfd3.html",i=r.showWhiteListRuleDetailCtrl;e.current.name.indexOf("networklist")!==-1&&(n="/templates/rule/whitelist/ip-rule-policy-content.28076fcd.html",i=r.showIpRuleDetailCtrl),o.open({templateUrl:n,controller:i,size:"lg",backdrop:!0,resolve:{items:function(){return a.getRulesbyBlockId(t.policyBlockId)},policyBlock:function(){return t},policy:function(){return a.getPolicyByPolicyId(v)}}})},h.countSelected=function(e){e.checked?(h.selectedBlockCount++,h.selectedRuleCount+=e._rulesCount):(h.selectedBlockCount--,h.selectedRuleCount-=e._rulesCount);for(var t=0,n=0,o=0;o<h.table.length;o++)h.table[o].deployed||(t++,h.table[o].checked&&n++);var a=n>0,r=n===t;h.selectAll=!!a&&(!!r||null)},h.selectAllSignature=function(){h.selectAllCheckBox=!h.selectAllCheckBox,h.selectAllSigs=!h.selectAllSigs,h.selectAllSigsText=h.selectAllSigs?"清除全部勾选":"全选所有规则",h.selectAll=h.selectAllSigs,h.selectedBlockCount=h.selectAllSigs?h.totalNum:0,h.selectedRuleCount=h.selectAllSigs?h.blockCount:0;for(var e=0;e<h.table.length;e++)h.table[e].checked=h.selectAllSigs},h.deleteWhiteList=function(){for(var t=[],n=0;n<h.table.length;n++)h.table[n].checked&&t.push(h.table[n].policyBlockId);a.deleteBlocksByBlockIds(t).then(function(t){t.message?e.reload().then(function(){i.addAlert({type:"danger",content:"删除规则失败："+t.message})}):e.reload().then(function(){i.addAlert({type:"success",content:"删除规则成功"})})},function(t){e.reload().then(function(){i.addAlert({type:"danger",content:"删除规则集失败："+t.data.error})})})},h.selectAllSigsText="全选所有规则",h.getSource=function(e){return"LEARN"===e?"学习":"TEMPLATE"===e?"模版":"自定义"}}var u={restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/rule/whitelist/total-rule-block-table.3cbf41f4.html",link:d};return u}o.$inject=["$state","Custom","$stateParams","$modal","Signature","WhiteListService","$rootScope","Template","dataservice","$q"],angular.module("southWest.rule.whitelist").directive("deployedTable",e).directive("policyManagementTable",t).directive("policyDetailTable",n).directive("totalRuleBlockTable",o)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d){"ngInject";function u(u,p,f,m){function g(e,n,a,r){r.indexOf("whitelist")!==-1?e.tab="whitelist":e.tab="networklist",e.editRules=!1,e.editRuleItem=!1,e.ruleItems=[],e.currentTree={},e.selectedRuleItems=[],e.customPolicyBlock={},e.customPolicyBlock.name="",e.customPolicyBlock.sourceZoneName="",e.customPolicyBlock.destinationZoneName="",e.customPolicyBlock.descirption="",e.customPolicyBlock.timeStamp=new Date,e.customPolicyBlock.type="CUSTOM",e.customPolicyBlock.ruleItems=e.ruleItems,e.customPolicyBlock.selectAll=!1,e.securityZones=[],e.zones=[],e.ruleList=[{sourceIp:{value:"",option:!1,placeHolder:"任意"},desIp:{value:"",option:!1,placeHolder:"任意"},sourcePort:{value:"",option:!1,placeHolder:"任意"},desPort:{value:"",option:!1,placeHolder:"任意"}}],o.getSecurityAreaNames().then(function(t){e.securityZones=t}),a(e),e.createRuleItem=function(){e.editRules=!0,e.currentTree={};var n={currentValue:"[]"};t.getData(n).then(function(t){var n=t.data.nodeTree;e.generateTree(n.nodes)})},e.confirmCreateRule=function(){e.ruleList=[{sourceIp:{value:"",option:!1,placeHolder:"任意"},desIp:{value:"",option:!1,placeHolder:"任意"},sourcePort:{value:"",option:!1,placeHolder:"任意"},desPort:{value:"",option:!1,placeHolder:"任意"}}],e.editRules=!1;var t=[];if("networklist"===e.tab){var n=e.ruleList[0];t.push({name:"协议名称",value:n.protocol}),t.push({name:"起源IP",value:n.sourceIp.value}),t.push({name:"目标IP",value:n.desIp.value}),t.push({name:"起源端口",value:n.sourcePort.value}),t.push({name:"目标端口",value:n.desPort.value})}else for(var o in e.currentTree)if(e.currentTree[o]&&!e.currentTree[o].active){var a={};a.name=e.currentTree[o].nodeDisplayName,a.value=e.currentTree[o].nodeDisplayValue,t.push(a)}t.length>0&&e.ruleItems.push({fields:t,action:"DROP",checked:!1,riskLevel:"LOW"}),e.editRuleItem=!1},e.modifyRuleItem=function(n,o){e.ruleItemIndex=n,e.editRules=!0,e.editRuleItem=!0;var a={currentValue:angular.toJson(o.fields)};t.getData(a).then(function(t){var n=t.data.nodeTree;e.currentTree=n.nodes,e.generateTree(n.nodes)})},e.confirmRuleEdit=function(){e.editRules=!1;var t=[];if("networklist"===e.tab){var n=e.ruleList[0];t.push({name:"协议名称",value:n.protocol}),t.push({name:"起源IP",value:n.sourceIp.value}),t.push({name:"目标IP",value:n.desIp.value}),t.push({name:"起源端口",value:n.sourcePort.value}),t.push({name:"目标端口",value:n.desPort.value})}else for(var o in e.currentTree)if(e.currentTree[o]&&!e.currentTree[o].active){var a={};a.name=e.currentTree[o].nodeDisplayName,a.value=e.currentTree[o].nodeDisplayValue,t.push(a)}e.ruleItems[e.ruleItemIndex].fields=t,e.editRuleItem=!1},e.cancelRuleEdit=function(){e.editRules=!1,$("#diagram","*").empty()},e.selectRuleItem=function(t,n){t.checked?(e.selectedRuleItems.push(n),e.selectedRuleItems.length===e.ruleItems.length&&(e.customPolicyBlock.selectAll=!0)):(e.selectedRuleItems=_.without(e.selectedRuleItems,n),e.customPolicyBlock.selectAll=!1)},e.selectAllRuleItem=function(){e.selectedRuleItems=[],e.ruleItems.forEach(function(t,n){t.checked=e.customPolicyBlock.selectAll,e.customPolicyBlock.selectAll&&e.selectedRuleItems.push(n)})},e.moveUp=function(){var t=e.selectedRuleItems[0];if(0!==t){var n=t-1,o=e.ruleItems[t];e.ruleItems[t]=e.ruleItems[n],e.ruleItems[n]=o,e.selectedRuleItems[0]=n}},e.moveDown=function(){var t=e.selectedRuleItems[0];if(t!==e.ruleItems.length-1){var n=t+1,o=e.ruleItems[t];e.ruleItems[t]=e.ruleItems[n],e.ruleItems[n]=o,e.selectedRuleItems[0]=n}},e.deleteRuleItems=function(){e.selectedRuleItems.forEach(function(t){delete e.ruleItems[t],e.selectedRuleItems=_.without(e.selectedRuleItems,t)}),e.ruleItems=_.without(e.ruleItems,void 0),e.customPolicyBlock.selectAll=!1},e.changeAction=function(e,t){e.action=t},e.changeRiskLevel=function(e,t){e.riskLevel=t},e.ok=function(){n.close(e.customPolicyBlock)},e.cancel=function(){n.dismiss("cancel")}}function h(e,t,n,o,i,l){var s=o.policyBlockId;e.enableEdit=!0,e.rulePagination={currentPage:1,numPerPage:5,totalNum:0},e.rulePagination.totalNum=n.data.length,e.rulePagination.numPages=parseInt(e.rulePagination.totalNum/e.rulePagination.numPerPage),"SIGNATURE"===o.type?o.signatures=n.data:(o.rules=n.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage),o.rules.forEach(function(e){e.checked=!1})),e.policyBlocks=o,i(e),l(e,n),e.changeAction=function(e,t){e.action=t,"SIGNATURE"===o.type?r.changeAction(s,e.signatureId,t).then(function(){}):a.changeAction(s,e.ruleId,t).then(function(){})},e.pageChanged=function(){o.rules=n.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage),o.rules.forEach(function(e){e.checked=!1})},e.changeRiskLevel=function(e,t){e.riskLevel=t,a.changeRuleRiskLevel(e.ruleId,e.riskLevel).then(function(e){})},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}function v(e){var n=e||{};return t.getAll(T,"NoDeploy","custom",n,m.protocolType)}function y(e){var n=e||{};return t.getCount(T,"NoDeploy","custom",n,m.protocolType)}function I(e){return t.getAll({$filter:b(e)})}g.$inject=["$scope","$modalInstance","tree","state"],h.$inject=["$scope","$modalInstance","items","policyBlock","tree","ruleItemEdit"],m.protocolType="WHITELIST",u.getDateTime=function(e){var t=new Date(e);return t.toLocaleString("en-GB")},m.disableToolbar=!0,m.disableSearch=!0;var D=m;D.table=[],D.blockCount=0,D.selectedBlockCount=0,D.selectedRuleCount=0,u.$on("updateLeftSelectAllStatus",function(){D.selectAllSigs||(D.selectAll=!1)}),D.countSelected=function(e){e.checked?(D.selectedBlockCount++,D.selectedRuleCount+=e._rulesCount):(D.selectedBlockCount--,D.selectedRuleCount-=e._rulesCount);for(var t=0,n=0,o=0;o<D.table.length;o++)D.table[o].deployed||(t++,D.table[o].checked&&n++);var a=n>0,r=n===t;D.selectAll=!!a&&(!!r||null)},D.toggle=function(){D.selectedBlockCount=0,D.selectedRuleCount=0;for(var e=0;e<D.table.length;e++)D.table[e].deployed||(D.table[e].checked=D.selectAll,D.selectAll&&(D.selectedBlockCount++,D.selectedRuleCount+=D.table[e]._rulesCount))},u.$on("customs",function(){for(var e=[],t=0;t<D.table.length;t++)D.table[t].checked&&!D.table[t].deployed&&e.push(D.table[t].policyBlockId);e.length>0&&(l.unlockPromise=r.unlock(T,s.policyName,e,m.protocolType).then(function(e){for(var t=0;t<D.table.length;t++)D.table[t].checked&&!D.table[t].deployed&&(D.table[t].deployed=!0);l.$broadcast("refreshPreDeployTable",e.data)}))}),l.$on("refreshLeftTable",function(){m.getTableData()});var T=n.policyId;m.createCustomRules=function(n){var o="",a="",r=g;o="WHITELIST",a="/templates/rule/whitelist/custom-rule-editor.6e2dbd38.html";var l=e.open({templateUrl:a,controller:r,size:"lg",resolve:{state:function(){return n}}});l.result.then(function(e){var n={};n.name=e.name,n._sourceZoneName=e.sourceZoneName,n._destinationZoneName=e.destinationZoneName,n.description=e.description,t.createPolicyBlock(T,n,o).then(function(n){var o=n.data.policyBlockId;if(e.ruleItems.length){var a=[];e.ruleItems.forEach(function(e,n){var r={};r.priority=n,r.action=e.action,r.riskLevel=e.riskLevel,r.fields=angular.copy(e.fields),a.push(t.createRule(o,r))}),i.all(a).then(function(){m.getTableData(),m.getTableDataCount()})}else m.getTableData(),m.getTableDataCount()})},function(){})},D.showDetail=function(t){var n="/templates/rule/whitelist/policyContent.6483cfd3.html",o=h;c.current.name.indexOf("networklist")!==-1&&(n="/templates/rule/whitelist/ip-rule-policy-content.28076fcd.html",o=d.showIpRuleDetailCtrl);var r=e.open({templateUrl:n,controller:o,size:"lg",backdrop:!0,resolve:{items:function(){return a.getRulesbyBlockId(t.policyBlockId)},policyBlock:function(){return t},policy:function(){return a.getPolicyByPolicyId(T)}}});r.result.then(function(e){},function(){})};var b=function(e){var t=["name","make","modelIdentifier","serialNumber","_zoneNames","devicePorts","portsNumber","protectedDevicesNumber"];return t.map(function(t){return"contains("+t+", '"+e+"')"}).join(" or ")};m.setConfig({name:"custom",pagination:!0,scrollable:!1,totalCount:!1,getAll:v,getCount:y,predicate:"updatedAt",reverse:!0,search:I})}var p={restrict:"E",scope:!1,templateUrl:"/templates/rule/whitelist/custom-table.a39eedfb.html",require:"^dtable",link:u};return p}e.$inject=["$modal","Custom","$stateParams","DeviceAsset","Signature","Template","$q","$rootScope","dataservice","$state","WhiteListService"],angular.module("southWest.rule.whitelist").directive("customTable",e)}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s,c){"ngInject";function d(e,t){o.getPolicyBlockbyPolicyId(f,"ReadyDeploy",null,null,"WHITELIST").then(function(n){p.blockCount=0,p.selectedBlockCount=0,p.selectedRuleCount=0,p.selectAll=!1;for(var o=0;o<e.length;o++){e[o].checked=!1,p.blockCount+=e[o]._rulesCount;for(var a=0;a<n.data.length;a++)e[o].policyBlockId===n.data[a].sourceId&&(e[o].deployed=!0)}t&&t(e)})}function u(){var n={offset:(p.currentPage-1)*p.numPerPage,limit:p.numPerPage};p.predicate&&(n.sorting=(p.reverse?"-":"+")+p.predicate),m.then(function(n){var o=0;"IP_RULE"===e.learningType&&(o=1),t.getLearningBlocksByRef(n.data._resultRef.baseUrls[o]).then(function(t){e.count=t.data.length,d(t.data,function(e){p.table=e})})})}var p=this;p.currentPage=1,p.numPerPage=20,p.table=[],p.enableUploadTemplate=!1,p.blockCount=0,p.selectedBlockCount=0,p.selectedRuleCount=0,p.task={},p.isDPIUpgrading=!1,p.learningType=e.learningType,i.$on("refreshLeftTable",function(){u()}),e.$on("updateLeftSelectAllStatus",function(){p.selectAllSigs||(p.selectAll=!1)}),p.updateNumPerPage=function(){};var f=e.policyId(),m=e.task();p.toggle=function(){p.selectedBlockCount=0,p.selectedRuleCount=0;for(var e=0;e<p.table.length;e++)p.table[e].deployed||(p.table[e].checked=p.selectAll,p.selectAll&&(p.selectedBlockCount++,p.selectedRuleCount+=p.table[e]._rulesCount))},p.countSelected=function(e){if(e.checked){p.selectedBlockCount++,p.selectedRuleCount+=e._rulesCount;for(var t=0,n=0;n<p.table.length;n++)t+=p.table[n].deployed||p.table[n].checked?1:0;p.selectAll=t===p.table.length}else p.selectedBlockCount--,p.selectedRuleCount-=e._rulesCount,p.selectAll=!1};var g=e.$on("learning",function(){for(var t=[],n=0;n<p.table.length;n++)p.table[n].checked&&!p.table[n].deployed&&t.push(p.table[n].policyBlockId);t.length>0&&(i.unlockPromise=a.unlock(f,r.policyName,t,p.learningType).then(function(t){for(var n=0;n<p.table.length;n++)p.table[n].checked&&!p.table[n].deployed&&(p.table[n].deployed=!0);return e.move({block:t.data})}))}),h=function(e,t,n,r){if(e.rulePagination={currentPage:1,numPerPage:5,totalNum:0},e.rulePagination.totalNum=n.data.length,e.rulePagination.numPages=parseInt(e.rulePagination.totalNum/e.rulePagination.numPerPage),"SIGNATURE"===r.type)r.signatures=n.data;else{for(var i=0;i<n.data.length;i++)if(n.data[i].fields.length>1){if("协议"===n.data[i].fields[0].name)continue;for(var l=0,s=1;s<n.data[i].fields.length;i++)if("协议"===n.data[i].fields[s].name){l=s;break}var c=n.data[i].fields.splice(l,1)[0];n.data[i].fields.splice(0,0,c)}r.rules=n.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage)}e.policyBlocks=r,e.changeRiskLevel=function(e,t){e.riskLevel=t,o.changeRuleRiskLevel(e.ruleId,e.riskLevel).then(function(e){})},e.changeAction=function(e,t){e.action=t,"SIGNATURE"===r.type?a.changeAction(r.policyBlockId,e.signatureId,t).then(function(e){}):o.changeAction(r.policyBlockId,e.ruleId,t).then(function(e){})},e.pageChanged=function(){r.rules=n.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage)},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}};h.$inject=["$scope","$modalInstance","items","policyBlock"],p.showDetail=function(t){var a="/templates/rule/whitelist/policyContent.6483cfd3.html",r=h;"IP_RULE"===e.learningType&&(a="/templates/rule/whitelist/ip-rule-policy-content.28076fcd.html",r=c.showIpRuleDetailCtrl);var i=n.open({templateUrl:a,controller:r,size:"lg",backdrop:!0,resolve:{items:function(){return o.getRulesbyBlockId(t.policyBlockId)},policyBlock:function(){return t},policy:function(){return o.getPolicyByPolicyId(f)}}});i.result.then(function(e){},function(){})};var v=e.$on("refreshTask",function(){e.task().then(function(e){p.task=e.data,i.disableDeploy=!1,"PROCESSING"!==p.task.state&&"PAUSED"!==p.task.state||(i.disableDeploy=!0)})}),y=e.$on("refreshLearningTable",function(){u()});e.$on("destroy",function(){g(),v(),y()}),u()}e.$inject=["$scope","Learning","$modal","Signature","Template","dataservice","$rootScope","System","$state","WhiteListService"];var t={restrict:"E",scope:{policyId:"=",task:"=",move:"&",learningType:"=",checkbox:"=",count:"="},templateUrl:"/templates/rule/whitelist/learning-table.c3a2884d.html",controllerAs:"learnings",controller:e,link:function(){}};return t}angular.module("southWest.rule.whitelist").directive("learningTable",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l){function s(s,c,d,u){function p(e,t){n.getPolicyBlockbyPolicyId(y,"ReadyDeploy",null,null,"WHITELIST").then(function(n){v.blockCount=0,v.selectedBlockCount=0,v.selectedRuleCount=0,v.selectAll=!1;for(var o=e.length-1;o>=0;o--){e[o].checked=!1,v.blockCount+=e[o]._rulesCount;for(var a=0;a<n.data.length;a++)e[o].policyBlockId===n.data[a].sourceId&&(e[o].deployed=!0)}t&&t(e)})}function f(){var e={offset:(v.currentPage-1)*v.numPerPage,limit:v.numPerPage};v.predicate&&(e.sorting=(v.reverse?"-":"+")+v.predicate);var t="WHITELIST";"networklist"===v.protocolType&&(t="IP_RULE"),n.getPolicyBlockbyPolicyId(y,"NoDeploy","template",{$orderby:"policyBlockSource desc, priority, createdAt desc"},t).then(function(e){p(e.data,function(e){v.tableAll=e})})}function m(e){f();var t="WHITELIST";"networklist"===v.protocolType&&(t="IP_RULE");var o=e||{};return o.$orderby&&""!==o.$orderby?o.$orderby+=", policyBlockSource desc, priority":o.$orderby="policyBlockSource desc, priority, updatedAt desc",n.getPolicyBlockbyPolicyId(y,"NoDeploy","template",o,t).then(function(e){return e.data})}function g(e){var t="WHITELIST";"networklist"===v.protocolType&&(t="IP_RULE");var o=e||{};return n.getPolicyBlockbyPolicyId(y,"NoDeploy","template",o,t).then(function(e){return e.data.length})}var h=s,v=u;i.current.name.indexOf("networklist")!==-1?v.protocolType="networklist":v.protocolType="whitelist",v.currentPage=1,v.numPerPage=10,v.table=[],v.updateNumPerPage=function(){},v.blockCount=0,v.selectedBlockCount=0,v.selectedRuleCount=0,r.$on("refreshLeftTable",function(){v.refresh()}),s.$on("updateLeftSelectAllStatus",function(){v.selectAllSigs||(v.selectAll=!1)});var y=e.policyId;h.$on("templates",function(){for(var e=[],t=0;t<v.table.length;t++)v.table[t].checked&&!v.table[t].deployed&&e.push(v.table[t].policyBlockId);if(e.length>0){var n="WHITELIST";"networklist"===v.protocolType&&(n="IP_RULE"),r.unlockPromise=o.unlock(y,a.policyName,e,n).then(function(e){for(var t=0;t<v.table.length;t++)v.table[t].checked&&!v.table[t].deployed&&(v.table[t].deployed=!0);r.$broadcast("refreshPreDeployTable",e.data)})}}),v.countSelected=function(e){e.checked?(v.selectedBlockCount++,v.selectedRuleCount+=e._rulesCount):(v.selectedBlockCount--,v.selectedRuleCount-=e._rulesCount);for(var t=0,n=0,o=0;o<v.table.length;o++)v.table[o].deployed||(t++,v.table[o].checked&&n++);var a=n>0,r=n===t;v.selectAll=!!a&&(!!r||null)},angular.element("input.template").bind("change",function(e){var t=e.target.files[0];if(t){var n=t,o="WHITELIST";"networklist"===v.protocolType&&(o="IPRULES"),v.uploadTemplate(n,o),this.value=null}}),v.showDetail=function(e){var a="/templates/rule/whitelist/policyContent.6483cfd3.html",r=["$scope","$modalInstance","items","policyBlock",function(e,t,a,r){e.rulePagination={currentPage:1,numPerPage:5,totalNum:0},e.rulePagination.totalNum=a.data.length,e.rulePagination.numPages=parseInt(e.rulePagination.totalNum/e.rulePagination.numPerPage),"SIGNATURE"===r.type||(r.rules=a.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage)),e.policyBlocks=r,e.changeAction=function(e,t){e.action=t,"SIGNATURE"===r.type?o.changeAction(r.policyBlockId,e.signatureId,t).then(function(e){}):n.changeAction(r.policyBlockId,e.ruleId,t).then(function(e){})},e.pageChanged=function(){r.rules=a.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage)},e.changeRiskLevel=function(e,t){e.riskLevel=t,n.changeRuleRiskLevel(e.ruleId,e.riskLevel).then(function(e){})},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}}];"networklist"===v.protocolType&&(a="/templates/rule/whitelist/ip-rule-policy-content.28076fcd.html",r=l.showIpRuleDetailCtrl);var i=t.open({templateUrl:a,controller:r,size:"lg",backdrop:!0,resolve:{items:function(){return n.getRulesbyBlockId(e.policyBlockId)},policyBlock:function(){return e},policy:function(){return n.getPolicyByPolicyId(y)}}});i.result.then(function(e){},function(){})},v.uploadTemplate=function(e,t){h.uploadTemplatePromise=o.uploadTemplate(e,t).then(function(e){e=e.data,e.error&&e.error.length>0?r.addAlert({type:"danger",content:"上传失败: "+e.error}):(v.refresh(),r.addAlert({type:"success",content:"上传成功"}))},function(e){e=e.data,r.addAlert({type:"danger",content:"上传失败: "+(e.error?": "+e.error:"")})})},v.toggle=function(){v.selectedBlockCount=0,v.selectedRuleCount=0;for(var e=0;e<v.table.length;e++)v.table[e].deployed||(v.table[e].checked=v.selectAll,v.selectAll&&(v.selectedBlockCount++,v.selectedRuleCount+=v.table[e]._rulesCount))},u.setConfig({name:"template",pagination:!0,scrollable:!1,totalCount:!1,getAll:m,getCount:g,fields:[],predicate:"updatedAt",reverse:!0}),u.disableToolbar=!0}var c={restrict:"E",scope:!1,require:"^dtable",templateUrl:"/templates/rule/whitelist/template-table.b3c623a2.html",link:s};return c}e.$inject=["$stateParams","$modal","Signature","Template","dataservice","$rootScope","$state","WhiteListService"],angular.module("southWest.rule.whitelist").directive("templateTable",e)}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m){"ngInject";function g(e,t){for(var n=0;n<e.length;n++)if(e[n].policyBlockId===t.policyBlockId){e.splice(n,1);break}}function h(){D.tt=!0,D.ut=!0,D.lt=!0,D.bt=!0;var e,t;D.selectedPolicyBlocks.forEach(function(n){T=n.policyId,e&&t?(n.index>t&&(t=n.index),n.index<e&&(e=n.index)):(e=n.index,t=n.index)}),t-e+1!==D.selectedPolicyBlocks.length&&(D.tt=!1,D.ut=!1,D.lt=!1,D.bt=!1),1===e&&(D.tt=!1,D.ut=!1),t===D.totalNum&&(D.lt=!1,D.bt=!1)}function v(){var e="WHITELIST";return n.getPolicyBlockCountbyPolicyId(T,"ReadyDeploy",null,null,e).then(function(e){D.totalNum=e.data||0})}function y(e){var t={$skip:(D.currentPage-1)*D.numPerPage,$limit:D.numPerPage,$orderby:"priority"};return D.predicate&&(t.sorting=(D.reverse?"-":"+")+D.predicate),n.getPolicyByPolicyId(T).then(function(a){if(a.data){D.policy=a.data,c.policyName=D.policy.name,D.policy.inUse&&e&&(D.foreverDeployed=o.alreadyDeployed=D.alreadyDeployed=!0);var r="WHITELIST";return n.getPolicyBlockbyPolicyId(T,"ReadyDeploy",null,t,r)}D.enableDefaultRuleEdit=!1;var i=new Date,l=i.getMonth()+1,s=l<10?"0"+l:l,d=i.getDate()<10?"0"+i.getDate():i.getDate(),u=i.getHours()<10?"0"+i.getHours():i.getHours(),p=i.getMinutes()<10?"0"+i.getMinutes():i.getMinutes(),f="规则-"+i.getFullYear()+"-"+s+"-"+d+"-"+u+":"+p;c.policyName=f,D.policy={name:c.policyName}}).then(function(t){if(t){0===t.data.length&&e&&(o.alreadyDeployed=D.alreadyDeployed=!1),D.policy.blocks=t.data,D.table=I(t.data),D.table.forEach(function(e){e.select=!1,D.selectedPolicyBlocks.forEach(function(t){e.policyBlockId===t.policyBlockId&&(e.select=!0)})});var a={$skip:0,$limit:1e4,$orderby:"priority"};return n.getPolicyBlockbyPolicyId(T,"ReadyDeploy",null,a,"WHITELIST").then(function(e){var t=I(e.data);t.forEach(function(e,t){D.selectedPolicyBlocks.forEach(function(n){e.policyBlockId===n.policyBlockId&&(n.priority=e.priority,n.index=t+1)})})})}}).then(function(){h()})}function I(e){D.blockCount=0;for(var t=0;t<e.length;t++)"SIGNATURE"===e[t].type?D.blockCount+=e[t]._signaturesCount:D.blockCount+=e[t]._rulesCount;return n.getPolicySignatureRulesCount(T).then(function(e){o.disableDeploy=e&&0===e.data}),e}var D=this;D.protocolType="whitelist_manager",D.currentPage=1,D.numPerPage=10,D.policy={},D.table=[],D.disableRearrange=!0,D.actions=["允许","警告","阻断"],D.foreverDeployed=o.alreadyDeployed=D.alreadyDeployed=!1,D.blockCount=0,D.enableDefaultRuleEdit=!1;var T=f.policyId;o.$$listeners.refreshPreDeployTable=[],e.$on("rebuildselectedPolicy",function(){D.selectedPolicyBlocks=[]}),o.$on("refreshPreDeployTable",function(e,t){(t>0||t.length)&&(o.alreadyDeployed=D.alreadyDeployed=!1,n.getPolicyByPolicyId(T).then(function(e){e.data&&(D.policy=e.data)}),y(),v())}),D.changeDefaultRuleAction=function(e,t,a){var r=null,i=null;"supportRuleAction"===t?(r=a,i=e.unknownRuleAction):"unknownRuleAction"===t&&(r=e.supportRuleAction,i=a),n.changeDefaultRuleAction(T,r,i).then(function(t){o.alreadyDeployed=D.alreadyDeployed=!1,e.supportRuleAction=t.data.supportRuleAction,e.unknownRuleAction=t.data.unknownRuleAction})},D.changeName=function(){n.changePolicyName(T,D.policy.name).then(function(e){
c.policyName=e.data.name,o.$broadcast("updateDashboardHeader")})},y(!0),v(),D.deleteAllPredeployPolicy=function(){function e(e,t,n,a){e.done=function(){n.deleteAllBlocksByPolicyIdandType(T,"CUSTOM").then(function(){D.pageChanged(),o.addAlert({type:"success",content:"删除规则成功"}),o.$broadcast("refreshLeftTable")},function(e){a.reload().then(function(){o.addAlert({type:"danger",content:"规则删除失败："+e.data.error})})}),t.close("done")},e.cancel=function(){t.dismiss("cancel")}}e.$inject=["$scope","$modalInstance","Signature","$state"];var n=t.open({templateUrl:"templates/rule/whitelist/confirmDeleteAllPreDeploy.370eefce.html",controller:e,size:"sm"});n.result.then(function(){},function(){l.info("Modal dismissed at: "+new Date)})},D.deleteSelectPredeployPolicy=function(){var e=[];D.selectedPolicyBlocks.forEach(function(t){e.push(t.policyBlockId)}),D.selectedPolicyBlocks=[],D.alreadyDeployed=!1,n.deleteBlocksByBlockIds(e).then(function(){D.pageChanged(),o.addAlert({type:"success",content:"删除规则成功"}),o.$broadcast("refreshLeftTable")},function(e){o.addAlert({type:"danger",content:"删除规则失败："+e.data.error})})},D.selectedPolicyBlocks=[],D.countSelected=function(e,t,n){e.index=n,t?D.selectedPolicyBlocks.push(e):g(D.selectedPolicyBlocks,e),h()},D.policyPriority=!1,D.updatePriority=function(e){if(!D.policyPriority)if(D.selectedPolicyBlocks.length>0){var t,a,r,i=0;if(D.selectedPolicyBlocks.forEach(function(e){r=e.policyId,t&&a?(e.index>a&&(a=e.index),e.index<t&&(t=e.index)):(t=e.index,a=e.index),delete e.index,delete e.select,delete e.selectAll}),1!==D.selectedPolicyBlocks.length&&a-t+1!==D.selectedPolicyBlocks.length)return o.addAlert({type:"danger",content:"不能跨行选择排序"}),void D.pageChanged();if("t"===e||"u"===e){if(1===t)return o.addAlert({type:"danger",content:"已经为最高优先级不能上移"}),void D.pageChanged()}else if(a===D.totalNum)return o.addAlert({type:"danger",content:"已经为最低优先级不能下移"}),void D.pageChanged();i="t"===e?t-1:"u"===e?1:"l"===e?-1:a-D.totalNum,D.alreadyDeployed=!1,o.$broadcast("refreshLeftTable"),D.policyPriority=!0,n.changePriorityByDirection(r,D.selectedPolicyBlocks,e,i).then(function(){return o.addAlert({type:"success",content:"优先级更新成功"}),D.pageChanged()},function(e){o.addAlert({type:"danger",content:"优先级更新失败："+e.data.error})}).then(function(){D.policyPriority=!1})}else o.addAlert({type:"danger",content:"请最少选择一个规则"})},D.pageChanged=function(){return m.all([y(),v()])};var b=function(e,t,o,a,r,i,l){e.enableEdit=!0,e.enableAction=l,e.rulePagination={currentPage:1,numPerPage:5,totalNum:0},e.rulePagination.totalNum=o.data.length,e.rulePagination.numPages=parseInt(e.rulePagination.totalNum/e.rulePagination.numPerPage),"SIGNATURE"===a.type?a.signatures=o.data:a.rules=o.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage),e.policyBlocks=a,r(e),i(e,o),e.changeRiskLevel=function(e,t){e.riskLevel=t,n.changeRuleRiskLevel(e.ruleId,e.riskLevel).then(function(e){})},e.pageChanged=function(){a.rules=o.data.slice((e.rulePagination.currentPage-1)*e.rulePagination.numPerPage,e.rulePagination.currentPage*e.rulePagination.numPerPage)},e.changeAction=function(e,t){e.action=t,"SIGNATURE"===a.type?p.changeAction(a.policyBlockId,e.signatureId,t).then(function(e){}):n.changeAction(a.policyBlockId,e.ruleId,t).then(function(e){})},e.ok=function(){t.close("ok")},e.cancel=function(){t.dismiss("cancel")}};b.$inject=["$scope","$modalInstance","items","policyBlock","tree","ruleItemEdit","enable"],D.showDetail=function(e,a){var r="/templates/rule/whitelist/policyContent.6483cfd3.html",i=b;D.alreadyDeployed=!1;var l=t.open({templateUrl:r,controller:i,size:"lg",backdrop:!0,resolve:{items:function(){return"SIGNATURE"===e.type?n.getSignaturesbyBlockId(e.policyBlockId):n.getRulesbyBlockId(e.policyBlockId)},policyBlock:function(){return e},enable:function(){return a},policy:function(){return n.getPolicyByPolicyId(T)}}});l.result.then(function(e){},function(){n.getPolicySignatureRulesCount(T).then(function(e){o.disableDeploy=e&&0===e.data})})},D.deploy=function(){var e=0,l=t.open({templateUrl:"/templates/rule/whitelist/confirmDeploy.7f3280e8.html",controller:["$scope","$modalInstance",function(e,t){var n=!1;e.check={checkIDS:!0,checkProtocol:!0,checkDisconnect:!0,checkBlacklistOnly:!0},e.msg={text:"部署新规则将会覆盖原部署规则，这个步骤无法还原。",qus:"确定部署新规则？",buttonText:"部署规则",fontAwesomeText:"fa-cloud-download",isShowDeviceConnectedCnt:0,isShowDeviceDisconnectedMsg:!1,isShowDeviceDisconnectedText:"规则将无法部署以下未连线设备：",hasIDS:!1,hasIDSText:"以下监测审计设备上的阻断规则会被智能替换为告警。",noProtocolWarning:!1,noProtocolWarningText:"以下数采隔离设备没有选择数采隔离协议。如果部署规则，经过以下隔离设备的所有的协议流量将会被阻止。",hasWhitelistPort:!1,blacklistOnlyWarningText:"以下设备只能部署黑名单。白名单将无法部署到以下设备:",isShowDeviceUpgradingMsg:n},e.ok=function(){e.msg.isShowDeviceUpgradingMsg?t.dismiss("cancel"):t.close()},e.cancel=function(){t.dismiss("cancel")}}],size:"sm"});l.result.then(function(){return 0===D.table.length?void o.addAlert({type:"danger",content:"没有有效的规则，不可部署"}):void n.deploy(T).then(function(t){var n=t.data.taskId,l=m.defer();o.deployTaskPromise=l.promise,o.deployTaskPromise.then(function(e){"success"===e&&r.go("rule."+D.protocolType+".deploy",{tab:"deployedPanel"})}),function e(t){var r=a(function(){i.getTask(n,o.currentIp).then(function(n){if("SUCCESS"===n.data.state){o.addAlert({type:"success",content:"部署成功"});for(var i=0;i<D.table.length;i++)D.table[i].status="ACTIVE";D.foreverDeployed=o.alreadyDeployed=D.alreadyDeployed=!0,o.$broadcast("updateDashboardHeader"),l.resolve("success"),a.cancel(r)}else"FAILED"===n.data.state?(o.addAlert({type:"danger",content:n.data.reason?"部署失败："+n.data.reason:"部署失败"}),l.resolve("fail"),a.cancel(r)):t>0?e(t-1):(l.resolve("timeout"),o.addAlert({type:"danger",content:"部署超时"}))})},1e3)}(120+15*e)},function(e){o.addAlert({type:"danger",content:e.data.rejectReason?"部署失败："+e.data.rejectReason:"部署失败"})})},function(){})}}e.$inject=["$scope","$modal","Signature","$rootScope","$timeout","$state","Task","$log","Device","dataservice","System","Topology","Template","$stateParams","$q"];var t={restrict:"E",scope:!1,templateUrl:"/templates/rule/whitelist/pre-deploy-table.7084a7bf.html",controllerAs:"policyblocks",controller:e};return t}angular.module("southWest.rule.whitelist").directive("preDeployTable",e)}(),function(){"use strict";function e(e){e.state("securityaudit",{parent:"dashboard",abstract:!0,controller:"SecurityAuditCtrl as securityaudit",templateUrl:"templates/securityaudit/index.6d812724.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("securityaudit.audittable",{url:"/securityaudit/protocolaudit",controller:"AuditTableCtrl as audittable",templateUrl:"templates/protocolaudit/index.e7fb8ad7.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("securityaudit.audittable.dpidata",{parent:"securityaudit",url:"/securityaudit/audit/dpidata",controller:"DPIDataCtrl as dpidata",templateUrl:"templates/audit/dpidata/index.00ca2881.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("securityaudit.audittable.dpidevicedata",{parent:"securityaudit",url:"/securityaudit/audit/dpidevicedata",controller:"DPIDeviceDataCtrl as dpidevicedata",templateUrl:"templates/audit/dpidevicedata",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("securityaudit.audittable.icdevicedata",{parent:"securityaudit",url:"/securityaudit/audit/icdevicedata",controller:"ICDeviceDataCtrl as icdevicedata",templateUrl:"templates/audit/icdevicedata",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("securityaudit.audittable.behavioraudit",{parent:"securityaudit",url:"/securityaudit/audit/behavioraudit",controller:"BehaviorCtrl as BehaviorCtrl",templateUrl:"templates/audit/behavior/index.ca8b13cd.html",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("securityaudit.audittable.forumpost",{parent:"securityaudit",url:"/securityaudit/audit/forumpost",controller:"ForumPostDataCtrl as forumpostdata",templateUrl:"templates/audit/forumpostdata",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}}).state("securityaudit.audittable.searchengine",{parent:"securityaudit",url:"/securityaudit/audit/searchengine",controller:"SearchEngineDataCtrl as searchenginedata",templateUrl:"templates/audit/searchenginedata",resolve:{state:["$rootScope",function(e){e.currentState="AUDIT_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.securityaudit").config(e)}(),function(){"use strict";function e(e,t,n,o){var a=this;a.closeAudit=!0,a.closeContent=!0,a.expanded="true"===localStorage.getItem("securityaudit:navbar:expanded"),a.toggleExpand=function(){a.expanded=!a.expanded,localStorage.setItem("securityaudit:navbar:expanded",a.expanded)},a.isActive=function(e){return"protocolaudit"===e&&"securityaudit.audittable"===t.current.name||("audit"!==e&&"dpidata"!==e&&"dpidevice_data"!==e&&"icdevice_data"!==e||"securityaudit.audittable.dpidata"!==t.current.name&&"securityaudit.audittable.dpidevicedata"!==t.current.name&&"securityaudit.audittable.icdevicedata"!==t.current.name&&"audit.dpidevice_data"!==t.current.name&&"audit.dpidevice_data.detail"!==t.current.name&&"audit.icdevice_data"!==t.current.name&&"audit.icdevice_data.detail"!==t.current.name?"behavioraudit"===e&&("securityaudit.audittable.behavioraudit"===t.current.name||"audit.behaviortimecontrol"===t.current.name)||!("contentaudit"!==e&&"forumpost"!==e&&"searchengine"!==e||"securityaudit.audittable.forumpost"!==t.current.name&&"securityaudit.audittable.searchengine"!==t.current.name&&"audit.timecontrol"!==t.current.name)&&a.closeContent:a.closeAudit)},a.isActiveSub=function(e){return"dpidata"===e&&"securityaudit.audittable.dpidata"===t.current.name||("dpidevice_data"===e&&("audit.dpidevice_data"===t.current.name||"audit.dpidevice_data.detail"===t.current.name||"securityaudit.audittable.dpidevicedata"===t.current.name)||("icdevice_data"===e&&("audit.icdevice_data"===t.current.name||"audit.icdevice_data.detail"===t.current.name||"securityaudit.audittable.icdevicedata"===t.current.name)||(!("forumpost"!==e||!("securityaudit.audittable.forumpost"===t.current.name||"audit.timecontrol"===t.current.name&&n.menuName&&"forumpost"===n.menuName))||!("searchengine"!==e||!("securityaudit.audittable.searchengine"===t.current.name||"audit.timecontrol"===t.current.name&&n.menuName&&"searchengine"===n.menuName)))))},a.uiEnable=function(e,t){return o.isShow(e,t)},a.entry=function(e){"protocolaudit"===e.getState()&&t.go("securityaudit.audittable"),"dpidata"===e.getState()&&t.go("securityaudit.audittable.dpidata"),"dpidevice_data"===e.getState()&&t.go("securityaudit.audittable.dpidevicedata"),"icdevice_data"===e.getState()&&t.go("securityaudit.audittable.icdevicedata"),"behavioraudit"===e.getState()&&t.go("securityaudit.audittable.behavioraudit"),"forumpost"===e.getState()&&t.go("securityaudit.audittable.forumpost"),"searchengine"===e.getState()&&t.go("securityaudit.audittable.searchengine")},a.displayNav=!0,n.isJAXX||(a.displayNav=!1),a.notJAStyle={},n.isJAXX||(a.notJAStyle={"margin-left":"-25px","margin-right":"-20px","margin-top":"-10px"})}e.$inject=["$scope","$state","$rootScope","uiCtrl"],angular.module("southWest.securityaudit").controller("SecurityAuditCtrl",e)}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s){function c(){var t;if(0===e.actionAuditList.length)e.retList.push({srcIp:"0.0.0.0",destIp:"0.0.0.0",enabled:!0});else for(var n=e.actionAuditList.length-1;n>=0;n--)t=e.actionAuditList[n],delete t.srcIpError,delete t.destIpError,delete t.duplicateError,e.retList.push(e.actionAuditList[n])}var d=this;d.allowConfirm=!0,e.editMode=!1,o.getAuditSetting("action").then(function(t){e.originalActionAuditListList=t,e.actionAuditList=[],1===e.originalActionAuditListList.length&&"0.0.0.0"===e.originalActionAuditListList[0].srcIp&&"0.0.0.0"===e.originalActionAuditListList[0].destIp?e.originalActionAuditListList=[]:angular.copy(e.originalActionAuditListList,e.actionAuditList)}),d.edit=function(){0===e.actionAuditList.length&&e.actionAuditList.push({srcIp:"0.0.0.0",destIp:"0.0.0.0",enabled:!0,srcIpError:!1,destIpError:!1}),e.editMode=!0},d.cancel=function(){e.editMode=!1,angular.copy(e.originalActionAuditListList,e.actionAuditList)},d.enableAll=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.enabled=!0}},d.disableAll=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.enabled=!1}},d.confirm=function(){function n(e,t){e.offlineDevices=[],e.onlineDevices=[],e.check={OfflineWarning:!1};var n={$filter:"(category eq SECURITY_DEVICE)"};r.getAll(n).then(function(n){n.map(function(t){1!==t.deviceOnline?e.offlineDevices.push(t):e.onlineDevices.push(t)}),e.cancel=function(){t.dismiss("cancel")},e.ok=function(){t.close("done")}})}n.$inject=["$scope","$modalInstance"],e.retList=[],c();var d=a.open({templateUrl:"templates/securityauditsetting/actionaudit/actionAudit-deviceOffline-confirm-panel.2695f02f.html",size:"sm",controller:n});d.result.then(function(){var n=i.defer();t.actionAuditTaskPromise=n.promise,o.setAuditSetting(e.retList).then(function(o){var a=o.data.taskId;!function o(r){var i=l(function(){s.getTask(a).then(function(a){"SUCCESS"===a.data.state?(t.addAlert({type:"success",content:"行为审计配置下发成功"}),n.resolve("success"),l.cancel(i),e.editMode=!1):"FAILED"===a.data.state?(t.addAlert({type:"danger",content:a.data.reason?"行为审计配置下发失败："+a.data.reason:"行为审计配置下发失败"}),n.resolve("fail"),l.cancel(i)):"REJECTED"===a.data.state?(t.addAlert({type:"danger",content:a.data.reason?"行为审计配置下发失败："+a.data.reason:a.data.rejectReason?"行为审计配置下发失败："+a.data.rejectReason:"行为审计配置下发被拒绝"}),n.resolve("fail"),l.cancel(i)):("PENDING"===a.data.state,r>0?o(r-1):(n.resolve("timeout"),t.addAlert({type:"danger",content:"协议开关下发超时"}),l.cancel(i)))})},1e3)}(30)},function(e){t.addAlert({type:"danger",content:e.data.reason?"行为审计配置下发失败："+e.data.reason:e.data.rejectReason?"行为审计配置下发失败："+e.data.rejectReason:"行为审计配置下发失败"}),n.resolve("fail")})})},e.validateAuditIp=function(e){e.srcIpError=!n.checkAuditIpFormat(e.srcIp),e.destIpError=!n.checkAuditIpFormat(e.destIp)},e.addActionAuditCfg=function(){e.actionAuditList.push({srcIp:"",destIp:"",enabled:!0,srcIpError:!0,destIpError:!0})},e.removeCfg=function(t){e.actionAuditList.splice(t,1)},e.removeAllCfg=function(){function t(e,t){e.cancel=function(){t.dismiss("cancel")},e.ok=function(){t.close("done")}}t.$inject=["$scope","$modalInstance"];var n=a.open({templateUrl:"templates/securityauditsetting/actionaudit/actionAudit-setting-remove-all-modal.86dcc7ec.html",size:"sm",controller:t});n.result.then(function(){e.actionAuditList=[],e.validateAll()})},e.validateDuplicate=function(){var t={};jQuery.each(e.actionAuditList,function(n,o){void 0!==t[o.srcIp+"||"+o.destIp]?(o.duplicateError=!0,e.actionAuditList[t[o.srcIp+"||"+o.destIp]].duplicateError=!0):(t[o.srcIp+"||"+o.destIp]=n,o.duplicateError=!1)})},e.validateAll=function(){var t,n;for(t=0;t<e.actionAuditList.length;t++)if(n=e.actionAuditList[t],n.srcIpError||n.destIpError||n.duplicateError)return void(d.allowConfirm=!1);d.allowConfirm=!0}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"templates/securityauditsetting/actionaudit/index.ae2291db.html",controller:e,controllerAs:"actionAuditCtrl"};return t}angular.module("southWest.securityauditsetting").directive("actionAudit",e)}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s){function c(){var t;if(0===e.contentAuditList.length)e.retList.push({srcIp:"0.0.0.0",destIp:"0.0.0.0",enabled:!0});else for(var n=e.contentAuditList.length-1;n>=0;n--)t=e.contentAuditList[n],delete t.srcIpError,delete t.destIpError,delete t.duplicateError,e.retList.push(e.contentAuditList[n])}var d=this;d.allowConfirm=!0,e.editMode=!1,o.getAuditSetting("content").then(function(t){e.originalContentAuditListList=t,e.contentAuditList=[],1===e.originalContentAuditListList.length&&"0.0.0.0"===e.originalContentAuditListList[0].srcIp&&"0.0.0.0"===e.originalContentAuditListList[0].destIp?e.originalContentAuditListList=[]:angular.copy(t,e.contentAuditList)}),d.edit=function(){0===e.contentAuditList.length&&e.contentAuditList.push({srcIp:"0.0.0.0",destIp:"0.0.0.0",enabled:!0,srcIpError:!1,destIpError:!1}),e.editMode=!0},d.cancel=function(){e.editMode=!1,angular.copy(e.originalContentAuditListList,e.contentAuditList)},d.enableAll=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.enabled=!0}},d.disableAll=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.enabled=!1}},d.confirm=function(){function n(e,t){e.offlineDevices=[],e.onlineDevices=[],e.check={OfflineWarning:!1};var n={$filter:"(category eq SECURITY_DEVICE)"};r.getAll(n).then(function(n){n.map(function(t){1!==t.deviceOnline?e.offlineDevices.push(t):e.onlineDevices.push(t)}),e.cancel=function(){t.dismiss("cancel")},e.ok=function(){t.close("done")}})}n.$inject=["$scope","$modalInstance"],e.retList=[],c();var d=a.open({templateUrl:"templates/securityauditsetting/contentaudit/contentAudit-deviceOffline-confirm-panel.67962ecc.html",size:"sm",controller:n});d.result.then(function(){var n=i.defer();t.contentAuditTaskPromise=n.promise,o.setContentAuditSetting(e.retList).then(function(o){var a=o.data.taskId;!function o(r){var i=l(function(){s.getTask(a).then(function(a){"SUCCESS"===a.data.state?(t.addAlert({type:"success",content:"内容审计配置下发成功"}),n.resolve("success"),l.cancel(i),e.editMode=!1):"FAILED"===a.data.state?(t.addAlert({type:"danger",content:a.data.reason?"内容审计配置下发失败："+a.data.reason:"内容审计配置下发失败"}),n.resolve("fail"),l.cancel(i)):"REJECTED"===a.data.state?(t.addAlert({type:"danger",content:a.data.reason?"内容审计配置下发失败："+a.data.reason:a.data.rejectReason?"内容审计配置下发失败："+a.data.rejectReason:"内容审计配置下发被拒绝"}),n.resolve("fail"),l.cancel(i)):("PENDING"===a.data.state,r>0?o(r-1):(n.resolve("timeout"),t.addAlert({type:"danger",content:"协议开关下发超时"}),l.cancel(i)))})},1e3)}(30)},function(e){t.addAlert({type:"danger",content:e.data.reason?"内容审计配置下发失败："+e.data.reason:e.data.rejectReason?"内容审计配置下发失败："+e.data.rejectReason:"内容审计配置下发失败"}),n.resolve("fail")})})},e.validateAuditIp=function(e){e.srcIpError=!n.checkAuditIpFormat(e.srcIp),e.destIpError=!n.checkAuditIpFormat(e.destIp)},e.addcontentAuditCfg=function(){e.contentAuditList.push({srcIp:"",destIp:"",enabled:!0,srcIpError:!0,destIpError:!0})},e.removeCfg=function(t){e.contentAuditList.splice(t,1)},e.removeAllCfg=function(){function t(e,t){e.cancel=function(){t.dismiss("cancel")},e.ok=function(){t.close("done")}}t.$inject=["$scope","$modalInstance"];var n=a.open({templateUrl:"templates/securityauditsetting/contentaudit/contentAudit-setting-remove-all-modal.86dcc7ec.html",size:"sm",controller:t});n.result.then(function(){e.contentAuditList=[],e.validateAll()})},e.validateDuplicate=function(){var t={};jQuery.each(e.contentAuditList,function(n,o){void 0!==t[o.srcIp+"||"+o.destIp]?(o.duplicateError=!0,e.contentAuditList[t[o.srcIp+"||"+o.destIp]].duplicateError=!0):(t[o.srcIp+"||"+o.destIp]=n,o.duplicateError=!1)})},e.validateAll=function(){var t,n;for(t=0;t<e.contentAuditList.length;t++)if(n=e.contentAuditList[t],n.srcIpError||n.destIpError||n.duplicateError)return void(d.allowConfirm=!1);d.allowConfirm=!0}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"templates/securityauditsetting/contentaudit/index.67a39a9b.html",controller:e,controllerAs:"contentAuditCtrl"};return t}angular.module("southWest.securityauditsetting").directive("contentAudit",e)}(),function(){"use strict";function e(e){e.state("audit_setting",{parent:"dashboard",url:"/audit_setting",controller:"SecurityauditSettingCtrl as securityauditsetting",templateUrl:"templates/securityauditsetting/index.8f52911e.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_AUDIT"}]}}).state("audit_setting.protocol_setting",{parent:"dashboard",url:"/audit_setting/protocol_setting",controller:"SecurityauditSettingCtrl as securityauditsetting",templateUrl:"templates/securityauditsetting/index.8f52911e.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_AUDIT"}]}}).state("audit_setting.behavior_setting",{parent:"dashboard",url:"/audit_setting/behavior_setting",controller:"SecurityauditSettingCtrl as securityauditsetting",templateUrl:"templates/securityauditsetting/index.8f52911e.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_AUDIT"}]}}).state("audit_setting.content_setting",{parent:"dashboard",url:"/audit_setting/content_setting",controller:"SecurityauditSettingCtrl as securityauditsetting",templateUrl:"templates/securityauditsetting/index.8f52911e.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_AUDIT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.securityauditsetting").config(e)}(),function(){"use strict";function e(e){var t=this;t.tabEnabled=function(t){var n=e.customizedMenus.filter(function(e){return e.target===t});return!!(n&&n.length>0)},t.tabEnabled("PROTOCOL_SETTING")?t.securityauditsetting_init_tab="PROTOCOL_SETTING":t.tabEnabled("BEHAVIOR_SETTING")?t.securityauditsetting_init_tab="BEHAVIOR_SETTING":t.securityauditsetting_init_tab="CONTENT_SETTING"}e.$inject=["$rootScope"],angular.module("southWest.securityauditsetting").controller("SecurityauditSettingCtrl",e)}(),function(){"use strict";function e(e){e.state("session.flowdata_industry",{url:"/flowdata/industry",controller:"ICDeviceDataCtrl2 as icdevicedata",templateUrl:"templates/session/flowdata/industry/index.57878c59.html"}).state("session.flowdata_industry.detail",{parent:"session",url:"/flowdata/industry/detail/deviceid/:deviceID/deviceInfo/:deviceInfo",controller:"ICDeviceProtocolTrafficDataCtrl2 as icdeviceprotocoltrafficdata",templateUrl:"templates/session/flowdata/industry/icDeviceProtocolTraffic.63055b2a.html",resolve:{menuState:function(){return"session.flowdata_industry"},deviceId:["$stateParams",function(e){return e.deviceID}],deviceInfo:["$stateParams",function(e){return e.deviceInfo}]}})}e.$inject=["$stateProvider"],angular.module("southWest.session.flowdata_industry").config(e)}(),function(){"use strict";function e(e,t,o,a,r,i){function l(){s();var e=r(function(){s()},24e3);o.$on("$destroy",function(){r.cancel(e)})}function s(){o.reloadDevices=!0,t.sysbaseinfo().then(function(t){var a=new Date(t.data||""),r=a-24e3,i=new Date(r),l=i-36e5,s=new Date(l);e.getTopTrafficDevice(s,i,5).then(function(e){c(e).then(function(){n($("#icdevice-device-line-chart").highcharts()),o.reloadDevices=!1})})})}function c(n){var o=5,r=$("#icdevice-device-line-chart").highcharts(),i=r?r.series||[]:[];if(r&&i){var l=function(e,t){for(var n=0;n<t.length;n++)if(t[n].options.id===e.deviceId)return t[n]},s=function(){var e=[];i.forEach(function(t){e.push(t.color)});for(var t=0;t<p.length;t++)if($.inArray(p[t],e)<0)return p[t];return p[p.length-1]};return t.sysbaseinfo().then(function(t){var c=new Date(t.data||""),d=c-24e3,u=[];i.forEach(function(e){for(var t=0;t<n.length;t++)if(void 0!==e&&e.options.id===n[t].deviceId)return;u.push(e)}),u.forEach(function(e){e.remove(!1)});for(var p=[],f=0;f<n.length&&f<=o;f++){var m=n[f],g=l(m,i),h=void 0===g,v=new Date(d),y=h?36e5:24e3,I=v-y,D=new Date(I);h?r.addSeries({id:m.deviceId,name:void 0===m.Id||null===m.Id||"0"===m.Id||"0"===m.Id?m.deviceName+" ("+m.deviceId+")":m.deviceName,color:s()}):g.update({name:void 0===m.Id||null===m.Id||"0"===m.Id||"0"===m.Id?m.deviceName+" ("+m.deviceId+")":m.deviceName}),p.push(e.getDeviceTraffic(m,D,v))}return a.all(p).then(function(e){for(var t=0;t<n.length&&t<=o;t++){for(var a=l(e[t].device,i),s=e[t].endTime.getTime(),c=0;c<e[t].data.length;c++){var d=new Date(e[t].data[c].timestamp).getTime(),u=Math.floor(e[t].data[c].totalBytes/10.24)/100;a&&a.addPoint([d,u],!1,!1)}0===e[t].data.length&&i[t]&&i[t].addPoint([s,0],!1,!1),r.redraw()}})})}return a.when(!1)}function d(){a.all([t.sysbaseinfo()]).then(function(){o.reloadDevices=!1,f.showDeviceLine(),l()})}function u(){var t=1;f.timeSpan=f.timeSpan||"1h","1h"===f.timeSpan?t=36e5:"24h"===f.timeSpan?t=864e5:"168h"===f.timeSpan&&(t=6048e5),e.getDeviceTrafficStatistics(t).then(function(e){f.trafficsStaticsData=e,f.showDeviceTrafficPieChart()})}var p=["#7cb5ec","#f45b5b","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#91e8e1"],f=this;f.showDeviceLine=function(){var t={title:null,legendEnable:!0,deviceIds:[]};$("#icdevice-device-line-chart").highcharts(e.deviceLineChart([],t))},f.showDeviceTrafficPieChart=function(){var t={title:null},o=0;f.trafficsStaticsData.forEach(function(e){o+=e.totalBytes}),f.totalDevices=f.trafficsStaticsData.length,f.totalTraffics=i.formatTrafficDataWithUnit(o),f.reportTime=new Date;var a=f.totalTraffics.substring(f.totalTraffics.indexOf(" ")+1);$("#icdevice-traffic-statistics-pie-chart").highcharts(e.devicePieChart(f.trafficsStaticsData,t,a)),n($("#icdevice-traffic-statistics-pie-chart").highcharts())},f.changeDeviceLineChart=function(){a.all([t.sysbaseinfo()]).then(function(){f.showDeviceLine(),s()})},f.changeDeviceTrafficPieChartTimeSpan=function(){u()},d()}function t(e,t,o,a,r,i,l,s){function c(){d();var e=l(function(){d()},24e3);r.$on("$destroy",function(){l.cancel(e)})}function d(){o.getSelectedProtocols(g.deviceId).then(function(e){u(e).then(function(){n($("#icdevice-traffic-statistics-pie-chart").highcharts())})})}function u(e){var t=$("#icdevice-device-protocol-line-chart").highcharts(),n=t?t.series||[]:[],r=g.deviceId;if(t&&n&&e.length){var l=function(e,t){for(var n=0;n<t.length;n++)if(t[n].name===e.protocolName)return!0;return!1},s=function(){var e=[];n.forEach(function(t){e.push(t.color)});for(var t=0;t<m.length;t++)if($.inArray(m[t],e)<0)return m[t];return m[m.length-1]};return a.sysbaseinfo().then(function(a){var c=new Date(a.data||""),d=c-24e3,u=[];n.forEach(function(t){for(var n=0;n<e.length;n++)if(t&&t.name===e[n].protocolName)return;u.push(t)}),u.forEach(function(e){e.remove(!1)});for(var p=[],f=0;f<e.length;f++){var m=e[f],g=l(m,n)===!1,h=new Date(d),v=g?36e5:24e3,y=h-v,I=new Date(y);g&&t.addSeries({name:m.protocolName,color:s()}),p.push(o.getProtocolTraffic(r,m.trafficId,I,h))}return i.all(p).then(function(o){for(var a=0;a<e.length;a++){for(var r=o[a].endTime.getTime(),i=0;i<o[a].data.length;i++){var l=new Date(o[a].data[i].timestamp).getTime(),s=Math.floor(o[a].data[i].totalBytes/10.24)/100;n[a]&&n[a].addPoint([l,s],!1,!1)}0===o[a].data.length&&n[a]&&n[a].addPoint([r,0],!1,!1),t.redraw()}})})}return i.when(!1)}function p(){i.all([a.sysbaseinfo()]).then(function(e){g.showProtocolLine(),c()})}function f(){var e=1;g.timeSpan=g.timeSpan||"1h","1h"===g.timeSpan?e=36e5:"24h"===g.timeSpan?e=864e5:"168h"===g.timeSpan&&(e=6048e5),o.getProtocolTrafficStatistics(g.deviceId,e).then(function(e){g.trafficsStaticsData=e,g.showProtocolTrafficPieChart()})}var m=["#2b908f","#90ee7e","#f45b5b","#7798BF","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"],g=this;g.deviceId=e;var h=decodeURI(t).split("|");g.device={deviceName:h[2],ipAddr:h[1],macAddr:h[0]},g.showProtocolLine=function(){var e={title:null,legendEnable:!0};$("#icdevice-device-protocol-line-chart").highcharts(o.protocolLineChart([],e))},g.showProtocolTrafficPieChart=function(){var e={title:null},t=0;g.trafficsStaticsData.forEach(function(e){t+=e.totalBytes}),g.protocolReportTime=new Date,g.totalTraffics=s.formatTrafficDataWithUnit(t);var a=g.totalTraffics.substring(g.totalTraffics.indexOf(" ")+1);$("#icdevice-traffic-statistics-pie-chart").highcharts(o.protocolPieChart(g.trafficsStaticsData,e,a)),n($("#icdevice-traffic-statistics-pie-chart").highcharts())},g.changeProtocolLineChart=function(){i.all([a.sysbaseinfo()]).then(function(){g.showProtocolLine(),c()})},g.changeDeviceTrafficPieChartTimeSpan=function(){f()},p()}function n(e){var t=400;if(e){var n=e.hasData()?t:t/2;n!==e.chartHeight&&e.setSize(e.chartWidth,n,!1)}}e.$inject=["icdevicedata","apiInfo","$scope","$q","$interval","trafficDataService"],t.$inject=["deviceId","deviceInfo","icdevicedata","apiInfo","$scope","$q","$interval","trafficDataService"],angular.module("southWest.session.flowdata_industry").controller("ICDeviceDataCtrl2",e).controller("ICDeviceProtocolTrafficDataCtrl2",t)}(),function(){"use strict";function e(e,t,n){function o(o,a,r,i){function l(e){return t.sysbaseinfo().then(function(t){var o=new Date(t.data||""),a=o-24e3,r=new Date(a),i=r-36e5,l=new Date(i);return n.getDeviceTrafficCount(l,r,e)})}function s(o){return t.sysbaseinfo().then(function(t){var a=new Date(t.data||""),r=a-24e3,i=new Date(r),l=i-36e5,s=new Date(l);return n.getDeviceTrafficList(s,i,o).then(function(t){return t.length?e.all(t).then(function(){return t.map(function(e,n){t[n].avgRecvSpeed=Math.floor(t[n].avgRecvSpeed/10.24)/100+" KB/s",t[n].avgSendSpeed=Math.floor(t[n].avgSendSpeed/10.24)/100+" KB/s",t[n].timestamp=new Date(t[n].timestamp).getTime()}),t}):[]})})}var c=["totalBytes","deviceName","ipAddr","macAddr","recvBytes","sendBytes","percent","createdAt"];i.disableToolbar=!0,i.setConfig({name:"devicedata",pagination:!0,numPerPage:5,scrollable:!1,totalCount:!0,fields:c,getAll:s,getCount:l}),o.$watch(function(){return o.reloadDevices},function(){o.reloadDevices===!0&&o.$parent.dtable.getTableData()})}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/session/flowdata/industry/icdevicedataTable.d736001a.html",link:o};return a}function t(e){function t(t,n,o,a){function r(e){return i(e)}function i(n){var o=n||{};return t.skip=n.$skip||0,e.getDeviceTrafficStats(o)}function l(t){var n=t||{};return e.getDeviceTrafficStatsCount(n)}var s=["iCDeviceIp","protocolType","timestamp","trafficType"],c=[{text:"所有协议",value:"-1"},{text:"TCP",value:"1"},{text:"UDP",value:"2"},{text:"ICMP",value:"3"},{text:"OPC_Classic",value:"4"},{text:"其它",value:"5"}],d=[{text:"所有协议",value:"-1"},{text:"MODBUS_TCP",value:"1"},{text:"OPCDA",value:"2"},{text:"IEC104",value:"3"},{text:"DNP3",value:"4"},{text:"MMS",value:"5"},{text:"S7",value:"6"},{text:"PROFINETIO",value:"7"},{text:"GOOSE",value:"8"},{text:"SV",value:"9"},{text:"ENIP",value:"10"},{text:"OPCUA",value:"12"},{text:"PNRT_DCP",value:"13"},{text:"MODBUS_UDP",value:"14"}];a.setConfig({name:"item",numPerPage:10,pagination:!0,scrollable:!1,totalCount:!0,getAll:i,getCount:l,search:r,fields:s,advancedSearch:"item",advancedSearchOptions:[{name:"timestamp",display:"时间",input:"timerange",option:!0,value:[],options:[]},{name:"iCDeviceIp",display:"IP",input:"string",option:!1,value:""},{name:"protocolType",display:"网络服务",input:"checkbox",option:!0,value:"-1",options:c},{name:"trafficType",display:"协议类型",input:"checkbox",option:!0,value:"-1",options:d}]})}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/session/flowdata/industry/flowdataTable.a1aff8cb.html",link:t};return n}e.$inject=["$q","apiInfo","icdevicedata"],t.$inject=["icdevicedata"],angular.module("southWest.session.flowdata_industry").directive("icdevicedataTable2",e).directive("flowdataTable",t)}(),function(){"use strict";function e(){var e=[{text:"所有协议",value:"-1"},{text:"TOTAL",value:"0"},{text:"MODBUS_TCP",value:"1"},{text:"OPCDA",value:"2"},{text:"IEC104",value:"3"},{text:"DNP3",value:"4"},{text:"MMS",value:"5"},{text:"S7",value:"6"},{text:"PROFINETIO",value:"7"},{text:"GOOSE",value:"8"},{text:"SV",value:"9"},{text:"ENIP",value:"10"},{text:"OPCUA",value:"12"},{text:"PNRT_DCP",value:"13"},{text:"MODBUS_UDP",value:"14"},{text:"OTHER",value:"100"}];return function(t){return(_.find(e,{value:t.toString()})||{}).text||t}}angular.module("southWest.session.flowdata_industry").filter("trafficType",e)}(),function(){"use strict";function e(e){e.state("session.flowdata_overview",{url:"/flowdata/overview",controller:"DPIDataCtrl2 as dpidata",templateUrl:"templates/session/flowdata/overview/index.c8fe0afc.html"})}e.$inject=["$stateProvider"],angular.module("southWest.session.flowdata_overview").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s){function c(){e.getOverView(36e5).then(function(e){m.overViewData=e.data,m.showTotalLineChart()})}function d(){var t=1;"1h"===m.protocolTime?t=36e5:"24h"===m.protocolTime?t=864e5:"168h"===m.protocolTime&&(t=6048e5),e.getProtocolView(t).then(function(e){m.protocolViewData=e,
m.showProtocolPieChart()})}function u(e){var t=400;if(e){var n=e.hasData()?t:t/2;n!==e.chartHeight&&e.setSize(e.chartWidth,n,!1)}}function p(){return s.sysbaseinfo().then(function(e){var t=new Date(e.data||""),n=t-24e3,o=new Date(n),a=o-36e5,r=new Date(a);l.getSelectedProtocols(r,o).then(function(e){m.protocols=e,f()})})}function f(){m.protocolRealTimeData=[],m.protocols&&s.sysbaseinfo().then(function(e){for(var t=new Date(e.data||""),n=t-24e3,a=new Date(n),r=a-36e5,i=new Date(r),s=[],c=0;c<m.protocols.length;c++)s.push(l.getProtocolRealTime(m.protocols[c].trafficId,i,a));o.all(s).then(function(e){for(var t=0;t<m.protocols.length;t++)e[t].data.length>0?m.protocolRealTimeData.push(e[t].data):m.protocolRealTimeData.push({timestamp:e[t].endTime,totalBytes:0});m.showProtocolLine()})})}var m=this;m.protocolTime="1h",c(),d(),p(),m.showTotalLineChart=function(){var t=[],n={name:"数据流量",data:function(){var e=[];if(!m.overViewData)return e;if(m.overViewData.length<1)return e.push({x:(new Date).getTime(),y:0}),e;var t=0-m.overViewData.length;for(t;t<0;t+=1){var n=new Date(m.overViewData[t+m.overViewData.length].timestamp).getTime(),o=Math.floor(m.overViewData[t+m.overViewData.length].totalBytes/10.24)/100;e.push({x:n,y:o})}return e}()};t.push(n);var o={title:null,legendEnable:!0};$("#dpi-overview-line-chart").highcharts(e.totalLineChart(t,o,a))},m.showProtocolPieChart=function(){m.protocolTotal=0,m.protocolNum=0,m.reportTime=new Date;for(var t={title:null},n=0;n<m.protocolViewData.length;n++)m.protocolNum++,m.protocolTotal+=m.protocolViewData[n].totalBytes;if(m.protocolTotal>0){m.protocolTotal=i.formatTrafficDataWithUnit(m.protocolTotal);var o=m.protocolTotal.substring(m.protocolTotal.indexOf(" ")+1);$("#dpi-protocol-pie-chart").highcharts(e.pieChart(m.protocolViewData,t,o))}else t={title:null},$("#dpi-protocol-pie-chart").highcharts(e.pieChart(m.protocolViewData,t));u($("#dpi-protocol-pie-chart").highcharts())},m.changeProtocolPieChart=function(){d()},m.showDeviceLine=function(){if(m.selectedDevices){var t=[],n=["#7cb5ec","#f45b5b","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#91e8e1"];if(m.selectedDevices.length>3)return 0;for(var o=[],r=function(e){var t=[];if(!m.deviceData[e])return t;if(m.deviceData[e].length<1)return t.push({x:(new Date).getTime(),y:0}),t;var n=0-m.deviceData[e].length;for(n;n<0;n+=1){var o=new Date(m.deviceData[e][n+m.deviceData[e].length].startTime).getTime(),a=Math.floor(m.deviceData[e][n+m.deviceData[e].length].totalBytes/10.24)/100;t.push({x:o,y:a})}return t},i=0;i<m.selectedDevices.length;i++){o.push(m.selectedDevices[i].deviceId);var l={name:m.selectedDevices[i].name,color:n[i],data:r(i)};t.push(l)}var s={title:null,legendEnable:!0,deviceIds:o};m.deviceLineChart=e.deviceLineChart(t,s,a),$("#dpi-deviceview-line-chart").highcharts(m.deviceLineChart)}},m.showProtocolLine=function(){if(m.protocols){for(var e=[],t=["#2b908f","#90ee7e","#f45b5b","#7798BF","#aaeeee","#ff0066","#eeaaee","#55BF3B","#DF5353","#7798BF","#aaeeee"].reverse(),n=[],o=function(e){var t=[];if(!m.protocolRealTimeData[e])return t;if(m.protocolRealTimeData[e].length<1)return t.push({x:(new Date).getTime(),y:0}),t;var n=0-m.protocolRealTimeData[e].length;for(n;n<0;n+=1){var o=new Date(m.protocolRealTimeData[e][n+m.protocolRealTimeData[e].length].timestamp).getTime(),a=Math.floor(m.protocolRealTimeData[e][n+m.protocolRealTimeData[e].length].totalBytes/10.24)/100;t.push({x:o,y:a})}return t},r=0;r<m.protocols.length;r++){n.push(m.protocols[r].trafficId);var i={name:m.protocols[r].protocolName,color:t.pop(),data:o(r)};e.push(i)}var s={title:null,legendEnable:!0,protocolIds:n};$("#dpidevice-protocol-line-chart").highcharts(l.protocolLineChart(e,s,t,a)),u($("#dpidevice-protocol-line-chart").highcharts())}}}e.$inject=["mwdata","$modal","$rootScope","$q","$scope","uiCtrl","trafficDataService","dpidevicedata","apiInfo"],angular.module("southWest.session.flowdata_overview").controller("DPIDataCtrl2",e)}(),function(){"use strict";function e(e){e.state("session.protocol",{url:"/protocol",controller:"SessionProtocolCtrl as SessionProtocolCtrl",templateUrl:"templates/session/protocol/index.8a96f59a.html",resolve:{state:["$rootScope",function(e){e.currentState="STRATEGY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.session.protocol").config(e)}(),function(){"use strict";function e(){}angular.module("southWest.session.protocol").controller("SessionProtocolCtrl",e)}(),function(){"use strict";function e(){function e(e,t,n,o){function a(e,t){return e/t<.5?.5:e/t>4?4:e/t}var r=this;r.open=!1,r.active=!1,r.searchS=!0,r.selectedProto="请选择",r.searchTime="h",r.srcIp="",r.dstIp="",r.sTime="",r.eTime="",r.protocol=[{name:"modbus",selected:!1},{name:"opcda",selected:!1},{name:"s7",selected:!1},{name:"dnp3",selected:!1},{name:"iec104",selected:!1},{name:"mms",selected:!1},{name:"profinetio",selected:!1},{name:"goose",selected:!1},{name:"sv",selected:!1},{name:"eniptcp",selected:!1},{name:"enipudp",selected:!1},{name:"enipio",selected:!1},{name:"http",selected:!1},{name:"ftp",selected:!1},{name:"telnet",selected:!1},{name:"pop3",selected:!1},{name:"smtp",selected:!1},{name:"opcua",selected:!1},{name:"pnrtdcp",selected:!1},{name:"snmp",selected:!1}],r.setSelectItem=function(e,t){r.selectedProto="",r.protocol[e]=t,r.protocol.forEach(function(e){var t=e.name;e.selected&&(r.selectedProto?r.selectedProto=r.selectedProto+","+t:r.selectedProto=t)}),r.selectedProto||(r.selectedProto="请选择")},r.activeSearch=function(){r.active=!r.active},r.convertData=function(e,t,n){for(var o=e.data,i=[],l=0;l<o.length;l++){var s=o[l],c=r.geoCoordMap[s.srcPool],d=r.geoCoordMap[s.dstPoolName];c&&d&&i.push({fromName:s.srcPool,toName:s.dstPoolName,coords:[c,d],lineValue:s.srcPool+"->"+s.dstPoolName+":"+e.protocolName+"</br>共"+s.value+"个数据包",lineStyle:{normal:{width:a(s.value,t)}},srcPoolId:s.srcPoolId,dstPoolId:s.dstPoolId,type:"pool",cor:n})}return i};var i;r.defaultMap={type:"FeatureCollection",features:[{type:"Feature",properties:{name:"defaultMap"},geometry:{type:"MultiPolygon",coordinates:[[[[0,.5],[25,.5],[25,9.5],[0,9.5]]]]}}]},echarts.registerMap("defaultMap",r.defaultMap),r.searchTime="h",r.timeChange=function(e){r.searchTime=e},r.saveAsImage=function(){i.dispatchAction({type:"saveAsImage",context:_.find(i._componentsViews,function(e){return e.__id.indexOf("toolbox")>=0})._features.saveAsImage})},r.restore=function(){i.dispatchAction({type:"restore"})},r.goBack=function(){r.searchS=!0,i.clear(),r.search(),i.setOption(r.option)},r.search=function(){o.sysbaseinfo().then(function(o){var a=new Date(o.data||""),l=a.getFullYear(),s=a.getMonth()+1,c=a.getDate(),d=a.getHours(),u=l+"-"+s+"-"+c+" "+d+":00:00",p=new Date(u||""),f=new Date(u||""),m=new Date(p.setHours(p.getHours()+1)).toISOString();m=m.slice(0,m.length-5)+"+00:00";var g;"h"===r.searchTime?g=f:"d"===r.searchTime?g=f.setMinutes(f.getMinutes()-1380,f.getSeconds(),0):"w"===r.searchTime&&(g=f.setMinutes(f.getMinutes()-10080+60,f.getSeconds(),0));var h=new Date(g).toISOString();h=h.slice(0,h.length-5)+"+00:00";var v="";if("请选择"===r.selectedProto)r.selectedProto="";else{var y=r.selectedProto.split(",");y.forEach(function(e,t){v=0===t?v+"'"+e+"'":v+",'"+e+"'"})}r.sTime=h,r.eTime=m,n.get(v,r.srcIp,r.dstIp,h,m).then(function(e){if(!(e.length<1)){var t=e[0],n=e[1],o=e[2],a=e[3].average;r.init_sessionPoolOverviw(t,n,o,a)}}).then(function(){i=echarts.init(document.getElementById("session_poolOverview")),i.setOption(r.option),i.on("click",function(n){"effectScatter"===n.seriesType&&"防火墙外地址池"!==n.name&&"pool"===n.data.type&&(r.searchS=!1,i.clear(),r.showAssetProtocol_pool(n.data.name,n.data.poolId)),"lines"===n.seriesType&&"pool"===n.data.type&&(r.searchS=!1,i.clear(),r.showAssetProtocol_line(n.seriesName,n.data.fromName,n.data.toName,n.data.srcPoolId,n.data.dstPoolId,n.data.cor)),"lines"===n.seriesType&&"asset"===n.data.type&&t.$broadcast("getPoolLinesDetail",r.sTime,r.eTime,n.data.fromName,n.data.toName,n.data.protocolType),"graph"===n.seriesType&&"edge"===n.dataType&&t.$broadcast("getPoolLinesDetail",r.sTime,r.eTime,n.data.source,n.data.target,n.data.protocolName),e.$digest()})})})},r.init_sessionPoolOverviw=function(e,t,n,o){function a(e,t){r.series.push({name:"地址池",type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{scale:2,brushType:"stroke"},symbol:"image://images/network.png",label:{normal:{show:!0,position:"top",formatter:function(e){return e.data.topLable}}},symbolSize:45,itemStyle:{normal:{color:t}},showEffectOn:"emphasis",data:e.map(function(e){return{name:e.poolName,value:r.geoCoordMap[e.poolName].concat(10),lineValue:e.ipRange,topLable:"安全区域："+e.SecAreaName+"\n 地址池："+e.poolName,poolId:e.poolId,type:"pool"}})})}r.geoCoord=e,r.otherCoord=t,r.datas=n,r.color=["#36F7E7","#30FD85","#B1FB32","#FBD632","#FD7630","#FA61D2","#9F77E4","#DFDAAA","#CDECEF","#8BA6E4","#79F6DB","#CC9999","#CC6699","#CC3399","#CC0099","#996699","#669999","#339999","#006699","#0033CC"],r.series=[],r.curveness=.1,r.pool_sourceAngle=1===r.geoCoord.length?0:360/r.geoCoord.length,r.geoCoordMap={},1===r.geoCoord.length?r.geoCoordMap[r.geoCoord[0].poolName]=[0,5.25]:2===r.geoCoord.length?(r.geoCoordMap[r.geoCoord[0].poolName]=[0,5.25],r.geoCoordMap[r.geoCoord[1].poolName]=[20.5,5.25]):r.geoCoord.forEach(function(e,t){var n=t*r.pool_sourceAngle*2*Math.PI/360,o=10.5+11.5*Math.cos(n),a=5+3.5*Math.sin(n);r.geoCoordMap[e.poolName]=[o,a]}),r.otherCoord.length>0&&(r.geoCoordMap[r.otherCoord[0].poolName]=[26,9]),r.legendData=[],r.datas.forEach(function(e,t){var n=e.protocolName;r.legendData.push({name:n}),r.series.push({name:n,type:"lines",zlevel:2,effect:{show:!0,period:10,trailLength:0,symbol:"arrow",symbolSize:6},lineStyle:{normal:{color:r.color[t],opacity:.4,curveness:r.curveness}},data:r.convertData(e,o,r.color[t])}),r.curveness=r.curveness+.05});var i="NA",l=0,s=[];r.geoCoord.forEach(function(e,t){"NA"===i?(i=e.SecAreaName,s.push(e)):i!==e.SecAreaName?(a(s,r.color[l]),s=[],s.push(e),l+=1):s.push(e),t+1===r.geoCoord.length&&a(s,r.color[l])}),r.otherCoord.length>0&&r.series.push({name:r.otherCoord[0].poolName,type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{scale:2,brushType:"stroke"},symbol:"image://images/network1.png",label:{normal:{show:!0,position:"right",formatter:"{b}"}},symbolSize:50,itemStyle:{normal:{color:"#DDDD00"}},showEffectOn:"emphasis",data:r.otherCoord.map(function(e){return{name:e.poolName,value:r.geoCoordMap[e.poolName].concat(10),lineValue:"",type:"pool"}})}),r.option={backgroundColor:"#2a2d36",animationDurationUpdate:1500,animationEasingUpdate:"quinticInOut",title:{text:"地址池协议总览图",subtext:"",left:"center",textStyle:{color:"#fff"}},tooltip:{trigger:"item",formatter:function(e){return""===e.data.lineValue?e.name:e.data.lineValue}},geo:{map:"defaultMap",label:{emphasis:{show:!1}},roam:!0,itemStyle:{normal:{areaColor:"#2a2d36",borderColor:"#2a2d36"},emphasis:{areaColor:"#2a2d36"}}},toolbox:{itemGap:20,itemSize:20,left:30,iconStyle:{normal:{color:"#ccc"},emphasis:{color:"#fff",borderColor:"#DDDDDD"}},feature:{saveAsImage:{show:!1,type:"png",name:"会话协议图",title:"保存为图片",icon:"path://M11.5 7l-4 4-4-4h2.5v-6h3v6zM7.5 11h-7.5v4h15v-4h-7.5zM14 13h-2v-1h2v1z"},restore:{show:!1,icon:"path://M376.35,112.755l16.879-84.86c1.842-9.259-2.076-18.717-9.925-23.961 c-7.85-5.246-18.087-5.246-25.937,0L243.036,80.328c-0.008,0.005-0.016,0.011-0.023,0.017c-0.528,0.355-1.032,0.741-1.528,1.134 c-0.101,0.081-0.213,0.151-0.313,0.233c-0.584,0.481-1.142,0.988-1.676,1.522c-0.163,0.163-0.307,0.345-0.467,0.514\tc-0.359,0.383-0.724,0.762-1.058,1.169c-0.132,0.162-0.247,0.338-0.377,0.504c-0.339,0.434-0.677,0.868-0.983,1.327\tc-0.078,0.115-0.14,0.24-0.216,0.356c-0.338,0.523-0.666,1.053-0.963,1.604c-0.033,0.064-0.058,0.129-0.092,0.193\tc-0.322,0.612-0.622,1.234-0.89,1.877c-0.012,0.031-0.022,0.065-0.034,0.096c-0.275,0.671-0.524,1.355-0.738,2.057\tc-0.02,0.064-0.033,0.129-0.05,0.195c-0.196,0.666-0.372,1.338-0.509,2.028c-0.003,0.011-0.006,0.02-0.008,0.031\tc-0.042,0.213-0.059,0.429-0.096,0.644c-0.089,0.528-0.182,1.055-0.235,1.595c-0.068,0.685-0.096,1.371-0.104,2.056\tc0,0.087-0.012,0.171-0.012,0.26c0,0.003,0,0.005,0,0.006c0,0.778,0.039,1.555,0.118,2.326c0.045,0.478,0.134,0.943,0.21,1.411\tc0.045,0.28,0.073,0.563,0.128,0.843c0.121,0.604,0.28,1.192,0.445,1.777c0.039,0.142,0.067,0.286,0.109,0.426\tc0.188,0.619,0.412,1.225,0.65,1.821c0.042,0.107,0.075,0.219,0.12,0.327c0.251,0.605,0.535,1.192,0.834,1.769\tc0.051,0.1,0.093,0.204,0.146,0.302c0.321,0.598,0.674,1.175,1.041,1.74c0.048,0.072,0.086,0.148,0.132,0.219l0.02,0.03\tc0.022,0.031,0.04,0.062,0.062,0.092l76.313,114.21c4.384,6.562,11.708,10.374,19.405,10.374c1.511,0,3.038-0.148,4.558-0.45\tc9.259-1.842,16.498-9.08,18.339-18.34l10.974-55.171c37.191,31.415,60.857,78.365,60.857,130.748\tc0,94.356-76.764,171.121-171.12,171.121c-94.357,0-171.123-76.765-171.123-171.121c0-62.522,34.094-120.058,88.976-150.156\tc11.305-6.198,15.443-20.386,9.243-31.688c-6.198-11.303-20.382-15.441-31.69-9.243C81.579,141.408,38.199,214.628,38.199,294.201\tc0,120.097,97.707,217.804,217.806,217.804c120.097,0,217.802-97.707,217.802-217.804\tC473.807,218.561,435.044,151.816,376.35,112.755z"}}},legend:{orient:"vertical",x:"left",top:"bottom",textStyle:{color:"#fff"},data:r.legendData},series:r.series}},r.pool_convertData=function(e,t){for(var n=e.data,o=[],a=0;a<n.length;a++){var r=n[a],i=t[r.srcIp],l=t[r.dstIp];i&&l&&o.push({fromName:r.srcIp,toName:r.dstIp,coords:[i,l],lineValue:r.srcIp+"->"+r.dstIp+":"+e.protocolName,type:"asset",protocolType:e.protocolName})}return o},r.showAssetProtocol_pool=function(e,t){var o=[],a=[],l=[],s=[],c=[],d=[],u=[],p=.1;n.getPoolDetails(t,r.sTime,r.eTime).then(function(e){l=e[0],s=e[1],c=e[2],d=e[3],u=e[4];var t={},n=12.5,i=12.5,f=5;l.forEach(function(e,o){var a=3;0!==o&&1!==o||(a=1.5),o%2===0?(n-=a,t[e]=[n,f]):(i+=a,t[e]=[i,f])});var m=10.5,g=10.5,h=9;s.forEach(function(e,n){n%2===0?(h=9,n/2%2===0?0===n?(m+=1.5,t[e]=[m,h]):4===n?(g-=1.5,t[e]=[g,h]):(g-=3,t[e]=[g,h]):(m+=3,t[e]=[m,h])):(h=1,1===n?t[e]=[m,h]:(n-1)/2%2===1?t[e]=[m,h]:t[e]=[g,h])});var v=l.concat(s),y=d.concat(u),I=[];v.forEach(function(e,t){I.push({assetIp:e,assetName:y[t]})}),a.push({name:"设备",type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{scale:0,brushType:"stroke"},symbol:"image:///images/pc-2.png",label:{normal:{show:!0,position:"top",formatter:function(e){return e.data.labelText},textStyle:{color:"#fff"}}},symbolSize:30,showEffectOn:"emphasis",data:I.map(function(e){return{name:e.assetIp,value:t[e.assetIp].concat(10),lineValue:"",type:"asset",labelText:e.assetName+":("+e.assetIp+")"}})}),c.forEach(function(e,n){o.push({name:e.protocolName}),a.push({name:e.protocolName,type:"lines",zlevel:1e3,effect:{show:!0,period:10,trailLength:0,symbol:"arrow",symbolSize:6},lineStyle:{normal:{color:r.color[n],opacity:.4,curveness:p}},data:r.pool_convertData(e,t)}),p+=.05})}).then(function(){var t={backgroundColor:"#2a2d36",animationDurationUpdate:1500,animationEasingUpdate:"quinticInOut",title:{text:e+" 资产设备协议图",subtext:"",left:"center",textStyle:{color:"#fff"}},tooltip:{trigger:"item",formatter:function(e){return""===e.data.lineValue?e.name:e.data.lineValue}},toolbox:{itemGap:30,itemSize:20,left:30,iconStyle:{normal:{color:"#ccc"},emphasis:{color:"#fff",borderColor:"#DDDDDD"}},feature:{saveAsImage:{type:"png",show:!1,name:e+" 资产设备协议图",title:"保存为图片",icon:"path://M11.5 7l-4 4-4-4h2.5v-6h3v6zM7.5 11h-7.5v4h15v-4h-7.5zM14 13h-2v-1h2v1z"},restore:{icon:"path://M376.35,112.755l16.879-84.86c1.842-9.259-2.076-18.717-9.925-23.961 c-7.85-5.246-18.087-5.246-25.937,0L243.036,80.328c-0.008,0.005-0.016,0.011-0.023,0.017c-0.528,0.355-1.032,0.741-1.528,1.134 c-0.101,0.081-0.213,0.151-0.313,0.233c-0.584,0.481-1.142,0.988-1.676,1.522c-0.163,0.163-0.307,0.345-0.467,0.514\tc-0.359,0.383-0.724,0.762-1.058,1.169c-0.132,0.162-0.247,0.338-0.377,0.504c-0.339,0.434-0.677,0.868-0.983,1.327\tc-0.078,0.115-0.14,0.24-0.216,0.356c-0.338,0.523-0.666,1.053-0.963,1.604c-0.033,0.064-0.058,0.129-0.092,0.193\tc-0.322,0.612-0.622,1.234-0.89,1.877c-0.012,0.031-0.022,0.065-0.034,0.096c-0.275,0.671-0.524,1.355-0.738,2.057\tc-0.02,0.064-0.033,0.129-0.05,0.195c-0.196,0.666-0.372,1.338-0.509,2.028c-0.003,0.011-0.006,0.02-0.008,0.031\tc-0.042,0.213-0.059,0.429-0.096,0.644c-0.089,0.528-0.182,1.055-0.235,1.595c-0.068,0.685-0.096,1.371-0.104,2.056\tc0,0.087-0.012,0.171-0.012,0.26c0,0.003,0,0.005,0,0.006c0,0.778,0.039,1.555,0.118,2.326c0.045,0.478,0.134,0.943,0.21,1.411\tc0.045,0.28,0.073,0.563,0.128,0.843c0.121,0.604,0.28,1.192,0.445,1.777c0.039,0.142,0.067,0.286,0.109,0.426\tc0.188,0.619,0.412,1.225,0.65,1.821c0.042,0.107,0.075,0.219,0.12,0.327c0.251,0.605,0.535,1.192,0.834,1.769\tc0.051,0.1,0.093,0.204,0.146,0.302c0.321,0.598,0.674,1.175,1.041,1.74c0.048,0.072,0.086,0.148,0.132,0.219l0.02,0.03\tc0.022,0.031,0.04,0.062,0.062,0.092l76.313,114.21c4.384,6.562,11.708,10.374,19.405,10.374c1.511,0,3.038-0.148,4.558-0.45\tc9.259-1.842,16.498-9.08,18.339-18.34l10.974-55.171c37.191,31.415,60.857,78.365,60.857,130.748\tc0,94.356-76.764,171.121-171.12,171.121c-94.357,0-171.123-76.765-171.123-171.121c0-62.522,34.094-120.058,88.976-150.156\tc11.305-6.198,15.443-20.386,9.243-31.688c-6.198-11.303-20.382-15.441-31.69-9.243C81.579,141.408,38.199,214.628,38.199,294.201\tc0,120.097,97.707,217.804,217.806,217.804c120.097,0,217.802-97.707,217.802-217.804\tC473.807,218.561,435.044,151.816,376.35,112.755z",show:!1}}},geo:{map:"defaultMap",label:{emphasis:{show:!1}},roam:!0,itemStyle:{normal:{areaColor:"#2a2d36",borderColor:"#2a2d36"},emphasis:{areaColor:"#2a2d36"}}},legend:{orient:"vertical",x:"left",top:"bottom",textStyle:{color:"#fff"},data:o},series:a};i.setOption(t)})},r.showAssetProtocol_line=function(e,t,o,a,l,s){n.getLineDetails(e,a,l,r.sTime,r.eTime).then(function(n){var a=[],r=1===n[0].length?0:360/n[0].length,l=i.getWidth()/4,c=i.getHeight()/4,d=Math.min(l,c);n[0].forEach(function(e,t){var o=t*r*2*Math.PI/360,i=l+d*Math.cos(o),s=c+d*Math.sin(o),u={name:e,x:i,y:s,symbol:"image:///images/pc-2.png",symbolSize:30,label:{normal:{position:"bottom",show:!0,formatter:function(){return n[3][t]+":("+e+")"},textStyle:{color:"#fff"}}}};a.push(u)});var u=1===n[1].length?0:360/n[1].length;n[1].forEach(function(e,t){var o=t*u*2*Math.PI/360,r=3*l+d*Math.cos(o),i=c+d*Math.sin(o),s={name:e,x:r,y:i,symbol:"image:///images/pc-2.png",symbolSize:30,label:{normal:{position:"bottom",show:!0,formatter:function(){return n[4][t]+":("+e+")"},textStyle:{color:"#fff"}}}};a.push(s)}),a.push({name:t,x:l,y:c,symbol:"image:///images/center.png",symbolSize:1,label:{normal:{position:"bottom",show:!0,textStyle:{fontSize:20,fontWeight:"bold",color:"#fff"}}}}),a.push({name:o,x:3*l,y:c,symbol:"image:///images/center.png",symbolSize:1,label:{normal:{position:"bottom",show:!0,textStyle:{fontSize:20,fontWeight:"bold",color:"#fff"}}}});var p=[];n[2].forEach(function(e){var t=[];e.data.forEach(function(n){var o={source:n.srcIp,target:n.dstIp,symbolSize:[2,10],protocolName:e.protocolName,label:{normal:{show:!0,formatter:function(t){return t.name+":"+e.protocolName}}},lineStyle:{normal:{width:2,curveness:.2}}};t.push(o)}),p.push({name:e.protocolName,type:"graph",layout:"none",roam:!0,hoverAnimation:!1,edgeSymbol:["circle","arrow"],edgeSymbolSize:[10,10],edgeLabel:{normal:{textStyle:{fontSize:10,color:s}}},data:a,links:t,lineStyle:{normal:{opacity:.9,width:1,color:s}}})});var f={backgroundColor:"#2a2d36",animationDurationUpdate:1500,animationEasingUpdate:"circularInOut",title:{text:t+"<>"+o+"（"+e+"） 协议图",subtext:"",left:"center",textStyle:{color:"#fff"}},tooltip:{trigger:"item",formatter:function(e){if(e.name)return e.name}},toolbox:{itemGap:30,itemSize:20,left:30,iconStyle:{normal:{color:"#ccc"},emphasis:{color:"#fff",borderColor:"#DDDDDD"}},feature:{saveAsImage:{type:"png",show:!1,name:t+"<>"+o+"（"+e+"） 协议图",title:"保存为图片",icon:"path://M11.5 7l-4 4-4-4h2.5v-6h3v6zM7.5 11h-7.5v4h15v-4h-7.5zM14 13h-2v-1h2v1z"},restore:{icon:"path://M376.35,112.755l16.879-84.86c1.842-9.259-2.076-18.717-9.925-23.961 c-7.85-5.246-18.087-5.246-25.937,0L243.036,80.328c-0.008,0.005-0.016,0.011-0.023,0.017c-0.528,0.355-1.032,0.741-1.528,1.134 c-0.101,0.081-0.213,0.151-0.313,0.233c-0.584,0.481-1.142,0.988-1.676,1.522c-0.163,0.163-0.307,0.345-0.467,0.514\tc-0.359,0.383-0.724,0.762-1.058,1.169c-0.132,0.162-0.247,0.338-0.377,0.504c-0.339,0.434-0.677,0.868-0.983,1.327\tc-0.078,0.115-0.14,0.24-0.216,0.356c-0.338,0.523-0.666,1.053-0.963,1.604c-0.033,0.064-0.058,0.129-0.092,0.193\tc-0.322,0.612-0.622,1.234-0.89,1.877c-0.012,0.031-0.022,0.065-0.034,0.096c-0.275,0.671-0.524,1.355-0.738,2.057\tc-0.02,0.064-0.033,0.129-0.05,0.195c-0.196,0.666-0.372,1.338-0.509,2.028c-0.003,0.011-0.006,0.02-0.008,0.031\tc-0.042,0.213-0.059,0.429-0.096,0.644c-0.089,0.528-0.182,1.055-0.235,1.595c-0.068,0.685-0.096,1.371-0.104,2.056\tc0,0.087-0.012,0.171-0.012,0.26c0,0.003,0,0.005,0,0.006c0,0.778,0.039,1.555,0.118,2.326c0.045,0.478,0.134,0.943,0.21,1.411\tc0.045,0.28,0.073,0.563,0.128,0.843c0.121,0.604,0.28,1.192,0.445,1.777c0.039,0.142,0.067,0.286,0.109,0.426\tc0.188,0.619,0.412,1.225,0.65,1.821c0.042,0.107,0.075,0.219,0.12,0.327c0.251,0.605,0.535,1.192,0.834,1.769\tc0.051,0.1,0.093,0.204,0.146,0.302c0.321,0.598,0.674,1.175,1.041,1.74c0.048,0.072,0.086,0.148,0.132,0.219l0.02,0.03\tc0.022,0.031,0.04,0.062,0.062,0.092l76.313,114.21c4.384,6.562,11.708,10.374,19.405,10.374c1.511,0,3.038-0.148,4.558-0.45\tc9.259-1.842,16.498-9.08,18.339-18.34l10.974-55.171c37.191,31.415,60.857,78.365,60.857,130.748\tc0,94.356-76.764,171.121-171.12,171.121c-94.357,0-171.123-76.765-171.123-171.121c0-62.522,34.094-120.058,88.976-150.156\tc11.305-6.198,15.443-20.386,9.243-31.688c-6.198-11.303-20.382-15.441-31.69-9.243C81.579,141.408,38.199,214.628,38.199,294.201\tc0,120.097,97.707,217.804,217.806,217.804c120.097,0,217.802-97.707,217.802-217.804\tC473.807,218.561,435.044,151.816,376.35,112.755z"}}},series:p};i.setOption(f)})}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/session/protocol/sessionPooloverview.6a588986.html",controller:["$scope","$rootScope","ProtocolModel","apiInfo",e],controllerAs:"sessionPoolOverviewCtrl"};return t}angular.module("southWest.session.protocol").directive("sessionPoolOverview",e)}(),function(){"use strict";function e(e){e.state("session",{abstract:!0,parent:"dashboard",url:"/session",controller:"SessionCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html"})}e.$inject=["$stateProvider"],angular.module("southWest.session").config(e)}(),function(){"use strict";function e(e,t,n){var o=this;o.prefixId="session",o.subMenus=n.rootMenu.getChild("SESSION"),o.expanded="true"===localStorage.getItem("session:navbar:expanded"),o.toggleExpand=function(){o.expanded=!o.expanded,localStorage.setItem("session:navbar:expanded",o.expanded)},o.isActive=function(e){return t.current.name.indexOf(e.getState())>-1}}e.$inject=["$scope","$state","$rootScope"],angular.module("southWest.session").controller("SessionCtrl",e)}(),function(){"use strict";function e(e){e.state("session.state",{url:"/state",controller:"SessionStateCtrl as sessionState",templateUrl:"templates/session/state/index.d6165641.html"})}e.$inject=["$stateProvider"],angular.module("southWest.session.state").config(e)}(),function(){"use strict";function e(e,n){function o(e){var t="image:///images/"+e+".png";return n.revManifest&&_.keys(n.revManifest).some(function(e){if(t.indexOf(e)>0)return t=t.replace(e,n.revManifest[e]),!0}),t}var a=this;a.sessionsState=[];var r;a.initSessionState=function(){e.sessionStateLoaded=function(e){a.sessionsState=e,a.loadSessionState(e)};var t={tooltip:{formatter:function(e){return"edge"===e.dataType?e.data.source+"-->"+e.data.target+": "+e.data.services.join(", "):e.name}},animationDurationUpdate:1500,animationEasingUpdate:"quinticInOut",series:[{type:"graph",layout:"none",symbolSize:50,label:{normal:{show:!0,position:"bottom",textStyle:{color:"#FFFFFF",fontWeight:"bold"}}},edgeSymbol:["circle","arrow"],edgeSymbolSize:[2,10],edgeLabel:{normal:{show:!0,textStyle:{fontSize:11}},emphasis:{textStyle:{fontSize:14,fontWeight:"bold"}}}}]};r=echarts.init(document.getElementById("session_graph")),r.setOption(t),r.on("click",function(e){if(e&&"node"===e.dataType){var t=[];t=a.sessionName===e.data.name?a.sessionsState:a.sessionsState.filter(function(t){return e.data.name===t.sourceName||e.data.name===t.targetName}),t.length>0&&a.loadSessionState(t,e.data.name)}})},a.loadSessionState=function(e,n){var i=r.getOption();if(!e||0===e.length)return void(i&&null!==i&&(i.series[0].data=[],i.series[0].links=[],r.setOption(i)));n=n||"",e=e||[];var l=new t,s=new t;e.forEach(function(e){l.contains(e.sourceName)||l.put(e.sourceName,e),s.contains(e.targetName)||s.put(e.targetName,e)});var c=l.length()<=1||s.length()<=1,d=c?"none":"circular";if(i&&null!==i&&e){var u=i.series[0];u.layout=d;var p=r.getWidth()/2,f=r.getHeight()/2,m=Math.min(p,f),g=function(e,t,n,a){a=void 0===a?m:a;var r=p+a*Math.cos(t),i=f+a*Math.sin(t);if(n){if(I.indexOf(e.sourceName)<0)return v.push({name:e.sourceName,x:r,y:i,symbol:o(e.sourceType)}),I.push(e.sourceName),!0}else if(I.indexOf(e.targetName)<0)return v.push({name:e.targetName,x:r,y:i,symbol:o(e.targetType)}),I.push(e.targetName),!0;return!1},h=function(e,t){var n=y.filter(function(t){return t.source===e.sourceName&&t.target===e.targetName});n.length<1?y.push({source:e.sourceName,target:e.targetName,services:[e.sessionProtocol],lineStyle:{normal:{opacity:.9,type:"dotted",color:t?"#aa474f":"#21aa28",width:1}},label:{normal:{formatter:function(e){return e.data.services.join(", ")}},emphasis:{formatter:function(e){return e.data.services.join(", ")}}}}):n.forEach(function(t){t.services.indexOf(e.sessionProtocol)<0&&t.services.push(e.sessionProtocol)})},v=[],y=[],I=[];if(c){var D=1===l.length(),T=D?l.getAt(0):s.getAt(0);D&&l.remove(T.sourceName),!D&&s.remove(T.targetName),g(T,0,D,0),h(T,D);var b=l.length()<=1?0:180/(l.length()-1);l.forEach(function(e,t){var n=2*(270-t*b)*Math.PI/360;g(e,n,!0),h(e,e.sourceName===T.sourceName)});var S=1===s.length()?90:180/(s.length()-1+2);s.forEach(function(e,t){var n=2*(-90+(t+1)*S)*Math.PI/360;g(e,n,!1),h(e,e.sourceName===T.sourceName)})}else{var P=e.length<=1?0:360/l.intersect(s).length(),A=0;e.forEach(function(e){var t=A*P*Math.PI/360;g(e,t,!0)&&A++,g(e,t,!1)&&A++,h(e)})}a.sessionName=n,u.data=v,u.links=y,r.setOption(i)}}}function t(){var e=[];this.length=function(){return e.length},this.contains=function(t){return e.indexOf(t)>-1},this.put=function(t,n){this.contains(t)||e.push(t),this[t]=n},this.remove=function(t){var n=e.indexOf(t);n>=0&&(e.splice(n,1),delete this[t])},this.getAt=function(t){if(t>=0&&t<e.length){var n=e[t];return this[n]}},this.forEachKey=function(t){e.forEach(function(e,n){t(e,n)})},this.forEach=function(t){var n=this;e.forEach(function(e,o){n.contains(e)&&t(n[e],o)})},this.intersect=function(e){if(e instanceof t){var n=new t;return this.forEachKey(function(t){n.contains(t)||n.put(t,e[t])}),e.forEachKey(function(t){n.contains(t)||n.put(t,e[t])}),n}}}e.$inject=["$scope","$rootScope"],angular.module("southWest.session.state").controller("SessionStateCtrl",e)}(),function(){"use strict";function e(e){function t(t,n,o,a){function r(){var e=[{value:"NEW",text:"NEW"},{value:"ESTABED",text:"ESTABED"},{value:"CLOSED",text:"CLOSED"},{value:"TCP_NONE",text:"TCP_NONE"},{value:"TCP_LISTEN",text:"TCP_LISTEN"},{value:"TCP_SYN_SENT",text:"TCP_SYN_SENT"},{value:"TCP_SYN_RECV",text:"TCP_SYN_RECV"},{value:"TCP_ESTABLISHED",text:"TCP_ESTABLISHED"},{value:"TCP_FIN_WAIT1",text:"TCP_FIN_WAIT1"},{value:"TCP_FIN_WAIT2",text:"TCP_FIN_WAIT2"},{value:"TCP_TIME_WAIT",text:"TCP_TIME_WAIT"},{value:"TCP_LAST_ACK",text:"TCP_LAST_ACK"},{value:"TCP_CLOSE_WAIT",text:"TCP_CLOSE_WAIT"},{value:"TCP_CLOSING",text:"TCP_CLOSING"},{value:"TCP_CLOSED",text:"TCP_CLOSED"}];angular.forEach(e,function(e){t.connStateList.push(e)})}function i(){e.getStrategyList().then(function(e){e&&angular.isArray(e)&&e.forEach(function(e){t.strategyList.push({value:e.id,text:e.name})})})}function l(n){return t.params=n,e.getAll(n,t.dtable).then(function(e){return t.sessionStateLoaded(e),e})}function s(){return e.getCount(t.dtable)}function c(e){return l(e)}t.strategyList=[{value:"-1",text:""}],t.connStateList=[{value:"-1",text:""}],a.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:l,getCount:s,search:c,fields:["sourceIp","targetIp","serviceApp","connectionState","strategyRef"],advancedSearch:"item",advancedSearchOptions:[{name:"sourceIp",display:"源IP",input:"ipAdress",option:!1,value:""},{name:"targetIp",display:"目标IP",input:"ipAdress",option:!1,value:""},{name:"serviceApp",display:"应用名称",input:"string",option:!1,value:""},{name:"connectionState",display:"连接状态",input:"checkbox",option:!0,parser:"string",options:t.connStateList},{name:"strategyRef",display:"策略引用",input:"checkbox",option:!0,parser:"string",options:t.strategyList}]}),a.highAdvancedSearch(),r(),i()}var n={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/session/state/sessionStateTable.9db557e8.html",link:t};return n}e.$inject=["SessionStateModel"],angular.module("southWest.session.state").directive("sessionStateTable",e)}(),function(){"use strict";function e(e){e.state("setting.basic",{url:"/basic",controller:"BasicCtrl as basic",templateUrl:"templates/setting/basic/index.2d246cfd.html"})}e.$inject=["$stateProvider"],angular.module("southWest.setting.basic").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m,g,h){function v(){p.getStrategyInfo().then(function(e){var t=e.data;t.forEach(function(e){"REMOTE_ACCESS_PROTOCOL"===e.strategyInfo.strategyCode&&y(e)})})}function y(e){N.remoteProtocol.setting.strategyInfo=e.strategyInfo,N.remoteProtocol.setting.strategyRules=e.strategyRules,N.remoteProtocol.setting.strategyActions=e.strategyActions,N.remoteProtocol.setting.strategyRuleSetId=N.remoteProtocol.setting.strategyInfo.strategyRuleSetId,I(N.remoteProtocol.setting.strategyRules)}function I(e){for(var t=0;t<e.length;t++)"SSH"===e[t].strategyRuleName?(N.remoteProtocol.setting.SSHDisabled=e[t].disabled,N.remoteProtocol.setting.SSHPort=e[t].ruleData):"https"===e[t].strategyRuleName&&(N.remoteProtocol.setting.httpsDisabled=e[t].disabled,N.remoteProtocol.setting.httpsPort=e[t].ruleData)}function D(e,o){return t.protocolPortOccupied(o).then(function(t){return""===t.data.service||t.data.service.indexOf(e)!==-1||(n.addAlert({type:"danger",content:"端口："+o+"已被其他服务占用"}),!1)},function(e){return n.addAlert({type:"danger",content:e.data}),!1})}function T(){u.all([p.getStrategyInfo(),p.getJobStrategyInfo("LOG_DELETION"),t.getMWNetwork()]).then(function(e){var t=e[0].data;if(t.forEach(function(e){if("MAX_LOGIN_TRY_MANAGEMENT"===e.strategyInfo.strategyCode)N.maxLoginTimesStrategy=e;else if("LOGIN_LOCKING_TIME"===e.strategyInfo.strategyCode)N.loginLockingTimeStrategy=e;else if("TIMEOUT_MANAGEMENT"===e.strategyInfo.strategyCode)N.timeoutStrategy=e;else if("IP_LOGIN_MANAGEMENT"===e.strategyInfo.strategyCode)S(e);else if("LOG_DELETION_MANAGEMENT"===e.strategyInfo.strategyCode)N.logDeletionManagement=e,N.logDeletionManagementTmp=e.strategyRules[0].ruleData;else if("LOG_DELETION_TIME"===e.strategyInfo.strategyCode){N.logDeletionTime=e;var t=e.strategyRules[0].ruleData.split(":"),n=new Date;n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(t[2]),n.setMilliseconds(0),N.logDeletionTimeTmp=n}}),e[1].data){N.logDeletionManagement=e[1].data,N.logDeletionManagementTmp=e[1].data.schedulingJob.jobData;var n=moment.utc();n.set("second",e[1].data.schedulingJobMeta[0].second),n.set("minute",e[1].data.schedulingJobMeta[0].minute),n.set("hour",e[1].data.schedulingJobMeta[0].hour),N.logDeletionTimeTmp=new Date(moment(n.format()).format())}e[2]&&e[2].data&&(N.mwIp=e[2].data.mwIp)})}function b(){return p.getRemoteIp().then(function(e){S(e.data),N.ipDataToRemove=[]})}function S(e){N.remoteIpData.setting.strategyInfo=e.strategyInfo,N.remoteIpData.setting.strategyRules=e.strategyRules,N.remoteIpData.setting.strategyActions=e.strategyActions,N.remoteIpData.setting.strategyRuleSetId=N.remoteIpData.setting.strategyInfo.strategyRuleSetId,
P(N.remoteIpData.setting.strategyRules)}function P(e){N.remoteIpsSource=e,N.remoteIps=angular.copy(N.remoteIpsSource);for(var t=0;t<N.remoteIps.length;t++){var n=N.remoteIps[t];n.strategyRuleName||"0.0.0.0/0"!==n.ruleData||(n.strategyRuleName="允许所有IP地址访问"),n.errors=!1}N.validIp=!0,N.remoteIpsEnable=1!==N.remoteIps.length||"0.0.0.0/0"!==N.remoteIps[0].ruleData}function A(){for(var e=0;e<N.remoteIps.length;e++){var t=N.remoteIps[e];if(t.errors)return void(N.validIp=!1)}N.validIp=!0}function C(e){var t=e.split(".");return(Number(t[0])<<24|Number(t[1])<<16|Number(t[2])<<8|Number(t[3])<<0)>>>0}function k(e){var t=e||{};t.$filter=R,f.getConfBackUpInfos(t).then(function(e){N.backupInfos=e})}function w(){for(var e=N.syslog.setting.syslogs.length,t=0;t<e;t++)for(var n=N.syslog.setting.syslogs[t],o=t+1;o<e;o++){var a=N.syslog.setting.syslogs[o];if(!a.errors&&n.syslogIp+n.syslogPort+n.syslogProtocol===a.syslogIp+a.syslogPort+a.syslogProtocol)return N.reduplicateSyslogs=!0,void(N.validSyslog=!1)}N.reduplicateSyslogs=!1}function E(){for(var e=N.syslog.setting.syslogs.length,t=0;t<e;t++){var n=N.syslog.setting.syslogs[t];if(n.errors)return void(N.validSyslog=!1)}N.validSyslog=!0}var N=this;N.SettingType={WMODE:"0",TIME:"1",SAFTY:"2",HOST:"3",BAK:"4",LOG:"5",RESET:"6"},N.editMode={workingModeSetting:!1,timeSync:!1,security:!1,ipaddress:!1,backup:!1,syslogStorage:!1,scheduleDelete:!1,login:!1},t.getBasicSetting().then(function(e){N.initWorkingModeSetting(e),N.initTimeSync(e),N.initSyslogStorage(e)}),N.initWorkingModeSetting=function(e){var t=e.data.workingModeSetting;t&&(N.modeType=t.modeType,N.enableSwitch=!!t.enableSwitch&&t.enableSwitch,N.switchTime=t.switchTime?new Date(t.switchTime):"",N.switchModeType=t.switchModeType)},N.initTimeSync=function(e){var t=e.data.timeSync;t&&(N.ntpIp=t.ntpIp?t.ntpIp:"",N.activateNtp=t.activateNtp&&t.activateNtp?"1":"0",N.setActivateNtp=!!t.activateNtp&&t.activateNtp)},N.ModeTypes={TEST:0,NORMAL:1,ALL:2},N.modeTypeOptions=[{value:N.ModeTypes.TEST,text:"测试模式"},{value:N.ModeTypes.NORMAL,text:"正常模式"},{value:N.ModeTypes.ALL,text:"全通模式"}],a.$watch("basic.switchModeType",function(e){N.switchMode=_.find(N.modeTypeOptions,{value:e})}),N.filterTestMode=function(e){return e.value>N.ModeTypes.TEST},N.validSwitchTime=!0,N.validateSwitchTime=function(){N.validSwitchTime=N.switchTime.getTime()>(new Date).getTime()},N.clickEnableSwitch=function(){N.enableSwitch&&N.validateSwitchTime()},N.clickModeType=function(){N.modeType!==N.ModeTypes.TEST&&(N.enableSwitch=!1,N.validSwitchTime=!0)},N.editWorkingMode=function(){N.editMode.workingModeSetting=!N.editMode.workingModeSetting},N.changeWorkingMode=function(){var e={modeType:N.modeType,enableSwitch:N.enableSwitch,switchTime:moment(N.switchTime).utc().format("YYYY-MM-DD HH:mm:ss"),switchModeType:N.switchModeType};N.modeType!==N.ModeTypes.TEST&&(e.enableSwitch="",e.switchTime="",e.switchModeType="");var o=u.defer();n.timeoutPromise=o.promise,t.setWorkingModeSetting(e).then(function(){o.resolve("success"),n.addAlert({type:"success",content:"工作模式下发成功"}),N.editMode.workingModeSetting=!1},function(e){o.resolve("fail"),n.addAlert({type:"danger",content:e.data.reason?"工作模式下发失败："+e.data.reason:e.data.rejectReason?"工作模式下发失败："+e.data.rejectReason:"工作模式下发失败"})})},N.cancelWorkingMode=function(){t.getBasicSetting().then(function(e){N.initWorkingModeSetting(e)}),N.editMode.workingModeSetting=!N.editMode.workingModeSetting},N.validSystemTime=!1,N.systemDateInput="",N.systemTimeInput="",N.datePickerCtrl={},N.timePickerCtrl={},N.redirectWaitTime=5,N.loadSystemTime=r(function(){g.getTime().then(function(e){N.serverTime=new Date(e)})},1e3),N.validateSystemTime=function(){N.validSystemTime=!1,"object"==typeof N.systemTimeInput&&"object"==typeof N.systemDateInput&&(N.validSystemTime=!0)},N.validateNtpIP=function(e){N.validNtpIP=e&&!l.validateIp(e)&&"0.0.0.0"!==e&&"255.255.255.255"!==e},N.getInputDateTime=function(){var e=N.systemDateInput?N.systemDateInput:new Date(N.serverTime.getTime());return N.systemTimeInput?(e.setHours(N.systemTimeInput.getHours()),e.setMinutes(N.systemTimeInput.getMinutes()),e.setSeconds(N.systemTimeInput.getSeconds())):(e.setHours(N.serverTime.getHours()),e.setMinutes(N.serverTime.getMinutes()),e.setSeconds(N.serverTime.getSeconds())),e=e.toISOString().substring(0,19)+"Z"},N.editTimeSync=function(){N.validSystemTime=!1,N.setActivateNtp="1"===N.activateNtp,N.editMode.timeSync=!N.editMode.timeSync,N.ntpIpEnter=N.ntpIp,N.validateNtpIP(N.ntpIpEnter)},N.changeTimeSync=function(){var o=e.open({templateUrl:"templates/setting/basic/systemTimeSetModal.4793edd0.html",size:"sm",controller:["$scope","$modalInstance",function(e,t){e.cancel=function(){t.close(!1)},e.confirm=function(){t.close(!0)}}]});o.result.then(function(e){if(e){var o=u.defer();if(n.timeoutPromise=o.promise,N.setActivateNtp)t.updateNtpSync(N.ntpIpEnter,N.setActivateNtp).then(function(e){e&&e.code?(o.resolve("success"),c(function(){window.location.reload()},200)):(o.resolve("fail"),n.addAlert({type:"danger",content:"NTP服务器IP无效！"}))},function(e){o.resolve("fail"),n.addAlert({type:"danger",content:e.data.error?e.data.error:"NTP时钟设置失败，请稍后重试！"})});else{var a=N.getInputDateTime();a&&t.setSystemTime(a).then(function(){c(function(){o.resolve("success"),window.location.reload()},2e3)},function(){o.resolve("fail"),n.addAlert({type:"danger",content:"时钟同步设置失败！"})})}}})},N.cancelTimeSync=function(){N.setActivateNtp="1"===N.activateNtp,N.datePickerCtrl.clearDate(),N.timePickerCtrl.clearDate(),N.systemDateInput="",N.systemTimeInput="",N.editMode.timeSync=!N.editMode.timeSync},N.isShowDisconnectModal=!1,N.showDisconnectModal=function(){function t(e,t){N.hideDisconnectModal=function(){N.isShowDisconnectModal=!1,t.close("done")}}t.$inject=["$scope","$modalInstance"],N.isShowDisconnectModal=!0,e.open({templateUrl:"disconnectModal.html",controller:t,size:"sm",backdrop:"static",keyboard:!1})},N.redirectToMainPage=function(){N.isShowDisconnectModal=!0,N.showDisconnectModal(),c(function(){i.sysbaseinfo().then(function(e){var t=new Date(e.data);isNaN(t.getDate())||isNaN(t.getTime())?(N.isShowDisconnectModal||N.showDisconnectModal(),N.redirectToMainPage()):(N.isShowDisconnectModal=!1,h.path("/"),s.location.reload())},function(){N.isShowDisconnectModal||N.showDisconnectModal(),N.redirectToMainPage()})},5e3)},v(),N.remoteProtocol={setting:{}},N.validSSHPort=!1,N.validHttpsPort=!1,N.editSecurity=function(){N.editMode.security=!N.editMode.security,N.validateSSHPort(N.remoteProtocol.setting.SSHPort),N.validateHttpsPort(N.remoteProtocol.setting.httpsPort)};var M=N.security={};N.changeSecurity=function(){function t(e,t,n){t.data=e,t.cancel=function(){n.dismiss("cancel")},t.done=function(){M.changeRemoteProtocol(),n.close("done")}}if(t.$inject=["data","$scope","$modalInstance"],(!N.remoteProtocol.setting.SSHDisabled&&N.validSSHPort||N.remoteProtocol.setting.SSHDisabled)&&(!N.remoteProtocol.setting.httpsDisabled&&N.validHttpsPort||N.remoteProtocol.setting.httpsDisabled)&&"none"===$("#error_span_timeout").css("display")&&"none"===$("#error_span_loginTry").css("display")&&"none"===$("#error_span_loginLockingTime").css("display"))if(N.remoteProtocol.setting.SSHDisabled||N.remoteProtocol.setting.httpsDisabled){var n=e.open({templateUrl:"templates/setting/basic/remote-protocol-panel.403373fd.html",size:"sm",controller:t,resolve:{data:function(){return[N.remoteProtocol.setting.SSHDisabled,N.remoteProtocol.setting.httpsDisabled]}}});n.result.then(function(e){},function(){})}else M.changeRemoteProtocol()},M.changeRemoteProtocol=function(){function e(){var e=[];return N.remoteProtocol.setting.SSHDisabled||e.push(D("sshd",N.remoteProtocol.setting.SSHPort)),N.remoteProtocol.setting.httpsDisabled||e.push(D("nginx",N.remoteProtocol.setting.httpsPort)),u.all(e).then(function(e){return _.every(e,function(e){return e===!0})})}e().then(function(e){if(e){for(var o=0;o<N.remoteProtocol.setting.strategyRules.length;o++)"SSH"===N.remoteProtocol.setting.strategyRules[o].strategyRuleName?(N.remoteProtocol.setting.strategyRules[o].ruleData=N.remoteProtocol.setting.SSHPort,N.remoteProtocol.setting.strategyRules[o].disabled=N.remoteProtocol.setting.SSHDisabled):"https"===N.remoteProtocol.setting.strategyRules[o].strategyRuleName&&(N.remoteProtocol.setting.strategyRules[o].ruleData=N.remoteProtocol.setting.httpsPort,N.remoteProtocol.setting.strategyRules[o].disabled=N.remoteProtocol.setting.httpsDisabled);var a=u.defer();n.timeoutPromise=a.promise,t.updateRemoteProtocol(N.remoteProtocol.setting.strategyRules).then(function(){a.resolve("success"),N.remoteProtocol.setting.httpsDisabled?(n.addAlert({type:"success",content:"安全管理配置成功，"+N.redirectWaitTime+"秒后系统将无法通过Web控制页面访问。。。"}),c(function(){N.redirectToMainPage()},1e3*N.redirectWaitTime)):(n.addAlert({type:"success",content:"安全管理配置成功，稍后请重新登录系统。"}),t.restartNginx(),c(function(){window.location.href="https://"+window.location.hostname+":"+N.remoteProtocol.setting.httpsPort},2e3)),N.editMode.security=!1},function(e){a.resolve("fail"),n.addAlert({type:"danger",content:"配置失败：设定授权远程访问服务出错！"})})}})},N.cancelSecurity=function(){v(),N.editMode.security=!N.editMode.security},N.validateSSHPort=function(e){N.validSSHPort=e&&!l.validatePort(e)},N.validateHttpsPort=function(e){N.validHttpsPort=e&&!l.validatePort(e)},T(),N.editLogin=function(){N.editMode.login=!N.editMode.login},N.changeLogin=function(){function e(){var e,t,o=!0;for(e=0;e<N.remoteIps.length;e++)t=N.remoteIps[e],"0.0.0.0/0"===t.ruleData&&1!==N.remoteIps.length&&(n.addAlert({type:"danger",content:"设置全网段(0.0.0.0/0)可访问时，不能添加其他访问IP规则"}),o=!1);return u.resolve(o)}e().then(function(e){e&&u.all([p.updateStrategyInfo(N.maxLoginTimesStrategy.strategyRules[0]),p.updateStrategyInfo(N.loginLockingTimeStrategy.strategyRules[0]),p.updateStrategyInfo(N.timeoutStrategy.strategyRules[0]),N.confirmRemoteIps()]).then(function(){n.addAlert({type:"success",content:"登陆管理配置成功"}),T(),N.editLogin()},function(e){n.addAlert({type:"danger",content:"登陆管理配置失败"})})})},N.cancelLogin=function(){T(),b(),N.editMode.login=!N.editMode.login},N.login={},N.login.maxRemoteIpNo=5,N.remoteIpData={setting:{}},N.ipDataToRemove=[],N.addRemoteIp=function(){N.remoteIps.length<N.login.maxRemoteIpNo?(N.remoteIps.unshift({ruleData:"",strategyRuleName:"",errors:!0}),N.validIp=!1):n.addAlert({type:"danger",content:"最多只能设置"+N.login.maxRemoteIpNo+"个远程地址"})},N.removeRemoteIp=function(e,t){return void 0===t?(N.remoteIps.splice(e,1),void A()):(N.ipDataToRemove.push(t),void N.remoteIps.splice(e,1))},N.refreshRemoteIp=function(){b()},N.checkIp=function(e){"0.0.0.0"===e.ruleData||"0.0.0.0/0"===e.ruleData?(N.validIp=!0,e.isMwIp=!1):e.ruleData===N.mwIp||e.ruleData.lastIndexOf("/32")>0&&e.ruleData.split("/")[0]===N.mwIp?(N.validIp=!1,e.isMwIp=!0):(N.validIp=e.ruleData&&e.ruleData.length>0&&!l.validateIpRange(e.ruleData),e.isMwIp=!1),e.errors=!N.validIp,N.validIp&&A()},N.confirmRemoteIps=function(){var e,t,n=[];for(e=0;e<N.remoteIps.length;e++)if(t=N.remoteIps[e],delete t.isMwIp,t.strategyRuleId)delete t.errors,n.push(p.updateRemoteIp(t));else{var o={strategyRuleSetId:N.remoteIpData.setting.strategyInfo.strategyRuleSetId,strategyRuleCode:"EQ",ruleData:t.ruleData,strategyRuleName:t.strategyRuleName,rulePriority:0,disabled:!1,strategyRuleIdentifier:"VALID_IP"};n.push(p.createRemoteIp(o))}for(e=0;e<N.ipDataToRemove.length;e++)n.push(p.deleteRemoteIp(N.ipDataToRemove[e]));u.all(n).then(function(){N.refreshRemoteIp()})},N.editIPAddress=function(){N.editMode.ipaddress=!N.editMode.ipaddress,N.validateHostName(N.hostName),N.validatePlatformIP(N.ipAddress),N.validatePlatformNetMask(N.netMask),N.validatePlatformPreferDns(N.preferDns),N.validatePlatformSpareDns(N.spareDns)},N.changeIPAddress=function(){var e=C(N.ipAddress),o=(C(N.ipAddress)&C(N.netMask))>>>0,a=(o|~C(N.netMask))>>>0;N.validPlatformIP=o<e&&e<a,N.validPlatformIP&&N.validPlatformNetMask&&N.validPlatformGateWay&&N.validPreferDns&&N.validSpareDns&&N.validPlatformHostName?(N.disableEditIPButton=!0,t.updateIPAddress(N.hostName,N.ipAddress,N.netMask,N.gateWay,N.preferDns,N.spareDns).then(function(){N.originalIpAddress=N.ipAddress,N.originalNetMask=N.netMask,N.originalGateWay=N.gateWay,N.originHostName=N.hostName,N.originPreferDns=N.preferDns,N.originSpareDns=N.spareDns,n.addAlert({type:"success",content:"系统会在十秒后自动网址重定向。请稍等。。。"}),setTimeout(function(){s.location.href="https://"+N.ipAddress},1e4)},function(e){N.ipAddress=N.originalIpAddress,N.netMask=N.originalNetMask,N.gateWay=N.originalGateWay,N.hostName=N.originHostName,N.preferDns=N.originPreferDns,N.spareDns=N.originSpareDns,n.addAlert({type:"danger",content:"网络端口配置失败！"})}),N.editIPAddress()):n.addAlert({type:"danger",content:"请确认IP地址与网关在同一有效网段！"})},N.cancelIPAddress=function(){N.editIPAddress(),N.ipAddress=N.originalIpAddress,N.netMask=N.originalNetMask,N.gateWay=N.originalGateWay,N.hostName=N.originHostName,N.preferDns=N.originPreferDns,N.spareDns=N.originSpareDns},N.validatePlatformIP=function(e){N.validPlatformIP=e&&!l.validateIp(e),N.validatePlatformGateWay(N.gateWay)},N.validatePlatformNetMask=function(e){N.validPlatformNetMask=e&&e.match(l.getIPReg())&&!l.validateNetMask(e),N.validatePlatformGateWay(N.gateWay)},N.validateHostName=function(e){N.validPlatformHostName=e&&l.checkProtocolName(N.hostName)},N.validatePlatformPreferDns=function(e){N.validPreferDns=e&&!l.validateIp(e)},N.validatePlatformSpareDns=function(e){N.validSpareDns=void 0===e||e&&!l.validateIp(e)},N.validatePlatformGateWay=function(e){if(N.validPlatformIP&&N.validPlatformNetMask&&e&&!l.validateIp(e)){var t=C(e),n=(C(N.ipAddress)&C(N.netMask))>>>0,o=(n|~C(N.netMask))>>>0;N.validPlatformGateWay=n<t&&t<o}else N.validPlatformGateWay=!1};var R="infoType eq MW";k(),N.editBackup=function(){N.editMode.backup=!N.editMode.backup},N.changeBackup=function(){N.editMode.backup=!N.editMode.backup},N.cancelBackup=function(){N.editMode.backup=!N.editMode.backup},N.backup=function(){},N.restore=function(){},N.reduplicateSyslogs=!1,N.initSyslogStorage=function(e){N.syslog.setting.type=e.data.syslogStorage.syslogStorageType,N.syslog.setting.localEnabled=!1,N.syslog.setting.syslogEnabled=!1,"LOCAL"===N.syslog.setting.type?N.syslog.setting.localEnabled=!0:"SYSLOG"===N.syslog.setting.type?N.syslog.setting.syslogEnabled=!0:"DUAL"===N.syslog.setting.type&&(N.syslog.setting.localEnabled=!0,N.syslog.setting.syslogEnabled=!0),N.syslog.setting.syslogs=e.data.syslogStorage.syslogs},N.syslog={setting:{}},N.syslog.setting.maxNo=3,N.syslog.setting.syslogs=[],N.syslog.setting.syslogToRemove=[],N.editSyslog=function(){N.editMode.syslogStorage=!N.editMode.syslogStorage,E()},N.changeSyslog=function(){N.syslog.setting.type="NONE",N.syslog.setting.localEnabled&&(N.syslog.setting.type="LOCAL"),N.syslog.setting.syslogEnabled&&(N.syslog.setting.type="SYSLOG"),N.syslog.setting.localEnabled&&N.syslog.setting.syslogEnabled&&(N.syslog.setting.type="DUAL");var e={syslogStorageType:N.syslog.setting.type};if(e.syslogs=[],"SYSLOG"===e.syslogStorageType||"DUAL"===e.syslogStorageType)for(var o=0;o<N.syslog.setting.syslogs.length;o++)e.syslogs[o]={},void 0===e.syslogs[o].syslogId&&(e.syslogs[o].syslogId=o+1),e.syslogs[o].seq=o+1,e.syslogs[o].syslogIp=N.syslog.setting.syslogs[o].syslogIp,e.syslogs[o].syslogPort=N.syslog.setting.syslogs[o].syslogPort,e.syslogs[o].syslogProtocol=N.syslog.setting.syslogs[o].syslogProtocol;var a=u.defer();n.basicSettingDeployTaskPromise=a.promise,n.timeoutPromise=t.updateSyslog(e).then(function(){a.resolve("success"),n.addAlert({type:"success",content:"日志存储配置成功"}),N.editSyslog()},function(e){a.resolve("fail"),n.addAlert({type:"danger",content:e.data.reason?"日志存储配置失败："+e.data.reason:e.data.rejectReason?"日志存储配置失败："+e.data.rejectReason:"日志存储配置失败"})})},N.cancelSyslog=function(){t.getBasicSetting().then(function(e){N.initSyslogStorage(e)}),N.editSyslog(),N.reduplicateSyslogs=!1},N.addSyslog=function(){N.syslog.setting.syslogs.length<N.syslog.setting.maxNo?(N.syslog.setting.syslogs.unshift({syslogIp:"",syslogProtocol:"",syslogPort:"",errors:!0}),N.validSyslog=!1,N.validateSyslog(N.syslog.setting.syslogs[0])):n.addAlert({type:"danger",content:"最多只能设置"+N.syslog.setting.maxNo+"个远程地址"})},N.removeSyslog=function(e,t){return void 0===t?(N.syslog.setting.syslogs.splice(e,1),E(),void w()):(N.syslog.setting.syslogToRemove.push(t),N.syslog.setting.syslogs.splice(e,1),void w())},N.validateSyslog=function(e){w(),N.validateSyslogIp(e),N.validateSyslogProtocol(e),N.validateSyslogPort(e),e.errors=e.ipErrors||e.protocolErrors||e.portErrors,N.validSyslog=!e.errors&&!N.reduplicateSyslogs,N.validSyslog&&E()},N.validateSyslogIp=function(e){e.ipErrors=!(e.syslogIp&&e.syslogIp.length>0&&!l.validateIp(e.syslogIp))},N.validateSyslogProtocol=function(e){e.protocolErrors=!e.syslogProtocol||""===e.syslogProtocol||e.syslogProtocol.length<0},N.validateSyslogPort=function(e){e.portErrors=!(e.syslogPort&&!l.validatePort(e.syslogPort))},N.editScheduleDelete=function(){N.editMode.scheduleDelete=!N.editMode.scheduleDelete},N.changeScheduleDelete=function(){N.logDeletionManagement.schedulingJob.jobData=N.logDeletionManagementTmp,N.logDeletionTimeTmp.setHours(N.logDeletionTimeTmp.getHours()+Math.round(N.logDeletionTimeTmp.getTimezoneOffset()/60)),N.logDeletionManagement.schedulingJobMeta[0].hour=N.logDeletionTimeTmp.getHours().toString(),N.logDeletionManagement.schedulingJobMeta[0].minute=N.logDeletionTimeTmp.getMinutes().toString(),N.logDeletionManagement.schedulingJobMeta[0].second=N.logDeletionTimeTmp.getSeconds().toString(),u.all([p.updateStradegyJobBuilder(N.logDeletionManagement)]).then(function(){n.addAlert({type:"success",content:"定期删除信息配置成功"}),T(),N.editScheduleDelete()})},N.cancelScheduleDelete=function(){T(),N.editScheduleDelete()},N.hasPrivilege=function(e,t){var n=m.get("privilege"),o=n.filter(function(t){return t.name===e});return!!(t&&o&&o.length)&&o[0].actionValue>=t},a.$on("$destroy",function(){r.cancel(N.loadSystemTime)})}e.$inject=["$modal","Basic","$rootScope","timerService","$scope","$interval","apiInfo","formatVal","$window","$timeout","Task","$q","System","Device","Enum","serverTime","$location"],angular.module("southWest.setting.basic").controller("BasicCtrl",e)}(),function(){"use strict";function e(e){e.state("setting.reliable",{url:"/reliable",controller:"ReliableCtrl as reliable",templateUrl:"templates/setting/reliable/index.90dee29f.html"})}e.$inject=["$stateProvider"],angular.module("southWest.setting.reliable").config(e)}(),function(){"use strict";function e(e,t,n,o,a){var r=this;r.editMode={hotStandby:!1,bypass:!1},r.loadHotStandby=function(){n.getHotStandby().then(function(e){r.enableHotStandby=e.enableHotStandby,r.localHAIp=e.localHAIp,r.localHAPort=e.localHAPort,r.priority=e.priority,r.remoteHAIp=e.remoteHAIp,r.enableLocalPrimary=e.enableLocalPrimary,r.checkHotStandbySW()}),r.hotStandbyState="运行状态: 运行正常，本地为主设备",n.getHotStandbyState().then(function(e){var t=e.runningState,n=e.mainStandbyState;t?n||(r.hotStandbyState="运行状态: 运行正常，本地为备设备"):r.hotStandbyState="运行状态: 双机热备未启用"})},r.validateIp=function(e,t){var n=e&&!o.validateIp(e)&&"0.0.0.0"!==e&&"255.255.255.255"!==e;"local"===t?r.validLocalHAIp=n:"remote"===t&&(r.validRemoteHAIp=n)},r.validateLocalHAPort=function(e){r.validLocalHAPort=!(isNaN(e)||e<1024||e>4096)},r.validatePriority=function(e){r.validPriority=!(isNaN(e)||e<1||e>255)},r.checkHotStandbySW=function(){r.enableHotStandby?(r.validateIp(r.localHAIp,"local"),r.validateIp(r.remoteHAIp,"remote"),r.validateLocalHAPort(r.localHAPort),r.validatePriority(r.priority)):(r.validLocalHAIp=!0,r.validRemoteHAIp=!0,r.validLocalHAPort=!0,r.validPriority=!0)},r.updateHotStandby=function(){var t={enableHotStandby:r.enableHotStandby,localHAIp:r.localHAIp,localHAPort:r.localHAPort,priority:r.priority,remoteHAIp:r.remoteHAIp,enableLocalPrimary:r.enableLocalPrimary},o=a.defer();e.timeoutPromise=o.promise,n.updateHotStandby(t).then(function(){o.resolve("success"),e.addAlert({type:"success",content:"双机热备下发成功"}),r.editMode.hotStandby=!1},function(t){o.resolve("fail"),e.addAlert({type:"danger",content:t.data.reason?"双机热备下发失败："+t.data.reason:t.data.rejectReason?"双机热备下发失败："+t.data.rejectReason:"双机热备下发失败"})})},r.cancelHotStandby=function(){r.loadHotStandby(),r.editMode.hotStandby=!r.editMode.hotStandby},r.loadBypass=function(){n.getBypass().then(function(e){r.bypassList=e,r.bypasses=[];for(var t=0;t<e.length;t++){var n=e[t];r.bypasses[t]={},r.bypasses[t].bypassName=n.bypassName,r.bypasses[t].appFault=n.appFault,r.bypasses[t].powerOn=n.powerOn}})},r.loadBypass(),r.updateBypass=function(){var t=r.bypasses,o=a.defer();e.timeoutPromise=o.promise,n.updateBypass(t).then(function(){o.resolve("success"),e.addAlert({type:"success",content:"BYPASS下发成功"}),r.editMode.bypass=!1},function(t){o.resolve("fail"),e.addAlert({type:"danger",content:t.data.reason?"BYPASS下发失败："+t.data.reason:t.data.rejectReason?"BYPASS下发失败："+t.data.rejectReason:"BYPASS下发失败"})})},r.cancelBypass=function(){r.loadBypass(),r.editMode.bypass=!r.editMode.bypass}}e.$inject=["$rootScope","$scope","Reliable","formatVal","$q"],angular.module("southWest.setting.reliable").controller("ReliableCtrl",e)}(),function(){"use strict";function e(){function e(e,t,n,o,a,r,i,l,s,c,d,u,p){"ngInject";var f=this;f.target=t.target,f.disabled=1,f.handling=!1;var m=function(t){return e.go(e.current,t,{reload:!0,inherit:!1,notify:!0})};f.doConfBackUp=function(){function e(e,t,n,l){t.validBackupPassword=!1;var s=/^[\w.]{8,20}$/;t.ok=function(){if(void 0!==t.backupPassword&&""!==t.backupPassword){f.handling=!0;var s="CONFIGURATION_BACKUP",c=r.defer();e.timeoutPromise=c.promise;var d=e.$on("confBakCollect",function(t,n){"conf"===n.name&&!function t(r){var l=a(function(){i.getTask(n.taskId).then(function(n){"SUCCESS"===n.data.state?(m({tab:s}).then(function(){c.resolve("success"),e.addAlert({type:"success",content:n.data.reason?"配置备份成功："+n.data.reason:"配置备份成功"})}),a.cancel(l),d()):"FAILED"===n.data.state?(m({tab:s}).then(function(){c.resolve("fail"),e.addAlert({type:"danger",content:n.data.reason?"配置备份失败："+n.data.reason:"配置备份失败"})}),a.cancel(l),d()):r>0?t(r-1):(o.info("Task state was invalid."),c.resolve("fail"),e.addAlert({type:"danger",content:"无法获取配置备份任务结果，请联系管理员。"}))})},1e3)}(5)}),p={};p.infoType=f.target,p.infoCollectionType="CONF_BACKUP",p.tag=f.tag,p.hasPassword=!0,l.getSecretKey().then(function(o){var a=o.data;p.password=btoa(u.encrypt(t.backupPassword,a)),l.doConfBackUp(p,function(t,o){n.close(),o&&(c.resolve("fail"),e.addAlert({type:"danger",content:o?"配置备份失败："+o.rejectReason:"配置备份失败"}))})})}else e.addAlert({type:"danger",content:"请输入备份密码"})},t.cancel=function(){n.dismiss("cancel")},t.validateBackupPassword=function(e){t.validBackupPassword=e&&e.match(s)}}e.$inject=["$rootScope","$scope","$modalInstance","Device"];var t=n.open({templateUrl:"conf-backup-collection-confirmation.html",size:"sm",controller:e});t.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},f.openUploadPanel=function(e){function t(e,t,n){e.extension=n,e.addPsw="1",e.uploader=new l({url:s+"/devices/confrestoration",autoUpload:!1,queueLimit:1}),e.uploader.onErrorItem=function(e,t){c.addAlert({type:"danger",content:"配置文件导入失败： "+t.error})},e.uploader.onSuccessItem=function(){},e.ok=function(){var n=r.defer();c.timeoutPromise=n.promise;var l=c.$on("confBakRestore",function(e,t){"conf"===t.name&&!function e(r){var s=a(function(){i.getTask(t.taskId).then(function(t){"SUCCESS"===t.data.state?(n.resolve("success"),c.addAlert({type:"success",content:(t.data.reason?t.data.reason:"配置恢复成功")+", 系统会在十秒后开始重启。请稍等。。。"}),a(function(){p.restartSystem("none").then(function(){c.addAlert({type:"success",content:"系统正在重启。。。稍候请重新登陆"})},function(){c.addAlert({type:"danger",content:"系统重启失败！"})})},5e3),a.cancel(s),l()):"FAILED"===t.data.state?(n.resolve("fail"),c.addAlert({type:"danger",content:t.data.reason?t.data.reason:"配置恢复失败"}),a.cancel(s),l()):r>0?e(r-1):(o.info("Task state was invalid."),n.resolve("fail"),c.addAlert({type:"danger",content:"无法获取配置恢复任务结果，请联系管理员。"}))})},1e3)}(5)});d.getSecretKey().then(function(n){var o=n.data;e.uploader.queue[0].url=s+"/devices/confrestoration/"+btoa(u.encrypt(e.backupPassword,o)),e.uploader.queue[0].upload(),t.close()})},e.upload=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","extension"];var f=n.open({templateUrl:"templates/setting/security_operation/confirmUploadPanel.b51fbca0.html",controller:t,size:"sm",resolve:{extension:function(){return e}}});f.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}e.$inject=["$state","$scope","$modal","$log","$timeout","$q","Task","FileUploader","URI","$rootScope","Device","$crypto","System"];var t={scope:{target:"@"},restrict:"E",replace:!0,templateUrl:"/templates/setting/security_operation/conf-backup.180091d7.html",controller:e,controllerAs:"backup"};return t}function t(e,t,n,o,a,r,i,l){function s(s,c,d,u){function p(e){var t=e||{};return t.$filter=g,r.getConfBackUpFileInfos(t)}function f(e){var t=e||{};return t.$filter=g,r.getConfBackUpFileInfoCount(t)}function m(e){var t=e||{};return t.$filter=t.$filter+" and "+g,r.getConfBackUpFileInfos(t)}var g="infoType eq CONFIGURATION";u.disableToolbar=!0,u.setConfig({name:"file",pagination:!1,scrollable:!1,totalCount:!0,getAll:p,getCount:f,search:m}),u.downloadConfBackUpFiles=function(e){window.open("./"+e,"_self")},u.deleteConfBackUpFiles=function(n){function a(t,n,o){t.ok=function(){0!==r.length?o.deleteConfBackUpFiles(r,function(o){n.close(),o?e.addAlert({type:"danger",content:o?"文件删除失败："+o:"文件删除失败"}):(e.addAlert({type:"success",content:"文件删除成功"}),t.dtable.getTableData())}):(e.addAlert({type:"info",content:"请至少选中一个文件"}),n.close())},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance","Device"];var r=[];if(Array.isArray(n))r=n;else for(var i in n)n[i]&&r.push(i);var l=t.open({templateUrl:"conf-backup-delete-confirmation.html",size:"sm",controller:a,scope:s});l.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},u.restoreConfBackUpFiles=function(r){function s(t,s,c,d){s.ok=function(){if(void 0!==s.backupPassword&&""!==s.backupPassword){var u=a.defer();e.timeoutPromise=u.promise;var p=e.$on("confBakRestore",function(a,r){"conf"===r.name&&!function a(l){var s=n(function(){i.getTask(r.taskId).then(function(r){"SUCCESS"===r.data.state?(u.resolve("success"),e.addAlert({type:"success",content:(r.data.reason?r.data.reason:"配置恢复成功")+", 系统会在十秒后开始重启。请稍等。。。"}),n(function(){t.restartSystem("none").then(function(){e.addAlert({type:"success",content:"系统正在重启。。。稍候请重新登陆"})},function(){e.addAlert({type:"danger",content:"系统重启失败！"})})},5e3),n.cancel(s),p()):"FAILED"===r.data.state?(u.resolve("fail"),e.addAlert({type:"danger",content:r.data.reason?r.data.reason:"配置恢复失败"}),n.cancel(s),p()):l>0?a(l-1):(o.info("Task state was invalid."),u.resolve("fail"),e.addAlert({type:"danger",content:"无法获取配置恢复任务结果，请联系管理员。"}))})},1e3)}(5)}),f={};f.infoCollectionType="CONF_BACKUP",f.confBackupFileInfoId=r,f.hasPassword=!0,d.getSecretKey().then(function(t){var n=t.data;f.password=btoa(l.encrypt(s.backupPassword,n)),d.restoreConfBackUpFiles(f).success(function(){c.close()}).error(function(t){e.addAlert({type:"danger",content:t?t:"配置恢复失败"})})})}else e.addAlert({type:"danger",content:"请输入备份时设置的密码"})},s.cancel=function(){c.dismiss("cancel")}}s.$inject=["System","$scope","$modalInstance","Device"];var c=t.open({templateUrl:"conf-backup-restore-confirmation.html",size:"sm",controller:s});c.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var c={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/setting/security_operation/conf-backup-table.8f56aa5c.html",link:s};return c}t.$inject=["$rootScope","$modal","$timeout","$log","$q","Device","Task","$crypto"],angular.module("southWest.setting.security_operation").directive("confBackup",e).directive("confBackupTable",t)}(),function(){"use strict";function e(e){e.state("setting.security_operation",{parent:"setting",url:"/security_operation",templateUrl:"templates/setting/security_operation/index.6f6b55ed.html",controller:"SecurityOperationCtrl as update"})}e.$inject=["$stateProvider"],angular.module("southWest.setting.security_operation").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d){function u(e,t){for(var n=!0,o=0;o<t.length;o++)e[o]>t[o]&&(n=!1);return n}var p=this;d.getSerialNumber().then(function(e){e.data.serialNumber&&(p.serialNumber=e.data.serialNumber)}),p.uploader=new t({url:o+"/files/console/uploadimage",autoUpload:!0,queueLimit:1});var f="",m=n.VERSION_NUMBER.substr(3),g={invalid_content_size:"升级包长度不符合规格，请重新上传。",invalid_algorithm:"checksum算法未找到，请重试。",invalid_checksum_size:"checksum数值不匹配，请重新上传。",invalid_checksum:"升级包的checksum数值与checksum算法结果不匹配，请重新上传。",invalid_meta_info:"meta信息中升级包文件路径不是合法的json数据，请重新上传。",invalid_file_format:"升级包格式错误，请重新上传。",disk_full:"磁盘空间不足，请清理磁盘空间后重试。",missing_version_info:"升级包版本信息缺失，请重新上传。",unable_to_read_file:"无法读取升级包文件，请重新上传。",publish_error:"升级包文件下发出错，请重试。"};p.uploader.onSuccessItem=function(e,t){if(t.error)p.uploadImageFail=g[t.reason]?g[t.reason]:"服务无反应，请查看 LCD 屏幕报错信息。";else if(p.uploader.queue.length<1)p.uploadImageFail=null,p.uploadImageSuccess=!1;else if(p.uploadImageSuccess=!0,p.uploadedImage=p.uploader.queue[0].file.name,f=p.uploadedImage.split("-")[1],""===m&&(m=n.VERSION_NUMBER.substr(3)),m&&f){var o=m.split("."),a=f.split(".");o.length===a.length?(p.uploadImageSuccess=u(o,a),p.uploadImageSuccess||(p.uploadImageFail="升级包版本低于当前系统版本，请重新上传。")):p.uploadImageFail="升级包版本命名格式错误，请重新上传。"}else p.uploadImageFail=g.missing_version_info},p.cancelUpload=function(e){e.cancel(),p.uploader.queue.splice(0,1)},p.uploader.onProgressItem=function(e){a.sysbaseinfo().then(function(){p.uploadImageFail=""},function(){e.isUploading&&(p.uploadImageFail="网络异常，请确认网络连接。")})},p.uploader.onErrorItem=function(e,t){t.error?p.uploadImageFail=g[t.reason]?g[t.reason]:"升级包文档格式错误或上传时发生错误，请重新上传。":p.uploadImageFail="服务无反应，无法上传文件。",p.uploadedImage=p.uploader.queue>0?p.uploader.queue[0].file.name:null,p.uploadImageSuccess=!1},p.uploader.onBeforeUploadItem=p.uploader.onabort=function(){p.uploadImageFail=null,p.uploadImageSuccess=!1},p.showUpgradeConfirmationModal=function(){function t(e,t){e.cancel=function(){t.dismiss("cancel")},e.done=function(){e.upgradeStarting=!0,t.close("confirmed")}}t.$inject=["$scope","$modalInstance"];var n=e.open({templateUrl:"templates/setting/security_operation/upgrade-modal.e160ce44.html",controller:t,windowClass:"upgrade-modal-window"});n.result.then(function(e){"confirmed"===e&&p.confirmSystemUpgrade()},function(){})},p.confirmSystemUpgrade=function(){function t(e,t){t.startUpgradeAllinOne(p.serialNumber).then(function(t){l(function(){e.close({complete:!t.error,taskId:t.data.taskId})},5e3)},function(){l(function(){e.close({complete:!1})},5e3)})}t.$inject=["$modalInstance","System"];var n=e.open({templateUrl:"templates/setting/security_operation/upgrade-progress-modal.2c0587cf.html",controller:t,windowClass:"upgrade-progress-modal-window",keyboard:!1});n.result.then(function(e){p.showUpgradeResponseModal(e)},function(){})},p.showUpgradeResponseModal=function(t){function o(e,t,o){if(e.upgradeInformation=o,o.complete){var r=c.defer();n.timeoutPromise=r.promise;var i=function(){n.addAlert({type:"success",content:"部署成功,3秒钟后自动刷新页面"}),r.resolve("success"),l(function(){window.location.href="/"},3e3)},d=function(){s.getTask(o.taskId).then(function(e){"PROCESSING"!==e.data.state?l(function(){var e=setInterval(function(){a.sysbaseinfo().then(function(t){200===t.status&&(i(),clearInterval(e))})},5e3)},5e3):l(d,2e3)},function(e){401===e.status?i():l(d,2e3)})};d()}e.cancel=function(){t.dismiss("cancel")}}o.$inject=["$scope","$modalInstance","upgradeInformation"],e.open({templateUrl:"templates/setting/security_operation/upgrade-response.6a5f7b76.html",controller:o,windowClass:"upgrade-progress-modal-window",keyboard:!1,resolve:{upgradeInformation:function(){return t}}})};var h=p.reset={};p.showDisconnectModal=function(){function t(e,t){p.hideDisconnectModal=function(){p.isShowDisconnectModal=!1,t.close("done")}}t.$inject=["$scope","$modalInstance"],
p.isShowDisconnectModal=!0,e.open({templateUrl:"disconnectModal.html",controller:t,size:"sm",backdrop:"static",keyboard:!1})},h.resetModal=function(){function t(e,t,o){e.cancel=function(){t.dismiss("cancel")},e.done=function(){n.timeoutPromise=o.resetSystem().then(function(){n.addAlert({type:"success",content:"系统会在十秒后开始恢复原厂设置。需要大约2~5分钟恢复，请稍等。。。"}),l(function(){h.redirectToMainPage()},1e4)},function(){n.addAlert({type:"danger",content:"恢复原厂设置失败。"})}),t.close("done")}}t.$inject=["$scope","$modalInstance","System"];var o=e.open({templateUrl:"templates/setting/basic/reset-panel.e8d3c9a6.html",size:"sm",controller:t});o.result.then(function(e){},function(){})},h.rebootModal=function(){function t(e,t,o){e.cancel=function(){t.dismiss("cancel")},e.done=function(){o.restartSystem("none").then(function(){n.addAlert({type:"success",content:"系统会在十秒后开始重启。需要大约2~5分钟恢复，请稍等。。。"}),l(function(){h.redirectToMainPage()},1e4)},function(){n.addAlert({type:"danger",content:"系统重启失败！"})}),t.close("done")}}t.$inject=["$scope","$modalInstance","System"];var o=e.open({templateUrl:"templates/setting/basic/restart-panel.e2c4b3b7.html",size:"sm",controller:t});o.result.then(function(e){},function(){})},h.redirectToMainPage=function(){l(function(){a.sysbaseinfo().then(function(e){var t=new Date(e.data);isNaN(t.getDate())||isNaN(t.getTime())?(p.isShowDisconnectModal||p.showDisconnectModal(),h.redirectToMainPage()):(p.isShowDisconnectModal=!1,i.path("/"),r.location.reload())},function(){p.isShowDisconnectModal||p.showDisconnectModal(),h.redirectToMainPage()})},5e3)}}e.$inject=["$modal","FileUploader","$rootScope","URI","apiInfo","$window","$location","$timeout","Task","$q","System"],angular.module("southWest.setting.security_operation").controller("SecurityOperationCtrl",e)}(),function(){"use strict";function e(e){function t(t,n,o,a){function r(){return e.getAllUpgradeInfo()}function i(){return e.getAllUpgradeInfo().then(function(e){return e.length})}a.disableToolbar=!0,a.setConfig({pagination:!1,scrollable:!1,totalCount:!1,getAll:r,getCount:i})}var n={scope:!0,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/setting/security_operation/update-info-table.fd0db436.html",link:t};return n}e.$inject=["System"],angular.module("southWest.setting.security_operation").directive("updateInfoTable",e)}(),function(){"use strict";function e(e){e.state("setting",{abstract:!0,parent:"dashboard",url:"/setting",controller:"SettingCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html"})}e.$inject=["$stateProvider"],angular.module("southWest.setting").config(e)}(),function(){"use strict";function e(e,t,n){var o=this;o.prefixId="setting",o.subMenus=n.rootMenu.getChild("SETTING"),o.expanded="true"===localStorage.getItem("object:navbar:expanded"),o.toggleExpand=function(){o.expanded=!o.expanded,localStorage.setItem("object:navbar:expanded",o.expanded)},o.isActive=function(e){return t.current.name.indexOf(e.getState())>-1}}e.$inject=["$scope","$state","$rootScope"],angular.module("southWest.setting").controller("SettingCtrl",e)}(),function(){"use strict";function e(e){e.state("setting.switch",{url:"/switch",controller:"SwitchCtrl as switch",templateUrl:"templates/setting/switch/index.6a14cda6.html"})}e.$inject=["$stateProvider"],angular.module("southWest.setting.switch").config(e)}(),function(){"use strict";function e(e,t,n,o){var a=this;a.isEditingTraffic=!1,a.loadTrafficSwitch=function(){t.getTrafficSwitch().then(function(e){for(var t=0;t<e.length;t++){var n=e[t];if("IP_TRAFFIC"===n.subscriptionType){a.iptrafficReport="ON_ALARM"===n.subscriptionStatus?1:0;break}}})},a.loadTrafficSwitch(),a.editTraffic=function(){a.isEditingTraffic=!a.isEditingTraffic},a.cancelTraffic=function(){a.isEditingTraffic=!a.isEditingTraffic,a.loadTrafficSwitch()},a.confirmTraffic=function(){function r(n,r){n.confirmTitle="流量开关",n.ok=function(){r.close("done");var n={iptrafficReport:a.iptrafficReport},i=o.defer();e.timeoutPromise=i.promise,t.setTrafficSwitch(n).then(function(){i.resolve("success"),e.addAlert({type:"success",content:"流量开关下发成功"}),a.isEditingTraffic=!1},function(t){i.resolve("fail"),e.addAlert({type:"danger",content:t.data.reason?"流量开关下发失败："+t.data.reason:t.data.rejectReason?"流量开关下发失败："+t.data.rejectReason:"流量开关下发失败"})})},n.cancel=function(){r.dismiss("cancel"),a.cancelTraffic()}}r.$inject=["$scope","$modalInstance"],n.open({templateUrl:"templates/setting/switch/switch-setting-confirm.f570e7ff.html",size:"sm",controller:r})},a.isEditingDP=!1,a.loadAuditProtocolSwitch=function(){t.getProtocolSwitch().then(function(e){a.DPprotocols=e})},a.loadAuditProtocolSwitch(),a.enableAllDP=function(){a.DPprotocols.map(function(e){e.status=!0})},a.disableAllDP=function(){a.DPprotocols.map(function(e){e.status=!1})},a.editDP=function(){a.oldDPprotocols=angular.copy(a.DPprotocols),a.isEditingDP=!0},a.cancelDP=function(){a.DPprotocols=a.oldDPprotocols,a.isEditingDP=!1},a.showConfirm=function(){function e(e,t){e.confirmTitle="协议审计开关",e.ok=function(){a.confirmDP(),t.close("done")},e.cancel=function(){a.cancelDP(),t.dismiss("cancel")}}e.$inject=["$scope","$modalInstance"],n.open({templateUrl:"templates/setting/switch/switch-setting-confirm.f570e7ff.html",size:"sm",controller:e})},a.confirmDP=function(){for(var n="0",r=a.DPprotocols.length-1;r>=0;r--)n+=a.DPprotocols[r].status?1:0;n=parseInt(n,2);var i={icAccountingReport1:n},l=o.defer();e.timeoutPromise=l.promise,t.setProtocolSwitch(i).then(function(){l.resolve("success"),e.addAlert({type:"success",content:"协议审计开关下发成功"}),a.isEditingDP=!1,a.loadAuditProtocolSwitch()},function(t){l.resolve("fail"),e.addAlert({type:"danger",content:t.data.reason?"协议审计开关下发失败："+t.data.reason:t.data.rejectReason?"协议审计开关下发失败："+t.data.rejectReason:"协议审计开关下发失败"})})}}e.$inject=["$rootScope","SwitchModel","$modal","$q"],angular.module("southWest.setting.switch").controller("SwitchCtrl",e)}(),function(){"use strict";function e(e){e.state("setting.systemconsole",{url:"/systemconsole",params:{tab:null},controller:"SystemConsoleCtrl as sysconsole",templateUrl:"templates/setting/systemconsole/index.209356ef.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_POLICY SETTINGS_PLATFORM_REBOOT SETTINGS_PLATFORM_UPGRADE_RESET SETTINGS_IP_LOGIN SETTINGS_PROTOCOL"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.setting.systemconsole").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m,g,h,v,y,I,D,T){function b(e,t){return e&&t&&e[0]<=t[0]&&e[2]<=t[2]}function S(){p.all([t.getStrategyInfo(),t.getJobStrategyInfo("LOG_DELETION"),t.getJobStrategyInfo("MALICIOUS_DOMAIN_SCAN")]).then(function(e){var t=e[0].data;if(t.forEach(function(e){if("STORAGE_MANAGEMENT"===e.strategyInfo.strategyCode)k.storageStrategy=e;else if("MAX_LOGIN_TRY_MANAGEMENT"===e.strategyInfo.strategyCode)k.maxLoginTimesStrategy=e;else if("ENCRYPTION_MANAGEMENT"===e.strategyInfo.strategyCode)k.encryptionStrategy=e,k.encryptionStrategy.encryptionStrategyVal=k.encryptionStrategy.strategyRules[0].ruleData;else if("PASSWORD_COMPLEXITY_MANAGEMENT"===e.strategyInfo.strategyCode)k.passwordComplexityStrategy=e,k.changePasswordComplexityStrategyArray(e.strategyRules[0].ruleData);else if("TIMEOUT_MANAGEMENT"===e.strategyInfo.strategyCode)k.timeoutStrategy=e;else if("IP_TRAFFIC_MANAGEMENT"===e.strategyInfo.strategyCode)k.IPTrafficManagement=e;else if("IP_TRAFFIC_TOGGLE"===e.strategyInfo.strategyCode)k.iptrafficConfSwitch=e,k.iptrafficConfSwitch.iptrafficConfSwitchVal="1"===k.iptrafficConfSwitch.strategyRules[0].ruleData;else if("LOG_DELETION_MANAGEMENT"===e.strategyInfo.strategyCode)k.logDeletionManagement=e,k.logDeletionManagementTmp=e.strategyRules[0].ruleData;else if("LOG_DELETION_TIME"===e.strategyInfo.strategyCode){k.logDeletionTime=e;var t=e.strategyRules[0].ruleData.split(":"),n=new Date;n.setHours(t[0]),n.setMinutes(t[1]),n.setSeconds(0),n.setMilliseconds(0),k.logDeletionTimeTmp=n}else"NOTIFICATION_MANAGEMENT"===e.strategyInfo.strategyCode&&(k.notificationManagement=e,k.notificationManagementTmp=e.strategyRules[0].ruleData,k.setSoundModeTmp=e.strategyActions[0].actionData,k.notificationDropDown=!0,"incident"===e.strategyRules[0].ruleData?(k.setSoundIncidents=!0,k.setSoundEvents=!1):"event"===e.strategyRules[0].ruleData?(k.setSoundIncidents=!1,k.setSoundEvents=!0):"incident_event"===e.strategyRules[0].ruleData?(k.setSoundEvents=!0,k.setSoundIncidents=!0):(k.setSoundEvents=!1,k.setSoundIncidents=!1,k.setSoundModeTmp="",k.notificationDropDown=!1))}),e[1].data){k.logDeletionManagement=e[1].data,k.logDeletionManagementTmp=e[1].data.schedulingJob.jobData;var n=moment.utc();n.set("second",0),n.set("minute",e[1].data.schedulingJobMeta[0].minute),n.set("hour",e[1].data.schedulingJobMeta[0].hour),k.logDeletionTimeTmp=new Date(moment(n.format()).format())}e[2].data&&(k.maliciousdomainConf=e[2].data,k.maliciousdomainConfSwitchVal="true"===k.maliciousdomainConf.schedulingJob.jobData,k.maliciousdomainConfScanInterval=k.maliciousdomainConf.schedulingJobMeta[0].minute.split("/")[1])})}function P(e){var t=e.split(".");return(Number(t[0])<<24|Number(t[1])<<16|Number(t[2])<<8|Number(t[3])<<0)>>>0}function A(e){return 1===l.getUserType()||!s.centraliztion||"RUNNING_MODE"===e}function C(){var e={},t="category eq SECURITY_DEVICE",n=o.get("Role");if(!n[0].defaultRole){var a=o.get("deviceAccess");a.length?(t+=" and (",t+=a.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),t+=")"):t+=" and (contains(deviceId, 'null'))"}return e.$filter=t,e.$orderby="deviceId",I.getAll(e).then(function(e){k.dpiData=e,k.onlineDPISN=[];for(var t=0;t<k.dpiData.length;t++)1===k.dpiData[t].deviceOnline&&"DISCOVERY"===k.dpiData[t].deviceSource&&k.onlineDPISN.push(k.dpiData[t].serialNumber);return k.upgradeInfo().then(function(){for(var e=0;e<k.dpiData.length;e++){for(var t,n=0;n<k.upgradingDPIinfo.length;n++)if(k.dpiData[e].deviceId===k.upgradingDPIinfo[n].deviceId){t=k.upgradingDPIinfo[n];break}k.dpiData[e].isUpgrading=!t||!("NONE"===t.state&&(0===t.percentage||100===t.percentage)||t.error)}})})}var k=this;f.findLand("SYSTEM_CONSOLE",1);var w=k.syslog={setting:{}};C().then(function(){k.hasDpiData=k.dpiData.length>0});for(var E=m.getNode("SYSTEM_CONSOLE").getChilds(),N=["SYSTEM_SETTING","SYSTEM_RESET","SYSTEM_UPGRADE","IP_CONFIG","PROTOCOL_SETTING"],$=0;$<E.length;$++)if(E[$].getPrivilegeValue()>1){var M=$>0?N[$-1]:N[$];if(A(M)){k.system_console_init_tab=M;break}}k.system_console_init_tab||(k.system_console_init_tab="PROTOCOL_SETTING"),null!==T.tab&&(k.system_console_init_tab=T.tab),s.centraliztion&&(k.system_console_init_tab="RUNNING_MODE"),k.editRight=o.get("privilege").filter(function(e){return"SETTINGS_POLICY"===e.name}),k.editRight=k.editRight&&k.editRight.length&&30===k.editRight[0].actionValue,k.noViewRight=o.get("privilege").filter(function(e){return"SETTINGS_POLICY"===e.name}),k.noViewRight=k.noViewRight&&k.noViewRight.length&&1===k.noViewRight[0].actionValue,k.isRemote=f.isRemote(),k.isAllinOne=f.isAllinOne(),t.getSerialNumber().then(function(e){e.data.serialNumber&&(k.serialNumber=e.data.serialNumber)}),t.getLastUpgrade().then(function(e){k.lastupgrade=e.data&&e.data.updatedAt?new Date(e.data.updatedAt):null}),k.uploader=new n({url:r+"/files/console/uploadimage",autoUpload:!0,queueLimit:1});var R="",U=s.VERSION_NUMBER.substr(3,3),_={invalid_content_size:"升级包长度不符合规格，请重新上传。",invalid_algorithm:"checksum算法未找到，请重试。",invalid_checksum_size:"checksum数值不匹配，请重新上传。",invalid_checksum:"升级包的checksum数值与checksum算法结果不匹配，请重新上传。",invalid_meta_info:"meta信息中升级包文件路径不是合法的json数据，请重新上传。",invalid_file_format:"升级包格式错误，请重新上传。",disk_full:"磁盘空间不足，请清理磁盘空间后重试。",missing_version_info:"升级包版本信息缺失，请重新上传。",unable_to_read_file:"无法读取升级包文件，请重新上传。",publish_error:"升级包文件下发出错，请重试。"};k.uploader.onSuccessItem=function(e,t){t.error?k.uploadImageFail=_[t.reason]?_[t.reason]:"服务无反应，请查看 LCD 屏幕报错信息。":k.uploader.queue.length<1?(k.uploadImageFail=null,k.uploadImageSuccess=!1):(k.uploadImageSuccess=!0,k.uploadedImage=k.uploader.queue[0].file.name,R=k.uploadedImage.substr(3,3),k.uploadImageSuccess=b(U,R),k.uploadImageSuccess||(k.uploadImageFail="升级包版本低于当前系统版本，请重新上传。"))},k.cancelUpload=function(e){e.cancel(),k.uploader.queue.splice(0,1)},k.uploader.onProgressItem=function(e){y.getCurDate().then(function(){k.uploadImageFail=""},function(){e.isUploading&&(k.uploadImageFail="网络异常，请确认网络连接。")})},k.uploader.onErrorItem=function(e,t){t.error?k.uploadImageFail=_[t.reason]?_[t.reason]:"升级包文档格式错误或上传时发生错误，请重新上传。":k.uploadImageFail="服务无反应，无法上传文件。",k.uploadedImage=k.uploader.queue>0?k.uploader.queue[0].file.name:null,k.uploadImageSuccess=!1},k.uploader.onBeforeUploadItem=k.uploader.onabort=function(){k.uploadImageFail=null,k.uploadImageSuccess=!1},g.init(),k.updateTimer=function(){setTimeout(function(){k.timerService=g,h.$apply(function(){k.serverTime=g.serverTime,k.localTime=g.localTime}),k.updateTimer()},100)},k.updateTimer(),k.updateTimeInput=function(){"undefined"==typeof k.timeoutFn&&(k.timeoutFn=v(function(){k.systemDateInput=new Date(k.localTime.getTime()),k.systemTimeInput=new Date(k.localTime.getTime())},100))},k.stopTimeout=function(){"object"==typeof k.timeoutFn&&(v.cancel(k.timeoutFn),delete k.timeoutFn)},k.validSystemTime=!1,k.systemDateInput="",k.systemTimeInput="",k.datePickerCtrl={},k.timePickerCtrl={},k.importLocalTime=function(){k.systemDateInput=new Date(k.localTime.getTime()),k.systemTimeInput=new Date(k.localTime.getTime()),k.updateTimeInput()},k.validateSystemTime=function(){k.validSystemTime=!1,"object"==typeof k.systemTimeInput&&"object"==typeof k.systemDateInput&&(k.validSystemTime=!0)},k.disableNtpSubmit=!1,k.setActivateNtp&&(k.disableNtpSubmit=!0),h.$watchCollection("[sysconsole.setActivateNtp, sysconsole.validNtpIP]",function(e){k.disableNtpSubmit=!0,e[0]&&e[1]&&(k.disableNtpSubmit=!1),k.setActivateNtp||(k.disableNtpSubmit=!1)});var x=k.mode={},O=k.ipMacBinding={};k.validateIp=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,k.editMode={storage:!1,security:!1,ipaddress:!1,ntpSync:!1,encryption:!1,iptraffic:!1,maliciousdomainConf:!1,scheduleDelete:!1},k.passwordComplexityStrategyArray=["低","中","高"],t.getSystemStatus().then(function(e){w.setting.ip=e.data.syslogIp,w.setting.port=e.data.syslogPort,w.setting.protocol=e.data.protocol,O.status=e.data.ipmacMode,O.action=e.data.action,x.status=e.data.maintenanceMode,k.compareVar=e.data,k.hostName=e.data.hostName,k.ipAddress=e.data.mwIp&&e.data.mwIp.length>0?e.data.mwIp.substring(0,e.data.mwIp.length):"0.0.0.0",k.netMask=e.data.netMask&&e.data.netMask.length>0?e.data.netMask.substring(0,e.data.netMask.length):"255.255.255.0",k.gateWay=e.data.gateWay&&e.data.gateWay.length>0?e.data.gateWay.substring(0,e.data.gateWay.length):"0.0.0.0",k.preferDns=e.data.preferDns,k.spareDns=e.data.spareDns,k.originalIpAddress=k.ipAddress,k.originalNetMask=k.netMask,k.originalGateWay=k.gateWay,k.originHostName=k.hostName,k.originPreferDns=k.preferDns,k.originSpareDns=k.spareDns,k.ntpIp=e.data.ntpIp,k.activateNtp=e.data.activateNtp?"1":"0",k.setActivateNtp=e.data.activateNtp,k.soundIncidents=k.soundIncidents=e.data.soundIncidents,k.soundEvents=k.soundEvents=e.data.soundEvents,k.soundMode=k.soundMode=e.data.soundIncidents}),w.isEdited=!1,w.errMsg="",w.edit=function(){w.isEdited=!0,w.editedSetting=angular.copy(w.setting)},w.done=function(){w.isEdited=!1,w.setting.ip=w.editedSetting.ip,w.setting.port=w.editedSetting.port,w.setting.protocol=w.editedSetting.protocol,t.updateSyslog({syslogIp:w.setting.ip,syslogPort:w.setting.port,protocol:w.setting.protocol}).then(function(e){})},w.cancel=function(){w.isEdited=!1},O.bind=function(){t.ipMac({systemSettingType:"IPMAC",flag:O.status,action:O.action}).then(function(e){k.compareVar=e}),k.showSuccessMessage=!0,c(function(){k.showSuccessMessage=!1},3e3)};var L=k.reset={};k.isShowDisconnectModal=!1,k.showDisconnectModal=function(){function t(e,t){k.hideDisconnectModal=function(){k.isShowDisconnectModal=!1,t.close("done")}}t.$inject=["$scope","$modalInstance"],k.isShowDisconnectModal=!0,e.open({templateUrl:"disconnectModal.html",controller:t,size:"sm",backdrop:"static",keyboard:!1})},L.redirectToMainPage=function(){c(function(){y.sysbaseinfo().then(function(e){var t=new Date(e.data);isNaN(t.getDate())||isNaN(t.getTime())?(k.isShowDisconnectModal||k.showDisconnectModal(),L.redirectToMainPage()):(k.isShowDisconnectModal=!1,u.path("/"),d.location.reload())},function(){k.isShowDisconnectModal||k.showDisconnectModal(),L.redirectToMainPage()})},5e3)},L.resetModal=function(){function t(e,t,n){e.cancel=function(){t.dismiss("cancel")},e.done=function(){n.resetSystem().then(function(){s.addAlert({type:"success",content:"系统会在十秒后开始恢复原厂设置。请稍等。。。"}),c(function(){L.redirectToMainPage()},5e3)},function(){s.addAlert({type:"danger",content:"恢复原厂设置失败。"})}),t.close("done")}}t.$inject=["$scope","$modalInstance","System"];var n=e.open({templateUrl:"templates/setting/systemconsole/reset-panel.32f84d97.html",size:"sm",controller:t});n.result.then(function(e){},function(){})},L.restartModal=function(){function t(e,t,n){e.cancel=function(){t.dismiss("cancel")},e.done=function(){n.restartSystem(a.id).then(function(){s.addAlert({type:"success",content:"系统会在十秒后开始重启。请稍等。。。"}),c(function(){L.redirectToMainPage()},1e4)},function(){s.addAlert({type:"danger",content:"系统重启失败！"})}),t.close("done")}}t.$inject=["$scope","$modalInstance","System"];var n=e.open({templateUrl:"templates/setting/systemconsole/restart-panel.44f79df8.html",size:"sm",controller:t});n.result.then(function(e){},function(){})},L.shutdownModal=function(){function t(e,t,n){e.cancel=function(){t.dismiss("cancel")},e.done=function(){n.shutdownSystem("0").then(function(){s.addAlert({type:"success",content:"安全监管平台会在5秒后关机。"})},function(){s.addAlert({type:"danger",content:"系统关机失败！"})}),t.close("done")}}t.$inject=["$scope","$modalInstance","System"];var n=e.open({templateUrl:"templates/setting/systemconsole/shutdown-panel.5e29b5ab.html",size:"sm",controller:t});n.result.then(function(e){},function(){})},x.changeMode=function(){x.status=!x.status,t.updateMaintenance({systemSettingType:"MAINTENANCE_MODE",flag:x.status}).then(function(e){})},k.validateNotificationDropDown=function(){k.setSoundEvents===!1&&k.setSoundIncidents===!1||""!==k.setSoundModeTmp?k.setSoundEvents===!1&&k.setSoundIncidents===!1&&""!==k.setSoundModeTmp&&(k.setSoundModeTmp="",k.notificationDropDown=!1):(k.notificationDropDown=!0,k.setSoundModeTmp="visual")},k.editStorage=function(){k.editMode.storage=!k.editMode.storage},k.editSecurity=function(){k.editMode.security=!k.editMode.security},k.editIPAddress=function(){k.editMode.ipaddress=!k.editMode.ipaddress,k.validateHostName(k.hostName),k.validatePlatformIP(k.ipAddress),k.validatePlatformNetMask(k.netMask),k.validatePlatformPreferDns(k.preferDns),k.validatePlatformSpareDns(k.spareDns)},k.editNtpSync=function(){g.init(),k.serverTime=g.serverTime,k.updateTimer(),k.validSystemTime=!1,k.setActivateNtp="1"===k.activateNtp,k.editMode.ntpSync=!k.editMode.ntpSync,k.ntpIpEnter=k.ntpIp,k.validateNtpIP(k.ntpIpEnter)},k.editEncryption=function(){k.editMode.encryption=!k.editMode.encryption},k.editSoundOption=function(){k.editMode.soundOption=!k.editMode.soundOption},k.editIPTraffic=function(){k.editMode.IPTraffic=!k.editMode.IPTraffic},k.editMaliciousDomainConf=function(){k.editMode.maliciousdomainConf=!k.editMode.maliciousdomainConf},k.editScheduleDelete=function(){k.editMode.scheduleDelete=!k.editMode.scheduleDelete},k.changeIPTrafficStatus=function(){k.iptrafficConfSwitch.iptrafficConfSwitchVal?k.iptrafficConfSwitch.strategyRules[0].ruleData="1":k.iptrafficConfSwitch.strategyRules[0].ruleData="0",p.all([t.updateIPTrafficInfo(k.IPTrafficManagement.strategyRules[0]),t.updateIPTrafficInfo(k.iptrafficConfSwitch.strategyRules[0])]).then(function(){S(),k.editIPTraffic()})},k.changeMaliciousDomainConf=function(){k.maliciousdomainConf.schedulingJob.jobData=k.maliciousdomainConfSwitchVal,k.maliciousdomainConf.schedulingJobMeta[0].minute="0/"+k.maliciousdomainConfScanInterval,t.updateStradegyJobBuilder(k.maliciousdomainConf).then(function(){S(),k.editMaliciousDomainConf()})},k.changeStorageStatus=function(){t.updateStorageInfo(k.storageStrategy.strategyRules[0]).then(function(){S(),k.editStorage()},function(e){})},k.changeIPAddress=function(){var e=P(k.ipAddress),n=(P(k.ipAddress)&P(k.netMask))>>>0,o=(n|~P(k.netMask))>>>0;k.validPlatformIP=n<e&&e<o,k.validPlatformIP&&k.validPlatformNetMask&&k.validPlatformGateWay&&k.validPreferDns&&k.validSpareDns&&k.validPlatformHostName?(k.disableEditIPButton=!0,t.updateIPAddress(k.hostName,k.ipAddress,k.netMask,k.gateWay,k.preferDns,k.spareDns).then(function(){k.originalIpAddress=k.ipAddress,k.originalNetMask=k.netMask,k.originalGateWay=k.gateWay,k.originHostName=k.hostName,k.originPreferDns=k.preferDns,k.originSpareDns=k.spareDns,s.addAlert({type:"success",content:"系统会在十秒后自动网址重定向。请稍等。。。"}),setTimeout(function(){d.location.href="https://"+k.ipAddress},1e4)},function(e){k.ipAddress=k.originalIpAddress,k.netMask=k.originalNetMask,k.gateWay=k.originalGateWay,k.hostName=k.originHostName,k.preferDns=k.originPreferDns,k.spareDns=k.originSpareDns,s.addAlert({type:"danger",content:"网络端口配置失败！"})}),k.editIPAddress()):s.addAlert({type:"danger",content:"请确认IP地址与网关在同一有效网段！"})},k.getInputDateTime=function(){var e="";if("object"==typeof k.systemDateInput&&"object"==typeof k.systemTimeInput)k.systemDateInput.setHours(k.systemTimeInput.getHours()),k.systemDateInput.setMinutes(k.systemTimeInput.getMinutes()),k.systemDateInput.setSeconds(k.systemTimeInput.getSeconds()),e=k.systemDateInput.toISOString();else if("object"==typeof k.systemDateInput)k.systemDateInput.setHours(k.serverTime.getHours()),k.systemDateInput.setMinutes(k.serverTime.getMinutes()),k.systemDateInput.setSeconds(k.serverTime.getSeconds()),e=k.systemDateInput.toISOString();else if("object"==typeof k.systemTimeInput){var t=new Date(k.serverTime.getTime());t.setHours(k.systemTimeInput.getHours()),t.setMinutes(k.systemTimeInput.getMinutes()),t.setSeconds(k.systemTimeInput.getSeconds()),e=t.toISOString()}else e=g.serverTime.toISOString();return e=e.substring(0,19)+"Z"},k.systemTimeModal=function(){function n(e,t){e.cancel=function(){t.close(!1)},e.confirm=function(){t.close(!0)}}n.$inject=["$scope","$modalInstance"];var o=e.open({templateUrl:"templates/setting/systemconsole/systemTimeSetModal.a9b42bc5.html",size:"sm",controller:n});o.result.then(function(e){if(e){var n=k.getInputDateTime();n&&t.setSystemTime(n).then(function(){t.updateNtpSync(k.ntpIp,!1),s.timeoutPromise=v(function(){y.sysbaseinfo().then(function(){v.cancel(s.timeoutPromise),window.location.reload()})},1e4,12)},function(e){s.addAlert({type:"danger",content:"时钟同步设置失败！"})})}})},k.changeNtpSync=function(){k.setActivateNtp?s.timeoutPromise=t.updateNtpSync(k.ntpIpEnter,k.setActivateNtp).then(function(){t.getSystemStatus().then(function(e){k.ntpIp=e.data.ntpIp,k.activateNtp=e.data.activateNtp?"1":"0",k.setActivateNtp=!0,k.editMode.ntpSync=!k.editMode.ntpSync})},function(e){s.addAlert({type:"danger",content:"时钟同步设置失败！"})}):k.systemTimeModal()},k.changeEncryption=function(){t.updateStrategyInfo(k.encryptionStrategy.strategyRules[0]).then(function(){S(),k.editEncryption()},function(e){})},k.soundSettingsMap={incident:"安全事件",incident_event:"安全和系统事件"},k.changeSoundOption=function(){k.notificationManagement.strategyRules[0].ruleData=k.notificationManagementTmp,k.notificationManagement.strategyActions[0].actionData=k.setSoundModeTmp,p.all([t.updateSystemConsoleAction(k.notificationManagement.strategyActions[0]),t.updateSystemConsoleInfo(k.notificationManagement.strategyRules[0])]).then(function(){k.editSoundOption(),S()})},k.changeScheduleDelete=function(){k.logDeletionManagement.schedulingJob.jobData=k.logDeletionManagementTmp,k.logDeletionTimeTmp.setHours(k.logDeletionTimeTmp.getHours()+Math.round(k.logDeletionTimeTmp.getTimezoneOffset()/60)),k.logDeletionManagement.schedulingJobMeta[0].hour=k.logDeletionTimeTmp.getHours().toString(),k.logDeletionManagement.schedulingJobMeta[0].minute=k.logDeletionTimeTmp.getMinutes().toString(),p.all([t.updateStradegyJobBuilder(k.logDeletionManagement)]).then(function(){S(),k.editScheduleDelete()})},k.changeSecurityStatus=function(){p.all([t.updateStorageInfo(k.maxLoginTimesStrategy.strategyRules[0]),t.updateStorageInfo(k.passwordComplexityStrategy.strategyRules[0]),t.updateStorageInfo(k.timeoutStrategy.strategyRules[0])]).then(function(){S(),k.editSecurity()})},k.cancelIPTrafficStatus=function(){S(),k.editIPTraffic()},k.cancelMaliciousDomainConf=function(){S(),k.editMaliciousDomainConf()},k.cancelStorageStatus=function(){S(),k.editStorage()},k.cancelSecurityStatus=function(){S(),k.editSecurity()},k.cancelIPAddress=function(){k.editIPAddress(),k.ipAddress=k.originalIpAddress,k.netMask=k.originalNetMask,k.gateWay=k.originalGateWay,k.hostName=k.originHostName,k.preferDns=k.originPreferDns,k.spareDns=k.originSpareDns},k.validatePlatformIP=function(e){k.validPlatformIP=e&&!D.validateIp(e),k.validatePlatformGateWay(k.gateWay)},k.validatePlatformNetMask=function(e){k.validPlatformNetMask=e&&e.match(D.getIPReg())&&!D.validateNetMask(e),k.validatePlatformGateWay(k.gateWay)},k.validateHostName=function(e){k.validPlatformHostName=e&&D.checkProtocolName(k.hostName)},k.validatePlatformPreferDns=function(e){k.validPreferDns=e&&!D.validateIp(e)},k.validatePlatformSpareDns=function(e){k.validSpareDns=void 0===e||e&&!D.validateIp(e)},k.validatePlatformGateWay=function(e){if(k.validPlatformIP&&k.validPlatformNetMask&&e&&!D.validateIp(e)){var t=P(e),n=(P(k.ipAddress)&P(k.netMask))>>>0,o=(n|~P(k.netMask))>>>0;k.validPlatformGateWay=n<t&&t<o}else k.validPlatformGateWay=!1},k.validateNtpIP=function(e){k.validNtpIP=e&&!D.validateIp(e)&&"0.0.0.0"!==e&&"255.255.255.255"!==e},k.cancelNtpSync=function(){k.setActivateNtp="1"===k.activateNtp,k.datePickerCtrl.clearDate(),k.timePickerCtrl.clearDate(),k.stopTimeout(),k.systemDateInput="",k.systemTimeInput="",k.editMode.ntpSync=!k.editMode.ntpSync},k.cancelEncryption=function(){k.editEncryption(),S()},k.cancelSoundOption=function(){k.editSoundOption(),S()},k.cancelScheduleDelete=function(){S(),k.editScheduleDelete()},k.changePasswordComplexityStrategyArray=function(e){var t=[{name:"低",message:"任意字母、数字或字符，8位或以上，25位以下"},{name:"中",message:"必须是字母加数字和符号，8位或以上，25位以下"},{name:"高",message:"必须是字母加数字和符号，12位或以上，25位以下"}];t.forEach(function(t){t.name===e&&(k.passwordComplexityStrategyMessage=t.message)})},k.syncDataToAllInOne=function(){t.syncDataToAllInOne().then(function(){s.addAlert({type:"success",content:"用户信息同步请求已经成功发送给一体机，请稍后在一体机上确认。"})},function(e){s.addAlert({type:"danger",content:"用户信息同步失败！"})})},S(),k.showUpgradeConfirmationModal=function(){function t(e,t){e.cancel=function(){t.dismiss("cancel")},e.done=function(){e.upgradeStarting=!0,t.close("confirmed")}}t.$inject=["$scope","$modalInstance"];var n=e.open({templateUrl:"templates/setting/systemconsole/upgrade-modal.e160ce44.html",controller:t,windowClass:"upgrade-modal-window"});n.result.then(function(e){"confirmed"===e&&k.confirmSystemUpgrade()},function(){})},k.confirmSystemUpgrade=function(){function t(e,t){k.isUpgrading?(s.addAlert({type:"danger",content:"系统正在升级, 请稍后再试。"}),e.dismiss("cancel")):t.getSerialNumber().then(function(n){var o=n.data.serialNumber;t.startUpgradeAllinOne(o).then(function(t){c(function(){e.close({complete:!t.error,taskId:t.data.taskId})},5e3)},function(){c(function(){e.close({complete:!1})},5e3)})})}t.$inject=["$modalInstance","System"];var n=e.open({templateUrl:"templates/setting/systemconsole/upgrade-progress-modal.42676e17.html",controller:t,windowClass:"upgrade-progress-modal-window",keyboard:!1});n.result.then(function(e){k.showUpgradeResponseModal(e)},function(){})},k.showUpgradeResponseModal=function(t){function n(e,t,n){if(e.upgradeInformation=n,n.complete){var o=p.defer();s.deployTaskPromise=o.promise,s.$on("dpiUpgradeState",function(){i.getTask(n.taskId).then(function(e){"SUCCESS"===e.data.state?(s.addAlert({type:"success",content:"部署成功"}),o.resolve("success"),c(function(){var e=setInterval(function(){y.sysbaseinfo().then(function(t){200===t.status&&(window.location.href="/",clearInterval(e))})},5e3)},5e3)):"FAILED"===e.data.state&&o.resolve("fail")})})}e.cancel=function(){t.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","upgradeInformation"],e.open({templateUrl:"templates/setting/systemconsole/upgrade-response.6a5f7b76.html",controller:n,windowClass:"upgrade-progress-modal-window",keyboard:!1,resolve:{upgradeInformation:function(){return t}}})},k.upgradeInfo=function(){for(var e="",n=0;n<k.onlineDPISN.length;n++)e+="serialNumber="+k.onlineDPISN[n]+"&";return e=e?e.substring(0,e.length-1):"",e+="&$orderby=deviceId",e?t.getDPIUpgradeInfo(e).then(function(e){return k.upgradingDPIinfo=e.data,k.upgradingDPIinfo?k.isUpgrading=!!k.upgradingDPIinfo.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0]:(k.upgradingDPIinfo=[],k.isUpgrading=!1),k.isUpgrading}):(k.upgradingDPIinfo=[],k.isUpgrading=!1,k.isUpgrading)},k.tabEnabled=A}e.$inject=["$modal","System","FileUploader","Enum","topologyId","URI","Task","auth","$rootScope","$timeout","$window","$location","$q","uiCtrl","uiTree","timerService","$scope","$interval","apiInfo","Device","formatVal","$stateParams"],angular.module("southWest.setting.systemconsole").controller("SystemConsoleCtrl",e)}(),function(){"use strict";function e(e,t,n){function o(o){function a(e){l.remoteIpsSource=e,l.remoteIps=angular.copy(l.remoteIpsSource);for(var t=0;t<l.remoteIps.length;t++){var n=l.remoteIps[t];n.strategyRuleName||"0.0.0.0/0"!==n.ruleData||(n.strategyRuleName="允许所有IP地址访问"),n.errors=!1}l.validIp=!0,l.remoteIpsEnable=1!==l.remoteIps.length||"0.0.0.0/0"!==l.remoteIps[0].ruleData}function r(){return e.getRemoteIp().then(function(e){l.remoteIpData.setting.strategyInfo=e.data.strategyInfo,l.remoteIpData.setting.strategyRules=e.data.strategyRules,l.remoteIpData.setting.strategyActions=e.data.strategyActions,l.strategyRuleSetId=l.remoteIpData.setting.strategyInfo.strategyRuleSetId,a(l.remoteIpData.setting.strategyRules)})}function i(){for(var e=0;e<l.remoteIps.length;e++){var t=l.remoteIps[e];if(t.errors)return void(l.validIp=!1)}l.validIp=!0}var l=o;l.remoteIpData={setting:{}},r(),l.toRemove=[],l.isEditing=!1,l.edit=function(){r(),l.isEditing=!0},l.add=function(){l.remoteIps.unshift({ruleData:"",strategyRuleName:"",errors:!0}),l.validIp=!1},l.initialAdd=function(){l.isEditing=!0,l.add()},l.remove=function(e,t){return void 0===t?(l.remoteIps.splice(e,1),void i()):(l.toRemove.push(t),l.remoteIps.splice(e,1),void(l.isEditing=!0))},l.refresh=function(){l.isEditing=!1,r()},l.closeAll=function(){var t;for(t=0;t<l.remoteIps.length;t++)e.deleteRemoteIp(l.remoteIps[t].strategyRuleId);for(t=0;t<l.toRemove.length;t++)e.deleteRemoteIp(l.toRemove[t]);var n={strategyRuleSetId:l.remoteIpData.setting.strategyInfo.strategyRuleSetId,strategyRuleCode:"EQ",ruleData:"0.0.0.0/0",strategyRuleName:"允许所有IP地址访问",rulePriority:0,disabled:!1,strategyRuleIdentifier:"VALID_IP"};e.createRemoteIp(n).then(function(){l.remoteIpsEnable=!1,l.refresh()})},l.confirm=function(){var t,o,a=[];for(t=0;t<l.remoteIps.length;t++)if(o=l.remoteIps[t],o.strategyRuleId)delete o.errors,a.push(e.updateRemoteIp(o));else{var r={strategyRuleSetId:l.remoteIpData.setting.strategyInfo.strategyRuleSetId,strategyRuleCode:"EQ",ruleData:o.ruleData,strategyRuleName:o.strategyRuleName,rulePriority:0,disabled:!1,strategyRuleIdentifier:"VALID_IP"};a.push(e.createRemoteIp(r))}for(t=0;t<l.toRemove.length;t++)a.push(e.deleteRemoteIp(l.toRemove[t]));n.all(a).then(function(){l.refresh()})},l.checkIp=function(e){l.validIp=e.ruleData&&e.ruleData.length>0&&!t.validateIpRange(e.ruleData),e.errors=!l.validIp,l.validIp&&i()}}var a={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/setting/systemconsole/remote-ip.89235ea4.html",link:o};return a}function t(){function e(e,t,n,o,a,r,i,l,s){function c(){for(var e in m.protocols)m.protocols[e]&&(m.protocols[e].message="")}function d(e){var t=+e;return t>=1&&t<=65535&&e===t.toString();
}function u(){var e=!1;for(var t in m.protocols)m.protocols[t]&&!m.protocols[t].disabled&&(m.protocols[t].protocolPort&&0!==m.protocols[t].protocolPort.length?d(m.protocols[t].protocolPort.toString())||(m.protocols[t].message="请输入合法的端口码",e=!0):(m.protocols[t].message="请输入端口码",e=!0));return!e}function p(){var e,t,n,o=!1;for(n=m.protocols.length,e=0;e<n;e++)if(!m.protocols[e].disabled&&m.protocols[e].protocolPort&&0!==m.protocols[e].protocolPort.length)for(t=e+1;t<n;t++)!m.protocols[t].disabled&&m.protocols[t].protocolPort&&0!==m.protocols[t].protocolPort.length&&m.protocols[e].protocolPort.toString()===m.protocols[t].protocolPort.toString()&&(m.protocols[e].message="重复",m.protocols[t].message="重复",o=!0);return!o}function f(){var e=!1;for(var t in m.protocols)if(m.protocols[t]&&!m.protocols[t].disabled){if(!m.protocols[t].protocolPort||0===m.protocols[t].protocolPort.length)continue;for(var n in m.hiddenPorts)if(m.hiddenPorts[n].toString()===m.protocols[t].protocolPort.toString()){m.protocols[t].message=m.hiddenPorts[n]+"为网络端口，请输入其他端口码",e=!0;break}}return!e}e.refresh=function(){t.reload()};var m=this;m.reload=function(){var e="";n.isC02&&(e="BAOXIN"),o.getProtocols(e).then(function(e){m.protocols=e}),o.getHiddenPorts().then(function(e){m.hiddenPorts=e}),o.getProtocolSwitch().then(function(e){m.DPprotocols=e}),o.getFTPProtocols().then(function(e){m.FTPprotocols=e})},m.reload();var g={$filter:"(category eq SECURITY_DEVICE)"};r.getAll(g).then(function(e){m.devices=e}),m.noErrors=!0,m.editFTP=function(){m.oldFTPprotocols=angular.copy(m.FTPprotocols),m.isEditingFTP=!0},m.cancelFTP=function(){m.FTPprotocols=m.oldFTPprotocols,m.isEditingFTP=!1},m.confirmFTP=function(){o.updateAllDP(m.FTPprotocols.strategyRules[0]).then(function(){n.addAlert({type:"success",content:"协议部署成功"}),m.isEditingFTP=!1})},m.switchFTP=function(e){m.FTPprotocols.strategyRules[0].ruleData=e},m.enableAllDP=function(){m.DPprotocols.map(function(e){e.status=!0})},m.disableAllDP=function(){m.DPprotocols.map(function(e){e.status=!1})},m.editDP=function(){m.oldDPprotocols=angular.copy(m.DPprotocols),m.isEditingDP=!0},m.cancelDP=function(){m.DPprotocols=m.oldDPprotocols,m.isEditingDP=!1},m.showOfflineDeviceConfirmUI=function(e){function t(t,n){t.offlineDevices=[],t.onlineDevices=[],t.check={OfflineWarning:!1},r.getAll(g).then(function(o){o.map(function(e){1!==e.deviceOnline?t.offlineDevices.push(e):t.onlineDevices.push(e)}),t.cancel=function(){"DP"===e?m.cancelDP():"PP"===e&&m.cancelPP(),n.dismiss("cancel")},t.ok=function(){"DP"===e?m.confirmDP():"PP"===e&&m.showConfirmUIPP(),n.close("done")}})}t.$inject=["$scope","$modalInstance"];var n=a.open({templateUrl:"templates/setting/systemconsole/protocol-deviceOffline-confirm-panel.e55697fe.html",size:"sm",controller:t});n.result.then(function(){},function(){})},m.confirmDP=function(){for(var e="0",t=m.DPprotocols.length-1;t>=0;t--)e+=m.DPprotocols[t].status?1:0;e=parseInt(e,2);var a={icAccountingReport1:e},r=i.defer();n.protocolDeployTaskPromise=r.promise,o.setProtocolSwitch(a).then(function(e){var t=e.taskId;!function e(o){var a=l(function(){s.getTask(t).then(function(t){"SUCCESS"===t.data.state?(n.addAlert({type:"success",content:"协议开关下发成功"}),r.resolve("success"),l.cancel(a),m.isEditingDP=!1,m.reload()):"FAILED"===t.data.state?(n.addAlert({type:"danger",content:t.data.reason?"协议开关下发失败："+t.data.reason:"协议开关下发失败"}),r.resolve("fail"),l.cancel(a),m.isEditingDP=!1,m.reload()):"REJECTED"===t.data.state?(n.addAlert({type:"danger",content:t.data.reason?"协议开关下发失败："+t.data.reason:t.data.rejectReason?"协议开关下发失败："+t.data.rejectReason:"协议开关下发被拒绝"}),r.resolve("fail"),l.cancel(a),m.isEditingDP=!1,m.reload()):("PENDING"===t.data.state,o>0?e(o-1):(r.resolve("timeout"),n.addAlert({type:"danger",content:"协议开关下发超时"}),l.cancel(a),m.isEditingDP=!1,m.reload()))})},1e3)}(30)},function(e){n.addAlert({type:"danger",content:e.data.reason?"协议开关下发失败："+e.data.reason:e.data.rejectReason?"协议开关下发失败："+e.data.rejectReason:"协议开关下发失败"}),r.resolve("fail"),m.isEditingDP=!1,m.reload()})},m.switchDP=function(e,t){e.status=t},m.editPP=function(){m.oldprotocols=angular.copy(m.protocols),m.isEditingPP=!0},m.cancelPP=function(){m.protocols=m.oldprotocols,m.isEditingPP=!1},m.confirmPP=function(){o.updateAll(m.protocols).then(function(){m.isEditingPP=!1},function(e){for(var t in m.protocols)if(m.protocols[t]&&m.protocols[t].privateProtocolId===e.privateProtocolId&&e.info){m.protocols[t].message=e.info;break}})},m.showConfirmUIPP=function(){function e(e,t){e.msg={text:"",list:"",qus:"确定所有修改？"};for(var n=0;n<m.protocols.length;n++)0===m.oldprotocols[n].disabled&&1===m.protocols[n].disabled&&(e.msg.text+=e.msg.text?"":"请注意，关闭已经启用的私有协议会影响到引用过此私有协议的内容，包括：学习到的与此私有协议相关行为规则；引用此私有协议的手写规则；将来此事件的处理方式等。",e.msg.list+=e.msg.list?m.oldprotocols[n].protocolName+"， ":"以下私有协议将被关闭: "+m.oldprotocols[n].protocolName+"， ");e.cancel=function(){m.cancelPP(),t.dismiss("cancel")},e.done=function(){m.confirmPP(),t.close("done")}}e.$inject=["$scope","$modalInstance"];var t=a.open({templateUrl:"templates/privateprotocol/confirm-panel.d9f32561.html",size:"sm",controller:e});t.result.then(function(){},function(){})},m.switchPP=function(e,t){0===t&&e.protocolPort&&"-1"===e.protocolPort.toString()&&(e.protocolPort=""),e.disabled=t,this.checkAllPorts()},m.enableAllCustomProtocol=function(e){for(var t=0;t<m.protocols.length;t++){var n=m.protocols[t];m.switchPP(n,e)}},m.checkAllPorts=function(){c();var e=u(),t=p(),n=f();m.noErrors=e&&t&&n}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/setting/systemconsole/protocol-setting.6cd0822f.html",controller:e,controllerAs:"protocolsetting"};return t}function n(e,t,n,o,a,r,i,l){function s(s){function c(e){if(!e)return!0;for(var t=0;t<e.length;t++){var n=e[t];if(n.disabled)return!0}return!1}function d(){for(var e,t=s.customProtocolList.length-1;t>=0;t--)e=s.customProtocolList[t],delete e.error,delete e.nameError,e.protocolName&&e.protocolPort&&s.retList.push(s.customProtocolList[t]);for(var n=0;n<s.retList.length;n++)e=s.retList[n],delete e.error}s.editMode=!1,s.allowConfirm=!0,t.getPrivateProtocols("DEFAULT").then(function(e){s.originalProtocolList=e,s.protocolList=[],angular.copy(e,s.protocolList)}),t.getPrivateProtocols("CUSTOM").then(function(e){s.orininalCustomProtocolList=e,s.customProtocolList=[],angular.copy(e,s.customProtocolList)}),s.enableAll=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.disabled=!1}},s.disableAll=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.disabled=!0}},s.checkEnableAll=function(e,t){t&&("default"===e?s.enableAllDefault=!0:s.enableAllCustom=!0)},s.removeAllCustom=function(){function e(e,t){e.cancel=function(){t.dismiss("cancel")},e.ok=function(){t.close("done")}}e.$inject=["$scope","$modalInstance"];var t=n.open({templateUrl:"templates/setting/systemconsole/protocol-port-setting-remove-all-modal.b49eaf70.html",size:"sm",controller:e});t.result.then(function(){s.customProtocolList=[],s.validateAll()})},s.editPorts=function(){s.editMode=!0,s.validateAll(),s.enableAllDefault=c(s.protocolList),s.enableAllCustom=c(s.enableAllCustom),angular.copy(s.protocolList,s.originalProtocolList),angular.copy(s.customProtocolList,s.orininalCustomProtocolList)},s.cancel=function(){s.editMode=!1,angular.copy(s.originalProtocolList,s.protocolList),angular.copy(s.orininalCustomProtocolList,s.customProtocolList)},s.validateDefaultProtocol=function(t){t.protocolPort&&e.checkPortInput(t.protocolPort)?t.error=!1:t.error=!0},s.validateCustomProtocol=function(t){t.nameError=!t.protocolName||""===t.protocolName||!e.checkProtocolName(t.protocolName),t.error=!t.protocolPort||!e.checkPortInput(t.protocolPort)},s.validateAll=function(){var e,t;for(e=0;e<s.protocolList.length;e++)if(t=s.protocolList[e],t.error)return void(s.allowConfirm=!1);for(e=0;e<s.customProtocolList.length;e++)if(t=s.customProtocolList[e],t.error||t.nameError)return void(s.allowConfirm=!1);s.allowConfirm=!0},s.confirmUpdate=function(e){function c(e,t){e.offlineDevices=[],e.onlineDevices=[],e.check={OfflineWarning:!1};var n={$filter:"(category eq SECURITY_DEVICE)"};o.getAll(n).then(function(n){n.map(function(t){1!==t.deviceOnline?e.offlineDevices.push(t):e.onlineDevices.push(t)}),e.cancel=function(){t.dismiss("cancel")},e.ok=function(){t.close("done")}})}c.$inject=["$scope","$modalInstance"],s.retList=[],angular.copy(s.protocolList,s.retList),d();var u=n.open({templateUrl:"templates/setting/systemconsole/protocol-deviceOffline-confirm-panel.e55697fe.html",size:"sm",controller:c});u.result.then(function(){var n=r.defer();a.protocolDeployTaskPromise=n.promise,t.updatePrivateProtocols(s.retList).then(function(t){var o=t.data.taskId;!function t(r){var c=i(function(){l.getTask(o).then(function(o){"SUCCESS"===o.data.state?(a.addAlert({type:"success",content:e+"下发成功"}),n.resolve("success"),i.cancel(c),s.editMode=!1):"FAILED"===o.data.state?(a.addAlert({type:"danger",content:o.data.reason?e+"下发失败："+o.data.reason:e+"下发失败"}),n.resolve("fail"),i.cancel(c)):"REJECTED"===o.data.state?(a.addAlert({type:"danger",content:o.data.reason?e+"下发失败："+o.data.reason:o.data.rejectReason?e+"下发失败："+o.data.rejectReason:e+"下发被拒绝"}),n.resolve("fail"),i.cancel(c)):("PENDING"===o.data.state,r>0?t(r-1):(n.resolve("timeout"),a.addAlert({type:"danger",content:e+"下发超时"}),i.cancel(c)))})},1e3)}(30)},function(t){a.addAlert({type:"danger",content:t.data.reason?e+"下发失败："+t.data.reason:t.data.rejectReason?e+"下发失败："+t.data.rejectReason:e+"下发失败"}),n.resolve("fail")})})},s.addCustomProtocol=function(){s.customProtocolList.push({protocolName:"",protocolType:"TCP",protocolPort:"",dataType:"CUSTOM",disabled:!0,error:!0,nameError:!0})},s.validatePortObj=function(t){t.error=!e.checkPortInput(t.protocolPort)},s.removeCustomPort=function(e){s.customProtocolList.splice(e,1)}}var c={restrict:"E",replace:!0,templateUrl:"/templates/setting/systemconsole/protocol-port-setting.c0524d22.html",link:s};return c}function o(){function e(e,t,n,o,a,r,i){var l=this,s={};s.$filter="infoType eq MW",r.getDebuginfoCollection(s).then(function(e){t.dbgInfo=e[0]});var c=function(t){return e.go(e.current,t,{reload:!0,inherit:!1,notify:!0})};l.collectMWDebugInfo=function(){function e(e,t,n,r){t.ok=function(){var t="DEBUG_INFO_COLLECTION";e.mwCollecting=!0;var l=e.$on("debuginfoCollect",function(n,r){"mw"===r.name&&!function n(s){var d=a(function(){i.getTask(r.taskId).then(function(r){"SUCCESS"===r.data.state?(c({tab:t}).then(function(){e.addAlert({type:"success",content:r.data.reason?"信息收集成功："+r.data.reason:"信息收集成功"}),e.mwCollecting=!1}),a.cancel(d),l()):"FAILED"===r.data.state?(c({tab:t}).then(function(){e.addAlert({type:"danger",content:r.data.reason?"信息收集失败："+r.data.reason:"信息收集失败"}),e.mwCollecting=!1}),a.cancel(d),l()):s>0?n(s-1):(o.info("Task state was invalid."),e.addAlert({type:"danger",content:"无法获取信息收集任务结果，请联系管理员。"}),e.mwCollecting=!1)})},1e3)}(5)}),s={};s.infoType="MW",s.infoCollectionType="DEBUG",r.collectDebuginfo(s,function(t,o){n.close(),o&&(e.addAlert({type:"danger",content:o.rejectReason?"信息收集失败："+o.rejectReason:"信息收集失败"}),e.mwCollecting=!1)})},t.cancel=function(){n.dismiss("cancel")}}e.$inject=["$rootScope","$scope","$modalInstance","Device"];var t=n.open({templateUrl:"debuginfo-mw-collection-confirmation.html",size:"sm",controller:e});t.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var t={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/setting/systemconsole/debug-info-collection.2ef648f7.html",controller:e,controllerAs:"debuginfo"};return t}function a(e,t,n,o,a,r,i,l,s,c,d){function u(u,p,f,m){function g(e){e.$orderby&&""!==e.$orderby||(e.$orderby="name");var n=e||{};return n.$filter=I,i.getAll(n).then(function(e){var n={};return n.$filter="infoType eq DEVICE",i.getDebuginfoCollection(n).then(function(n){var o={};n.map(function(e){o[e.deviceId]=e});var a=e.map(function(e){return l.getDeviceNodes(e.deviceId)});return a.length?t.all(a).then(function(t){return e.map(function(n,a){for(var r=[],i=0;i<t[a][0].ports.length;i++)r.push(+t[a][0].ports[i].substr(1));var l=r.sort();t[a][0].portRange="p"+l[0]+"-p"+l[l.length-1],e[a].nodes=t[a],e[a].debuginfo=o[e[a].deviceId]}),y(e)}):[]})})}function h(e){var t=e||{};return t.$filter=I,i.getCount(t,d.id)}function v(e){return i.search("SECURITY_DEVICE",e)}function y(e){for(var t in e)if(t&&e[t].nodes)for(var n in e[t].nodes)if(n&&e[t].nodes[n].ports&&"IPS"===e[t].nodes[n].type&&1===e[t].nodes[n].online)for(var o in e[t].nodes[n].ports){if(1!==e[t].nodes[n].online)break;if(o&&e[t].nodes[n].ports[o])for(var a in e[t].devicePorts)if(a&&e[t].devicePorts[a].portName===e[t].nodes[n].ports[o]&&1!==e[t].devicePorts[a].linkState){e[t].nodes[n].online=e[t].devicePorts[a].linkState;break}}return e}var I="(category eq SECURITY_DEVICE)",D=s.get("Role");if(!D[0].defaultRole){var T=s.get("deviceAccess");T.length?(I+=" and (",I+=T.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),I+=")"):I+=" and (contains(deviceId, 'null'))"}m.disableToolbar=!0,m.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:g,getCount:h,search:v});var b=function(e){return a.go(a.current,e,{reload:!0,inherit:!1,notify:!0})};m.isDeviceOffline=function(e){return!(1===e.deviceOnline&&"DISCOVERY"===e.deviceSource)},m.selectAll=function(){m.selectedItems={},m.table.map(function(e){m.isDeviceOffline(e)||(m.selectedItems[e.deviceId]=m.selectAllValue)})},m.collectDpiDebugInfo=function(t){function a(t,n,a){t.ok=function(){var t="DEBUG_INFO_COLLECTION";if(void 0!==e.dpiCollecting)for(var l in e.dpiCollecting)if(e.dpiCollecting[l]===!0)return n.close(),void e.addAlert({type:"danger",content:"信息收集失败：另外一个任务还没有完成,请稍后再部署"});e.dpiCollecting={},e.dpiCollectingError={},e.dpiCollectingMessage={},i.map(function(t){e.dpiCollecting[t]=!0,e.dpiCollectingError[t]=!1,e.dpiCollectingMessage[t]=""});var s=e.$on("debuginfoCollect",function(n,a){"mw"!==a.name&&!function n(i){var l=r(function(){c.getTask(a.taskId).then(function(c){var d=a.name;"PROCESSING"===c.data.state?(b().then(function(){e.dpiCollecting[d]=!1}),a.exception?(e.dpiCollectingError[d]=!0,e.dpiCollectingMessage[d]=a.exception):e.dpiCollectingMessage[d]="信息收集完成",r.cancel(l)):"SUCCESS"===c.data.state?(b({tab:t}).then(function(){e.addAlert({type:"success",content:c.data.reason?"信息收集完成："+c.data.reason:"信息收集完成"}),e.dpiCollecting={}}),a.exception?(e.dpiCollectingError[d]=!0,e.dpiCollectingMessage[d]=a.exception):e.dpiCollectingMessage[d]="信息收集完成",r.cancel(l),s()):"FAILED"===c.data.state?(b({tab:t}).then(function(){e.addAlert({type:"danger",content:c.data.reason?"信息收集完成："+c.data.reason:"信息收集失败"}),e.dpiCollecting={}}),a.exception?(e.dpiCollectingError[d]=!0,e.dpiCollectingMessage[d]=a.exception):e.dpiCollectingMessage[d]="信息收集完成",r.cancel(l),s()):i>0?n(i-1):(o.info("Task state was invalid."),e.addAlert({type:"danger",content:"无法获取信息收集任务结果，请联系管理员。"}),e.dpiCollecting={})})},1e3)}(5)});if(0!==i.length){var d={};d.infoType="DEVICE",d.deviceIds=i,d.infoCollectionType="DEBUG",a.collectDebuginfo(d,function(t,o){n.close(),o&&(e.addAlert({type:"danger",content:o.rejectReason?"信息收集失败："+o.rejectReason:"信息收集失败"}),e.dpiCollecting={})})}else e.addAlert({type:"info",content:"请至少选中一台设备"}),n.close()},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance","Device"];var i=[];if(Array.isArray(t))i=t;else for(var l in t)t[l]&&i.push(l);var s=n.open({templateUrl:"debuginfo-dpi-collection-confirmation.html",size:"sm",controller:a});s.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var p={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/setting/systemconsole/debug-info-dpi-table.b3145611.html",link:u};return p}function r(){function e(e,t,n,o,a,r,i,l){var s=this;s.target=t.target,s.isMW="MW"===t.target,s.disabled=1;var c=function(){var e="CONF_BACKUP_"+t.target;i.getJobStrategyInfo(e).then(function(e){e.data&&(s.confAutoBackUp=e.data,"1"===e.data.schedulingJob.jobData?s.disabled=1:s.disabled=0)})};c(),s.switchBackUpStrategy=function(e){s.disabled=e,s.confAutoBackUp.schedulingJob.jobData=e,r.all([i.updateStradegyJobBuilder(s.confAutoBackUp)]).then(function(){c()})};var d=function(t){return e.go(e.current,t,{reload:!0,inherit:!1,notify:!0})};s.doConfBackUp=function(){function e(e,t,n,i){t.ok=function(){var t="CONFIGURATION_BACKUP",c=r.defer();e.mwConfBackUpPromise=c.promise;var u=e.$on("confBakCollect",function(n,r){"mw"===r.name&&!function n(i){var s=a(function(){l.getTask(r.taskId).then(function(r){"SUCCESS"===r.data.state?(d({tab:t}).then(function(){c.resolve("success"),e.addAlert({type:"success",content:r.data.reason?"配置备份成功："+r.data.reason:"配置备份成功"})}),a.cancel(s),u()):"FAILED"===r.data.state?(d({tab:t}).then(function(){c.resolve("fail"),e.addAlert({type:"danger",content:r.data.reason?"配置备份失败："+r.data.reason:"配置备份失败"})}),a.cancel(s),u()):i>0?n(i-1):(o.info("Task state was invalid."),c.resolve("fail"),e.addAlert({type:"danger",content:"无法获取配置备份任务结果，请联系管理员。"}))})},1e3)}(5)}),p={};p.infoType=s.target,p.infoCollectionType="CONF_BACKUP",i.doConfBackUp(p,function(t,o){n.close(),o&&(c.resolve("fail"),e.addAlert({type:"danger",content:o.rejectReason?"配置备份失败："+o.rejectReason:"配置备份失败"}))})},t.cancel=function(){n.dismiss("cancel")}}e.$inject=["$rootScope","$scope","$modalInstance","Device"];var t=n.open({templateUrl:"conf-backup-mw-collection-confirmation.html",size:"sm",controller:e});t.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var t={scope:{target:"@"},restrict:"E",replace:!0,templateUrl:"/templates/setting/systemconsole/configuration-backup.ec1bb1c8.html",controller:e,controllerAs:"backup"};return t}function i(e,t,n,o,a){function r(r,i,l,s){function c(e){var t=e||{};return t.$filter=p,a.getConfBackUpInfos(t)}function d(e){var t=e||{};return t.$filter=p,a.getConfBackUpInfoCount(t)}function u(e){var t=e||{};return t.$filter=t.$filter+" and "+p,a.getConfBackUpInfos(t)}var p="infoType eq MW";s.disableToolbar=!0,s.setConfig({name:"file",pagination:!0,scrollable:!1,totalCount:!0,getAll:c,getCount:d,search:u});var f=function(e){return o.go(o.current,e,{reload:!0,inherit:!1,notify:!0})};s.selectAll=function(){s.selectedItems={},s.table.map(function(e){s.selectedItems[e.backupFileInfoId]=s.selectAllValue})},s.deleteBackUpFiles=function(o){function a(t,n,o){t.ok=function(){var t="CONFIGURATION_BACKUP";0!==r.length?o.deleteBackUpFiles(r,function(o){n.close(),o?e.addAlert({type:"danger",content:o.data?"文件删除失败："+o.data:"文件删除失败"}):f({tab:t}).then(function(){e.addAlert({type:"success",content:"文件删除成功"})})}):(e.addAlert({type:"info",content:"请至少选中一个文件"}),n.close())},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance","Device"];var r=[];if(Array.isArray(o))r=o;else for(var i in o)o[i]&&r.push(i);var l=t.open({templateUrl:"conf-backup-mw-delete-confirmation.html",size:"sm",controller:a});l.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})}}var i={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/setting/systemconsole/configuration-backup-mw-table.c420536c.html",link:r};return i}function l(e,t,n){function o(){}function a(){var o=this;o.valid=!0,o.isEditing=!1,o.editRunningMode=function(){o.isEditing=!0,o.validate()},o.confirmEdit=function(){var t={runningMode:o.runningMode,autoDiscovery:o.autoDiscovery,remoteMwIp:o.autoDiscovery?"":o.remoteMwIp},a=[];a.push(e.saveRunningMode(t));var r=n.defer();o.configPromise=r.promise,n.all(a).finally(function(){o.loadRunningMode(),o.isEditing=!1,o.configPromise=null})},o.cancel=function(){o.isEditing=!1,o.loadRunningMode()},o.activeRunningMode=function(e){var t=o.runningModes.some(function(t){return t.mode===e});t&&(o.runningMode=e)},o.isActive=function(e){return o.runningMode===e},o.loadRunningMode=function(){e.loadRunningMode().then(function(e){o.runningModes=e.runningModes,o.runningMode=e.runningMode,o.autoDiscovery=e.autoDiscovery,o.remoteMwIp=e.remoteMwIp})},o.canAutoDiscovery=function(){return 1===o.runningMode},o.canInputMwIp=function(){return o.isEditing&&1===o.runningMode&&!o.autoDiscovery},o.validate=function(){var e=o.canInputMwIp();e?o.remoteMwIp?o.valid=!t.validateIp(o.remoteMwIp):o.valid=!1:o.valid=!0},o.loadRunningMode()}var r={scope:!1,restrict:"E",replace:!0,templateUrl:"/templates/setting/systemconsole/running-mode-setting.61f60a18.html",link:o,controller:a,controllerAs:"runningModeSetting"};return r}e.$inject=["System","formatVal","$q"],n.$inject=["formatVal","PrivateProtocol","$modal","Device","$rootScope","$q","$timeout","Task"],a.$inject=["$rootScope","$q","$modal","$log","$state","$timeout","Device","Topology","Enum","Task","topologyId"],i.$inject=["$rootScope","$modal","$log","$state","Device"],l.$inject=["System","formatVal","$q"],angular.module("southWest.setting.systemconsole").directive("remoteIp",e).directive("protocolSetting",t).directive("protocolPortSetting",n).directive("debugInfoCollection",o).directive("debugInfoDpiTable",a).directive("configurationBackup",r).directive("confBackupMwTable",i).directive("runningModeSetting",l)}(),function(){"use strict";function e(e){e.state("setting.systemdevice",{url:"/systemdevice",params:{tab:null},controller:"SystemDeviceCtrl as sysdevice",templateUrl:"templates/setting/systemdevice/index.d4074ef9.html",resolve:{state:["$rootScope",function(e){e.currentState="SETTINGS_DPI_REBOOT SETTINGS_DPI_UPGRADE_RESET"}]}}).state("setting.systemdevice.backup",{parent:"setting",url:"/systemdevice/backup",params:{deviceid:null,deviceName:null},controller:"SystemDeviceBackUpCtrl",templateUrl:"templates/setting/systemdevice/configuration-backup-device-detail.69c8bd56.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.setting.systemdevice").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p){function f(){var e={},t="category eq SECURITY_DEVICE",n=c.get("Role");if(!n[0].defaultRole){var a=c.get("deviceAccess");a.length?(t+=" and (",t+=a.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),t+=")"):t+=" and (contains(deviceId, 'null'))"}e.$filter=t,e.$orderby="deviceId",o.getAll(e).then(function(e){m.dpiData=e,m.reset_selectDPI=[],m.upgrade_selectDPI=[],m.onlineDPI=[],m.dpiSNlist=[];for(var t=0;t<m.dpiData.length;t++){for(var n=0;n<m.dpiData[t].devicePorts.length;n++)m.dpiData[t].devicePorts[n].isMgmtPort&&(m.dpiData[t].ip=m.dpiData[t].devicePorts[n].portIp);m.reset_selectDPI.push(!1),m.upgrade_selectDPI.push(!1),m.dpiSNlist.push(m.dpiData[t].serialNumber),m.onlineDPI.push(1===m.dpiData[t].deviceOnline&&"DISCOVERY"===m.dpiData[t].deviceSource)}m.upgradeInfo().then(function(){for(var e=0;e<m.dpiData.length;e++){var t;if(m.dpiData[e].deviceId===m.upgradingDPIinfo[e].deviceId)t=m.upgradingDPIinfo[e];else for(var n=e;n<m.upgradingDPIinfo.length;n++)if(m.upgradingDPIinfo[n].deviceId===m.dpiData[e].deviceId){t=m.upgradingDPIinfo[n];break}m.dpiData[e].isUpgrading=!t||!("NONE"===t.state&&(0===t.percentage||100===t.percentage)||t.error)}})})}var m=this;m.simplifyModelName=u.simplifyModelName,f(),m.upgrade_dpiSelectAll=!1,m.reset_dpiSelectAll=!1,m.eventHandler={},m.variable={upgrade_stats:"NONE"};for(var g=d.getNode("SYSTEM_DEVICE_MANAGEMENT").getChilds(),h=["DEVICE_RESET","DEVICE_UPGRADE"],v=0;v<g.length;v++)if(g[v].getPrivilegeValue()>1){m.system_device_init_tab=h[v];break}null!==p.tab&&(m.system_device_init_tab=p.tab),m.getMenuFromTarget=function(e){if(s.parsedMenu&&s.parsedMenu[2])for(var t=0;t<s.parsedMenu[2].length;t++){var n=s.parsedMenu[2][t];if(n.target===e&&n.active)return n.description}return!1},m.systemConsoleTabEnabled=function(e){return!!m.getMenuFromTarget(e)},m.eventHandler.deviceHandler=s.$on("device",function(e,n){if(n.deviceOnline===-1||1===n.deviceOnline)for(var o=0;o<m.dpiData.length;o++)if(m.dpiData[o].deviceId===n.deviceId)return m.dpiData[o].deviceOnline=n.deviceOnline,void t.$apply()}),t.$on("destroy",function(){m.eventHandler.deviceHandler(),m.eventHandler.dpiUpgradeStateHandler()}),m.editRight=30===c.get("privilege").filter(function(e){return"DEVICE_MANAGEMENT"===e.name})[0].actionValue,m.uploader=new i({url:l+"/files/device/uploadimage",autoUpload:!0,queueLimit:1}),m.uploader.onErrorItem=function(e,t){m.uploadImageFail="invalid_file_format"===t.reason?"升级包文件无效":"无效的升级包文件或网络有问题"},m.uploader.onSuccessItem=function(e,t){m.upgradeImageInfo=t,m.changeUpdate()},m.validate={packageUploaded:!1,isUploading:!1,uploadFailed:!1},m.reset={type:"restart"},m.reset_selectAllDPI=function(){m.reset_selectDPI=[];for(var e=0;e<m.dpiData.length;e++)m.reset_selectDPI.push(m.reset_dpiSelectAll&&m.onlineDPI[e]&&!m.dpiData[e].isUpgrading)},m.confirmReset=function(){function t(e,t,r){e.title="设备重置","restart"===m.reset.type?(e.info="你现在选择以下设备重启:",e.confirmInfo="确定要重启吗？"):"reset"===m.reset.type?(e.info="你现在选择以下设备恢复原厂设置:",e.confirmInfo="此动作会将设备信息移除, 确定要恢复原厂设置吗？"):"shutdown"===m.reset.type&&(e.info="你现在选择关闭以下设备:",e.confirmInfo="确定要关闭吗？"),e.deviceList=n,e.cancel=function(){t.dismiss("cancel")},e.done=function(){"restart"===m.reset.type?r.restartDevice(o,a.id).then(function(e){s.addAlert({type:"success",content:"设备即将开始重启。请稍等。。。"})},function(e){s.addAlert({type:"danger",content:"设备重启没有成功。"})}):"reset"===m.reset.type?r.resetDevice(o,a.id).then(function(e){s.addAlert({type:"success",content:"设备即将开始恢复原厂设置。请稍等。。。"})},function(e){s.addAlert({type:"danger",content:"恢复原厂设置失败。"})}):"shutdown"===m.reset.type&&r.shutdownDevice(o,a.id).then(function(e){s.addAlert({type:"success",content:"设备即将关闭。请稍等。。。"})},function(e){s.addAlert({type:"danger",content:"关闭设备没有成功。"})}),m.reset_selectDPI=m.reset_selectDPI.map(function(e){e=!1}),m.reset_dpiSelectAll=!1,t.close("done")}}t.$inject=["$scope","$modalInstance","System"];for(var n=[],o=[],r=0;r<m.dpiData.length;r++)m.reset_selectDPI[r]&&(n.push(m.dpiData[r]),o.push({serialNumber:m.dpiData[r].serialNumber}));if(!n.length)return void s.addAlert({type:"danger",content:"没有选中任何设备。"});var i=e.open({templateUrl:"templates/setting/systemdevice/reset-panel.4f6da4eb.html",size:"sm",controller:t});i.result.then(function(e){},function(){})},m.isUpgrading=!1,m.downgradeWarning=!1,m.firstConfirmUpgrade=!1,m.showLastUpgrade=!1,m.upgrade_selectDPI=[],r.getUpgradeImageInfo().then(function(e){m.upgradeImageInfo=e.data}),m.eventHandler.dpiUpgradeStateHandler=s.$on("dpiUpgradeState",function(){f()}),m.upgrade_selectAllDPI=function(){m.upgrade_selectDPI=[];for(var e=0;e<m.dpiData.length;e++)m.upgrade_selectDPI.push(m.upgrade_dpiSelectAll&&(m.onlineDPI[e]||"-1"===m.dpiData[e].topologyId));m.changeUpdate()},m.changeUpdate=function(){var e={},t={};m.versionCompare=[];var n=m.upgradeImageInfo&&m.upgradeImageInfo.imageVersion?m.upgradeImageInfo.imageVersion.slice(m.upgradeImageInfo.imageVersion.indexOf("-")+1,m.upgradeImageInfo.imageVersion.lastIndexOf("-")):null;n&&(e.buildStr=n.slice(0,n.indexOf("-")),n=n.slice(0,n.lastIndexOf("-")),e.versionStr=n.slice(n.lastIndexOf("-")+1,n.length)),m.upgradelist=[],m.upgradeDevicelist=[];for(var o=0;o<m.dpiData.length;o++)m.upgrade_selectDPI[o]&&(m.upgradelist.push(m.dpiData[o].serialNumber),m.upgradeDevicelist.push(m.dpiData[o]));m.upgradeDevicelist.map(function(o){var a=o.version.slice(o.version.indexOf("-")+1,o.version.length);t.buildStr=a.slice(0,a.indexOf("-")),a=a.slice(0,a.lastIndexOf("-")),t.versionStr=a.slice(a.lastIndexOf("-")+1,a.length),m.versionCompare.push(n?t.buildStr>e.buildStr||t.buildStr===e.buildStr&&t.versionStr>e.versionStr?"LOWER":t.buildStr===e.buildStr&&t.versionStr===e.versionStr?"SAME":"HIGHER":"N/A")}),m.downgradeWarning=m.versionCompare&&m.versionCompare.filter(function(e){return"HIGHER"!==e}).length},m.upgrade_isAnySelected=function(){for(var e=0;e<m.upgrade_selectDPI.length;e++)if(m.upgrade_selectDPI[e])return!0},m.confirmUpgrade=function(){function t(e,t,n){e.title="设备升级",e.confirmInfo="确定要升级吗？",e.cancel=function(){t.dismiss("cancel")},e.done=function(){m.upgradelist.length&&n.upgradeDPI(m.upgradelist).then(function(e){"REJECTED"===e.data.state?s.addAlert({type:"danger",content:"升级失败，"+e.data.rejectReason}):m.firstConfirmUpgrade=!0}),t.close("done")}}t.$inject=["$scope","$modalInstance","System"],m.changeUpdate();var n=e.open({templateUrl:"templates/setting/systemdevice/upgrade-panel.d373da6f.html",size:"sm",controller:t});n.result.then(function(e){},function(){})},m.upgradeInfo=function(){for(var e="",t={NONE:0,COMMAND_RESOLVED:1,DOWNLOADING:2,UPGRADING:3},n=0;n<m.dpiSNlist.length;n++)e+="serialNumber="+m.dpiSNlist[n]+"&";return e=e?e.substring(0,e.length-1):"",e+="&$orderby=deviceId",e?r.getDPIUpgradeInfo(e).then(function(e){if(m.upgradingDPIinfo=e.data,m.upgradingDevices=[],m.upgradingDPIinfo){for(var n=0;n<m.upgradingDPIinfo.length;n++){for(var o=0;o<m.dpiData.length;o++)m.dpiData[o].deviceId===m.upgradingDPIinfo[n].deviceId&&m.upgradingDevices.push(m.dpiData[o]);m.upgradingDPIinfo[n].percentageShow=25*t[m.upgradingDPIinfo[n].state]+Math.round(m.upgradingDPIinfo[n].percentage/4),"NONE"===m.upgradingDPIinfo[n].state&&100===m.upgradingDPIinfo[n].percentage&&(m.upgradingDPIinfo[n].percentageShow=100),m.upgrade_selectDPI[o]&&m.upgradelist.push(m.dpiData[o].serialNumber)}m.isUpgrading=!!m.upgradingDPIinfo.filter(function(e){return("NONE"!==e.state||"NONE"===e.state&&0!==e.percentage&&100!==e.percentage)&&!e.error})[0],m.showLastUpgrade=!!m.isUpgrading||m.showLastUpgrade}else m.upgradingDPIinfo=[],m.isUpgrading=!1;return m.isUpgrading}):(m.upgradingDPIinfo=[],m.isUpgrading=!1,m.isUpgrading)}}function t(e,t){e.deviceid=t.deviceid,e.deviceName=t.deviceName}e.$inject=["$modal","$scope","domain","Device","topologyId","System","FileUploader","URI","$rootScope","Enum","uiTree","deviceTypeService","$stateParams"],t.$inject=["$scope","$stateParams"],angular.module("southWest.setting.systemdevice").controller("SystemDeviceCtrl",e).controller("SystemDeviceBackUpCtrl",t)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c){function d(a,d,u,p){function f(e){e.$orderby&&""!==e.$orderby||(e.$orderby="name");var n=e||{};return n.$filter=v,i.getAll(n).then(function(e){var n=e.map(function(e){return l.getDeviceNodes(e.deviceId)});return n.length?t.all(n).then(function(t){return e.map(function(n,o){for(var a=[],r=0;r<t[o][0].ports.length;r++)a.push(+t[o][0].ports[r].substr(1));var i=a.sort();t[o][0].portRange="p"+i[0]+"-p"+i[i.length-1],e[o].nodes=t[o]}),h(e)}):[]})}function m(e){var t=e||{};return t.$filter=v,i.getCount(t)}function g(e){return i.search("SECURITY_DEVICE",e)}function h(e){for(var t in e)if(t&&e[t].nodes)for(var n in e[t].nodes)if(n&&e[t].nodes[n].ports&&"IPS"===e[t].nodes[n].type&&1===e[t].nodes[n].online)for(var o in e[t].nodes[n].ports){if(1!==e[t].nodes[n].online)break;if(o&&e[t].nodes[n].ports[o])for(var a in e[t].devicePorts)if(a&&e[t].devicePorts[a].portName===e[t].nodes[n].ports[o]&&1!==e[t].devicePorts[a].linkState){e[t].nodes[n].online=e[t].devicePorts[a].linkState;break}}return e}var v="(category eq SECURITY_DEVICE)",y=s.get("Role");if(!y[0].defaultRole){var I=s.get("deviceAccess");I.length?(v+=" and (",v+=I.map(function(e){return"contains(deviceId, '"+e+"')"}).join(" or "),v+=")"):v+=" and (contains(deviceId, 'null'))"}p.disableToolbar=!0,p.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:f,getCount:m,search:g}),p.isDeviceOffline=function(e){return!(1===e.deviceOnline&&"DISCOVERY"===e.deviceSource)},p.selectAll=function(){p.selectedItems={},p.table.map(function(e){p.isDeviceOffline(e)||(p.selectedItems[e.deviceId]=p.selectAllValue)})},p.doConfBackUps=function(t){function a(t,n,a){t.ok=function(){if(void 0!==e.dpiBackingUp)for(var t in e.dpiBackingUp)if(e.dpiBackingUp[t]===!0)return n.close(),void e.addAlert({type:"danger",content:"配置备份失败：另外一个任务还没有完成,请稍后再部署"});e.dpiBackingUp={},e.dpiBackingUpError={},e.dpiBackingUpMessage={},i.map(function(t){e.dpiBackingUp[t]=!0,e.dpiBackingUpError[t]=!1,e.dpiBackingUpMessage[t]=""});var l=e.$on("confBakCollect",function(t,n){"mw"!==n.name&&!function t(a){var i=r(function(){c.getTask(n.taskId).then(function(s){var c=n.name;"PROCESSING"===s.data.state?(e.dpiBackingUp[c]=!1,n.exception?(e.dpiBackingUpError[c]=!0,e.dpiBackingUpMessage[c]=n.exception):e.dpiBackingUpMessage[c]="配置备份完成",
r.cancel(i)):"SUCCESS"===s.data.state?(e.addAlert({type:"success",content:s.data.reason?"配置备份完成："+s.data.reason:"配置备份完成"}),n.exception?(e.dpiBackingUpError[c]=!0,e.dpiBackingUpMessage[c]=n.exception):e.dpiBackingUpMessage[c]="配置备份完成",e.dpiBackingUp={},r.cancel(i),l()):"FAILED"===s.data.state?(e.addAlert({type:"danger",content:s.data.reason?"配置备份完成："+s.data.reason:"配置备份失败"}),n.exception?(e.dpiBackingUpError[c]=!0,e.dpiBackingUpMessage[c]=n.exception):e.dpiBackingUpMessage[c]="配置备份完成",e.dpiBackingUp={},r.cancel(i),l()):a>0?t(a-1):(o.info("Task state was invalid."),e.addAlert({type:"danger",content:"无法获取信息收集任务结果，请联系管理员。"}),e.dpiBackingUp={},e.dpiBackingUpError={})})},1e3)}(5)});if(0!==i.length){var s={};s.infoType="DEVICE",s.deviceIds=i,s.infoCollectionType="CONF_BACKUP",a.collectDebuginfo(s,function(t,o){n.close(),o&&(e.addAlert({type:"danger",content:o.rejectReason?"配置备份失败："+o.rejectReason:"配置备份失败"}),e.dpiBackingUp={})})}else e.addAlert({type:"info",content:"请至少选中一台设备"}),n.close()},t.cancel=function(){n.dismiss("cancel")}}a.$inject=["$scope","$modalInstance","Device"];var i=[];if(Array.isArray(t))i=t;else for(var l in t)t[l]&&i.push(l);var s=n.open({templateUrl:"configuration-backup-device-confirmation.html",size:"sm",controller:a});s.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})}}var u={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/setting/systemdevice/configuration-backup-device-table.9af6eb5b.html",link:d};return u}function t(e,t,n,o,a){function r(r,i,l,s){function c(e){var t=e||{};return t.$filter=p,a.getConfBackUpInfos(t)}function d(e){var t=e||{};return t.$filter=p,a.getConfBackUpInfoCount(t)}function u(e){var t=e||{};return t.$filter+=" and "+p,a.getConfBackUpInfos(t)}var p="(infoType eq DEVICE)";p=p.concat(" and (deviceId eq '"+l.deviceid+"')"),s.disableToolbar=!0,s.setConfig({name:"file",pagination:!0,scrollable:!1,totalCount:!0,getAll:c,getCount:d,search:u}),s.selectAll=function(){s.selectedItems={},s.table.map(function(e){s.selectedItems[e.backupFileInfoId]=s.selectAllValue})},s.deleteBackUpFiles=function(a){function r(t,n,a){t.ok=function(){0!==i.length?a.deleteBackUpFiles(i,function(t){n.close(),t?e.addAlert({type:"danger",content:t.data?"文件删除失败："+t.data:"文件删除失败"}):o.reload().then(function(){e.addAlert({type:"success",content:"文件删除成功"})})}):(e.addAlert({type:"info",content:"请至少选中一个文件"}),n.close())},t.cancel=function(){n.dismiss("cancel")}}r.$inject=["$scope","$modalInstance","Device"];var i=[];if(Array.isArray(a))i=a;else for(var l in a)a[l]&&i.push(l);var s=t.open({templateUrl:"conf-backup-device-delete-confirmation.html",size:"sm",controller:r});s.result.then(function(){},function(){n.info("Modal dismissed at: "+new Date)})}}var i={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/setting/systemdevice/configuration-backup-file-table.0676ca4b.html",link:r};return i}e.$inject=["$rootScope","$q","$modal","$log","$state","$timeout","Device","Topology","Enum","Task"],t.$inject=["$rootScope","$modal","$log","$state","Device"],angular.module("southWest.setting.systemdevice").directive("confBackupDeviceTable",e).directive("confBackupFileTable",t)}(),function(){"use strict";function e(e){e.state("strategy.anti_penetration",{url:"/anti_penetration",controller:"antiPenetrationCtrl as antiPenetrationCtrl",templateUrl:"templates/strategy/antiPenetration/index.652b93a1.html",resolve:{state:["$rootScope",function(e){e.currentState="STRATEGY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.strategy.anti_penetration").config(e)}(),function(){"use strict";function e(e,t,n,o,a){var r=this;r.dos=!1,r.dosid="",r.scanning=!1,r.scanningid="",r.editMode=!1,r.isShowTimeWarn=!1,r.isDisabledTimeText=!1,r.antiPenetrations=[],t.getAntiPenetrationSetting().then(function(e){r.antiPenetrations=e,r.antiPenetrations.map(function(e){"0"===e.attackValue&&(e.attackValue="")}),r.oldantiPenetrations=angular.copy(r.antiPenetrations),e.forEach(function(e){0===e.attackType?(r.dos=e.g_switch,r.dosid="dos"+e.attackType):(r.scanning=e.g_switch,r.scanningid="scanning"+e.attackType)})}),r.editChangeMode=function(){r.editMode=!r.editMode;var e=!1;r.antiPenetrations.map(function(t){1===t.attackType&&t.enable&&(e=!0)}),r.scanning&&r.editMode&&e&&(r.isDisabledTimeText=!0)},r.changeAntiPenetrations=function(e,t,n,o){r.setEnable=!1,e.toString().indexOf("dos")>=0?r.antiPenetrations.map(function(e){0===e.attackType&&(e.g_switch=t)}):e.toString().indexOf("scanning")>=0?r.antiPenetrations.map(function(e){1===e.attackType&&(e.g_switch=t)}):r.antiPenetrations.map(function(a){a.antiAttackId===e&&(a.g_switch=t,o||2===a.documentType?a.attackValue=n:a.attackValue="",a.enable=o)});var a=!1,i=!1;r.antiPenetrations.map(function(e){e.enable&&1===e.attackType&&1===e.documentType&&(r.antiPenetrations.map(function(e){1!==e.attackType||2!==e.documentType||e.attackValue&&r.isNormalInteger(e.attackValue)&&!(e.attackValue<=59)||(r.intervalErrorMessage=" 请在秒数区域输入大于等60的整数数字",i=!0)}),a=!0)}),r.isDisabledTimeText=a,r.isShowTimeWarn=i,r.antiPenetrations.map(function(e){1===e.attackType&&2===e.documentType&&e.attackValue&&!r.isDisabledTimeText&&(e.attackValue=""),(1===e.documentType&&e.enable&&(!r.isNormalInteger(e.attackValue)||e.attackValue<10)||r.isShowTimeWarn)&&(r.setEnable=!0)})},r.checkAttackValue=function(e,t){return!(!e||!r.editMode||r.isNormalInteger(t)&&!(t<10))},r.isNormalInteger=function(e){var t=~~Number(e);return t===parseFloat(e)},r.setAntiPenetrations=function(){var n=a.defer(),o="抗攻击配置";e.antiPenetrationDeployTaskPromise=n.promise,t.setAntiPenetrationSetting(r.antiPenetrations).then(function(a){"SUCCESS"===a.state&&(e.addAlert({type:"success",content:o+"下发成功"}),n.resolve("success"),t.getAntiPenetrationSetting().then(function(e){r.antiPenetrations=e,r.antiPenetrations.map(function(e){"0"===e.attackValue&&(e.attackValue="")}),r.oldantiPenetrations=angular.copy(r.antiPenetrations),e.forEach(function(e){0===e.attackType?(r.dos=e.g_switch,r.dosid="dos"+e.attackType):(r.scanning=e.g_switch,r.scanningid="scanning"+e.attackType)})}),r.editMode=!1)},function(t){e.addAlert({type:"danger",content:t.data.reason?o+"下发失败："+t.data.reason:t.data.rejectReason?o+"下发失败："+t.data.rejectReason:o+"下发失败"}),n.resolve("fail")})},r.cancelAntiPenetrations=function(){r.antiPenetrations=angular.copy(r.oldantiPenetrations),r.antiPenetrations.forEach(function(e){0===e.attackType?(r.dos=e.g_switch,r.dosid="dos"+e.attackType):(r.scanning=e.g_switch,r.scanningid="scanning"+e.attackType)}),r.editMode=!r.editMode,r.isShowTimeWarn=!1,r.isDisabledTimeText=!1}}e.$inject=["$rootScope","antiPenetration","Task","$timeout","$q"],angular.module("southWest.strategy.anti_penetration").controller("antiPenetrationCtrl",e)}(),function(){"use strict";function e(){}angular.module("southWest.strategy.anti_penetration").directive("dosSetting",e)}(),function(){"use strict";function e(e){e.state("strategy.nat_snat",{parent:"strategy",url:"/nat/snat",templateUrl:"templates/strategy/nat/snat.073a2a93.html"}).state("strategy.nat_dnat",{parent:"strategy",url:"/nat/dnat",templateUrl:"templates/strategy/nat/dnat.522893dd.html"})}e.$inject=["$stateProvider"],angular.module("southWest.strategy.nat").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s){function c(c,d,u,p){function f(e){return m(e)}function m(e){var t=e||{};return c.skip=e.$skip||0,n.getSNATAll(t)}function g(e){var t=e||{};return n.getSNATCount(t)}function h(e){var t=p.table;if(e&&t)for(var n=0;n<t.length;n++)if(t[n].snatName===e)return!0;return!1}function v(e){return!e||!i.validateObjectAssetsName(e)}function y(e){var t={};return t.snatName=e.snatName,t.sourceAddressType=e.sourceAddressType,t.sourceAddress=1===e.sourceAddressType?e.sourceAddressPool:e.sourceInterface,t.destinationAddressType=e.destinationAddressType,t.destinationAddress=1===e.destinationAddressType?e.destinationAddressPool:e.destinationInterface,t.serversAppsType=e.serversAppsType,t.serversApps=e.serversApps,t.transAddressType=e.transAddressType,t.transAddress=1===e.transAddressType?e.transAddressPool:e.transAddressIp,t}function I(e,t,l,s,c){function d(e){var t="";return angular.forEach(u,function(n,o){angular.forEach(n,function(n){n===e&&(t=o)})}),t}e.interfaceList=l[0],e.securityAreaList=[],e.sourceAddressPoolList=[],e.destinationAddressPoolList=[],e.transAddressAddressPoolList=[];var u={};angular.forEach(l[1],function(e){var t=e.securityAreaName?e.securityAreaName:"其他区域",n=e.addressPoolName?e.addressPoolName:"";u[t]?u[t].push(n):u[t]=[n]}),angular.forEach(u,function(t,n){e.securityAreaList.push(n)}),e.securityAreaList.length>0&&(e.sourceAddressPoolList=u[e.securityAreaList[0]],e.destinationAddressPoolList=u[e.securityAreaList[0]],e.transAddressPoolList=u[e.securityAreaList[0]]),e.snatData={},"add"===s?(e.snatData={sourceAddressType:0,sourceInterface:e.interfaceList[0],sourceSecurityArea:e.securityAreaList?e.securityAreaList[0]:"",sourceAddressPool:e.sourceAddressPoolList?e.sourceAddressPoolList[0]:"",destinationAddressType:0,destinationInterface:e.interfaceList[0],destinationSecurityArea:e.securityAreaList?e.securityAreaList[0]:"",destinationAddressPool:e.destinationAddressPoolList?e.destinationAddressPoolList[0]:"",serversAppsType:0,transAddressType:0,transAddressSecurityArea:e.securityAreaList?e.securityAreaList[0]:"",transAddressPool:e.transAddressPoolList?e.transAddressPoolList[0]:""},e.isEditing=!1):(e.snatData=angular.copy(c),e.snatData.sourceInterface=0===e.snatData.sourceAddressType?e.snatData.sourceAddress:e.interfaceList[0],e.snatData.sourceSecurityArea=1===e.snatData.sourceAddressType?d(e.snatData.sourceAddress):e.securityAreaList?e.securityAreaList[0]:"",e.snatData.sourceAddressPool=1===e.snatData.sourceAddressType?e.snatData.sourceAddress:e.sourceAddressPoolList?e.sourceAddressPoolList[0]:"",e.snatData.destinationInterface=0===e.snatData.destinationAddressType?e.snatData.destinationAddress:e.interfaceList[0],e.snatData.destinationSecurityArea=1===e.snatData.destinationAddressType?d(e.snatData.destinationAddress):e.securityAreaList?e.securityAreaList[0]:"",e.snatData.destinationAddressPool=1===e.snatData.destinationAddressType?e.snatData.destinationAddress:e.destinationAddressPoolList?e.destinationAddressPoolList[0]:"",e.snatData.transAddressIp=0===e.snatData.transAddressType?e.snatData.transAddress:"",e.snatData.transAddressSecurityArea=1===e.snatData.transAddressType?d(e.snatData.transAddress):e.securityAreaList?e.securityAreaList[0]:"",e.snatData.transAddressPool=1===e.snatData.transAddressType?e.snatData.transAddress:e.transAddressPoolList?e.transAddressPoolList[0]:"",e.selectedObj={title:e.snatData.serversApps},e.isEditing=!0),e.error={snatName:"add"===s,sourceAddress:!e.interfaceList||0===e.interfaceList.length,destinationAddress:!e.interfaceList||0===e.interfaceList.length,transAddress:"add"===s},e.validateAddress=function(e){return i.validateIp(e)},e.changeSnat_transAddress_ipaddress=function(){e.error.transAddress=e.validateAddress(e.snatData.transAddressIp)},e.searchServiceApps=function(t){return 1===e.snatData.serversAppsType?o.searchApps(t):o.searchServices(t)},e.$watch("snatData.sourceSecurityArea",function(t,n){e.sourceAddressPoolList=u[t],t===n&&"add"!==s||(e.snatData.sourceAddressPool=e.sourceAddressPoolList?e.sourceAddressPoolList[0]:"")}),e.$watch("snatData.destinationSecurityArea",function(t,n){e.destinationAddressPoolList=u[t],t===n&&"add"!==s||(e.snatData.destinationAddressPool=e.destinationAddressPoolList?e.destinationAddressPoolList[0]:"")}),e.$watch("snatData.transAddressSecurityArea",function(t,n){e.transAddressPoolList=u[t],t===n&&"add"!==s||(e.snatData.transAddressPool=e.transAddressPoolList?e.transAddressPoolList[0]:"")}),e.$watch("snatData.sourceAddressType",function(t){1===t?e.error.sourceAddress=!(void 0!==e.sourceAddressPoolList&&e.sourceAddressPoolList.length>0):e.error.sourceAddress=!(void 0!==e.interfaceList&&e.interfaceList.length>0)}),e.$watch("snatData.destinationAddressType",function(t){1===t?e.error.destinationAddress=!(void 0!==e.destinationAddressPoolList&&e.destinationAddressPoolList.length>0):e.error.destinationAddress=!(void 0!==e.interfaceList&&e.interfaceList.length>0)}),e.$watch("snatData.transAddressType",function(t){1===t?e.error.transAddress=!(void 0!==e.transAddressPoolList&&e.transAddressPoolList.length>0):e.error.transAddress=e.validateAddress(e.snatData.transAddressIp)}),e.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',e.checkNameVal=function(t){var n=v(t);n||(n=h(t),e.nameValMsg=n?"已创建该名称的SNAT，请更换其他SNAT名称":'支持中文、字母、数字、"-"、"_"的组合，3-20个字符'),e.error.snatName=n},e.ok=function(){var o=r.defer();e.configPromise=o.promise,n.addSNATData(y(e.snatData)).then(function(){T().then(function(){a.addAlert({type:"success",content:"SNAT策略添加成功"})})},function(e){a.addAlert({type:"danger",content:e.data?"SNAT策略添加失败："+e.data.error:"SNAT策略添加失败"})}).finally(function(){e.configPromise=null,t.close("done")})},e.cancel=function(){t.dismiss("cancel")}}I.$inject=["$scope","$modalInstance","data","type","snatData"];var D=["snatName","sourceAddress","destinationAddress","serversApps","transAddress"];p.setConfig({name:"item",numPerPage:10,pagination:!0,scrollable:!1,totalCount:!0,getAll:m,getCount:g,search:f,fields:D,advancedSearch:"item",advancedSearchOptions:[{name:"snatName",display:"策略名称",input:"string",option:!1,value:""},{name:"sourceAddress",display:"源地址",input:"string",option:!1,value:""},{name:"destinationAddress",display:"目的地址",input:"string",option:!1,value:""},{name:"serversApps",display:"服务/应用",input:"string",option:!1,value:""},{name:"transAddress",display:"转换地址",input:"string",option:!1,value:""}]}),p.selectedItems={},p.selectAll=function(){p.selectedItems={},p.table.forEach(function(e){p.selectedItems[e.snatId]=p.selectAllValue})},p.selectItem=function(){var e=!1,t=!0;p.table.forEach(function(n){p.selectedItems[n.snatId]?e=!0:t=!1}),e===!0&&t===!1?p.selectAllValue=null:e===!0&&t===!0?p.selectAllValue=!0:p.selectAllValue=!1},c.switchMsg="",c.isSwitching={},p.changeStatus=function(e,t){var o=r.defer();if(p.changeStatusPromise=o.promise,c.switchMsg=e[t]===!0?"启动":"停止",c.isSwitching[t]&&c.isSwitching[t][e.snatName])c.isSwitching[t][e.snatName]=!0;else{var i={};i[e.snatName]=!0,c.isSwitching[t]=i}"status"===t&&n.switchSNATStatus(e).then(function(){a.addAlert({type:"success",content:"SNAT"+e.snatName+c.switchMsg+"成功"})},function(t){e.status=!e.status,a.addAlert({type:"danger",content:"SNAT:"+e.snatName+c.switchMsg+"失败："+(t.data?"："+t.data.error:"")})}).finally(function(){c.isSwitching[t][e.snatName]=!1,o.resolve()})};var T=function(e){return s.go(s.current,e,{reload:!0,inherit:!1,notify:!0})};p.addNew=function(){r.all([l.getInterfaceNames({$filter:"(interfaceType eq 'ETH')"}),n.getAddressPools()]).then(function(n){var o=e.open({templateUrl:"/templates/strategy/nat/snatAdd.6e3cea68.html",size:"sm",backdrop:"static",controller:I,resolve:{type:function(){return"add"},data:function(){return n},snatData:function(){return{}}}});o.result.then(function(){},function(){t.info("Modal dismissed at: "+new Date)})})},p.edit=function(o){r.all([l.getInterfaceNames({$filter:"(interfaceType eq 'ETH')"}),n.getAddressPools()]).then(function(n){var a=e.open({templateUrl:"/templates/strategy/nat/snatAdd.6e3cea68.html",size:"sm",backdrop:"static",controller:I,resolve:{type:function(){return"edit"},data:function(){return n},snatData:function(){return o}}});a.result.then(function(){},function(){t.info("Modal dismissed at: "+new Date)})})},p.delete=function(){var e=p.selectedItems,t=[];if(e)for(var o in e)if(e[o])for(var i=0;i<p.table.length;i++)p.table[i].snatId+""===o&&t.push(p.table[i]);if(0!==t.length){var l=r.defer();p.deletePromise=l.promise,n.deleteSNATData(t).then(function(){a.addAlert({type:"success",content:"SNAT删除成功"})},function(e){l.resolve("fail"),a.addAlert({type:"danger",content:"SNAT删除失败"+(e.data?"："+e.data.error:"")})}).finally(function(){l.resolve()})}else a.addAlert({type:"info",content:"请至少选中一条SNAT"})}}var d={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/strategy/nat/snatTable.ede8f11b.html",link:c};return d}function t(e,t,n,o,a,r,i){function l(l,s,c,d){function u(e){return p(e)}function p(e){var t=e||{};return l.skip=e.$skip||0,r.getDNATAll(t)}function f(e){var t=e||{};return r.getDNATCount(t)}function m(e){return!(e&&!i.validateObjectAssetsName(e))}function g(e){var t=d.table;if(e&&t)for(var n=0;n<t.length;n++)if(t[n].dnatName===e)return!0;return!1}var h=["dnatName","destinationAddress","serversApps","mappingAddress","mappingPort"];d.setConfig({name:"item",numPerPage:10,pagination:!0,scrollable:!1,totalCount:!0,getAll:p,getCount:f,search:u,fields:h,advancedSearch:"item",advancedSearchOptions:[{name:"dnatName",display:"策略名称",input:"string",option:!1,value:""},{name:"destinationAddress",display:"目的地址",input:"string",option:!1,value:""},{name:"serversApps",display:"服务/应用",input:"string",option:!1,value:""},{name:"mappingAddress",display:"映射IP",input:"string",option:!1,value:""},{name:"mappingPort",display:"映射端口",input:"string",option:!1,value:""}]}),l.switchMsg="",l.isSwitching={status:{},logs:{}},d.changeStatus=function(t,n){if(l.switchMsg=t[n]===!0?"开启":"关闭",l.isSwitching[n]&&l.isSwitching[n][t.dnatName])l.isSwitching[n][t.dnatName]=!0;else{var o={};o[t.dnatName]=!0,l.isSwitching[n][t.dnatName]=!0}"status"===n?r.switchDNATStatus(t).then(function(){e.addAlert({type:"success",content:t.dnatName+l.switchMsg+"成功"})},function(n){t.status=!t.status,e.addAlert({type:"danger",content:t.dnatName+l.switchMsg+"失败："+(n.data?"："+n.data:"")})}).finally(function(){l.isSwitching[n][t.dnatName]=!1}):"logs"===n&&r.switchDNATLogs(t).then(function(){e.addAlert({type:"success",content:t.dnatName+l.switchMsg+"日志成功"})},function(n){t.logs=!t.logs,e.addAlert({type:"danger",content:t.dnatName+l.switchMsg+"日志失败："+(n.data?"："+n.data:"")})}).finally(function(){l.isSwitching[n][t.dnatName]=!1})};var v=function(e){return a.go(a.current,e,{reload:!0,inherit:!1,notify:!0})};d.addNew=function(){function a(n,o){n.dnatData={destinationAddressType:0,destinationAddress:"",serversAppsType:0,mappingAddressType:0,mappingAddress:""},n.isEditing=!1,n.error={dnatName:!0,destinationAddress:!0,serversApps:!0,mappingAddress:!0},n.isGettingAddressPools=!0,r.getAddressPools().then(function(e){n.securityAreas=[],n.addressaddressPools=[],n.addressaddressPool=[];var t="其他";if(e)for(var o=0;o<e.length;o++)e[o].securityAreaName||(e[o].securityAreaName="其他"),e[o].securityAreaName!==t&&(n.securityAreas.push(t),t=e[o].securityAreaName,n.addressaddressPool.length&&(n.addressaddressPools.push(n.addressaddressPool),n.addressaddressPool=[])),n.addressaddressPool.push(e[o].addressPoolName),o===e.length-1&&(n.securityAreas.push(t),n.addressaddressPool.length&&n.addressaddressPools.push(n.addressaddressPool));n.securityAreaName=n.securityAreas[0],n.destAddresses=n.addressaddressPools[0],n.destAddressesName=n.destAddresses[0],n.mappingSecurityAreaName=angular.copy(n.securityAreaName),n.mappingAddresses=angular.copy(n.destAddresses),n.mappingAddressesName=angular.copy(n.destAddressesName),n.isGettingAddressPools=!1},function(){n.isGettingAddressPools=!1}),n.changeDestType=function(e){1===e?n.error.destinationAddress=!1:n.error.destinationAddress=i.validateIp(n.dnatData.destinationAddress)},n.changeSecurityArea=function(e,t){n.securityAreaName=t,n.destAddresses=n.addressaddressPools[e],n.destAddressesName=n.addressaddressPools[e][0]},n.changeDestAddress=function(e){n.destAddressesName=e},n.changeMappingType=function(e){1===e?n.error.mappingAddress=!1:n.error.mappingAddress=i.validateIp(n.dnatData.mappingAddress)},n.changeMappingSecurityArea=function(e,t){n.mappingSecurityAreaName=t,n.mappingAddresses=n.addressaddressPools[e],n.mappingAddressesName=n.addressaddressPools[e][0]},n.changeMappingAddress=function(e){n.mappingAddressesName=e},n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',n.checkNameVal=function(e){var t=!m(e);t||(t=g(e),n.nameValMsg=t?"已创建该名称的DNAT，请更换其他DNAT名称":'支持中文、字母、数字、"-"、"_"的组合，3-20个字符'),n.error.dnatName=!e||t},n.validateDestinationAddress=function(e){n.error.destinationAddress=i.validateIp(e)},n.validateMappingAddress=function(e){n.error.mappingAddress=i.validateIp(e)},n.validateMappingPort=function(e){n.error.mappingPort=""!==e&&i.validatePort(e)},n.searchServiceApps=function(e){return 0===n.dnatData.serversAppsType?r.searchApps(e):r.searchServices(e)},n.ok=function(){var a=t.defer();n.configPromise=a.promise,1===n.dnatData.destinationAddressType&&(n.dnatData.destinationAddress=n.destAddressesName),1===n.dnatData.mappingAddressType&&(n.dnatData.mappingAddress=n.mappingAddressesName),r.addDNATData(n.dnatData).then(function(){v().then(function(){e.addAlert({type:"success",content:"DNAT策略添加成功"})})},function(t){e.addAlert({type:"danger",content:t.data?"DNAT策略添加失败："+t.data:"DNAT策略添加失败"})}).finally(function(){n.configPromise=null,o.close("done")})},n.cancel=function(){o.dismiss("cancel")}}a.$inject=["$scope","$modalInstance"];var l=n.open({templateUrl:"/templates/strategy/nat/dnatAdd.b8918c6e.html",size:"sm",backdrop:"static",controller:a});l.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},d.edit=function(a){function l(n,o){n.dnatData=angular.copy(a),n.selectedObj={title:n.dnatData.serversApps},n.isEditing=!0,n.error={destinationAddress:1!==n.dnatData.destinationAddressType&&i.validateIp(n.dnatData.destinationAddress),serversApps:!n.dnatData.serversApps,mappingAddress:1!==n.dnatData.mappingAddressType&&i.validateIp(n.dnatData.mappingAddress),mappingPort:""!==n.dnatData.mappingPort&&i.validatePort(n.dnatData.mappingPort)},n.isGettingAddressPools=!0,r.getAddressPools().then(function(e){n.securityAreas=[],n.addressaddressPools=[],n.addressaddressPool=[];var t,o,a="其他";if(e)for(t=0;t<e.length;t++)e[t].securityAreaName||(e[t].securityAreaName="其他"),e[t].securityAreaName!==a&&(n.securityAreas.push(a),a=e[t].securityAreaName,n.addressaddressPool.length&&(n.addressaddressPools.push(n.addressaddressPool),n.addressaddressPool=[])),n.addressaddressPool.push(e[t].addressPoolName),t===e.length-1&&(n.securityAreas.push(a),n.addressaddressPool.length&&n.addressaddressPools.push(n.addressaddressPool));if(1===n.dnatData.destinationAddressType){for(t=0;t<e.length;t++)if(n.dnatData.destinationAddress===e[t].addressPoolName)for(n.securityAreaName=e[t].securityAreaName,o=0;o<n.securityAreas.length;o++)n.securityAreas[o]===n.securityAreaName&&(n.destAddresses=n.addressaddressPools[o]);n.destAddressesName=n.dnatData.destinationAddress}else n.securityAreaName=n.securityAreas[0],n.destAddresses=n.addressaddressPools[0],n.destAddressesName=n.destAddresses[0];if(1===n.dnatData.mappingAddressType){for(t=0;t<e.length;t++)if(n.dnatData.mappingAddress===e[t].addressPoolName)for(n.mappingSecurityAreaName=e[t].securityAreaName,o=0;o<n.securityAreas.length;o++)n.securityAreas[o]===n.mappingSecurityAreaName&&(n.mappingAddresses=n.addressaddressPools[o]);n.mappingAddressesName=n.dnatData.mappingAddress}else n.mappingSecurityAreaName=angular.copy(n.securityAreaName),n.mappingAddresses=angular.copy(n.destAddresses),n.mappingAddressesName=angular.copy(n.destAddressesName);n.isGettingAddressPools=!1},function(){n.isGettingAddressPools=!1}),n.changeDestType=function(e){1===e?n.error.destinationAddress=!1:n.error.destinationAddress=i.validateIp(n.dnatData.destinationAddress)},n.changeSecurityArea=function(e,t){n.securityAreaName=t,n.destAddresses=n.addressaddressPools[e],n.destAddressesName=n.addressaddressPools[e][0]},n.changeDestAddress=function(e){n.destAddressesName=e},n.changeMappingType=function(e){1===e?n.error.mappingAddress=!1:n.error.mappingAddress=i.validateIp(n.dnatData.mappingAddress)},n.changeMappingSecurityArea=function(e,t){n.mappingSecurityAreaName=t,n.mappingAddresses=n.addressaddressPools[e],n.mappingAddressesName=n.addressaddressPools[e][0]},n.changeMappingAddress=function(e){n.mappingAddressesName=e},n.validateDestinationAddress=function(e){n.error.destinationAddress=i.validateIp(e)},n.validateMappingAddress=function(e){n.error.mappingAddress=i.validateIp(e)},n.validateMappingPort=function(e){n.error.mappingPort=""!==e&&i.validatePort(e)},n.searchServiceApps=function(e){return 0===n.dnatData.serversAppsType?r.searchApps(e):r.searchServices(e)},n.ok=function(){var a=t.defer();n.configPromise=a.promise,1===n.dnatData.destinationAddressType&&(n.dnatData.destinationAddress=n.destAddressesName),1===n.dnatData.mappingAddressType&&(n.dnatData.mappingAddress=n.mappingAddressesName),r.editDNATData(n.dnatData).then(function(){e.addAlert({type:"success",content:"DNAT策略修改成功"})},function(t){e.addAlert({type:"danger",content:t.data?"DNAT策略修改失败："+t.data:"DNAT策略修改失败"})}).finally(function(){n.configPromise=null,o.close("done")})},n.cancel=function(){o.dismiss("cancel")}}l.$inject=["$scope","$modalInstance"];var s=n.open({templateUrl:"/templates/strategy/nat/dnatAdd.b8918c6e.html",size:"sm",backdrop:"static",controller:l});s.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},d.selectedItems={},d.selectAll=function(){d.selectedItems={},d.table.forEach(function(e){d.selectedItems[e.dnatId]=d.selectAllValue})},d.selectItem=function(){var e=!1,t=!0;d.table.forEach(function(n){d.selectedItems[n.dnatId]?e=!0:t=!1}),e===!0&&t===!1?d.selectAllValue=null:e===!0&&t===!0?d.selectAllValue=!0:d.selectAllValue=!1},d.delete=function(){var n=d.selectedItems,o=[];if(n)for(var a in n)if(n[a])for(var i=0;i<d.table.length;i++)d.table[i].dnatId+""===a&&o.push(d.table[i]);if(0!==o.length){var l=t.defer();d.deletePromise=l.promise,r.deleteDNATData(o).then(function(){l.resolve("success"),e.addAlert({type:"success",content:"DNAT策略删除成功"}),v()},function(t){l.resolve("fail"),e.addAlert({type:"danger",content:t.data?"DNAT策略删除失败："+t.data:"DNAT策略删除失败"})})}else e.addAlert({type:"info",content:"请至少选中一条DNAT策略"})}}var s={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/strategy/nat/dnatTable.18f28f23.html",link:l};return s}e.$inject=["$modal","$log","snatModel","dnatModel","$rootScope","$q","formatVal","interfaceModel","$state"],t.$inject=["$rootScope","$q","$modal","$log","$state","dnatModel","formatVal"],angular.module("southWest.strategy.nat").directive("snatTable",e).directive("dnatTable",t)}(),function(){"use strict";function e(e){e.state("strategy.security",{url:"/security",controller:"SecurityStrategyCtrl as security",templateUrl:"templates/strategy/security/index.2447500d.html",resolve:{state:["$rootScope",function(e){e.currentState="STRATEGY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.strategy.security").config(e)}(),function(){"use strict";function e(){}angular.module("southWest.strategy.security").controller("SecurityStrategyCtrl",e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d){function u(u,p,f,m){function g(e){var t=e||{};return u.skip=e.$skip||0,d.getAll(t)}function h(e){var t=e||{};return d.getCount(t)}function v(e){return g(e)}function y(e){return!(e&&!l.validateObjectAssetsName(e))}n.all([d.getTimes()]).then(function(e){u.times=e[0],m.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:g,getCount:h,search:v,fields:["name","sourceObjectName","targetObjectName","serviceAppName","action","enable","enableLog"],advancedSearch:"securityStrategy",advancedSearchOptions:[{name:"name",display:"策略名称",input:"string",option:!1,value:""},{name:"sourceObjectName",display:"源策略对象",input:"string",option:!1,value:""},{name:"targetObjectName",display:"目标策略对象",input:"string",option:!1,value:""},{name:"serviceAppName",display:"应用/服务",input:"string",option:!1,value:""},{name:"action",display:"动作",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:"ALLOW",text:"放行"},{value:"REJECT",text:"阻断"}]},{name:"enable",display:"启用状态",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:!0,text:"开启"},{value:!1,text:"关闭"}]},{name:"enableLog",display:"日志",input:"checkbox",option:!0,options:[{value:"-1",text:"全部"},{value:!0,text:"打开"},{value:!1,text:"关闭"}]}]})}),m.selectedItems={},m.selectAll=function(){m.selectedItems={},m.table.forEach(function(e){m.selectedItems[e.name]=m.selectAllValue})},u.privilegeName="STRATEGY_SECURITY";var I=s.get("privilege").filter(function(e){return e.name===u.privilegeName}),D=I&&I.length>0?I[0].actionValue:1;u.isNoEditPri=D<28,m.addNewStrategy=function(){function n(n,a){function r(e){var t=m.table,n=!0;return e&&t&&t.some(function(t){if(t.name===e)return n=!1,!0}),n}n.times=angular.isArray(u.times)?u.times:[],n.software="APPLICATION",n.newStrategy={enable:!0,action:"ALLOW"},n.checkNameVal=function(e){var t=y(e);return t?(t=r(e),t||(n.nameValMsg="已定义该名称的安全策略，请更换其他策略名称")):n.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},n.searchObjects=function(e){var t={$filter:"(contains(name, '"+e+"'))"};return d.searchObjects(t)},n.searchServiceApps=function(e){var t={$filter:"(contains(name, '"+e+"'))"};return"APPLICATION"===n.software?d.searchApps(t):d.searchServices(t)},n.$watch("selectedSoftware",function(e){if(e&&e.originalObject){n.appId=e.originalObject.appId,n.appProtocolType=i("appIdToProtocol")(n.appId),n.treeNodes=[];var t={funcCode:n.appProtocolType};d.getTreeNode(t).then(function(e){n.rootTree=e.detail,n.funcCodes=e.getAllFuncCode(),n.addNewFuncCode()})}else n.appId="",n.appProtocolType=null}),n.$watch("newStrategy.appSetting",function(e){e&&(angular.isUndefined(n.newStrategy.enableFlood)&&(n.newStrategy.enableFlood=!1),angular.isUndefined(n.newStrategy.enableTransaction)&&(n.newStrategy.enableTransaction=!1),angular.isUndefined(n.newStrategy.enableNoresponse)&&(n.newStrategy.enableNoresponse=!1))}),n.$watch("newStrategy.enableFlood",function(e){e||(n.newStrategy.floodSetting="")}),n.$watch("newStrategy.enableTransaction",function(e){e||(n.newStrategy.transactionSetting="")}),n.$watch("newStrategy.enableNoresponse",function(e){e||(n.newStrategy.noresponseSetting="")}),d.initTreeNodeAction(n),n.ok=function(r){if(r){var i=d.formatStrategy(n.newStrategy,n.treeNodes);"APPLICATION"===n.software?i.serviceAppType=1:i.serviceAppType=0,i.appId=n.appId,n.isAddingStrategy=!0,d.addNewSecurityStrategy([i],function(r,i){var l=n.$on("closeAddModal",function(){n.isAddingStrategy=!1,a.close(),l()});if(i)n.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"安全策略添加失败："+i.data:"安全策略添加失败"});else{var s=r.taskId;!function a(r){var i=o(function(){c.getTask(s).then(function(l){"SUCCESS"===l.data.state?(n.$emit("closeAddModal"),t.reload().then(function(){e.addAlert({type:"success",content:"安全策略添加成功"})}),o.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"安全策略添加失败："+l.data.reason:"安全策略添加失败"}),o.cancel(i)):("PENDING"===l.data.state,r>0?a(r-1):(n.$emit("closeAddModal"),e.addAlert({type:"danger",content:"安全策略添加超时"}),o.cancel(i)))})},1e3)}(30)}})}},n.cancel=function(){a.dismiss("cancel")}}n.$inject=["$scope","$modalInstance"];var l=a.open({templateUrl:"strategy-security-add-new.html",size:"lg",controller:n});l.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},m.viewStrategy=function(e){function t(t,n){t.isViewOnly=!0,t.times=angular.isArray(u.times)?u.times:[],t.editStrategy=e,t.selectedSourceObject=t.selectedTargetObject=t.selectedSoftware={},t.checkNameVal=function(){return!0},t.searchServiceApps=function(e){var n={$filter:"(contains(name, '"+e+"'))"};return"APPLICATION"===t.software?d.searchApps(n):d.searchServices(n)},1===t.editStrategy.serviceAppType?(t.software="APPLICATION",t.searchServiceApps(t.editStrategy.serviceAppName).then(function(e){angular.isArray(e)&&e.some(function(e){if(e.name===t.editStrategy.serviceAppName){t.appId=e.appId,t.appProtocolType=i("appIdToProtocol")(t.appId);var n={funcCode:t.appProtocolType};return d.getTreeNode(n).then(function(e){t.rootTree=e.detail,t.funcCodes=e.getAllFuncCode(),t.treeNodes=d.parseStrategy(t.editStrategy,t.rootTree,t.funcCodes,t.selectFuncCode)}),!0}})})):t.software="SERVICE",t.$watch("editStrategy.enableFlood",function(e){e||(t.editStrategy.floodSetting="")}),t.$watch("editStrategy.enableTransaction",function(e){
e||(t.editStrategy.transactionSetting="")}),t.$watch("editStrategy.enableNoresponse",function(e){e||(t.editStrategy.noresponseSetting="")}),d.initTreeNodeAction(t),t.checkRangeVal=function(){return!0},t.ok=function(){n.close()},t.cancel=function(){n.dismiss("cancel")}}t.$inject=["$scope","$modalInstance"];var n=a.open({templateUrl:"strategy-security-edit.html",size:"lg",controller:t});n.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},m.editStrategy=function(n){function l(a,r){function l(e){var t=m.table,o=!0;return e&&t&&t.some(function(t){if(t.name===e&&t.name!==n.name)return o=!1,!0}),o}a.isEditDisabled=!0,a.times=angular.isArray(u.times)?u.times:[],a.editStrategy=angular.copy(n),a.selectedSourceObject=a.selectedTargetObject=a.selectedSoftware={},a.checkNameVal=function(e){var t=y(e);return t?(t=l(e),t||(a.nameValMsg="已定义该名称的安全策略，请更换其他策略名称")):a.nameValMsg='支持中文、字母、数字、"-"、"_"的组合，3-20个字符',t},a.searchObjects=function(e){var t={$filter:"(contains(name, '"+e+"'))"};return d.searchObjects(t)},a.searchServiceApps=function(e){var t={$filter:"(contains(name, '"+e+"'))"};return"APPLICATION"===a.software?d.searchApps(t):d.searchServices(t)},1===a.editStrategy.serviceAppType?(a.software="APPLICATION",a.searchServiceApps(a.editStrategy.serviceAppName).then(function(e){angular.isArray(e)&&e.some(function(e){if(e.name===a.editStrategy.serviceAppName){a.appId=e.appId,a.appProtocolType=i("appIdToProtocol")(a.appId);var t={funcCode:a.appProtocolType};return d.getTreeNode(t).then(function(e){a.rootTree=e.detail,a.funcCodes=e.getAllFuncCode(),a.treeNodes=d.parseStrategy(a.editStrategy,a.rootTree,a.funcCodes,a.selectFuncCode)}),!0}})})):a.software="SERVICE",a.$watch("selectedSoftware",function(e){if(e&&e.originalObject){a.appId=e.originalObject.appId,a.appProtocolType=i("appIdToProtocol")(a.appId),a.treeNodes=[];var t={funcCode:a.appProtocolType};d.getTreeNode(t).then(function(e){a.rootTree=e.detail,a.funcCodes=e.getAllFuncCode(),a.addNewFuncCode()})}else a.appId="",a.appProtocolType=null}),a.$watch("editStrategy.appSetting",function(e){e&&(angular.isUndefined(a.editStrategy.enableFlood)&&(a.editStrategy.enableFlood=!1),angular.isUndefined(a.editStrategy.enableTransaction)&&(a.editStrategy.enableTransaction=!1),angular.isUndefined(a.editStrategy.enableNoresponse)&&(a.editStrategy.enableNoresponse=!1))}),a.$watch("editStrategy.enableFlood",function(e){e||(a.editStrategy.floodSetting="")}),a.$watch("editStrategy.enableTransaction",function(e){e||(a.editStrategy.transactionSetting="")}),a.$watch("editStrategy.enableNoresponse",function(e){e||(a.editStrategy.noresponseSetting="")}),d.initTreeNodeAction(a),a.ok=function(n){if(n){var i=d.formatStrategy(a.editStrategy,a.treeNodes);"APPLICATION"===a.software?i.serviceAppType=1:i.serviceAppType=0,i.appId=a.appId,a.isEdittingStrategy=!0,d.updateSecurityStrategy([i],function(n,i){var l=a.$on("closeAddModal",function(){a.isEdittingStrategy=!1,r.close(),l()});if(i)a.$emit("closeAddModal"),e.addAlert({type:"danger",content:i.data?"安全策略修改失败："+i.data:"安全策略修改失败"});else{var s=n.taskId;!function n(r){var i=o(function(){c.getTask(s).then(function(l){"SUCCESS"===l.data.state?(a.$emit("closeAddModal"),t.reload().then(function(){e.addAlert({type:"success",content:"安全策略修改成功"})}),o.cancel(i)):"FAILED"===l.data.state||"REJECTED"===l.data.state?(a.$emit("closeAddModal"),e.addAlert({type:"danger",content:l.data.reason?"安全策略修改失败："+l.data.reason:"安全策略修改失败"}),o.cancel(i)):("PENDING"===l.data.state,r>0?n(r-1):(a.$emit("closeAddModal"),e.addAlert({type:"danger",content:"安全策略修改超时"}),o.cancel(i)))})},1e3)}(30)}})}},a.cancel=function(){r.dismiss("cancel")}}l.$inject=["$scope","$modalInstance"];var s=a.open({templateUrl:"strategy-security-edit.html",size:"lg",controller:l});s.result.then(function(){},function(){r.info("Modal dismissed at: "+new Date)})},m.selectChanged=function(){var e=!1,t=!0;m.table.forEach(function(n){var o=void 0!==m.selectedItems[n.name]&&m.selectedItems[n.name]!==!1;e=e||o,t=t&&o}),m.selectAllValue=!!t||!!e&&null},m.deleteStrategy=function(){var a=m.selectedItems,r=[];if(a)for(var i in a)a[i]&&r.push(i);if(0!==r.length){var l=n.defer();e.securityStrategyDeleteTaskPromise=l.promise,d.deleteSecurityStrategy(r,function(n,a){if(a)e.addAlert({type:"danger",content:a.data?"安全策略删除失败："+a.data:"安全策略删除失败"}),l.resolve("fail");else{var r=n.taskId;!function n(a){var i=o(function(){c.getTask(r).then(function(r){"SUCCESS"===r.data.state?(t.reload().then(function(){e.addAlert({type:"success",content:"安全策略删除成功"}),m.selectedItems={},m.selectChanged()}),l.resolve("success"),o.cancel(i)):"FAILED"===r.data.state||"REJECTED"===r.data.state?(e.addAlert({type:"danger",content:r.data.reason?"安全策略删除失败："+r.data.reason:"安全策略删除失败"}),l.resolve("fail"),o.cancel(i)):("PENDING"===r.data.state,a>0?n(a-1):(e.addAlert({type:"danger",content:"安全策略删除超时"}),l.resolve("timeout"),o.cancel(i)))})},1e3)}(30)}})}else e.addAlert({type:"info",content:"请至少选中一条安全策略"})}}var p={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/strategy/security/securityTable.ad2b5a9c.html",link:u};return p}function t(e){function t(t,n){var o=90;e(function(){var e=angular.element(n[0].querySelector(".info-label")).width(),t=n.width(),a=t-e-5;angular.element(n[0].querySelector(".info-value")).css({width:a>=o?a+"px":"100%"})})}var n={scope:!1,restrict:"C",link:t};return n}function n(){function e(e,t,n,o){o.$render=function(){o.$modelValue&&(e.expression=o.$modelValue.expression,e.value=o.$modelValue.value)},e.$watch("[expression, value]",function(){o.$modelValue&&(!o.$modelValue||e.expression===o.$modelValue.expression&&e.value===o.$modelValue.value)||(e.regex="rg"===e.expression?/^(\d|[1-9]\d{1,4})-(\d|[1-9]\d{1,4})$/:/^\d$|^[1-9]\d{1,4}$/,e.maxlen="rg"===e.expression?11:5,o.$setViewValue({expression:e.expression,value:e.value}))}),e.expression="eq",e.checkRangeVal=function(t,n){if(t){var o=[t];if("rg"===e.expression&&t.indexOf("-")>=0&&(o=t.split("-"),Number(o[0])>Number(o[1])))return!1;if(n&&angular.isDefined(n.min)&&angular.isDefined(n.max)){var a=!0,r=Number(n.min),i=Number(n.max);return o.some(function(e){return e=Number(e),a=e>=r&&e<=i,!a}),a}}return!0}}var t={scope:{ngDisabled:"<?",formName:"<",min:"<",max:"<"},restrict:"E",require:"?ngModel",replace:!0,templateUrl:"/templates/strategy/security/expressionInputTpl.f62a82a1.html",link:e};return t}e.$inject=["$rootScope","$state","$q","$timeout","$modal","$log","$filter","formatVal","Enum","Task","SecurityStrategyModel"],t.$inject=["$timeout"],angular.module("southWest.strategy.security").directive("strategySecurityTable",e).directive("valueDetailContainer",t).directive("expressionInput",n)}(),function(){"use strict";function e(e){e.state("strategy.session",{url:"/session",templateUrl:"templates/strategy/session/index.387b7980.html"})}e.$inject=["$stateProvider"],angular.module("southWest.strategy.session").config(e)}(),function(){"use strict";function e(e,t,n,o,a){function r(r,i,l,s){function c(e){return r.params=e,a.getAll(e)}function d(e){return a.getCount(e)}s.disableToolbar=!0,s.setConfig({name:"item",pagination:!0,scrollable:!1,totalCount:!0,getAll:c,getCount:d}),s.selectedItems={},s.selectAll=function(){s.selectedItems={},s.table.forEach(function(e){s.selectedItems[e.sessionControlId]=s.selectAllValue})},s.selectChanged=function(){var e=!1,t=!0;s.table.forEach(function(n){var o=void 0!==s.selectedItems[n.sessionControlId]&&s.selectedItems[n.sessionControlId]!==!1;e=e||o,t=t&&o}),s.selectAllValue=!!t||!!e&&null},s.openConfigWin=function(a,r){function i(n,o,i,l){function c(){("any"!==n.sessionControlData.sourceIp&&""!==n.sessionControlData.sourceIp||"any"!==n.sessionControlData.targetIp&&""!==n.sessionControlData.targetIp||"-1"!==n.sessionControlData.sessionType&&n.sessionControlData.serviceApp&&"any"!==n.sessionControlData.serviceApp)&&(n.sessionControlData.frequencyUpperLimit||n.sessionControlData.totalUpperLimit)&&n.valid.sourceIp&&n.valid.targetIp&&n.valid.frequency?n.valid.enableSave=!0:n.valid.enableSave=!1}n.sessionTypeOptions=[{name:"",value:-1},{name:"服务",value:0},{name:"应用",value:1}],n.sessionControlData={sessionType:-1,serviceApp:"any"},n.isEdit=a,n.valid={sourceIp:!1,targetIp:!1,serviceApp:!1,frequency:!0,duplicate:!1,error:!1,enableSave:!1},n.searchService=i.searchService,n.searchApp=i.searchApp,n.validateIp=function(e,t){"SOURCE"===t?n.valid.sourceIp="any"===e.toLowerCase()||!l.validateIp(e):"TARGET"===t&&(n.valid.targetIp="any"===e.toLowerCase()||!l.validateIp(e)),c()},n.changeSessionType=function(){n.sessionControlData.sessionType===-1?n.sessionControlData.serviceApp="any":n.sessionControlData.serviceApp=""},n.$watch("sessionControlData.serviceApp",function(e,t){e!==t&&c()}),n.validateFrequency=function(e){e?n.valid.frequency=!isNaN(e)&&e>=10&&e<=1e3:n.valid.frequency=!0,c()},n.validateTotalUpperLimit=function(e){e&&(isNaN(n.sessionControlData.totalUpperLimit)||n.sessionControlData.totalUpperLimit<1)&&(n.sessionControlData.totalUpperLimit=""),c()},a&&(n.sessionControlData=angular.copy(r),n.validateIp(r.sourceIp,"SOURCE"),n.validateIp(r.targetIp,"TARGET"),n.validateFrequency(r.frequencyUpperLimit),n.validateTotalUpperLimit(r.totalUpperLimit),n.valid.enableSave=!0),n.ok=function(){n.valid.error=!1;var r=t.defer();n.configPromise=r.promise;var l=angular.copy(n.sessionControlData);l.sourceIp=l.sourceIp.toLowerCase(),a?i.editSessionControl(l).then(function(){o.close("done"),r.resolve("success"),e.addAlert({type:"success",content:"会话控制修改成功"}),s.refresh()},function(){r.resolve("fail"),n.valid.error=!0}):i.validateSessionControl(l).then(function(t){t&&"0"===t.code?(n.valid.duplicate=!1,i.addSessionControl(l).then(function(){o.close("done"),r.resolve("success"),e.addAlert({type:"success",content:"会话控制添加成功"}),s.refresh()},function(){r.resolve("fail"),n.valid.error=!0})):t&&"1"===t.code&&(n.valid.duplicate=!0,r.resolve("fail"))},function(){n.valid.error=!0,r.resolve("fail")})},n.cancel=function(){o.dismiss("cancel")}}i.$inject=["$scope","$modalInstance","SessionControlModel","formatVal"];var l=n.open({templateUrl:"/templates/strategy/session/sessionControl.d2dbff04.html",size:"sm",backdrop:"static",controller:i});l.result.then(function(){},function(){o.info("Modal dismissed at: "+new Date)})},s.add=function(){s.openConfigWin(!1)},s.edit=function(e){s.openConfigWin(!0,e)},s.delete=function(){var o=s.selectedItems,r=[];if(s.table.forEach(function(e){o[e.sessionControlId]&&r.push(e)}),0!==r.length){var i=n.open({templateUrl:"/templates/strategy/session/sessionControlDelModal.123a75c6.html",size:"sm",controller:["$scope","$modalInstance",function(e,t){e.cancel=function(){t.dismiss("cancel")},e.confirm=function(){t.close()}}]});i.result.then(function(){var n=t.defer();s.deletePromise=n.promise,a.delSessionControl(r).then(function(){n.resolve("success"),e.addAlert({type:"success",content:"会话控制删除成功"}),s.selectedItems={},s.selectChanged(),s.refresh()},function(t){n.resolve("fail"),e.addAlert({type:"danger",content:t.data?"会话控制删除失败："+t.data:"会话控制删除失败"})})})}else e.addAlert({type:"info",content:"请至少选中一条会话控制"})},s.changeSwitch=function(n,o){var r=t.defer();e.timeoutPromise=r.promise;var i="";"LOG"===o?i="日志开关":"UPPERLIMITWARN"===o&&(i="超出上限警告开关"),a.changeSwitch(n).then(function(){r.resolve("success"),e.addAlert({type:"success",content:i+"配置成功"}),s.refresh()},function(t){r.resolve("fail"),e.addAlert({type:"danger",content:t.data?i+"配置失败："+t.data:i+"配置失败"}),s.refresh()})}}var i={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/strategy/session/sessionControlTable.5a11041a.html",link:r};return i}e.$inject=["$rootScope","$q","$modal","$log","SessionControlModel"],angular.module("southWest.strategy.session").directive("sessionControlTable",e)}(),function(){"use strict";function e(e){e.state("strategy",{abstract:!0,parent:"dashboard",url:"/strategy",controller:"StrategyCtrl as menuCtrl",templateUrl:"templates/includes/nav-left.1fd45e73.html"})}e.$inject=["$stateProvider"],angular.module("southWest.strategy").config(e)}();!function(){"use strict";function e(e,t,n){var o=this;o.prefixId="strategy",o.subMenus=n.rootMenu.getChild("STRATEGY"),o.expanded="true"===t.getItem("strategy:navbar:expanded"),o.toggleExpand=function(){o.expanded=!o.expanded,t.setItem("strategy:navbar:expanded",o.expanded)},o.isActive=function(t){return e.current.name.indexOf(t.getState())>-1}}e.$inject=["$state","localStorage","$rootScope"],angular.module("southWest.strategy").controller("StrategyCtrl",e)}();!function(){"use strict";function e(e){e.state("setting.usercontrol",{parent:"setting",url:"/usercontrol",controller:"SystemUserCtrl as systemuser",templateUrl:"templates/systemuser/index.970a265b.html",resolve:{users:["SystemUser",function(e){return e.getUsers()}],roles:["SystemUser","secretKey",function(e,t){return e.getRoles().then(function(e){return e},function(e){return e})}],user:["SystemUser","secretKey",function(e,t){return e.getCurrentUser()}],strategyInfo:["System","secretKey",function(e,t){return e.getStrategyInfo()}]}}).state("setting.rootcontrol",{parent:"setting",url:"/rootcontrol",controller:"RootUserCtrl as systemuser",templateUrl:"templates/systemuser/rootcontrol.f7a7effe.html",resolve:{users:["SystemUser","secretKey",function(e,t){return e.getDefaultUser()}],user:["SystemUser","secretKey",function(e,t){return e.getCurrentUser()}],strategyInfo:["System","secretKey",function(e,t){return e.getStrategyInfo()}],roles:["SystemUser","secretKey",function(e,t){return e.getRoles().then(function(e){return e},function(e){return e})}]}})}e.$inject=["$stateProvider"],angular.module("southWest.systemuser").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c,d,u,p,f,m,g,h,v,y){function I(){var e=[];e.push({privilege:"EVENT",menu:"MONITOR_INCIDENT",description:"事件"}),e.push({privilege:"LOG_MANAGEMENT",menu:"MONITOR_LOGGER",description:"日志"}),e.push({privilege:"REPORT",menu:"MONITOR_REPORT",description:"报告"}),e.push({privilege:"SESSION_MANAGEMENT",menu:"SESSION",description:"会话"}),e.push({privilege:"RULE_BLACKLIST",menu:"RULE_BLACKLIST",description:"黑名单"}),e.push({privilege:"RULE_WHITELIST",menu:"RULE_WHITELIST",description:"白名单"}),e.push({privilege:"RULE_IP_MAC",menu:"RULE_IPMAC",description:"IP/MAC"}),e.push({privilege:"NETWORK_INTERFACE",menu:"NETWORK_INTERFACE",description:"接口"}),e.push({privilege:"NETWORK_ROUTE",menu:"NETWORK_STATIC_ROUTER",description:"路由"}),e.push({privilege:"OBJECT_ASSET",menu:"OBJECT_NETWORK_ASSET",description:"网络资产"}),e.push({privilege:"OBJECT_SERVICE",menu:"OBJECT_SERVICE",description:"服务"}),e.push({privilege:"OBJECT_APPLICATION",menu:"OBJECT_APPLY",description:"应用"}),e.push({privilege:"OBJECT_SCHEDULE",menu:"OBJECT_SCHEDULE",description:"时间表"}),e.push({privilege:"STRATEGY_SECURITY",menu:"STRATEGY_SECURITY",description:"安全策略"}),e.push({privilege:"STRATEGY_NAT",menu:"STRATEGY_NAT",description:"NAT策略"}),e.push({privilege:"STRATEGY_SESSION",menu:"STRATEGY_SESSION",description:"会话策略"}),e.push({privilege:"STRATEGY_ANTI_ATTACK",menu:"STRATEGY_ANTI_PENETRATION",description:"抗渗透"}),e.push({privilege:"SETTING_BASIC",menu:"SETTING_BASIC",description:"基本设置"}),e.push({privilege:"SETTING_SWITCH",menu:"SETTING_SWITCH",description:"开关设置"}),e.push({privilege:"SETTING_RELIABLITY",menu:"SETTING_RELIABLE",description:"可靠性"}),e.push({privilege:"OPERATION_UPGRADE",menu:"SETTING_SECURITY_OPERATION",description:"升级"}),e.push({privilege:"OPERATION_REBOOT",menu:"SETTING_SECURITY_OPERATION",description:"重启"}),e.push({privilege:"OPERATION_RESET",menu:"SETTING_SECURITY_OPERATION",description:"重置"}),e.push({privilege:"OPERATION_BACKUP",menu:"SETTING_SECURITY_OPERATION",description:"备份"}),e.push({privilege:"USER_MANAGEMENT",menu:"SETTING_USERCONTROL",description:"用户管理"});var t={};e.forEach(function(e){t[e.privilege]=e}),P.privilegeDict=t;var n=["EVENT","LOG_MANAGEMENT","REPORT","SESSION_MANAGEMENT","RULE_BLACKLIST","RULE_WHITELIST","RULE_IP_MAC","NETWORK_INTERFACE","NETWORK_ROUTE","OBJECT_SERVICE","OBJECT_SCHEDULE","OBJECT_ASSET","OBJECT_APPLICATION","STRATEGY_SECURITY","STRATEGY_NAT","STRATEGY_SESSION","STRATEGY_ANTI_ATTACK"],o=["SETTING_BASIC","SETTING_SWITCH","SETTING_RELIABLITY","USER_MANAGEMENT","OPERATION_UPGRADE","OPERATION_REBOOT","OPERATION_RESET","OPERATION_BACKUP"];P.privilegeGroups={MonitorMgt:n,SystemMgt:o}}function D(){var t=[];t.push(e.getUsers()),t.push(e.getRoles()),c.all(t).then(function(e){P.table=e[0].users,P.currentRole=e[1].currentRole,P.subRoles=e[1].subRoles,i=e[1],i.subRoles.map(function(e){e.groupLevel=1}),P.userGroupTree=[{name:i.currentRole.name,roleId:i.currentRole.roleId,subRoles:i.subRoles,showSubRoles:!0,subRolesLoaded:!0,groupLevel:0}]})}function T(e,t){e&&e.subMenus&&e.subMenus.length&&e.subMenus.map(function(e){e.menuDisabled_infinte||e.menuDisabled_temp||e.checked===t||(e.checked=t),T(e,t)})}function b(e){if(e&&e.parentMenu&&e.parentMenu.subMenus){var t=e.parentMenu,n=[],o=[];t.subMenus.forEach(function(e){switch(e.checked){case!0:n.push(e);break;case!1:o.push(e)}});var a=n.length===t.subMenus.length,r=o.length<t.subMenus.length;t.checked=!!r&&(!!a||null),b(t)}}function S(e,t,n){1===n?(e||P.menusCheckedChanged(t,!1),P.menusDisabledChanged(t,!0)):e||(P.menusDisabledChanged(t,!1),P.menusCheckedChanged(t,!0))}var P=this;return 412===i.status?(n.addAlert({type:"danger",content:"没有用户或用户组管理权限， 请联系系统管理员"}),void y.transitionTo("monitor.overview")):(P.table=r.users,P.currentRole=i.currentRole,P.subRoles=i.subRoles,P.currentUser=l,P.requestError="",P.createdError={},P.currentUserdisabledEditUserGroup=!1,P.currentUserdisabledEditUser=!1,P.showCreateUserGroup=!1,P.showEditUserGroup=!1,P.showCreateUser=!1,P.showEditUser=!1,P.privilegesToBan=[],I(),P.setCurrentUserEnabledEditUserAndGroup=function(e){var t=e.filter(function(e){return"USER_MANAGEMENT"===e.name}),n=e.filter(function(e){return"USER_GROUP_MANAGEMENT"===e.name});t=void 0!==t&&null!==t&&t.length>0?t[0]:null,n=void 0!==n&&null!==n&&n.length>0?n[0]:null,null!==t&&30===t.actionValue||(P.currentUserdisabledEditUser=!0,P.currentUserdisabledEditUserGroup=!0),null!==n&&30===n.actionValue||(P.currentUserdisabledEditUserGroup=!0)},P.setCurrentUserEnabledEditUserAndGroup(l.targetAndActionValueFormList),P.userLockedChanged=function(t){e.lockUser(t.locked?"lock":"unlock",t.userId).then(function(e){e.data?n.addAlert({type:"success",content:t.locked?"锁定成功！":"解锁成功!"}):(t.locked=!t.locked,n.addAlert({type:"danger",content:"修改失败！"}))})},P.getUserByUserGroupId=function(t){e.getUsersByRoleId(t.roleId).then(function(e){P.table=e.users})},P.passwordComplexityStrategy=v.getPassComplexity(g.data),P.passwordComplexityMessage=v.getPassComplexityMessage(P.passwordComplexityStrategy.strategyRules[0].ruleData),P.passwordErrormessages=v.errorMessages,P.getCurrentUserName=function(){return s.getUserName()},P.getCurrentUserRole=function(){return s.getUserRole()},P.goToUserManagerPage=function(){P.groupEditState="groupInfo",P.privilegesToBan=[],P.showCreateUserGroup=!1,P.showEditUserGroup=!1,P.showCreateUser=!1,P.showEditUser=!1,P.parentGroup&&delete P.parentGroup,P.selfGroup&&delete P.selfGroup,P.editedUserGroup&&delete P.editedUserGroup,P.createdError&&delete P.createdError,P.newUser&&delete P.newUser},P.cleanErrorMsg=function(){P.newPassValid=0,P.confirmPassValid=0,P.createdError&&delete P.createdError,P.cleanForms()},P.cleanForms=function(){P.showCreateUser=!1,P.showEditUser=!1,P.showUserTable=!0,P.showEditUserGroup=!1,P.showUserGroup=!0,P.showCreateUserGroup=!1,P.editedUser&&delete P.editedUser,P.newUser&&delete P.newUser,P.editedUserGroup&&delete P.editedUserGroup,P.createdError&&delete P.createdError,P.parentGroup&&delete P.parentGroup,P.selfGroup&&delete P.selfGroup},P.hasPrivilege=function(e,t){var n=P.editedUserParentGroup&&P.editedUserParentGroup.targetAndActionValueFormList?P.editedUserParentGroup.targetAndActionValueFormList:u.get("privilege"),o=n.filter(function(t){return t.name===e});return!!(t&&o&&o.length)&&o[0].actionValue>=t},P.changeCM=function(e,t){t.menuDisabled_infinte||t.menuDisabled_temp||t.checked===e||(t.checked=e),T(t,e),b(t)},P.disabledMenusChain=function(e,t,n,o,a){t.menuDisabled_temp=e,t.subMenus&&t.subMenus.length&&t.subMenus.map(function(t){t.menuDisabled_temp=e,P.disabledMenusChain(e,t)});var r;n&&(r=n.subMenus.filter(function(e){return!e.menuDisabled_temp&&!e.menuDisabled_infinte}),n.menuDisabled_temp=null===r||0===r.length),o&&(r=o.subMenus.filter(function(e){return!e.menuDisabled_temp&&!e.menuDisabled_infinte}),o.menuDisabled_temp=null===r||0===r.length),a&&(r=a.subMenus.filter(function(e){return!e.menuDisabled_temp&&!e.menuDisabled_infinte}),a.menuDisabled_temp=null===r||0===r.length)},P.groupPrivilegeEnabled=function(e,t){var n=P.privilegeGroups[e];if(n){var o=!1;return n.forEach(function(e){P.hasPrivilege(e,t)&&(o|=!0)}),o}return!1},P.groupPrivilegeChanged=function(e,t){var n=P.privilegeGroups[e];n&&n.forEach(function(e){P.hasPrivilege(e,t)&&(P.userGroupPrivilege[e]=t,P.privilegeChanged(e,t))})},P.privilegeChanged=function(e,t){var n=P.privilegeDict[e];if(n){var o=n.menu,a=n.description,r=!1;switch(o){case"SETTING_SECURITY_OPERATION":var i=P.userGroupPrivilege.OPERATION_UPGRADE,l=P.userGroupPrivilege.OPERATION_REBOOT,s=P.userGroupPrivilege.OPERATION_RESET,c=P.userGroupPrivilege.OPERATION_BACKUP,d=i|l|s|c,u="SETTING_SECURITY_OPERATION";S(r,u,d);break;case"USER_MANAGEMENT":r||(P.userGroupPrivilege.USER_GROUP_MANAGEMENT=P.userGroupPrivilege[e]),S(r,o,t);break;default:S(r,o,t)}if(void 0!==a&&null!==a&&""!==a){var p=P.privilegesToBan.filter(function(e){return e.name===a});switch(p=void 0!==p&&null!==p&&p.length>0?p[0]:null,t){case 1:null===p?P.privilegesToBan.push({name:a,banStatus:!0}):p.banStatus=!0;break;default:null!==p&&(p.banStatus=!1)}}}},P.menusCheckedChanged=function(e,t){function n(e,t){var o;return e.some(function(e){return e.target===t?(o=e,!0):!(!e.subMenus||0!==t.indexOf(e.target))&&(o=n(e.subMenus,t),!!o)}),o}var o=n(P.editedUserGroup.customizedMenu_parent,e);o&&P.changeCM(t,o)},P.menusDisabledChanged=function(e,t){P.editedUserGroup.customizedMenu_parent.map(function(n){n.target===e?P.disabledMenusChain(t,n):n.subMenus.map(function(o){o.target===e?P.disabledMenusChain(t,o,n):o.subMenus.map(function(a){a.target===e&&P.disabledMenusChain(t,a,o,n)})})})},P.checkMenuLevel=function(e){return e.split("-").length},P.findMenuById=function(e,t){return t.filter(function(t){return t.customizedMenuId===e})},P.findIconByTarget=function(e){var t=n.menuslist.filter(function(t){return t.target===e});return void 0!==t&&null!==t&&t.length>0?t[0].icon:""},P.sortMenus=function(e){return e&&e.length&&e.sort(function(e,t){var n=e.customizedMenuId.split("-"),o=t.customizedMenuId.split("-");if(n.length!==o.length)return n.length>o.length?1:-1;for(var a=0;a<n.length;a++)if(n[a]!==o[a])return parseInt(n[a])>parseInt(o[a])?1:-1})},P.createMenuTree=function(e){for(var t=[[],[],[],[]],n=[],o=0;o<e.length;o++)e[o].menuDisabled_infinte=!1,e[o].menuDisabled_temp=!1,e[o].childMenuShow=!0,e[o].checked=e[o].active,t[P.checkMenuLevel(e[o].customizedMenuId)-1].push(e[o]);for(var a,r,i=0;i<t.length;i++){P.sortMenus(t[i]);for(var l=0;l<t[i].length;l++)switch(t[i][l].subMenus=[],t[i][l].icon=P.findIconByTarget(t[i][l].target),i){case 0:n.push(t[i][l]);break;case 1:a=t[i][l].customizedMenuId.split("-")[0],r=P.findMenuById(a,n),r&&r.length&&r[0].subMenus.push(t[i][l])&&(t[i][l].parentMenu=r[0]),b(t[i][l]);break;case 2:a=t[i][l].customizedMenuId.split("-")[0],r=P.findMenuById(a,n),a=t[i][l].customizedMenuId.split("-")[0]+"-"+t[i][l].customizedMenuId.split("-")[1],r&&r.length&&(r=P.findMenuById(a,r[0].subMenus)),r&&r.length&&r[0].subMenus.push(t[i][l])&&(t[i][l].parentMenu=r[0]),b(t[i][l]);break;case 3:a=t[i][l].customizedMenuId.split("-")[0],r=P.findMenuById(a,n),a=t[i][l].customizedMenuId.split("-")[0]+"-"+t[i][l].customizedMenuId.split("-")[1],r&&r.length&&(r=P.findMenuById(a,r[0].subMenus)),a=t[i][l].customizedMenuId.split("-")[0]+"-"+t[i][l].customizedMenuId.split("-")[1]+"-"+t[i][l].customizedMenuId.split("-")[2],r&&r.length&&(r=P.findMenuById(a,r[0].subMenus)),r&&r.length&&r[0].subMenus.push(t[i][l])&&(t[i][l].parentMenu=r[0]),b(t[i][l])}}return n},P.initialInfiniteDisabled=function(e,t){return e.map(function(e){var n=P.findMenuById(e.customizedMenuId,t);n&&n.length>0&&!n[0].active&&(e.menuDisabled_infinte=!0),e.subMenus.map(function(e){var n=P.findMenuById(e.customizedMenuId,t);n&&n.length>0&&!n[0].active&&(e.menuDisabled_infinte=!0),e.subMenus.map(function(e){var n=P.findMenuById(e.customizedMenuId,t);n&&n.length>0&&!n[0].active&&(e.menuDisabled_infinte=!0)})})}),e},P.initialTempDisabled=function(){for(var e in P.privilegeDict)if(P.privilegeDict.hasOwnProperty(e)){var t=P.privilegeDict[e];t&&S(!0,t.menu,P.userGroupPrivilege[t.privilege])}},P.disabledOverViewMenuAndHiddenHelpChildren=function(e){var t=e.filter(function(e){return"MONITOR"===e.target})[0];t.menuDisabled_infinte=!0,t.menuDisabled_temp=!0;var n=t.subMenus.filter(function(e){return"MONITOR_OVERVIEW"===e.target})[0];return n.menuDisabled_infinte=!0,n.menuDisabled_temp=!0,e},P.readMenuTree=function(e){for(var t=[],n=0;n<e.length;n++)t.push({customizedMenuId:e[n].customizedMenuId,description:e[n].description,target:e[n].target,active:e[n].checked!==!1}),e[n].subMenus&&e[n].subMenus.length&&(t=t.concat(P.readMenuTree(e[n].subMenus)));return t},P.goToCreateUserGroup=function(t){P.userPrivilegeDisabled=!1,P.editedUserGroup={},P.editedUserGroup.role={name:"",comment:"",roleLevel:""},e.getUserGroup(t.roleId).then(function(e){P.parentGroup=angular.copy(e),P.selfGroup=angular.copy(e),P.editedUserGroup.customizedMenu_parent=P.disabledOverViewMenuAndHiddenHelpChildren(P.initialInfiniteDisabled(P.createMenuTree(P.selfGroup.customizedMenus),P.parentGroup.customizedMenus)),P.editedUserParentGroup=P.parentGroup,P.editedUserGroup.parentRoleId=t.roleId,P.editedUserGroup.role.roleLevel="ADMIN"===t.roleLevel||"ROOT"===t.roleLevel?"NORMAL":t.roleLevel,P.editedUserGroup.targetAndActionValueFormList=[],P.userGroupPrivilege=[];for(var n=e.targetAndActionValueFormList?e.targetAndActionValueFormList:P.currentUser.targetAndActionValueFormList,o=0;o<n.length;o++){var a=n[o];P.editedUserGroup.targetAndActionValueFormList.push({name:a.name,actionValue:a.actionValue,description:a.description}),P.userGroupPrivilege[a.name]=a.actionValue}P.showCreateUserGroup=!0,P.showEditUserGroup=!1,P.showCreateUser=!1,P.showEditUser=!1,P.groupEditState="groupInfo",P.groupFormValid=!1,f.focusById("systemUserGroupEditInput")},function(){n.addAlert({type:"danger",content:"网络不通，获取用户组信息失败，请重试！"})})},P.goToEditUserGroup=function(){P.groupEditState="groupInfo",P.showCreateUserGroup=!1,P.showEditUserGroup=!0,P.showCreateUser=!1,P.showEditUser=!1,P.createdError={nameVoid:!1,nameOversize:!1,commentVoid:!1,commentOversize:!1,errorNumber:0}},P.editUserGroup=function(t){P.groupFormValid=!0,e.getUserGroup(t.roleId).then(function(n){e.getUserGroup(t.parentRoleId?t.parentRoleId:t.roleId).then(function(e){P.parentGroup=angular.copy(e),P.selfGroup=angular.copy(n),P.editedUserGroup=P.selfGroup,P.editedUserParentGroup=P.parentGroup,P.userPrivilegeDisabled=P.currentUserdisabledEditUserGroup||P.editedUserGroup.role.defaultRole||P.getCurrentUserRole()[0].roleId===P.editedUserGroup.role.roleId,P.editedUserGroup.customizedMenu_parent=P.disabledOverViewMenuAndHiddenHelpChildren(P.initialInfiniteDisabled(P.createMenuTree(P.selfGroup.customizedMenus),P.parentGroup.customizedMenus)),P.userGroupPrivilege=[];for(var t=0;t<P.editedUserGroup.targetAndActionValueFormList.length;t++)P.userGroupPrivilege[P.editedUserGroup.targetAndActionValueFormList[t].name]=P.editedUserGroup.targetAndActionValueFormList[t].actionValue;P.editedUserGroup.locked?P.editedUserGroup.locked="on":P.editedUserGroup.locked="off",P.initialTempDisabled(),P.goToEditUserGroup()})},function(){n.addAlert({type:"danger",content:"网络不通，获取用户组信息失败，请重试！"})})},P.validationGroupForm=function(){P.editedUserGroup.role.name?P.groupFormValid=!0:P.groupFormValid=!1},P.saveEditUserGroup=function(t){var o=[];P.updateUserGroupPromise=e.updateUserGroup(t).then(function(){o.push(e.getUsers()),o.push(e.getRoles()),o.push(e.getCurrentUser()),c.all(o).then(function(e){P.table=e[0].users,P.currentRole=e[1].currentRole,P.subRoles=e[1].subRoles,P.currentUser=e[2],D(),P.goToUserManagerPage(),n.addAlert({type:"success",content:"用户组信息修改成功！"})})},function(e){P.createdError.passwordInvalid=!0,P.createdError.message=e.data.error,n.addAlert({type:"danger",content:"用户组信息修改失败！"+e.data.error})})},P.saveNewUserGroup=function(t){P.updateUserGroupPromise=e.createGroup(t).then(function(){delete P.createdError,delete P.editedUserGroup,D(),P.goToUserManagerPage(),n.addAlert({type:"success",content:"用户组创建成功！"})},function(e){n.addAlert({type:"danger",content:"用户组创建失败！"+e.data.error})})},P.saveUserGroup=function(){if(P.createdError={nameVoid:!1,nameOversize:!1,commentVoid:!1,commentOversize:!1,errorNumber:0},P.editedUserGroup.role.name?P.editedUserGroup.role.name.length>64&&(P.createdError.nameOversize=!0,P.createdError.errorNumber++):(P.createdError.nameVoid=!0,P.createdError.errorNumber++),P.editedUserGroup.role.comment&&P.editedUserGroup.role.comment.length>64&&(P.createdError.commentOversize=!0,P.createdError.errorNumber++),0===P.createdError.errorNumber){P.editedUserGroup.targetAndActionValueFormList.map(function(e){e.actionValue=P.userGroupPrivilege[e.name]});var e=angular.copy(P.editedUserGroup);if(e.customizedMenus=P.readMenuTree(e.customizedMenu_parent),delete e.customizedMenu_parent,e.role.roleId){var t=P.getPrivilegeChangedToBan();""!==t?P.groupPrivilegeChangedWarningConfirmPopup(t,e):P.saveEditUserGroup(e)}else P.saveNewUserGroup(e)}},P.getPrivilegeChangedToBan=function(){var e=P.privilegesToBan.filter(function(e){return e.banStatus}),t="";e=e&&e.length>0?e:[];for(var n=0;n<e.length;n++)t+=e[n].name+",";return t.length>0&&(t=t.substring(0,t.length-1)),t},P.groupPrivilegeChangedWarningConfirmPopup=function(e,t){function n(e,t,n,o){e.privileges=n,e.tempgroup=o,e.ok=function(){P.saveEditUserGroup(o),t.close()},e.cancel=function(){t.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","privileges","tempgroup"];var o=a.open({templateUrl:"changePrivilegeToForbidWarning.html",controller:n,size:"sm",resolve:{privileges:function(){return e},tempgroup:function(){return t}}});o.result.then(function(){},function(){d.info("Modal dismissed at: "+new Date)})},P.deleteGroup=function(t){e.deleteGroup(t).then(function(e){e.data&&(n.addAlert({type:"success",content:"用户组删除成功！"}),D())},function(){n.addAlert({type:"danger",content:"用户组删除失败！"})})},P.deleteGroupConfirmPopup=function(e,t){function n(e,t,n,o){e.name=o,e.ok=function(){P.deleteGroup(n),t.close()},e.cancel=function(){t.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","roleId","roleName"];var o=a.open({templateUrl:"deleteUserGroup-popup.html",controller:n,size:"sm",resolve:{roleId:function(){return e},roleName:function(){return t}}});o.result.then(function(){},function(){d.info("Modal dismissed at: "+new Date)})},P.goToEditUser=function(){P.newPassValid=0,P.confirmPassValid=0,P.requestError="",P.formValid=!1,P.groupFormValid=!1,P.showCreateUserGroup=!1,P.showEditUserGroup=!1,P.showCreateUser=!1,P.showEditUser=!0},P.goToCreateUser=function(e){P.showCreateUserGroup=!1,P.showEditUserGroup=!1,P.showCreateUser=!0,P.showEditUser=!1,P.newPassValid=0,P.confirmPassValid=0,P.requestError="",P.formValid=!1,f.focusById("input-username"),P.createdError={},P.selectedUserGroup=e},P.editUser=function(e){P.goToEditUser(),P.formValid=!0,P.editedUser=angular.copy(P.table[e]),P.editedUser._roleId=P.editedUser._roles[0].roleId,P.editedUser.locked?P.editedUser.locked=!0:P.editedUser.locked=!1,P.createdError={nameVoid:!1,nameOversize:!1,commentVoid:!1,commentOversize:!1,errorNumber:0}},P.delete=function(t,o){e.deleteUser(t).then(function(t){if(t.data){var a=[];a.push(e.getUsersByRoleId(o)),c.all(a).then(function(e){P.table=e[0].users}),n.addAlert({type:"success",content:"用户删除成功！"}),D()}},function(){n.addAlert({type:"danger",content:"用户删除失败！"})})},P.deleteConfirmPopup=function(e){function t(e,t,n,o,a){
e.name=o,e.ok=function(){P.delete(n,a),t.close()},e.cancel=function(){t.dismiss("cancel")}}t.$inject=["$scope","$modalInstance","userId","userName","roleId"];var n=a.open({templateUrl:"delete-popup.html",controller:t,size:"sm",resolve:{userId:function(){return e.userId},userName:function(){return e.name},roleId:function(){return e._roles[0].roleId}}});n.result.then(function(){},function(){d.info("Modal dismissed at: "+new Date)})},P.validatePassword=function(e,t){var n=v.validator(e,t,P.passwordComplexityStrategy.strategyRules[0].ruleData);return P.newPassValid=n.newPassValid,P.confirmPassValid=n.confirmPassValid,P.allValid=n.allValid,n.allValid},P.validateNewUserForm=function(){if(P.requestError="",P.formValid=!0,void 0===P.newUser)return void(P.formValid=!1);if(P.newUser.name){var e=/^[a-zA-Z0-9_]{0,20}$/;P.newUser.name.match(e)||(P.requestError="用户名不符合规则",P.formValid=!1)}else P.formValid=!1;P.newUser.stuffName||(P.formValid=!1),P.allValid||(P.formValid=!1)},P.validateEditUserForm=function(){if(P.requestError="",P.formValid=!0,void 0===P.editedUser)return void(P.formValid=!1);if(P.editedUser.name){var e=/^[a-zA-Z0-9!@#$%^&*_]{0,64}$/;P.editedUser.name.match(e)||(P.requestError="用户名不符合规则",P.formValid=!1)}else P.formValid=!1;P.editedUser.stuffName||(P.formValid=!1),P.allValid||!P.editedUser.newPassword&&!P.editedUser.confirmNewPassword||(P.formValid=!1),P.editedUser._roleId||(P.formValid=!1)},P.saveNewUser=function(){P.newPassValid=0,P.confirmPassValid=0,P.newUser.passwordHash=P.newUser.newPassword,P.newUser._roles=[{roleId:P.selectedUserGroup.roleId}],delete P.newUser._roleId,delete P.newUser.newPassword,delete P.newUser.confirmNewPassword,P.updateUserGroupPromise=e.createUser(P.newUser).then(function(e){e?(P.requestError="",P.goToUserManagerPage(),delete P.createdError,delete P.newUser,n.addAlert({type:"success",content:"创建用户成功！"}),D()):P.requestError=e.message},function(e){n.addAlert({type:"danger",content:"创建用户失败！"}),"用户名已经存在。"===e.data.error&&(P.requestError=e.data.error,P.formValid=!1,P.allValid=!1)})},P.saveEditedUser=function(){P.newPassValid=0,P.confirmPassValid=0,P.editedUser.newPassword&&(P.editedUser.passwordHash=P.editedUser.newPassword),P.editedUser._roles=[{roleId:P.editedUser._roleId}],delete P.editedUser._roleId,delete P.editedUser.newPassword,delete P.editedUser.confirmNewPassword;var t=[e.lockUser(P.editedUser.locked?"lock":"unlock",P.editedUser.userId)];"on"===P.editedUser.locked?P.editedUser.locked=!0:P.editedUser.locked=!1,t.push(e.editUser(P.editedUser)),c.all(t).then(function(){var t=[];t.push(e.getUsersByRoleId(P.editedUser._roles[0].roleId)),c.all(t).then(function(e){P.table=e[0].users,delete P.createdError,delete P.editedUser,P.goToUserManagerPage()})},function(e){"用户名已经存在。"===e.data.error&&(P.editedUser.locked=P.editedUser.locked?"on":"off",P.requestError=e.data.error,P.formValid=!1,P.allValid=!1)})},i.subRoles.map(function(e){e.groupLevel=1}),P.userGroupTree=[{name:i.currentRole.name,roleId:i.currentRole.roleId,subRoles:i.subRoles,showSubRoles:!0,subRolesLoaded:!0,groupLevel:0}],void(P.showSubRoles=function(t){if(t.showSubRoles&&!t.subRolesLoaded){var n=[];n.push(e.getUserGroup(t.roleId)),c.all(n).then(function(e){t.subRoles=e[0].subRoles,t.showSubRoles=!0,t.subRolesLoaded=!0,t.subRoles.map(function(e){e.showSubRoles=!1,e.subRolesLoaded=!1,e.groupLevel=t.groupLevel+1})})}}))}function t(e,t,n,o,a,r,i,l){var s=this;s.table=t.subUsers,s.showEditUser=!1,s.showUserTable=!0,s.currentUser=n,s.requestError="",s.createdError={},s.userLockedChanged=function(t){e.lockUser(t.locked?"lock":"unlock",t.userId).then(function(e){e.data?l.addAlert({type:"success",content:t.locked?"锁定成功！":"解锁成功!"}):(t.locked=!t.locked,l.addAlert({type:"danger",content:t.locked?"锁定失败！":"解锁失败!"}))})},s.passwordComplexityStrategy=i.getPassComplexity(r.data),s.passwordComplexityMessage=i.getPassComplexityMessage(s.passwordComplexityStrategy.strategyRules[0].ruleData),s.passwordErrormessages=i.errorMessages,s.getCurrentUserName=function(){return o.getUserName()},s.getCurrentUserRole=function(){return o.getUserRole()},s.goToUserManagerPage=function(){s.showEditUser=!1,s.showUserTable=!0,s.editedUser&&delete s.editedUser},s.goToEditUser=function(){s.newPassValid=0,s.confirmPassValid=0,s.requestError="",s.formValid=!1,s.groupFormValid=!1,s.showUserTable=!1,s.showEditUser=!0},s.editUser=function(e){s.formValid=!0,s.editedUser=angular.copy(s.table[e]),s.goToEditUser(),s.editedUser._roleId=s.editedUser._roles[0].roleId,s.editedUser.locked?s.editedUser.locked=!0:s.editedUser.locked=!1,s.createdError={nameVoid:!1,nameOversize:!1,commentVoid:!1,commentOversize:!1,errorNumber:0}},s.validatePassword=function(e,t){var n=i.validator(e,t,s.passwordComplexityStrategy.strategyRules[0].ruleData);return s.newPassValid=n.newPassValid,s.confirmPassValid=n.confirmPassValid,s.allValid=n.allValid,n.allValid},s.validateEditUserForm=function(){if(s.requestError="",s.formValid=!0,void 0===s.editedUser)return void(s.formValid=!1);if(s.editedUser.name){var e=/^[a-zA-Z0-9!@#$%^&*_]{0,64}$/;s.editedUser.name.match(e)||(s.requestError="用户名不符合规则",s.formValid=!1)}else s.formValid=!1;s.editedUser.stuffName||(s.formValid=!1),s.allValid||!s.editedUser.newPassword&&!s.editedUser.confirmNewPassword||(s.formValid=!1),s.editedUser._roleId||(s.formValid=!1),s.formValid=s.validatePassword(s.editedUser.newPassword,s.editedUser.confirmNewPassword)},s.saveEditedUser=function(){s.newPassValid=0,s.confirmPassValid=0,s.editedUser.newPassword&&(s.editedUser.passwordHash=s.editedUser.newPassword),s.editedUser._roles=[{roleId:s.editedUser._roleId}],delete s.editedUser._roleId,delete s.editedUser.newPassword,delete s.editedUser.confirmNewPassword;var t=[e.lockUser(s.editedUser.locked?"lock":"unlock",s.editedUser.userId)];"on"===s.editedUser.locked?s.editedUser.locked=!0:s.editedUser.locked=!1,t.push(e.editUser(s.editedUser)),a.all(t).then(function(){var t=[];t.push(e.getDefaultUser()),a.all(t).then(function(e){s.table=e[0].subUsers,delete s.createdError,delete s.editedUser,s.goToUserManagerPage()})},function(e){"用户名已经存在。"===e.data.error&&(s.editedUser.locked=s.editedUser.locked?"on":"off",s.requestError=e.data.error,s.formValid=!1,s.allValid=!1)})}}e.$inject=["SystemUser","System","$rootScope","$scope","$modal","users","roles","user","auth","$q","$log","Enum","Device","autofocusCtrl","uiCtrl","strategyInfo","constantService","passwordValidationService","$state"],t.$inject=["SystemUser","users","user","auth","$q","strategyInfo","passwordValidationService","$rootScope"],angular.module("southWest.systemuser").controller("SystemUserCtrl",e).controller("RootUserCtrl",t)}(),function(){"use strict";function e(){function e(e,t,n){e.privilege=n.privilege,e.type=parseInt(n.type)||3}var t={scope:!0,restrict:"E",replace:!0,templateUrl:"/templates/systemuser/privilege-edit.a37e423c.html",link:e};return t}angular.module("southWest.systemuser").directive("privilegeEdit",e)}(),function(){"use strict";function e(e){e.state("todolist",{parent:"dashboard",url:"/todolist",templateUrl:"templates/todolist/index.4a85b685.html",resolve:{state:["$rootScope",function(e){e.currentState="MY_ACCOUNT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.todolist").config(e)}(),function(){"use strict";function e(e,t,n,o){function a(e,a,r,i){function l(e){e.$orderby&&""!==e.$orderby||(e.$orderby="createdAt desc");var n=e||{};return n.$filter=c,t.getTodoList(n).then(function(e){return e})}function s(){var e={};return e.$filter=c,t.getTodoList(e).then(function(e){return o.$broadcast("todolist_refresh",e.length),e.length})}i.disableSearch=!0,i.disableToolbar=!0,e.showDetail=!1;var c="(todoListStatus eq PENDING or todoListStatus eq READ)";i.setConfig({name:"待办事宜",pagination:!0,scrollable:!1,totalCount:!0,getAll:l,getCount:s}),e.filter="all",e.$on("newToDoListInsert",function(){e.shouldFlash=!0}),e.updateTodoItem=function(e,n){"PENDING"===e.todoListStatus&&o.$broadcast("todolist_reduce"),e.todoListStatus=n,t.updateTodoList(e.todoListId,e).then(function(){i.refresh()})},e.viewDetail=function(a){function r(n,r){n.item=a,n.cancel=function(){r.dismiss("cancel")},n.decline=function(t){e.updateTodoItem(t,"DECLINED"),i.refresh(),r.close("done")},n.confirm=function(n){t.doTodoItem(n).then(function(t){t.error?o.addAlert({type:"danger",content:n.content+" - 失败! "+t.error}):(o.addAlert({type:"success",content:n.content+" - 成功"}),e.updateTodoItem(n,"DONE"))}),i.refresh(),r.close("done")}}if(r.$inject=["$scope","$modalInstance"],"MALICIOUS_DOMAIN"===a.todoListType)return e.updateTodoItem(a,"DONE"),void(window.location.href="/rule/maliciousdomain?panel=waiting");"PENDING"===a.todoListStatus&&(e.updateTodoItem(a,"READ"),o.$broadcast("todolist_reduce"));var l=n.open({templateUrl:"templates/todolist/todoList-modal.991f7185.html",controller:r,size:"sm"});l.result.then(function(e){},function(){})}}var r={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/todolist/todoListTable.46961237.html",link:a};return r}function t(e,t,n){function o(e,o,a,r){function i(e){e.$orderby&&""!==e.$orderby||(e.$orderby="createdAt desc");var n=e||{};return n.$filter=s,t.getTodoList(n).then(function(e){return e})}function l(){var e={};return e.$filter=s,t.getTodoList(e).then(function(e){return e.length})}r.disableSearch=!0,r.disableToolbar=!0,e.showDetail=!1;var s="(todoListStatus eq DECLINED or todoListStatus eq DONE)";r.setConfig({name:"已办事宜",pagination:!0,scrollable:!1,totalCount:!0,getAll:i,getCount:l}),e.filter="all",e.viewDetail=function(e){function t(t,n){t.item=e,t.cancel=function(){n.dismiss("cancel")}}if(t.$inject=["$scope","$modalInstance"],"MALICIOUS_DOMAIN"===e.todoListType)return void(window.location.href="/rule/maliciousdomain?panel=waiting");var o=n.open({templateUrl:"templates/todolist/todoList-modal.991f7185.html",controller:t,size:"sm"});o.result.then(function(e){},function(){})}}var a={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/todolist/todoListTable.46961237.html",link:o};return a}e.$inject=["$q","Dashboard","$modal","$rootScope"],t.$inject=["$q","Dashboard","$modal"],angular.module("southWest.todolist").directive("todoListTable",e).directive("doneListTable",t)}(),function(){"use strict";function e(e,t,n,o,a){return{scope:!1,restrict:"E",templateUrl:"/templates/topology/singleTopo/allInOneHeader.36b20e5c.html",link:function(r,i){r.uploadTopologyModal=function(){function e(e,t,n,o,a,r,i,l){e.isDPIUpgrading=r.isDPIUpgrading(),l.$on("dpiUpgradeState",function(){e.isDPIUpgrading=r.isDPIUpgrading()});var s=e.uploader=new o({url:a+"/files/topology/"+i.id+"/fileupload",autoUpload:!0,removeAfterUpload:!0,queueLimit:1});s.onSuccessItem=function(e,t,n){l.$broadcast("updateDashboardHeader"),t.warningInfos.length?l.addAlert({type:"warning",content:"警告!"+t.warningInfos}):200===n&&l.addAlert({type:"success",content:"拓扑文件上传成功"})},s.onProgressAll=function(){t.close()},s.onErrorItem=function(e,t){l.addAlert({type:"danger",content:t.error})},e.ok=function(){t.close()},e.cancel=function(){t.dismiss("cancel")}}e.$inject=["$scope","$modalInstance","$state","FileUploader","URI","System","topologyId","$rootScope"];var t=n.open({animation:!0,templateUrl:"upload-confirmation.html",controller:e,size:"sm",resolve:{scope:function(){return r},element:function(){return i}}});t.result.then(function(){},function(){a.info("Modal dismissed at: "+new Date)})},r.deployAllEndpoint=function(){o.getDomain().then(function(n){e.deployAllEndpoint(n[0].domainInfo.currentTopologyId).then(function(e){e.data&&"SUCCESS"===e.data.state?t.addAlert({type:"success",content:"配置所有终端成功"}):t.addAlert({type:"danger",content:"配置所有终端失败"+(e.data&&e.data.reason?": "+e.data.reason:"")})},function(e){t.addAlert({type:"danger",content:"配置所有终端失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})})}}}}function t(e,t,n,o,a,r,i,l,s,c,d,u){function p(t,n,o,d){var p=0,f=0,m=n.defer();t.isDPIUpgrading=d.isDPIUpgrading(),r.$on("dpiUpgradeState",function(){t.isDPIUpgrading=d.isDPIUpgrading()});var g=this;this.hovered=100,this.linkPromise=m.promise,this.gridPattern={stroke:"#333333",strokeWidth:.8},this.nodeBGBrush="#000",this.nodeSelectionBrush="#76B900",this.nodeTopFillBrush="#1C418F",this.nodeTextBrush="#E4E4E4",this.nodeTopFont="10pt SourceHanSansCN-Regular",this.nodeFont="8pt SourceHanSansCN-Regular",this.iconFont="8pt FontAwesome",this.statusOffBrush="#FE540F",this.centerConnectorStroke="#76B900",this.centerConnectorFill="black",this.connectorBrush="#E4E4E4",this.linkBrush="#CCCCCC",this.linkOpacity=.5,this.linkHighlightBrush="#76B900",this.linkHighlightOpacity=.5,this.tooltipBGBrush="#E6E6E6",this.deviceColor="",this.invalid=!1,this.location=c.$$host,this.getDeviceColor=function(e){var t="#193984";switch(e){case"SECURITY_DEVICE":t="#814E00";break;case"FACTORY_DEVICE":t="#102B6B";break;case"NETWORK_DEVICE":t="#056555"}return t},this.level=[],this.levelInfo={},this.holder,t.currentNode={orderID:null},t.showOptions=!1,t.optionsStyle={position:"absolute",left:p+"px",top:f+"px"},t.saveChange=function(){e.updateNode(t.currentNodeCopy).then(function(){angular.copy(t.currentNodeCopy,t.currentNode)})},t.detailStyle={position:"absolute",left:"0px",top:"0px"},t.showDetailPanel=!1,t.calculatePosition=function(){t.detailStyle.left=p+30+"px",t.detailStyle.top=f+"px"},this.setPosition=function(e,n){t.optionsStyle.left=e+65+"px",t.optionsStyle.top=n-10+"px"},t.topo||(t.topo=""),t.downloadTopo=function(){e.downloadLink(t.currentTopo.topologyId).then(function(e){window.open("./"+e,"_self")})},t.discoverTopo=function(){o.transitionTo("topology.discovery")},t.pv=i.get("privilege").filter(function(e){return e.name===r.currentState})[0].actionValue,t.render=function(o){l.getDomain().then(function(r){r&&r[0].domainInfo.currentTopologyId?(t.topo&&r[0].domainInfo.currentTopologyId!==t.topo||(t.switchAlternate="on"),t.topo||(t.topo=r[0].domainInfo.currentTopologyId),t.noTopo=!1):t.noTopo=!t.topo,t.topo&&(m.resolve(t.topo),e.getTopo(t.topo).then(function(r){var i=r,l=[];l.push(e.getNodes(t.topo)),l.push(e.getLinks(t.topo)),l.push(e.getDevices(t.topo)),l.push(a.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$limit:1e6,$orderby:"model_name"})),l.push(a.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq FACTORY_DEVICE",$limit:1e6,$orderby:"model_name"})),l.push(a.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq NETWORK_DEVICE",$limit:1e6,$orderby:"model_name"})),l.push(a.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq SECURITY_DEVICE",$limit:1e6,$orderby:"model_name"})),n.all(l).then(function(e){i.nodes=e[0].data,i.links=e[1].data,i.devices=e[2].data,e[3][0].model_name||e[3][0].make||e[3][0].model?"":i.blankModel=e[3][0].modelId,g.factory_models=e[4],g.network_models=e[5],g.security_models=e[6],t.topologyHasNode=s.hasNode,t.currentTopo=i,o?t.putDiagramData(i):t.drawTopo(i)})}))})},this.updateDiagram=function(o){n.all([u.autoLogin(o)]).then(function(){e.getTopo(t.topo,o).then(function(r){var i=r,l=[];l.push(e.getNodes(t.topo,o)),l.push(e.getLinks(t.topo,o)),l.push(e.getDevices(t.topo,o)),l.push(a.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$limit:1e6,$orderby:"model_name"})),n.all(l).then(function(e){i.nodes=e[0].data,i.links=e[1].data,i.devices=e[2].data,e[3][0].model_name||e[3][0].make||e[3][0].model?"":i.blankModel=e[3][0].modelId,t.putDiagramData(i)})})})},t.render()}function f(n,o,i,l){function s(){var e=document.getElementsByTagName("MAIN")[0].offsetHeight;document.getElementById("singleTopoIndexDiv").style.height=e+"px",document.getElementById("topologySingle").style.height=(window.innerHeight-190>800?800:window.innerHeight-190)+"px"}n.$on("$destroy",function(){t.unsubscribe("node")}),document.getElementsByTagName("MAIN")[0].style.overflowY="hidden",window.onresize=function(){document.getElementById("singleTopoIndexDiv")?s():""},s(),l.linkPromise.then(function(o){function i(){D.startTransaction("removePortFinal");var e=[];D.selection.each(function(t){(t instanceof go.Node||t instanceof go.Link)&&e.push(t)});for(var t=0;t<e.length;t++)D.remove(e[t]);D.commitTransaction("removePortFinal")}function s(t){if((4&n.pv)>0){var o=D.findPartAt(t.diagram.lastInput.documentPoint,!1);null!==o&&(o.selectionAdorned=!1);for(var a=t.diagram.selection.iterator;a.next();)if(a.value instanceof go.Node&&a.value.data.deviceId){var r={id:a.value.data.nodeId,x:a.value.location.x,y:a.value.location.y};e.updatePosition(r)}}}function c(){D.startTransaction("highlight"),D.clearHighlighteds();var e=[];D.selection.each(function(t){t instanceof go.Node&&(t.findLinksConnected().each(function(e){e.isHighlighted=!0}),e.push(t.data))}),1===e.length&&(f(e[0]),l.lastSelection=e[0].key),D.commitTransaction("highlight")}function u(e){f(e.data),e.data.deviceId&&a.getACLInfo(e.data.deviceId).then(function(e){n.hasacltable=!1,e.length>0&&(n.hasacltable=!0),n.acltable=e},function(){n.hasacltable=!1}),D.select(e)}function p(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,o){var a=n[e]<o[e]?-1:n[e]>o[e]?1:0;return a*t}}function f(e){if(n.selectedDeviceInTable=e,n.selectedDeviceInTable.ports){for(var t=0;t<n.selectedDeviceInTable.ports.length;t++)"mgmt"!==n.selectedDeviceInTable.ports[t].portName.toLowerCase()&&(n.selectedDeviceInTable.ports[t].index=+n.selectedDeviceInTable.ports[t].portName.substr(1));n.selectedDeviceInTable.ports.sort(p("index"));for(var o=0;o<n.selectedDeviceInTable.ports.length;o++)"mgmt"!==n.selectedDeviceInTable.ports[o].portName.toLowerCase()&&delete n.selectedDeviceInTable.ports[o].index;n.selectedDeviceInTable.ports.sort(p("index"))}}function m(e){e.subject.part.data.key&&e.subject.part.data.deviceId&&a.getACLInfo(e.subject.part.data.deviceId).then(function(e){n.hasacltable=!1,e.length>0&&(n.hasacltable=!0),n.acltable=e},function(){n.hasacltable=!1}),n.$digest()}function g(e){function o(e){D.startTransaction("连掉线"),D.model.nodeDataArray.forEach(function(t,n){var o=!1;if(D.devicesNodeMapCopy[t.deviceId]===e.id)o=!0;else for(var a=0;a<D.devicesNodeMapCopy[t.deviceId].length;a++)if(D.devicesNodeMapCopy[t.deviceId][a]===e.id){o=!0;break}o&&(e.online===-1?(D.model.nodeDataArray[n].statusText="掉线",D.model.nodeDataArray[n].statusColor="red",D.model.setDataProperty(D.model.nodeDataArray[n],"statusIconShow",!0),D.model.setDataProperty(D.model.nodeDataArray[n],"deviceOnline",e.online)):1===e.online&&(D.model.nodeDataArray[n].statusText="连线",D.model.nodeDataArray[n].statusColor="green",D.model.setDataProperty(D.model.nodeDataArray[n],"statusIconShow",!1),D.model.setDataProperty(D.model.nodeDataArray[n],"deviceOnline",e.online)))}),D.commitTransaction("连掉线"),D.requestUpdate()}D.doMouseWheel=function(){l.over&&(this.lastInput.control=!0,D.toolManager.doMouseWheel()),localStorage.setItem("monitor:topology.scale."+e.topologyId,D.scale)},v(e),r.$on("updateDashboardHeader",function(){n.render("update");for(var e=0;e<D.model.nodeDataArray.length;e++)D.model.nodeDataArray[e].currentTopology=!D.model.nodeDataArray[e].currentTopology}),t.listen("node",n,o)}function h(e,t,n,o,a){this.from=t,this.to=n,this.fromPort=o,this.toPort=a,this.color="gray",this.toArrow="",this.strokeWidth="1",this.linkId=e,this.link=go.Link.AvoidsNodes}function v(e){if(l.levelInfo[e.ip])return D.model=l.levelInfo[e.ip].model,D.model.linkFromPortIdProperty="fromPort",D.model.linkToPortIdProperty="toPort",D.model.linkToPortIdProperty="toPort",void(D.model.isReadOnly=!0);var t=[],o=[];if(0===l.level.length){D.nodeTemplate.doubleClick=function(e,t){1===t.data.deviceOnline&&t.data.ip!==l.level[0].ip&&l.level.length<=1&&(l.level.push({name:t.data.nameInDetail,ip:t.data.ip}),n.$digest(),l.levelInfo[t.data.ip]?v({ip:t.data.ip}):(l.holder=t.data.ip,l.updateDiagram(t.data.ip)))};var r=1,i={key:r,iconType:"remote",topologyId:e.topologyId,modelId:"cloud",img:"images/devices/security/kep-icon.png",loc:"0 0",nameInDetail:"远端监管平台",category:"CLOUD",manufacturerInDetail:"匡恩网络",modelInDetail:"KEP-C2000",updateTime:e.updatedAt,statusIconShow:!1,portIdRef:!0,ip:l.location};t.push(i),r++;for(var s=0;s<e.devices.length;s++){var c=e.devices[s];if("SECURITY_DEVICE"===c.category){for(var p=c.updatedAt,f="",m="",g="",y=0;y<c.devicePorts.length;y++)c.devicePorts[y].isMgmtPort&&(f=c.devicePorts[y].linkState||"",m=c.devicePorts[y].portIp||"",g=c.devicePorts[y].mac||"");i={key:r,topologyId:e.topologyId,currentTopology:e.currentTopology,deviceId:c.deviceId,img:"SECURITY_DEVICE"===c.category?a.getSecurityDeviceIconPath(c._model_name,c.iconType):"images/"+c.iconType.toLowerCase()+"-icon.png",iconType:c.iconType.toLowerCase(),loc:-200*e.devices.length/2+200*r+" 200",nameInDetail:c.name,manufacturerInDetail:c&&c.make?c.make:"",modelId:c&&c.modelId?c.modelId:"",modelInDetail:c&&c._model_name?c._model_name:"",versionInDetail:c&&c.version?c.version:"",serialNumber:c.serialNumber?c.serialNumber:"",ruleOnNode:"",countOfIncident:"",unreadCountOfIncident:"",mmgtPort:f,deviceOnline:c.deviceOnline,updateTime:p,mac:g,ip:m,ports:"switch"!==c.iconType.toLowerCase()?c.devicePorts:"",numPorts:c.devicePorts.length,category:c.category,subcategory:c._subCategory,startDatetime:c.startDatetime},r++,1===e.devices[s].deviceOnline?(i.statusText="连线",i.statusIconShow=!1,i.statusColor="green"):0===e.devices[s].deviceOnline&&e.devices[s]&&"SECURITY_DEVICE"===e.devices[s].category?(i.statusText="未激活",i.statusIconShow=!0,i.statusColor="red"):e.devices[s].deviceOnline===-1?(i.statusText="掉线",i.statusIconShow=!0,i.statusColor="red"):(i.statusText="",i.statusIconShow=!1,i.statusColor="white"),t.push(i);var I=new h(1,t[0].key,i.key,"unspecified","unspecified");I.link=go.Link.Normal,o.push(I)}}var T=d.getAllDomains();for(s=1;s<t.length;s++)T[s-1]?t[s].ip=T[s-1].ip:"",t[s].loc=-200*t.length/2+200*(t[s].key-1)+" 200";D.model=new go.GraphLinksModel(t,o),u(D.findNodeForKey(D.model.nodeDataArray[0].key)),l.holder=l.location,l.level.push({name:"远端总览",ip:l.location})}else{D.topologyId=e.topologyId;var b=function(e,t,n){var o=["",""];if(e)for(var a=0;a<e.length;a++)if(e[a]!==n){var r=!1;if(t)for(var i=0;i<t.length;i++)2===t[i].length&&(t[i][0]===e[a]&&t[i][1]===n||t[i][0]===n&&t[i][1]===e[a])&&(r=!0,o[1].length>0&&(o[1]+=","),o[1]+=e[a]);r||(o[0].length>0&&(o[0]+=","),o[0]+=e[a])}return o};n.routingIPS=!1;for(var S=[],P={},A={},C={},k={},w={},E=0;E<e.devices.length;E++){P[e.devices[E].deviceId]=[],A[e.devices[E].deviceId]=[];for(var N=0;N<e.devices[E].devicePorts.length;N++)P[e.devices[E].deviceId].push(-1),A[e.devices[E].deviceId].push(-1)}for(var $=0;$<e.nodes.length;$++)if("CLOUD"===e.nodes[$].type){var M={key:e.nodes[$].id,nodeId:e.nodes[$].id,iconType:"cloud",topologyId:e.nodes[$].topologyId,currentTopology:e.currentTopology,modelId:"cloud",img:"images/cloud-icon.727f8e55.png",loc:e.nodes[$].x+" "+e.nodes[$].y,nameInDetail:e.nodes[$].name,category:"NETWORK_DEVICE",updateTime:e.updatedAt,statusIconShow:!1,portIdRef:!0,nodeType:"CLOUD",deviceId:"cloud"};S.push(M)}else{k[e.nodes[$].id]=e.nodes[$].deviceId,C[e.nodes[$].deviceId]={positionNodeId:e.nodes[$].id,loc:e.nodes[$].x+" "+e.nodes[$].y,x:e.nodes[$].x,y:e.nodes[$].y,iconType:a.getIconName(e.nodes[$]._iconType),nodeType:e.nodes[$].type,subcategory:e.nodes[$]._subcategory},n.routingIPS||"ROUTING_IPS"!==e.nodes[$].type||(n.routingIPS=!0);for(var R=0;R<e.devices.length;R++)if(e.devices[R].deviceId===e.nodes[$].deviceId){if(e.nodes[$].ports&&e.devices[R].devicePorts.length>1){for(var U=0;U<e.nodes[$].ports.length;U++)for(var _=0;_<e.devices[R].devicePorts.length;_++)if(e.devices[R].devicePorts[_].portName===e.nodes[$].ports[U]){P[e.devices[R].deviceId][_]=e.nodes[$].id,"ips"===e.nodes[$].type.toLowerCase()?A[e.devices[R].deviceId][_]=e.nodes[$].id:A[e.devices[R].deviceId]=e.nodes[$].id;break}}else A[e.devices[R].deviceId]=e.nodes[$].id;break}}for(var x=1,O={},L={},B=!1,V=[],j=0;j<e.devices.length;j++){var W=e.devices[j];if(C[W.deviceId]){for(var F=W.updatedAt,H="",G="",z="",q=0;q<W.devicePorts.length;q++)W.devicePorts[q].isMgmtPort&&(H=W.devicePorts[q].linkState||"",G=W.devicePorts[q].portIp||"",z=W.devicePorts[q].mac||"");O[W.deviceId]=x;var Y,K="ROUTING_IPS"===C[W.deviceId].nodeType;if(K){var J;for($=0;$<e.nodes.length;$++)if(e.nodes[$].deviceId===W.deviceId){if(W&&W.notConnectedPortMap)for(Y=W.notConnectedPortMap.split(/\[(.*?)\]/g),J=Y.length-1;J>=0;J--)Y[J].length<2?Y.splice(J,1):Y[J]=Y[J].split(",");if(W.devicePorts)for(J=0;J<W.devicePorts.length;J++)for(var Z=0;Z<W.devicePorts.length;Z++)W.devicePorts.index=Z,W.devicePorts[J].portName==="p"+Z&&(W.devicePorts[J].index=+W.devicePorts[J].portName.substr(1),W.devicePorts[J].connection=b(e.nodes[$].ports,Y,"p"+Z))}}var Q=C[W.deviceId].nodeType&&"ROUTING_IPS"===C[W.deviceId].nodeType?"路由保护":C[W.deviceId].nodeType&&("IDS"===C[W.deviceId].nodeType?"监测审计":C[W.deviceId].nodeType&&("IPS"===C[W.deviceId].nodeType?"DATA_COLLECTION_DEVICE"===W._subCategory?"数采隔离":"智能保护":"")),X={key:-x,nodeId:C[W.deviceId].positionNodeId,topologyId:e.topologyId,currentTopology:e.currentTopology,deviceId:W.deviceId,img:"SECURITY_DEVICE"===W.category?a.getSecurityDeviceIconPath(W._model_name,W.iconType):"images/"+C[W.deviceId].iconType.toLowerCase()+"-icon.png",iconType:C[W.deviceId].iconType.toLowerCase(),loc:C[W.deviceId].loc,nameInDetail:W.name,manufacturerInDetail:W&&W.make?W.make:"",modelId:W&&W.modelId?W.modelId:"",modelInDetail:W&&W._model_name?W._model_name:"",versionInDetail:W&&W.version?W.version:"",serialNumber:W.serialNumber?W.serialNumber:"",modeDescription:Q,ruleOnNode:"",countOfIncident:"",unreadCountOfIncident:"",showMode:Q.length>0,routingMode:K,mmgtPort:H,deviceOnline:W.deviceOnline,updateTime:F,mac:z,ip:G,ports:"switch"!==C[W.deviceId].iconType.toLowerCase()?W.devicePorts:"",numPorts:W.devicePorts.length,rightArray:[],leftArray:[],nearArray:[],farArray:[],category:W.category,subcategory:W._subCategory,nodeType:C[W.deviceId].nodeType,isEdited:!1,invalid:!1,startDatetime:W.startDatetime};if(C[W.deviceId].devicePorts=X.ports,"ips"!==C[W.deviceId].nodeType.toLowerCase())X.portIdRef=!0;else{X.portIdRef=!1;for(var ee=0;ee<X.ports.length;ee++)X.ports[ee].isMgmtPort||(Number(X.ports[ee].portName.substr(1))%2===0?(X.nearArray.push({portName:X.ports[ee].portName+"near"}),X.leftArray.push({portName:X.ports[ee].portName})):(X.farArray.push({portName:X.ports[ee].portName+"far"}),X.rightArray.push({portName:X.ports[ee].portName})));for(ee=0;ee<X.leftArray.length;ee++)V.push(new h((-1),(-x),(-x),X.nearArray[ee].portName,X.farArray[ee].portName))}1===W.deviceOnline?(X.statusText="连线",X.statusIconShow=!1,X.statusColor="green"):0===W.deviceOnline&&W&&"SECURITY_DEVICE"===W.category?(X.statusText="未激活",X.statusIconShow=!0,X.statusColor="red"):W.deviceOnline===-1?(X.statusText="掉线",X.statusIconShow=!0,X.statusColor="red"):(X.statusText="",X.statusIconShow=!1,X.statusColor="white"),B||"SECURITY_DEVICE"!==X.category||(B=x-1);var te={};for(var ne in X)X.hasOwnProperty(ne)&&(te[ne]=X[ne]);t.push(X),L[x]=X,w[te.deviceId]=te,x++}}for(var oe=0;oe<S.length;oe++)O[x]=x,L[x]=S[oe].key,k[S[oe].key]=x,A[x]=S[oe].key,S[oe].key=-x,t.push(S[oe]),x++;for(var ae={},re=0;re<e.links.length;re++){var ie=-O[k[e.links[re].nodeID]],le=-O[k[e.links[re].destinationNodeID]],se="unspecified",ce="unspecified";if(C[k[e.links[re].nodeID]]&&"ips"===C[k[e.links[re].nodeID]].nodeType.toLowerCase())for(var de=0;de<P[k[e.links[re].nodeID]].length;de++)if(P[k[e.links[re].nodeID]][de]===e.links[re].nodeID){P[k[e.links[re].nodeID]][de]=-1,se=C[k[e.links[re].nodeID]].devicePorts[de].portName;break}if(C[k[e.links[re].destinationNodeID]]&&"ips"===C[k[e.links[re].destinationNodeID]].nodeType.toLowerCase())for(var ue=0;ue<P[k[e.links[re].destinationNodeID]].length;ue++)if(P[k[e.links[re].destinationNodeID]][ue]===e.links[re].destinationNodeID){P[k[e.links[re].destinationNodeID]][ue]=-1,ce=C[k[e.links[re].destinationNodeID]].devicePorts[ue].portName;break}o.push(new h(e.links[re].id,ie,le,se,ce)),ae[e.links[re].id]=new h(e.links[re].id,ie,le,se,ce)}for(o=o.concat(V),D.linkCopy=ae,w.length=t.length,D.nodeCopy=w,D.devicesNodeMapCopy=A,L.length=t.length,D.keyToDevice=L,D.allData=e,D.currentTopology=e.currentTopology,D.topologyId=e.topologyId,D.blankModelId=e.blankModel,D.model=new go.GraphLinksModel(t,o),D.model.linkFromPortIdProperty="fromPort",D.model.linkToPortIdProperty="toPort",D.model.isReadOnly=!0,n.topologyHasNode&&(B=B===!1?0:B,u(l.lastSelection!==!1&&D.findNodeForKey(-O[l.lastSelection])?D.findNodeForKey(-O[l.lastSelection]):D.findNodeForData(D.model.nodeDataArray[B]))),n.oldData=[],re=0;re<D.model.nodeDataArray.length;re++){var pe={deviceId:D.model.nodeDataArray[re].deviceId,serialNumber:D.model.nodeDataArray[re].serialNumber,ip:D.model.nodeDataArray[re].ip};n.oldData.push(pe)}}l.levelInfo[l.holder]={model:new go.GraphLinksModel(t,o),topo:e},D.model.linkFromPortIdProperty="fromPort",D.model.linkToPortIdProperty="toPort",D.model.isReadOnly=!0}var y=go.GraphObject.make,I=y(go.Adornment,"Vertical",y("ContextMenuButton",y(go.TextBlock,"删除设备"),{click:function(){i()}})),D=y(go.Diagram,"topologySingle",{initialContentAlignment:go.Spot.TopCenter,scale:null===localStorage.getItem("monitor:topology.scale."+o)?1:parseFloat(localStorage.getItem("monitor:topology.scale."+o)),"toolManager.mouseWheelBehavior":go.ToolManager.WheelZoom,"undoManager.isEnabled":!0,allowDrop:!0,grid:y(go.Panel,"Grid",{gridCellSize:new go.Size(50,50)},y(go.Shape,"LineH",l.gridPattern),y(go.Shape,"LineV",l.gridPattern))});D.scrollMode=go.Diagram.InfiniteScroll,D.nodeTemplate=y(go.Node,"Spot",{margin:50,name:"NODE",selectionAdorned:!1,deletable:!1},new go.Binding("location","loc",go.Point.parse),new go.Binding("deletable","deviceId",function(e){return!e}),new go.Binding("contextMenu","deviceId",function(e){return e?"":I}),y(go.Panel,"Table",{toolTip:y(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},y(go.Shape,"Rectangle",{isPanelMain:!0,fill:l.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),y(go.Panel,"Vertical",{margin:10},y(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN)},new go.Binding("text","nameInDetail",function(e){return"设备名称: "+e})),y(go.TextBlock,{text:"",alignment:go.Spot.Left},new go.Binding("visible","category",function(e){return"SECURITY_DEVICE"===e}),new go.Binding("text","statusText",function(e){return"设备状态: "+e})),y(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN)},new go.Binding("visible","iconType",function(e){return!(["cloud","remote"].indexOf(e)>=0)}),new go.Binding("text","modelInDetail",function(e){return"型号: "+e})),y(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN)},new go.Binding("visible","iconType",function(e){return!(["cloud","subnet","switch"].indexOf(e)>=0)}),new go.Binding("text","ip",function(e){return"IP: "+e})),y(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN)},new go.Binding("visible","iconType",function(e){return!(["cloud","subnet","switch","remote"].indexOf(e)>=0)}),new go.Binding("text","mac",function(e){return"MAC: "+e}))))},y(go.Panel,"Auto",{row:1,column:1,name:"BODY"},y(go.Shape,"RoundedRectangle",{fill:null,strokeWidth:2,stroke:null,portId:"unspecified"},new go.Binding("fill","isSelected",function(e){return e?l.nodeSelectionBrush:null}).ofObject("")),y(go.Panel,"Auto",{alignment:go.Spot.Top},y(go.Shape,"RoundedRectangle",{width:100,fill:l.nodeTopFillBrush,stroke:null,name:"TextBox"},new go.Binding("fill","",function(e){return"remote"===e.iconType?"#737272":l.getDeviceColor(e.category)})),y(go.TextBlock,{margin:new go.Margin(2,0,6,0),stroke:l.nodeTextBrush,isMultiline:!1,width:90,font:l.nodeTopFont,textAlign:"center",overflow:go.TextBlock.OverflowEllipsis,
wrap:go.TextBlock.None,name:"TEXT"},new go.Binding("text","nameInDetail",function(e){return 1===l.level.length&&"远端监管平台"!==e?e+"":e}))),y(go.Shape,"Rectangle",{alignment:go.Spot.Top,width:100,fill:l.nodeBGBrush,stroke:null,height:10,margin:new go.Margin(20,0,0,0)}),y(go.Panel,"Auto",{margin:new go.Margin(20,0,0,0)},y(go.Shape,"RoundedRectangle",{width:100,fill:l.nodeBGBrush,strokeWidth:3,stroke:null}),y(go.Panel,"Vertical",{margin:new go.Margin(0,5,0,5)},y(go.Panel,"Auto",y(go.Picture,{margin:new go.Margin(5),width:80,height:65,imageStretch:go.GraphObject.Uniform},new go.Binding("source","img")),y(go.Picture,{name:"OfflineIcon",margin:new go.Margin(0,0,0,0),width:60,height:55,source:"/images/Warning.f7811348.png"},new go.Binding("visible","statusIconShow"))),y(go.TextBlock,{stroke:l.nodeTextBrush,textAlign:"center",margin:new go.Margin(0,0,0,0),wrap:go.TextBlock.None,font:l.nodeFont,height:9},new go.Binding("visible","iconType",function(e){return!(["cloud","subnet","switch"].indexOf(e)>=0)}),new go.Binding("text","ip",function(e){return e&&0!==e.length?e:"未知"}),new go.Binding("stroke","statusIconShow",function(e){return e?l.statusOffBrush:l.nodeTextBrush}))),y(go.Shape,"Circle",{fill:l.centerConnectorFill,desiredSize:new go.Size(16,16),strokeWidth:4,stroke:l.centerConnectorStroke,fromLinkable:!0,toLinkable:!0,name:"middlePort"},new go.Binding("opacity","",function(){return l.EditMode?1:0}),new go.Binding("portId","portIdRef",function(e){return e?"foreGround":"security"}),new go.Binding("cursor","",function(){return l.EditMode?"pointer":"default"}),new go.Binding("visible","portIdRef")))),y(go.Panel,"Vertical",new go.Binding("itemArray","nearArray"),{row:1,column:0,itemTemplate:y(go.Panel,{fromSpot:go.Spot.Right,toSpot:go.Spot.Left},new go.Binding("portId","portName"),y(go.Shape,"Rectangle",{stroke:null,fill:null,desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)}))}),y(go.Panel,"Vertical",new go.Binding("itemArray","farArray"),{row:1,column:2,itemTemplate:y(go.Panel,{fromSpot:go.Spot.Right,toSpot:go.Spot.Left},new go.Binding("portId","portName"),y(go.Shape,"Rectangle",{stroke:null,fill:null,desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)}))}),y(go.Panel,"Vertical",new go.Binding("itemArray","rightArray"),{row:1,column:2,itemTemplate:y(go.Panel,{mouseEnter:function(e,t){l.hovered=Math.floor(Number(t.data.portName[1])/2),D.updateAllTargetBindings("portName")},mouseLeave:function(){l.hovered=100,D.updateAllTargetBindings("portName")},fromSpot:go.Spot.Right,toSpot:go.Spot.Right,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),y(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)},new go.Binding("fill","portName",function(e){return Math.floor(Number(e[1])/2)===l.hovered?l.centerConnectorStroke:l.connectorBrush}),new go.Binding("cursor","",function(){return l.EditMode?"pointer":"default"})),{toolTip:y(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},y(go.Shape,"Rectangle",{isPanelMain:!0,fill:l.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),y(go.Panel,"Vertical",{margin:10},y(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN)},new go.Binding("text","portName",function(e){return"端口: "+e}))))})}),y(go.Panel,"Vertical",new go.Binding("itemArray","leftArray"),{row:1,column:0,itemTemplate:y(go.Panel,{mouseEnter:function(e,t){l.hovered=Math.floor(Number(t.data.portName[1])/2),D.updateAllTargetBindings("portName")},mouseLeave:function(){l.hovered=100,D.updateAllTargetBindings("portName")},fromSpot:go.Spot.Left,toSpot:go.Spot.Left,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),y(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)},new go.Binding("fill","portName",function(e){return Math.floor(Number(e[1])/2)===l.hovered?l.centerConnectorStroke:l.connectorBrush}),new go.Binding("cursor","",function(){return l.EditMode?"pointer":"default"})),{toolTip:y(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},y(go.Shape,"Rectangle",{isPanelMain:!0,fill:l.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),y(go.Panel,"Vertical",{margin:10},y(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN)},new go.Binding("text","portName",function(e){return"端口: "+e}))))})})));var T=y(go.Adornment,"Vertical",y("ContextMenuButton",y(go.TextBlock,"删除连线"),{click:function(){i()}}));D.linkTemplate=y(go.Link,{curve:go.Link.JumpOver,routing:go.Link.AvoidsNodes,contextMenu:T,relinkableFrom:!0,relinkableTo:!0},new go.Binding("contextMenu","",function(){return l.EditMode?T:null}),new go.Binding("selectable","linkId",function(e){return e!==-1}),new go.Binding("routing","link"),y(go.Shape,{strokeWidth:15,stroke:"transparent",isPanelMain:!0},new go.Binding("visible","linkId",function(e){return!(e===-1&&!l.EditMode)})),y(go.Shape,{strokeWidth:2,stroke:l.linkBrush,opacity:l.linkOpacity,isPanelMain:!0,visible:!0},new go.Binding("stroke","isHighlighted",function(e){return e?l.linkHighlightBrush:l.linkBrush}).ofObject(""),new go.Binding("opacity","isHighlighted",function(e){return e?l.linkHighlightOpacity:l.linkOpacity}).ofObject(""),new go.Binding("visible","linkId",function(e){return!(e===-1&&!l.EditMode)}))),D.click=function(){D.startTransaction("no highlighteds"),D.clearHighlighteds(),D.commitTransaction("no highlighteds"),n.$digest()},D.mouseDrop=function(){D.startTransaction("getNode"),D.selection.each(function(e){e instanceof go.Node&&!(D.selection.count>1)&&(u(e),n.$digest())}),D.commitTransaction("getNode")},document.getElementById("topologySingle").onmousedown=function(e){e.which&&3===e.which&&D.toolManager.panningTool.doActivate()},document.getElementById("topologySingle").onmousemove=function(e){(3===e.which||navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&2===e.buttons)&&(D.toolManager.panningTool.doMouseMove(),D.currentCursor="all-scroll",D.toolManager.draggingTool.doCancel())},n.forms={},D.animationManager.isEnabled=!1,D.toolManager.draggingTool.isGridSnapEnabled=!0,D.toolManager.draggingTool.gridSnapCellSize=new go.Size(10,10),D.toolManager.panningTool.isEnabled=!1,D.toolManager.hoverDelay=1200,D.toolManager.dragSelectingTool.box=y(go.Part,{layerName:"Tool"},y(go.Shape,{name:"SHAPE",fill:"gray",opacity:.3,strokeWidth:1})),D.toolManager.linkingTool.temporaryLink=y(go.Link,{layerName:"Tool"},y(go.Shape,{strokeWidth:2,stroke:l.centerConnectorStroke}),y(go.Shape,{toArrow:"Standard",fill:l.centerConnectorStroke,stroke:null})),D.toolManager.linkingTool.temporaryFromPort.strokeWidth=2,D.toolManager.linkingTool.temporaryFromPort.stroke=l.centerConnectorStroke,D.toolManager.linkingTool.temporaryFromPort.figure="Circle",D.toolManager.linkingTool.temporaryFromPort.fill=l.centerConnectorStroke,D.toolManager.linkingTool.temporaryToPort.strokeWidth=2,D.toolManager.linkingTool.temporaryToPort.stroke=l.centerConnectorStroke,D.toolManager.linkingTool.temporaryToPort.figure="Circle",D.toolManager.linkingTool.temporaryToPort.fill=l.centerConnectorStroke,D.addDiagramListener("SelectionMoved",s),D.addDiagramListener("ChangedSelection",c),D.addDiagramListener("ObjectSingleClicked",m),n.drawTopo=function(e){g(e)},n.putDiagramData=function(e){v(e)},document.getElementById("topologySingle").onmouseover=function(){l.over=!0},document.getElementById("topologySingle").onmouseleave=function(){l.over=!1},l.crumbClick=function(e){for(var t=!1;l.level.length-1!==e;)l.level.pop(),t=!0;t?v({ip:l.level[e].ip}):""}})}var m={scope:!1,restrict:"E",templateUrl:"/templates/topology/singleTopo/topoDiagram.9847af30.html",controller:p,controllerAs:"topoCtrl",link:f};return m}e.$inject=["Topology","$rootScope","$modal","domain","$log"],t.$inject=["Topology","sse","$q","Incident","Device","$rootScope","Enum","domain","topologyId","$location","UCD","auth"],angular.module("southWest.topology.singleTopo").directive("topoAllInOneHeader",e).directive("topoAllInOne",t)}(),function(){"use strict";function e(e){e.state("topology.singleTopo",{url:"/topology/singleTopo",controller:"singleTopoCtrl as singleTopo",templateUrl:"templates/topology/singleTopo/index.ed6609bf.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}],user:["auth",function(e){return e.whoAmI()}],userRole:["user","Enum","SystemUser",function(e,t,n){var o=t.get("Role");return!(!o.length||!o[0].roleId)&&n.getUserGroup(o[0].roleId).then(function(e){return e},function(e){return e})}],topology:["Topology",function(e){return e.getTopologies()}],devices:["topology","Device",function(e,t){var n="(category eq SECURITY_DEVICE)",o=[];return o.$filter=n,t.getAll(o,e.data[0].topologyId)}]}}).state("topology.singleTopo.topo",{url:"/",controller:"singleTopoCtrl as singleTopo",templateUrl:"templates/topology/singleTopo/index.ed6609bf.html",resolve:{state:["$rootScope",function(e){e.currentState="DEVICE_MANAGEMENT"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.topology.singleTopo").config(e)}(),function(){"use strict";function e(e,t,n,o,a,r,i,l,s,c){e.topo=t.params.topo,e.userRole=s,e.devices=c;var d=this;d.isTopoView=!0,d.isRemote=r.isRemote(),d.uiEnable=function(e,t){return r.isShow(e,t)},n.$on("addedToCurrentTopology",function(){t.reload()});var u=e.uploader=new i({url:a+"/files/topology/"+l.id+"/fileupload",autoUpload:!0,queueLimit:1,removeAfterUpload:!0}),p=o.defer();u.onSuccessItem=function(t,o,a){n.uploadTaskPromise=null,o.warningInfos.length?n.addAlert({type:"warning",content:"警告!\n- "+o.warningInfos.join("\n- ")}):200===a&&n.addAlert({type:"success",content:"拓扑文件上传成功"}),e.topologyHasNode=!0,e.render()},u.onProgressAll=function(){n.uploadTaskPromise=p.promise},u.onErrorItem=function(e,t){n.uploadTaskPromise=null,n.addAlert({type:"danger",content:t.error}),u._directives.select.length&&u._directives.select[0].element.length&&u._directives.select[0].element[0].value&&(u._directives.select[0].element[0].value="")}}e.$inject=["$scope","$state","$rootScope","$q","URI","uiCtrl","FileUploader","topologyId","userRole","devices"],angular.module("southWest.topology.singleTopo").controller("singleTopoCtrl",e)}(),function(){"use strict";function e(){function e(e,t,n,o){var a=go.GraphObject.make,r=a(go.Palette,"topoPaletteDiv");r.maxSelectionCount=1,r.toolManager.dragSelectingTool.isEnabled=!1,r.nodeTemplate=a(go.Node,"Auto",{selectionAdorned:!1},a(go.Shape,"RoundedRectangle",{fill:null,strokeWidth:0,stroke:null,fromLinkable:!0,toLinkable:!0},new go.Binding("fill","isSelected",function(e){return e?o.nodeSelectionBrush:null}).ofObject("")),a(go.Panel,"Vertical",a(go.Panel,"Auto",a(go.Shape,"RoundedRectangle",{width:100,stroke:null,name:"TextBox"},new go.Binding("fill","category",function(e){return o.getDeviceColor(e)})),a(go.Panel,"Horizontal",{alignment:go.Spot.TopLeft},a(go.TextBlock,{width:95,margin:new go.Margin(2,0,6,0),stroke:o.nodeTextBrush,isMultiline:!0,font:o.nodeTopFont,textAlign:"center",overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,name:"TEXT"},new go.Binding("text","deviceType")))),a(go.Shape,"Rectangle",{width:100,fill:o.nodeBGBrush,stroke:null,height:10,margin:new go.Margin((-10),0,0,0)}),a(go.Panel,"Auto",{margin:new go.Margin((-10),0,0,0)},a(go.Shape,"RoundedRectangle",{width:100,fill:o.nodeBGBrush,strokeWidth:3,stroke:null}),a(go.Panel,"Vertical",a(go.Panel,"Auto",a(go.Picture,{margin:new go.Margin(5,0,5,0),width:80,height:65,imageStretch:go.GraphObject.Uniform},new go.Binding("source","img"))))))),r.layout.sorting=go.GridLayout.Forward,r.model.nodeDataArray=[{img:"images/ips-icon.5574fae1.png",deviceType:"安全设备",category:"SECURITY_DEVICE",nId:"NotSet"},{img:"images/switch-icon.6f86bf86.png",deviceType:"网络交换机",category:"NETWORK_DEVICE",nId:"NotSet"},{img:"images/router-icon.00818ddb.png",deviceType:"路由器",category:"NETWORK_DEVICE",nId:"NotSet"},{img:"images/cloud-icon.727f8e55.png",deviceType:"Cloud",category:"NETWORK_DEVICE",nId:"NotSet"},{img:"images/cnc-icon.9d932840.png",deviceType:"高端数控机床",category:"FACTORY_DEVICE",nId:"NotSet"},{img:"images/hmi-icon.d167758d.png",deviceType:"HMI",category:"FACTORY_DEVICE",nId:"NotSet"},{img:"images/workstation-icon.4bb4089c.png",deviceType:"工作站",category:"FACTORY_DEVICE",nId:"NotSet"},{img:"images/subnet-icon.4cdf3317.png",deviceType:"子网",category:"FACTORY_DEVICE",nId:"NotSet"},{img:"images/opc_client-icon.edda6300.png",deviceType:"OPC 客户端",category:"FACTORY_DEVICE",nId:"NotSet"},{img:"images/opc_server-icon.e984edd4.png",deviceType:"OPC 服务器",category:"FACTORY_DEVICE",nId:"NotSet"},{img:"images/plc-icon.7996fd56.png",deviceType:"PLC",category:"FACTORY_DEVICE",nId:"NotSet"}]}var t={require:"^topoDiagram",scope:!1,restrict:"E",templateUrl:"/templates/topology/singleTopo/topoPalette.14ce1c2b.html",link:e};return t}function t(e,t,n,o,a,r){function i(e,n,o,a,i,l){var s=e.uploader=new i({url:l+"/files/topology/"+r.id+"/fileupload",autoUpload:!0,queueLimit:1,removeAfterUpload:!0});s.onSuccessItem=function(n,o,a){o.warningInfos.length?t.addAlert({type:"warning",content:"警告!"+o.warningInfos}):200===a&&t.addAlert({type:"success",content:"拓扑文件上传成功"}),e.topologyHasNode=!0,e.render()},s.onErrorItem=function(e,n){t.addAlert({type:"danger",content:n.error}),s._directives.select.length&&s._directives.select[0].element.length&&s._directives.select[0].element[0].value&&(s._directives.select[0].element[0].value="")}}function l(i,l){i.topologyHasNode=r.hasNode,i.uploadTopologyModal=function(){function e(e,t,n,o,a,r,i,l){e.isDPIUpgrading=a.isDPIUpgrading();var s=i.$on("dpiUpgradeState",function(){e.isDPIUpgrading=a.isDPIUpgrading()});e.$on("destroy",function(){s()});var c=e.uploader=new n({url:o+"/files/topology/"+r.id+"/fileupload",autoUpload:!0,removeAfterUpload:!0,queueLimit:1}),d=l.defer();c.onSuccessItem=function(e,t,n){i.uploadTaskPromise=null,i.$broadcast("updateDashboardHeader"),t.warningInfos.length?i.addAlert({type:"warning",content:"警告!"+t.warningInfos}):200===n&&i.addAlert({type:"success",content:"拓扑文件上传成功"})},c.onProgressAll=function(){i.uploadTaskPromise=d.promise,t.close()},c.onErrorItem=function(e,t){i.uploadTaskPromise=null,i.addAlert({type:"danger",content:t.error})},e.ok=function(){i.uploadTaskPromise=null,t.close()},e.cancel=function(){i.uploadTaskPromise=null,t.dismiss("cancel")}}e.$inject=["$scope","$modalInstance","FileUploader","URI","System","topologyId","$rootScope","$q"];var o=n.open({animation:!0,templateUrl:"upload-confirmation.html",controller:e,size:"sm",resolve:{scope:function(){return i},element:function(){return l}}});o.result.then(function(){},function(){t.uploadTaskPromise=null,a.info("Modal dismissed at: "+new Date)})},i.deployAllEndpoint=function(){o.getDomain().then(function(n){e.deployAllEndpoint(n[0].domainInfo.currentTopologyId).then(function(e){e.data&&"SUCCESS"===e.data.state?t.addAlert({type:"success",content:"配置所有终端成功"}):t.addAlert({type:"danger",content:"配置所有终端失败"+(e.data&&e.data.reason?": "+e.data.reason:"")})},function(e){t.addAlert({type:"danger",content:"配置所有终端失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})})}}return i.$inject=["$scope","$q","$state","System","FileUploader","URI"],{scope:!1,restrict:"E",controller:i,templateUrl:"/templates/topology/singleTopo/header.c939e7c0.html",link:l}}function n(e,t,n,o,i,l,s,c,d,u,p,f,m,g,h,v,y){function I(t,n,a,r,l){var m=0,g=0,h=n.defer();t.isDPIUpgrading=r.isDPIUpgrading();var v=this;v.simplifyModelName=l.simplifyModelName,v.eventHandler={},p.isMacNeeded().then(function(e){t.needMac=e}),v.eventHandler.dpiUpgradeStateHandler=i.$on("dpiUpgradeState",function(){t.isDPIUpgrading=r.isDPIUpgrading()}),v.isDefaultRole=s.get("Role"),v.checkAllDeviceAccess=function(e,t){if(412===e.status)return i.addAlert({type:"danger",content:"没有用户或用户组管理权限， 请联系系统管理员"}),void a.transitionTo("monitor.overview");var n=!1;if(e&&e.role.defaultRole)n=!0;else{var o=0;for(o=0;o<t.length;o++){var r=t[o];if(e.deviceIds.indexOf(r.deviceId)===-1)break}o===t.length&&(n=!0)}return n},v.hasAllDeviceCtrl=v.checkAllDeviceAccess(t.userRole,t.devices),v.isDefaultRole=!(!v.isDefaultRole||!v.isDefaultRole[0])&&v.isDefaultRole[0].defaultRole,this.EditMode=!1,this.linkPromise=h.promise,this.gridPattern={stroke:"#393939",strokeWidth:.8},this.nodeBGBrush="#000",this.nodeSelectionBrush="#76B900",this.nodeTopFillBrush="#1C418F",this.nodeTextBrush="#E4E4E4",this.nodeInvalidBrush="#FF0000",this.nodeTopFont="14px arial",this.tooltipFont="13px arial",this.ipFont="9px sans-serif",this.iconFont="8pt FontAwesome",this.statusOffBrush="#FE540F",this.centerConnectorStroke="#76B900",this.centerConnectorFill="black",this.connectorBrush="#E4E4E4",this.linkBrush="#CCCCCC",this.linkOpacity=.5,this.linkHighlightBrush="#76B900",this.linkHighlightOpacity=.5,this.tooltipBGBrush="#E6E6E6",this.deviceColor="",this.invalid=!1,this.groupBodyBack="#1D1D1D",this.groupHeadBack="#CCCCCC",this.groupHeadStroke="#1E1E1E",this.groupIcon="images/subnet-icon.4cdf3317.png",this.badGroupAdd="#631D1D",this.goodGroupAdd="#1D441D",this.invalidDeviceList=[],this.selectedInvalidDevice=null,this.getDeviceColor=function(e){var t="#193984";switch(e){case"SECURITY_DEVICE":t="#AA3D11";break;case"FACTORY_DEVICE":t="#1D3D87";break;case"NETWORK_DEVICE":t="#107F6D"}return t},t.currentNode={orderID:null},t.showOptions=!1,t.optionsStyle={position:"absolute",left:m+"px",top:g+"px"},t.detailStyle={position:"absolute",left:"0px",top:"0px"},t.showDetailPanel=!1,t.calculatePosition=function(){t.detailStyle.left=m+30+"px",t.detailStyle.top=g+"px"},this.setPosition=function(e,n){t.optionsStyle.left=e+65+"px",t.optionsStyle.top=n-10+"px"},t.topo||(t.topo=""),t.downloadModal=function(){function n(e,t,n){e.topoName="default拓扑图"===n.name?"默认拓扑图":n.name,e.validateTopoFileName=function(){var t="^[一-龥_a-zA-Z0-9-.]+$";e.topoName.match(t)?e.valid=!0:e.valid=!1},e.validateTopoFileName(),e.cancel=function(){t.dismiss("cancel")},e.confirm=function(){t.close(e.topoName)}}n.$inject=["$scope","$modalInstance","currentTopo"];var o=f.open({templateUrl:"templates/topology/singleTopo/downloadModal.0cc66e01.html",size:"sm",controller:n,resolve:{currentTopo:function(){return t.currentTopo}}});o.result.then(function(n){n!==t.currentTopo.name?e.changeTopoName(t.currentTopo.topologyId,n).then(function(e){t.currentTopo=e.data,t.downloadTopo()}):t.downloadTopo()})},t.downloadTopo=function(){e.downloadLink(t.currentTopo.topologyId).then(function(e){window.open("./"+e,"_self")})},t.discoverTopo=function(){a.transitionTo("topology.discovery")},t.pv=s.get("privilege").filter(function(e){return e.name===i.currentState}),t.pv=t.pv&&t.pv[0]?t.pv[0].actionValue:30,t.render=function(a){c.getDomain().then(function(r){r&&r[0].domainInfo.currentTopologyId?(t.topo&&r[0].domainInfo.currentTopologyId!==t.topo||(t.switchAlternate="on"),t.topo||(t.topo=r[0].domainInfo.currentTopologyId),t.noTopo=!1):t.noTopo=!t.topo,t.topo&&(h.resolve(t.topo),e.getTopo(t.topo).then(function(r){var i=r,l=[];l.push(e.getNodes(t.topo)),l.push(e.getLinks(t.topo)),l.push(e.getDevices(t.topo)),l.push(o.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$limit:1e6,$orderby:"model_name"})),l.push(o.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq FACTORY_DEVICE",$limit:1e6,$orderby:"model_name"})),l.push(o.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq NETWORK_DEVICE",$limit:1e6,$orderby:"model_name"})),l.push(o.getModels({$select:["modelId","model_name","model","subCategory","make","iconType","numOfPorts"],$filter:"category eq SECURITY_DEVICE",$limit:1e6,$orderby:"model_name"})),l.push(o.getGroups()),n.all(l).then(function(e){i.nodes=e[0].data,i.links=e[1].data,i.devices=e[2].data;for(var n=0;n<i.devices.length;n++){var o=i.devices[n]._model_name?i.devices[n]._model_name.split(" /"):[];"数控审计保护平台"===o[0]&&(i.devices[n]._model_name=u("resFilter")(o[0],"slideAuditTitle")+" /"+o[1])}i.groups=e[7].data,e[3][0].model_name||"N/A"!==e[3][0].make||e[3][0].model?"":i.blankModel=e[3][0].modelId,v.factory_models=e[4],v.network_models=e[5],v.security_models=e[6],t.topologyHasNode=d.hasNode,t.currentTopo=i,a?t.putDiagramData(i):t.drawTopo(i)})}))})},v.eventHandler.portHandler=i.$on("port",function(e,n){var o=t.currentTopo.devices.filter(function(e){return e.deviceId===n.deviceId});if(o){var a=o[0].devicePorts.filter(function(e){return e.portId===n.portId});a&&(a[0].linkState=n.linkState)}}),t.render(),t.$on("$destroy",function(){v.eventHandler.dpiUpgradeStateHandler(),v.eventHandler.portHandler()})}function D(n,c,d,p){function I(){document.getElementById("topologySingle").style.height=(window.innerHeight-130>1e3?1e3:window.innerHeight-130)+"px"}var D,T,b=[];I(),window.onresize=function(){document.getElementById("singleTopoIndexDiv")?I():""},p.linkPromise.then(function(d){function I(e,t){if(p.EditMode){var o,a=!0;t&&t.diagram.selection.each(function(e){e instanceof go.Node&&(["SECURITY_DEVICE"].indexOf(e.data.category)>=0||"CLOUD"===e.data.nodeType||e.data.isGroup)&&(a=!1)}),o=!!a&&(null!==t?t.addMembers(t.diagram.selection,!0):e.diagram.commandHandler.addTopLevelParts(e.diagram.selection,!0)),o||e.diagram.currentTool.doCancel(),t&&te.model.setDataProperty(t.data,"statusShade",""),o&&(t&&te.groupRef.edited.indexOf(t.data.groupId)===-1?te.groupRef.edited.push(t.data.groupId):"",te.groupRef.leave&&te.groupRef.edited.indexOf(te.groupRef.leave)===-1?te.groupRef.edited.push(te.groupRef.leave):"",t?S(t):"",te.groupRef.leave?S(te.findNodeForKey(te.groupRef[te.groupRef.leave])):"",te.groupRef.leave=null,n.validateDevice(n.selectedDeviceInTable))}}function S(e){var t;e.isSubGraphExpanded||(e.expandSubGraph(),t=e.memberParts),e.data.preview=te.makeImage({parts:t?t:e.memberParts}).src,t?e.collapseSubGraph():""}function P(e,t,n){if(t){if(e.handled=!0,n&&p.EditMode){var o=t.diagram.toolManager.draggingTool,a=o.draggedParts||o.copiedParts,r=!0;return a.each(function(e){e.key instanceof go.Node&&(["SECURITY_DEVICE"].indexOf(e.key.data.category)>=0||"CLOUD"===e.key.data.nodeType)&&(r=!1)}),void(r?te.model.setDataProperty(t.data,"statusShade","good"):te.model.setDataProperty(t.data,"statusShade","bad"))}te.model.setDataProperty(t.data,"statusShade","")}}function A(){var e=[];if(te.selection.each(function(t){t instanceof go.Node&&!t.data.isGroup&&t.data.deviceId&&"SECURITY_DEVICE"===t.data.category&&1===t.data.deviceOnline&&e.push(t.data)}),e.length>0)return void p.cannotDelete(e);te.startTransaction("removePortFinal");var t=[],n=[];if(te.selection.each(function(e){(e instanceof go.Link||e instanceof go.Node)&&!e.data.isGroup&&(e.data.deviceId&&e instanceof go.Node?n.push(e):t.push(e))}),0===n.length){for(var o=0;o<t.length;o++)te.remove(t[o]),r(p.invalidDeviceList,t[o].data);0===p.invalidDeviceList.length&&(p.invalid=!1),x()}else n.length>0?p.deleteDevice(n,t):"";te.commitTransaction("removePortFinal")}function C(t){if((4&n.pv)>0){var o=te.findPartAt(t.diagram.lastInput.documentPoint,!1);null!==o&&(o.selectionAdorned=!1);for(var a=t.diagram.selection.iterator;a.next();)if(a.value instanceof go.Node&&a.value.data.deviceId){var r={id:a.value.data.nodeId,x:a.value.location.x,y:a.value.location.y};e.updatePosition(r)}else if(a.value.data.isGroup)for(var i=a.value.memberParts.iterator;i.next();)if(i.value instanceof go.Node&&i.value.data.nodeId){var l={id:i.value.data.nodeId,x:i.value.location.x,y:i.value.location.y};e.updatePosition(l)}}}function k(){te.startTransaction("highlight"),te.clearHighlighteds();var e=[];if(te.selection.each(function(t){t instanceof go.Node&&(t.findLinksConnected().each(function(e){e.isHighlighted=!0}),e.push(t.data))}),n.selectedDeviceInTable){for(var t=!!n.selectedDeviceInTable.deviceId,o=0;o<e.length;o++)e[o].key===n.selectedDeviceInTable.key&&(t=!1);t&&n.selectedDeviceInTable&&n.selectedDeviceInTable.isEdited&&!n.selectedDeviceInTable.invalid&&V(n.selectedDeviceInTable)}1===e.length&&($(e[0]),"SECURITY_DEVICE"===e[0].category?n.populateModeOptions(n.selectedDeviceInTable.subcategory,n.selectedDeviceInTable.modelInDetail):n.populateModelOptions(n.selectedDeviceInTable.category),p.lastSelection=e[0].key),te.commitTransaction("highlight")}function w(e){te.startTransaction("highlight"),te.groupRef.edited.indexOf(e.subject.q[0].data.groupId)===-1?te.groupRef.edited.push(e.subject.q[0].data.groupId):"",te.commitTransaction("highlight")}function E(e){$(e.data),e.data.deviceId&&o.getACLInfo(e.data.deviceId).then(function(e){n.hasacltable=!1,e.length>0&&(n.hasacltable=!0),n.acltable=e},function(){n.hasacltable=!1}),n.validateDevice(n.selectedDeviceInTable),n.populateModelOptions(n.selectedDeviceInTable.category),te.select(e)}function N(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,o){var a=n[e]<o[e]?-1:n[e]>o[e]?1:0;return a*t}}function $(e){if(n.selectedDeviceInTable=e,n.selectedDeviceInTable.ports){for(var t=0;t<n.selectedDeviceInTable.ports.length;t++)"mgmt"!==n.selectedDeviceInTable.ports[t].portName.toLowerCase()&&(n.selectedDeviceInTable.ports[t].index=+n.selectedDeviceInTable.ports[t].portName.substr(1));n.selectedDeviceInTable.ports.sort(N("index"));for(var o=0;o<n.selectedDeviceInTable.ports.length;o++)"mgmt"!==n.selectedDeviceInTable.ports[o].portName.toLowerCase()&&delete n.selectedDeviceInTable.ports[o].index;n.selectedDeviceInTable.ports.sort(N("index"))}}function M(e){e.subject.part.data.key&&(e.subject.part.data.deviceId&&o.getACLInfo(e.subject.part.data.deviceId).then(function(e){n.hasacltable=!1,e.length>0&&(n.hasacltable=!0),n.acltable=e},function(){n.hasacltable=!1}),n.populateModelOptions(n.selectedDeviceInTable.category)),n.validateDevice(n.selectedDeviceInTable),n.$digest()}function R(e){var t={};if(t.key=-te.nodeCopy.count,te.nodeCopy.count++,t.nameInDetail=e.deviceType,t.topology=te.topologyId,t.currentTopology=te.currentTopology,t.img=e.img?e.img:"images/cloud-icon.727f8e55.png",t.category=e.category?e.category:"",t.updateTime=(new Date).toJSON(),t.statusIconShow="SECURITY_DEVICE"===e.category,t.portIdRef="Cloud"!==e.deviceType&&!("FACTORY_DEVICE"===e.category&&"子网"!==e.deviceType),t.loc="",t.nodeType=e.deviceType&&"Cloud"!==e.deviceType?"网络交换机"===e.deviceType?"SWITCH":"路由器"===e.deviceType?"ROUTER":"安全设备"===e.deviceType?"IPS":"ENDPOINT":"CLOUD",t.isEdited=!1,t.iconType=e.img?e.img.substring(7,e.img.length-9):"cloud",t.modelId="Cloud"!==e.deviceType?"":"cloud",t.deviceId="",t.hasUSB="SECURITY_DEVICE"===e.category,t.hasWireless=!1,t.hasPorts="Cloud"!==e.deviceType,e.isGroup){t.modelId="Group",t.statusShade="",t.preview="",t.isGroup=!0,t.img=p.groupIcon,t.nameInDetail="_分组";for(var o=te.selection.iterator;o.next();)if(o.value instanceof go.Node){t.nameInDetail=o.value.data.nameInDetail+"分组";break}}if(e.deviceType&&"Cloud"!==e.deviceType){var a={_subnets:Array[0],deployedRulesNumber:0,deviceId:"Device Id",isMgmtPort:!0,linkState:0,mac:"",portId:"",portIp:"",portName:"p0",protectedDevicesNumber:0,status:0,netMask:""};"子网"===e.deviceType?a.netMask="255.255.255.0":"",t.ports=[a],t.deviceOnline=0,t.deviceSource="",t.numPorts=0,t.ip="",t.manufacturerInDetail="",t.modelInDetail="",t.versionInDetail="",t.routingMode="Routind Mode",t.mmgtPort=0,t.mac="",t.rightArray=[],t.leftArray=[],t.bottomArray="FACTORY_DEVICE"===e.category&&"子网"!==e.deviceType?[{portName:"p0",portIp:""}]:[],t.subcategory="NORMAL",t.statusColor="red","安全设备"===e.deviceType&&(t.modeDescription="",t.showMode=t.modeDescription.length,t.statusText="未激活",t.serialNumber="")}return n.topologyHasNode||(n.topologyHasNode=!0),t}function U(e,t,n,o,a){var r=!1,i=!1;if(a)if(a.fromPort!==t&&a.toPort===o)r=!0;else{if(a.fromPort!==t||a.toPort===o)return!0;i=!0}var l,s,c,d=e.findLinksConnected(t.portId),u=n.findLinksConnected(o.portId);if("SECURITY_DEVICE"===e.data.category)if(["IPS","IDS"].indexOf(e.data.nodeType)===-1){var p=1;if(e.data.deviceId){for(c=0;c<te.allData.nodes.length;c++)if(te.allData.nodes[c].deviceId===e.data.deviceId){p=te.allData.nodes[c].ports.length;break}}else p=e.data.numPorts-1;for(var f=p,m=0;m<f;m++){var g=e.findLinksConnected("p"+m);p=g.count>0?p-g.count:p}l=!!i||p-d.count>0}else l=!!i||d.count<1;else l="FACTORY_DEVICE"!==e.data.category||(!!i||d.count<1);if("SECURITY_DEVICE"===n.data.category)if(["IPS","IDS"].indexOf(n.data.nodeType)===-1){var h=1;if(n.data.deviceId){for(c=0;c<te.allData.nodes.length;c++)if(te.allData.nodes[c].deviceId===n.data.deviceId){h=te.allData.nodes[c].ports.length;break}}else h=n.data.numPorts-1;for(var v=h,y=0;y<v;y++){var I=n.findLinksConnected("p"+y);h=I.count>0?h-I.count:h}s=!!r||h-u.count>0}else s=!!r||u.count<1;else s="FACTORY_DEVICE"!==n.data.category||(!!r||u.count<1);return l&&s}function _(e){function t(e,t){te.startTransaction("连掉线"),te.model.nodeDataArray.forEach(function(e,n){e.deviceId===t.deviceId&&(t.deviceOnline===-1?(te.model.nodeDataArray[n].statusText="掉线",te.model.nodeDataArray[n].statusColor="red",te.model.setDataProperty(te.model.nodeDataArray[n],"statusIconShow",!0),te.model.setDataProperty(te.model.nodeDataArray[n],"deviceOnline",t.online)):1===t.deviceOnline&&"DISCOVERY"===t.deviceSource&&(te.model.nodeDataArray[n].statusText="连线",te.model.nodeDataArray[n].statusColor="green",te.model.setDataProperty(te.model.nodeDataArray[n],"statusIconShow",!1),te.model.setDataProperty(te.model.nodeDataArray[n],"deviceOnline",t.online)))}),te.commitTransaction("连掉线"),te.requestUpdate()}te.doMouseWheel=function(){p.over&&(this.lastInput.control=!0,te.toolManager.doMouseWheel()),localStorage.setItem("monitor:topology.scale."+e.topologyId,te.scale)},Q(e),D=i.$on("updateDashboardHeader",function(){n.render("update");for(var e=0;e<te.model.nodeDataArray.length;e++)te.model.nodeDataArray[e].currentTopology=!te.model.nodeDataArray[e].currentTopology}),T=i.$on("device",t),n.$on("$destroy",function(){D(),T()})}function x(){for(var e=0;e<te.allData.nodes.length;e++){var t=te.findNodeForKey(-e);if(t){te.select(t);break}}}function O(){for(var e=0,n=[],a=[],r={},l=["from","to"],s=0;s<te.model.linkDataArray.length;s++){var c=te.model.linkDataArray[s];if(c.linkId!==-1)for(var d=0;d<l.length;d++){var u=te.keyToDevice[-c[l[d]]];if("SECURITY_DEVICE"===u.category){r[u.deviceId]=r[u.deviceId]||{DeviceRef:u},e=1,r[u.deviceId][e]=r[u.deviceId][e]||[];for(var p=!1,f=0;f<te.allData.nodes.length;f++)te.allData.nodes[f].deviceId===u.deviceId&&(p=te.allData.nodes[f].ports);if(p)r[u.deviceId][e]=p;else for(var m=0;m<u.ports.length-1;m++)u.ports[m].isMgmtPort||(0===r[u.deviceId][e].length||r[u.deviceId][e].indexOf(u.ports[m].portName)<0)&&r[u.deviceId][e].push(u.ports[m].portName)}else if(u.nodeType){var g=[];if("FACTORY_DEVICE"===u.category&&"subnet"!==u.iconType)for(var h=0;h<u.ports.length;h++)g.push("p"+h.toString());r[u.deviceId]=r[u.deviceId]||{deviceId:["CLOUD"].indexOf(u.nodeType)===-1?u.deviceId:"0",name:u.nameInDetail,type:u.nodeType,x:te.findNodeForKey(c[l[d]]).location.x,y:te.findNodeForKey(c[l[d]]).location.y,importance:1,zoneName:"FACTORY_DEVICE"===u.category?u.nameInDetail:"",category:u.category,ports:u.ports},g.length>0&&(r[u.deviceId].ports=g),"subnet"===u.iconType&&delete r[u.deviceId].ports,"FACTORY_DEVICE"!==u.category&&(delete r[u.deviceId].category,delete r[u.deviceId].ports)}}}var v=te.allData.nodes;for(var y in r)if(r.hasOwnProperty(y))for(var I=0;I<v.length;I++)if(y===v[I].deviceId){if(r[y].DeviceRef?e=1:"",r[y].DeviceRef&&!r[y][e]||!!r[y].DeviceRef&&(!v[I].ports||r[y][e].sort().join("_")!==v[I].ports.sort().join("_")))continue;var D=!!v[I].name&&(r[y].DeviceRef?v[I].name!==r[y].DeviceRef.nameInDetail+"_"+r[y][e].sort().join("_"):v[I].name!==r[y].name),T=r[y].DeviceRef?v[I].type!==r[y].DeviceRef.nodeType:v[I].type!==r[y].type;if(D||T){var b={};b.id=v[I].id,b.nodeZoneId=v[I].nodeZoneId,b.name=r[y].DeviceRef?r[y].DeviceRef.nameInDetail+"_"+r[y][e].sort().join("_"):r[y].name,b.type=r[y].DeviceRef?r[y].DeviceRef.nodeType:r[y].type,r[y].category&&"FACTORY_DEVICE"===r[y].category&&r[y].ports?b.ports=r[y].ports:r[y].DeviceRef?b.ports=r[y][e].sort():"";for(var S in b)b.hasOwnProperty(S)&&(b[S]?"":delete b[S]);a.push(b)}if(r[y].DeviceRef&&2!==Object.keys(r[y]).length?delete r[y][e]:delete r[y],
!r[y])break}for(y in r)if(r.hasOwnProperty(y))if(r[y].DeviceRef)for(var P in r[y])r[y].hasOwnProperty(P)&&"DeviceRef"!==P&&n.push({deviceId:r[y].DeviceRef.deviceId,name:r[y].DeviceRef.nameInDetail+"_"+r[y][P].sort().join("_"),type:r[y].DeviceRef.nodeType,ports:r[y][P].sort(),importance:1,x:te.findNodeForKey(r[y].DeviceRef.key).location.x,y:te.findNodeForKey(r[y].DeviceRef.key).location.y});else n.push(r[y]);for(s=0;s<te.model.nodeDataArray.length;s++){var A=!0,C=te.model.nodeDataArray[s];if(!C.isGroup&&te.devicesNodeMapCopy[C.deviceId]===-1){for(var k=0;k<n.length;k++)if(n[k].deviceId===C.deviceId||"cloud"===C.iconType&&"0"===n[k].deviceId){A=!1;break}if(A){var w={};["CLOUD"].indexOf(C.nodeType)>=0?w.deviceId="0":w.deviceId=C.deviceId,w.name=C.nameInDetail,w.type=C.nodeType;var E,N=[];if(["SECURITY_DEVICE"].indexOf(C.category)>=0){for(E=0;E<C.ports.length-1;E++)N.push("p"+E);w.ports=N,w.name=C.nameInDetail+"_"+N.sort().join("_")}if(w.x=te.findNodeForKey(C.key).location.x,w.y=te.findNodeForKey(C.key).location.y,"FACTORY_DEVICE"===C.category){if("subnet"!==C.iconType){for(E=0;E<C.ports.length;E++)N.push("p"+E);w.ports=N}w.zoneName=C.nameInDetail}w.importance=1,n.push(w)}if(te.devicesNodeMapCopy[C.deviceId]=[],C.ports)for(var $=0;$<C.ports.length;$++)te.devicesNodeMapCopy[C.deviceId].push(-1);else te.devicesNodeMapCopy[C.deviceId]="cloud"}}var M=[];for(s=0;s<a.length;s++)M.push(o.updateNode(a[s]));for(var R=0;R<n.length;R++)delete n[R].category;M.push(o.createNodes(n));var U=t.defer();t.all(M).then(function(){U.resolve("success"),L(n.length)},function(e){U.resolve("创建设备失败"),i.addAlert({type:"danger",content:"创建设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}function L(o){var a=!0;t.all([e.getNodes(n.topo)]).then(function(e){te.allData.nodes.length+o===e[0].data.length?(a=!1,G()):setTimeout(function(){L(o)},100)})}function B(){te.startTransaction("linkHandler");for(var o,a,r=[],l=[],s=[],c=[],d=0;d<te.model.linkDataArray.length;d++){var u=te.model.linkDataArray[d];if(u.linkId!==-1){if("number"==typeof te.keyToDevice[-u.from]||"number"==typeof te.devicesNodeMapCopy[te.keyToDevice[-u.from].deviceId])o="number"==typeof te.keyToDevice[-u.from]?te.keyToDevice[-u.from]:te.devicesNodeMapCopy[te.keyToDevice[-u.from].deviceId];else for(var f=0;f<te.keyToDevice[-u.from].ports.length;f++)if(te.keyToDevice[-u.from].ports[f].portName.toLowerCase()===u.fromPort.toLowerCase()){o=te.devicesNodeMapCopy[te.keyToDevice[-u.from].deviceId][f];break}if("number"==typeof te.keyToDevice[-u.to]||"number"==typeof te.devicesNodeMapCopy[te.keyToDevice[-u.to].deviceId])a="number"==typeof te.keyToDevice[-u.to]?te.keyToDevice[-u.to]:te.devicesNodeMapCopy[te.keyToDevice[-u.to].deviceId];else for(var g=0;g<te.keyToDevice[-u.to].ports.length;g++)if(te.keyToDevice[-u.to].ports[g].portName.toLowerCase()===u.toPort.toLowerCase()){a=te.devicesNodeMapCopy[te.keyToDevice[-u.to].deviceId][g];break}u.linkId?(te.linkCopy[u.linkId].from===u.from&&te.linkCopy[u.linkId].to===u.to&&te.linkCopy[u.linkId].fromPort===u.fromPort&&te.linkCopy[u.linkId].toPort===u.toPort||l.push({id:u.linkId,nodeID:o,destinationNodeID:a,sourcePortName:"unspecified"===u.fromPort?"":u.fromPort,destinationPortName:"unspecified"===u.toPort?"":u.toPort}),delete te.linkCopy[u.linkId]):r.push({nodeID:o,destinationNodeID:a,sourcePortName:"unspecified"===u.fromPort?"":u.fromPort,destinationPortName:"unspecified"===u.toPort?"":u.toPort})}}for(var h in te.linkCopy)te.linkCopy.hasOwnProperty(h)&&s.push({id:h});s.length>0&&c.push(e.deleteLink(s,te.topologyId)),l.length>0&&c.push(e.updateLink(l,te.topologyId)),r.length>0&&c.push(e.addLink(r,te.topologyId));var v=t.defer();t.all(c).then(function(){v.resolve("success"),n.render("update"),p.EditMode=!1,te.validationMessage&&te.validationMessage.length?i.addAlert({type:"warning",content:"警告!\n- "+te.validationMessage}):i.addAlert({type:"success",content:"修改设备成功"}),m.updateDashboard({dashBoardTypeDetail:"TOPOLOGY_STRUCTURESAFETY"})},function(e){v.resolve("修改设备失败"),i.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})}),te.commitTransaction("linkHandler")}function V(n){te.startTransaction("linkHandler");var a=[];if(-n.key<=te.nodeCopy.length){var r={};if(n.modelInDetail&&"N/A"!==n.modelInDetail?r._model_name=n.modelInDetail:"",n.modelId&&"N/A"!==n.modelId?r.modelId=n.modelId:"",r._subCategory=n.subcategory,r.category=n.category,r.deviceId=n.deviceId,n.ports){r.devicePorts=[];for(var l=0;l<n.ports.length;l++){var s={isMgmtPort:n.ports[l].isMgmtPort,portName:n.ports[l].portName,portIp:n.ports[l].portIp,mac:n.ports[l].mac?n.ports[l].mac.toUpperCase():"",portId:n.ports[l].portId};r.devicePorts.push(s)}}if(r.hasPort=n.ports.length>0,r.iconType=n.iconType,r.make=n.manufacturerInDetail,r.name=n.nameInDetail,n.serialNumber&&"N/A"!==n.serialNumber?r.serialNumber=n.serialNumber:"",r.topologyId=n.topologyId,r.updatedAt=(new Date).toJSON(),n.isEdited.indexOf("basic")>=0&&a.push(o.update(r.deviceId,r)),n.isEdited.indexOf("ipmac")>=0&&"SWITCH"!==n.nodeType&&("SECURITY_DEVICE"!==n.category||0===n.deviceOnline))if("FACTORY_DEVICE"===n.category&&"subnet"!==n.iconType)a.push(o.updateAllDevicePorts(n.topologyId,n.deviceId,r));else for(var c=0;c<n.ports.length;c++)if(n.ports[c].isMgmtPort){var d={portIp:"subnet"===n.iconType?n.subnetIp:n.ip,mac:n.mac?n.mac.toUpperCase():"",portId:n.ports[c].portId};a.push(o.updateMgmIpMac(n.topologyId,n.deviceId,d))}}var u=t.defer();t.all(a).then(function(){if(n.isEdited=!1,"FACTORY_DEVICE"===n.category&&"subnet"!==n.iconType){var a=[];a.push(e.getLinks(n.topologyId)),a.push(e.getDeviceNodes(n.deviceId)),t.all(a).then(function(t){for(var a=t[0].data,r=t[1][0],l=[],s=[],c=0;c<n.ports.length;c++)l.push("p"+c.toString());r.ports=l,o.updateNode(r).then(function(){},function(e){u.resolve("修改设备失败"),i.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})});for(var d=0;d<a.length;d++){var p=a[d];p.nodeID===r.id&&p.sourcePortName&&parseInt(p.sourcePortName.slice(1))>=n.ports.length&&s.push({id:p.id})}s.length>0&&e.deleteLink(s,n.topologyId)})}u.resolve("success")},function(e){u.resolve("修改设备失败"),i.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})}),te.commitTransaction("DeviceHandler")}function j(){te.startTransaction("linkHandler");for(var e=[],n=0;n<te.model.nodeDataArray.length;n++){var a=te.model.nodeDataArray[n];if(-a.key>te.nodeCopy.length){if("cloud"!==a.iconType){var r={};a.mac?a.mac=a.mac.toUpperCase():"",r.name=a.nameInDetail,r.iconType=a.iconType,a.serialNumber?r.serialNumber=a.serialNumber:"",r.modelId=a.modelId,r.devicePorts=a.ports?a.ports:[],"FACTORY_DEVICE"===a.category?r.devicePorts[0].portIp="subnet"===a.iconType?a.subnetIp:r.devicePorts[0].portIp:(r.devicePorts[0].portIp=a.ip,r.devicePorts[0].mac=a.mac);for(var l=0;l<a.ports.length;l++)r.devicePorts[l].hasOwnProperty("deployedRulesNumber")?delete r.devicePorts[l].deployedRulesNumber:"",r.devicePorts[l].hasOwnProperty("deviceId")?delete r.devicePorts[l].deviceId:"",r.devicePorts[l].hasOwnProperty("linkState")?delete r.devicePorts[l].linkState:"",r.devicePorts[l].hasOwnProperty("portId")?delete r.devicePorts[l].portId:"",r.devicePorts[l].hasOwnProperty("protectedDevicesNumber")?delete r.devicePorts[l].protectedDevicesNumber:"",r.devicePorts[l].hasOwnProperty("status")?delete r.devicePorts[l].status:"",r.devicePorts[l].hasOwnProperty("_subnets")?delete r.devicePorts[l]._subnets:"",r.devicePorts[l].hasOwnProperty("invalidIp")?delete r.devicePorts[l].invalidIp:"",r.devicePorts[l].hasOwnProperty("invalidMac")?delete r.devicePorts[l].invalidMac:"",r.devicePorts[l].hasOwnProperty("hasDuplicateIP")?delete r.devicePorts[l].hasDuplicateIP:"",r.devicePorts[l].hasOwnProperty("hasDuplicateMAC")?delete r.devicePorts[l].hasDuplicateMAC:"",r.devicePorts[l].hasOwnProperty("invalidRange")?delete r.devicePorts[l].invalidRange:"";"subnet"===a.iconType&&(r.modelId=te.blankModelId,r.devicePorts[0].netMask=a.ports[0].netMask),e.push(o.createDevice(r)),a.isEdited=!1}}else delete te.nodeCopy[a.deviceId]}for(var s in te.nodeCopy)te.nodeCopy.hasOwnProperty(s)&&["length","count"].indexOf(s)===-1&&e.push(o.deleteOneDevice(s));for(var c=0;c<b.length;c++){e.push(o.removeNodeByID(b[c].nodeId));for(var d=0;d<te.allData.nodes.length;d++){var u=te.allData.nodes[d];if(b[c].nodeId===u.id){te.allData.nodes.splice(d,1);break}}}var p=t.defer();t.all(e).then(function(e){p.resolve("success"),H(e),W(),O()},function(e){p.resolve("修改设备失败"),i.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})}),te.commitTransaction("DeviceHandler")}function W(){for(var e=[],n=0;n<te.groupRef.removed.length;n++)e.push(o.updateGroups(te.groupRef.removed[n],[]));for(n=0;n<te.groupRef.edited.length;n++){var a=te.findNodeForKey(te.groupRef[te.groupRef.edited[n]]);if(a){var r=[],l={};l.groupName=a.data.nameInDetail,l.groupX=a.location.x,l.groupY=a.location.y,l.isExpaneded=a.isSubGraphExpanded,l.groupId=a.data.groupId,e.push(o.createGroups(l));for(var s=a.memberParts.iterator;s.next();)s.value instanceof go.Node&&r.push(s.value.data.deviceId);e.push(o.updateGroups(a.data.groupId,r))}}var c=t.defer();t.all(e).then(function(){c.resolve("success")},function(e){c.resolve("修改设备失败"),i.addAlert({type:"danger",content:"修改设备失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")})})}function F(){function n(e,t){e.isGroup||("CLOUD"!==e.nodeType?(T[t]=new a(e,t),S[t]=new r(e,t)):(b[D.toString()+e.key]=new o(e,t,(!1),[]),D++))}function o(e,t,n,o){var a=n?n:"";if(a&&(a="_"+a),this.id=100*t,this.deviceId=t.toString(),this.importance=["IPS","IDS","ROUTING_IPS"].indexOf(e.nodeType)>=0?1:2,this.name=e.nameInDetail+a,this.zoneName=e.zoneName?o.length>0?e.zoneName[Math.floor(Number(o[0][1])/2)]:e.zoneName[0]:"FACTORY_DEVICE"===e.category?e.nameInDetail:"NA",this.type=e.nodeType,this.nodeProperty=o.length>0&&e.nodeProperty&&"SECURITY_DEVICE"===e.category?e.nodeProperty[Math.floor(Number(o[0][1])/2)]:"",this.x=te.findNodeForKey(e.key).x,this.y=te.findNodeForKey(e.key).y,o.length>0){this.ports=[];for(var r=0;r<o.length;r++)this.ports.push(o[r])}}function a(e,t){function n(e,t){this.portName=e.portName?e.portName:"",this.isMgmtPort=!!e.isMgmtPort&&e.isMgmtPort,this.portIp=e.isMgmtPort?t:e.portIp?e.portIp:"",this.netMask=e.netMask?e.netMask:"",this.mac=e.mac?e.mac:""}this.deviceId=t.toString(),this.modelId=t.toString(),this.category=e.category,this.name=e.nameInDetail,this.modelIdentifier=e.modelIdentifier?e.modelIdentifier:"",this.serialNumber=e.serialNumber,this.devicePorts="",this.iconType=e.iconType,this.hasUSB=e.hasUSB,this.hasWireless=e.hasWireless,this.hasPort=!0,this.notConnectedPortMap=e.notConnectedPortMap?e.notConnectedPortMap:"";var a,r=0;if(te.deviceNodesHolder[e.deviceId]){if(e.ports)for(this.devicePorts=e.ports,r=0;r<this.devicePorts.length;r++)delete this.devicePorts[r].index,delete this.devicePorts[r].connection;a=new o(e,t,te.deviceNodesHolder[e.deviceId][0].sort().join("_"),te.deviceNodesHolder[e.deviceId][0])}else{var i=[];if(e.ports){var l=[];for(r=0;r<e.ports.length;r++)"subnet"===e.iconType?l.push(new n(e.ports[r],e.subnetIp)):"FACTORY_DEVICE"===e.category?l.push(new n(e.ports[r],e.ports[r].portIp)):l.push(new n(e.ports[r],e.ip)),0===e.ports[r].portName.indexOf("p")?i.push("p"+r):"";this.devicePorts=l}a=new o(e,t,i.join("_"),i)}b["0"+e.key]=a}function r(e,t){var n=u("deviceModel")(e.modelInDetail);this.modelId=t.toString(),this.category=e.category,this.make=e.manufacturerInDetail,"SECURITY_DEVICE"===e.category?this.model=n.substring(n.indexOf("KE"),n.length):this.model=n,this.version=e.version?e.version:""}function l(e,t){for(var n,o,a,r,i,l,s,c,d,u=!1,p=!1,f=0;f<t.length;f++){if(t[f].key===e.from){for(i in b)if(Number(i.split("-")[1])===-t[f].key){n=100*b[i].deviceId,c=e.fromPort;break}["IPS","IDS"].indexOf(t[f].nodeType)>=0&&(u=!0,a=n/100)}if(t[f].key===e.to){for(i in b)if(Number(i.split("-")[1])===-t[f].key){o=100*b[i].deviceId,d=e.toPort;break}["IPS","IDS"].indexOf(t[f].nodeType)>=0&&(p=!0,r=o/100)}}if(u)for(s in b){if(n===b[s].id)break;if(a===Number(b[s].deviceId))for(l=0;l<b[s].ports.length;l++)b[s].ports[l]===e.fromPort&&(n=b[s].id,c=e.fromPort)}if(p)for(s in b){if(o===b[s].id)break;if(r===Number(b[s].deviceId))for(l=0;l<b[s].ports.length;l++)b[s].ports[l]===e.toPort&&(o=b[s].id,d=e.toPort)}this.nodeID=n,this.destinationNodeID=o,this.sourcePortName=c,this.destinationPortName=d}var s,c,d,f,m=JSON.parse(te.model.toJson()),g=m.nodeDataArray,h=m.linkDataArray,v={},y=0,I="",D=0,T={},b={},S={},P=angular.copy(te.deviceNodesHolder),A=1;for(y=0;y<g.length;y++)n(g[y],A),A++;for(I=[],s=Object.keys(b),y=0;y<s.length;y++){var C=b[s[y]];for(c in C)C[c]||["id","importance"].indexOf(c)!==-1||delete C[c];I.push(C)}for(v.nodes=I,I=[],s=Object.keys(T),y=0;y<s.length;y++){var k=T[s[y]];for(c in k)if(k[c]||["hasUSB","hasWireless","hasPort"].indexOf(c)!==-1){if("devicePorts"===c)for(d in k[c])if(k[c].hasOwnProperty(d))for(f in k[c][d])k[c][d][f]||"isMgmtPort"===f||delete k[c][d][f]}else delete k[c];I.push(k)}for(v.devices=I,I=[],s=Object.keys(S),y=0;y<s.length;y++){var w=S[s[y]];for(c in w)w[c]||["make","model","category"].indexOf(c)!==-1||delete w[c];I.push(w)}v.models=I;var E=[];for(y=0;y<h.length;y++)h[y].from!==h[y].to&&E.push(new l(h[y],g));I=E,v.links=I;var N=t.defer();t.all([e.validateTopo(v)]).then(function(e){N.resolve("success"),te.validationMessage=e[0].data.warningInfos.join("\n- "),j(),K(!1),te.toolManager.dragSelectingTool.isEnabled=!1,te.toolManager.contextMenuTool.isEnabled=!1,te.model.isReadOnly=!0},function(e){p.isUpdating=!1,i.addAlert({type:"danger",content:"验证拓扑失败"+(e&&e.data&&e.data.error?"："+e.data.error:"")}),te.deviceNodesHolder=angular.copy(P),te.toolManager.dragSelectingTool.isEnabled=!0,te.toolManager.contextMenuTool.isEnabled=!0,te.model.isReadOnly=!1})}function H(e){for(var t=0,n=0;n<te.model.nodeDataArray.length;n++){var o=te.model.nodeDataArray[n];p.lastSelection===o.key&&-p.lastSelection<=te.nodeCopy.length?p.lastSelection="cloud"!==o.iconType.toLowerCase()?o.deviceId:-o.key:"",-o.key>te.nodeCopy.length&&("cloud"!==o.iconType?(p.lastSelection===o.key?p.lastSelection=e[t].deviceId:"",o.deviceId=e[t].deviceId,t++):(o.deviceId=-o.key,p.lastSelection===o.key?p.lastSelection=-o.key:""),te.keyToDevice[-o.key]=o,te.keyToDevice.length=te.keyToDevice.length+1,te.devicesNodeMapCopy[o.deviceId]=-1)}}function G(){var o=[],a=[],r=[];o.push(e.getDevices(n.topo)),o.push(e.getNodes(n.topo)),t.all(o).then(function(e){a=e[1].data,r=e[0].data;for(var t=0;t<te.model.nodeDataArray.length;t++){for(var n=te.model.nodeDataArray[t],o=!1,i=0;i<r.length;i++)if(te.model.nodeDataArray[t].deviceId===r[i].deviceId){o=r[i].deviceId;break}if(o){for(var l=0;l<a.length;l++)if(a[l].deviceId===n.deviceId)if(a[l].ports){for(var s=0;s<a[l].ports.length;s++)for(var c=0;c<n.ports.length;c++)if(n.ports[c].portName.toLowerCase()===a[l].ports[s].toLowerCase()){["ips","ids"].indexOf(n.nodeType.toLowerCase())>=0?Array.isArray(te.devicesNodeMapCopy[n.deviceId])&&(te.devicesNodeMapCopy[n.deviceId][c]=a[l].id):te.devicesNodeMapCopy[n.deviceId]=a[l].id;break}}else te.devicesNodeMapCopy[n.deviceId]=a[l].id}else if("cloud"===te.devicesNodeMapCopy[-n.key])for(var d=0;d<a.length;d++)if("cloud"===a[d].type.toLowerCase()){te.devicesNodeMapCopy[-n.key]=a[d].id;break}}B()})}function z(e){b.push(e)}function q(e){te.startTransaction("Edit"),p.isUpdating=!1;for(var t=0;t<te.model.linkDataArray.length;t++)"unspecified"===te.model.linkDataArray[t].fromPort&&te.model.setDataProperty(te.model.linkDataArray[t],"fromPort","foreGround"),"unspecified"===te.model.linkDataArray[t].toPort&&te.model.setDataProperty(te.model.linkDataArray[t],"toPort","foreGround");te.toolManager.dragSelectingTool.isEnabled=!0,te.toolManager.contextMenuTool.isEnabled=!0,te.maxSelectionCount=Number.MAX_VALUE,te.model.isReadOnly=!1,p.EditMode=!0,te.updateAllTargetBindings("nameInDetail"),te.updateAllTargetBindings("linkId"),K(e),te.commitTransaction("Edit")}function Y(e,t){e.cancel=function(){t.close(!1)},e.confirm=function(){t.close(!0)}}function K(e){o.getNewDevices({$orderby:"name"}).then(function(n){var a=[],r=0,s={};for(var c in n)if(c)for(var d in te.model.nodeDataArray)if(d){if(e&&!te.model.nodeDataArray[d].deviceId)continue;if("SECURITY_DEVICE"===te.model.nodeDataArray[d].category&&n[c].serialNumber===te.model.nodeDataArray[d].serialNumber){a[r]=n[c],s=te.model.nodeDataArray[d],r++;break}}a.length>0&&t.when(J(f,t,a,s)).then(function(){var e=t.defer(),n=[];for(var r in a)r&&n.push(o.addToCurrentTopology(a[r].deviceId,""));t.all(n).then(function(){e.resolve("success"),l.reload(),i.addAlert({type:"success",content:"加入当前拓扑成功"})},function(t){e.resolve("加入当前拓扑失败"),i.addAlert({type:"danger",content:"加入当前拓扑失败"+(t&&t.data&&t.data.error?"："+t.data.error:"")})})})})}function J(e,t,n,o){var a=[];for(var r in n)r&&(a[r]=n[r].name);var i=t.defer();return e.open({size:"sm",templateUrl:"templates/asset/securitydevice/confirm-panel.952c69dd.html",controller:["$scope","$modalInstance",function(e,t){e.title="发现相同序列号设备",e.content1='已安装设备中" '+o.nameInDetail+' "与自动发现的新设备＂'+a+"＂序列号相同（SN: "+o.serialNumber+"）。",e.content2='请注意，此操作可能会导致"'+o.nameInDetail+'"的设备规格与MAC地址被覆盖。',e.confirm=function(){t.close(),i.resolve()},e.cancel=function(){t.dismiss("cancel"),i.reject()}}]}),i.promise}function Z(e,t,n,o,a){this.from=t,this.to=n,this.fromPort=o,this.toPort=a,this.color="gray",this.toArrow="",this.strokeWidth="1",this.linkId=e,this.link=go.Link.AvoidsNodes}function Q(e){function t(e,t,n){var o=["",""];if(e)for(var a=0;a<e.length;a++)if(e[a]!==n){var r=!1;if(t)for(var i=0;i<t.length;i++)2===t[i].length&&(t[i][0]===e[a]&&t[i][1]===n||t[i][0]===n&&t[i][1]===e[a])&&(r=!0,o[1].length>0&&(o[1]+=","),o[1]+=e[a]);r||(o[0].length>0&&(o[0]+=","),o[0]+=e[a])}return o}n.drawing=!0,te.topologyId=e.topologyId,n.routingIPS=!1;for(var a=[],r=[],i={},l={},s={},c={},d={},u={},f={},m={},g=0;g<e.devices.length;g++){"SECURITY_DEVICE"===e.devices[g].category?m[e.devices[g].deviceId]=[]:"",d[e.devices[g].deviceId]={},i[e.devices[g].deviceId]=[],l[e.devices[g].deviceId]=[];for(var h=0;h<e.devices[g].devicePorts.length;h++)i[e.devices[g].deviceId].push(-1),l[e.devices[g].deviceId].push(-1),d[e.devices[g].deviceId][h]="NA"}for(var v=0;v<e.nodes.length;v++)if("CLOUD"===e.nodes[v].type){var y={key:e.nodes[v].id,nodeId:e.nodes[v].id,iconType:"cloud",topologyId:e.nodes[v].topologyId,currentTopology:e.currentTopology,modelId:"cloud",img:"images/cloud-icon.727f8e55.png",loc:e.nodes[v].x+" "+e.nodes[v].y,nameInDetail:e.nodes[v].name,category:"NETWORK_DEVICE",updateTime:e.updatedAt,statusIconShow:!1,portIdRef:!1,nodeType:"CLOUD",deviceId:"cloud"};r.push(y)}else{u[e.nodes[v].id]=e.nodes[v].deviceId,e.nodes[v].ports&&["ips","routing_ips","ids"].indexOf(e.nodes[v].type.toLowerCase())>=0&&(c[e.nodes[v].deviceId]=c[e.nodes[v].deviceId]||{},c[e.nodes[v].deviceId][Math.floor(Number(e.nodes[v].ports[0][1])/2)]=e.nodes[v].nodeProperty),d[e.nodes[v].deviceId][e.nodes[v].ports&&e.nodes[v].ports[0]?Math.floor(Number(e.nodes[v].ports[0][1])/2):0]=e.nodes[v].zoneName,s[e.nodes[v].deviceId]={positionNodeId:e.nodes[v].id,loc:e.nodes[v].x+" "+e.nodes[v].y,x:e.nodes[v].x,y:e.nodes[v].y,iconType:o.getIconName(e.nodes[v]._iconType),nodeType:e.nodes[v].type,subcategory:e.nodes[v]._subcategory},m[e.nodes[v].deviceId]?m[e.nodes[v].deviceId].push(e.nodes[v].ports):"",n.routingIPS||"ROUTING_IPS"!==e.nodes[v].type||(n.routingIPS=!0);for(var I=0;I<e.devices.length;I++)if(e.devices[I].deviceId===e.nodes[v].deviceId){if(e.nodes[v].ports){for(var D=0;D<e.nodes[v].ports.length;D++)for(var T=0;T<e.devices[I].devicePorts.length;T++)if(e.devices[I].devicePorts[T].portName.toLowerCase()===e.nodes[v].ports[D].toLowerCase()){Array.isArray(i[e.devices[I].deviceId])&&(i[e.devices[I].deviceId][T]=e.nodes[v].id),["ips","ids"].indexOf(e.nodes[v].type.toLowerCase())>=0?Array.isArray(l[e.devices[I].deviceId])&&(l[e.devices[I].deviceId][T]=e.nodes[v].id):l[e.devices[I].deviceId]=e.nodes[v].id;break}}else l[e.devices[I].deviceId]=e.nodes[v].id;break}}for(var b=1,P={},A={},C=!1,k=[],w=0;w<e.devices.length;w++){var N=e.devices[w];if(s[N.deviceId]){var $,M,U,_,x=N.updatedAt;$=M=U=_="";for(var O=0;O<N.devicePorts.length;O++)N.devicePorts[O].isMgmtPort&&($=N.devicePorts[O].linkState||"",M=N.devicePorts[O].portIp||"",U=N.devicePorts[O].mac||"",_=N.devicePorts[O].netMask||"");P[N.deviceId]=b;var L,B="ROUTING_IPS"===s[N.deviceId].nodeType;if(B){var V;for(v=0;v<e.nodes.length;v++)if(e.nodes[v].deviceId===N.deviceId){if(N&&N.notConnectedPortMap)for(L=N.notConnectedPortMap.split(/\[(.*?)\]/g),V=L.length-1;V>=0;V--)L[V].length<2?L.splice(V,1):L[V]=L[V].split(",");if(N.devicePorts)for(V=0;V<N.devicePorts.length;V++){for(var j=0;j<N.devicePorts.length;j++)N.devicePorts.index=j,N.devicePorts[V].portName==="p"+j&&(N.devicePorts[V].index=+N.devicePorts[V].portName.substr(1),N.devicePorts[V].connection=t(e.nodes[v].ports,L,"p"+j));N.devicePorts[V].isMgmtPort||!N.devicePorts[V].netMask||"0"===N.devicePorts[V].netMask||n.forms.netMasks[N.devicePorts[V].netMask]||(N.devicePorts[V].netMask=n.forms.netMasks.indexOf(N.devicePorts[V].netMask))}}}var W=s[N.deviceId].nodeType&&"ROUTING_IPS"===s[N.deviceId].nodeType?"路由保护":s[N.deviceId].nodeType&&("IDS"===s[N.deviceId].nodeType?"监测审计":s[N.deviceId].nodeType&&("IPS"===s[N.deviceId].nodeType?"DATA_COLLECTION_DEVICE"===N._subCategory?"数采隔离":"智能保护":"")),F={key:-b,nodeId:s[N.deviceId].positionNodeId,topologyId:e.topologyId,currentTopology:e.currentTopology,deviceId:N.deviceId,img:"SECURITY_DEVICE"===N.category?o.getSecurityDeviceIconPath(N._model_name,N.iconType):"images/"+s[N.deviceId].iconType.toLowerCase()+"-icon.png",iconType:s[N.deviceId].iconType.toLowerCase(),loc:s[N.deviceId].loc,nameInDetail:N.name,manufacturerInDetail:N&&N.make?N.make:"",modelId:N&&N.modelId?N.modelId:"",modelInDetail:N&&N._model_name?N._model_name:"",versionInDetail:N&&N.version?N.version:"",serialNumber:N.serialNumber?N.serialNumber:"",modeDescription:W,ruleOnNode:"",countOfIncident:"",unreadCountOfIncident:"",showMode:W.length>0,routingMode:B,mmgtPort:$,deviceOnline:"DISCOVERY"===N.deviceSource?N.deviceOnline:0,deviceSource:N.deviceSource,updateTime:x,mac:U,ip:M,netMask:_,ports:"switch"!==s[N.deviceId].iconType.toLowerCase()?N.devicePorts:"",numPorts:N.devicePorts.length,rightArray:[],leftArray:[],nearArray:[],farArray:[],bottomArray:[],category:N.category,subcategory:N._subCategory,nodeType:s[N.deviceId].nodeType,isEdited:!1,invalid:!1,startDatetime:N.startDatetime,nodeProperty:c[N.deviceId],zoneName:d[N.deviceId],modelIdentifier:N.modelIdentifier,hasWireless:N.hasWireless,hasUSB:N.hasUSB,group:N.groupId};if("subnet"===F.iconType&&F.ip.indexOf("/")>=0){F.subnetIp=F.ip;var H="",G=F.ip.split("/");F.ip=G[0];for(var z=0;z<4;z++){var q=G[1]>0?(G[1]=G[1]-8)>0?Array(9).join("1"):Array(G[1]+9).join("1")+Array(1-G[1]).join("0"):"0";H+=parseInt(q,2).toString(),3!==z?H+=".":""}F.netMask=H}if(s[N.deviceId].devicePorts=F.ports,["ips","ids"].indexOf(s[N.deviceId].nodeType.toLowerCase())===-1)if("FACTORY_DEVICE"===F.category&&"subnet"!==F.iconType.toLowerCase()){F.portIdRef=!1;for(var Y=0;Y<F.ports.length;Y++)F.ports[Y].isMgmtPort&&F.bottomArray.push({portName:F.ports[Y].portName,portIp:F.ports[Y].portIp})}else F.portIdRef=!0;else{F.portIdRef=!1;for(var K=0;K<F.ports.length;K++)F.ports[K].isMgmtPort||(Number(F.ports[K].portName.substr(1))%2===0?("ips"===s[N.deviceId].nodeType.toLowerCase()?F.nearArray.push({portName:F.ports[K].portName+"near"}):"",F.leftArray.push({portName:F.ports[K].portName})):("ips"===s[N.deviceId].nodeType.toLowerCase()?F.farArray.push({portName:F.ports[K].portName+"far"}):"",F.rightArray.push({portName:F.ports[K].portName})));for(K=0;K<F.nearArray.length;K++)k.push(new Z((-1),(-b),(-b),F.nearArray[K].portName,F.farArray[K].portName))}F&&"SECURITY_DEVICE"===F.category?"DISCOVERY"===F.deviceSource?1===F.deviceOnline?(F.statusText="连线",F.indicator="bullet bullet-online",F.statusIconShow=!1,F.statusColor="green"):F.deviceOnline===-1?(F.statusText="掉线",F.indicator="bullet bullet-offline",F.statusIconShow=!0,F.statusColor="red"):(F.statusText="未激活",F.indicator="bullet bullet-unactivated",F.statusIconShow=!0,F.statusColor="red"):(F.statusText="未激活",F.indicator="bullet bullet-unactivated",F.statusIconShow=!0,F.statusColor="red"):(F.statusText="",F.statusIconShow=!1,F.statusColor="white"),C||"SECURITY_DEVICE"!==F.category||(C=b-1);var J={};for(var Q in F)F.hasOwnProperty(Q)&&(J[Q]=F[Q]);a.push(F),A[b]=F,f[J.deviceId]=J,b++}}for(var X=0;X<r.length;X++)P[b]=b,A[b]=r[X].key,u[r[X].key]=b,l[b]=r[X].key,r[X].key=-b,a.push(r[X]),b++;for(var ee=[],ne={},oe=0;oe<e.links.length;oe++){var ae=-P[u[e.links[oe].nodeID]],re=-P[u[e.links[oe].destinationNodeID]],ie="unspecified",le="unspecified";if(s[u[e.links[oe].nodeID]])for(var se=0;se<i[u[e.links[oe].nodeID]].length;se++)if(i[u[e.links[oe].nodeID]][se]===e.links[oe].nodeID){i[u[e.links[oe].nodeID]][se]=-1,ie=e.links[oe].sourcePortName?e.links[oe].sourcePortName:"ROUTING_IPS"===s[u[e.links[oe].nodeID]].nodeType?"foreGround":s[u[e.links[oe].nodeID]].devicePorts[se].portName.toLowerCase();break}if(s[u[e.links[oe].destinationNodeID]])for(var ce=0;ce<i[u[e.links[oe].destinationNodeID]].length;ce++)if(i[u[e.links[oe].destinationNodeID]][ce]===e.links[oe].destinationNodeID){i[u[e.links[oe].destinationNodeID]][ce]=-1,le=e.links[oe].destinationPortName?e.links[oe].destinationPortName:"ROUTING_IPS"===s[u[e.links[oe].destinationNodeID]].nodeType?"foreGround":s[u[e.links[oe].destinationNodeID]].devicePorts[ce].portName.toLowerCase();break}ee.push(new Z(e.links[oe].id,ae,re,ie,le)),ne[e.links[oe].id]=new Z(e.links[oe].id,ae,re,ie,le)}ee=ee.concat(k);var de={leave:null,removed:[],edited:[],obsolete:[]};for(X=0;X<e.groups.length;X++){var ue=!0,pe={key:-b};for(pe.nameInDetail=e.groups[X].groupName,pe.x=e.groups[X].groupX,pe.y=e.groups[X].groupY,pe.initialExpansion=e.groups[X].isExpaneded,pe.groupId=e.groups[X].groupId,pe.topologyId=e.topologyId,pe.currentTopology=e.currentTopology,pe.img=p.groupIcon,pe.category=e.category?e.category:"",pe.updateTime=(new Date).toJSON(),pe.statusIconShow="SECURITY_DEVICE"===e.category,pe.nodeType=e.deviceType&&"Cloud"!==e.deviceType?"网络交换机"===e.deviceType?"SWITCH":"路由器"===e.deviceType?"ROUTER":"安全设备"===e.deviceType?"IPS":"ENDPOINT":"CLOUD",pe.isEdited=!1,pe.iconType=e.img?e.img.substring(7,e.img.length-9):"cloud",pe.modelId="Group",pe.deviceId="",pe.statusShade="",pe.preview="",pe.isGroup=!0,b++,de[e.groups[X].groupId]=pe.key,oe=0;oe<a.length;oe++)a[oe].group&&Number(a[oe].group)===pe.groupId&&(a[oe].group=pe.key,ue=!1);ue?de.obsolete.push(e.groups[X].groupId):a.push(pe)}te.groupRef=de,te.linkCopy=ne,f.length=a.length,f.count=b,te.nodeCopy=f,te.devicesNodeMapCopy=l,A.length=a.length,te.keyToDevice=A,te.allData=e,te.currentTopology=e.currentTopology,te.topologyId=e.topologyId,te.topoName=e.name,te.blankModelId=e.blankModel,te.deviceNodesHolder=m,te.model=new go.GraphLinksModel(a,ee),te.model.linkFromPortIdProperty="fromPort",te.model.linkToPortIdProperty="toPort",te.model.isReadOnly=!0,te.model.copyNodeDataFunction=R,n.GOJSmodel=te.model,n.drawing=!1,n.topologyHasNode&&(C=C===!1?0:C,E(p.lastSelection!==!1&&te.findNodeForKey(-P[p.lastSelection])?te.findNodeForKey(-P[p.lastSelection]):te.findNodeForData(te.model.nodeDataArray[C])));for(var fe=0;fe<te.model.nodeDataArray.length;fe++)te.model.nodeDataArray[fe].isGroup&&(S(te.findNodeForKey(te.model.nodeDataArray[fe].key)),te.findNodeForKey(te.model.nodeDataArray[fe].key).isSubGraphExpanded=te.model.nodeDataArray[fe].initialExpansion,te.model.nodeDataArray[fe].initialExpansion||(te.findNodeForKey(te.model.nodeDataArray[fe].key).location.x=te.model.nodeDataArray[fe].x,te.findNodeForKey(te.model.nodeDataArray[fe].key).location.y=te.model.nodeDataArray[fe].y));for(n.oldData=[],oe=0;oe<te.model.nodeDataArray.length;oe++){n.validateDevice(te.model.nodeDataArray[oe]);var me={deviceId:te.model.nodeDataArray[oe].deviceId,serialNumber:te.model.nodeDataArray[oe].serialNumber,ip:te.model.nodeDataArray[oe].ip};n.oldData.push(me)}}Y.$inject=["$scope","$modalInstance"];var X=go.GraphObject.make,ee=X(go.Adornment,"Vertical",X("ContextMenuButton",X(go.TextBlock,{text:"新增分組",font:p.nodeTopFont}),{click:function(e){var t=e.diagram;if(t.startTransaction("newGroup"),t.selection.count>0){var n=t.commandHandler;n.groupSelection()}t.commitTransaction("newGroup")}},new go.Binding("visible","",function(e){return!(["cloud"].indexOf(e.iconType)>=0||"SECURITY_DEVICE"===e.category||e.group)&&(!e.isGroup&&!e.fromPort)})),X("ContextMenuButton",X(go.TextBlock,{text:"删除分組",font:p.nodeTopFont}),{click:function(e){var t=e.diagram;t.startTransaction("unGroup");var n=t.commandHandler;n.ungroupSelection();var o=[];t.selection.each(function(e){e instanceof go.Node&&o.push(e)});for(var a=0;a<o.length-1;a++)o[a].isSelected=!1;t.commitTransaction("unGroup")},visible:!1},new go.Binding("visible","",function(e){return!!e.isGroup})),X("ContextMenuButton",X(go.TextBlock,{font:p.nodeTopFont},{click:function(){A()}},new go.Binding("text","",function(e){for(var t=!1,n=!1,o=te.selection.iterator;o.next();)if(t=o.value instanceof go.Link&&!o.value.data.isGroup||t,n=o.value instanceof go.Node&&!o.value.data.isGroup||n,t&&n)return"删除所选设备";return e.fromPort?"删除连线":"删除设备"})),new go.Binding("visible","",function(e){return!(e.isGroup||"SECURITY_DEVICE"===e.category&&1===e.deviceOnline)}))),te=X(go.Diagram,"topologySingle",{initialContentAlignment:go.Spot.TopCenter,scale:null===localStorage.getItem("monitor:topology.scale."+d)?1:parseFloat(localStorage.getItem("monitor:topology.scale."+d)),"toolManager.mouseWheelBehavior":go.ToolManager.WheelZoom,"commandHandler.archetypeGroupData":{isGroup:!0,category:"OfNodes"},allowDrop:!0,minScale:.1,maxScale:2,maxSelectionCount:1,grid:X(go.Panel,"Grid",{gridCellSize:new go.Size(50,50)},X(go.Shape,"LineH",p.gridPattern),X(go.Shape,"LineV",p.gridPattern))});te.scrollMode=go.Diagram.InfiniteScroll;var ne=te.findLayer("Foreground");te.addLayerBefore(X(go.Layer,{name:"SecurityDeviceLayer",allowGroup:!1}),ne);var oe=te.findLayer("Background");te.addLayerAfter(X(go.Layer,{name:"GroupLayer"}),oe),te.animationManager.isEnabled=!1,te.toolManager.hoverDelay=500,te.toolManager.contextMenuTool.isEnabled=!1,te.toolManager.draggingTool.isGridSnapEnabled=!0,te.toolManager.draggingTool.gridSnapCellSize=new go.Size(1,1),te.toolManager.panningTool.isEnabled=!1,te.toolManager.dragSelectingTool.isEnabled=!1,te.toolManager.dragSelectingTool.isPartialInclusion=!0,te.toolManager.linkingTool.linkValidation=U,te.toolManager.relinkingTool.linkValidation=U,te.commandHandler.canCopySelection=function(){return!1},te.commandHandler.canPasteSelection=function(){return!1},te.addDiagramListener("SelectionMoved",C),te.addDiagramListener("ChangedSelection",k),te.addDiagramListener("ObjectSingleClicked",M),te.addDiagramListener("SubGraphExpanded",w),te.addDiagramListener("SubGraphCollapsed",w),te.addChangedListener(function(e){"isSubGraphExpanded"===e.mm&&te.updateAllTargetBindings("key")});var ae=te.toolManager.linkingTool;ae.temporaryFromPort.strokeWidth=2,ae.temporaryFromPort.stroke=p.centerConnectorStroke,ae.temporaryFromPort.figure="Circle",ae.temporaryFromPort.fill=p.centerConnectorStroke,ae.temporaryToPort.strokeWidth=2,ae.temporaryToPort.stroke=p.centerConnectorStroke,ae.temporaryToPort.figure="Circle",ae.temporaryToPort.fill=p.centerConnectorStroke,ae.doActivate=function(){te.toolManager.hideToolTip(),go.LinkingTool.prototype.doActivate.call(ae)},te.toolManager.dragSelectingTool.box=X(go.Part,{layerName:"Tool"},X(go.Shape,{name:"SHAPE",fill:"gray",opacity:.3,strokeWidth:1})),te.toolManager.linkingTool.temporaryLink=X(go.Link,{layerName:"Tool"},X(go.Shape,{strokeWidth:2,stroke:p.centerConnectorStroke}),X(go.Shape,{toArrow:"Standard",fill:p.centerConnectorStroke,stroke:null})),te.commandHandler.ungroupSelection=function(){te.selection.each(function(e){if(e instanceof go.Node&&e.data.groupId){r(p.invalidDeviceList,e.data),
te.groupRef.removed.push(e.data.groupId);for(var t=0;t<te.groupRef.edited.length;t++)te.groupRef.edited[t]===e.data.groupId&&te.groupRef.edited.splice(t,1)}}),go.CommandHandler.prototype.ungroupSelection.call(this),0===p.invalidDeviceList.length&&(p.invalid=!1),x()},te.commandHandler.groupSelection=function(){go.CommandHandler.prototype.groupSelection.call(this),te.selection.each(function(e){if(e instanceof go.Node){for(e.data.groupId=te.groupRef.obsolete.shift();!e.data.groupId&&te.groupRef[e.data.groupId=Math.floor(100*Math.random()+1)];);te.groupRef[e.data.groupId]=e.data.key,te.groupRef.edited.indexOf(e.data.groupId)===-1?te.groupRef.edited.push(e.data.groupId):"",S(e)}})},te.commandHandler.deleteSelection=function(){A()},te.toolManager.dragSelectingTool.selectInRect=function(e){if(te.clearSelection(),go.DragSelectingTool.prototype.selectInRect.call(this,e),"crosshair"===te.defaultCursor&&te.selection.count>0){te.zoomToRect(te.computePartsBounds(te.selection));var t=te.computePartsBounds(te.selection).width,n=te.viewportBounds.width*(1-600/document.getElementById("topologySingle").offsetWidth);te.scale>1?te.scale=1:t>n&&(te.scale=.7*te.scale-300/t),te.centerRect(te.computePartsBounds(te.selection))}te.defaultCursor="default",te.toolManager.dragSelectingTool.box=X(go.Part,{layerName:"Tool"},X(go.Shape,{name:"SHAPE",fill:"gray",opacity:.3,strokeWidth:1}))},te.click=function(){te.startTransaction("no highlighteds"),te.clearHighlighteds(),te.commitTransaction("no highlighteds"),n.$digest()},te.mouseDrop=function(e){te.startTransaction("getNode"),te.selection.each(function(t){t instanceof go.Node&&!(te.selection.count>1)&&(E(t),I(e,null),n.$digest())}),te.commitTransaction("getNode")},p.createSnap=function(e){e.group&&S(te.findNodeForKey(e.group))},te.groupTemplate=X(go.Group,go.Panel.Auto,{background:"transparent",ungroupable:!0,groupable:!1,deletable:!1,computesBoundsIncludingLinks:!1,layerName:"GroupLayer",contextMenu:ee,computesBoundsAfterDrag:!0,selectionAdorned:!1,toolTip:X(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},X(go.Shape,"Rectangle",{isPanelMain:!0,fill:"rgb(42, 43, 49)"}),X(go.Picture,{imageStretch:go.GraphObject.Uniform},new go.Binding("source","preview"),new go.Binding("visible","",function(e){return!te.findNodeForData(e).isSubGraphExpanded}))),mouseDragEnter:function(e,t){P(e,t,!0)},mouseDragLeave:function(e,t){te.groupRef.leave?"":te.groupRef.leave=t.data.groupId,P(e,t,!1)},click:function(){te.updateAllTargetBindings("key")},mouseDrop:function(e,t){I(e,t)},doubleClick:function(e,t){t.isSubGraphExpanded?t.collapseSubGraph():t.expandSubGraph()}},X(go.Shape,"RoundedRectangle",{fill:null,strokeWidth:0,stroke:null,portId:"unspecified"},new go.Binding("fill","isSelected",function(e){return e?p.nodeSelectionBrush:null}).ofObject(""),new go.Binding("stroke","invalid",function(e){return e?p.nodeInvalidBrush:null}),new go.Binding("strokeWidth","invalid",function(e){return e?3:0})),X(go.Panel,"Auto",X(go.Shape,"RoundedRectangle",{strokeWidth:1.5,stroke:p.groupHeadBack},new go.Binding("stroke","isSelected",function(e){return e?p.nodeSelectionBrush:p.groupHeadBack}).ofObject(""),new go.Binding("fill","statusShade",function(e){return"good"===e?p.goodGroupAdd:"bad"===e?p.badGroupAdd:p.groupBodyBack})),X(go.Panel,"Vertical",X(go.Shape,"RoundedRectangle",{fill:p.groupHeadBack,stroke:null,name:"TextBox",height:26,stretch:go.GraphObject.Horizontal}),X(go.Panel,go.Panel.Horizontal,{margin:new go.Margin((-30),10,0,0),padding:0,alignment:go.Spot.Left},X("SubGraphExpanderButton",{alignment:go.Spot.Right,margin:new go.Margin(8,5,10,5)}),X(go.TextBlock,{alignment:go.Spot.Left,isMultiline:!1,font:p.nodeTopFont,stroke:p.groupHeadStroke},new go.Binding("text","nameInDetail").makeTwoWay())),X(go.Shape,"Rectangle",{fill:p.groupBodyBack,stroke:null,height:10,margin:new go.Margin((-7),0,0,0),stretch:go.GraphObject.Horizontal},new go.Binding("fill","statusShade",function(e){return"good"===e?p.goodGroupAdd:"bad"===e?p.badGroupAdd:p.groupBodyBack})),X(go.Panel,"Auto",{margin:new go.Margin((-10),0,0,0),alignment:go.Spot.Center},X(go.Shape,"RoundedRectangle",{margin:new go.Margin((-9),0,0,0),fill:null,stroke:null}),X(go.Picture,{margin:new go.Margin(5),source:p.groupIcon,width:80,height:65,imageStretch:go.GraphObject.Uniform},new go.Binding("visible","key",function(e){return!te.findNodeForKey(e).isSubGraphExpanded})),X(go.Placeholder,{background:null,padding:15}))))),te.nodeTemplate=X(go.Node,"Spot",{margin:50,name:"NODE",selectionAdorned:!1,contextMenu:ee},new go.Binding("location","loc",go.Point.parse),new go.Binding("groupable","",function(e){return["ips","cloud"].indexOf(e.iconType)===-1&&!e.group}),new go.Binding("layerName","category",function(e){return"SECURITY_DEVICE"===e?"SecurityDeviceLayer":""}),X(go.Panel,"Table",{toolTip:X(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},X(go.Shape,"Rectangle",{isPanelMain:!0,fill:p.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),X(go.Panel,"Vertical",{margin:10},X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.tooltipFont},new go.Binding("text","nameInDetail",function(e){return"设备名称: "+e})),X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.tooltipFont},new go.Binding("visible","category",function(e){return"SECURITY_DEVICE"===e}),new go.Binding("text","statusText",function(e){return"设备状态: "+e})),X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.tooltipFont},new go.Binding("visible","iconType",function(e){return!(["cloud"].indexOf(e)>=0)}),new go.Binding("text","modelInDetail",function(e){return"型号: "+e})),X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.tooltipFont},new go.Binding("visible","iconType",function(e){return!(["cloud","subnet","switch"].indexOf(e)>=0)}),new go.Binding("text","ports",function(e){var t=[];for(var n in e)n&&e[n]&&e[n].isMgmtPort&&t.push("[ "+(e[n].portIp?e[n].portIp:"未知")+" / "+(e[n].mac?e[n].mac:"未知")+" ]");return 1===t.length?"IP / MAC: "+t[0]:"IP / MAC: \n"+t.join("\n")}))))},X(go.Panel,"Auto",{row:1,column:1,name:"BODY"},X(go.Shape,"RoundedRectangle",{fill:null,strokeWidth:0,stroke:null,portId:"unspecified"},new go.Binding("fill","isSelected",function(e){return e?p.nodeSelectionBrush:null}).ofObject(""),new go.Binding("stroke","invalid",function(e){return e?p.nodeInvalidBrush:null}),new go.Binding("strokeWidth","invalid",function(e){return e?3:0})),X(go.Panel,"Auto",{alignment:go.Spot.Top},X(go.Shape,"RoundedRectangle",{width:100,fill:p.nodeTopFillBrush,stroke:null,name:"TextBox"},new go.Binding("fill","category",function(e){return p.getDeviceColor(e)})),X(go.TextBlock,{margin:new go.Margin(2,0,6,0),stroke:p.nodeTextBrush,isMultiline:!1,width:90,font:p.nodeTopFont,textAlign:"center",overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,name:"TEXT"},new go.Binding("text","nameInDetail"))),X(go.Shape,"Rectangle",{alignment:go.Spot.Top,width:100,fill:p.nodeBGBrush,stroke:null,height:10,margin:new go.Margin(20,0,0,0)}),X(go.Panel,"Auto",{margin:new go.Margin(20,0,0,0)},X(go.Shape,"RoundedRectangle",{width:100,fill:p.nodeBGBrush,strokeWidth:3,stroke:null}),X(go.Panel,"Vertical",{margin:new go.Margin(0,5,0,5)},X(go.Panel,"Auto",X(go.Picture,{margin:new go.Margin(5),width:80,height:65,imageStretch:go.GraphObject.Uniform},new go.Binding("source","img")),X(go.Picture,{margin:new go.Margin(38,40,0,0),width:30,imageStretch:go.GraphObject.Uniform},new go.Binding("visible","category",function(e){return"SECURITY_DEVICE"===e}),new go.Binding("source","serialNumber",function(e){var t=null;if(e&&e.length>=2){var n=e.substr(0,2).toLowerCase();["js","jc","sc","zb"].indexOf(n)>=0&&(t="/images/devices/security/badge-"+("jc"===n?"js":n)+".png")}return t})),X(go.Picture,{name:"OfflineIcon",margin:new go.Margin(0,0,0,0),width:60,height:55,source:"/images/Warning.f7811348.png"},new go.Binding("visible","statusIconShow"))),X(go.TextBlock,{stroke:p.nodeTextBrush,textAlign:"center",margin:new go.Margin(0,0,0,0),wrap:go.TextBlock.None,font:p.ipFont,height:9},new go.Binding("visible","iconType",function(e){return!(["cloud","subnet","switch"].indexOf(e)>=0)}),new go.Binding("text","key",function(e){var t=te.findNodeForKey(e).data;return"FACTORY_DEVICE"===t.category&&t.ports&&t.ports.length>0?t.ports[0].portIp?t.ports[0].portIp+(t.ports.length>1?" ...":""):"未知":t.ip&&0!==t.ip.length?t.ip:"未知"}),new go.Binding("stroke","statusIconShow",function(e){return e?p.statusOffBrush:p.nodeTextBrush})),X(go.TextBlock,{stroke:p.nodeTextBrush,textAlign:"center",margin:new go.Margin(0,0,0,0),wrap:go.TextBlock.None,font:p.ipFont,height:9},new go.Binding("visible","iconType",function(e){return["cloud","subnet","switch"].indexOf(e)>=0}))),X(go.Shape,"Circle",{fill:p.centerConnectorFill,desiredSize:new go.Size(16,16),strokeWidth:4,stroke:p.centerConnectorStroke,margin:new go.Margin(0,0,20,0),fromLinkable:!0,toLinkable:!0,name:"middlePort"},new go.Binding("opacity","",function(){return p.EditMode?1:0}),new go.Binding("portId","portIdRef",function(e){return e?"foreGround":"security"}),new go.Binding("cursor","",function(){return p.EditMode?"pointer":"default"}),new go.Binding("visible","portIdRef")))),X(go.Panel,"Vertical",new go.Binding("itemArray","nearArray"),{row:1,column:0,itemTemplate:X(go.Panel,{fromSpot:go.Spot.Right,toSpot:go.Spot.Left},new go.Binding("portId","portName"),X(go.Shape,"Rectangle",{stroke:null,fill:null,desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)}))}),X(go.Panel,"Vertical",new go.Binding("itemArray","farArray"),{row:1,column:2,itemTemplate:X(go.Panel,{fromSpot:go.Spot.Right,toSpot:go.Spot.Left},new go.Binding("portId","portName"),X(go.Shape,"Rectangle",{stroke:null,fill:null,desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)}))}),X(go.Panel,"Vertical",new go.Binding("itemArray","rightArray"),{row:1,column:2,itemTemplate:X(go.Panel,{mouseEnter:function(e,t){for(var n=Number(t.data.portName[1])%2===1?"rightArray":"leftArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=p.centerConnectorStroke,"IPS"===t.part.data.nodeType?t.part.data[Number(t.data.portName[1])%2===1?"leftArray":"rightArray"][o].portColor=p.centerConnectorStroke:"";break}te.updateAllTargetBindings("portColor")},mouseLeave:function(e,t){for(var n=Number(t.data.portName[1])%2===1?"rightArray":"leftArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=p.connectorBrush,"IPS"===t.part.data.nodeType?t.part.data[Number(t.data.portName[1])%2===1?"leftArray":"rightArray"][o].portColor=p.connectorBrush:"";break}te.updateAllTargetBindings("portColor")},fromSpot:go.Spot.Right,toSpot:go.Spot.Right,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),X(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)},new go.Binding("fill","",function(e){return e.portColor?e.portColor:p.connectorBrush}),new go.Binding("cursor","",function(){return p.EditMode?"pointer":"default"})),{toolTip:X(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},X(go.Shape,"Rectangle",{isPanelMain:!0,fill:p.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),X(go.Panel,"Vertical",{margin:10},X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.nodeTopFont},new go.Binding("text","portName",function(e){return"端口: "+e}))))})}),X(go.Panel,"Vertical",new go.Binding("itemArray","leftArray"),{row:1,column:0,itemTemplate:X(go.Panel,{mouseEnter:function(e,t){for(var n=Number(t.data.portName[1])%2===1?"rightArray":"leftArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=p.centerConnectorStroke,"IPS"===t.part.data.nodeType?t.part.data[Number(t.data.portName[1])%2===1?"leftArray":"rightArray"][o].portColor=p.centerConnectorStroke:"";break}te.updateAllTargetBindings("portColor")},mouseLeave:function(e,t){for(var n=Number(t.data.portName[1])%2===1?"rightArray":"leftArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=p.connectorBrush,"IPS"===t.part.data.nodeType?t.part.data[Number(t.data.portName[1])%2===1?"leftArray":"rightArray"][o].portColor=p.connectorBrush:"";break}te.updateAllTargetBindings("portColor")},fromSpot:go.Spot.Left,toSpot:go.Spot.Left,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),X(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(1,0)},new go.Binding("fill","",function(e){return e.portColor?e.portColor:p.connectorBrush}),new go.Binding("cursor","",function(){return p.EditMode?"pointer":"default"})),{toolTip:X(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},X(go.Shape,"Rectangle",{isPanelMain:!0,fill:p.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),X(go.Panel,"Vertical",{margin:10},X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.nodeTopFont},new go.Binding("text","portName",function(e){return"端口: "+e}))))})}),X(go.Panel,"Horizontal",new go.Binding("itemArray","bottomArray"),{row:2,column:1,itemTemplate:X(go.Panel,{mouseEnter:function(e,t){for(var n="bottomArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=p.centerConnectorStroke;break}te.updateAllTargetBindings("portColor")},mouseLeave:function(e,t){for(var n="bottomArray",o=0;o<t.part.data[n].length;o++)if(t.part.data[n][o].portName===t.data.portName){t.part.data[n][o].portColor=p.connectorBrush;break}te.updateAllTargetBindings("portColor")},fromSpot:go.Spot.Bottom,toSpot:go.Spot.Bottom,fromLinkable:!0,toLinkable:!0,cursor:"pointer"},new go.Binding("portId","portName"),X(go.Shape,"Rectangle",{desiredSize:new go.Size(8,8),margin:new go.Margin(0,1)},new go.Binding("fill","",function(e){return e.portColor?e.portColor:p.connectorBrush}),new go.Binding("cursor","",function(){return p.EditMode?"pointer":"default"})),{toolTip:X(go.Adornment,"Auto",{stretch:go.GraphObject.Fill},X(go.Shape,"Rectangle",{isPanelMain:!0,fill:p.tooltipBGBrush,maxSize:new go.Size(500,NaN)}),X(go.Panel,"Vertical",{margin:10},X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.nodeTopFont},new go.Binding("text","portName",function(e){return"端口: "+e})),X(go.TextBlock,{text:"",alignment:go.Spot.Left,overflow:go.TextBlock.OverflowEllipsis,wrap:go.TextBlock.None,maxSize:new go.Size(450,NaN),font:p.nodeTopFont},new go.Binding("text","portIp",function(e){return"IP: "+e}))))})}))),te.linkTemplate=X(go.Link,{curve:go.Link.JumpOver,routing:go.Link.AvoidsNodes,corner:5,contextMenu:ee,relinkableFrom:!0,relinkableTo:!0},new go.Binding("selectable","linkId",function(e){return e!==-1}),new go.Binding("routing","link"),X(go.Shape,{strokeWidth:15,stroke:"transparent",isPanelMain:!0},new go.Binding("visible","linkId",function(e){return!(e===-1&&!p.EditMode)})),X(go.Shape,{strokeWidth:2,stroke:p.linkBrush,opacity:p.linkOpacity,isPanelMain:!0,visible:!0},new go.Binding("stroke","isHighlighted",function(e){return e?p.linkHighlightBrush:p.linkBrush}).ofObject(""),new go.Binding("opacity","isHighlighted",function(e){return e?p.linkHighlightOpacity:p.linkOpacity}).ofObject(""),new go.Binding("visible","linkId",function(e){return!(e===-1&&!p.EditMode)}))),document.getElementById("topologySingle").onmousedown=function(e){e.which&&3===e.which&&te.toolManager.panningTool.doActivate()},document.getElementById("topologySingle").onmousemove=function(e){(3===e.which||navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&2===e.buttons)&&(te.toolManager.panningTool.doMouseMove(),te.currentCursor="all-scroll",te.toolManager.draggingTool.doCancel())},document.getElementById("topologySingle").oncontextmenu=function(e){e.stopPropagation()},document.getElementById("topologySingle").onkeydown=function(e){e.ctrlKey&&p.EditMode&&(te.defaultCursor="crosshair",te.toolManager.dragSelectingTool.box=X(go.Part,{layerName:"Tool"},X(go.Shape,{name:"SHAPE",fill:"orange",opacity:.3,strokeWidth:2,stroke:"orange"})))},document.getElementById("topologySingle").onkeyup=function(e){e.ctrlKey||(te.defaultCursor="default",te.toolManager.dragSelectingTool.box=X(go.Part,{layerName:"Tool"},X(go.Shape,{name:"SHAPE",fill:"gray",opacity:.3,strokeWidth:1})))},document.getElementById("topologySingle").onmouseover=function(){p.over=!0},document.getElementById("topologySingle").onmouseleave=function(){p.over=!1},p.newModel=function(e){function t(e,t){this._subnets=Array[0],this.deployedRulesNumber=0,this.deviceId=n.selectedDeviceInTable.deviceId,this.protectedDevicesNumber=0,this.status=0,this.linkState=0,this.isMgmtPort=t,this.portName=e,this.mac="",this.portIp=t?n.selectedDeviceInTable.ip:""}var o={"KEV-U1600":{portNum:16},"KEV-U800":{portNum:8},"KEV-C400":{portNum:4},"KEV-C200":{portNum:2},"KEC-U1000":{portNum:4},"KEA-U2000":{portNum:2},"KEA-U1000E":{portNum:5},"KEA-U1000":{portNum:2},"KEA-U1142":{portNum:6},"KEA-C400":{portNum:4},"KEA-C200":{portNum:2},"KED-U1600":{portNum:16},"KED-U800":{portNum:8},"KED-C400":{portNum:4},"KED-C200":{portNum:2}};if("SECURITY_DEVICE"===n.selectedDeviceInTable.category){"ROUTING_IPS"!==n.selectedDeviceInTable.nodeType&&(n.populateModeOptions(n.selectedDeviceInTable.subcategory,n.selectedDeviceInTable.modelInDetail),n.selectedDeviceInTable.modeDescription=n.forms.modes[0].modename,n.selectedDeviceInTable.nodeType=n.forms.modes[0].mode,"数采隔离"===n.selectedDeviceInTable.modeDescription?n.selectedDeviceInTable.subCategory="DATA_COLLECTION_DEVICE":n.selectedDeviceInTable.subCategory="NORMAL");var a,r=[],i=[],l=[],s=[],c=0;if(n.selectedDeviceInTable.ports=[],o[e]){a="ROUTING_IPS"===n.selectedDeviceInTable.nodeType;for(var d=0;d<=o[e].portNum;d++)d!==o[e].portNum?(n.selectedDeviceInTable.ports.push(new t("p"+d,(!1))),a?"":d%2===0?i.push({portName:n.selectedDeviceInTable.ports[d].portName}):r.push({portName:n.selectedDeviceInTable.ports[d].portName}),"IPS"===n.selectedDeviceInTable.nodeType?d%2===0?l.push({portName:n.selectedDeviceInTable.ports[d].portName+"near"}):s.push({portName:n.selectedDeviceInTable.ports[d].portName+"far"}):""):n.selectedDeviceInTable.ports.push(new t("mgmt",(!0)));var u=[],p=[];for(d=0;d<te.model.linkDataArray.length;d++)te.model.linkDataArray[d].linkId!==-1&&(n.selectedDeviceInTable.portIdRef===!1?a||"ROUTING_IPS"===n.selectedDeviceInTable.nodeType||te.model.linkDataArray[d].from!==n.selectedDeviceInTable.key&&te.model.linkDataArray[d].to!==n.selectedDeviceInTable.key?a&&(te.model.linkDataArray[d].from===n.selectedDeviceInTable.key&&u.push(new Z(te.model.linkDataArray[d].linkId,te.model.linkDataArray[d].from,te.model.linkDataArray[d].to,"foreGround",te.model.linkDataArray[d].toPort)),te.model.linkDataArray[d].to===n.selectedDeviceInTable.key&&u.push(new Z(te.model.linkDataArray[d].linkId,te.model.linkDataArray[d].from,te.model.linkDataArray[d].to,te.model.linkDataArray[d].fromPort,"foreGround"))):u.push(new Z(te.model.linkDataArray[d].linkId,te.model.linkDataArray[d].from,te.model.linkDataArray[d].to,te.model.linkDataArray[d].fromPort,te.model.linkDataArray[d].toPort)):te.model.linkDataArray[d].from!==n.selectedDeviceInTable.key&&te.model.linkDataArray[d].to!==n.selectedDeviceInTable.key||(a?u.push(new Z(te.model.linkDataArray[d].linkId,te.model.linkDataArray[d].from,te.model.linkDataArray[d].to,te.model.linkDataArray[d].fromPort,te.model.linkDataArray[d].toPort)):(u.push(new Z(te.model.linkDataArray[d].linkId,te.model.linkDataArray[d].from,te.model.linkDataArray[d].to,te.model.linkDataArray[d].from===n.selectedDeviceInTable.key?"p"+c:te.model.linkDataArray[d].toPort,te.model.linkDataArray[d].to===n.selectedDeviceInTable.key?"p"+c:te.model.linkDataArray[d].toPort)),c++),p.push(te.model.linkDataArray[d])));for(te.model.setDataProperty(n.selectedDeviceInTable,"leftArray",i),te.model.setDataProperty(n.selectedDeviceInTable,"rightArray",r),te.model.setDataProperty(n.selectedDeviceInTable,"portIdRef",a),te.model.setDataProperty(n.selectedDeviceInTable,"numPorts",n.selectedDeviceInTable.ports.length),te.model.setDataProperty(n.selectedDeviceInTable,"nearArray",l),te.model.setDataProperty(n.selectedDeviceInTable,"farArray",s),d=0;d<p.length;d++)te.model.removeLinkData(p[d]);for(d=0;d<u.length;d++)te.model.addLinkData(u[d]);for(d=0;d<l.length;d++)te.model.addLinkData(new Z((-1),n.selectedDeviceInTable.key,n.selectedDeviceInTable.key,l[d].portName,s[d].portName))}}},p.saveData=function(e){te.updateAllTargetBindings("nameInDetail"),te.updateAllTargetBindings("key"),p.EditMode&&(n.selectedDeviceInTable.isEdited?n.selectedDeviceInTable.isEdited.indexOf(e)===-1?te.model.insertArrayItem(n.selectedDeviceInTable.isEdited,-1,e):"":te.model.setDataProperty(n.selectedDeviceInTable,"isEdited",[e]))},p.groupNameEdit=function(){te.updateAllTargetBindings("nameInDetail"),te.groupRef.edited.push(n.selectedDeviceInTable.groupId)},n.forms={},n.forms.netMasks=angular.copy(h.getNetMasks()),n.validateIp=angular.copy(h.getIPReg()),n.validateMac=angular.copy(h.getMACReg()),n.validateDevice=function(e){e.hasDuplicateSN=!1,e.invalidIp=!1,e.invalidMac=!1,e.invalidNetMask=!1,e.hasDuplicateIP=!1,e.hasDuplicateMAC=!1,e.invalidRange=!1,e.nameError=!e.nameInDetail||0===e.nameInDetail.length,"subnet"!==e.iconType.toLowerCase()&&(e.modelError=!e.modelId||0===e.modelId.length);var t=[],o=[],i=[];for(var l in te.model.nodeDataArray)if(l){var s=te.model.nodeDataArray[l];if(s.ports&&(s.devicePorts=s.ports,i.push(s)),e.key!==s.key&&s.serialNumber&&e.serialNumber===s.serialNumber&&(e.hasDuplicateSN=!0),"subnet"===s.iconType.toLowerCase())s.subnetIp&&t.push(s.subnetIp.split("/")[0]);else if("FACTORY_DEVICE"!==s.category)s.ip&&t.push(s.ip),s.mac&&o.push(s.mac);else if(s.ports)for(var c=0;c<s.ports.length;c++)s.ports[c].isMgmtPort&&(s.ports[c].portIp&&t.push(s.ports[c].portIp),s.ports[c].mac&&o.push(s.ports[c].mac))}if("SECURITY_DEVICE"===e.category)e.serialError=!e.serialNumber||0===e.serialNumber.length,e.serialFormatError=!g.validSNFormat(e.serialNumber),e.invalidIp=!e.ip||h.validateIp(e.ip),e.invalidMac=e.mac&&!e.mac.match(n.validateMac),e.invalidIp||(e.hasDuplicateIP=n.checkDuplicate(e.ip,t),e.invalidRange=h.checkIpInSubnet(e.ip,i)),e.invalidMac||(e.hasDuplicateMAC=n.checkDuplicate(e.mac,o,!0));else if("NETWORK_DEVICE"===e.category)e.invalidIp=e.ip&&h.validateIp(e.ip),e.invalidMac=e.mac&&!e.mac.match(n.validateMac),e.invalidIp||(e.hasDuplicateIP=n.checkDuplicate(e.ip,t),e.invalidRange=h.checkIpInSubnet(e.ip,i)),e.invalidMac||(e.hasDuplicateMAC=n.checkDuplicate(e.mac,o,!0));else if("FACTORY_DEVICE"===e.category)if("subnet"===e.iconType.toLowerCase())e.invalidNetMask=!e.subnetIp||h.subnetValidation(e.subnetIp),e.invalidNetMask||(e.invalidRange=h.subnetOverlap(e,i,e.subnetIp));else for(var d=0;d<e.ports.length;d++){var u=e.ports[d];u.isMgmtPort&&(u.invalidIp=!u.portIp||h.validateIp(u.portIp),u.invalidMac=n.needMac?!u.mac||!u.mac.match(n.validateMac):u.mac&&!u.mac.match(n.validateMac),e.invalidIp=u.invalidIp||e.invalidIp,e.invalidMac=u.invalidMac||e.invalidMac,u.invalidIp||(u.hasDuplicateIP=n.checkDuplicate(u.portIp,t),u.invalidRange=h.checkIpInSubnet(u.portIp,i),e.hasDuplicateIP=u.hasDuplicateIP||e.hasDuplicateIP,e.invalidRange=u.invalidRange||e.invalidRange),u.invalidMac||(u.hasDuplicateMAC=n.checkDuplicate(u.mac,o,!0),e.hasDuplicateMAC=u.hasDuplicateMAC||e.hasDuplicateMAC))}e.invalid=e.nameError||e.modelError||e.invalidIp||e.serialError||e.invalidMac||e.invalidNetMask||e.invalidRange||e.hasDuplicateSN||e.hasDuplicateIP||e.hasDuplicateMAC||"SECURITY_DEVICE"===e.category&&e.serialFormatError;for(var f,m=0;m<te.model.nodeDataArray.length;m++)f=f||te.model.nodeDataArray[m].invalid;p.invalid=f,e.invalid?(a(p.invalidDeviceList,e),p.selectedInvalidDevice=e):r(p.invalidDeviceList,e),te.updateAllTargetBindings("invalid")},n.checkDuplicate=function(e,t,n){for(var o=0,a=0;a<t.length;a++)e&&(n?e.toLowerCase()===(t[a]?t[a].toLowerCase():""):e===t[a])&&o++;return o>1},n.addIpMac=function(){te.startTransaction("addPort");var e={},t={};e.isMgmtPort=!0,e.portIp="",e.mac="",e.portName="p"+n.selectedDeviceInTable.ports.length,t.portIp="",t.portName="p"+n.selectedDeviceInTable.bottomArray.length,n.selectedDeviceInTable.ports.push(e),te.model.insertArrayItem(n.selectedDeviceInTable.bottomArray,n.selectedDeviceInTable.ports.length-1,t),te.commitTransaction("addPort")},n.removeIpMac=function(e){te.startTransaction("removePort"),n.selectedDeviceInTable.ports.splice(e,1),te.model.removeArrayItem(n.selectedDeviceInTable.bottomArray,e),te.commitTransaction("removePort")},n.populateModelOptions=function(e){"cloud"!==n.selectedDeviceInTable.nodeType.toLowerCase()&&(n.forms.models=[],"FACTORY_DEVICE"===e?n.forms.models=p.factory_models:"NETWORK_DEVICE"===e?n.forms.models=p.network_models:"SECURITY_DEVICE"===e&&(n.forms.models=p.security_models))},n.serialNumberChanged=function(e){if("SECURITY_DEVICE"===n.selectedDeviceInTable.category){n.selectedDeviceInTable.modelInDetail="",n.selectedDeviceInTable.modelId="",n.selectedDeviceInTable.mode="",n.selectedDeviceInTable.manufacturerInDetail="",n.selectedDeviceInTable.numPorts="",n.selectedDeviceInTable.modeDescription="",n.forms.modes=[];var t=g.getModelBySN(e,n.forms.models).model;if(t)for(var o in n.forms.models)if(o&&n.forms.models[o].iconType&&n.forms.models[o].model===t){n.selectedDeviceInTable.modelId=n.forms.models[o].modelId,n.modelChange(n.selectedDeviceInTable);break}}},n.populateModeOptions=function(e,t){n.forms.modes=[];var o=t;t&&t.indexOf(" / ")>0&&(o=t.split(" / ")[1]),"DATA_COLLECTION_DEVICE"===e||0===o.indexOf("KED")?(n.forms.modes[0]={},n.forms.modes[0].mode="IPS",n.forms.modes[0].modename="数采隔离"):0===o.indexOf("KEA")?(n.forms.modes[0]={},n.forms.modes[0].mode="IDS",n.forms.modes[0].modename="监测审计"):0===o.indexOf("KEV")?"KEV-U800"===o?(n.forms.modes[0]={},n.forms.modes[0].mode="IPS",n.forms.modes[0].modename="智能保护"):(n.forms.modes[0]={},n.forms.modes[1]={},n.forms.modes[0].mode="IPS",n.forms.modes[1].mode="ROUTING_IPS",n.forms.modes[0].modename="智能保护",n.forms.modes[1].modename="路由保护"):0===o.indexOf("KEC")&&(n.forms.modes[0]={},n.forms.modes[1]={},n.forms.modes[0].mode="IPS",n.forms.modes[1].mode="IDS",n.forms.modes[0].modename="智能保护",n.forms.modes[1].modename="监测审计")},n.modelChange=function(e){for(var t in n.forms.models)if(t&&n.forms.models[t].modelId===e.modelId){if(e.manufacturerInDetail=n.forms.models[t].make,e.numPorts=n.forms.models[t].numOfPorts,e.modelInDetail=n.forms.models[t].model_name+" / "+n.forms.models[t].model,"SECURITY_DEVICE"===e.category){te.updateAllTargetBindings("serialNumber"),te.model.setDataProperty(e,"img",o.getSecurityDeviceIconPath(n.forms.models[t].model,n.forms.models[t].iconType)),e.subcategory=n.forms.models[t].subCategory,e.iconType=n.forms.models[t].iconType?n.forms.models[t].iconType.toLowerCase():"";var a=n.forms.models[t].model_name+" / "+n.forms.models[t].model;p.newModel(n.forms.models[t].model),n.populateModeOptions(e.subcategory,a)}break}p.saveData("basic"),n.validateDevice(e)},n.modeChange=function(e){for(var t in n.forms.modes)if(t&&n.forms.modes[t].modename===e.modeDescription){if(e.nodeType=n.forms.modes[t].mode,"数采隔离"===e.modeDescription&&(e.subCategory=1),e.modelInDetail.indexOf("KEV")>=0){var o=u("deviceModel")(e.modelInDetail);p.newModel(o.substring(o.indexOf("KEV"),o.length))}break}n.validateDevice(e)},n.selectInvalidDevice=function(e){if(e.key){var t=te.findNodeForData(e);te.select(t),te.zoomToRect(t.actualBounds),te.centerRect(t.actualBounds);var n=te.computePartsBounds(te.selection).width,o=te.viewportBounds.width*(1-600/document.getElementById("topologySingle").offsetWidth);te.scale>1?te.scale=1:n>o&&(te.scale=.7*te.scale-300/n)}},n.drawTopo=function(e){_(e)},n.putDiagramData=function(e){Q(e)},p.cleanupTopo=function(){var e=s.get("Role");e.length&&e[0].roleId&&y.getUserGroup(e[0].roleId).then(function(e){var t,o;p.checkAllDeviceAccess(e,n.devices)?(o=function(e,t,n,o,a,r){e.hasDeployment=!1,r.getDeployedPolicy("BLACKLIST").then(function(t){t.data.length>0?e.hasDeployment=!0:r.getDeployedPolicy("WHITELIST").then(function(t){e.hasDeployment=t.data.length>0})}),e.cancel=function(){t.dismiss("cancel")},e.confirm=function(){n.cleanup(a.id).then(function(){o.reload()}),t.close("done")}},t=f.open({templateUrl:"templates/topology/singleTopo/cleanupConfirmation.f8390d16.html",size:"sm",controller:o}),t.result.then(function(){},function(){})):(o=function(e,t){e.cancel=function(){t.dismiss("cancel")}},t=f.open({templateUrl:"templates/topology/singleTopo/hasNoAuthority.efc0ab09.html",size:"sm",controller:o}))})},p.uploadCheckAuthority=function(){var e=s.get("Role");e.length&&e[0].roleId&&y.getUserGroup(e[0].roleId).then(function(e){if(p.checkAllDeviceAccess(e,n.devices))p.uploadTopologyModal();else{var t=function(e,t){e.cancel=function(){t.dismiss("cancel")}};t.$inject=["$scope","$modalInstance"],f.open({templateUrl:"templates/topology/singleTopo/hasNoAuthority.efc0ab09.html",size:"sm",controller:t})}})},p.uploadTopologyModal=function(){function e(e,t,n,o,a,r,i,l){e.isDPIUpgrading=a.isDPIUpgrading();var s=i.$on("dpiUpgradeState",function(){e.isDPIUpgrading=a.isDPIUpgrading()});e.$on("destroy",function(){s()});var c=e.uploader=new n({url:o+"/files/topology/"+r.id+"/fileupload",autoUpload:!0,removeAfterUpload:!0,queueLimit:1}),d=l.defer();c.onSuccessItem=function(e,t,n){i.uploadTaskPromise=null,i.$broadcast("updateDashboardHeader"),t.warningInfos.length?i.addAlert({type:"warning",content:"警告!\n- "+t.warningInfos.join("\n- ")}):200===n&&i.addAlert({type:"success",content:"拓扑文件上传成功"})},c.onProgressAll=function(){i.uploadTaskPromise=d.promise,t.close()},c.onErrorItem=function(e,t){i.uploadTaskPromise=null,i.addAlert({type:"danger",content:t.error})},e.ok=function(){i.uploadTaskPromise=null,t.close()},e.cancel=function(){i.uploadTaskPromise=null,t.dismiss("cancel")}}e.$inject=["$scope","$modalInstance","FileUploader","URI","System","topologyId","$rootScope","$q"];var t=f.open({animation:!0,templateUrl:"upload-confirmation.html",controller:e,size:"sm",resolve:{scope:function(){return n},element:function(){return c}}});t.result.then(function(){},function(){i.uploadTaskPromise=null})},p.cannotDelete=function(e){function t(e,t,n){e.devices=n,e.cancel=function(){t.close()}}t.$inject=["$scope","$modalInstance","devices"];var n=f.open({templateUrl:"templates/asset/cannotDelete.43ea6261.html",controller:t,size:"sm",resolve:{devices:function(){return e}}});n.result.then(function(){},function(){})},p.deleteDevice=function(e,t){function n(e,n,o){e.device=1===o.length?o[0].data:o,e.ok=function(){n.close();for(var e=0;e<o.length;e++){te.remove(o[e]),r(p.invalidDeviceList,o[e].data),0===p.invalidDeviceList.length&&(p.invalid=!1),x();for(var a=[],i=0;i<te.allData.nodes.length;i++)te.allData.nodes[i].deviceId!==o[e].data.deviceId?a.push(te.allData.nodes[i]):"";te.allData.nodes=a,"cloud"===o[e].data.iconType&&z(o[e].data)}for(e=0;e<t.length;e++)te.remove(t[e]),r(p.invalidDeviceList,t[e].data),0===p.invalidDeviceList.length&&(p.invalid=!1),x()},e.cancel=function(){n.dismiss("cancel")}}n.$inject=["$scope","$modalInstance","device"];var o=f.open({templateUrl:"templates/asset/deleteDevice.4bd25fc1.html",controller:n,size:"sm",resolve:{device:function(){return e}}});o.result.then(function(){},function(){})},p.EnterEdit=function(e){if(e)p.EditMode=!p.EditMode,p.lastSelection=!1,p.invalidDeviceList=[],te.toolManager.dragSelectingTool.isEnabled=!1,te.toolManager.contextMenuTool.isEnabled=!1,te.maxSelectionCount=1,n.render("update"),K(e);else if(p.EditMode){te.startTransaction("Edit"),
p.isUpdating=!0;for(var t=0;t<te.model.linkDataArray.length;t++)"foreGround"===te.model.linkDataArray[t].fromPort&&te.model.setDataProperty(te.model.linkDataArray[t],"fromPort","unspecified"),"foreGround"===te.model.linkDataArray[t].toPort&&te.model.setDataProperty(te.model.linkDataArray[t],"toPort","unspecified");te.toolManager.dragSelectingTool.isEnabled=!1,te.toolManager.contextMenuTool.isEnabled=!1,te.model.isReadOnly=!0,n.selectedDeviceInTable&&n.selectedDeviceInTable.deviceId&&n.selectedDeviceInTable.isEdited&&!n.selectedDeviceInTable.invalid&&V(n.selectedDeviceInTable),F(),te.commitTransaction("Edit")}else v.getLearningTasks().then(function(t){for(var n=t.data,o=!1,a=0;a<n.length;a++)"PROCESSING"!==n[a].state&&"PAUSED"!==n[a].state||(o=!0);if(o){var r=f.open({templateUrl:"templates/topology/singleTopo/learingInProgressAlert.b228b806.html",size:"sm",controller:Y});r.result.then(function(t){t&&q(e)})}else q(e)})}})}var T={scope:!1,restrict:"E",templateUrl:"/templates/topology/singleTopo/topoDiagram.9847af30.html",controller:I,controllerAs:"topoCtrl",link:D};return T}function o(e,t,n,o,a,r){function i(t,n,r,i){function s(n){return e.getAll(n,t.topo)}function c(n){return e.getCount(n,t.topo)}function d(t){return e.search("SECURITY_DEVICE",t)}t.open=function(e){"FACTORY_DEVICE"===e.category?l({tmpl:"factorySettingDialog.html",device:e,size:"sm",ctrl:"factoryCtrl"}):"SECURITY_DEVICE"===e.category&&l({tmpl:"securitySettingDialog.html",device:e,size:"lg",ctrl:"securityCtrl"})},t.disableWhenTopologyInUse=function(){return!!o.topo&&(!a.id||o.topo!==a.id)},i.setConfig({name:"device",pagination:!0,scrollable:!1,totalCount:!0,getAll:s,getCount:c,search:d})}function l(t){[function(o,a){o.validateIp=angular.copy(r.getIPRangeReg()),o.deviceCopy=angular.copy(t.device),o.confirm=function(){if(!o.deviceCopy.invalid){var r={iporsubnet:o.deviceCopy.devicePorts[0].portIp};e.updateSingleIpSubnet(t.device.topologyId,t.device.deviceId,r).then(function(e){e.message?o.updateSingleIpSubnetErrorMsg=e.message:(t.device.devicePorts=e,n.addAlert({type:"success",content:t.device.name+"已保存"}),a.close())})}},o.cancel=function(){a.dismiss("cancel")}},function(o,a){o.device=t.device,o.device.port=t.device.port,o.deviceCopy=angular.copy(t.device),o.confirm=function(){for(var r=o.deviceCopy.devicePorts,i=0;i<r.length;i++)if(!r[i].isMgmtPort&&(r[i].mask||r[i].ip||!r[i].portIp||!r[i].netMask))return;var l=[];o.deviceCopy.devicePorts.forEach(function(e){l.push({portId:e.portId,portIp:e.portIp,netMask:e.netMask})}),e.updateDevicePort(t.device.deviceId,l).then(function(e){t.device.devicePorts=e,n.addAlert({type:"success",content:t.device.name+"已保存"})}),a.close()},o.cancel=function(){t.device.port=o.deviceCopy.port,a.dismiss("cancel")}}].forEach(function(e){s[e.name]=e})}var s={},c={scope:!1,restrict:"E",require:"^dtable",replace:!0,templateUrl:"/templates/topology/singleTopo/devicesTable/table.html",link:i};return c}function a(e,t){var n=!1;for(var o in e)if(o&&e[o].key===t.key){e[o]=t,n=!0;break}n||e.push(t)}function r(e,t){for(var n in e)if(n&&e[n].key===t.key){e.splice(n,1);break}}t.$inject=["Topology","$rootScope","$modal","domain","$log","topologyId"],n.$inject=["Topology","$q","Incident","Device","$rootScope","$state","Enum","domain","topologyId","$filter","Signature","$modal","Dashboard","snVal","formatVal","Learning","SystemUser"],o.$inject=["Device","$modal","$rootScope","$stateParams","topologyId","formatVal"],angular.module("southWest.topology.singleTopo").directive("topoEditorHeader",t).directive("topoDiagram",n).directive("allDevicesTable",o).directive("topoPalette",e)}(),function(){"use strict";function e(e){e.state("topology",{parent:"dashboard",abstract:!0,controller:"TopoOverCtrl as topoOver",templateUrl:"templates/topology/index.3914d86f.html",resolve:{state:["$rootScope",function(e){e.currentState="TOPOLOGY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.topology").config(e)}(),function(){"use strict";function e(){}angular.module("southWest.topology").controller("TopoOverCtrl",e)}(),function(){"use strict";function e(e){e.state("unknown",{parent:"dashboard",abstract:!0,controller:"RuleCtrl as unknown",templateUrl:"templates/unknown/index.00cb9bc0.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}}).state("unknown.ipmac",{url:"/unknown/ipmac/",controller:"IPMACCtrl as ipmac",templateUrl:"templates/rule/ipmac/index.03d32323.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],allDeviceFull:["$stateParams","Topology","domain",function(e,t,n){return n.getDomain().then(function(e){return t.getDevices(e[0].domainInfo.currentTopologyId)})}]}}).state("unknown.ipmacsync",{url:"/unknown/ipmacsync/",controller:"ipmacsyncCtrl as ipmacsyncCtrl",templateUrl:"templates/rule/ipmacsync/index.6269a19e.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],allDeviceFull:["$stateParams","Topology","domain",function(e,t,n){return n.getDomain().then(function(e){return t.getDevices(e[0].domainInfo.currentTopologyId)})}]}})}e.$inject=["$stateProvider"],angular.module("southWest.unknown").config(e)}(),function(){"use strict";function e(){var e=this;e.test={}}angular.module("southWest.unknown").controller("UnknownCtrl",e)}(),function(){"use strict";function e(e){e.state("vul",{parent:"dashboard",abstract:!0,controller:"RuleCtrl as vul",templateUrl:"templates/vulnerability/index.85888b17.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}}).state("vul.blacklist",{url:"/vul/blacklist/?tab",controller:"blacklistSignatureCtrl as signature",templateUrl:"templates/rule/blacklist/index.9c78b056.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],domainInfo:["domain",function(e){return e.getDomain()}],deployedPolicyArr:["Signature",function(e){return e.getDeployedPolicy("BLACKLIST").then(function(e){return e.data})}],policiesArr:["Signature",function(e){return e.getPolicies("BLACKLIST").then(function(e){return e.data})}]}}).state("vul.blacklist.editor",{parent:"vul",url:"/vul/blacklist/editor/:topologyId?policyId?tab",controller:"blacklistEditorCtrl as editor",templateUrl:"templates/rule/blacklist/editor.acce6724.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}],domainInfo:["domain",function(e){return e.getDomain()}],policiesArr:["Signature",function(e){return e.getPolicies("BLACKLIST").then(function(e){return e.data})}]}}).state("vul.blacklist.policyDetail",{parent:"vul",url:"/vul/blacklist/policyDetail/:topologyId?policyId",controller:"blacklistPolicyDetailCtrl as policyDetail",templateUrl:"templates/rule/blacklist/policyDetail.d57a9896.html",resolve:{state:["$rootScope",function(e){e.currentState="POLICY"}]}})}e.$inject=["$stateProvider"],angular.module("southWest.vul").config(e)}(),function(){"use strict";function e(){var e=this;e.test={}}angular.module("southWest.vul").controller("VulCtrl",e)}(),function(){"use strict";function e(){var e="/api/v2.0",t="js/mock/models/";angular.module("southWest",i.concat(l)).config(o).run(a).controller("AppCtrl",r).constant("URI",e).constant("MOCK",t),angular.element(document).ready(function(){angular.bootstrap(document,["southWest"])})}function t(){$.getJSON("js/mock/models/uni/api.json").then(e,n)}function n(){}function o(e,t,n,o,a,r){e.otherwise("/"),t.html5Mode(!0),n.defaults.useXDomain=!0,n.defaults.withCredentials=!0,delete n.defaults.headers.common["X-Requested-With"],n.defaults.headers.common.Accept="*/*",n.defaults.headers.common["Content-Type"]="application/json, charset=UTF-8",n.interceptors.push("unauthorized"),o.classNameFilter(/angular-animate/);var i=!1;a.state("root",{abstract:!0,url:"",resolve:{init:["auth",function(e){if(!i)return i=!0,e.whoAmI()}],secretKey:["auth","$rootScope",function(e,t){if(!t.secretKey)return e.getSecretKey()}]}}),r.options={backdrop:"static"}}function a(e,t,n,o,a){e.getLogo().then(function(){},function(){n.logo={loginLogo:"acorn-logo",logo:"logo",logo2:"logo2",text:"2016 匡恩网络 版权所有"}}),"production"===window.env&&$.getJSON("/js/rev-manifest.json").then(function(e){n.revManifest=e}),n.$on("$stateChangeStart",function(e,n){n.resolve.pauseStateChange=[function(){var r=n.name;return _.isFunction(n.resolve.menuState)&&(r=n.resolve.menuState()),"redirect"===r?a.resolve():t.validateState(r).then(function(t){return t||(e.preventDefault(),o.go("redirect")),a.resolve()})}]})}function r(e,t,n,o,a,r){var i=this;window.addEventListener("storage",function(e){"loginSuccess"===e.key&&"1"===e.newValue&&"auth"===r.current.name&&location.reload(),"secretKey"===e.key&&(n.secretKey=e.newValue)}),document.onkeydown=function(e){if(e=window.event||e||e.which,112===e.keyCode)return n.openHelp(),!1},i.scrollTo=function(n){e.hash(n),t()},i.messages=[],i.stayMessage=[],n.addAlert=function(e){if(e&&"学习任务完成"===e.content)for(var t=0;t<i.messages.length;t++)if("学习任务完成"===i.messages[t].content)return;i.messages.push(e),o(function(){var t=i.messages.indexOf(e);t>=0&&i.closeAlert(e)},6e3)},i.closeAlert=function(e){var t=i.messages.indexOf(e);t>=0&&i.messages.splice(t,1)},n.stayAlert=function(e){i.stayMessage.push(e),o(function(){var t=i.stayMessage.indexOf(e);t>=0&&i.closeStayAlert(e)},1e4)},i.closeStayAlert=function(e){var t=i.stayMessage.indexOf(e);t>=0&&i.stayMessage.splice(t,1)},i.stopEventPropagation=function(e){return e.stopPropagation(),!1}}o.$inject=["$urlRouterProvider","$locationProvider","$httpProvider","$animateProvider","$stateProvider","$modalProvider"],a.$inject=["logo","auth","$rootScope","$state","$q"],r.$inject=["$location","$anchorScroll","$rootScope","$timeout","auth","$state"];var i=["ui.router","ui.bootstrap","ui.sortable","ngSanitize","ngCookies","ngResource","ngAnimate","cgBusy","angularFileUpload","highcharts-ng","ngCrypto","angucomplete","inputmask4angular","ui.tree","ngDragDrop","720kb.tooltips","angular-loading-bar","rx","southWest.filters","southWest.models","southWest.directives","southWest.services"],l=["southWest.asset","southWest.attack","southWest.protocolaudit","southWest.securityaudit","southWest.audit","southWest.audit.behavior","southWest.audit.dpidata","southWest.audit.dpidevicedata","southWest.audit.icdevicedata","southWest.audit.forumpostdata","southWest.audit.searchenginedata","southWest.auth","southWest.dashboard","southWest.todolist","southWest.detect","southWest.domain","southWest.monitor","southWest.postlog","southWest.infsafety","southWest.reduction","southWest.rule","southWest.rule.blacklist","southWest.rule.ipmac","southWest.rule.maliciousdomain","southWest.rule.whitelist","southWest.rule.networklist","southWest.rule.learning","southWest.rule.sync","southWest.rule.ipmacsync","southWest.securityauditsetting","southWest.setting","southWest.setting.systemconsole","southWest.setting.systemdevice","southWest.systemuser","southWest.myaccount","southWest.privateprotocol","southWest.record","southWest.topology","southWest.topology.singleTopo","southWest.asset.securitydevice","southWest.asset.factorydevice","southWest.asset.networkdevice","southWest.asset.ucddevice","southWest.monitor.device","southWest.monitor.incident","southWest.monitor.logger","southWest.monitor.overview","southWest.redirect","southWest.ai","southWest.unknown","southWest.ntpsync","southWest.vul","southWest.monitor.report_event","southWest.monitor.report_log","southWest.monitor.report_protocol","southWest.network","southWest.network.interface","southWest.network.static_router","southWest.object","southWest.object.network_asset","southWest.object.service","southWest.object.apply","southWest.object.schedule","southWest.strategy","southWest.strategy.security","southWest.strategy.nat","southWest.strategy.session","southWest.strategy.anti_penetration","southWest.setting.basic","southWest.setting.reliable","southWest.setting.security_operation","southWest.setting.switch","southWest.session","southWest.session.state","southWest.session.flowdata_overview","southWest.session.flowdata_industry","southWest.session.protocol"];$.getJSON("/api/v2.0/systemsetting/configuration/item/buildVersion").then(e,t)}();